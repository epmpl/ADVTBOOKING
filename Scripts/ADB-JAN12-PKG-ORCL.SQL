/*********************************** issue 6199************************/
CREATE OR REPLACE procedure  rpt_vts_report
(

pagency_code in varchar2,
pclient_code in varchar2,
pfrom_date in varchar2,
pto_date in varchar2,
pdateformat in varchar2,
ppublication in varchar2,
pedition in varchar2,
ppub_center in varchar2,
pbranch in varchar2,
pcompcode in varchar2,
puserid in varchar2,
chk_access in varchar2,
clienttype in varchar2,
pextra1 in varchar2,
pextra2 in varchar2,
p_accounts OUT Cur_Type_New1.cursor_type
)
is 
query1 varchar2(8000);
v_frdt date;
v_todt date; 
begin

v_frdt :=to_date(pfrom_date,''''||pdateformat||'''');
v_todt :=to_date(pto_date,''''||pdateformat||'''');

query1:=query1|| 'select 
c."Agency_Name" AS "AGENCY",
nvl((SELECT "Cust_Name" FROM  CUST_MAST WHERE a."Comp_code"= CUST_MAST."Comp_Code" AND "Cust_Code"="Client_code"),"Client_code")  AS "CLIENT", 
b."Edition" as "EDITION",
to_char("Insert_Date",'''||pdateformat||''') AS "PUB_DATE" ,
a."No_of_insertion",
nvl(a."Agrred_rate",a."Card_rate" ) AS "RATE",
(select "Comp_Name" from  comp_mst where comp_mst."Comp_Code"=a."Comp_code") comp_name
from  tbl_booking_mast a, tbl_booking_insert b, agency_mast c
WHERE a."Comp_code"='''||pcompcode||''' AND
a."Agency_sub_code"=c."code_subcode" AND
a."cio_booking_id"=b."Cio_Booking_Id"  and
 ((b."Pub_Cent_Code" in (select distinct pub_center from  login_center where newuser_id='''||puserid||''') and '''||chk_access||'''=''1'')
or  ('''||chk_access||'''=''0'') )';

IF(pfrom_date IS NOT NULL AND pto_date IS NOT NULL)
then
query1:=query1||' and b."Insert_Date" between  '''||v_frdt ||''' and  '''||v_todt||''' ';
END if;

IF(pagency_code IS NOT NULL )
then
query1:=query1||' and a."Agency_code" =  '''||pagency_code||''' ';
END if;

IF(pclient_code IS NOT NULL )
then
query1:=query1||' and a."Client_code"='''||pclient_code ||'''';
END if;

IF(ppublication IS NOT NULL )
then
query1:=query1||' and  b."Publication_Code"='''||ppublication||'''';
END if;

IF(ppub_center IS NOT NULL )
then
query1:=query1||'  and b."Pub_Cent_Code"='''||ppub_center||'''';
END if;

IF(pedition IS NOT NULL )
then
query1:=query1||'  and b."Edition_Code"='''||pedition||'''';
END if;

IF(pbranch IS NOT NULL )
then
query1:=query1||'  and a."branch"='''||pbranch||'''';
END if;

  if (clienttype is not null or clienttype<>'') then
      if clienttype = 'R' then
         query1:=query1||'  and "Client_code" in (select "Cust_Code" from  cust_mast where "Comp_Code" = '''||pcompcode||''''||'and "Cust_Status"=''ACTIVE'')';
      else if clienttype = 'N' then
         query1:=query1||'  and "Client_code" not in (select "Cust_Code" from  cust_mast where "Comp_Code = '''||pcompcode||''''||'and "Cust_Status"=''ACTIVE'')';
      else
         query1:=query1;
      end if;
      end if;
   end if; 

--insert into test1 (vstring) values (query1);commit;

DELETE  FROM SEARCHTBL;
INSERT INTO SEARCHTBL VALUES('PK'||query1);
COMMIT;
open p_accounts for 
query1;

end rpt_vts_report;

/*********************************** issue 6199************************/

/********************************************************************contracrt***********/
CREATE OR REPLACE PACKAGE          bindproductforcontract
IS
   TYPE t_account_cursor IS REF CURSOR;

   PROCEDURE bindproductforcontract_p (
      client       IN       VARCHAR2,
      compcode     IN       VARCHAR2,
      userid       IN       VARCHAR2,
      p_accounts   OUT      t_account_cursor
   );
END bindproductforcontract;
/



CREATE OR REPLACE PACKAGE BODY          bindproductforcontract
IS
   PROCEDURE bindproductforcontract_p (
      client       IN       VARCHAR2,
      compcode     IN       VARCHAR2,
      userid       IN       VARCHAR2,
      p_accounts   OUT      t_account_cursor
   )
   AS
   BEGIN
      OPEN p_accounts FOR
         SELECT "product_name" as "Product_Name", "product_code" as "Product_Code"
           FROM client_pro_master
          WHERE "Comp_code" = compcode AND "client_code" = client;
   END bindproductforcontract_p;
END bindproductforcontract;
/

/****************************************/


CREATE OR REPLACE procedure          TV_packagebind
(
compcode in varchar2,
adtype in varchar2,
channel_p in varchar2,
p_accounts   OUT   cur_type_new1.cursor_type
)

as
begin
if adtype='EL0' then
 open p_accounts for
    select Combin_Code as "Combin_Code",Package_Name as "Package_Name",(Combin_Code ||'@'|| Combin_Desc) as "pck_code" from tv_combin_mast
where Comp_Code=compcode and (CHANNEL=channel_p or channel_p is null) order by Package_Name;
else
    open p_accounts for
    select "Combin_Code","Package_Name",("Combin_Code" ||'@'|| "Combin_Desc") as "pck_code" from combin_mast
where "Comp_Code"=compcode and "Ad_Type_code"=adtype order by "Package_Name";
end if;
end;
/


/************************************************contract***********/



/******************mimoh 11jan2011********************/


CREATE OR REPLACE PACKAGE Insertintobooking
IS
   PROCEDURE  insertintobooking_P (
	date_time IN DATE,
	adsizetype IN VARCHAR2,
	branch IN VARCHAR2,
	booked_by IN VARCHAR2,
	prevbook IN VARCHAR2,
	approvedby IN VARCHAR2,
	ciobookid IN VARCHAR2,
	audit1 IN VARCHAR2,
	rono IN VARCHAR2,
	rodate IN DATE,
	caption IN VARCHAR2,
	billstatus IN VARCHAR2,
	rostatus IN VARCHAR2,
	agency IN VARCHAR2,
	client IN VARCHAR2,
	agencyaddress IN VARCHAR2,
	clientaddresses IN VARCHAR2,
	agencycode IN VARCHAR2,
	dockitno IN VARCHAR2,
	execname IN VARCHAR2,
    execzone IN VARCHAR2,
    product IN VARCHAR2,
    brand IN VARCHAR2,
    keyno IN VARCHAR2,
    billremark IN VARCHAR2,
    printremark IN VARCHAR2,
    PACKAGE1 IN VARCHAR2,
    insertion IN NUMBER,
    startdate IN DATE,
    repeatdate IN VARCHAR2,
    adtype1 IN VARCHAR2,
    Adcategory IN VARCHAR2,
    subcategory IN VARCHAR2,
    color IN VARCHAR2,
    uom IN VARCHAR2,
    pageposition IN VARCHAR2,
    pagetype1 IN VARCHAR2,
    pageno IN NUMBER,
    adsizheight IN NUMBER,
    adsizwidth IN NUMBER,
    scheme1 IN VARCHAR2,
    currency IN VARCHAR2,
    ratecode11 IN VARCHAR2,
    agreedrate IN NUMBER,
    agreedamt IN NUMBER,
    spedisc IN NUMBER,
    compcode IN VARCHAR2,
    spacedisx IN NUMBER,
    specialcharges IN NUMBER,
    userid IN VARCHAR2,
    agencytype IN VARCHAR2,
    agencystatus IN VARCHAR2,
    paymode IN VARCHAR2,
    agenccredit IN NUMBER,
    cardrate IN NUMBER,
    cardamount IN NUMBER,
    discount IN NUMBER,
    discountper IN NUMBER,
    billaddress IN VARCHAR2,
    totarea IN NUMBER,
    billcycle IN VARCHAR2,
    billpay IN VARCHAR2,
    revenuecenter IN VARCHAR2,
    billheight IN NUMBER,
    billwidth IN NUMBER,
    billto IN VARCHAR2,
    invoices IN NUMBER,
    vts IN NUMBER,
    tradedisc IN NUMBER,
    agencyout IN VARCHAR2,
    boxcode IN VARCHAR2,
    boxno IN VARCHAR2,
    boxagency IN VARCHAR2,
    boxaddress IN VARCHAR2,
    boxclient IN VARCHAR2,
    coupan IN VARCHAR2,
    bookingtype IN VARCHAR2,
    tfn IN VARCHAR2,
    campaign IN VARCHAR2,
    bill_amt IN NUMBER,
    pageprem IN VARCHAR2,
    pageamt IN NUMBER,
    premper IN NUMBER,
    grossamt IN NUMBER,
    adsizcolumn IN NUMBER,
    billcolumn IN NUMBER,
    specdiscper IN NUMBER,
    spacediscper IN NUMBER,
    billarea IN NUMBER,
    paidins IN NUMBER,
    dealrate IN NUMBER,
    deviation IN NUMBER,
    varient IN VARCHAR2,
    contractname IN VARCHAR2,
    dealtype IN VARCHAR2,
    cardname IN VARCHAR2,
    cardtype IN VARCHAR2,
    cardmonth IN VARCHAR2,
    cardyear IN VARCHAR2,
    cardno IN VARCHAR2,
    receiptno IN VARCHAR2,
    adscat3 IN VARCHAR2,
    adscat4 IN VARCHAR2,
    adscat5 IN VARCHAR2,
    bgcolor IN VARCHAR2,
    bulletcode IN VARCHAR2,
    bulletprm IN NUMBER,
    material IN VARCHAR2,
    receiptdate IN DATE:=NULL,
    prevcioid IN VARCHAR2:=NULL,
    prevreceipt IN VARCHAR2:=NULL,
    prev_ga IN NUMBER:=NULL,
    varient_name IN VARCHAR2:=NULL,
    region1 IN VARCHAR2:=NULL,
    coltype IN VARCHAR2,
    logo_h IN VARCHAR2,
    logo_w IN VARCHAR2,
    logo_col IN VARCHAR2,
    logo_uom IN VARCHAR2,
    retainer1 IN VARCHAR2,
    addagencyrate IN VARCHAR2,
    mobileno    in varchar2,
    addlamt in varchar2,
retamt in varchar2,
retper in varchar2,
cashrecieved in number,
CIRAGENCY_V in varchar2,
CIRRATE_V in varchar2,
CIREDITION_V in varchar2,
CIRPUBLICATION_V in varchar2,
CIRAGENCYSUBCODE_V in varchar2,
BARTERTYPE IN VARCHAR2,
CASHDISCOUNT_V IN VARCHAR2,
CASHDISCOUNTPER_V IN VARCHAR2,
attach1 in varchar2,
attach2 in varchar2,
drpdiscprem in varchar2,
doctype_v in varchar2,
CHKTRADE IN VARCHAR2,
sharepub_p in varchar2,
fmginsert in varchar2,
chkno in VARCHAR2,
chkdate in date:=null,
chkamt in VARCHAR2,
chkbankname in varchar2,
ourbank    in varchar2,
DEALERPANEL_P in VARCHAR2,
DEALERH_P in FLOAT,
DEALERW_P in FLOAT,
DEALERTYPE_P in VARCHAR2,
multiselect in VARCHAR2,
AGREEDRATE_ACTIVE NUMBER,
AGREEDAMT_ACTIVE NUMBER,
grossamtlocal_p number,
billamtlocal_p number,
chkadon_p varchar2,
refid_p varchar2,
rcpt_currency varchar2,
cur_convrate varchar2,
p_revisedate IN       DATE,
clienttype varchar2,
p_error out varchar2
   );
END Insertintobooking;
/





CREATE OR REPLACE PACKAGE BODY insertintobooking
IS
   PROCEDURE insertintobooking_p (
      date_time            IN       DATE,
      adsizetype           IN       VARCHAR2,
      branch               IN       VARCHAR2,
      booked_by            IN       VARCHAR2,
      prevbook             IN       VARCHAR2,
      approvedby           IN       VARCHAR2,
      ciobookid            IN       VARCHAR2,
      audit1               IN       VARCHAR2,
      rono                 IN       VARCHAR2,
      rodate               IN       DATE,
      caption              IN       VARCHAR2,
      billstatus           IN       VARCHAR2,
      rostatus             IN       VARCHAR2,
      agency               IN       VARCHAR2,
      client               IN       VARCHAR2,
      agencyaddress        IN       VARCHAR2,
      clientaddresses      IN       VARCHAR2,
      agencycode           IN       VARCHAR2,
      dockitno             IN       VARCHAR2,
      execname             IN       VARCHAR2,
      execzone             IN       VARCHAR2,
      product              IN       VARCHAR2,
      brand                IN       VARCHAR2,
      keyno                IN       VARCHAR2,
      billremark           IN       VARCHAR2,
      printremark          IN       VARCHAR2,
      package1             IN       VARCHAR2,
      insertion            IN       NUMBER,
      startdate            IN       DATE,
      repeatdate           IN       VARCHAR2,
      adtype1              IN       VARCHAR2,
      adcategory           IN       VARCHAR2,
      subcategory          IN       VARCHAR2,
      color                IN       VARCHAR2,
      uom                  IN       VARCHAR2,
      pageposition         IN       VARCHAR2,
      pagetype1            IN       VARCHAR2,
      pageno               IN       NUMBER,
      adsizheight          IN       NUMBER,
      adsizwidth           IN       NUMBER,
      scheme1              IN       VARCHAR2,
      currency             IN       VARCHAR2,
      ratecode11           IN       VARCHAR2,
      agreedrate           IN       NUMBER,
      agreedamt            IN       NUMBER,
      spedisc              IN       NUMBER,
      compcode             IN       VARCHAR2,
      spacedisx            IN       NUMBER,
      specialcharges       IN       NUMBER,
      userid               IN       VARCHAR2,
      agencytype           IN       VARCHAR2,
      agencystatus         IN       VARCHAR2,
      paymode              IN       VARCHAR2,
      agenccredit          IN       NUMBER,
      cardrate             IN       NUMBER,
      cardamount           IN       NUMBER,
      discount             IN       NUMBER,
      discountper          IN       NUMBER,
      billaddress          IN       VARCHAR2,
      totarea              IN       NUMBER,
      billcycle            IN       VARCHAR2,
      billpay              IN       VARCHAR2,
      revenuecenter        IN       VARCHAR2,
      billheight           IN       NUMBER,
      billwidth            IN       NUMBER,
      billto               IN       VARCHAR2,
      invoices             IN       NUMBER,
      vts                  IN       NUMBER,
      tradedisc            IN       NUMBER,
      agencyout            IN       VARCHAR2,
      boxcode              IN       VARCHAR2,
      boxno                IN       VARCHAR2,
      boxagency            IN       VARCHAR2,
      boxaddress           IN       VARCHAR2,
      boxclient            IN       VARCHAR2,
      coupan               IN       VARCHAR2,
      bookingtype          IN       VARCHAR2,
      tfn                  IN       VARCHAR2,
      campaign             IN       VARCHAR2,
      bill_amt             IN       NUMBER,
      pageprem             IN       VARCHAR2,
      pageamt              IN       NUMBER,
      premper              IN       NUMBER,
      grossamt             IN       NUMBER,
      adsizcolumn          IN       NUMBER,
      billcolumn           IN       NUMBER,
      specdiscper          IN       NUMBER,
      spacediscper         IN       NUMBER,
      billarea             IN       NUMBER,
      paidins              IN       NUMBER,
      dealrate             IN       NUMBER,
      deviation            IN       NUMBER,
      varient              IN       VARCHAR2,
      contractname         IN       VARCHAR2,
      dealtype             IN       VARCHAR2,
      cardname             IN       VARCHAR2,
      cardtype             IN       VARCHAR2,
      cardmonth            IN       VARCHAR2,
      cardyear             IN       VARCHAR2,
      cardno               IN       VARCHAR2,
      receiptno            IN       VARCHAR2,
      adscat3              IN       VARCHAR2,
      adscat4              IN       VARCHAR2,
      adscat5              IN       VARCHAR2,
      bgcolor              IN       VARCHAR2,
      bulletcode           IN       VARCHAR2,
      bulletprm            IN       NUMBER,
      material             IN       VARCHAR2,
      receiptdate          IN       DATE := NULL,
      prevcioid            IN       VARCHAR2 := NULL,
      prevreceipt          IN       VARCHAR2 := NULL,
      prev_ga              IN       NUMBER := NULL,
      varient_name         IN       VARCHAR2 := NULL,
      region1              IN       VARCHAR2 := NULL,
      coltype              IN       VARCHAR2,
      logo_h               IN       VARCHAR2,
      logo_w               IN       VARCHAR2,
      logo_col             IN       VARCHAR2,
      logo_uom             IN       VARCHAR2,
      retainer1            IN       VARCHAR2,
      addagencyrate        IN       VARCHAR2,
      mobileno             IN       VARCHAR2,
      addlamt              IN       VARCHAR2,
      retamt               IN       VARCHAR2,
      retper               IN       VARCHAR2,
      cashrecieved         IN       NUMBER,
      ciragency_v          IN       VARCHAR2,
      cirrate_v            IN       VARCHAR2,
      ciredition_v         IN       VARCHAR2,
      cirpublication_v     IN       VARCHAR2,
      ciragencysubcode_v   IN       VARCHAR2,
      bartertype           IN       VARCHAR2,
      CASHDISCOUNT_V IN VARCHAR2,
CASHDISCOUNTPER_V IN VARCHAR2,
attach1 in varchar2,
attach2 in varchar2,
drpdiscprem in varchar2,
doctype_v in varchar2,
CHKTRADE IN VARCHAR2,
sharepub_p in varchar2,
fmginsert in varchar2,
chkno in VARCHAR2,
chkdate in date:=null,
chkamt in VARCHAR2,
chkbankname in varchar2,
ourbank    in varchar2,
DEALERPANEL_P in VARCHAR2,
DEALERH_P in FLOAT,
DEALERW_P in FLOAT,
DEALERTYPE_P in VARCHAR2,
multiselect in VARCHAR2,
AGREEDRATE_ACTIVE NUMBER,
AGREEDAMT_ACTIVE NUMBER,
grossamtlocal_p number,
billamtlocal_p number,
chkadon_p varchar2,
refid_p varchar2,
rcpt_currency varchar2,
cur_convrate varchar2,
p_revisedate IN       DATE,
clienttype varchar2,
p_error              OUT      VARCHAR2
   )
   AS
      sccode   VARCHAR2 (50);
      agencytype1 varchar2(20);
       error1 varchar2(100);
       rate_auth varchar2(2);
       bk_audit varchar2(2);
       auditn varchar2(50);
       username_v varchar2(50);
       roleid_v varchar2(20);
       RELAUTHREQ varchar2(1);
   BEGIN
   agencytype1:=agencytype;
   if agencytype is null then
    select "Agency_Type_Code" into agencytype1 from agency_mast where "code_subcode"=agencycode;
   end if;
   select RATE_AUTHORIZATION,"audit",RELAUTHREQON into rate_auth,bk_audit,RELAUTHREQ from preferrences where "comp_code"=compcode;
      -- BEGIN
           --SELECT distinct "scheme_id" INTO sccode FROM SCHEME_MASTER WHERE "Scheme_Name"=LTRIM(RTRIM(scheme1)) AND ("Comp_code"=compcode);
          -- EXCEPTION WHEN NO_DATA_FOUND THEN NULL ;
      -- END;
     select "username",ROLEID into username_v,roleid_v from login where "userid"=userid;   
    if roleid_v!='SE0' AND RELAUTHREQ != 'A' then 
        IF RELAUTHREQ = 'D' THEN
            if rate_auth='Y' and bk_audit='y' and agreedamt is null then
               
                auditn:=username_v;
            else
                auditn:=audit1;    
            end if;
        ELSE
        
            auditn:=username_v;    
        END IF;    
    else
     auditn:=audit1; 
    end if;    
      sccode := scheme1;
  
     
      /*INSERT INTO tbl_booking_mast
                  ("date_time", "branch", "booked_by", "cio_booking_id",
                   "prev_booking", "applied_by", "audit", "RO_No",
                   "RO_Date", "Caption", "bill_status", "ro_status",
                   "Agency_code", "Agency_address", "Client_code",
                   "Client_address", "Agency_sub_code", "Dockit_no",
                   "Executive_code", "Executive_zone", "Product_code",
                   "Brand_code", "Key_no", "Bill_remarks", "Print_remark",
                   "Package_code", "No_of_insertion", "Insertion_date",
                   "Repeating_day", "Ad_type_code", "Ad_cat_code",
                   "Ad_sub_cat_code", "Color_code", "Uom_code",
                   "Page_position_code", "Page_type_code", "Page_no",
                   "Ad_size_type_code", "Ad_size_height", "Ad_size_width",
                   "Rate_code", "Scheme_type_code", "Currency_code",
                   "Agrred_rate", "Agreed_amount", "Special_discount",
                   "Space_discount", "Special_charges", "Comp_code",
                   "Userid", "Agency_status", "Agency_type", "Agency_pay",
                   "Agency_credit", "Total_area", "Card_rate",
                   "Card_amount", "Discount", "Discount_per", "Bill_cycle",
                   "Revenue_center", "Bill_pay", "Bill_height",
                   "Bill_width", "Bill_to", "Invoices", "Vts", "Bill_add",
                   "Trade_disc", "Agency_out", "Box_code", "Box_no",
                   "Box_agency", "Box_client", "Box_address",
                   "Booking_type", "Tfn", "Coupan_ad", "Campaign",
                   "Bill_amount", "Page_prem", "Page_amount", "Prem_per",
                   "Gross_amount", "Ad_size_column", "Bill_column",
                   "Bill_area", "Special_disc_per", "Space_disc_per",
                   "Paid_ins", "Contract_rate", "Deviation", "Variant_code",
                   "Contract_name", "Contract_type", "Card_name",
                   "Card_type", "Card_month", "Card_year", "Card_number",
                   "Receipt_no", "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5",
                   "Bg_color", "Bullet_code", "Bullet_premium",
                   "Material_status", "Receipt_date", "prev_cioid",
                   "prev_receipt", "prev_grossamt", "Region", "Variant",
                   "Colortype", "Logo_H", "Logo_W", "Logo_color",
                   "Logo_Uom", "Creation_datetime", "RETAINER",
                   "ADD_AGENCY_COMM", mobileno, add_agency_comm_amt,
                   retainer_comm, retainer_comm_amt, cash_recieved,
                   ciragency, cirrate, ciredition, cirpublication,
                   ciragency_subcode, barter_type
                  )
           VALUES (date_time, branch, booked_by, ciobookid,
                   prevbook, approvedby, audit1, rono,
                   rodate, caption, billstatus, rostatus,
                   agency, agencyaddress, client,
                   clientaddresses, agencycode, dockitno,
                   execname, execzone, product,
                   brand, keyno, billremark, printremark,
                   package1, insertion, startdate,
                   repeatdate, adtype1, adcategory,
                   subcategory, color, uom,
                   pageposition, pagetype1, pageno,
                   adsizetype, adsizheight, adsizwidth,
                   ratecode11, sccode, currency,
                   agreedrate, agreedamt, spedisc,
                   spacedisx, specialcharges, compcode,
                   userid, agencystatus, agencytype, paymode,
                   agenccredit, totarea, cardrate,
                   cardamount, discount, discountper, billcycle,
                   revenuecenter, billpay, billheight,
                   billwidth, billto, invoices, vts, billaddress,
                   tradedisc, agencyout, boxcode, boxno,
                   boxagency, boxclient, boxaddress,
                   bookingtype, tfn, coupan, campaign,
                   bill_amt, pageprem, pageamt, premper,
                   grossamt, adsizcolumn, billcolumn,
                   billarea, specdiscper, spacediscper,
                   paidins, dealrate, deviation, varient,
                   contractname, dealtype, cardname,
                   cardtype, cardmonth, cardyear, cardno,
                   receiptno, adscat3, adscat4, adscat5,
                   bgcolor, bulletcode, bulletprm,
                   material, receiptdate, prevcioid,
                   prevreceipt, prev_ga, region1, varient_name,
                   coltype, logo_h, logo_w, logo_col,
                   logo_uom, SYSDATE, retainer1,
                   addagencyrate, mobileno, addlamt,
                   retper, retamt, cashrecieved,
                   ciragency_v, cirrate_v, ciredition_v, cirpublication_v,
                   ciragencysubcode_v, bartertype
                  );
                  */
                  INSERT INTO tbl_booking_mast_g
                  (DATE_TIME, BRANCH, BOOKED_BY, CIO_BOOKING_ID,
                   PREV_BOOKING, APPLIED_BY, AUDIT_G, RO_NO,
                   RO_DATE, CAPTION, BILL_STATUS, RO_STATUS,
                   AGENCY_CODE, AGENCY_ADDRESS, CLIENT_CODE,
                   CLIENT_ADDRESS, AGENCY_SUB_CODE, DOCKIT_NO,
                   EXECUTIVE_CODE, EXECUTIVE_ZONE, PRODUCT_CODE,
                   BRAND_CODE, KEY_NO, BILL_REMARKS, PRINT_REMARK,
                   PACKAGE_CODE, NO_OF_INSERTION, INSERTION_DATE,
                   REPEATING_DAY, AD_TYPE_CODE, AD_CAT_CODE,
                   AD_SUB_CAT_CODE, COLOR_CODE, UOM_CODE,
                   PAGE_POSITION_CODE, PAGE_TYPE_CODE, PAGE_NO,
                   AD_SIZE_TYPE_CODE, AD_SIZE_HEIGHT, AD_SIZE_WIDTH,
                   RATE_CODE, SCHEME_TYPE_CODE, CURRENCY_CODE,
                   AGRRED_RATE, AGREED_AMOUNT, SPECIAL_DISCOUNT,
                   SPACE_DISCOUNT, SPECIAL_CHARGES, COMP_CODE,
                   USERID, AGENCY_STATUS, AGENCY_TYPE, AGENCY_PAY,
                   AGENCY_CREDIT, TOTAL_AREA, CARD_RATE,
                   CARD_AMOUNT, DISCOUNT, DISCOUNT_PER, BILL_CYCLE,
                   REVENUE_CENTER, BILL_PAY, BILL_HEIGHT,
                   BILL_WIDTH, BILL_TO, INVOICES, VTS, BILL_ADD,
                   TRADE_DISC, AGENCY_OUT, BOX_CODE, BOX_NO,
                   BOX_AGENCY, BOX_CLIENT, BOX_ADDRESS,
                   BOOKING_TYPE, TFN, COUPAN_AD, CAMPAIGN,
                   BILL_AMOUNT, PAGE_PREM, PAGE_AMOUNT, PREM_PER,
                   GROSS_AMOUNT, AD_SIZE_COLUMN, BILL_COLUMN,
                   BILL_AREA, SPECIAL_DISC_PER, SPACE_DISC_PER,
                   PAID_INS, CONTRACT_RATE, DEVIATION, VARIANT_CODE,
                   CONTRACT_NAME, CONTRACT_TYPE, CARD_NAME,
                   CARD_TYPE, CARD_MONTH, CARD_YEAR, CARD_NUMBER,
                   RECEIPT_NO, AD_SUBCAT3, AD_SUBCAT4, AD_SUBCAT5,
                   BG_COLOR, BULLET_CODE, BULLET_PREMIUM,
                   MATERIAL_STATUS, RECEIPT_DATE, PREV_CIOID,
                   PREV_RECEIPT, PREV_GROSSAMT, REGION, VARIANT,
                   COLORTYPE, LOGO_H, LOGO_W, LOGO_COLOR,
                   LOGO_UOM, CREATION_DATETIME, RETAINER,
                   ADD_AGENCY_COMM, MOBILENO, ADD_AGENCY_COMM_AMT,
                   RETAINER_COMM, RETAINER_COMM_AMT, CASH_RECIEVED,
                   CIRAGENCY, CIRRATE, CIREDITION, CIRPUBLICATION,
                   CIRAGENCY_SUBCODE, BARTER_TYPE, SESID,CASHDISCOUNT,CASHDISCTYPE,ATTACHMENT1,ATTACHMENT2,DISC_PREMIUM,DOCTYPE,CHKTRADEDISC,
                   CHK_NO,CHK_DATE,CHK_AMT,CHK_BANK_NAME,OUR_BANK,DEALERPANEL, DEALER_H, DEALER_W, DEALERTYPE, ACTIVE_AGREEDRATE, ACTIVE_AGREEDAMT,
                    LOCALGROSSAMT, LOCALBILLAMT,PACKAGE_TYPE, AD_REFID, RECEIPT_CURRENCY, CONV_CURR_RATE,
                    REVISE_DATE,CLIENT_TYPE
                  )
           VALUES (date_time, branch, booked_by, ciobookid,
                   prevbook, approvedby, auditn, rono,
                   rodate, caption, billstatus, rostatus,
                   agency, agencyaddress, client,
                   clientaddresses, agencycode, dockitno,
                   execname, execzone, product,
                   brand, keyno, billremark, printremark,
                   package1, insertion, startdate,
                   repeatdate, adtype1, adcategory,
                   subcategory, color, uom,
                   pageposition, pagetype1, pageno,
                   adsizetype, adsizheight, adsizwidth,
                   ratecode11, sccode, currency,
                   agreedrate, agreedamt, spedisc,
                   spacedisx, specialcharges, compcode,
                   userid, agencystatus, agencytype1, paymode,
                   agenccredit, totarea, cardrate,
                   cardamount, discount, discountper, billcycle,
                   revenuecenter, billpay, billheight,
                   billwidth, billto, invoices, vts, billaddress,
                   tradedisc, agencyout, boxcode, boxno,
                   boxagency, boxclient, boxaddress,
                   bookingtype, tfn, coupan, campaign,
                   bill_amt, pageprem, pageamt, premper,
                   grossamt, adsizcolumn, billcolumn,
                   billarea, specdiscper, spacediscper,
                   paidins, dealrate, deviation, varient,
                   contractname, dealtype, cardname,
                   cardtype, cardmonth, cardyear, cardno,
                   receiptno, adscat3, adscat4, adscat5,
                   bgcolor, bulletcode, bulletprm,
                   material, receiptdate, prevcioid,
                   prevreceipt, prev_ga, region1, varient_name,
                   coltype, logo_h, logo_w, logo_col,
                   logo_uom, SYSDATE, retainer1,
                   addagencyrate, mobileno, addlamt,
                   retper, retamt, cashrecieved,
                   ciragency_v, cirrate_v, ciredition_v, cirpublication_v,
                   ciragencysubcode_v, bartertype,USERENV ('sessionid'),CASHDISCOUNT_V,CASHDISCOUNTPER_V,attach1,attach2,drpdiscprem,doctype_v,CHKTRADE
                  ,chkno,chkdate,chkamt,chkbankname,ourbank,DEALERPANEL_P,
                    DEALERH_P,
                    DEALERW_P,
                    DEALERTYPE_P,AGREEDRATE_ACTIVE,
                    AGREEDAMT_ACTIVE,grossamtlocal_p,billamtlocal_p,chkadon_p,refid_p,rcpt_currency,cur_convrate,
                    p_revisedate,clienttype);
                  IF sharepub_p is not null then
                        insert_sharepub_details(sharepub_p,ciobookid,'INSERT',error1);
                  end if;
                  
                  if fmginsert is not null then
                    insert_fmgTrans_details(fmginsert,ciobookid,'INSERT',error1);   
                  end if;   
                  if multiselect is not null then
                    insert_multiexec_details(userid,compcode,multiselect,ciobookid,'INSERT',error1);
                  end if;  
                 
   EXCEPTION
      WHEN OTHERS
      THEN
         p_error := 'Error :' || SQLERRM;
         
         
         
   END insertintobooking_p;
END insertintobooking;
/

/******************************/


CREATE OR REPLACE PROCEDURE committransaction(
    pcioid          in  varchar2,
    totalcount      in  int,
    pcompcode       in  varchar2,
    pcentname       in  varchar2,
    puserid         in  varchar2,
    pbkid_gentype   in  varchar2,
    pbk_type        in  varchar2,
    p_error         OUT VARCHAR2,
    p_new_cioid     OUT VARCHAR2) is
    
countnum        int;
newid           varchar2(100);
billpay         varchar2(20);
rostatus        varchar2(20);
remarks         varchar2(500);
clientname      varchar2(200);
v_cursor1       TYPES.cursor_type;
v_cursor2       TYPES.cursor_type;

v_cursor1_var1  varchar2(50);
v_cursor1_var2  varchar2(50);
v_cursor2_var1  varchar2(50);

begin
newid:=pcioid;

select count(*) into countnum from tbl_booking_insert_g where Cio_Booking_Id=pcioid;
if(countnum=totalcount) then 
     
    
   getautocodebooking.getautocodebooking_p (compcode        =>  pcompcode,
                                            auto1           =>  '0',
                                            no1             =>  '0',
                                            p_accounts      =>  v_cursor1,
                                            p_accounts1     =>  v_cursor2);
                                            
    FETCH v_cursor1 INTO v_cursor1_var1, v_cursor1_var2;
    
    FETCH v_cursor2 INTO v_cursor2_var1;
    
    if  pbkid_gentype='1' then--1 for First 3 character of Centre Name+Year + Slno  
        
        newid:=substr(pcentname,1,3)||v_cursor1_var2||LPAD(v_cursor1_var1,8,'0');
    
    elsif  pbkid_gentype='2' then--2 for First 3 character of Centre Name+Year + Userid + Slno
    
        newid:=substr(pcentname,1,3)||v_cursor1_var2||LPAD(v_cursor1_var1,8,'0')||puserid;

    elsif  pbkid_gentype='4' then--BK Type + Slno

        newid:=pbk_type||LPAD(v_cursor1_var1,8,'0');

    else

        newid:=LPAD(v_cursor1_var1,8,'0');

    end if; 
    
    p_error     :='Y';
    p_new_cioid := newid;

    INSERT INTO tbladid_ins(CIOID,COUNTNUM,FLAG) VALUES(newid,countnum,p_error);
    INSERT INTO TBL_BOOKING_MAST("date_time", "branch", "booked_by", "cio_booking_id", "prev_booking", "applied_by", "audit", "RO_No", "RO_Date", "Caption", "bill_status", "ro_status", "Agency_code", "Agency_address", "Client_code", "Client_address", "Agency_sub_code", "Dockit_no", "Executive_code", "Executive_zone", "Product_code", "Brand_code", "Key_no", "Bill_remarks", "Print_remark", "Package_code", "No_of_insertion", "Insertion_date", "Repeating_day", "Ad_type_code", "Ad_cat_code", "Ad_sub_cat_code", "Color_code", "Uom_code", "Page_position_code", "Page_type_code", "Page_no", "Ad_size_type_code", "Ad_size_height", "Ad_size_width", "Rate_code", "Scheme_type_code", "Currency_code", "Agrred_rate", "Agreed_amount", "Special_discount", "Space_discount", "Special_charges", "Agency_status", "Agency_type", "Agency_pay", "Agency_credit", "Total_area", "Card_rate", "Card_amount", "Discount", "Discount_per", "Bill_cycle", "Revenue_center", "Bill_pay", "Bill_height", "Bill_width", "Bill_to", "Invoices", "Vts", "Bill_add", "Trade_disc", "Agency_out", "Box_code", "Box_no", "Box_agency", "Box_client", "Box_address", "Comp_code", "Userid", "Creation_datetime", "Booking_type", "Tfn", "Coupan_ad", "Campaign", "Bill_amount", "Page_prem", "Page_amount", "Prem_per", "Gross_amount", "Ad_size_column", "Bill_column", "Bill_area", "Special_disc_per", "Space_disc_per", "Paid_ins", "Contract_rate", "Deviation", "Variant_code", "Contract_name", "Contract_type", "Card_name", "Card_type", "Card_month", "Card_year", "Card_number", "Receipt_no", "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color", "Bullet_code", "Bullet_premium", "Material_status", "Receipt_date", "prev_cioid", "prev_receipt", "prev_grossamt", "Region", "Variant", "Colortype", "Logo_H", "Logo_W", "Logo_color", "Logo_Uom", "SAPID", "RETAINER", "ADD_AGENCY_COMM", "AUDIT_COMMENT", "MOBILENO", "ADD_AGENCY_COMM_AMT", "RETAINER_COMM", "RETAINER_COMM_AMT", "CASH_RECIEVED", "CONT_GROSS", "CIRAGENCY", "CIRRATE", "CIREDITION", "CIRPUBLICATION", "CIRAGENCY_SUBCODE", "BARTER_TYPE", "APP_STATUS", "APP_REMARKS", "APP_DATE", "APP_USER", "RODOCSTATUS",CASHDISCOUNT, CASHDISCTYPE, ATTACHMENT1, ATTACHMENT2,DISC_PREMIUM,DOCTYPE,CHKTRADEDISC,CHK_NO,CHK_DATE,CHK_AMT,CHK_BANK_NAME,OUR_BANK,DEALERPANEL, DEALER_H, DEALER_W, DEALERTYPE,ACTIVE_AGREEDRATE, ACTIVE_AGREEDAMT,LOCALGROSSAMT, LOCALBILLAMT, PACKAGE_TYPE, AD_REFID,RECEIPT_CURRENCY, CONV_CURR_RATE,REVISE_DATE,CLIENT_TYPE) 
    SELECT DATE_TIME, BRANCH, BOOKED_BY, newid CIO_BOOKING_ID, PREV_BOOKING, APPLIED_BY, AUDIT_G, RO_NO, RO_DATE, CAPTION, BILL_STATUS, RO_STATUS, AGENCY_CODE, AGENCY_ADDRESS, CLIENT_CODE, CLIENT_ADDRESS, AGENCY_SUB_CODE, DOCKIT_NO, EXECUTIVE_CODE, EXECUTIVE_ZONE, PRODUCT_CODE, BRAND_CODE, KEY_NO, BILL_REMARKS, PRINT_REMARK, PACKAGE_CODE, NO_OF_INSERTION, INSERTION_DATE, REPEATING_DAY, AD_TYPE_CODE, AD_CAT_CODE, AD_SUB_CAT_CODE, COLOR_CODE, UOM_CODE, PAGE_POSITION_CODE, PAGE_TYPE_CODE, PAGE_NO, AD_SIZE_TYPE_CODE, AD_SIZE_HEIGHT, AD_SIZE_WIDTH, RATE_CODE, SCHEME_TYPE_CODE, CURRENCY_CODE, AGRRED_RATE, AGREED_AMOUNT, SPECIAL_DISCOUNT, SPACE_DISCOUNT, SPECIAL_CHARGES, AGENCY_STATUS, AGENCY_TYPE, AGENCY_PAY, AGENCY_CREDIT, TOTAL_AREA, CARD_RATE, CARD_AMOUNT, DISCOUNT, DISCOUNT_PER, BILL_CYCLE, REVENUE_CENTER, BILL_PAY, BILL_HEIGHT, BILL_WIDTH, BILL_TO, INVOICES, VTS, BILL_ADD, TRADE_DISC, AGENCY_OUT, BOX_CODE, BOX_NO, BOX_AGENCY, BOX_CLIENT, BOX_ADDRESS, COMP_CODE, USERID, CREATION_DATETIME, BOOKING_TYPE, TFN, COUPAN_AD, CAMPAIGN, BILL_AMOUNT, PAGE_PREM, PAGE_AMOUNT, PREM_PER, GROSS_AMOUNT, AD_SIZE_COLUMN, BILL_COLUMN, BILL_AREA, SPECIAL_DISC_PER, SPACE_DISC_PER, PAID_INS, CONTRACT_RATE, DEVIATION, VARIANT_CODE, CONTRACT_NAME, CONTRACT_TYPE, CARD_NAME, CARD_TYPE, CARD_MONTH, CARD_YEAR, CARD_NUMBER, RECEIPT_NO, AD_SUBCAT3, AD_SUBCAT4, AD_SUBCAT5, BG_COLOR, BULLET_CODE, BULLET_PREMIUM, MATERIAL_STATUS, RECEIPT_DATE, PREV_CIOID, PREV_RECEIPT, PREV_GROSSAMT, REGION, VARIANT, COLORTYPE, LOGO_H, LOGO_W, LOGO_COLOR, LOGO_UOM, SAPID, RETAINER, ADD_AGENCY_COMM, AUDIT_COMMENT, MOBILENO, ADD_AGENCY_COMM_AMT, RETAINER_COMM, RETAINER_COMM_AMT, CASH_RECIEVED, CONT_GROSS, CIRAGENCY, CIRRATE, CIREDITION, CIRPUBLICATION, CIRAGENCY_SUBCODE, BARTER_TYPE, APP_STATUS, APP_REMARKS, APP_DATE, APP_USER, RODOCSTATUS,CASHDISCOUNT, CASHDISCTYPE, ATTACHMENT1, ATTACHMENT2, DISC_PREMIUM, DOCTYPE,CHKTRADEDISC,CHK_NO,CHK_DATE,CHK_AMT,CHK_BANK_NAME,OUR_BANK, DEALERPANEL, DEALER_H, DEALER_W, DEALERTYPE,ACTIVE_AGREEDRATE, ACTIVE_AGREEDAMT,LOCALGROSSAMT, LOCALBILLAMT, PACKAGE_TYPE, AD_REFID, RECEIPT_CURRENCY, CONV_CURR_RATE,REVISE_DATE,CLIENT_TYPE FROM TBL_BOOKING_MAST_G WHERE  CIO_BOOKING_ID=pcioid;

    INSERT INTO TBL_BOOKING_insert("Insert_Id", "Cio_Booking_Id", "No_Insert", "Edition_Code", "Publication_Code", "Pub_Cent_Code", "Supp_Code", "Edition", "Insert_Date", "Col_Code", "Height", "Width", "Size_Book", "Page_Post", "Premium1", "Prem_Per1", "Premium2", "Prem_Per2", "Premium_Allow", "Ad_Cat", "Ad_Sub_Cat", "Latest_By", "Repeating_Date", "Status_Material", "File_Name", "Card_Rate", "Disc_Rate", "Insert_Status", "Bill_Status", "Agreed_Rate", "Pai_Free_Ins", "Solo_Rate", "Gross_Rate", "Comp_Code", "Userid", "Page_No", "Remarks", "Pub_Height", "Pub_Width", "Page_Prem", "Page_Per", "No_Ofcolumn", "Bill_Amt", "Bill_Rate", "Logo_H", "Logo_W", "Logo_name", "AD_SUBCAT3", "AD_SUBCAT4", "AD_SUBCAT5", "PACKAGE_CODE", "BILL_NO", "BILL_DATE", "INSERTS", "PKG_ALIAS", "CONT_GROSS_AMT", "APP_STATUS", "APP_REMARKS", "APP_DATE", "APP_USER",SPECIAL_SIZE1,VATAMT,BOXCHARGE,VAT_INC,LOCALGROSSAMT, LOCALBILLAMT,SECTIONCODE,RESOURCE_NO) 
    SELECT INSERT_ID, newid CIO_BOOKING_ID, NO_INSERT, EDITION_CODE, PUBLICATION_CODE, PUB_CENT_CODE, SUPP_CODE, EDITION, INSERT_DATE, COL_CODE, HEIGHT, WIDTH, SIZE_BOOK, PAGE_POST, PREMIUM1, PREM_PER1, PREMIUM2, PREM_PER2, PREMIUM_ALLOW, AD_CAT, AD_SUB_CAT, LATEST_BY, REPEATING_DATE, STATUS_MATERIAL, FILE_NAME, CARD_RATE, DISC_RATE, INSERT_STATUS, BILL_STATUS, AGREED_RATE, PAI_FREE_INS, SOLO_RATE, GROSS_RATE, COMP_CODE, USERID, PAGE_NO, REMARKS, PUB_HEIGHT, PUB_WIDTH, PAGE_PREM, PAGE_PER, NO_OFCOLUMN, BILL_AMT, BILL_RATE, LOGO_H, LOGO_W, LOGO_NAME, AD_SUBCAT3, AD_SUBCAT4, AD_SUBCAT5, PACKAGE_CODE, BILL_NO, BILL_DATE, INSERTS, PKG_ALIAS, CONT_GROSS_AMT, APP_STATUS, APP_REMARKS, APP_DATE, APP_USER, SPECIAL_SIZE1,VATAMT, BOXCHARGE, VAT_INC,LOCALGROSSAMT, LOCALBILLAMT, SECTIONCODE, RESOURCE_NO FROM TBL_BOOKING_INSERT_G WHERE  CIO_BOOKING_ID=pcioid;

    INSERT INTO TBL_BOOKING_VTS(COMPCODE, CIOID, INSERTID, VTS, PUBLICATION, EDITION, RATE, CREATIONDATETIME, CIRAGCODE, CIRAGSUBCODE, CENTER, BRANCH, PUBLISHDATE) 
    SELECT COMPCODE, newid CIOID, INSERTID, VTS, PUBLICATION, EDITION, RATE, CREATIONDATETIME, CIRAGCODE, CIRAGSUBCODE, CENTER, BRANCH, PUBLISHDATE FROM TBL_BOOKING_VTS_G WHERE  cioid=pcioid;

    insert into tbl_booking_insert_sizesplit(CIOID, RECEIPTNO, INSERTID, INSERTDATE, HEIGHT, WIDTH, AREA, SRNO, CREATIONDATETIME)
    select newid CIOID, RECEIPTNO, INSERTID, INSERTDATE, HEIGHT, WIDTH, AREA, SRNO, CREATIONDATETIME from tbl_booking_insert_sizesplit_g where cioid=pcioid;

    --INSERT INTO ABCTEST VALUES(newid,counttest);
    insert into tbl_booking_subedition(COMP_CODE, CIOID, INSERTID, PUBLICATION, EDITION, INSERTDATE, HEIGHT, WIDTH, TOTALAREA, INSERTSTATUS, RECEIPTNO,SRNO, NO_INSERT)
    select COMP_CODE, newid CIOID, INSERTID, PUBLICATION, EDITION, INSERTDATE, HEIGHT, WIDTH, TOTALAREA, INSERTSTATUS, RECEIPTNO, SRNO, NO_INSERT from tbl_booking_subedition_g
    where tbl_booking_subedition_g.CIOID=pcioid;

    insert into TBL_BOOKING_SHARING_TRANS(PUBLICATION, TYPE, SHARING, CIOID, SRNO)
    select PUBLICATION, TYPE, SHARING, newid CIOID, SRNO from TBL_BOOKING_SHARING_TRANS_g where CIOID=pcioid ;

    insert into TBL_BOOKING_FMG_TRANS(CIOID, INSERTID, CREATIONDATETIME)
    select newid CIOID, INSERTID, CREATIONDATETIME from TBL_BOOKING_FMG_TRANS_G where CIOID=cioid;

    select "Bill_pay","ro_status" into billpay,rostatus from tbl_booking_mast where "cio_booking_id"=newid;

    if billpay = 'CA0' and rostatus='1' then
        declare
            cursor c1 is
            select * from tbl_booking_mast where "cio_booking_id"=newid;
        v1 c1%rowtype;

        v_error      varchar2(2000);
        v_rcptno_r   varchar2(50);
        vrecpt       varchar2(20);
        branchcode   varchar2(20);
        vrepcode     varchar2(20);
        subagencyreg varchar2(20);
        prevcioid_v  varchar2(50);
        billamt_v    float;
        grossamt_v   float;
        v_curdate     date;
    begin
        open c1;
            fetch c1 into v1;
        Begin
            select "Branch_Code" into branchcode from branch_mst where "Comp_Code"=v1."Comp_code" and "Branch_Name"=v1."branch";
        Exception When no_data_found then
            branchcode:=v1."branch";
        End;
   
        Begin
            select "SUB_Agency_Code" into subagencyreg from agency_mast where "Comp_Code"=v1."Comp_code" and "code_subcode"=v1."Agency_sub_code";
        Exception When no_data_found then
            subagencyreg:='';
        End;
        vrecpt       :=v1."Receipt_no";
        prevcioid_v  :=v1."prev_cioid";
        if prevcioid_v is null or v1."prev_receipt" is null then
            billamt_v   :=v1."Bill_amount";
            grossamt_v  :=v1."Gross_amount";
            v_curdate   :=to_date(sysdate);
        else
            select "Bill_amount","Gross_amount" into  billamt_v,grossamt_v from tbl_booking_mast where "cio_booking_id"=prevcioid_v;
            billamt_v   :=v1."Bill_amount" - billamt_v;
            grossamt_v :=v1."Gross_amount" - grossamt_v;
            IF grossamt_v=0 OR grossamt_v IS NULL THEN
                grossamt_v:=v1."Gross_amount";
            END IF;
            v_curdate  :=to_date(sysdate);
        end if;

        -- select substr(max("recptno"),1,12)||lpad(substr(max("recptno"),-6)+1,6,'0') into vrecpt from ad_rcpthdr where "unit"=branchcode and "doctype"='RCP' and
        -- "recptdt" between '1-mar-2011' and '31-mar-2011';
         
        --receiptsave_booking.receiptsave_booking_P(pcompcode,puserid , punit ,ptype , precpt , prdate , ppaymodres ,preceivedreg ,pvouno  ,pamount  ,pagency , pothercd ,
        --pchno  ,pchedate , pbank  , pnarration ,prep   , pvdate , pag_main_code ,pag_sub_code , ourbank,  cioid , execname , retainer ,
        -- prevcioid , p_error)
        begin
            SELECT "Cust_Name" into clientname FROM CUST_MAST WHERE "Cust_Code" = v1."Client_code" and "Comp_Code"=v1."Comp_code";
        exception when NO_DATA_FOUND THEN
            clientname:=v1."Client_code";
        END;

        remarks:='RONO#'||v1."RO_No" ||' RODATE# ' || to_char(v1."RO_Date",'dd-mon-yyyy') || ' BOOKINGID# ' || v1."cio_booking_id" || ' CLIENT#' || clientname;

        receiptsave_booking.receiptsave_booking_p(v1."Comp_code",v1."Userid", v1."branch",V1.DOCTYPE,vrecpt,v_curdate,v1."Bill_pay",'','',billamt_v,v1."Agency_sub_code",grossamt_v,
            '','','',remarks,vrepcode,v1."date_time",v1."Agency_code",subagencyreg,'',v1."cio_booking_id",v1."Executive_code",v1.RETAINER,v1."prev_cioid",v_rcptno_r,v_error);
   
        update tbl_booking_mast set "Receipt_no"=v_rcptno_r,"Receipt_date"= v_curdate where "cio_booking_id"=v1."cio_booking_id";
    close c1;
    commit;
 end;
 end if;
 /*
 INSERT INTO TBL_BOOKING_MAST("date_time", "branch", "booked_by", "cio_booking_id", "prev_booking", "applied_by", "audit", "RO_No", "RO_Date", "Caption", "bill_status", "ro_status", "Agency_code", "Agency_address", "Client_code", "Client_address", "Agency_sub_code", "Dockit_no", "Executive_code", "Executive_zone", "Product_code", "Brand_code", "Key_no", "Bill_remarks", "Print_remark", "Package_code", "No_of_insertion", "Insertion_date", "Repeating_day", "Ad_type_code", "Ad_cat_code", "Ad_sub_cat_code", "Color_code", "Uom_code", "Page_position_code", "Page_type_code", "Page_no", "Ad_size_type_code", "Ad_size_height", "Ad_size_width", "Rate_code", "Scheme_type_code", "Currency_code", "Agrred_rate", "Agreed_amount", "Special_discount", "Space_discount", "Special_charges", "Agency_status", "Agency_type", "Agency_pay", "Agency_credit", "Total_area", "Card_rate", "Card_amount", "Discount", "Discount_per", "Bill_cycle", "Revenue_center", "Bill_pay", "Bill_height", "Bill_width", "Bill_to", "Invoices", "Vts", "Bill_add", "Trade_disc", "Agency_out", "Box_code", "Box_no", "Box_agency", "Box_client", "Box_address", "Comp_code", "Userid", "Creation_datetime", "Booking_type", "Tfn", "Coupan_ad", "Campaign", "Bill_amount", "Page_prem", "Page_amount", "Prem_per", "Gross_amount", "Ad_size_column", "Bill_column", "Bill_area", "Special_disc_per", "Space_disc_per", "Paid_ins", "Contract_rate", "Deviation", "Variant_code", "Contract_name", "Contract_type", "Card_name", "Card_type", "Card_month", "Card_year", "Card_number", "Receipt_no", "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color", "Bullet_code", "Bullet_premium", "Material_status", "Receipt_date", "prev_cioid", "prev_receipt", "prev_grossamt", "Region", "Variant", "Colortype", "Logo_H", "Logo_W", "Logo_color", "Logo_Uom", "SAPID", "RETAINER", "ADD_AGENCY_COMM", "AUDIT_COMMENT", "MOBILENO", "ADD_AGENCY_COMM_AMT", "RETAINER_COMM", "RETAINER_COMM_AMT", "CASH_RECIEVED", "CONT_GROSS", "CIRAGENCY", "CIRRATE", "CIREDITION", "CIRPUBLICATION", "CIRAGENCY_SUBCODE", "BARTER_TYPE", "APP_STATUS", "APP_REMARKS", "APP_DATE", "APP_USER", "RODOCSTATUS") 
SELECT DATE_TIME, BRANCH, BOOKED_BY, CIO_BOOKING_ID, PREV_BOOKING, APPLIED_BY, AUDIT_G, RO_NO, RO_DATE, CAPTION, BILL_STATUS, RO_STATUS, AGENCY_CODE, AGENCY_ADDRESS, CLIENT_CODE, CLIENT_ADDRESS, AGENCY_SUB_CODE, DOCKIT_NO, EXECUTIVE_CODE, EXECUTIVE_ZONE, PRODUCT_CODE, BRAND_CODE, KEY_NO, BILL_REMARKS, PRINT_REMARK, PACKAGE_CODE, NO_OF_INSERTION, INSERTION_DATE, REPEATING_DAY, AD_TYPE_CODE, AD_CAT_CODE, AD_SUB_CAT_CODE, COLOR_CODE, UOM_CODE, PAGE_POSITION_CODE, PAGE_TYPE_CODE, PAGE_NO, AD_SIZE_TYPE_CODE, AD_SIZE_HEIGHT, AD_SIZE_WIDTH, RATE_CODE, SCHEME_TYPE_CODE, CURRENCY_CODE, AGRRED_RATE, AGREED_AMOUNT, SPECIAL_DISCOUNT, SPACE_DISCOUNT, SPECIAL_CHARGES, AGENCY_STATUS, AGENCY_TYPE, AGENCY_PAY, AGENCY_CREDIT, TOTAL_AREA, CARD_RATE, CARD_AMOUNT, DISCOUNT, DISCOUNT_PER, BILL_CYCLE, REVENUE_CENTER, BILL_PAY, BILL_HEIGHT, BILL_WIDTH, BILL_TO, INVOICES, VTS, BILL_ADD, TRADE_DISC, AGENCY_OUT, BOX_CODE, BOX_NO, BOX_AGENCY, BOX_CLIENT, BOX_ADDRESS, COMP_CODE, USERID, CREATION_DATETIME, BOOKING_TYPE, TFN, COUPAN_AD, CAMPAIGN, BILL_AMOUNT, PAGE_PREM, PAGE_AMOUNT, PREM_PER, GROSS_AMOUNT, AD_SIZE_COLUMN, BILL_COLUMN, BILL_AREA, SPECIAL_DISC_PER, SPACE_DISC_PER, PAID_INS, CONTRACT_RATE, DEVIATION, VARIANT_CODE, CONTRACT_NAME, CONTRACT_TYPE, CARD_NAME, CARD_TYPE, CARD_MONTH, CARD_YEAR, CARD_NUMBER, RECEIPT_NO, AD_SUBCAT3, AD_SUBCAT4, AD_SUBCAT5, BG_COLOR, BULLET_CODE, BULLET_PREMIUM, MATERIAL_STATUS, RECEIPT_DATE, PREV_CIOID, PREV_RECEIPT, PREV_GROSSAMT, REGION, VARIANT, COLORTYPE, LOGO_H, LOGO_W, LOGO_COLOR, LOGO_UOM, SAPID, RETAINER, ADD_AGENCY_COMM, AUDIT_COMMENT, MOBILENO, ADD_AGENCY_COMM_AMT, RETAINER_COMM, RETAINER_COMM_AMT, CASH_RECIEVED, CONT_GROSS, CIRAGENCY, CIRRATE, CIREDITION, CIRPUBLICATION, CIRAGENCY_SUBCODE, BARTER_TYPE, APP_STATUS, APP_REMARKS, APP_DATE, APP_USER, RODOCSTATUS FROM TBL_BOOKING_MAST_G WHERE SESID=USERENV ('sessionid') and CIO_BOOKING_ID=cioid;

INSERT INTO TBL_BOOKING_insert("Insert_Id", "Cio_Booking_Id", "No_Insert", "Edition_Code", "Publication_Code", "Pub_Cent_Code", "Supp_Code", "Edition", "Insert_Date", "Col_Code", "Height", "Width", "Size_Book", "Page_Post", "Premium1", "Prem_Per1", "Premium2", "Prem_Per2", "Premium_Allow", "Ad_Cat", "Ad_Sub_Cat", "Latest_By", "Repeating_Date", "Status_Material", "File_Name", "Card_Rate", "Disc_Rate", "Insert_Status", "Bill_Status", "Agreed_Rate", "Pai_Free_Ins", "Solo_Rate", "Gross_Rate", "Comp_Code", "Userid", "Page_No", "Remarks", "Pub_Height", "Pub_Width", "Page_Prem", "Page_Per", "No_Ofcolumn", "Bill_Amt", "Bill_Rate", "Logo_H", "Logo_W", "Logo_name", "AD_SUBCAT3", "AD_SUBCAT4", "AD_SUBCAT5", "PACKAGE_CODE", "BILL_NO", "BILL_DATE", "INSERTS", "PKG_ALIAS", "CONT_GROSS_AMT", "APP_STATUS", "APP_REMARKS", "APP_DATE", "APP_USER") 
SELECT INSERT_ID, CIO_BOOKING_ID, NO_INSERT, EDITION_CODE, PUBLICATION_CODE, PUB_CENT_CODE, SUPP_CODE, EDITION, INSERT_DATE, COL_CODE, HEIGHT, WIDTH, SIZE_BOOK, PAGE_POST, PREMIUM1, PREM_PER1, PREMIUM2, PREM_PER2, PREMIUM_ALLOW, AD_CAT, AD_SUB_CAT, LATEST_BY, REPEATING_DATE, STATUS_MATERIAL, FILE_NAME, CARD_RATE, DISC_RATE, INSERT_STATUS, BILL_STATUS, AGREED_RATE, PAI_FREE_INS, SOLO_RATE, GROSS_RATE, COMP_CODE, USERID, PAGE_NO, REMARKS, PUB_HEIGHT, PUB_WIDTH, PAGE_PREM, PAGE_PER, NO_OFCOLUMN, BILL_AMT, BILL_RATE, LOGO_H, LOGO_W, LOGO_NAME, AD_SUBCAT3, AD_SUBCAT4, AD_SUBCAT5, PACKAGE_CODE, BILL_NO, BILL_DATE, INSERTS, PKG_ALIAS, CONT_GROSS_AMT, APP_STATUS, APP_REMARKS, APP_DATE, APP_USER FROM TBL_BOOKING_INSERT_G WHERE SESID=USERENV ('sessionid') and CIO_BOOKING_ID=cioid;

*/
else
rollback;
 p_error        :=  'N';
 p_new_cioid    :=  newid;
--DELETE FROM TBL_BOOKING_INSERT WHERE "Cio_Booking_Id"=cioid;
--DELETE FROM TBL_BOOKING_mast WHERE "cio_booking_id"=cioid;
INSERT INTO tbladid_ins(CIOID,COUNTNUM,FLAG) VALUES(newid,countnum,p_error);
end if;
--delete from tbl_booking_mast_g where  CIO_BOOKING_ID=cioid;
--delete from tbl_booking_insert_g where  CIO_BOOKING_ID=cioid;
--delete from tbl_booking_vts_g where  cioid=newid;
end;
/



/**********************************/



CREATE OR REPLACE PACKAGE Executebookingdisp
IS
  TYPE T_Accounts_Cursor IS REF CURSOR;
  PROCEDURE executebookingdisp_p(
  compcode IN VARCHAR2,
  ciobookid IN VARCHAR2,
  docno IN VARCHAR2:=NULL,
  keyno IN VARCHAR2:=NULL,
  rono IN VARCHAR2:=NULL,
  agencycode IN VARCHAR2:=NULL,
  client IN VARCHAR2:=NULL,
  booking IN VARCHAR2,dateformat IN VARCHAR2,
  revenue in varchar2,
  P_Accounts  OUT  T_Accounts_Cursor,P_Accounts1  OUT  T_Accounts_Cursor,P_Accounts2  OUT  T_Accounts_Cursor,
  P_Accounts3  OUT  T_Accounts_Cursor);
END Executebookingdisp ;
/





CREATE OR REPLACE PACKAGE BODY Executebookingdisp
IS
   PROCEDURE executebookingdisp_p (
      compcode      IN       VARCHAR2,
      ciobookid     IN       VARCHAR2,
      docno         IN       VARCHAR2 := NULL,
      keyno         IN       VARCHAR2 := NULL,
      rono          IN       VARCHAR2 := NULL,
      agencycode    IN       VARCHAR2 := NULL,
      client        IN       VARCHAR2 := NULL,
      booking       IN       VARCHAR2,
      dateformat     IN          VARCHAR2,
      revenue in varchar2,
      p_accounts    OUT      t_accounts_cursor,
      p_accounts1   OUT      t_accounts_cursor,
      p_accounts2   OUT      t_accounts_cursor,
      P_Accounts3  OUT  T_Accounts_Cursor
    
   )
   AS
      VERSION1   NUMBER;
      count1    NUMBER;

   BEGIN

       DELETE FROM TEMPBOOKING_MAST;
        
      INSERT INTO TEMPBOOKING_MAST
         SELECT "date_time", "branch", "booked_by", "cio_booking_id",
                "prev_booking", "applied_by", "audit", "RO_No", "RO_Date",
                "Caption", "bill_status", "ro_status", "Agency_code",
                "Agency_address", "Client_code", "Client_address",
                "Agency_sub_code", "Dockit_no", "Executive_code",
                "Executive_zone", "Product_code", "Brand_code", "Key_no",
                "Bill_remarks", "Print_remark", "Package_code",
                "No_of_insertion", "Insertion_date", "Repeating_day",
                "Ad_type_code", "Ad_cat_code", "Ad_sub_cat_code",
                "Color_code", "Uom_code", "Page_position_code",
                "Page_type_code", "Page_no", "Ad_size_type_code",
                "Ad_size_height", "Ad_size_width", "Rate_code",
                "Scheme_type_code", "Currency_code", NVL("Agrred_rate",'0'),
                NVL("Agreed_amount",'0'), "Special_discount", "Space_discount",
                "Special_charges", "Agency_status", "Agency_type",
                "Agency_pay", "Agency_credit", "Total_area", "Card_rate",
                "Card_amount", NVL("Discount",'0'), "Discount_per", "Bill_cycle",
                "Revenue_center", "Bill_pay", "Bill_height", "Bill_width",
                "Bill_to", "Invoices", "Vts", "Bill_add", "Trade_disc",
                "Agency_out", "Box_code", "Box_no", "Box_agency",
                "Box_client", "Box_address", "Comp_code", "Userid",
                "Creation_datetime", "Booking_type", "Tfn", "Coupan_ad",
                "Campaign", "Bill_amount", "Page_prem", "Page_amount",
                "Prem_per", "Gross_amount", "Ad_size_column", "Bill_column",
                "Bill_area", "Special_disc_per", "Space_disc_per",
                "Paid_ins", "Contract_rate", "Deviation", "Variant_code",
                "Contract_name", "Contract_type", "Card_name", "Card_type",
                "Card_month", "Card_year", "Card_number", "Receipt_no",
                "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color",
                "Bullet_code", "Bullet_premium", "Material_status",
                TRUNC("Receipt_date"), "prev_cioid", "prev_receipt",
                "prev_grossamt", "Region", "Variant", "Colortype", "Logo_H",
                "Logo_W", "Logo_color", "Logo_Uom",sapid,RETAINER,"ADD_AGENCY_COMM",MOBILENO,ADD_AGENCY_COMM_AMT,RETAINER_COMM,RETAINER_COMM_AMT,CASH_RECIEVED,
                CIRAGENCY,CIRRATE,CIREDITION,CIRPUBLICATION,CIRAGENCY_SUBCODE,BARTER_TYPE,CASHDISCOUNT, CASHDISCTYPE, ATTACHMENT1, ATTACHMENT2, DISC_PREMIUM, CHKTRADEDISC,
                CHK_DATE, CHK_AMT, CHK_BANK_NAME, OUR_BANK, CHK_NO,DEALERPANEL, DEALER_H, DEALER_W, DEALERTYPE,ACTIVE_AGREEDRATE,ACTIVE_AGREEDAMT,
                LOCALGROSSAMT,LOCALBILLAMT,PACKAGE_TYPE, AD_REFID, RECEIPT_CURRENCY, CONV_CURR_RATE,REVISE_DATE,CLIENT_TYPE
           FROM TBL_BOOKING_MAST
          WHERE ("Comp_code" = compcode OR compcode IS NULL)
            AND (("cio_booking_id" = ciobookid OR ciobookid IS NULL
                ) OR("Receipt_no"=ciobookid OR ciobookid IS NULL))
            AND ("Dockit_no" = docno  OR docno IS NULL)
            AND ("Key_no" = keyno  OR keyno IS NULL)
            AND ("RO_No" = rono  OR rono IS NULL)
            AND ("Agency_sub_code" LIKE agencycode || '%'
                 OR agencycode IS NULL
                )
            AND ("Client_code" LIKE client || '%' OR client IS NULL)
            AND ("Ad_type_code" = booking  OR booking IS NULL)
            AND "branch" in(SELECT LTRIM(RTRIM(BRANCH_CODE)) FROM LOGIN_BRANCH_MAST WHERE USER_CODE=revenue and COMP_CODE=compcode and USER_FLAG='Y')
         --AND "branch"=revenue 
            ;

  -- Dbms_output.put_line('rinki--');
      OPEN p_accounts FOR
      SELECT CASE dateformat
                     WHEN 'mm/dd/yyyy' THEN TO_CHAR("date_time",'mm/dd/yyyy')
                  WHEN 'dd/mm/yyyy' THEN TO_CHAR("date_time",'dd/mm/yyyy')
                     WHEN 'yyyy/mm/dd' THEN TO_CHAR("date_time",'yyyy/mm/dd')  END AS date_time,
                     "branch",(select "Branch_Name" from branch_mst where "Branch_Code"="branch") as "BRANCH_NAME",
                     "booked_by", "cio_booking_id", "prev_booking", "applied_by","audit", "RO_No",
            CASE dateformat
                 WHEN 'mm/dd/yyyy' THEN TO_CHAR("RO_Date",'mm/dd/yyyy')
                 WHEN 'dd/mm/yyyy' THEN TO_CHAR("RO_Date",'dd/mm/yyyy')
                 WHEN 'yyyy/mm/dd' THEN TO_CHAR("RO_Date",'yyyy/mm/dd')  END AS "RO_Date",
                  TO_CHAR("RO_Date", 'dd/mm/yyyy') AS "RO_Date",
                "Caption", "bill_status", "ro_status", "Agency_code",
                "Agency_address", "Client_code", "Client_address",
                "Agency_sub_code", "Dockit_no", "Executive_code",
                "Executive_zone", "Product_code", "Brand_code", "Key_no",
                "Bill_remarks", "Print_remark", "Package_code","No_of_insertion",
            CASE dateformat
                    WHEN 'mm/dd/yyyy' THEN TO_CHAR("Insertion_date",'mm/dd/yyyy')
                    WHEN 'dd/mm/yyyy' THEN TO_CHAR("Insertion_date",'dd/mm/yyyy')
                    WHEN 'yyyy/mm/dd' THEN TO_CHAR("Insertion_date",'yyyy/mm/dd')  END    AS "Insertion_date",
                "Repeating_day", "Ad_type_code", "Ad_cat_code",
                "Ad_sub_cat_code", "Color_code", "Uom_code",
                "Page_position_code", "Page_type_code", "Page_no",
                "Ad_size_type_code", "Ad_size_height", "Ad_size_width", "Rate_code",
                (SELECT "Scheme_Name" FROM SCHEME_MASTER WHERE "Comp_code"=compcode and "scheme_id" =TEMPBOOKING_MAST."Scheme_type_code")AS "Scheme_type_code",
                 "Currency_code", "Agrred_rate", "Agreed_amount",
                "Special_discount", "Space_discount", "Special_charges",
                TEMPBOOKING_MAST."Comp_code", TEMPBOOKING_MAST."Userid",
                TEMPBOOKING_MAST."Agency_status", "Agency_type", "Agency_pay",
                "Agency_credit", "Total_area", "Card_rate", "Card_amount",
                "Discount", "Discount_per", "Bill_cycle", "Revenue_center",
                "Bill_pay", "Bill_height", "Bill_width",
                TEMPBOOKING_MAST."Bill_to", "Invoices", "Vts", "Bill_add",
                "Trade_disc", "Agency_out", "Booking_type", "Campaign",
                "Page_prem", "Page_amount", "Prem_per", "Gross_amount",
                "Bill_amount", "Box_code", "Box_no", "Box_agency",
                "Box_client", "Box_address", "Tfn", "Coupan_ad",
                "Ad_size_column", "Bill_column", "Bill_area",
                "Special_disc_per", "Space_disc_per",
                AGENCY_MAST."Agency_Name" || '(' || AGENCY_MAST."code_subcode" || ')' AS "AgencyName",
                (SELECT EXEC_MAST."Exec_name" || '(' || TO_CHAR(EXEC_MAST."Exe_no") || ')' FROM EXEC_MAST
                  WHERE TEMPBOOKING_MAST."Executive_code" = EXEC_MAST."Exe_no"
                    AND TEMPBOOKING_MAST."Comp_code" = EXEC_MAST."comp_code" and TEMPBOOKING_MAST."Comp_code"=compcode) AS "execname",
                    --91
                (SELECT  PRODUCT_CAT_MAST."prod_desc" || '(' || PRODUCT_CAT_MAST."prod_cat_code" || ')' FROM PRODUCT_CAT_MAST
                  WHERE TEMPBOOKING_MAST."Product_code" = PRODUCT_CAT_MAST."prod_cat_code"
                    AND TEMPBOOKING_MAST."Comp_code" = PRODUCT_CAT_MAST."comp_code" and TEMPBOOKING_MAST."Comp_code"=compcode) AS "product",
                    --92
                "Paid_ins", "Contract_rate", "Deviation", "Variant_code",
                 (select "deal_name" from contract_mast where "Deal_No"= (select "deal_code" from contract_detail where "ContractCode"= "Contract_name")) as "Contract_name", "Contract_type", "Card_name", "Card_type",
                --100
                "Card_month", "Card_year", "Card_number", "Receipt_no",
                "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color",
                "Bullet_code", "Bullet_premium",
                (SELECT "Agency_Name" FROM AGENCY_MAST WHERE "code_subcode" =TEMPBOOKING_MAST."Agency_sub_code" and agency_mast."Comp_Code"=compcode) AS "AgencySubCode",
              --111
                NVL ((SELECT DISTINCT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code" = "Client_code" and "Comp_Code"=compcode), '') AS "Client",                                       --112
                (SELECT DISTINCT "Payment_Mode_Name" FROM PAYMENT_MODE_MAST WHERE "Pay_Mode_Code" = "Agency_pay" and "Comp_Code"=compcode) AS "PayMode",
                (SELECT DISTINCT "Adv_Cat_Name" FROM ADV_CAT_MAST WHERE ADV_CAT_MAST."Adv_Cat_Code" =TEMPBOOKING_MAST."Ad_cat_code" and "Comp_Code"=compcode) AS "categoryname",
                (SELECT DISTINCT "Adv_Subcat_Name" FROM ADV_SUBCAT_MAST  WHERE ADV_SUBCAT_MAST."Adv_Subcat_Code" =TEMPBOOKING_MAST."Ad_sub_cat_code" and "Comp_Code"=compcode)
                 AS "subcategoryname",
                (SELECT DISTINCT "brand_name" FROM BRAND_MST WHERE "brand_code" =TEMPBOOKING_MAST."Brand_code" and "comp_code"=compcode) AS "Brand",
                (SELECT DISTINCT "Uom_Name" FROM UOM_MAST WHERE "Uom_Code" = TEMPBOOKING_MAST."Uom_code" and "Comp_Code"=compcode) AS "UOM",
                (SELECT "premiumname" FROM ADVPOS_PREM_MAST WHERE "Premiumcode" =TEMPBOOKING_MAST."Page_prem" and "comp_code"=compcode) AS "PagePremium",
                 (SELECT DISTINCT "Pos_Type" FROM ADVPOS_TYPE_MAST
                  WHERE "Pos_Type_Code" = TEMPBOOKING_MAST."Page_position_code" and "Comp_Code"=compcode) AS "PositionPremium",
                (SELECT DISTINCT "Curr_Name" FROM CURR_MAST WHERE "Curr_Code" = TEMPBOOKING_MAST."Currency_code" and "Comp_Code"=compcode) AS "Currency",
                "Material_status", TO_CHAR("Receipt_date",'dd/mm/yyyy') AS "Receipt_date", TEMPBOOKING_MAST."Region",
                "Variant", "Colortype",
                (SELECT DISTINCT "UOM_DESC" FROM UOM_MAST WHERE "Uom_Code" = TEMPBOOKING_MAST."Uom_code" and "Comp_Code"=compcode) AS "uom_desc",
                (SELECT DISTINCT "Logo" FROM UOM_MAST WHERE "Uom_Code" = TEMPBOOKING_MAST."Uom_code" and "Comp_Code"=compcode) AS "logo","Logo_H", "Logo_W", "Logo_color", "Logo_Uom",
                (SELECT DISTINCT "Logo_Uom" FROM UOM_MAST WHERE "Uom_Code" = TEMPBOOKING_MAST."Uom_code" and "Comp_Code"=compcode)  AS "logocode",
                (SELECT DISTINCT "Box_Charges_Native" FROM BOX_MAST WHERE BOX_MAST."Box_Code"=TEMPBOOKING_MAST."Box_code" and "Comp_Code"=compcode) AS "boxchrg",TEMPBOOKING_MAST.sapid,
                retainer,(SELECT "Retain_Name"||'('||"Retain_Code"||')' FROM RETAINERMASTER WHERE RETAINERMASTER."Retain_Code"=TEMPBOOKING_MAST.RETAINER and "Comp_Code"=compcode) AS "RETAINER1",
                (SELECT DISTINCT "Package_Name" FROM combin_mast WHERE "Combin_Code" =

                TEMPBOOKING_MAST."Package_code" and "Comp_Code"=compcode) as "Package_cod",(SELECT DISTINCT "Col_Name" FROM col_mast WHERE "Col_Code" = TEMPBOOKING_MAST."Color_code" and "Comp_Code"=compcode) as

                "Color_cod",(SELECT DISTINCT "Pos_Type" FROM advpos_type_mast WHERE "Pos_Type_Code" =

                TEMPBOOKING_MAST."Page_position_code" and "Comp_Code"=compcode) as "Page_position_cod",
                decode(TEMPBOOKING_MAST."Booking_type",'1','BARTER','2','FMG','3','NORMAL','4','INHOUSE') as "Book_type",
                (SELECT DISTINCT "catname"  FROM  AD_CAT3   WHERE

                AD_CAT3."catcode"=TEMPBOOKING_MAST."Ad_Subcat3" and "compcode"=compcode)  as "Subcat3",(SELECT DISTINCT "Cat_Name"  FROM  TBL_CAT4   WHERE

                TBL_CAT4."Cat_Code"=TEMPBOOKING_MAST."Ad_Subcat4" and "Comp_Code"=compcode) as "Subcat4",(SELECT DISTINCT "Cat_Name"  FROM  TBL_CAT5   WHERE

                TBL_CAT5."Cat_Code"=TEMPBOOKING_MAST."Ad_subcat5" and "Comp_Code"=compcode) as "subcat5",(SELECT DISTINCT "Comm_Rate" FROM ret_comm_details WHERE

                ret_comm_details."Retain_Code"=TEMPBOOKING_MAST.RETAINER and "Comp_code"=compcode and rowid=(select max(rowid) from ret_comm_details where ret_comm_details."Retain_Code"=TEMPBOOKING_MAST.RETAINER and "Comp_code"=compcode)) AS "RETAINER_COMM",(select AUDIT_COMMENT from tbl_booking_mast where tbl_booking_mast."cio_booking_id"=TEMPBOOKING_MAST."cio_booking_id" and tbl_booking_mast."Comp_code"=compcode) as "remarks","ADD_AGENCY_COMM",
                 (SELECT DISTINCT "Box_Charges_Type" FROM BOX_MAST WHERE BOX_MAST."Box_Code"=TEMPBOOKING_MAST."Box_code" and "Comp_code"=compcode) AS "boxchargetype",
                 ADD_AGENCY_COMM_AMT,RETAINER_COMM,RETAINER_COMM_AMT,TEMPBOOKING_MAST."Scheme_type_code" as "SCHEMEID",TEMPBOOKING_MAST.CASH_RECIEVED,
                 (select DISTINCT "pub_center" from branch_mst where "Branch_Code"=tempbooking_mast."branch" and "Comp_Code"=compcode) as "pub_center",
                  CIRAGENCY,CIRRATE,CIREDITION,CIRPUBLICATION,CIRAGENCY_SUBCODE,BARTERTYPE,(SELECT BARTE_DESC FROM AD_BARTER WHERE COMP_CODE=compcode AND BARTER_CODE=TEMPBOOKING_MAST.BARTERTYPE) AS BARTE_DESC,
                  (SELECT DISTINCT BARTER_AMOUNT FROM AD_BARTER WHERE COMP_CODE=compcode AND  BARTER_CODE=TEMPBOOKING_MAST.BARTERTYPE) AS BARTE_AMOUNT,
                  (SELECT DISTINCT ADDITIONAL_FLAG  FROM COMM_DETAILS WHERE "Agency_code"||"Agency_sub_code"=TEMPBOOKING_MAST."Agency_sub_code"
                 and "Comp_Code"=upper(compcode) and SYSDATE between "Eff_from_Date" and "Eff_Till_Date" AND ROWNUM<=1) AS ADDFLAG,
                  CASHDISCOUNT, CASHDISCTYPE, ATTACHMENT1, ATTACHMENT2, DISC_PREMIUM, CHKTRADE, CASE dateformat
                                     WHEN 'mm/dd/yyyy' THEN TO_CHAR(CHK_DATE,'mm/dd/yyyy')
                                  WHEN 'dd/mm/yyyy' THEN TO_CHAR(CHK_DATE,'dd/mm/yyyy')
                                     WHEN 'yyyy/mm/dd' THEN TO_CHAR(CHK_DATE,'yyyy/mm/dd')  END as CHK_DATE, CHK_AMT, CHK_BANK_NAME, OUR_BANK, CHK_NO, agency_mast.BOOKING_TYPE,
                                     DEALERPANEL, DEALER_H, DEALER_W, DEALERTYPE,MOBILENO,
                                     (select "Comm_Rate" from comm_details where "Agency_code" || "Agency_sub_code"=TEMPBOOKING_MAST."Agency_sub_code"
                 and "Comp_Code"=upper(compcode) and SYSDATE between "Eff_from_Date" and "Eff_Till_Date" AND ROWNUM<=1 ) as COMM_RATE,ACTIVE_AGREEDRATE,ACTIVE_AGREEDAMT, NVL(LOCALGROSSAMT,"Gross_amount") as LOCALGROSSAMT, NVL(LOCALBILLAMT,"Bill_amount") as LOCALBILLAMT,
                 CASE dateformat
                         WHEN 'mm/dd/yyyy' THEN TO_CHAR("REVISE_DATE",'mm/dd/yyyy')
                         WHEN 'dd/mm/yyyy' THEN TO_CHAR("REVISE_DATE",'dd/mm/yyyy')
                         WHEN 'yyyy/mm/dd' THEN TO_CHAR("REVISE_DATE",'yyyy/mm/dd')  END AS "REVISE_DATE",CLIENT_TYPE
/*for Display and classified*/
           FROM TEMPBOOKING_MAST, AGENCY_MAST
          WHERE AGENCY_MAST."code_subcode" =
                                            TEMPBOOKING_MAST."Agency_sub_code"
            AND AGENCY_MAST."Comp_Code" = compcode ORDER BY "Creation_datetime";


      Dbms_output.put_line('rinki--');
----------------------------------------------------Lata------------------------------------------------------

      OPEN p_accounts1 FOR
      SELECT 'A' AS A FROM DUAL;
    /*     SELECT NVL(COUNT (*),'0') AS "count"
                     FROM TBL_BOOKING_MAST_LOG WHERE "Receipt_no" = ciobookid AND "audit" IS NOT NULL;

      BEGIN
         SELECT MAX (VSEQNO) INTO VERSION1 FROM TBL_BOOKING_MAST_LOG
          WHERE "Receipt_no" = ciobookid AND VSEQNO < (SELECT MAX (VSEQNO) FROM TBL_BOOKING_MAST_LOG WHERE "Receipt_no" = ciobookid);
            EXCEPTION WHEN NO_DATA_FOUND THEN NULL;
      END;
*/
      OPEN p_accounts2 FOR
      SELECT 'A' AS A FROM DUAL;
         /*SELECT    CASE dateformat
                     WHEN 'mm/dd/yyyy' THEN TO_CHAR("date_time",'mm/dd/yyyy')
                  WHEN 'dd/mm/yyyy' THEN TO_CHAR("date_time",'dd/mm/yyyy')
                     WHEN 'yyyy/mm/dd' THEN TO_CHAR("date_time",'yyyy/mm/dd')  END AS "date_time",
                 "branch", "booked_by", "cio_booking_id", "prev_booking", "applied_by","audit", "RO_No",
               CASE dateformat
                     WHEN 'mm/dd/yyyy' THEN TO_CHAR("RO_Date",'mm/dd/yyyy')
                  WHEN 'dd/mm/yyyy' THEN TO_CHAR("RO_Date",'dd/mm/yyyy')
                     WHEN 'yyyy/mm/dd' THEN TO_CHAR("RO_Date",'yyyy/mm/dd')  END AS "RO_Date",
                "Caption","bill_status", "ro_status",
                TBL_BOOKING_MAST_LOG."Agency_code", "Agency_address",
                "Client_code", "Client_address", "Agency_sub_code",
                "Dockit_no", "Executive_code", "Executive_zone",
                "Product_code", "Brand_code", "Key_no", "Bill_remarks",
                "Print_remark", "Package_code", "No_of_insertion",
            CASE dateformat
                     WHEN 'mm/dd/yyyy' THEN TO_CHAR("Insertion_date",'mm/dd/yyyy')
                  WHEN 'dd/mm/yyyy' THEN TO_CHAR("Insertion_date",'dd/mm/yyyy')
                     WHEN 'yyyy/mm/dd' THEN TO_CHAR("Insertion_date",'yyyy/mm/dd')  END AS "Insertion_date",
               -- TO_CHAR ("Insertion_date", 'dd/mm/yyyy') AS "Insertion_date",
                "Repeating_day", "Ad_type_code", "Ad_cat_code",
                "Ad_sub_cat_code", "Color_code", "Uom_code",
                "Page_position_code", "Page_type_code", "Page_no",
                "Ad_size_type_code", "Ad_size_height", "Ad_size_width",
                "Rate_code", "Scheme_type_code", "Currency_code",
                "Agrred_rate", "Agreed_amount", "Special_discount",
                "Space_discount", "Special_charges",
                TBL_BOOKING_MAST_LOG."Comp_code",
                TBL_BOOKING_MAST_LOG."Userid",
                TBL_BOOKING_MAST_LOG."Agency_status", "Agency_type",
                "Agency_pay", "Agency_credit", "Total_area", "Card_rate",
                "Card_amount", "Discount", "Discount_per", "Bill_cycle",
                "Revenue_center", "Bill_pay", "Bill_height", "Bill_width",
                TBL_BOOKING_MAST_LOG."Bill_to", "Invoices", "Vts",
                "Bill_add", "Trade_disc", "Agency_out", "Booking_type",
                "Campaign", "Page_prem", "Page_amount", "Prem_per",
                "Gross_amount", "Bill_amount", "Box_code", "Box_no",
                "Box_agency", "Box_client", "Box_address", "Tfn" "Coupan_ad",
                "Ad_size_column", "Bill_column", "Bill_area",
                "Special_disc_per", "Space_disc_per",
                  AGENCY_MAST."Agency_Name"|| '('|| AGENCY_MAST."code_subcode"|| ')' AS "AgencyName",
                   (SELECT    EXEC_MAST."Exec_name" || '('|| TO_CHAR (EXEC_MAST."Exe_no") || ')'
                   FROM EXEC_MAST  WHERE TBL_BOOKING_MAST_LOG."Executive_code" =EXEC_MAST."Exe_no"
                    AND TBL_BOOKING_MAST_LOG."Comp_code" =EXEC_MAST."comp_code" and "comp_code"=compcode)AS "execname",
               (SELECT    PRODUCT_CAT_MAST."prod_desc"|| '('|| PRODUCT_CAT_MAST."prod_cat_code" || ')'
                   FROM PRODUCT_CAT_MAST WHERE TBL_BOOKING_MAST_LOG."Product_code" =PRODUCT_CAT_MAST."prod_cat_code"
                    AND TBL_BOOKING_MAST_LOG."Comp_code" =PRODUCT_CAT_MAST."comp_code")                                                                 AS "product",
                "Paid_ins", "Contract_rate", "Deviation", "Variant_code",
                "Contract_name", "Contract_type", "Card_name", "Card_type",
                "Card_month", "Card_year", "Card_number", "Receipt_no",
                "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color",
                (SELECT "Agency_Name" FROM AGENCY_MAST WHERE "code_subcode" = TBL_BOOKING_MAST_LOG."Agency_sub_code" and "Comp_Code"=compcode)AS "AgencySubCode",
               NVL ((SELECT "Cust_Name"  FROM CUST_MAST WHERE "Cust_Code" = "Client_code" and "Comp_Code"=compcode),'' ) AS "Client",
              (SELECT "Payment_Mode_Name"  FROM PAYMENT_MODE_MAST WHERE "Pay_Mode_Code" = "Agency_pay" and "Comp_Code"=compcode) AS "PayMode",
               (SELECT "Adv_Cat_Name" FROM ADV_CAT_MAST WHERE ADV_CAT_MAST."Adv_Cat_Code" =TBL_BOOKING_MAST_LOG."Ad_cat_code" and "Comp_Code"=compcode)AS "categoryname",
               (SELECT "Adv_Subcat_Name"  FROM ADV_SUBCAT_MAST WHERE ADV_SUBCAT_MAST."Adv_Subcat_Code" =TBL_BOOKING_MAST_LOG."Ad_sub_cat_code" and "Comp_Code"=compcode)
                 AS "subcategoryname",
               (SELECT "brand_name"  FROM BRAND_MST   WHERE "brand_code" = TBL_BOOKING_MAST_LOG."Brand_code" and "comp_code"=compcode)AS "Brand",
               (SELECT "Uom_Name" FROM UOM_MAST WHERE "Uom_Code" =TBL_BOOKING_MAST_LOG."Uom_code" and "Comp_Code"=compcode)AS "UOM",
               (SELECT "premiumname" FROM ADVPOS_PREM_MAST WHERE "Premiumcode" =TBL_BOOKING_MAST_LOG."Page_type_code" and "comp_code"=compcode)AS "PagePremium",
                (SELECT "Pos_Type" FROM ADVPOS_TYPE_MAST WHERE "Pos_Type_Code" =TBL_BOOKING_MAST_LOG."Page_position_code" and "Comp_Code"=compcode)AS "PositionPremium",
               (SELECT "Curr_Name"  FROM CURR_MAST WHERE "Curr_Code" =TBL_BOOKING_MAST_LOG."Currency_code" and "Comp_Code"=compcode) AS "Currency"
           FROM TBL_BOOKING_MAST_LOG, AGENCY_MAST
             WHERE TBL_BOOKING_MAST_LOG."Receipt_no" = ciobookid
            AND VSEQNO = VERSION1
            AND AGENCY_MAST."code_subcode" =
                                    TBL_BOOKING_MAST_LOG."Agency_sub_code"
            AND AGENCY_MAST."Comp_Code" = compcode;
*/
      OPEN p_accounts3 FOR
      SELECT 'A' AS A FROM DUAL;
--select * from tbl_booking_mast_log where cio_booking_id=@ciobookid and version=@version
      /*   SELECT    CASE dateformat
                     WHEN 'mm/dd/yyyy' THEN TO_CHAR("date_time",'mm/dd/yyyy')
                  WHEN 'dd/mm/yyyy' THEN TO_CHAR("date_time",'dd/mm/yyyy')
                     WHEN 'yyyy/mm/dd' THEN TO_CHAR("date_time",'yyyy/mm/dd')  END AS "date_time",
                   "branch","booked_by", "cio_booking_id", "prev_booking", "applied_by","audit", "RO_No",
              CASE dateformat
                     WHEN 'mm/dd/yyyy' THEN TO_CHAR("RO_Date",'mm/dd/yyyy')
                  WHEN 'dd/mm/yyyy' THEN TO_CHAR("RO_Date",'dd/mm/yyyy')
                     WHEN 'yyyy/mm/dd' THEN TO_CHAR("RO_Date",'yyyy/mm/dd')  END AS "RO_Date",
                "Caption","bill_status", "ro_status",
                TBL_BOOKING_MAST_LOG."Agency_code", "Agency_address",
                "Client_code", "Client_address", "Agency_sub_code",
                "Dockit_no", "Executive_code", "Executive_zone",
                "Product_code", "Brand_code", "Key_no", "Bill_remarks",
                "Print_remark", "Package_code", "No_of_insertion",
            CASE dateformat
                     WHEN 'mm/dd/yyyy' THEN TO_CHAR("Insertion_date",'mm/dd/yyyy')
                  WHEN 'dd/mm/yyyy' THEN TO_CHAR("Insertion_date",'dd/mm/yyyy')
                     WHEN 'yyyy/mm/dd' THEN TO_CHAR("Insertion_date",'yyyy/mm/dd')  END AS "Insertion_date",
                "Repeating_day", "Ad_type_code", "Ad_cat_code",
                "Ad_sub_cat_code", "Color_code", "Uom_code",
                "Page_position_code", "Page_type_code", "Page_no",
                "Ad_size_type_code", "Ad_size_height", "Ad_size_width",
                "Rate_code", "Scheme_type_code", "Currency_code",
                "Agrred_rate", "Agreed_amount", "Special_discount",
                "Space_discount", "Special_charges",
                TBL_BOOKING_MAST_LOG."Comp_code",
                TBL_BOOKING_MAST_LOG."Userid",
                TBL_BOOKING_MAST_LOG."Agency_status", "Agency_type",
                "Agency_pay", "Agency_credit", "Total_area", "Card_rate",
                "Card_amount", "Discount", "Discount_per", "Bill_cycle",
                "Revenue_center", "Bill_pay", "Bill_height", "Bill_width",
                TBL_BOOKING_MAST_LOG."Bill_to", "Invoices", "Vts",
                "Bill_add", "Trade_disc", "Agency_out", "Booking_type",
                "Campaign", "Page_prem", "Page_amount", "Prem_per",
                "Gross_amount", "Bill_amount", "Box_code", "Box_no",
                "Box_agency", "Box_client", "Box_address", "Tfn", "Coupan_ad",
                "Ad_size_column", "Bill_column", "Bill_area",
                "Special_disc_per", "Space_disc_per",
                 AGENCY_MAST."Agency_Name" || '('|| AGENCY_MAST."code_subcode"|| ')' AS "AgencyName",
                (SELECT    EXEC_MAST."Exec_name" || '('|| TO_CHAR (EXEC_MAST."Exe_no")|| ')'
                   FROM EXEC_MAST  WHERE TBL_BOOKING_MAST_LOG."Executive_code" = EXEC_MAST."Exe_no"
                    AND TBL_BOOKING_MAST_LOG."Comp_code" = EXEC_MAST."comp_code")AS "execname",
                (SELECT    PRODUCT_CAT_MAST."prod_desc" || '(' || PRODUCT_CAT_MAST."prod_cat_code" || ')'
                   FROM PRODUCT_CAT_MAST WHERE TBL_BOOKING_MAST_LOG."Product_code" =PRODUCT_CAT_MAST."prod_cat_code"
                    AND TBL_BOOKING_MAST_LOG."Comp_code" =PRODUCT_CAT_MAST."comp_code")AS "product",
                "Paid_ins", "Contract_rate", "Deviation", "Variant_code",
                "Contract_name", "Contract_type", "Card_name", "Card_type",
                "Card_month", "Card_year", "Card_number", "Receipt_no",
                "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color",
                "Bullet_code", "Bullet_premium",
                (SELECT "Agency_Name" FROM AGENCY_MAST WHERE "code_subcode" =TBL_BOOKING_MAST_LOG."Agency_sub_code" and "Comp_Code"=compcode)AS "AgencySubCode",
                NVL ((SELECT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code" = "Client_code" and "Comp_Code"=compcode),'' ) AS "Client",
                (SELECT "Payment_Mode_Name" FROM PAYMENT_MODE_MAST WHERE "Pay_Mode_Code" = "Agency_pay" and "Comp_Code"=compcode) AS "PayMode",
                (SELECT "Adv_Cat_Name" FROM ADV_CAT_MAST WHERE ADV_CAT_MAST."Adv_Cat_Code" =TBL_BOOKING_MAST_LOG."Ad_cat_code" and "Comp_Code"=compcode)AS "categoryname",
                (SELECT "Adv_Subcat_Name" FROM ADV_SUBCAT_MAST WHERE ADV_SUBCAT_MAST."Adv_Subcat_Code" =TBL_BOOKING_MAST_LOG."Ad_sub_cat_code" and "Comp_Code"=compcode)AS "subcategoryname",
                (SELECT "brand_name" FROM BRAND_MST WHERE "brand_code" =TBL_BOOKING_MAST_LOG."Brand_code" and "comp_code"=compcode)AS "Brand",
                (SELECT "Uom_Name" FROM UOM_MAST WHERE "Uom_Code" =TBL_BOOKING_MAST_LOG."Uom_code" and "Comp_Code"=compcode)AS "UOM",
                (SELECT "premiumname" FROM ADVPOS_PREM_MAST  WHERE "Premiumcode" =TBL_BOOKING_MAST_LOG."Page_type_code" and "comp_code"=compcode)AS "PagePremium",
                (SELECT "Pos_Type" FROM ADVPOS_TYPE_MAST WHERE "Pos_Type_Code" = TBL_BOOKING_MAST_LOG."Page_position_code" and "Comp_Code"=compcode)AS "PositionPremium",
                (SELECT "Curr_Name" FROM CURR_MAST WHERE "Curr_Code" =TBL_BOOKING_MAST_LOG."Currency_code" and "Comp_Code"=compcode)AS "Currency"
           FROM TBL_BOOKING_MAST_LOG, AGENCY_MAST
          WHERE TBL_BOOKING_MAST_LOG."Receipt_no" = ciobookid
            AND VSEQNO =(SELECT MAX (VSEQNO) FROM TBL_BOOKING_MAST_LOG WHERE "Receipt_no" = ciobookid AND VSEQNO <
            (SELECT MAX(VSEQNO) FROM TBL_BOOKING_MAST_LOG WHERE "Receipt_no" = ciobookid) AND "audit" IS NOT NULL)
                        AND AGENCY_MAST."code_subcode" =
             TBL_BOOKING_MAST_LOG."Agency_sub_code" AND AGENCY_MAST."Comp_Code" = compcode;
             */
            -- open P_Accounts4 for 
             -- select CASHAMOUNT as "cashreceived" from tbl_cashreceiptdetail where BOOKING_ID =ciobookid ; -- and RECEIPTNO=

   END executebookingdisp_p;
END Executebookingdisp;
/


/******************mimoh 11jan2011********************/
///////////////////////updated by Garima

CREATE OR REPLACE PROCEDURE Websp_Bindcioidnew1
(
fromdate IN VARCHAR2,
todate IN VARCHAR2,
date1 IN VARCHAR2,
publication IN VARCHAR2,
bookingcenter IN VARCHAR2,
revenuecenter IN VARCHAR2,
agencytype IN VARCHAR2,

PACKAGE1 IN VARCHAR2,
adtype1 IN VARCHAR2,
agency IN VARCHAR2,
client IN VARCHAR2,
billstatus IN VARCHAR2,
rate_audit IN VARCHAR2,
billmode IN VARCHAR2,
billcycle IN VARCHAR2,

v_retainer_name in varchar2,
v_executive_name in varchar2,
v_branch_name in varchar2,
v_ad_category in varchar2,
v_district in varchar2,
v_taluka in varchar2,
pcompcode  IN  varchar2,
P_BILLNO IN VARCHAR2,
P_BILL_GEN_PRIOR IN VARCHAR2,
P_CENTERLOGIN IN VARCHAR2,
P_PUB_CENT_HO IN VARCHAR2,
P_FMG_BILL IN VARCHAR2,
P_SCHEME_TYPE in varchar2,
pto_bill_no in varchar2,

p_recordset OUT Cur_Type_New1.cursor_type

)

IS

query1 VARCHAR2(10000);


v_bill_criteria varchar2(10);

BEGIN
    if adtype1='DI0' then
        select disp_billing_criteria into v_bill_criteria from preferrences where "comp_code"=pcompcode;
    else
        select clsd_billing_criteria into v_bill_criteria from preferrences where "comp_code"=pcompcode;
    end if;
    
   IF(billstatus='3' AND rate_audit='n')
   THEN

      query1:='SELECT  DISTINCT  TBL_BOOKING_INSERT."Cio_Booking_Id", "No_Insert" AS "no_of_insertion" ,TBL_BOOKING_MAST."Package_code"  AS "edition",


      nvl((select distinct cust_mast."Cust_Alias" from cust_mast  where

cust_mast."Cust_Code"=tbl_booking_mast."Client_code"),"Client_code") as "client",


      AGENCY_MAST."Agency_Name" AS "Agency",sum(TBL_BOOKING_INSERT."Gross_Rate") as "Gross_Rate",TBL_BOOKING_MAST."Trade_disc" AS "Commission",tbl_booking_insert."Insert_Date" as "pub_date",
      TBL_BOOKING_INSERT."Insert_Status" AS "status",TBL_BOOKING_MAST."No_of_insertion" AS "total",TBL_BOOKING_MAST."Bill_remarks",
       tbl_booking_insert.BILL_NO
       ,(select max(nvl(ad_bills.PRINT_COUNT,0)) from ad_bills  where  tbl_booking_insert."Comp_Code"=ad_bills.COMP_CODE_V and ad_bills.BILNO=tbl_booking_insert.BILL_NO) as "PrintCount"
      FROM TBL_BOOKING_INSERT,TBL_BOOKING_MAST,AGENCY_MAST WHERE TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"  AND
       TBL_BOOKING_INSERT."Insert_Status"=''publish'' AND AGENCY_MAST."code_subcode"=TBL_BOOKING_MAST."Agency_sub_code"' ;
   END IF;


 IF(billstatus='3' AND rate_audit='y')
THEN

      query1:='SELECT  DISTINCT  TBL_BOOKING_INSERT."Cio_Booking_Id", "No_Insert" AS "no_of_insertion" ,TBL_BOOKING_MAST."Package_code"  AS "edition",
 nvl((select distinct cust_mast."Cust_Alias" from cust_mast  where

cust_mast."Cust_Code"=tbl_booking_mast."Client_code"),"Client_code") as "client",
      AGENCY_MAST."Agency_Name" AS "Agency",sum(TBL_BOOKING_INSERT."Gross_Rate") as "Gross_Rate",TBL_BOOKING_MAST."Trade_disc" AS "Commission",tbl_booking_insert."Insert_Date" as "pub_date",
      TBL_BOOKING_INSERT."Insert_Status" AS "status",TBL_BOOKING_MAST."No_of_insertion" AS "total",TBL_BOOKING_MAST."Bill_remarks",
       tbl_booking_insert.BILL_NO
       ,(select max(nvl(ad_bills.PRINT_COUNT,0)) from ad_bills  where  tbl_booking_insert."Comp_Code"=ad_bills.COMP_CODE_V and ad_bills.BILNO=tbl_booking_insert.BILL_NO) as "PrintCount"

      FROM TBL_BOOKING_INSERT,TBL_BOOKING_MAST,AGENCY_MAST WHERE TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"  AND
       TBL_BOOKING_INSERT."Insert_Status"=''audit by rate'' AND AGENCY_MAST."code_subcode"=TBL_BOOKING_MAST."Agency_sub_code"' ;
END IF;
IF(billstatus='1' AND rate_audit='y'AND billmode='2')
THEN

 query1:='SELECT  DISTINCT  TBL_BOOKING_INSERT."Cio_Booking_Id", "No_Insert" AS "no_of_insertion" ,TBL_BOOKING_MAST."Package_code"  AS "edition",
 nvl((select distinct cust_mast."Cust_Alias" from cust_mast  where

cust_mast."Cust_Code"=tbl_booking_mast."Client_code"),"Client_code") as "client",
      AGENCY_MAST."Agency_Name" AS "Agency",sum(TBL_BOOKING_INSERT."Gross_Rate") as "Gross_Rate",TBL_BOOKING_MAST."Trade_disc" AS "Commission",tbl_booking_insert."Insert_Date" as "pub_date",
      TBL_BOOKING_INSERT."Insert_Status" AS "status",TBL_BOOKING_MAST."No_of_insertion" AS "total",TBL_BOOKING_MAST."Bill_remarks",
       tbl_booking_insert.BILL_NO
       ,(select max(nvl(ad_bills.PRINT_COUNT,0)) from ad_bills  where  tbl_booking_insert."Comp_Code"=ad_bills.COMP_CODE_V and ad_bills.BILNO=tbl_booking_insert.BILL_NO) as "PrintCount"
      FROM TBL_BOOKING_INSERT,TBL_BOOKING_MAST,AGENCY_MAST WHERE TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"
AND AGENCY_MAST."code_subcode"=TBL_BOOKING_MAST."Agency_sub_code"  AND (TBL_BOOKING_INSERT."Insert_Status" =''AUDIT BY rate'' OR TBL_BOOKING_INSERT."Insert_Status"=''billed'')' ;
END IF;
IF(billstatus='1' AND rate_audit='n' AND billmode='2')
THEN

 query1:='SELECT  DISTINCT  TBL_BOOKING_INSERT."Cio_Booking_Id", "No_Insert" AS "no_of_insertion" ,TBL_BOOKING_MAST."Package_code"  AS "edition",
      (SELECT CUST_MAST."Cust_Alias" FROM CUST_MAST  WHERE CUST_MAST."Cust_Code" = TBL_BOOKING_MAST."Client_code") AS "client",
      AGENCY_MAST."Agency_Name" AS "Agency",sum(TBL_BOOKING_INSERT."Gross_Rate") as "Gross_Rate",TBL_BOOKING_MAST."Trade_disc" AS "Commission",tbl_booking_insert."Insert_Date" as "pub_date",
      TBL_BOOKING_INSERT."Insert_Status" AS "status",TBL_BOOKING_MAST."No_of_insertion" AS "total",TBL_BOOKING_MAST."Bill_remarks",
       tbl_booking_insert.BILL_NO
       ,(select max(nvl(ad_bills.PRINT_COUNT,0)) from ad_bills  where  tbl_booking_insert."Comp_Code"=ad_bills.COMP_CODE_V and ad_bills.BILNO=tbl_booking_insert.BILL_NO) as "PrintCount"
      FROM TBL_BOOKING_INSERT,TBL_BOOKING_MAST,AGENCY_MAST WHERE TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"
 AND AGENCY_MAST."code_subcode"=TBL_BOOKING_MAST."Agency_sub_code"  AND (TBL_BOOKING_INSERT."Insert_Status" =''publish'' OR TBL_BOOKING_INSERT."Insert_Status"=''billed'')' ;
END IF;

IF(billstatus='1' AND rate_audit='n' AND (billmode='1' OR billmode='3'))
THEN
 query1:='SELECT  DISTINCT  TBL_BOOKING_INSERT."Cio_Booking_Id", "No_Insert" AS "no_of_insertion" ,TBL_BOOKING_MAST."Package_code"  AS "edition",
      (SELECT CUST_MAST."Cust_Alias" FROM CUST_MAST  WHERE CUST_MAST."Cust_Code" = TBL_BOOKING_MAST."Client_code") AS "client",
      AGENCY_MAST."Agency_Name" AS "Agency",sum(TBL_BOOKING_INSERT."Gross_Rate") as "Gross_Rate",TBL_BOOKING_MAST."Trade_disc" AS "Commission",tbl_booking_insert."Insert_Date" as "pub_date",
      TBL_BOOKING_INSERT."Insert_Status" AS "status",TBL_BOOKING_MAST."No_of_insertion" AS "total",TBL_BOOKING_MAST."Bill_remarks",

      tbl_booking_insert.BILL_NO
      ,(select max(nvl(ad_bills.PRINT_COUNT,0)) from ad_bills  where  tbl_booking_insert."Comp_Code"=ad_bills.COMP_CODE_V and ad_bills.BILNO=tbl_booking_insert.BILL_NO) as "PrintCount"

      FROM TBL_BOOKING_INSERT,TBL_BOOKING_MAST,AGENCY_MAST WHERE TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"
 AND AGENCY_MAST."code_subcode"=TBL_BOOKING_MAST."Agency_sub_code"  AND (TBL_BOOKING_INSERT."Insert_Status"=''billed'')' ;
END IF;

IF(billstatus='1' AND rate_audit='y' AND (billmode='1' OR billmode='3'))
THEN

 query1:='SELECT  DISTINCT  TBL_BOOKING_INSERT."Cio_Booking_Id", "No_Insert" AS "no_of_insertion" ,TBL_BOOKING_MAST."Package_code"  AS "edition",
      (SELECT CUST_MAST."Cust_Alias" FROM CUST_MAST  WHERE CUST_MAST."Cust_Code" = TBL_BOOKING_MAST."Client_code") AS "client",
      AGENCY_MAST."Agency_Name" AS "Agency",sum(TBL_BOOKING_INSERT."Gross_Rate") as "Gross_Rate",TBL_BOOKING_MAST."Trade_disc" AS "Commission",tbl_booking_insert."Insert_Date" as "pub_date",
      TBL_BOOKING_INSERT."Insert_Status" AS "status",TBL_BOOKING_MAST."No_of_insertion" AS "total",TBL_BOOKING_MAST."Bill_remarks",
      tbl_booking_insert.BILL_NO
      ,(select max(nvl(ad_bills.PRINT_COUNT,0)) from ad_bills  where  tbl_booking_insert."Comp_Code"=ad_bills.COMP_CODE_V and ad_bills.BILNO=tbl_booking_insert.BILL_NO) as "PrintCount"
      FROM TBL_BOOKING_INSERT,TBL_BOOKING_MAST,AGENCY_MAST WHERE TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"
 AND AGENCY_MAST."code_subcode"=TBL_BOOKING_MAST."Agency_sub_code"  AND (TBL_BOOKING_INSERT."Insert_Status"=''billed'')' ;
END IF;

IF(billstatus='3' AND rate_audit='n' AND (billmode='1' OR billmode='3'))
THEN

 query1:='SELECT  DISTINCT  TBL_BOOKING_INSERT."Cio_Booking_Id", "No_Insert" AS "no_of_insertion" ,TBL_BOOKING_MAST."Package_code"  AS "edition",
      (SELECT CUST_MAST."Cust_Alias" FROM CUST_MAST  WHERE CUST_MAST."Cust_Code" = TBL_BOOKING_MAST."Client_code") AS "client",
      AGENCY_MAST."Agency_Name" AS "Agency",sum(TBL_BOOKING_INSERT."Gross_Rate") as "Gross_Rate",TBL_BOOKING_MAST."Trade_disc" AS "Commission",tbl_booking_insert."Insert_Date" as "pub_date",
      TBL_BOOKING_INSERT."Insert_Status" AS "status",TBL_BOOKING_MAST."No_of_insertion" AS "total",TBL_BOOKING_MAST."Bill_remarks",
      tbl_booking_insert.BILL_NO
      ,(select max(nvl(ad_bills.PRINT_COUNT,0)) from ad_bills  where  tbl_booking_insert."Comp_Code"=ad_bills.COMP_CODE_V and ad_bills.BILNO=tbl_booking_insert.BILL_NO) as "PrintCount"
      FROM TBL_BOOKING_INSERT,TBL_BOOKING_MAST,AGENCY_MAST WHERE TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"
 AND AGENCY_MAST."code_subcode"=TBL_BOOKING_MAST."Agency_sub_code"  AND (TBL_BOOKING_INSERT."Insert_Status"=''billed'')' ;
END IF;
IF(billstatus='3' AND rate_audit='y' AND (billmode='1' OR billmode='3'))
THEN

 query1:='SELECT  DISTINCT  TBL_BOOKING_INSERT."Cio_Booking_Id", "No_Insert" AS "no_of_insertion" ,TBL_BOOKING_MAST."Package_code"  AS "edition",
      (SELECT CUST_MAST."Cust_Alias" FROM CUST_MAST  WHERE CUST_MAST."Cust_Code" = TBL_BOOKING_MAST."Client_code") AS "client",
      AGENCY_MAST."Agency_Name" AS "Agency",sum(TBL_BOOKING_INSERT."Gross_Rate") as "Gross_Rate",TBL_BOOKING_MAST."Trade_disc" AS "Commission",tbl_booking_insert."Insert_Date" as "pub_date",
      TBL_BOOKING_INSERT."Insert_Status" AS "status",TBL_BOOKING_MAST."No_of_insertion" AS "total",TBL_BOOKING_MAST."Bill_remarks",
      tbl_booking_insert.BILL_NO
      ,(select max(nvl(ad_bills.PRINT_COUNT,0)) from ad_bills  where  tbl_booking_insert."Comp_Code"=ad_bills.COMP_CODE_V and ad_bills.BILNO=tbl_booking_insert.BILL_NO) as "PrintCount"
      FROM TBL_BOOKING_INSERT,TBL_BOOKING_MAST,AGENCY_MAST WHERE TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"
 AND AGENCY_MAST."code_subcode"=TBL_BOOKING_MAST."Agency_sub_code"  AND (TBL_BOOKING_INSERT."Insert_Status"=''billed'')' ;
END IF;
IF(billstatus=2)
THEN
 query1:=' SELECT DISTINCT  TBL_BOOKING_INSERT."Cio_Booking_Id","No_Insert" AS "no_of_insertion" ,TBL_BOOKING_MAST."Package_code" AS "edition" ,
(SELECT CUST_MAST."Cust_Alias" FROM CUST_MAST  WHERE CUST_MAST."Cust_Code" = TBL_BOOKING_MAST."Client_code") AS "client",
AGENCY_MAST."Agency_Name" AS "Agency",sum(TBL_BOOKING_INSERT."Gross_Rate") as "Gross_Rate",TBL_BOOKING_MAST."Trade_disc" AS "Commission",tbl_booking_insert."Insert_Date" as "pub_date",
TBL_BOOKING_INSERT."Insert_Status" AS "status",TBL_BOOKING_MAST."No_of_insertion" AS  "total",TBL_BOOKING_MAST."Bill_remarks",
tbl_booking_insert.BILL_NO
,(select max(nvl(ad_bills.PRINT_COUNT,0)) from ad_bills  where  tbl_booking_insert."Comp_Code"=ad_bills.COMP_CODE_V and ad_bills.BILNO=tbl_booking_insert.BILL_NO) as "PrintCount"
FROM TBL_BOOKING_INSERT,TBL_BOOKING_MAST,AGENCY_MAST WHERE TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"  AND
 TBL_BOOKING_INSERT."Insert_Status"=''billed'' AND AGENCY_MAST."code_subcode"=TBL_BOOKING_MAST."Agency_sub_code" ';
END IF;



   IF(billstatus='5')
   THEN

      query1:='SELECT  DISTINCT  TBL_BOOKING_INSERT."Cio_Booking_Id", "No_Insert" AS "no_of_insertion" ,TBL_BOOKING_MAST."Package_code"  AS "edition",
      (SELECT CUST_MAST."Cust_Alias" FROM CUST_MAST  WHERE CUST_MAST."Cust_Code" = TBL_BOOKING_MAST."Client_code") AS "client",
      AGENCY_MAST."Agency_Name" AS "Agency",sum(TBL_BOOKING_INSERT."Gross_Rate") as "Gross_Rate",TBL_BOOKING_MAST."Trade_disc" AS "Commission",tbl_booking_insert."Insert_Date" as "pub_date",
      TBL_BOOKING_INSERT."Insert_Status" AS "status",TBL_BOOKING_MAST."No_of_insertion" AS "total",TBL_BOOKING_MAST."Bill_remarks",
      tbl_booking_insert.BILL_NO
      ,(select max(nvl(ad_bills.PRINT_COUNT,0)) from ad_bills  where  tbl_booking_insert."Comp_Code"=ad_bills.COMP_CODE_V and ad_bills.BILNO=tbl_booking_insert.BILL_NO) as "PrintCount"
      FROM TBL_BOOKING_INSERT,TBL_BOOKING_MAST,AGENCY_MAST WHERE TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"  AND
       TBL_BOOKING_INSERT."Insert_Status"=''publish'' AND AGENCY_MAST."code_subcode"=TBL_BOOKING_MAST."Agency_sub_code"' ;
   END IF;


IF(billstatus=6)
THEN
 query1:=' SELECT DISTINCT  TBL_BOOKING_INSERT."Cio_Booking_Id","No_Insert" AS "no_of_insertion" ,TBL_BOOKING_MAST."Package_code" AS "edition" ,
(SELECT CUST_MAST."Cust_Alias" FROM CUST_MAST  WHERE CUST_MAST."Cust_Code" = TBL_BOOKING_MAST."Client_code") AS "client",
TBL_BOOKING_INSERT."Insert_Status" AS "status",TBL_BOOKING_MAST."No_of_insertion" AS  "total",TBL_BOOKING_MAST."Bill_remarks",
tbl_booking_insert.BILL_NO
,(select max(nvl(ad_bills.PRINT_COUNT,0)) from ad_bills  where  tbl_booking_insert."Comp_Code"=ad_bills.COMP_CODE_V and ad_bills.BILNO=tbl_booking_insert.BILL_NO) as "PrintCount"
FROM TBL_BOOKING_INSERT,TBL_BOOKING_MAST,AGENCY_MAST WHERE TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"  AND
 TBL_BOOKING_INSERT."Insert_Status"=''booked'' AND AGENCY_MAST."code_subcode"=TBL_BOOKING_MAST."Agency_sub_code" ';
END IF;








    IF(v_retainer_name  IS NOT NULL)
THEN
 query1:= query1 ||' and TBL_BOOKING_MAST ."RETAINER" ='''||v_retainer_name ||'''';
END IF;




        IF(v_executive_name IS NOT NULL)
THEN
 query1:= query1||' and TBL_BOOKING_MAST  ."Executive_code" ='''||v_executive_name ||'''';
END IF;



IF(v_branch_name  IS NOT NULL)
THEN
 query1:= query1 ||' and TBL_BOOKING_MAST ."branch" ='''||v_branch_name ||'''';
END IF;



IF(v_ad_category  IS NOT NULL)
THEN
 query1:= query1 ||' and TBL_BOOKING_MAST ."Ad_cat_code" ='''||v_ad_category||'''';
END IF;


IF(v_district  IS NOT NULL)
THEN
 query1:= query1 ||' and TBL_BOOKING_MAST."Agency_sub_code"  in (select AGENCY_MAST."code_subcode" from agency_mast where AGENCY_MAST."Dist_Code" ='''||v_district||''' or '''||v_district||''' is null)';
END IF;



IF(v_taluka IS NOT NULL)
THEN
 query1:= query1||'  AND TBL_BOOKING_MAST."Agency_sub_code"  in (select AGENCY_MAST."code_subcode" from agency_mast where (AGENCY_MAST."Dist_Code"  in(select DIST_CODE from taluka_mast where   TALU_CODE='''||v_taluka||''' or '''||v_taluka||''' is null) )  AND AGENCY_MAST."Dist_Code"='''||v_district||''' OR '''||v_district||'''  IS NULL   )';
END IF;

/*if v_bill_criteria='A' then
    IF(billcycle IS NOT NULL)
    THEN
        query1:=query1 ||' AND AGENCY_MAST."BILL_FREQUENCY"='''||billcycle ||'''';
    END IF;
elsif v_bill_criteria='R' then

    IF(billcycle IS NOT NULL)
    THEN
        query1:=query1 ||' AND TBL_BOOKING_MAST."Bill_cycle" ='''||billcycle ||'''';
    END IF;
end if;*/
IF(agency IS NOT NULL)
THEN
query1:=query1 ||' AND TBL_BOOKING_MAST."Agency_sub_code" ='''||agency ||'''';
END IF;

IF(client IS NOT NULL)
THEN
query1:=query1 ||' AND TBL_BOOKING_MAST."Client_code" ='''||client ||'''';
END IF;


IF(agencytype IS NOT NULL)
THEN
query1:=query1 ||' AND TBL_BOOKING_MAST."Agency_type"  ='''||trim(agencytype)||'''';
END IF;
IF(adtype1 IS NOT NULL)
THEN
query1:=query1 ||' AND TBL_BOOKING_MAST. "Ad_type_code" ='''||adtype1||''' ';
END IF;


IF(bookingcenter  IS NOT NULL)
THEN

query1:=query1 ||' AND TBL_BOOKING_MAST. "branch" ='''||bookingcenter||''' ';
END IF;




if (P_FMG_BILL !='Include')
then

query1:=query1 ||' AND tbl_booking_mast."Booking_type" not in (''2'',''4'',''5'')';

end if;

if(P_SCHEME_TYPE='EXCLUDE')
THEN

query1:=query1 ||' AND tbl_booking_INSERT ."Pai_Free_Ins"  in (''Y'')';

END IF;




IF(revenuecenter IS NOT NULL)
THEN

query1:=query1 ||' AND TBL_BOOKING_MAST. "branch" ='''||revenuecenter||''' ';
END IF;

IF(publication IS NOT NULL)
THEN
query1:=query1 ||'AND  TBL_BOOKING_INSERT."Publication_Code"='''||publication ||'''';
END IF;

if (P_BILLNO is not null) and (pto_bill_no is not null) then
   query1:=query1 ||'AND  tbl_booking_insert.BILL_NO between ='''||P_BILLNO||''' and '''||P_BILLNO||'''';
END IF;



IF(fromdate IS NOT NULL AND todate IS NOT NULL )
THEN
 query1:=query1 ||'  AND "Insert_Date" BETWEEN  '''||fromdate ||''' AND  '''||todate ||''' ';
END IF;



IF(PACKAGE1 IS NOT  NULL)
THEN
query1:=query1 ||' AND  TBL_BOOKING_INSERT."Edition" ='''||PACKAGE1 ||'''';
END IF;

query1:=query1 ||'group by TBL_BOOKING_INSERT."Cio_Booking_Id",tbl_booking_insert."No_Insert" ,TBL_BOOKING_MAST."Package_code"
 , AGENCY_MAST."Agency_Name",TBL_BOOKING_MAST."Trade_disc",TBL_BOOKING_INSERT."Insert_Status",TBL_BOOKING_MAST."No_of_insertion"
 ,TBL_BOOKING_MAST."Bill_remarks",TBL_BOOKING_MAST."Client_code",tbl_booking_insert.BILL_NO, tbl_booking_insert."Comp_Code",tbl_booking_insert."Insert_Date"  order by TBL_BOOKING_INSERT."Cio_Booking_Id", tbl_booking_insert."No_Insert"';


 delete from ank_search_new;
insert into ank_search_new values(query1);
commit;



 OPEN p_recordset FOR

 query1;

END ;
/
/////////////////////////////////////////////////////////////////
/////////////////////update by Garima
CREATE OR REPLACE PROCEDURE Websp_Bindcioidnew1
(
fromdate IN VARCHAR2,
todate IN VARCHAR2,
date1 IN VARCHAR2,
publication IN VARCHAR2,
bookingcenter IN VARCHAR2,
revenuecenter IN VARCHAR2,
agencytype IN VARCHAR2,

PACKAGE1 IN VARCHAR2,
adtype1 IN VARCHAR2,
agency IN VARCHAR2,
client IN VARCHAR2,
billstatus IN VARCHAR2,
rate_audit IN VARCHAR2,
billmode IN VARCHAR2,
billcycle IN VARCHAR2,

v_retainer_name in varchar2,
v_executive_name in varchar2,
v_branch_name in varchar2,
v_ad_category in varchar2,
v_district in varchar2,
v_taluka in varchar2,
pcompcode  IN  varchar2,
P_BILLNO IN VARCHAR2,
P_BILL_GEN_PRIOR IN VARCHAR2,
P_CENTERLOGIN IN VARCHAR2,
P_PUB_CENT_HO IN VARCHAR2,
P_FMG_BILL IN VARCHAR2,
P_SCHEME_TYPE in varchar2,
pto_bill_no in varchar2,

p_recordset OUT Cur_Type_New1.cursor_type

)

IS

query1 VARCHAR2(10000);


v_bill_criteria varchar2(10);

BEGIN
    if adtype1='DI0' then
        select disp_billing_criteria into v_bill_criteria from preferrences where "comp_code"=pcompcode;
    else
        select clsd_billing_criteria into v_bill_criteria from preferrences where "comp_code"=pcompcode;
    end if;
    
   IF(billstatus='3' AND rate_audit='n')
   THEN

      query1:='SELECT  DISTINCT  TBL_BOOKING_INSERT."Cio_Booking_Id", "No_Insert" AS "no_of_insertion" ,TBL_BOOKING_MAST."Package_code"  AS "edition",


      nvl((select distinct cust_mast."Cust_Alias" from cust_mast  where

cust_mast."Cust_Code"=tbl_booking_mast."Client_code"),"Client_code") as "client",


      AGENCY_MAST."Agency_Name" AS "Agency",sum(TBL_BOOKING_INSERT."Gross_Rate") as "Gross_Rate",TBL_BOOKING_MAST."Trade_disc" AS "Commission",tbl_booking_insert."Insert_Date" as "pub_date",
      TBL_BOOKING_INSERT."Insert_Status" AS "status",TBL_BOOKING_MAST."No_of_insertion" AS "total",TBL_BOOKING_MAST."Bill_remarks",
       tbl_booking_insert.BILL_NO
       ,(select max(nvl(ad_bills.PRINT_COUNT,0)) from ad_bills  where  tbl_booking_insert."Comp_Code"=ad_bills.COMP_CODE_V and ad_bills.BILNO=tbl_booking_insert.BILL_NO) as "PrintCount"
      FROM TBL_BOOKING_INSERT,TBL_BOOKING_MAST,AGENCY_MAST WHERE TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"  AND
       TBL_BOOKING_INSERT."Insert_Status"=''publish'' AND AGENCY_MAST."code_subcode"=TBL_BOOKING_MAST."Agency_sub_code"' ;
   END IF;


 IF(billstatus='3' AND rate_audit='y')
THEN

      query1:='SELECT  DISTINCT  TBL_BOOKING_INSERT."Cio_Booking_Id", "No_Insert" AS "no_of_insertion" ,TBL_BOOKING_MAST."Package_code"  AS "edition",
 nvl((select distinct cust_mast."Cust_Alias" from cust_mast  where

cust_mast."Cust_Code"=tbl_booking_mast."Client_code"),"Client_code") as "client",
      AGENCY_MAST."Agency_Name" AS "Agency",sum(TBL_BOOKING_INSERT."Gross_Rate") as "Gross_Rate",TBL_BOOKING_MAST."Trade_disc" AS "Commission",tbl_booking_insert."Insert_Date" as "pub_date",
      TBL_BOOKING_INSERT."Insert_Status" AS "status",TBL_BOOKING_MAST."No_of_insertion" AS "total",TBL_BOOKING_MAST."Bill_remarks",
       tbl_booking_insert.BILL_NO
       ,(select max(nvl(ad_bills.PRINT_COUNT,0)) from ad_bills  where  tbl_booking_insert."Comp_Code"=ad_bills.COMP_CODE_V and ad_bills.BILNO=tbl_booking_insert.BILL_NO) as "PrintCount"

      FROM TBL_BOOKING_INSERT,TBL_BOOKING_MAST,AGENCY_MAST WHERE TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"  AND
       TBL_BOOKING_INSERT."Insert_Status"=''audit by rate'' AND AGENCY_MAST."code_subcode"=TBL_BOOKING_MAST."Agency_sub_code"' ;
END IF;
IF(billstatus='1' AND rate_audit='y'AND billmode='2')
THEN

 query1:='SELECT  DISTINCT  TBL_BOOKING_INSERT."Cio_Booking_Id", "No_Insert" AS "no_of_insertion" ,TBL_BOOKING_MAST."Package_code"  AS "edition",
 nvl((select distinct cust_mast."Cust_Alias" from cust_mast  where

cust_mast."Cust_Code"=tbl_booking_mast."Client_code"),"Client_code") as "client",
      AGENCY_MAST."Agency_Name" AS "Agency",sum(TBL_BOOKING_INSERT."Gross_Rate") as "Gross_Rate",TBL_BOOKING_MAST."Trade_disc" AS "Commission",tbl_booking_insert."Insert_Date" as "pub_date",
      TBL_BOOKING_INSERT."Insert_Status" AS "status",TBL_BOOKING_MAST."No_of_insertion" AS "total",TBL_BOOKING_MAST."Bill_remarks",
       tbl_booking_insert.BILL_NO
       ,(select max(nvl(ad_bills.PRINT_COUNT,0)) from ad_bills  where  tbl_booking_insert."Comp_Code"=ad_bills.COMP_CODE_V and ad_bills.BILNO=tbl_booking_insert.BILL_NO) as "PrintCount"
      FROM TBL_BOOKING_INSERT,TBL_BOOKING_MAST,AGENCY_MAST WHERE TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"
AND AGENCY_MAST."code_subcode"=TBL_BOOKING_MAST."Agency_sub_code"  AND (TBL_BOOKING_INSERT."Insert_Status" =''AUDIT BY rate'' OR TBL_BOOKING_INSERT."Insert_Status"=''billed'')' ;
END IF;
IF(billstatus='1' AND rate_audit='n' AND billmode='2')
THEN

 query1:='SELECT  DISTINCT  TBL_BOOKING_INSERT."Cio_Booking_Id", "No_Insert" AS "no_of_insertion" ,TBL_BOOKING_MAST."Package_code"  AS "edition",
      (SELECT CUST_MAST."Cust_Alias" FROM CUST_MAST  WHERE CUST_MAST."Cust_Code" = TBL_BOOKING_MAST."Client_code") AS "client",
      AGENCY_MAST."Agency_Name" AS "Agency",sum(TBL_BOOKING_INSERT."Gross_Rate") as "Gross_Rate",TBL_BOOKING_MAST."Trade_disc" AS "Commission",tbl_booking_insert."Insert_Date" as "pub_date",
      TBL_BOOKING_INSERT."Insert_Status" AS "status",TBL_BOOKING_MAST."No_of_insertion" AS "total",TBL_BOOKING_MAST."Bill_remarks",
       tbl_booking_insert.BILL_NO
       ,(select max(nvl(ad_bills.PRINT_COUNT,0)) from ad_bills  where  tbl_booking_insert."Comp_Code"=ad_bills.COMP_CODE_V and ad_bills.BILNO=tbl_booking_insert.BILL_NO) as "PrintCount"
      FROM TBL_BOOKING_INSERT,TBL_BOOKING_MAST,AGENCY_MAST WHERE TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"
 AND AGENCY_MAST."code_subcode"=TBL_BOOKING_MAST."Agency_sub_code"  AND (TBL_BOOKING_INSERT."Insert_Status" =''publish'' OR TBL_BOOKING_INSERT."Insert_Status"=''billed'')' ;
END IF;

IF(billstatus='1' AND rate_audit='n' AND (billmode='1' OR billmode='3'))
THEN
 query1:='SELECT  DISTINCT  TBL_BOOKING_INSERT."Cio_Booking_Id", "No_Insert" AS "no_of_insertion" ,TBL_BOOKING_MAST."Package_code"  AS "edition",
      (SELECT CUST_MAST."Cust_Alias" FROM CUST_MAST  WHERE CUST_MAST."Cust_Code" = TBL_BOOKING_MAST."Client_code") AS "client",
      AGENCY_MAST."Agency_Name" AS "Agency",sum(TBL_BOOKING_INSERT."Gross_Rate") as "Gross_Rate",TBL_BOOKING_MAST."Trade_disc" AS "Commission",tbl_booking_insert."Insert_Date" as "pub_date",
      TBL_BOOKING_INSERT."Insert_Status" AS "status",TBL_BOOKING_MAST."No_of_insertion" AS "total",TBL_BOOKING_MAST."Bill_remarks",

      tbl_booking_insert.BILL_NO
      ,(select max(nvl(ad_bills.PRINT_COUNT,0)) from ad_bills  where  tbl_booking_insert."Comp_Code"=ad_bills.COMP_CODE_V and ad_bills.BILNO=tbl_booking_insert.BILL_NO) as "PrintCount"

      FROM TBL_BOOKING_INSERT,TBL_BOOKING_MAST,AGENCY_MAST WHERE TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"
 AND AGENCY_MAST."code_subcode"=TBL_BOOKING_MAST."Agency_sub_code"  AND (TBL_BOOKING_INSERT."Insert_Status"=''billed'')' ;
END IF;

IF(billstatus='1' AND rate_audit='y' AND (billmode='1' OR billmode='3'))
THEN

 query1:='SELECT  DISTINCT  TBL_BOOKING_INSERT."Cio_Booking_Id", "No_Insert" AS "no_of_insertion" ,TBL_BOOKING_MAST."Package_code"  AS "edition",
      (SELECT CUST_MAST."Cust_Alias" FROM CUST_MAST  WHERE CUST_MAST."Cust_Code" = TBL_BOOKING_MAST."Client_code") AS "client",
      AGENCY_MAST."Agency_Name" AS "Agency",sum(TBL_BOOKING_INSERT."Gross_Rate") as "Gross_Rate",TBL_BOOKING_MAST."Trade_disc" AS "Commission",tbl_booking_insert."Insert_Date" as "pub_date",
      TBL_BOOKING_INSERT."Insert_Status" AS "status",TBL_BOOKING_MAST."No_of_insertion" AS "total",TBL_BOOKING_MAST."Bill_remarks",
      tbl_booking_insert.BILL_NO
      ,(select max(nvl(ad_bills.PRINT_COUNT,0)) from ad_bills  where  tbl_booking_insert."Comp_Code"=ad_bills.COMP_CODE_V and ad_bills.BILNO=tbl_booking_insert.BILL_NO) as "PrintCount"
      FROM TBL_BOOKING_INSERT,TBL_BOOKING_MAST,AGENCY_MAST WHERE TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"
 AND AGENCY_MAST."code_subcode"=TBL_BOOKING_MAST."Agency_sub_code"  AND (TBL_BOOKING_INSERT."Insert_Status"=''billed'')' ;
END IF;

IF(billstatus='3' AND rate_audit='n' AND (billmode='1' OR billmode='3'))
THEN

 query1:='SELECT  DISTINCT  TBL_BOOKING_INSERT."Cio_Booking_Id", "No_Insert" AS "no_of_insertion" ,TBL_BOOKING_MAST."Package_code"  AS "edition",
      (SELECT CUST_MAST."Cust_Alias" FROM CUST_MAST  WHERE CUST_MAST."Cust_Code" = TBL_BOOKING_MAST."Client_code") AS "client",
      AGENCY_MAST."Agency_Name" AS "Agency",sum(TBL_BOOKING_INSERT."Gross_Rate") as "Gross_Rate",TBL_BOOKING_MAST."Trade_disc" AS "Commission",tbl_booking_insert."Insert_Date" as "pub_date",
      TBL_BOOKING_INSERT."Insert_Status" AS "status",TBL_BOOKING_MAST."No_of_insertion" AS "total",TBL_BOOKING_MAST."Bill_remarks",
      tbl_booking_insert.BILL_NO
      ,(select max(nvl(ad_bills.PRINT_COUNT,0)) from ad_bills  where  tbl_booking_insert."Comp_Code"=ad_bills.COMP_CODE_V and ad_bills.BILNO=tbl_booking_insert.BILL_NO) as "PrintCount"
      FROM TBL_BOOKING_INSERT,TBL_BOOKING_MAST,AGENCY_MAST WHERE TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"
 AND AGENCY_MAST."code_subcode"=TBL_BOOKING_MAST."Agency_sub_code"  AND (TBL_BOOKING_INSERT."Insert_Status"=''billed'')' ;
END IF;
IF(billstatus='3' AND rate_audit='y' AND (billmode='1' OR billmode='3'))
THEN

 query1:='SELECT  DISTINCT  TBL_BOOKING_INSERT."Cio_Booking_Id", "No_Insert" AS "no_of_insertion" ,TBL_BOOKING_MAST."Package_code"  AS "edition",
      (SELECT CUST_MAST."Cust_Alias" FROM CUST_MAST  WHERE CUST_MAST."Cust_Code" = TBL_BOOKING_MAST."Client_code") AS "client",
      AGENCY_MAST."Agency_Name" AS "Agency",sum(TBL_BOOKING_INSERT."Gross_Rate") as "Gross_Rate",TBL_BOOKING_MAST."Trade_disc" AS "Commission",tbl_booking_insert."Insert_Date" as "pub_date",
      TBL_BOOKING_INSERT."Insert_Status" AS "status",TBL_BOOKING_MAST."No_of_insertion" AS "total",TBL_BOOKING_MAST."Bill_remarks",
      tbl_booking_insert.BILL_NO
      ,(select max(nvl(ad_bills.PRINT_COUNT,0)) from ad_bills  where  tbl_booking_insert."Comp_Code"=ad_bills.COMP_CODE_V and ad_bills.BILNO=tbl_booking_insert.BILL_NO) as "PrintCount"
      FROM TBL_BOOKING_INSERT,TBL_BOOKING_MAST,AGENCY_MAST WHERE TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"
 AND AGENCY_MAST."code_subcode"=TBL_BOOKING_MAST."Agency_sub_code"  AND (TBL_BOOKING_INSERT."Insert_Status"=''billed'')' ;
END IF;
IF(billstatus=2)
THEN
 query1:=' SELECT DISTINCT  TBL_BOOKING_INSERT."Cio_Booking_Id","No_Insert" AS "no_of_insertion" ,TBL_BOOKING_MAST."Package_code" AS "edition" ,
(SELECT CUST_MAST."Cust_Alias" FROM CUST_MAST  WHERE CUST_MAST."Cust_Code" = TBL_BOOKING_MAST."Client_code") AS "client",
AGENCY_MAST."Agency_Name" AS "Agency",sum(TBL_BOOKING_INSERT."Gross_Rate") as "Gross_Rate",TBL_BOOKING_MAST."Trade_disc" AS "Commission",tbl_booking_insert."Insert_Date" as "pub_date",
TBL_BOOKING_INSERT."Insert_Status" AS "status",TBL_BOOKING_MAST."No_of_insertion" AS  "total",TBL_BOOKING_MAST."Bill_remarks",
tbl_booking_insert.BILL_NO
,(select max(nvl(ad_bills.PRINT_COUNT,0)) from ad_bills  where  tbl_booking_insert."Comp_Code"=ad_bills.COMP_CODE_V and ad_bills.BILNO=tbl_booking_insert.BILL_NO) as "PrintCount"
FROM TBL_BOOKING_INSERT,TBL_BOOKING_MAST,AGENCY_MAST WHERE TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"  AND
 TBL_BOOKING_INSERT."Insert_Status"=''billed'' AND AGENCY_MAST."code_subcode"=TBL_BOOKING_MAST."Agency_sub_code" ';
END IF;



   IF(billstatus='5')
   THEN

      query1:='SELECT  DISTINCT  TBL_BOOKING_INSERT."Cio_Booking_Id", "No_Insert" AS "no_of_insertion" ,TBL_BOOKING_MAST."Package_code"  AS "edition",
      (SELECT CUST_MAST."Cust_Alias" FROM CUST_MAST  WHERE CUST_MAST."Cust_Code" = TBL_BOOKING_MAST."Client_code") AS "client",
      AGENCY_MAST."Agency_Name" AS "Agency",sum(TBL_BOOKING_INSERT."Gross_Rate") as "Gross_Rate",TBL_BOOKING_MAST."Trade_disc" AS "Commission",tbl_booking_insert."Insert_Date" as "pub_date",
      TBL_BOOKING_INSERT."Insert_Status" AS "status",TBL_BOOKING_MAST."No_of_insertion" AS "total",TBL_BOOKING_MAST."Bill_remarks",
      tbl_booking_insert.BILL_NO
      ,(select max(nvl(ad_bills.PRINT_COUNT,0)) from ad_bills  where  tbl_booking_insert."Comp_Code"=ad_bills.COMP_CODE_V and ad_bills.BILNO=tbl_booking_insert.BILL_NO) as "PrintCount"
      FROM TBL_BOOKING_INSERT,TBL_BOOKING_MAST,AGENCY_MAST WHERE TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"  AND
       TBL_BOOKING_INSERT."Insert_Status"=''publish'' AND AGENCY_MAST."code_subcode"=TBL_BOOKING_MAST."Agency_sub_code"' ;
   END IF;


IF(billstatus=6)
THEN
 query1:=' SELECT DISTINCT  TBL_BOOKING_INSERT."Cio_Booking_Id","No_Insert" AS "no_of_insertion" ,TBL_BOOKING_MAST."Package_code" AS "edition" ,
(SELECT CUST_MAST."Cust_Alias" FROM CUST_MAST  WHERE CUST_MAST."Cust_Code" = TBL_BOOKING_MAST."Client_code") AS "client",
TBL_BOOKING_INSERT."Insert_Status" AS "status",TBL_BOOKING_MAST."No_of_insertion" AS  "total",TBL_BOOKING_MAST."Bill_remarks",
tbl_booking_insert.BILL_NO
,(select max(nvl(ad_bills.PRINT_COUNT,0)) from ad_bills  where  tbl_booking_insert."Comp_Code"=ad_bills.COMP_CODE_V and ad_bills.BILNO=tbl_booking_insert.BILL_NO) as "PrintCount"
FROM TBL_BOOKING_INSERT,TBL_BOOKING_MAST,AGENCY_MAST WHERE TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"  AND
 TBL_BOOKING_INSERT."Insert_Status"=''booked'' AND AGENCY_MAST."code_subcode"=TBL_BOOKING_MAST."Agency_sub_code" ';
END IF;








    IF(v_retainer_name  IS NOT NULL)
THEN
 query1:= query1 ||' and TBL_BOOKING_MAST ."RETAINER" ='''||v_retainer_name ||'''';
END IF;




        IF(v_executive_name IS NOT NULL)
THEN
 query1:= query1||' and TBL_BOOKING_MAST  ."Executive_code" ='''||v_executive_name ||'''';
END IF;



IF(v_branch_name  IS NOT NULL)
THEN
 query1:= query1 ||' and TBL_BOOKING_MAST ."branch" ='''||v_branch_name ||'''';
END IF;



IF(v_ad_category  IS NOT NULL)
THEN
 query1:= query1 ||' and TBL_BOOKING_MAST ."Ad_cat_code" ='''||v_ad_category||'''';
END IF;


IF(v_district  IS NOT NULL)
THEN
 query1:= query1 ||' and TBL_BOOKING_MAST."Agency_sub_code"  in (select AGENCY_MAST."code_subcode" from agency_mast where AGENCY_MAST."Dist_Code" ='''||v_district||''' or '''||v_district||''' is null)';
END IF;



IF(v_taluka IS NOT NULL)
THEN
 query1:= query1||'  AND TBL_BOOKING_MAST."Agency_sub_code"  in (select AGENCY_MAST."code_subcode" from agency_mast where (AGENCY_MAST."Dist_Code"  in(select DIST_CODE from taluka_mast where   TALU_CODE='''||v_taluka||''' or '''||v_taluka||''' is null) )  AND AGENCY_MAST."Dist_Code"='''||v_district||''' OR '''||v_district||'''  IS NULL   )';
END IF;

/*if v_bill_criteria='A' then
    IF(billcycle IS NOT NULL)
    THEN
        query1:=query1 ||' AND AGENCY_MAST."BILL_FREQUENCY"='''||billcycle ||'''';
    END IF;
elsif v_bill_criteria='R' then

    IF(billcycle IS NOT NULL)
    THEN
        query1:=query1 ||' AND TBL_BOOKING_MAST."Bill_cycle" ='''||billcycle ||'''';
    END IF;
end if;*/
IF(agency IS NOT NULL)
THEN
query1:=query1 ||' AND TBL_BOOKING_MAST."Agency_sub_code" ='''||agency ||'''';
END IF;

IF(client IS NOT NULL)
THEN
query1:=query1 ||' AND TBL_BOOKING_MAST."Client_code" ='''||client ||'''';
END IF;


IF(agencytype IS NOT NULL)
THEN
query1:=query1 ||' AND TBL_BOOKING_MAST."Agency_type"  ='''||trim(agencytype)||'''';
END IF;
IF(adtype1 IS NOT NULL)
THEN
query1:=query1 ||' AND TBL_BOOKING_MAST. "Ad_type_code" ='''||adtype1||''' ';
END IF;


IF(bookingcenter  IS NOT NULL)
THEN

query1:=query1 ||' AND TBL_BOOKING_MAST. "branch" ='''||bookingcenter||''' ';
END IF;




if (P_FMG_BILL !='Include')
then

query1:=query1 ||' AND tbl_booking_mast."Booking_type" not in (''2'',''4'',''5'')';

end if;

if(P_SCHEME_TYPE='EXCLUDE')
THEN

query1:=query1 ||' AND tbl_booking_INSERT ."Pai_Free_Ins"  in (''Y'')';

END IF;




IF(revenuecenter IS NOT NULL)
THEN

query1:=query1 ||' AND TBL_BOOKING_MAST. "branch" ='''||revenuecenter||''' ';
END IF;

IF(publication IS NOT NULL)
THEN
query1:=query1 ||'AND  TBL_BOOKING_INSERT."Publication_Code"='''||publication ||'''';
END IF;

if (P_BILLNO is not null) and (pto_bill_no is not null) then
   query1:=query1 ||'AND  tbl_booking_insert.BILL_NO between '''||P_BILLNO||''' and '''||pto_bill_no||'''';
END IF;



IF(fromdate IS NOT NULL AND todate IS NOT NULL )
THEN
 query1:=query1 ||'  AND "Insert_Date" BETWEEN  '''||fromdate ||''' AND  '''||todate ||''' ';
END IF;



IF(PACKAGE1 IS NOT  NULL)
THEN
query1:=query1 ||' AND  TBL_BOOKING_INSERT."Edition" ='''||PACKAGE1 ||'''';
END IF;

query1:=query1 ||'group by TBL_BOOKING_INSERT."Cio_Booking_Id",tbl_booking_insert."No_Insert" ,TBL_BOOKING_MAST."Package_code"
 , AGENCY_MAST."Agency_Name",TBL_BOOKING_MAST."Trade_disc",TBL_BOOKING_INSERT."Insert_Status",TBL_BOOKING_MAST."No_of_insertion"
 ,TBL_BOOKING_MAST."Bill_remarks",TBL_BOOKING_MAST."Client_code",tbl_booking_insert.BILL_NO, tbl_booking_insert."Comp_Code",tbl_booking_insert."Insert_Date"  order by TBL_BOOKING_INSERT."Cio_Booking_Id", tbl_booking_insert."No_Insert"';


 delete from ank_search_new;
insert into ank_search_new values(query1);
commit;



 OPEN p_recordset FOR

 query1;

END ;
/
/////////////////




//////////////////////////////////////////Issue No. 4887 Date-17/01/2011//////////////////////////////////////////////////////////////
CREATE OR REPLACE PROCEDURE completereport(
    p_compcode      IN VARCHAR2:= NULL,
    p_fromdate      IN VARCHAR2:= NULL,
    p_dateto        IN VARCHAR2:= NULL,
    p_dateformat    IN VARCHAR2:= NULL,
    p_publication   IN VARCHAR2:= NULL,
    p_pub_cent      IN VARCHAR2:= NULL,
    p_edition       IN VARCHAR2:= NULL,
    p_suppliment    IN VARCHAR2:= NULL,
    p_zone          IN VARCHAR2:= NULL,
    p_branch        IN VARCHAR2:= NULL,
    p_district      IN VARCHAR2:= NULL,
    p_region        IN VARCHAR2:= NULL,
    p_city          IN VARCHAR2:= NULL,
    p_revcenter     IN VARCHAR2:= NULL,
    p_adtype        IN VARCHAR2:= NULL,
    p_agencytype    IN VARCHAR2:= NULL,
    p_ratetype      IN VARCHAR2:= NULL,
    p_adcat         IN VARCHAR2:= NULL,
    p_adsubcat      IN VARCHAR2:= NULL,
    p_adsubcat3     IN VARCHAR2:= NULL,
    p_adsubcat4     IN VARCHAR2:= NULL,
    p_adsubcat5     IN VARCHAR2:= NULL,
    p_package       IN VARCHAR2:= NULL,
    p_scheme        IN VARCHAR2:= NULL,
    p_agency        IN VARCHAR2:= NULL,
    p_client        IN VARCHAR2:= NULL,
    p_executive     IN VARCHAR2:= NULL,
    p_retainer      IN VARCHAR2:= NULL,
    p_product       IN VARCHAR2:= NULL,
    p_brand         IN VARCHAR2:= NULL,
    p_varient       IN VARCHAR2:= NULL,
    p_pagetype      IN VARCHAR2:= NULL,
    p_pageprem      IN VARCHAR2:= NULL,
    p_postprem      IN VARCHAR2:= NULL,
    p_rostatus      IN VARCHAR2:= NULL,
    p_booktype      IN VARCHAR2:= NULL,
    p_contractname  IN varchar2:= NULL,
    p_filterby      IN varchar2:= NULL,
    p_adcheck       in varchar2:=null,
    p_state         in varchar2:=null,
    p_taluka        in varchar2:=null,
    p_base          in varchar2:=null,
    p_drpstatus     in varchar2:=null,
    p_chkdetail     in varchar2:=null,
    p_insertstatus  in varchar2:=null,
    p_puserid       in varchar2:=null,
    p_baxcode       in varchar2:=null,
    p_chk_access    in varchar2:=null,
    p_recordset1    OUT Cur_Type_New1.cursor_type,
    p_accounts      OUT Cur_Type_New1.cursor_type)

IS
query1 VARCHAR2(20000);
v_val number(5);
query2 VARCHAR2(20000);
query3 VARCHAR2(20000);


bookdate varchar2(50);
noinsert varchar2(50);
Paidinsert varchar2(50);
Area varchar2(50);
Pagepremium varchar2(50);
cardamt varchar2(50);
Deviationamt varchar2(50);
Deviationper varchar2(50);
aggamt varchar2(50);
DiscAmt varchar2(50);
Discper varchar2(50);
posamt varchar2(50);
posper varchar2(50);
Spdiscamt varchar2(50);
Spdiscper varchar2(50);
Spacedisc varchar2(50);
Spacediscper varchar2(50);
Specialcharge varchar2(50);
AgencyAddlTDper varchar2(50);
AgencyAddlTDAmt varchar2(50);
Grossamt varchar2(50);
RetTDper varchar2(50);
RetTDAmt varchar2(50);
AgencyTDper varchar2(50);
AgencyTDAmt varchar2(50);
Billamt varchar2(50);
RetCommper varchar2(50);
RetCommAmt varchar2(50);
ActualBusines varchar2(50);



Cursor C1 Is
SELECT /*+ index(TBL_BOOKING_MAST IND_TBL_BOOKING_MAST) index(TBL_BOOKING_INSERT  INSERT_I) */  distinct TBL_BOOKING_mast."cio_booking_id" AS "CIOID",
TBL_BOOKING_MAST."Package_code" as package_code,TBL_BOOKING_mast."Gross_amount" as Crate,'1' as chk_var
FROM TBL_BOOKING_MAST, TBL_BOOKING_INSERT
WHERE TBL_BOOKING_MAST."Comp_code"=p_compcode
AND TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"
AND ((tbl_booking_mast."Insertion_date" BETWEEN p_fromdate AND p_dateto and p_filterby='Publish Date') or (tbl_booking_mast."date_time" BETWEEN p_fromdate AND p_dateto and p_filterby='Booking Date'))
AND (TBL_BOOKING_INSERT."Publication_Code"=p_publication or p_publication is null)
--old version

and TBL_BOOKING_MAST."branch" IN (SELECT "Branch_Name" FROM BRANCH_MST WHERE TBL_BOOKING_MAST."branch"="Branch_Name" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"=p_pub_cent or p_pub_cent is null))
and (tbl_booking_mast."branch" =p_branch or p_branch is null)

--new version
--and TBL_BOOKING_MAST."branch" IN (SELECT "Branch_Code" FROM BRANCH_MST WHERE TBL_BOOKING_MAST."branch"="Branch_Code" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"=p_pub_cent or p_pub_cent is null))
--and (tbl_booking_mast."branch" = (SELECT "Branch_Code" FROM BRANCH_MST where "Branch_Name" =p_branch))

AND (TBL_BOOKING_MAST."Ad_type_code"=p_adtype or p_adtype is null)
AND (TBL_BOOKING_MAST."Ad_cat_code"=p_adcat or p_adcat is null)
AND (TBL_BOOKING_INSERT."Edition_Code"=p_edition or p_edition is null)
and (TBL_BOOKING_MAST."Agency_sub_code"  in (select AGENCY_MAST."code_subcode" from agency_mast where agency_mast."region" =p_region  or p_region is null))
and (tbl_booking_mast."Revenue_center" =p_revcenter or p_revcenter is null)
and (TBL_BOOKING_MAST."Agency_type" =p_agencytype or p_agencytype is null)
and (TBL_BOOKING_MAST."Ad_sub_cat_code" =p_adsubcat or p_adsubcat is null)
and (TBL_BOOKING_MAST."Ad_Subcat3" =p_adsubcat3 or p_adsubcat3 is null)
and (TBL_BOOKING_MAST."Ad_Subcat4" =p_adsubcat4 or p_adsubcat4 is null)
and (TBL_BOOKING_MAST."Ad_subcat5" =p_adsubcat5 or p_adsubcat5 is null)
and (TBL_BOOKING_MAST."Package_code" =p_package or p_package is null)
and (TBL_BOOKING_MAST."Scheme_type_code" =p_scheme or p_scheme is null)
and (TBL_BOOKING_MAST."Agency_code" =p_agency or p_agency is null)
and (TBL_BOOKING_MAST."Client_code" =p_client or p_client is null)
and (TBL_BOOKING_MAST."Executive_code" =p_executive or p_executive is null)
and (TBL_BOOKING_MAST.RETAINER =p_retainer or p_retainer is null)
and (TBL_BOOKING_MAST."Product_code" =p_product  or p_product is null)
and (TBL_BOOKING_MAST."Brand_code" =p_brand or p_brand is null)
and (TBL_BOOKING_MAST."Variant_code" =p_varient or p_varient is null)
and (TBL_BOOKING_MAST."Page_type_code" =p_pagetype or p_pagetype is null)
and (TBL_BOOKING_MAST."Page_prem" =p_pageprem or p_pageprem is null)
and (TBL_BOOKING_MAST."Page_position_code" =p_postprem or p_postprem is null)
and (TBL_BOOKING_MAST."ro_status" =p_rostatus or p_rostatus is null)
and (TBL_BOOKING_MAST."Booking_type" =p_booktype or p_booktype is null)
and (TBL_BOOKING_MAST."Contract_name" =p_contractname or p_contractname is null)
and (tbl_booking_insert."Supp_Code" =p_suppliment or p_suppliment is null)
and (tbl_booking_MAST."Rate_code" =p_ratetype or p_ratetype is null)
and (tbl_booking_mast."Box_code" = p_baxcode or p_baxcode is null)

and ((p_base='1' and TBL_BOOKING_MAST."Agency_sub_code"  in (select AGENCY_MAST."code_subcode" from agency_mast where AGENCY_MAST."City_Code" =p_city or p_city is null))
or (p_base='2' and tbl_booking_mast."Executive_code"  in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" =p_city or p_city is null))
or (p_base='3' and tbl_booking_mast.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."City_Code"=p_city or p_city is null)))

and ((p_base='1' and TBL_BOOKING_MAST."Agency_sub_code"  in (select AGENCY_MAST."code_subcode" from agency_mast where AGENCY_MAST."zone_code" =p_zone or p_zone is null))
or (p_base='2' and tbl_booking_mast."Executive_code"  in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" in (select city_mst."City_Code" from city_mst where city_mst."Zone_Code"= p_zone or p_zone is null) ))
or (p_base='3' and tbl_booking_mast.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Zone_Code"=p_zone or p_zone is null)))

and ((p_base='1' and TBL_BOOKING_MAST."Agency_sub_code"  in (select AGENCY_MAST."code_subcode" from agency_mast where AGENCY_MAST."Dist_Code" =p_district or p_district is null))
or (p_base='2' and tbl_booking_mast."Executive_code"  in(select exec_mast."Exe_no" from exec_mast where exec_mast."dist_code"= p_district or p_district is null ))
or (p_base='3' and tbl_booking_mast.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Dist_Code"=p_district or p_district is null)))

and ((p_base='1' and TBL_BOOKING_MAST."Agency_sub_code"  in (select AGENCY_MAST."code_subcode" from agency_mast where AGENCY_MAST."State_Code" =p_state or p_state is null))
or (p_base='2' and tbl_booking_mast."Executive_code"  in(select exec_mast."Exe_no" from exec_mast where exec_mast."State_code"= p_state or p_state is null ))
or (p_base='3' and tbl_booking_mast.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."State_Code"=p_state or p_state is null)))

and ((p_base='1' and TBL_BOOKING_MAST."Agency_sub_code"  in (select AGENCY_MAST."code_subcode" from agency_mast where AGENCY_MAST.TALUKA=p_taluka or p_taluka is null) )
or (p_base='2' and tbl_booking_mast."Executive_code"  in(select exec_mast."Exe_no" from exec_mast where exec_mast.TALUKA= p_taluka or p_taluka is null ))
or (p_base='3' and tbl_booking_mast.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER.TALUKA=p_taluka or p_taluka is null)))

and ((p_base='1' and TBL_BOOKING_MAST."Agency_sub_code" IS NOT NULL AND TBL_BOOKING_MAST."Agency_sub_code"!='0')
or (p_base='2' and tbl_booking_mast."Executive_code"    is not null and tbl_booking_mast."Executive_code" !='0' )
or (p_base='3' and tbl_booking_mast.RETAINER is not null  and tbl_booking_mast.RETAINER !='0'))

and ((p_drpstatus is  not null and  TBL_BOOKING_INSERT."Insert_Status"!='XYZ') or (p_drpstatus is  null and  lower("Insert_Status")!='cancel'))
and (lower("Insert_Status")=p_insertstatus or p_insertstatus is null)

and ((tbl_booking_insert."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id=p_puserid) and p_chk_access=1)
or  (p_chk_access=0) )

  
and p_adcheck='1'

union

SELECT /*+ index(TBL_BOOKING_MAST IND_TBL_BOOKING_MAST) index(TBL_BOOKING_INSERT  INSERT_I) */ distinct TBL_BOOKING_mast."cio_booking_id" AS "CIOID",
TBL_BOOKING_MAST."Package_code" as package_code,tbl_booking_insert."Gross_Rate" as Crate,'1' as chk_var
FROM TBL_BOOKING_MAST, TBL_BOOKING_INSERT
WHERE TBL_BOOKING_MAST."Comp_code"=p_compcode
AND TBL_BOOKING_MAST."Comp_code"=TBL_BOOKING_INSERT."Comp_Code"
AND TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"
AND (tbl_booking_insert."Insert_Date" BETWEEN p_fromdate AND p_dateto )
AND (TBL_BOOKING_INSERT."Publication_Code"=p_publication or p_publication is null)
--old version

and TBL_BOOKING_MAST."branch" IN (SELECT "Branch_Name" FROM BRANCH_MST WHERE TBL_BOOKING_MAST."branch"="Branch_Name" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"=p_pub_cent or p_pub_cent is null))
and (tbl_booking_mast."branch" =p_branch or p_branch is null)

--new version
--and TBL_BOOKING_MAST."branch" IN (SELECT "Branch_Code" FROM BRANCH_MST WHERE TBL_BOOKING_MAST."branch"="Branch_Code" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"=p_pub_cent or p_pub_cent is null))
--and (tbl_booking_mast."branch" = (SELECT "Branch_Code" FROM BRANCH_MST where "Branch_Name" =p_branch))


AND (TBL_BOOKING_MAST."Ad_type_code"=p_adtype or p_adtype is null)
AND (TBL_BOOKING_insert."Ad_Cat" =p_adcat or p_adcat is null)
AND (TBL_BOOKING_INSERT."Edition_Code"=p_edition or p_edition is null)
and (TBL_BOOKING_MAST."Agency_sub_code"  in (select AGENCY_MAST."code_subcode" from agency_mast where agency_mast."region" =p_region  or p_region is null))
and (tbl_booking_mast."Revenue_center" =p_revcenter or p_revcenter is null)
and (TBL_BOOKING_MAST."Agency_type" =p_agencytype or p_agencytype is null)
and (TBL_BOOKING_MAST."Ad_sub_cat_code" =p_adsubcat or p_adsubcat is null)
and (TBL_BOOKING_MAST."Ad_Subcat3" =p_adsubcat3 or p_adsubcat3 is null)
and (TBL_BOOKING_MAST."Ad_Subcat4" =p_adsubcat4 or p_adsubcat4 is null)
and (TBL_BOOKING_MAST."Ad_subcat5" =p_adsubcat5 or p_adsubcat5 is null)
and (TBL_BOOKING_MAST."Package_code" =p_package or p_package is null)
and (TBL_BOOKING_MAST."Scheme_type_code" =p_scheme or p_scheme is null)
and (TBL_BOOKING_MAST."Agency_code" =p_agency or p_agency is null)
and (TBL_BOOKING_MAST."Client_code" =p_client or p_client is null)
and (TBL_BOOKING_MAST."Executive_code" =p_executive or p_executive is null)
and (TBL_BOOKING_MAST.RETAINER =p_retainer or p_retainer is null)
and (TBL_BOOKING_MAST."Product_code" =p_product  or p_product is null)
and (TBL_BOOKING_MAST."Brand_code" =p_brand or p_brand is null)
and (TBL_BOOKING_MAST."Variant_code" =p_varient or p_varient is null)
and (TBL_BOOKING_MAST."Page_type_code" =p_pagetype or p_pagetype is null)
and (TBL_BOOKING_insert."Premium1"  =p_pageprem or p_pageprem is null)
and (tbl_booking_insert."Page_Post" =p_postprem or p_postprem is null)
and (TBL_BOOKING_MAST."ro_status" =p_rostatus or p_rostatus is null)
and (TBL_BOOKING_MAST."Booking_type" =p_booktype or p_booktype is null)
and (TBL_BOOKING_MAST."Contract_name" =p_contractname or p_contractname is null)
and (tbl_booking_insert."Supp_Code" =p_suppliment or p_suppliment is null)
and (tbl_booking_MAST."Rate_code" =p_ratetype or p_ratetype is null)
and (tbl_booking_mast."Box_code" = p_baxcode or p_baxcode is null)
and ((p_base='1' and TBL_BOOKING_MAST."Agency_sub_code"  in (select AGENCY_MAST."code_subcode" from agency_mast where AGENCY_MAST."City_Code" =p_city or p_city is null))
or (p_base='2' and tbl_booking_mast."Executive_code"  in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" =p_city or p_city is null))
or (p_base='3' and tbl_booking_mast.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."City_Code"=p_city or p_city is null)))
and ((p_base='1' and TBL_BOOKING_MAST."Agency_sub_code"  in (select AGENCY_MAST."code_subcode" from agency_mast where AGENCY_MAST."zone_code" =p_zone or p_zone is null))
or (p_base='2' and tbl_booking_mast."Executive_code"  in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" in (select /*+ index(city_mst ind_city_mst) */ city_mst."City_Code" from city_mst where city_mst."Zone_Code"= p_zone or p_zone is null) 
))
or (p_base='3' and tbl_booking_mast.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Zone_Code"=p_zone or p_zone is null)))
and ((p_base='1' and TBL_BOOKING_MAST."Agency_sub_code"  in (select AGENCY_MAST."code_subcode" from agency_mast where AGENCY_MAST."Dist_Code" =p_district or p_district is null))
or (p_base='2' and tbl_booking_mast."Executive_code"  in(select exec_mast."Exe_no" from exec_mast where exec_mast."dist_code"= p_district or p_district is null ))
or (p_base='3' and tbl_booking_mast.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Dist_Code"=p_district or p_district is null)))
and ((p_base='1' and TBL_BOOKING_MAST."Agency_sub_code"  in (select AGENCY_MAST."code_subcode" from agency_mast where AGENCY_MAST."State_Code" =p_state or p_state is null))
or (p_base='2' and tbl_booking_mast."Executive_code"  in(select exec_mast."Exe_no" from exec_mast where exec_mast."State_code"= p_state or p_state is null ))
or (p_base='3' and tbl_booking_mast.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."State_Code"=p_state or p_state is null)))
and ((p_base='1' and TBL_BOOKING_MAST."Agency_sub_code"  in (select AGENCY_MAST."code_subcode" from agency_mast where AGENCY_MAST.TALUKA=p_taluka or p_taluka is null) )
or (p_base='2' and tbl_booking_mast."Executive_code"  in(select exec_mast."Exe_no" from exec_mast where exec_mast.TALUKA= p_taluka or p_taluka is null ))
or (p_base='3' and tbl_booking_mast.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER.TALUKA=p_taluka or p_taluka is null)))
and ((p_base='1' and TBL_BOOKING_MAST."Agency_sub_code" IS NOT NULL AND TBL_BOOKING_MAST."Agency_sub_code"!='0')
or (p_base='2' and tbl_booking_mast."Executive_code"    is not null and tbl_booking_mast."Executive_code" !='0' )
or (p_base='3' and tbl_booking_mast.RETAINER is not null  and tbl_booking_mast.RETAINER !='0'))
and ((p_drpstatus is  not null and  TBL_BOOKING_INSERT."Insert_Status"!='XYZ')
or (p_drpstatus is  null and  lower("Insert_Status")!='cancel'))
and (lower("Insert_Status")=p_insertstatus or p_insertstatus is null)

and ((tbl_booking_insert."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id=p_puserid) and p_chk_access=1)
or  (p_chk_access=0) )

and p_adcheck='3'

union

SELECT /*+ index (ad_bills_det ind1_ad_bills_det) */distinct ad_bills."IDNUM" AS "CIOID",
ad_bills_det.PACKAGE_CODE as package_code,ad_bills.GROSS_AMT as Crate,'2' as chk_var
FROM ad_bills, ad_bills_det,agency_mast,branch_mst
WHERE ad_bills.IDNUM=ad_bills_det.IDNUM
AND ad_bills.BILDT >= p_fromdate and ad_bills.BILDT <= p_dateto
and (ad_bills."PRIPUB"=p_publication  or p_publication is null)
and (ad_bills_det."EDITION"=p_edition or p_edition is null)
and ad_bills.AGCODE =AGENCY_MAST."code_subcode" and (agency_mast."region" =p_region  or p_region is null)
and (ad_bills_det."AD_TYPE_V"=p_adtype or p_adtype is null)
and (agency_mast."Agency_Type_Code" =p_agencytype or p_agencytype is null)
and (ad_bills_det.PRIADCTG =p_adcat or p_adcat is null)
and (ad_bills_det.SECADCTG =p_adsubcat or p_adsubcat is null)
and (ad_bills_det."AD_SUBCAT3"  =p_adsubcat3 or p_adsubcat3 is null)
and (ad_bills_det.AD_SUBCAT4 =p_adsubcat4 or p_adsubcat4 is null)
and (ad_bills_det.AD_SUBCAT5 =p_adsubcat5 or p_adsubcat5 is null)
and (ad_bills_det.PACKAGE_CODE =p_package or p_package is null)
and (agency_mast."Agency_Code" =p_agency or p_agency is null)
and (ad_bills."CLIENTCD"=p_client or p_client is null)
and (ad_bills."EXECUTIVE_NAME"=p_executive or p_executive is null)
and (ad_bills."PRIPROCTG"=p_product or p_product is null)
and ((ad_bills."PRIPROCTG" in (select /*+ index(brand_mst brand_mst_pk)*/ brand_mst."prod_cat_code" from brand_mst where brand_mst."brand_code"=p_brand or p_brand is null) 
and ad_bills."PRIPROCTG" is not null)or (ad_bills."PRIPROCTG" is null))
and ((ad_bills."PRIPROCTG" in (select /*+ index(brand_mst brand_mst_pk)*/ brand_mst."prod_cat_code" from brand_mst where brand_mst."brand_code" in(select /*+ index(varient_mst ind_varient_mst) */ varient_mst."Brand_Code" from varient_mst where varient_mst."Varient_Name"=p_varient or p_varient is null)) 
and ad_bills."PRIPROCTG" is not null) or (ad_bills."PRIPROCTG" is null))
and (ad_bills_det.PAGE_PREM =p_pageprem or p_pageprem is null)
and (ad_bills_det.PAGE_POST =p_postprem or p_postprem is null)
and (ad_bills.CONTRACT_NAME =p_contractname or p_contractname is null)
and (ad_bills_det.SUPP_CODE =p_suppliment or p_suppliment is null)
and (ad_bills.RETAINER_CODE =p_retainer or p_retainer is null)
and (ad_bills_det.RATECD =p_ratetype or p_ratetype is null)
and ad_bills.UNIT = branch_mst."Branch_Code" and (branch_mst."Branch_Name" =p_branch or p_branch is null) 
and (branch_mst."pub_center"=p_pub_cent or p_pub_cent is null)
and (ad_bills.SCHEME=scheme or scheme is null)
and (AD_BILLS.REVENUE_CENTER =p_revcenter or p_revcenter is null)
and (AD_BILLS.RO_STATUS =p_rostatus or p_rostatus is null)
and (AD_BILLS.PAGE_TYPE =p_pagetype or p_pagetype is null)
and (AD_BILLS.BOOKING_TYPE =p_booktype or p_booktype is null)
 and (ad_bills.SCHEME=p_scheme or p_scheme is null)
 and (AD_BILLS.REVENUE_CENTER =p_revcenter or p_revcenter is null)
 and (AD_BILLS.RO_STATUS =p_rostatus or p_rostatus is null)
 and (AD_BILLS.PAGE_TYPE =p_pagetype or p_pagetype is null)
 and (AD_BILLS.BOOKING_TYPE =p_booktype or p_booktype is null)
and ((p_base='1' and (AGENCY_MAST."City_Code" =p_city or p_city is null))
or (p_base='2' and ad_bills.EXECUTIVE_NAME in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" =p_city or p_city is null))
or (p_base='3' and ad_bills.RETAINER_CODE in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."City_Code"=p_city or p_city is null)))

and ((p_base='1' and (AGENCY_MAST."zone_code" =p_zone or p_zone is null))
or (p_base='2' and ad_bills.EXECUTIVE_NAME in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" in (select city_mst."City_Code" from city_mst where city_mst."Zone_Code"= p_zone or p_zone is null) ))
or (p_base='3' and ad_bills.RETAINER_CODE in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Zone_Code"=p_zone or p_zone is null)))

and ((p_base='1' and (AGENCY_MAST."Dist_Code" =p_district or p_district is null))
or (p_base='2' and ad_bills.EXECUTIVE_NAME in(select exec_mast."Exe_no" from exec_mast where exec_mast."dist_code"= p_district or p_district is null ))
or (p_base='3' and ad_bills.RETAINER_CODE in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Dist_Code"=p_district or p_district is null)))

and ((p_base='1' and (AGENCY_MAST."State_Code" =p_state or p_state is null))
or (p_base='2' and ad_bills.EXECUTIVE_NAME in(select exec_mast."Exe_no" from exec_mast where exec_mast."State_code"= p_state or p_state is null ))
or (p_base='3' and ad_bills.RETAINER_CODE in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."State_Code"=p_state or p_state is null)))

and ((p_base='1' and (AGENCY_MAST.TALUKA=p_taluka or p_taluka is null) )
or (p_base='2' and ad_bills.EXECUTIVE_NAME   in(select exec_mast."Exe_no" from exec_mast where exec_mast.TALUKA= p_taluka or p_taluka is null ))
or (p_base='3' and ad_bills.RETAINER_CODE  in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER.TALUKA=p_taluka or p_taluka is null)))

and ((p_base='1' and ad_bills.AGCODE IS NOT NULL AND ad_bills.AGCODE!='0')
or (p_base='2' and ad_bills.EXECUTIVE_NAME   is not null and ad_bills.EXECUTIVE_NAME !='0' )
or (p_base='3' and ad_bills.RETAINER_CODE  is not null  and ad_bills.RETAINER_CODE !='0'))

and ((ad_bills_det."BKFOR" in (select distinct pub_center from login_center where newuser_id=p_puserid) and p_chk_access=1)
or  (p_chk_access=0) )

and p_adcheck='2';

v1 c1%rowtype;


---**************************************  For Billing Data*************************
Cursor C2 Is
SELECT distinct ad_bills."IDNUM" AS "CIOID",ad_bills.BILNO as "BILLNO" ,ad_bills.ag_main_code as "AGMAINCODE",ad_bills.ag_sub_code as "AG_SUB_CODE",ad_bills.agcode as "AGCODE",
"Agency_Name" as "AGNAME",nvl(ad_bills.executive_name,0) as "EXECCODE",AD_GET_EXECNAME(p_compcode,ad_bills.EXECUTIVE_NAME) as "EXECNAME",ad_bills.RETAINER_CODE as "RETCODE",AD_GET_RETAINER(p_compcode,ad_bills.RETAINER_CODE) as "RETNAME"
FROM ad_bills,AGENCY_MAST,branch_mst WHERE ad_bills.comp_code_v=p_compcode 
and ad_bills.BILDT >= p_fromdate and ad_bills.BILDT <=p_dateto 
and ad_bills.UNIT=branch_mst."Branch_Code" and (branch_mst."Branch_Name" =p_branch or p_branch is null) 
and (BRANCH_MST."pub_center" =p_pub_cent or p_pub_cent is null)
and ad_bills.AGCODE =AGENCY_MAST."code_subcode" and (agency_mast."region" =p_region  or p_region is null)
and (agency_mast."Agency_Type_Code" =p_agencytype or p_agencytype is null)
and (ad_bills."PRIPUB"=p_publication  or p_publication is null)
and (agency_mast."Agency_Code" =p_agency or p_agency is null)
and (ad_bills."CLIENTCD"=p_client or p_client is null)
and (ad_bills."EXECUTIVE_NAME"=p_executive or p_executive is null)
and (ad_bills."PRIPROCTG"=p_product or p_product is null)
and ((ad_bills."PRIPROCTG" in (select brand_mst."prod_cat_code" from brand_mst where brand_mst."brand_code"=p_brand or p_brand is null) and ad_bills."PRIPROCTG" is not null)or (ad_bills."PRIPROCTG" is null))
and ((ad_bills."PRIPROCTG" in (select brand_mst."prod_cat_code" from brand_mst where brand_mst."brand_code" in(select varient_mst."Brand_Code" from varient_mst where varient_mst."Varient_Name"=p_varient or p_varient is null)) and ad_bills."PRIPROCTG" is not null) or (ad_bills."PRIPROCTG" is null))
and (ad_bills.CONTRACT_NAME =p_contractname or p_contractname is null)
and (ad_bills.RETAINER_CODE =p_retainer or p_retainer is null)
and (ad_bills.SCHEME=p_scheme or p_scheme is null)
and (AD_BILLS.REVENUE_CENTER =p_revcenter or p_revcenter is null)
and (AD_BILLS.RO_STATUS =p_rostatus or p_rostatus is null)
and (AD_BILLS.PAGE_TYPE =p_pagetype or p_pagetype is null)
and (AD_BILLS.BOOKING_TYPE =p_booktype or p_booktype is null)
and ((p_base='1' and (AGENCY_MAST."City_Code" =p_city or p_city is null))
or (p_base='2' and ad_bills.EXECUTIVE_NAME in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" =p_city or p_city is null))
or (p_base='3' and ad_bills.RETAINER_CODE in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."City_Code"=p_city or p_city is null)))
and ((p_base='1' and (AGENCY_MAST."zone_code" =p_zone or p_zone is null))
or (p_base='2' and ad_bills.EXECUTIVE_NAME in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" in (select city_mst."City_Code" from city_mst where city_mst."Zone_Code"= p_zone or p_zone is null) ))
or (p_base='3' and ad_bills.RETAINER_CODE in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Zone_Code"=p_zone or p_zone is null)))
and ((p_base='1' and (AGENCY_MAST."Dist_Code" =p_district or p_district is null))
or (p_base='2' and ad_bills.EXECUTIVE_NAME in(select exec_mast."Exe_no" from exec_mast where exec_mast."dist_code"= p_district or p_district is null ))
or (p_base='3' and ad_bills.RETAINER_CODE in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Dist_Code"=p_district or p_district is null)))
and ((p_base='1' and (AGENCY_MAST."State_Code" =p_state or p_state is null))
or (p_base='2' and ad_bills.EXECUTIVE_NAME in(select exec_mast."Exe_no" from exec_mast where exec_mast."State_code"= p_state or p_state is null ))
or (p_base='3' and ad_bills.RETAINER_CODE in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."State_Code"=p_state or p_state is null)))
and ((p_base='1' and (AGENCY_MAST.TALUKA=p_taluka or p_taluka is null) )
or (p_base='2' and ad_bills.EXECUTIVE_NAME   in(select exec_mast."Exe_no" from exec_mast where exec_mast.TALUKA= p_taluka or p_taluka is null ))
or (p_base='3' and ad_bills.RETAINER_CODE  in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER.TALUKA=p_taluka or p_taluka is null)))
and ((p_base='1' and ad_bills.AGCODE IS NOT NULL AND ad_bills.AGCODE!='0')
or (p_base='2' and ad_bills.EXECUTIVE_NAME   is not null and ad_bills.EXECUTIVE_NAME !='0' )
or (p_base='3' and ad_bills.RETAINER_CODE  is not null  and ad_bills.RETAINER_CODE !='0'));

v2 C2%rowtype;

--**********************************************************************************

v_edition varchar2(100);
v_edipkg varchar2(500);
prefer   varchar2(10);

BEGIN
delete from searchtbl;
/*insert into searchtbl values('compcode-'||compcode||'fromdate-'||fromdate||'dateto-'||dateto||'dateformat-'||dateformat||'publication-'||publication
||'pub_cent-'||pub_cent||'edition-'||edition||'suppliment-'||suppliment||'zone-'||zone||'branch-'||branch||'district-'||district||'region-'||region||
'city-'||city||'revcenter-'||revcenter||'adtype-'||adtype||'agencytype-'||agencytype||'ratetype-'||ratetype||'adcat-'||adcat||'adsubcat-'||adsubcat||
'adsubcat3-'||adsubcat3||'adsubcat4-'||adsubcat4||'adsubcat5-'||adsubcat5||'package-'||package||'scheme-'||scheme||'agency-'||agency||'client-'||client||
'executive-'||executive||'retainer-'||retainer||'product-'||product||'brand-'||brand||'varient-'||varient||'pagetype-'||pagetype||'pageprem-'||pageprem||
'postprem-'||postprem||'rostatus-'||rostatus||'booktype-'||booktype||'contractname-'||contractname||'filterby-'||filterby||'adcheck-'||adcheck||'state-'||state||
'taluka-'||taluka||'base-'||base||'drpstatus-'||drpstatus||'chkdetail-'||chkdetail||'insertstatus-'||insertstatus||'puserid-'||puserid||'chk_access-'||chk_access);

*/


select DISTINCT AGENCY_RETAINER_COMM into prefer from preferrences where "comp_code"=p_compcode;

delete from multipack_rep where sess_id=userenv('sessionid')  ;
delete from multipack_rat where sess_id=userenv('sessionid') ;
DELETE FROM multipack_ratnew where sess_id=userenv('sessionid')  ;

commit;
open c1;
loop
fetch c1 into v1;
exit when c1%notfound;

     v_val:=multipack_report(v1.CIOID,v1.package_code,v1.Crate,v1.chk_var);

    v_edition:=null;v_edipkg:=null;
end loop;
close c1; 
commit;

if(p_chkdetail='Detail')then

if(p_adcheck=1)
then
query1:=query1||'SELECT distinct TBL_BOOKING_MAST."cio_booking_id" AS "CIOID",
to_char(TBL_BOOKING_MAST."date_time",'''||p_dateformat||''') as "BookDate",
AGENCY_MAST."Agency_Name" AS "Agency",
NVL((SELECT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code"="Client_code"),"Client_code")  AS "Client",
"RO_No" AS "RoNo.",
CASE '''||p_dateformat||'''
WHEN ''mm/dd/yyyy'' THEN TO_CHAR("RO_Date",''mm/dd/yyyy'')
WHEN ''dd/mm/yyyy'' THEN TO_CHAR("RO_Date" ,''dd/mm/yyyy'')
WHEN ''yyyy/mm/dd'' THEN TO_CHAR("RO_Date",''yyyy/mm/dd'') END AS "Ro.Date",
(select EXEC_MAST."Exec_name" from exec_mast where tbl_booking_mast."Executive_code"=exec_mast."Exe_no") AS "Executive",
(select RETAINERMASTER."Retain_Name"  FROM  RETAINERMASTER where RETAINERMASTER."Retain_Code"=tbl_booking_mast.RETAINER ) AS "Retainer",
decode(tbl_booking_mast."Booking_type",''1'',''Barter'',''2'',''FMG'',''3'',''Normal'',''4'',''InHouse'',''5'',''Complimentary'',''Normal'') as "BookType",
(select col_mast."Col_Alias" from col_mast where tbl_booking_mast."Color_code"=col_mast."Col_Code") as "Color",
adv_cat_mast."Adv_Cat_Name" as "Adcat",
(select adv_subcat_mast."Adv_Subcat_Name" from adv_subcat_mast where tbl_booking_mast."Ad_sub_cat_code"=adv_subcat_mast."Adv_Subcat_Code" and  adv_cat_mast."Adv_Cat_Code"=adv_subcat_mast."Adv_Cat_Code")as "Adsubcat",
(select ad_cat3."catname" from ad_cat3,adv_subcat_mast  where tbl_booking_mast."Ad_Subcat3"=ad_cat3."catcode" and ad_cat3."subcatname"=adv_subcat_mast."Adv_Subcat_Code" and tbl_booking_mast."Ad_sub_cat_code"=adv_subcat_mast."Adv_Subcat_Code" and  adv_cat_mast."Adv_Cat_Code"=adv_subcat_mast."Adv_Cat_Code") as "Adsubcat3",
(select tbl_cat4."Cat_Name" from tbl_cat4 where tbl_cat4."Cat_Code"=tbl_booking_mast."Ad_Subcat4") as Adsubcat4,
(select tbl_cat5."Cat_Name" from tbl_cat5 where tbl_cat5."Cat_Code"=tbl_booking_mast."Ad_subcat5") as Adsubcat5,
FETCH_PACK(tbl_booking_mast."cio_booking_id") AS "Package",
to_char(tbl_booking_mast."Insertion_date",'''||p_dateformat||''') as "PubDate",
tbl_booking_mast."No_of_insertion" as "noinsert",
tbl_booking_mast."Paid_ins" as "Paidinsert",
tbl_booking_mast."Ad_size_height" as "height",
 tbl_booking_mast."Ad_size_width" as "width",
tbl_booking_mast."Total_area" as "Area",
(select ADVPOS_PREM_MAST."premiumname" from advpos_prem_mast where tbl_booking_mast."Page_prem"=ADVPOS_PREM_MAST."Premiumcode") as "Pagepremium",
(select advpos_type_mast."Pos_Type" from advpos_type_mast where tbl_booking_mast."Page_position_code"=advpos_type_mast."Pos_Type_Code") as "Postprem",
(select scheme_master."Scheme_Name" from scheme_master where tbl_booking_mast."Scheme_type_code"=scheme_master."scheme_id") as "scheme",
tbl_booking_mast."Rate_code" as "Ratecode",
tbl_booking_mast."Card_rate" as "cardrate",
tbl_booking_mast."Card_amount" as "cardamt",
tbl_booking_mast."Contract_rate" as "contractrate",
TBL_BOOKING_mast."Deviation" as "Deviationamt",
TBL_BOOKING_mast."Deviation" AS "Deviation(%)",
tbl_booking_mast."Agrred_rate" as "Aggrate",
tbl_booking_mast."Agreed_amount" as "aggamt",
(tbl_booking_mast."Card_amount" - DECODE(NVL(tbl_booking_mast."Agreed_amount",0),0,tbl_booking_mast."Card_amount",tbl_booking_mast."Agreed_amount")) as "DiscAmt",
tbl_booking_mast."Discount_per" as "Discper",
(select SUM(nvl(RAT,0)) from multipack_rat where cioid=tbl_booking_mast."cio_booking_id"  and sess_id='||userenv('sessionid')||') as  "posamt",
(select SUM(nvl(PER_AMT,0)) from multipack_rat where cioid=tbl_booking_mast."cio_booking_id"   and sess_id='||userenv('sessionid')||') as "pos(%)",
round(((tbl_booking_mast."Special_disc_per" * tbl_booking_mast."Total_area" * tbl_booking_mast."Card_rate")/100),2) as "Spdiscamt",
tbl_booking_mast."Special_disc_per" as "Spdiscper",
round(((tbl_booking_mast."Space_disc_per" * tbl_booking_mast."Total_area" * tbl_booking_mast."Card_rate")/100),2) as "Spacedisc",
tbl_booking_mast."Space_disc_per" as "Spacediscper",
tbl_booking_mast."Special_charges" as "Specialcharge",
nvl(tbl_booking_mast."ADD_AGENCY_COMM",''0'') as "AgencyAddlTD(%)",
nvl((nvl(tbl_booking_mast."Gross_amount",''0'')*nvl(tbl_booking_mast."ADD_AGENCY_COMM",''0'')/100),''0'') as "AgencyAddlTDAmt",
nvl(tbl_booking_mast."Gross_amount",''0'') as "Grossamt",
(select DISTINCT TO_NUMBER(NVL("Comm_Rate",''0''))    from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",''0'')) AND ROWNUM<=1 ) as "RetTD(%)",
nvl(tbl_booking_mast."Gross_amount",''0'')*(select DISTINCT TO_NUMBER(NVL("Comm_Rate",''0''))    from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",''0'')) AND ROWNUM<=1 )/100 as "RetTDAmt",
nvl(tbl_booking_mast."Trade_disc",''0'' )as "AgencyTD(%)",
(nvl(tbl_booking_mast."Gross_amount",''0'')* nvl(tbl_booking_mast."Trade_disc",''0'' )/100 )as "AgencyTDAmt",
nvl(tbl_booking_mast."Bill_amount",''0'') as "Billamt",
nvl(case( '''||prefer||''' ) 
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",''0'')) AND ROWNUM<=1)
         when ''Gross'' then
                (
                 CASE to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM,0))
                 WHEN 0 THEN 0
                 ELSE (to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM,''0''))-to_number(nvl(tbl_booking_mast."ADD_AGENCY_COMM",''0'' )))
                 end )
         when ''Net''   then  to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM,''0''))
        END )
       
    ELSE (select 0  from dual)
end  ,''0'') as "RetComm(%)",
nvl(
case( '''||prefer||''' ) 
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",''0'')) AND ROWNUM<=1)
         when ''Gross'' then 
                 (
                 CASE to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM_AMT,0))
                 WHEN 0 THEN 0
                 ELSE (to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM_AMT,''0''))-(nvl((nvl(tbl_booking_mast."Gross_amount",''0'')*to_number(nvl(tbl_booking_mast."ADD_AGENCY_COMM",''0''))/100),''0'')))
                 end )
         
          
         when ''Net''   then  (nvl(tbl_booking_mast."Gross_amount",''0'')*(to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM,''0'')) )/100)
        END )
       
    ELSE (select 0  from dual)
end
,''0'') as "RetCommAmt",
minus_to_zero(nvl((  NVL(tbl_booking_mast."Bill_amount",''0'')-
nvl(
case( '''||prefer||''' ) 
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",''0'')) AND ROWNUM<=1)
         when ''Gross'' then 
         
                 (
                 CASE to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM_AMT,0))
                 WHEN 0 THEN 0
                 ELSE (to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM_AMT,''0''))-(nvl((nvl(tbl_booking_mast."Gross_amount",''0'')*to_number(nvl(tbl_booking_mast."ADD_AGENCY_COMM",''0''))/100),''0'')))
                 end )
                
          
         when ''Net''   then  (nvl(tbl_booking_mast."Gross_amount",''0'')*(to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM,''0'')) )/100)
        END )
       
    ELSE (select 0  from dual)
end
,''0'') ),''0'')) as "ActualBusiness",

(SELECT BRANCH_MST."Branch_Name" FROM BRANCH_MST WHERE tbl_booking_mast."Revenue_center"=BRANCH_MST."Branch_Code" )as "Revcenter",
UOM_MAST."Uom_Name"  AS "Uom",
uom_mast.UOM_DESC as "uomdesc"
,(select pub_cent_mast."Pub_Cent_name" from pub_cent_mast where pub_cent_mast."Pub_cent_Code" in(select "pub_center" from  BRANCH_MST WHERE TBL_BOOKING_MAST."branch"="Branch_Name") ) as "Printcenter"
--old version
,tbl_booking_mast."branch" as "Branch"
--new version
--,(SELECT "Branch_Name" FROM BRANCH_MST where  TBL_BOOKING_mast."branch" = "Branch_Code") as "Branch"


,case '''||p_base||'''
when ''1'' then  AGENCY_MAST."Dist_Code"
when ''2'' then (select dist_mst."Dist_Name" from dist_mst where dist_mst."Dist_Code" in(select exec_mast."dist_code" from exec_mast where  exec_mast."Exe_no"=tbl_booking_mast."Executive_code" )  )
when ''3'' then (select dist_mst."Dist_Name" from dist_mst where dist_mst."Dist_Code" in(select RETAINERMASTER."Dist_Code" from RETAINERMASTER where  RETAINERMASTER."Retain_Code"= tbl_booking_mast.RETAINER )  ) end as "District"
,case '''||p_base||'''
when ''1'' then (select taluka_mast.TALU_NAME  from taluka_mast where AGENCY_MAST.TALUKA=taluka_mast.TALU_CODE )
when ''2'' then (select taluka_mast.TALU_NAME  from taluka_mast where taluka_mast.TALU_CODE in(select exec_mast.TALUKA from exec_mast where  exec_mast."Exe_no"=tbl_booking_mast."Executive_code" )  )
when ''3'' then (select taluka_mast.TALU_NAME  from taluka_mast where taluka_mast.TALU_CODE in(select RETAINERMASTER.TALUKA from RETAINERMASTER where  RETAINERMASTER."Retain_Code"= tbl_booking_mast.RETAINER )  ) end as "Taluka"
,nvl(TBL_BOOKING_MAST."Page_no",0) as "Page_No"
,CASHDISCOUNT as "Cash_Disc"
,"Box_code" as "BoxCode"
,TBL_BOOKING_MAST."Userid" as USERID,(SELECT max("username") from login where com_code = TBL_BOOKING_MAST."Comp_code" and "userid"=TBL_BOOKING_MAST."Userid") as USERNAME
FROM TBL_BOOKING_MAST,AGENCY_MAST ,UOM_MAST,
adv_cat_mast,
adv_type_mast,
TBL_BOOKING_insert
WHERE TBL_BOOKING_MAST."Comp_code"='''||p_compcode||''' AND
 UOM_MAST."Uom_Code"=TBL_BOOKING_MAST."Uom_code" and
TBL_BOOKING_MAST."Agency_sub_code"=AGENCY_MAST."code_subcode" AND
tbl_booking_mast."Ad_cat_code"=adv_cat_mast."Adv_Cat_Code" and
tbl_booking_mast."Ad_type_code"=adv_type_mast."Adv_Type_Code"
and adv_type_mast."Adv_Type_Code"=adv_cat_mast."Adv_Type" and
tbl_booking_mast."cio_booking_id"=tbl_booking_insert."Cio_Booking_Id"
and ((tbl_booking_insert."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id='''||p_puserid||''') and '''||p_chk_access||'''=''1'')
or  ('''||p_chk_access||'''=''0'') )' ;


if(p_base='2')then
query1:=query1||' and (tbl_booking_mast."Executive_code" is not null and tbl_booking_mast."Executive_code" !=''0'')  ';
end if;

if(p_base='3')then
query1:=query1||' and (tbl_booking_mast.RETAINER is not null  and tbl_booking_mast.RETAINER !=''0'')  ';
end if;


if(p_drpstatus is null) then
query1:=query1||' and lower("Insert_Status")!='''||'cancel'||'''';
end if;

if(p_insertstatus is not null) then
query1:=query1||' and lower("Insert_Status")='''||p_insertstatus||'''';
end if;

IF(p_fromdate IS NOT NULL AND p_dateto IS NULL  and  p_filterby='Booking Date')
THEN
query1:=query1||' and tbl_booking_mast."date_time" ='''||p_fromdate||'''';
END IF;

IF(p_fromdate IS NOT NULL AND p_dateto IS NOT NULL and p_filterby='Booking Date' )
THEN
query1:=query1||' and tbl_booking_mast."date_time" between  '''||p_fromdate ||''' and  '''||p_dateto||''' ';
END IF;

IF(p_fromdate IS NOT NULL AND p_dateto IS NULL  and  p_filterby='Publish Date')
THEN
query1:=query1||' and tbl_booking_mast."Insertion_date" ='''||p_fromdate||'''';
END IF;

IF(p_fromdate IS NOT NULL AND p_dateto IS NOT NULL and p_filterby='Publish Date' )
THEN
query1:=query1||' and tbl_booking_mast."Insertion_date"  between  '''||p_fromdate ||''' and  '''||p_dateto||''' ';
END IF;

IF(p_publication IS NOT NULL)
THEN
query1:=query1||' and TBL_BOOKING_insert."Publication_Code"='''||p_publication||'''    ';
END IF;

--old version
IF(p_pub_cent IS NOT NULL)
THEN
query1:=query1||'  and TBL_BOOKING_MAST."branch" IN (SELECT "Branch_Name" FROM BRANCH_MST WHERE TBL_BOOKING_MAST."branch"="Branch_Name" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"='''||p_pub_cent||'''))';
END IF;


IF(p_branch IS NOT NULL)
THEN
query1:=query1||'  and tbl_booking_mast."branch" ='''||p_branch||'''';
END IF;


--new version
/*IF(p_pub_cent IS NOT NULL)
THEN
query1:=query1||'  and TBL_BOOKING_MAST."branch" IN (SELECT "Branch_Code" FROM BRANCH_MST WHERE TBL_BOOKING_MAST."branch"="Branch_Code" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"='''||p_pub_cent||'''))';
END IF;


IF(p_branch IS NOT NULL)
THEN
query1:=query1||'  and TBL_BOOKING_mast."branch" = (SELECT "Branch_Code" FROM BRANCH_MST where "Branch_Name" ='''||p_branch||''') ';
END IF;
*/

IF(p_edition IS NOT NULL)
THEN
query1:=query1||'  and tbl_booking_insert."Edition_Code"='''||p_edition||'''';
END IF;

IF(p_region IS NOT NULL)
THEN
query1:=query1 ||' and agency_mast."region" ='''||p_region ||''' ';
END IF;

IF(p_revcenter IS NOT NULL)
THEN
query1:=query1 ||' and tbl_booking_mast."Revenue_center" ='''||p_revcenter||'''';
END IF;

IF(p_adtype IS NOT NULL)
THEN
query1:=query1 || ' and TBL_BOOKING_MAST."Ad_type_code"='''||p_adtype||'''';
END IF;

IF(p_agencytype IS NOT NULL)
THEN
query1:=query1 || ' and TBL_BOOKING_MAST."Agency_type" ='''||p_agencytype||'''';
END IF;

IF(p_adcat IS NOT NULL)
THEN
query1:=query1 || ' and TBL_BOOKING_MAST."Ad_cat_code" ='''||p_adcat||'''';
END IF;

IF(p_adsubcat IS NOT NULL)
THEN
query1:=query1 || ' and TBL_BOOKING_MAST."Ad_sub_cat_code" ='''||p_adsubcat||'''';
END IF;

IF(p_adsubcat3 IS NOT NULL)
THEN
query1:=query1 || ' and TBL_BOOKING_MAST."Ad_Subcat3" ='''||p_adsubcat3||'''';
END IF;

IF(p_adsubcat4 IS NOT NULL)
THEN
query1:=query1 || ' and TBL_BOOKING_MAST."Ad_Subcat4" ='''||p_adsubcat4||'''';
END IF;

IF(p_adsubcat5 IS NOT NULL)
THEN
query1:=query1 || ' and TBL_BOOKING_MAST."Ad_subcat5" ='''||p_adsubcat5||'''';
END IF;

IF(p_package IS NOT NULL)
THEN
query1:=query1 || ' and TBL_BOOKING_MAST."Package_code" ='''||p_package||'''';
END IF;

IF(p_scheme IS NOT NULL)
THEN
query1:=query1 || ' and TBL_BOOKING_MAST."Scheme_type_code" ='''||p_scheme||'''';
END IF;

IF(p_agency IS NOT NULL)
THEN
query1:=query1 || ' and TBL_BOOKING_MAST."Agency_code" ='''||p_agency||'''';
END IF;

IF(p_client IS NOT NULL)
THEN
query1:=query1 || ' and TBL_BOOKING_MAST."Client_code" ='''||p_client||'''';
END IF;

IF(p_executive IS NOT NULL)
THEN
query1:=query1 || ' and TBL_BOOKING_MAST."Executive_code" ='''||p_executive||'''';
END IF;

IF(p_retainer IS NOT NULL)
THEN
query1:=query1 || ' and TBL_BOOKING_MAST.RETAINER ='''||p_retainer||'''';
END IF;

IF(p_product IS NOT NULL)
THEN
query1:=query1 || ' and TBL_BOOKING_MAST."Product_code" ='''||p_product||'''';
END IF;

IF(p_brand IS NOT NULL)
THEN
query1:=query1 || ' and TBL_BOOKING_MAST."Brand_code" ='''||p_brand||'''';
END IF;

IF(p_varient IS NOT NULL)
THEN
query1:=query1 || ' and TBL_BOOKING_MAST."Variant_code" ='''||p_varient||'''';
END IF;

IF(p_pagetype IS NOT NULL)
THEN
query1:=query1 || ' and TBL_BOOKING_MAST."Page_type_code" ='''||p_pagetype||'''';
END IF;

IF(p_pageprem IS NOT NULL)
THEN
query1:=query1 || ' and TBL_BOOKING_MAST."Page_prem" ='''||p_pageprem||'''';
END IF;

IF(p_postprem IS NOT NULL)
THEN
query1:=query1 || ' and TBL_BOOKING_MAST."Page_position_code" ='''||p_postprem||'''';
END IF;

IF(p_rostatus IS NOT NULL)
THEN
query1:=query1 || ' and TBL_BOOKING_MAST."ro_status" ='''||p_rostatus||'''';
END IF;

IF(p_booktype IS NOT NULL)
THEN
query1:=query1 || ' and TBL_BOOKING_MAST."Booking_type" ='''||p_booktype||'''';
END IF;

IF(p_contractname  IS NOT NULL)
THEN
query1:=query1 || ' and TBL_BOOKING_MAST."Contract_name" ='''||p_contractname ||'''';
END IF;

IF(p_suppliment  IS NOT NULL)
THEN
query1:=query1 || ' and tbl_booking_insert."Supp_Code" ='''||p_suppliment||'''';
END IF;

IF(p_ratetype  IS NOT NULL)
THEN
query1:=query1 || ' and tbl_booking_MAST."Rate_code" ='''||p_ratetype||'''';
END IF;

if (p_baxcode is not null) then
query1:=query1 || ' and tbl_booking_mast."Box_code" = '''||p_baxcode||'''';
end if;

IF(p_city  IS NOT NULL)
THEN
if(p_base='1')then
query1:=query1 || ' and AGENCY_MAST."City_Code" ='''||p_city||'''';
end if;

if(p_base='2')then
query1:=query1 || ' and tbl_booking_mast."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" ='''||p_city||''' )';
end if;

if(p_base='3')then
query1:=query1 || ' and tbl_booking_mast.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."City_Code"='''||p_city||''')';
end if;
END IF;

IF(p_zone  IS NOT NULL)
THEN
if(p_base='1')then
query1:=query1 || ' and AGENCY_MAST."zone_code" ='''||p_zone||'''';
end if;

if(p_base='2')then
query1:=query1 || ' and tbl_booking_mast."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" in (select city_mst."City_Code" from city_mst where city_mst."Zone_Code"= '''||p_zone||''') )';
end if;

if(p_base='3')then
query1:=query1 || ' and tbl_booking_mast.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Zone_Code"='''||p_zone||''')';
end if;
END IF;

IF(p_district  IS NOT NULL)
THEN
if(p_base='1')then
query1:=query1 || ' and AGENCY_MAST."Dist_Code" ='''||p_district||'''';
end if;

if(p_base='2')then
query1:=query1 || ' and tbl_booking_mast."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."dist_code" ='''||p_district||''' )';
end if;

if(p_base='3')then
query1:=query1 || ' and tbl_booking_mast.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Dist_Code"='''||p_district||''')';
end if;
END IF;

IF(p_state  IS NOT NULL)
THEN
if(p_base='1')then
query1:=query1 || ' and AGENCY_MAST."State_Code" ='''||p_state||'''';
end if;

if(p_base='2')then
query1:=query1 || ' and tbl_booking_mast."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."State_code" ='''||p_state||''' )';
end if;

if(p_base='3')then
query1:=query1 || ' and tbl_booking_mast.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."State_Code"='''||p_state||''')';
end if;
END IF;

IF(p_taluka  IS NOT NULL)
THEN
if(p_base='1')then
query1:=query1 || ' and AGENCY_MAST.TALUKA='''||p_taluka||'''  ';
end if;

if(p_base='2')then
query1:=query1 || ' and tbl_booking_mast."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast.TALUKA ='''||p_taluka||''' )';
end if;

if(p_base='3')then
query1:=query1 || ' and tbl_booking_mast.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER.TALUKA='''||p_taluka||''')';
end if;
END IF;

query1:=query1 || ' order by TBL_BOOKING_MAST."cio_booking_id"';


insert into searchtbl values(query1);
commit;
OPEN p_recordset1 FOR
query1;


elsif(p_adcheck=2)then
delete from temp_ad_bills_report where sess_id=userenv('sessionid')  ;
open c2;
loop
fetch c2 into v2;
exit when c2%notfound;
--insert into test_amit(a,b)values('amit-',v2.BILLNO);commit;

         v_val:=FUN_BILL_INSERT(p_compcode,v2.CIOID,v2.BILLNO,prefer,p_dateformat,v2.AGMAINCODE,v2.AG_SUB_CODE,v2.AGCODE,v2.AGNAME,v2.EXECCODE,v2.EXECNAME,v2.RETCODE,v2.RETNAME,p_base );    
end loop;
close c2;
commit;

query2:=query2 || 'select CIOID AS "CIOID",BILLNO AS "Billno" ,AGENCY AS "Agency", CLIENT AS "Client" ,
RONO  AS "RoNo.",
CASE '''||p_dateformat||'''
WHEN ''mm/dd/yyyy'' THEN TO_CHAR(RODATE ,''mm/dd/yyyy'')
WHEN ''dd/mm/yyyy'' THEN TO_CHAR(RODATE ,''dd/mm/yyyy'')
WHEN ''yyyy/mm/dd'' THEN TO_CHAR(RODATE,''yyyy/mm/dd'') END AS "Ro.Date",
EXECUTIVE  AS "Executive",RETAINER  AS "Retainer" ,BOOKTYPE as "BookType",COLOR as "Color",ADCAT as "Adcat",
ADSUBCAT as "Adsubcat",ADSUBCAT3 as "Adsubcat3",ADSUBCAT4  as "Adsubcat4",ADSUBCAT5 as "Adsubcat5",PACKAG AS "Package",
to_char(BILLDATE,'''||p_dateformat||''') as "BillDate",
NOINSERT as "noinsert",PAIDINSERT as "Paidinsert" ,HEIGHT as "height",WIDTH as "width",AREA as "Area",PAGEPREMIUM as "Pagepremium",POSTPREM as "Postprem",
SCHEME as "scheme",RATECOD as "Ratecode",CARDRATE as "cardrate",CARDAMT as "cardamt",
CONTRACTRATE as "contractrate",DEVIATIONAMT as "Deviationamt",DEVIATIONPER AS "Deviation(%)",
AGGRATE as "Aggrate",AGGAMT as "aggamt",DISCAMT as "DiscAmt",DISCPER as "Discper",
POSAMT as  "posamt",POSPER as "pos(%)",SPDISCAMT as "Spdiscamt",
SPDISCPER as "Spdiscper",SPACEDISC as "Spacedisc",SPACEDISCPER as "Spacediscper",SPECIALCHARGE as "Specialcharge",AGENCYADDLTDPER  as "AgencyAddlTD(%)",
AGENCYADDLTDAMT as "AgencyAddlTDAmt",GROSSAMT as "Grossamt",
RETTDPER as "RetTD(%)",RETTDAMT as "RetTDAmt",AGENCYTDPER as "AgencyTD(%)",AGENCYTDAMT as "AgencyTDAmt",BILLAMT as "Billamt",
RETCOMMPER as "RetComm(%)",RETCOMMAMT as "RetCommAmt",minus_to_zero(ACTUALBUSINESS) as "ActualBusiness",
REVCENTER as "Revcenter",UOM AS "Uom",UOMDESC as "uomdesc"
,PUB_CENT_NAME as "Printcenter"
,BRANCH_NAME  as "Branch"
,DIST_NAME as "District"
,TALU_NAME as "Taluka"
,PAGE_NO as "Page_No"
from temp_ad_bills_report where sess_id='||userenv('sessionid');

IF(p_fromdate IS NOT NULL AND p_dateto IS NOT NULL )
THEN
query2:=query2||' and BILLDATE between  '''||p_fromdate ||''' and  '''||p_dateto||''' ';
END IF;

IF(p_publication IS NOT NULL)
THEN
query2:=query2||' and PRIPUB='''||p_publication||'''';
END IF;

IF(p_pub_cent IS NOT NULL)
THEN
query2:=query2||'   and PUB_CENT_CODE='''||p_pub_cent||'''';
END IF;

IF(p_edition IS NOT NULL)
THEN
query2:=query2||'  and PEDITION='''||p_edition||'''';
END IF;

IF(p_branch IS NOT NULL)
THEN
query2:=query2||'  and  BRANCH_NAME ='''||p_branch||''' ';
END IF;

IF(p_region IS NOT NULL)
THEN
query2:=query2 ||' and REGION='''||p_region ||'''';
END IF;

IF(p_adtype IS NOT NULL)
THEN
query2:=query2 || ' and PADTYPE='''||p_adtype||'''';
END IF;

IF(p_agencytype IS NOT NULL)
THEN
query2:=query2 || ' and AGENCY_TYPE_CODE= '''||p_agencytype||'''';
END IF;

IF(p_adcat IS NOT NULL)
THEN
query2:=query2 || ' and PRIADCTG='''||p_adcat||'''';
END IF;

IF(p_adsubcat IS NOT NULL)
THEN
query2:=query2 || ' and SECADCTG ='''||p_adsubcat||'''';
END IF;

IF(p_adsubcat3 IS NOT NULL)
THEN
query2:=query2 || ' and AD_SUBCAT3 ='''||p_adsubcat3||'''';
END IF;

IF(p_adsubcat4 IS NOT NULL)
THEN
query2:=query2 || ' and AD_SUBCAT4 ='''||p_adsubcat4||'''';
END IF;

IF(p_adsubcat5 IS NOT NULL)
THEN
query2:=query2 || ' and AD_SUBCAT5 ='''||p_adsubcat5||'''';
END IF;

IF(p_package IS NOT NULL)
THEN
query2:=query2 || ' and PACKAGE_CODE='''||p_package||'''';
END IF;

IF(p_agency IS NOT NULL)
THEN
query2:=query2 || ' and AG_MAIN_CODE ='''||p_agency ||'''';
END IF;

IF(p_client IS NOT NULL)
THEN
query2:=query2 || ' and CLIENTCD='''||p_client ||'''';
END IF;

IF(p_executive IS NOT NULL)
THEN
query2:=query2 || ' and EXECUTIVE_NAME='''||p_executive||'''';
END IF;

IF(p_product IS NOT NULL)
THEN
query2:=query2 || ' and PRIPROCTG='''||p_product||'''';
END IF;

IF(p_brand IS NOT NULL)
THEN
query2:=query2 || ' and BRAND_CODE='''||p_brand||'''';
END IF;

IF(p_varient IS NOT NULL)
THEN
query2:=query2 || ' and   VARIENT_NAME='''||p_varient||'''';
END IF;

IF(p_pageprem IS NOT NULL)
THEN
query2:=query2 || ' and PAGE_PREM ='''||p_pageprem||'''';
END IF;

IF(p_postprem IS NOT NULL)
THEN
query2:=query2 || ' and PAGE_POST ='''||p_postprem||'''';
END IF;

IF(p_contractname  IS NOT NULL)
THEN
query2:=query2 || ' and CONTRACT_NAME ='''||p_contractname ||'''';
END IF;

IF(p_suppliment  IS NOT NULL)
THEN
query2:=query2 || ' and SUPP_CODE='''||p_suppliment||'''';
END IF;

IF(p_retainer IS NOT NULL)
THEN
query2:=query2 || ' and RETAINER_CODE='''||p_retainer||'''';
END IF;

IF(p_ratetype  IS NOT NULL)
THEN
query2:=query2 || ' and RATECD ='''||p_ratetype||'''';
END IF;

IF(p_scheme IS NOT NULL)
THEN
query2:=query2 || ' and PSCHEME='''||p_scheme||'''';
END IF;

IF(p_revcenter IS NOT NULL)
THEN
query2:=query2 ||' and REVENUE_CENTER='''||p_revcenter||'''';
END IF;

IF(p_rostatus IS NOT NULL)
THEN
query2:=query2 || ' and RO_STATUS='''||p_rostatus||'''';
END IF;

IF(p_pagetype IS NOT NULL)
THEN
query2:=query2 || ' and PAGE_TYPE ='''||p_pagetype||'''';
END IF;

IF(p_booktype IS NOT NULL)
THEN
query2:=query2 || ' and BOOKING_TYPE='''||p_booktype||'''';
END IF;

IF(p_city  IS NOT NULL)
THEN
query2:=query2 || ' and CITY_CODE ='''||p_city||'''';
END IF;

IF(p_zone  IS NOT NULL)
THEN
query2:=query2 || ' and ZONE_CODE ='''||p_zone||'''';
end if;

IF(p_district  IS NOT NULL)
THEN
query2:=query2 || ' and DIST_CODE ='''||p_district||'''';
end if;

IF(p_state  IS NOT NULL)
THEN
query2:=query2 || ' and STATE_CODE ='''||p_state||'''';
end if;

IF(p_taluka  IS NOT NULL)
THEN
query2:=query2 || ' and PTALUKA='''||p_taluka||'''  ';
end if;


if(p_base='2')then
query2:=query2 ||' and (EXECUTIVE_NAME   is not null and EXECUTIVE_NAME !=''0'')  ';
end if;

if(p_base='3')then
query2:=query2 ||' and (RETAINER_CODE  is not null  and RETAINER_CODE  !=''0'')  ';
end if;



query2:=query2 || ' order by CIOID';

--delete from searchtbl;
--insert into searchtbl values(query2);
--commit;

OPEN p_recordset1 FOR 
query2;

elsif(p_adcheck=3) then
query3:=query3 ||'SELECT  TBL_BOOKING_MAST."cio_booking_id" AS "CIOID",
to_char(TBL_BOOKING_MAST."date_time",'''||p_dateformat||''') as "BookDate",
AGENCY_MAST."Agency_Name" AS "Agency",
NVL((SELECT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code"="Client_code"),"Client_code")  AS "Client",
"RO_No" AS "RoNo.",
CASE '''||p_dateformat||'''
WHEN ''mm/dd/yyyy'' THEN TO_CHAR("RO_Date",''mm/dd/yyyy'')
WHEN ''dd/mm/yyyy'' THEN TO_CHAR("RO_Date" ,''dd/mm/yyyy'')
WHEN ''yyyy/mm/dd'' THEN TO_CHAR("RO_Date",''yyyy/mm/dd'') END AS "Ro.Date",
(select EXEC_MAST."Exec_name" from exec_mast where tbl_booking_mast."Executive_code"=exec_mast."Exe_no") AS "Executive",
(select RETAINERMASTER."Retain_Name"  FROM  RETAINERMASTER where RETAINERMASTER."Retain_Code"=tbl_booking_mast.RETAINER ) AS "Retainer",
decode(tbl_booking_mast."Booking_type",''1'',''Barter'',''2'',''FMG'',''3'',''Normal'',''4'',''InHouse'',''5'',''Complimentary'',''Normal'') as "BookType",
(select col_mast."Col_Alias" from col_mast where tbl_booking_insert."Col_Code" =col_mast."Col_Code") as "Color",
adv_cat_mast."Adv_Cat_Name" as "Adcat",
(select adv_subcat_mast."Adv_Subcat_Name" from adv_subcat_mast where tbl_booking_mast."Ad_sub_cat_code"=adv_subcat_mast."Adv_Subcat_Code" and  adv_cat_mast."Adv_Cat_Code"=adv_subcat_mast."Adv_Cat_Code")as "Adsubcat",
(select ad_cat3."catname" from ad_cat3,adv_subcat_mast  where tbl_booking_mast."Ad_Subcat3"=ad_cat3."catcode" and ad_cat3."subcatname"=adv_subcat_mast."Adv_Subcat_Code" and tbl_booking_mast."Ad_sub_cat_code"=adv_subcat_mast."Adv_Subcat_Code" and  adv_cat_mast."Adv_Cat_Code"=adv_subcat_mast."Adv_Cat_Code") as "Adsubcat3",
(select tbl_cat4."Cat_Name" from tbl_cat4 where tbl_cat4."Cat_Code"=tbl_booking_mast."Ad_Subcat4") as Adsubcat4,
(select tbl_cat5."Cat_Name" from tbl_cat5 where tbl_cat5."Cat_Code"=tbl_booking_mast."Ad_subcat5") as Adsubcat5,
FETCH_PACK(tbl_booking_mast."cio_booking_id") AS "Package",
to_char(tbl_booking_insert."Insert_Date" ,'''||p_dateformat||''') as "PubDate",
 tbl_booking_insert."Height" as "height",
 tbl_booking_insert."Width"  as "width",
tbl_booking_insert."Size_Book" as "Area",
(select ADVPOS_PREM_MAST."premiumname" from advpos_prem_mast where tbl_booking_insert."Premium1" =ADVPOS_PREM_MAST."Premiumcode") as "Pagepremium",
(select advpos_type_mast."Pos_Type" from advpos_type_mast where tbl_booking_insert."Page_Post" =advpos_type_mast."Pos_Type_Code") as "Postprem",
(select scheme_master."Scheme_Name" from scheme_master where tbl_booking_mast."Scheme_type_code"=scheme_master."scheme_id") as "scheme",
tbl_booking_mast."Rate_code" as "Ratecode",
tbl_booking_mast."Card_rate" as "cardrate",
tbl_booking_mast."Card_rate"*tbl_booking_insert."Size_Book" as "cardamt",
tbl_booking_mast."Contract_rate" as "contractrate",
TBL_BOOKING_mast."Deviation" as "Deviationamt",
TBL_BOOKING_mast."Deviation" AS "Deviation(%)",
tbl_booking_mast."Agrred_rate" as "Aggrate",
tbl_booking_insert."Agreed_Rate"  as "aggamt",
((tbl_booking_mast."Card_rate"*tbl_booking_insert."Size_Book") - DECODE(NVL(tbl_booking_insert."Agreed_Rate",0),0,(tbl_booking_mast."Card_rate"*tbl_booking_insert."Size_Book"),tbl_booking_insert."Agreed_Rate")) as "DiscAmt",
tbl_booking_mast."Discount_per" as "Discper",
(select SUM(nvl(RAT,0)) from multipack_rat where cioid=tbl_booking_mast."cio_booking_id"  and sess_id='||userenv('sessionid')||') as  "posamt",
(select SUM(nvl(PER_AMT,0)) from multipack_rat where cioid=tbl_booking_mast."cio_booking_id"   and sess_id='||userenv('sessionid')||') as "pos(%)",
round(((tbl_booking_mast."Special_disc_per" * tbl_booking_insert."Size_Book" * tbl_booking_mast."Card_rate")/100),2) as "Spdiscamt",
tbl_booking_mast."Special_disc_per" as "Spdiscper",
round(((tbl_booking_mast."Space_disc_per" * tbl_booking_insert."Size_Book" * tbl_booking_mast."Card_rate")/100),2) as "Spacedisc",
tbl_booking_mast."Space_disc_per" as "Spacediscper",
tbl_booking_mast."Special_charges" as "Specialcharge",
nvl(tbl_booking_mast."ADD_AGENCY_COMM",''0'') as "AgencyAddlTD(%)",
nvl((nvl(tbl_booking_insert."Gross_Rate" ,''0'')*nvl(tbl_booking_mast."ADD_AGENCY_COMM",''0'')/100),''0'') as "AgencyAddlTDAmt",
nvl(tbl_booking_insert."Gross_Rate",''0'') as "Grossamt",
(select DISTINCT TO_NUMBER(NVL("Comm_Rate",''0''))    from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",''0'')) AND ROWNUM<=1 ) as "RetTD(%)",
nvl(tbl_booking_insert."Gross_Rate",''0'')*(select DISTINCT TO_NUMBER(NVL("Comm_Rate",''0''))    from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",''0'')) AND ROWNUM<=1 )/100 as "RetTDAmt",
nvl(tbl_booking_mast."Trade_disc",''0'' )as "AgencyTD(%)",
(nvl(tbl_booking_insert."Gross_Rate",''0'')* nvl(tbl_booking_mast."Trade_disc",''0'' )/100 )as "AgencyTDAmt",
NVL(TBL_BOOKING_INSERT."Bill_Amt",''0'') as "Billamt",
nvl(case( '''||prefer||''' ) 
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",''0'')) AND ROWNUM<=1)
         when ''Gross'' then 
         
               (
                 CASE to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM,0))
                 WHEN 0 THEN 0
                 ELSE (to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM,''0''))-to_number(nvl(tbl_booking_mast."ADD_AGENCY_COMM",''0'') ))
                end  )
         
         
         when ''Net''   then  to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM,''0''))
        END )
       
    ELSE (select 0  from dual)
end  ,''0'') as "RetComm(%)",

nvl(
case( '''||prefer||''' ) 
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",''0'')) AND ROWNUM<=1)
         when ''Gross'' then 
         
        
               
                (
                 CASE to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM_AMT,0))
                 WHEN 0 THEN 0
               -- ELSE (to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM_AMT,''0''))-(nvl((nvl(tbl_booking_insert."Gross_Rate",''0'')*to_number(nvl(tbl_booking_mast."ADD_AGENCY_COMM",''0''))/100),''0'')))
                else (nvl(tbl_booking_insert."Gross_Rate",0)*(to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM,''0''))-to_number(nvl(tbl_booking_mast."ADD_AGENCY_COMM",''0'')) )/100)
                 end )
         
         
          
         when ''Net''   then  (nvl(tbl_booking_insert."Gross_Rate",''0'')*(to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM,''0'')) )/100)
        END )
       
    ELSE (select 0  from dual)
end
,''0'') as "RetCommAmt",


minus_to_zero(nvl((  NVL(TBL_BOOKING_INSERT."Bill_Amt",''0'')-
nvl(
case( '''||prefer||''' ) 
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",''0'')) AND ROWNUM<=1)
         when ''Gross'' then 
           (
                 CASE to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM_AMT,0))
                 WHEN 0 THEN 0
                -- ELSE (to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM_AMT,''0''))-(nvl((nvl(tbl_booking_insert."Gross_Rate",''0'')*to_number(nvl(tbl_booking_mast."ADD_AGENCY_COMM",''0''))/100),''0'')))
                 else (nvl(tbl_booking_insert."Gross_Rate",0)*(to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM,''0''))-to_number(nvl(tbl_booking_mast."ADD_AGENCY_COMM",''0'')) )/100)
               
                 end )
          
         when ''Net''   then  (nvl(tbl_booking_insert."Gross_Rate",''0'')*(to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM,''0'')) )/100)
        END )
       
    
    
    ELSE (select 0  from dual)
end
,''0'') ),''0'')) as "ActualBusiness",
(SELECT BRANCH_MST."Branch_Name" FROM BRANCH_MST WHERE tbl_booking_mast."Revenue_center"=BRANCH_MST."Branch_Code" )as "Revcenter"
,UOM_MAST."Uom_Name"  AS "Uom",
pub_mast."Pub_Name" as "Publication",
TBL_BOOKING_INSERT."Edition" as "Edition",
uom_mast.UOM_DESC as "uomdesc"
,(select pub_cent_mast."Pub_Cent_name" from pub_cent_mast where pub_cent_mast."Pub_cent_Code" in(select "pub_center" from  BRANCH_MST WHERE TBL_BOOKING_MAST."branch"="Branch_Name") ) as "Printcenter"
--old version
,tbl_booking_mast."branch" as "Branch"
--new version
--,(SELECT "Branch_Name" FROM BRANCH_MST where  TBL_BOOKING_mast."branch" = "Branch_Code") as "Branch"

,case '''||p_base||'''
when ''1'' then  AGENCY_MAST."Dist_Code"
when ''2'' then (select dist_mst."Dist_Name" from dist_mst where dist_mst."Dist_Code" in(select exec_mast."dist_code" from exec_mast where  exec_mast."Exe_no"=tbl_booking_mast."Executive_code" )  )
when ''3'' then (select dist_mst."Dist_Name" from dist_mst where dist_mst."Dist_Code" in(select RETAINERMASTER."Dist_Code" from RETAINERMASTER where  RETAINERMASTER."Retain_Code"= tbl_booking_mast.RETAINER )  ) end as "District"
,case '''||p_base||'''
when ''1'' then (select taluka_mast.TALU_NAME  from taluka_mast where AGENCY_MAST.TALUKA=taluka_mast.TALU_CODE )
when ''2'' then (select taluka_mast.TALU_NAME  from taluka_mast where taluka_mast.TALU_CODE in(select exec_mast.TALUKA from exec_mast where  exec_mast."Exe_no"=tbl_booking_mast."Executive_code" )  )
when ''3'' then (select taluka_mast.TALU_NAME  from taluka_mast where taluka_mast.TALU_CODE in(select RETAINERMASTER.TALUKA from RETAINERMASTER where  RETAINERMASTER."Retain_Code"= tbl_booking_mast.RETAINER )  ) end as "Taluka"
,tbl_booking_insert."Page_No" as "Page_No"
,CASHDISCOUNT as "Cash_Disc"
,"Insert_Status" as "Status"
,"Box_code" as "BoxCode",TBL_BOOKING_MAST."Userid" as USERID,(SELECT max("username") from login where com_code = TBL_BOOKING_MAST."Comp_code" and "userid"=TBL_BOOKING_MAST."Userid") as USERNAME
FROM TBL_BOOKING_MAST,AGENCY_MAST ,uom_mast,
adv_cat_mast,
adv_type_mast,pub_mast,
TBL_BOOKING_insert
WHERE TBL_BOOKING_MAST."Comp_code"='''||p_compcode||''' AND
UOM_MAST."Uom_Code"=TBL_BOOKING_MAST."Uom_code" and
TBL_BOOKING_MAST."Agency_sub_code"=AGENCY_MAST."code_subcode" AND
tbl_booking_insert."Ad_Cat" =adv_cat_mast."Adv_Cat_Code" and
tbl_booking_mast."Ad_type_code"=adv_type_mast."Adv_Type_Code"
and adv_type_mast."Adv_Type_Code"=adv_cat_mast."Adv_Type" and
pub_mast."Pub_Code"=TBL_BOOKING_insert."Publication_Code" and
tbl_booking_mast."cio_booking_id"=tbl_booking_insert."Cio_Booking_Id" 
and ((tbl_booking_insert."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id='''||p_puserid||''') and '''||p_chk_access||'''=''1'')
or  ('''||p_chk_access||'''=''0'') )' ;

if(p_base='2')then
query3:=query3 ||' and (tbl_booking_mast."Executive_code" is not null and tbl_booking_mast."Executive_code" !=''0'')  ';
end if;

if(p_base='3')then
query3:=query3 ||' and (tbl_booking_mast.RETAINER is not null  and tbl_booking_mast.RETAINER !=''0'')  ';
end if;


if(p_drpstatus is null) then
query3:=query3||' and lower("Insert_Status")!='''||'cancel'||'''';
end if;


if(p_insertstatus is not null) then
query3:=query3||' and lower("Insert_Status")='''||p_insertstatus||'''';
end if;


IF(p_fromdate IS NOT NULL AND p_dateto IS NULL )
THEN
query3:=query3 ||' and tbl_booking_insert."Insert_Date" ='''||p_fromdate||'''';
END IF;

IF(p_fromdate IS NOT NULL AND p_dateto IS NOT NULL)
THEN
query3:=query3 ||' and tbl_booking_insert."Insert_Date" between  '''||p_fromdate ||''' and  '''||p_dateto||''' ';
END IF;

IF(p_publication IS NOT NULL)
THEN
query3:=query3 ||' and TBL_BOOKING_insert."Publication_Code"='''||p_publication||'''    ';
END IF;

--old version
IF(p_pub_cent IS NOT NULL)
THEN
query3:=query3||'  and TBL_BOOKING_MAST."branch" IN (SELECT "Branch_Name" FROM BRANCH_MST WHERE TBL_BOOKING_MAST."branch"="Branch_Name" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"='''||p_pub_cent||'''))';
END IF;

IF(p_branch IS NOT NULL)
THEN
query3:=query3 ||'  and tbl_booking_mast."branch" ='''||p_branch||'''';
END IF;

if (p_baxcode is not null) then
query3:=query3 || ' and tbl_booking_mast."Box_code" = '''||p_baxcode||'''';
end if;

--new version
/*
IF(p_pub_cent IS NOT NULL)
THEN
query3:=query3||'  and TBL_BOOKING_MAST."branch" IN (SELECT "Branch_Code" FROM BRANCH_MST WHERE TBL_BOOKING_MAST."branch"="Branch_Code" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"='''||p_pub_cent||'''))';
END IF;


IF(p_branch IS NOT NULL)
THEN
query3:=query3||'  and TBL_BOOKING_mast."branch" = (SELECT "Branch_Code" FROM BRANCH_MST where "Branch_Name" ='''||p_branch||''') ';
END IF;
*/
IF(p_edition IS NOT NULL)
THEN
query3:=query3 ||'  and tbl_booking_insert."Edition_Code"='''||p_edition||'''';
END IF;
IF(p_region IS NOT NULL)
THEN
query3:=query3  ||' and agency_mast."region" ='''||p_region||'''';
END IF;

IF(p_revcenter IS NOT NULL)
THEN
query3:=query3  ||' and tbl_booking_mast."Revenue_center" ='''||p_revcenter||'''';
END IF;

IF(p_adtype IS NOT NULL)
THEN
query3:=query3  || ' and TBL_BOOKING_MAST."Ad_type_code"='''||p_adtype||'''';
END IF;

IF(p_agencytype IS NOT NULL)
THEN
query3:=query3  || ' and TBL_BOOKING_MAST."Agency_type" ='''||p_agencytype||'''';
END IF;

IF(p_adcat IS NOT NULL)
THEN
query3:=query3  || ' and TBL_BOOKING_insert."Ad_Cat" ='''||p_adcat||'''';
END IF;

IF(p_adsubcat IS NOT NULL)
THEN
query3:=query3  || ' and TBL_BOOKING_MAST."Ad_sub_cat_code" ='''||p_adsubcat||'''';
END IF;

IF(p_adsubcat3 IS NOT NULL)
THEN
query3:=query3  || ' and TBL_BOOKING_MAST."Ad_Subcat3" ='''||p_adsubcat3||'''';
END IF;

IF(p_adsubcat4 IS NOT NULL)
THEN
query3:=query3  || ' and TBL_BOOKING_MAST."Ad_Subcat4" ='''||p_adsubcat4||'''';
END IF;

IF(p_adsubcat5 IS NOT NULL)
THEN
query3:=query3  || ' and TBL_BOOKING_MAST."Ad_subcat5" ='''||p_adsubcat5||'''';
END IF;

IF(p_package IS NOT NULL)
THEN
query3:=query3  || ' and TBL_BOOKING_MAST."Package_code" ='''||p_package||'''';
END IF;

IF(p_scheme IS NOT NULL)
THEN
query3:=query3  || ' and TBL_BOOKING_MAST."Scheme_type_code" ='''||p_scheme||'''';
END IF;

IF(p_agency IS NOT NULL)
THEN
query3:=query3  || ' and TBL_BOOKING_MAST."Agency_code" ='''||p_agency||'''';
END IF;

IF(p_client IS NOT NULL)
THEN
query3:=query3  || ' and TBL_BOOKING_MAST."Client_code" ='''||p_client||'''';
END IF;

IF(p_executive IS NOT NULL)
THEN
query3:=query3  || ' and TBL_BOOKING_MAST."Executive_code" ='''||p_executive||'''';
END IF;

IF(p_retainer IS NOT NULL)
THEN
query3:=query3  || ' and TBL_BOOKING_MAST.RETAINER ='''||p_retainer||'''';
END IF;

IF(p_product IS NOT NULL)
THEN
query3:=query3 || ' and TBL_BOOKING_MAST."Product_code" ='''||p_product||'''';
END IF;

IF(p_brand IS NOT NULL)
THEN
query3:=query3  || ' and TBL_BOOKING_MAST."Brand_code" ='''||p_brand||'''';
END IF;

IF(p_varient IS NOT NULL)
THEN
query3:=query3  || ' and TBL_BOOKING_MAST."Variant_code" ='''||p_varient||'''';
END IF;

IF(p_pagetype IS NOT NULL)
THEN
query3:=query3  || ' and TBL_BOOKING_MAST."Page_type_code" ='''||p_pagetype||'''';
END IF;

IF(p_pageprem IS NOT NULL)
THEN
query3:=query3 || ' and TBL_BOOKING_insert."Premium1" ='''||p_pageprem||'''';
END IF;

IF(p_postprem IS NOT NULL)
THEN
query3:=query3 || ' and TBL_BOOKING_insert."Page_Post" ='''||p_postprem||'''';
END IF;

IF(p_rostatus IS NOT NULL)
THEN
query3:=query3 || ' and TBL_BOOKING_MAST."ro_status" ='''||p_rostatus||'''';
END IF;

IF(p_booktype IS NOT NULL)
THEN
query3:=query3 || ' and TBL_BOOKING_MAST."Booking_type" ='''||p_booktype||'''';
END IF;

IF(p_contractname  IS NOT NULL)
THEN
query3:=query3 || ' and TBL_BOOKING_MAST."Contract_name" ='''||p_contractname ||'''';
END IF;

IF(p_suppliment  IS NOT NULL)
THEN
query3:=query3 || ' and tbl_booking_insert."Supp_Code" ='''||p_suppliment||'''';
END IF;

IF(p_ratetype  IS NOT NULL)
THEN
query3:=query3 || ' and tbl_booking_MAST."Rate_code" ='''||p_ratetype||'''';
END IF;

IF(p_city  IS NOT NULL)
THEN
if(p_base='1')then
query3:=query3 || ' and AGENCY_MAST."City_Code" ='''||p_city||'''';
end if;

if(p_base='2')then
query3:=query3 || ' and tbl_booking_mast."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" ='''||p_city||''' )';
end if;

if(p_base='3')then
query3:=query3 || ' and tbl_booking_mast.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."City_Code"='''||p_city||''')';
end if;
END IF;

IF(p_zone  IS NOT NULL)
THEN
if(p_base='1')then
query3:=query3 || ' and AGENCY_MAST."zone_code" ='''||p_zone||'''';
end if;

if(p_base='2')then
query3:=query3 || ' and tbl_booking_mast."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" in (select city_mst."City_Code" from city_mst where city_mst."Zone_Code"= '''||p_zone||''') )';
end if;

if(p_base='3')then
query3:=query3 || ' and tbl_booking_mast.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Zone_Code"='''||p_zone||''')';
end if;
END IF;

IF(p_district  IS NOT NULL)
THEN
if(p_base='1')then
query3:=query3 || ' and AGENCY_MAST."Dist_Code" ='''||p_district||'''';
end if;

if(p_base='2')then
query3:=query3 || ' and tbl_booking_mast."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."dist_code" ='''||p_district||''' )';
end if;

if(p_base='3')then
query3:=query3 || ' and tbl_booking_mast.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Dist_Code"='''||p_district||''')';
end if;
END IF;

IF(p_state  IS NOT NULL)
THEN
if(p_base='1')then
query3:=query3 || ' and AGENCY_MAST."State_Code" ='''||p_state||'''';
end if;

if(p_base='2')then
query3:=query3 || ' and tbl_booking_mast."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."State_code" ='''||p_state||''' )';
end if;

if(p_base='3')then
query3:=query3 || ' and tbl_booking_mast.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."State_Code"='''||p_state||''')';
end if;
END IF;

IF(p_taluka  IS NOT NULL)
THEN
if(p_base='1')then
query3:=query3 || ' and AGENCY_MAST.TALUKA='''||p_taluka||'''  ';
end if;

if(p_base='2')then
query3:=query3 || ' and tbl_booking_mast."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast.TALUKA ='''||p_taluka||''' )';
end if;

if(p_base='3')then
query3:=query3 || ' and tbl_booking_mast.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER.TALUKA='''||p_taluka||''')';
end if;
END IF;

query3:=query3 || ' order by tbl_booking_insert."Insert_Date" ,TBL_BOOKING_MAST."cio_booking_id"';
--DELETE FROM SEARCHTBL;
--insert into searchtbl values(query3);
--commit;
OPEN p_recordset1 FOR
query3;

end if;

else

if(p_adcheck=1)
then


query1:=query1||'SELECT
to_char(a."date_time",''dd/mm/yyyy'') as "Date",
sum(a."No_of_insertion") as "noinsert",
sum(a."Paid_ins") as "Paidinsert",sum(a."Total_area") as "Area",
sum(a."Card_amount") as "cardamt",
sum(a."Deviation") as "Deviationamt",
round(((nvl(sum(a."Deviation"),0)*100)/sum(a."Card_amount")),2) AS "Deviation(%)",
sum(a."Agreed_amount") as "aggamt",
(sum(a."Card_amount")- DECODE(NVL(sum(a."Agreed_amount"),0),0,sum(a."Card_amount"),sum(a."Agreed_amount"))) as "DiscAmt",
round((((sum(a."Card_amount")- DECODE(NVL(sum(a."Agreed_amount"),0),0,sum(a."Card_amount"),sum(a."Agreed_amount"))) *100)/sum(a."Card_amount")),2)  as "Discper",
sum((select SUM(nvl(RAT,0)) from multipack_rat where cioid=a."cio_booking_id"  and sess_id='||userenv('sessionid')||')) as  "posamt",
round(((sum((select SUM(nvl(RAT,0)) from multipack_rat where cioid=a."cio_booking_id"  and sess_id='||userenv('sessionid')||'))*100)/sum(a."Card_amount")),2)   as "pos(%)",
sum(a."Special_disc_per" * a."Total_area" * a."Card_rate"/100) as "Spdiscamt",
round(((sum(a."Special_disc_per" * a."Total_area" * a."Card_rate"/100)*100)/sum(a."Card_amount")),2)  as "Spdiscper",
sum(a."Space_disc_per" * a."Total_area" * a."Card_rate"/100) as "Spacedisc",
round(((sum(a."Space_disc_per" * a."Total_area" * a."Card_rate"/100) *100)/sum(a."Card_amount")),2) as "Spacediscper",
sum(a."Special_charges") as "Specialcharge",
round(((sum(nvl((nvl(a."Gross_amount",''0'')*nvl(a."ADD_AGENCY_COMM",''0'')/100),''0''))*100)/(sum(a."Card_amount")+sum((select SUM(nvl(RAT,0)) from multipack_rat where cioid=a."cio_booking_id" and sess_id='||userenv('sessionid')||'))+sum(a."Special_charges")-sum(a."Deviation")-(sum(a."Card_amount")- DECODE(NVL(sum(a."Agreed_amount"),0),0,sum(a."Card_amount"),sum(a."Agreed_amount"))) -sum(a."Space_disc_per" * a."Total_area" * a."Card_rate"/100)-sum(a."Special_disc_per" * a."Total_area" * a."Card_rate"/100))),2) as "AgencyAddlTD(%)",
sum(nvl((nvl(a."Gross_amount",''0'')*nvl(a."ADD_AGENCY_COMM",''0'')/100),''0'')) as "AgencyAddlTDAmt",
sum(nvl(a."Gross_amount",''0'')) as "Grossamt",
round(((sum(nvl(nvl(a."Gross_amount",''0'')*(select DISTINCT TO_NUMBER(NVL("Comm_Rate",''0''))    from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'')) AND ROWNUM<=1 )/100,''0''))*100)/sum(nvl(a."Gross_amount",''0''))),2) as "RetTD(%)",
sum(nvl(nvl(a."Gross_amount",''0'')*(select DISTINCT TO_NUMBER(NVL("Comm_Rate",''0''))    from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'')) AND ROWNUM<=1 )/100,''0''))as "RetTDAmt",
round(((sum((nvl(a."Gross_amount",''0'')* nvl(a."Trade_disc",''0'' )/100) )*100)/(sum(a."Card_amount")+sum((select SUM(nvl(RAT,0)) from multipack_rat where cioid=a."cio_booking_id"  and sess_id='||userenv('sessionid')||'))+sum(a."Special_charges")-sum(a."Deviation")-(sum(a."Card_amount")- DECODE(NVL(sum(a."Agreed_amount"),0),0,sum(a."Card_amount"),sum(a."Agreed_amount"))) -sum(a."Space_disc_per" * a."Total_area" * a."Card_rate"/100)-sum(a."Special_disc_per" * a."Total_area" * a."Card_rate"/100))),2)as "AgencyTD(%)",
sum((nvl(a."Gross_amount",''0'')* nvl(a."Trade_disc",''0'' )/100) )as "AgencyTDAmt",
sum(nvl(a."Bill_amount",''0'')) as "Billamt",
round(((sum(nvl(
case( '''||prefer||''' ) 
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'')) AND ROWNUM<=1)
       when ''Gross'' then 
       
         (
                 CASE to_number(nvl(a.RETAINER_COMM,0))
                 WHEN 0 THEN 0
                 ELSE (to_number(nvl(a.RETAINER_COMM,''0''))-to_number(nvl(a."ADD_AGENCY_COMM",''0'') ))
                 end )
       
       
         when ''Net''   then  to_number(nvl(a.RETAINER_COMM,''0''))
          END )
        
        
       
    ELSE (select 0  from dual)
end
,''0''))*100)/sum(nvl(a."Gross_amount",''0''))),2) as "RetComm(%)",
sum(nvl(
case( '''||prefer||''' ) 
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'')) AND ROWNUM<=1)
       when ''Gross'' then 
       
                
                 (
                 CASE to_number(nvl(a.RETAINER_COMM_AMT,0))
                 WHEN 0 THEN 0
                 ELSE (to_number(nvl(a.RETAINER_COMM_AMT,''0''))-(nvl((nvl(a."Gross_amount",''0'')*to_number(nvl(a."ADD_AGENCY_COMM",''0''))/100),''0'')))
                 end )
        
         when ''Net''   then  (nvl(a."Gross_amount",''0'')*(to_number(nvl(a.RETAINER_COMM,''0'')) )/100)
            END )
        
        
      
       
    ELSE (select 0  from dual)
end
,''0'')) as "RetCommAmt",

minus_to_zero(sum(nvl((a."Bill_amount"-nvl(
case( '''||prefer||''' ) 
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'')) AND ROWNUM<=1)
       when ''Gross'' then 
       (
                 CASE to_number(nvl(a.RETAINER_COMM_AMT,0))
                 WHEN 0 THEN 0
                 ELSE (to_number(nvl(a.RETAINER_COMM_AMT,''0''))-(nvl((nvl(a."Gross_amount",''0'')*to_number(nvl(a."ADD_AGENCY_COMM",''0''))/100),''0'')))
                 end )
       
        
         when ''Net''   then  (nvl(a."Gross_amount",''0'')*(to_number(nvl(a.RETAINER_COMM,''0'')) )/100)
           END )
       
    ELSE (select 0  from dual)
end
,''0'')  ),''0'') ))as "ActualBusiness"
/*,TBL_BOOKING_MAST."Userid" as USERID,(SELECT max("username") from login where com_code = TBL_BOOKING_MAST."Comp_code" and "userid"=TBL_BOOKING_MAST."Userid") as USERNAME*/
FROM TBL_BOOKING_MAST a,
agency_mast
WHERE a."Comp_code"='''||p_compcode||''' AND
a."Agency_sub_code"=AGENCY_MAST."code_subcode"' ;


if(p_chk_access='1')then
query1:=query1||' and a."cio_booking_id"  in (select distinct b."Cio_Booking_Id" from tbl_booking_insert b where a."cio_booking_id"=b."Cio_Booking_Id" and b."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id='''||p_puserid||''')) ';
end if;

if(p_base='2')then
query1:=query1||' and (a."Executive_code" is not null and a."Executive_code" !=''0'')  ';
end if;

if(p_base='3')then
query1:=query1||' and (a.RETAINER is not null  and a.RETAINER !=''0'')  ';
end if;


if(p_drpstatus is null) then
query1:=query1||' and a."cio_booking_id"  in (select distinct b."Cio_Booking_Id" from tbl_booking_insert b where a."cio_booking_id"=b."Cio_Booking_Id" AND lower("Insert_Status")!='''||'cancel'||''' )';
end if;

if(p_insertstatus is not null) then
query1:=query1||' and a."cio_booking_id"  in (select distinct b."Cio_Booking_Id" from tbl_booking_insert b where a."cio_booking_id"=b."Cio_Booking_Id" AND lower("Insert_Status")='''||p_insertstatus||''' )';
end if;


IF(p_fromdate IS NOT NULL AND p_dateto IS NULL  and  p_filterby='Booking Date')
THEN
query1:=query1||' and a."date_time" ='''||p_fromdate||'''';
END IF;

IF(p_fromdate IS NOT NULL AND p_dateto IS NOT NULL and p_filterby='Booking Date' )
THEN
query1:=query1||' and a."date_time" between  '''||p_fromdate ||''' and  '''||p_dateto||''' ';
END IF;

IF(p_fromdate IS NOT NULL AND p_dateto IS NULL  and  p_filterby='Publish Date')
THEN
query1:=query1||' and a."Insertion_date" ='''||p_fromdate||'''';
END IF;

IF(p_fromdate IS NOT NULL AND p_dateto IS NOT NULL and p_filterby='Publish Date' )
THEN
query1:=query1||' and a."Insertion_date"  between  '''||p_fromdate ||''' and  '''||p_dateto||''' ';
END IF;

IF(p_publication IS NOT NULL)
THEN
query1:=query1||'  and a."cio_booking_id"  in (select distinct b."Cio_Booking_Id" from tbl_booking_insert b where b."Publication_Code"='''||p_publication||''' )    ';
END IF;

--old version
IF(p_pub_cent IS NOT NULL)
THEN
query1:=query1||'  and a."branch" IN (SELECT "Branch_Name" FROM BRANCH_MST WHERE a."branch"="Branch_Name" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"='''||p_pub_cent||'''))';
END IF;


IF(p_branch IS NOT NULL)
THEN
query1:=query1||' and a."branch" ='''||p_branch||'''';
END IF;

if (p_baxcode is not null) then
query1:=query1 || ' and tbl_booking_mast."Box_code" = '''||p_baxcode||'''';
end if;

--new version
/*
IF(p_pub_cent IS NOT NULL)
THEN
query1:=query1||'  and a."branch" IN (SELECT "Branch_Code" FROM BRANCH_MST WHERE a."branch"="Branch_Code" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"='''||p_pub_cent||'''))';
END IF;


IF(p_branch IS NOT NULL)
THEN
query1:=query1||'  and a."branch" = (SELECT "Branch_Code" FROM BRANCH_MST where "Branch_Name" ='''||p_branch||''') ';
END IF;
*/

IF(p_edition IS NOT NULL)
THEN
query1:=query1||' and a."cio_booking_id"  in (select distinct b."Cio_Booking_Id" from tbl_booking_insert b where b."Edition_Code"='''||p_edition||''' )';
END IF;

IF(p_region IS NOT NULL)
THEN
query1:=query1 ||'  and agency_mast."region" ='''||p_region||'''';
END IF;

IF(p_suppliment  IS NOT NULL)
THEN
query1:=query1 || '  and a."cio_booking_id"  in (select distinct b."Cio_Booking_Id" from tbl_booking_insert b where b."Supp_Code" ='''||p_suppliment||''' )';
END IF;

IF(p_revcenter IS NOT NULL)
THEN
query1:=query1 ||' and a."Revenue_center" ='''||p_revcenter||'''';
END IF;

IF(p_adtype IS NOT NULL)
THEN
query1:=query1 || ' and a."Ad_type_code"='''||p_adtype||'''';
END IF;

IF(p_agencytype IS NOT NULL)
THEN
query1:=query1 || ' and a."Agency_type" ='''||p_agencytype||'''';
END IF;

IF(p_adcat IS NOT NULL)
THEN
query1:=query1 || ' and a."Ad_cat_code" ='''||p_adcat||'''';
END IF;

IF(p_adsubcat IS NOT NULL)
THEN
query1:=query1 || ' and a."Ad_sub_cat_code" ='''||p_adsubcat||'''';
END IF;

IF(p_adsubcat3 IS NOT NULL)
THEN
query1:=query1 || ' and a."Ad_Subcat3" ='''||p_adsubcat3||'''';
END IF;

IF(p_adsubcat4 IS NOT NULL)
THEN
query1:=query1 || ' and a."Ad_Subcat4" ='''||p_adsubcat4||'''';
END IF;

IF(p_adsubcat5 IS NOT NULL)
THEN
query1:=query1 || ' and a."Ad_subcat5" ='''||p_adsubcat5||'''';
END IF;

IF(p_package IS NOT NULL)
THEN
query1:=query1 || ' and a."Package_code" ='''||p_package||'''';
END IF;

IF(p_scheme IS NOT NULL)
THEN
query1:=query1 || ' and a."Scheme_type_code" ='''||p_scheme||'''';
END IF;

IF(p_agency IS NOT NULL)
THEN
query1:=query1 || ' and a."Agency_code" ='''||p_agency||'''';
END IF;

IF(p_client IS NOT NULL)
THEN
query1:=query1 || ' and a."Client_code" ='''||p_client||'''';
END IF;

IF(p_executive IS NOT NULL)
THEN
query1:=query1 || ' and a."Executive_code" ='''||p_executive||'''';
END IF;

IF(p_retainer IS NOT NULL)
THEN
query1:=query1 || ' and a.RETAINER ='''||p_retainer||'''';
END IF;

IF(p_product IS NOT NULL)
THEN
query1:=query1 || ' and a."Product_code" ='''||p_product||'''';
END IF;

IF(p_brand IS NOT NULL)
THEN
query1:=query1 || ' and a."Brand_code" ='''||p_brand||'''';
END IF;

IF(p_varient IS NOT NULL)
THEN
query1:=query1 || ' and a."Variant_code" ='''||p_varient||'''';
END IF;

IF(p_pagetype IS NOT NULL)
THEN
query1:=query1 || ' and a."Page_type_code" ='''||p_pagetype||'''';
END IF;

IF(p_pageprem IS NOT NULL)
THEN
query1:=query1 || ' and a."Page_prem" ='''||p_pageprem||'''';
END IF;

IF(p_postprem IS NOT NULL)
THEN
query1:=query1 || ' and a."Page_position_code" ='''||p_postprem||'''';
END IF;

IF(p_rostatus IS NOT NULL)
THEN
query1:=query1 || ' and a."ro_status" ='''||p_rostatus||'''';
END IF;

IF(p_booktype IS NOT NULL)
THEN
query1:=query1 || ' and a."Booking_type" ='''||p_booktype||'''';
END IF;

IF(p_contractname  IS NOT NULL)
THEN
query1:=query1 || ' and a."Contract_name" ='''||p_contractname ||'''';
END IF;



IF(p_ratetype  IS NOT NULL)
THEN
query1:=query1 || ' and a."Rate_code" ='''||p_ratetype||'''';
END IF;

IF(p_city  IS NOT NULL)
THEN
if(p_base='1')then
query1:=query1 || ' and AGENCY_MAST."City_Code" ='''||p_city||'''';
end if;

if(p_base='2')then
query1:=query1 || ' and a."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" ='''||p_city||''' )';
end if;

if(p_base='3')then
query1:=query1 || ' and a.RETAINER in(select RET."Retain_Code" from  RETAINERMASTER RET where  RET."City_Code"='''||p_city||''')';
end if;
END IF;

IF(p_zone  IS NOT NULL)
THEN
if(p_base='1')then
query1:=query1 || ' and AGENCY_MAST."zone_code" ='''||p_zone||'''';
end if;

if(p_base='2')then
query1:=query1 || ' and a."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" in (select city_mst."City_Code" from city_mst where city_mst."Zone_Code"= '''||p_zone||''') )';
end if;

if(p_base='3')then
query1:=query1 || ' and a.RETAINER in(select RET."Retain_Code" from  RETAINERMASTER RET where  RET."Zone_Code"='''||p_zone||''')';
end if;
END IF;

IF(p_district  IS NOT NULL)
THEN
if(p_base='1')then
query1:=query1 || ' and AGENCY_MAST."Dist_Code" ='''||p_district||'''';
end if;

if(p_base='2')then
query1:=query1 || ' and a."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."dist_code" ='''||p_district||''' )';
end if;

if(p_base='3')then
query1:=query1 || ' and a.RETAINER in(select RET."Retain_Code" from  RETAINERMASTER RET where  RET."Dist_Code"='''||p_district||''')';
end if;
END IF;

IF(p_state  IS NOT NULL)
THEN
if(p_base='1')then
query1:=query1 || ' and AGENCY_MAST."State_Code" ='''||p_state||'''';
end if;

if(p_base='2')then
query1:=query1 || ' and a."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."State_code" ='''||p_state||''' )';
end if;

if(p_base='3')then
query1:=query1 || ' and a.RETAINER in(select RET."Retain_Code" from  RETAINERMASTER RET where  RET."State_Code"='''||p_state||''')';
end if;
END IF;

IF(p_taluka  IS NOT NULL)
THEN
if(p_base='1')then
query1:=query1 || ' and AGENCY_MAST.TALUKA='''||p_taluka||'''  ';
end if;

if(p_base='2')then
query1:=query1 || ' and a."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast.TALUKA ='''||p_taluka||''' )';
end if;

if(p_base='3')then
query1:=query1 || ' and a.RETAINER in(select RET."Retain_Code" from  RETAINERMASTER RET where  RET.TALUKA='''||p_taluka||''')';
end if;
END IF;

query1:=query1 || ' group by a."date_time" order by "Date" ';



OPEN p_recordset1 FOR
query1;



elsif(p_adcheck=2)then

delete from temp_ad_bills_report where sess_id=userenv('sessionid');
open c2;
loop
fetch c2 into v2;
exit when c2%notfound;
     v_val:=FUN_BILL_INSERT(p_compcode,v2.CIOID,v2.BILLNO,prefer,p_dateformat,v2.AGMAINCODE,v2.AG_SUB_CODE,v2.AGCODE,v2.AGNAME,v2.EXECCODE,v2.EXECNAME,v2.RETCODE,v2.RETNAME,p_base );    
end loop;
close c2;
commit;


query2:=query2||'SELECT 
to_char(BILLDATE,'''||p_dateformat||''') as "Date",
sum(NOINSERT) as "noinsert",
sum(PAIDINSERT) as "Paidinsert" ,
sum(AREA) as "Area",
sum(CARDAMT) as "cardamt",
sum(DEVIATIONAMT) as "Deviationamt",
round(((nvl(sum(DEVIATIONAMT),0) *100)/nvl(sum(CARDAMT),0)),2)   AS "Deviation(%)",
sum(AGGAMT)  as "aggamt",
sum(DISCAMT) as "DiscAmt",
round(((nvl(sum(DISCAMT),0) *100)/nvl(sum(CARDAMT),0)),2) as "Discper",
sum(POSAMT)as  "posamt",
round(((nvl(sum(POSAMT),0) *100)/nvl(sum(CARDAMT),0)),2)  as "pos(%)",
sum(SPDISCAMT) as "Spdiscamt",
round(((nvl(sum(SPDISCAMT),0)*100)/nvl(sum(CARDAMT),0)),2)  as "Spdiscper",
sum(SPACEDISC) as "Spacedisc",
round(((nvl(sum(SPACEDISC),0)*100)/nvl(sum(CARDAMT),0)),2)  as "Spacediscper",
sum(SPECIALCHARGE) as "Specialcharge",
sum(AGENCYADDLTDAMT) as "AgencyAddlTDAmt",
round(((nvl(sum(AGENCYADDLTDAMT),0)*100)/(nvl(sum(CARDAMT),0)+nvl(sum(POSAMT),0)+nvl(sum(SPECIALCHARGE),0)-nvl(sum(DEVIATIONAMT),0)-nvl(sum(DISCAMT),0)-nvl(sum(SPDISCAMT),0)-nvl(sum(SPACEDISC),0))),2) as "AgencyAddlTD(%)",
sum(GROSSAMT)  as "Grossamt",
sum(RETTDAMT)as "RetTDAmt",
round(((nvl(sum(RETTDAMT),0)*100)/nvl(sum(GROSSAMT),0) ),2) as "RetTD(%)",
sum(AGENCYTDAMT)as "AgencyTDAmt",
round(((nvl(sum(AGENCYTDAMT),0)*100)/(nvl(sum(CARDAMT),0)+nvl(sum(POSAMT),0)+nvl(sum(SPECIALCHARGE),0)-nvl(sum(DEVIATIONAMT),0)-nvl(sum(DISCAMT),0)-nvl(sum(SPDISCAMT),0)-nvl(sum(SPACEDISC),0))),2)as "AgencyTD(%)",
sum(BILLAMT )as "Billamt",
sum(RETCOMMAMT)as "RetCommAmt",
round(((nvl(sum(RETCOMMAMT),0)*100)/nvl(sum(GROSSAMT),0)),2) as "RetComm(%)",
minus_to_zero(sum(ACTUALBUSINESS))as "ActualBusiness"
from temp_ad_bills_report where sess_id='||userenv('sessionid');




IF(p_fromdate IS NOT NULL AND p_dateto IS NOT NULL )
THEN
query2:=query2||' and BILLDATE between  '''||p_fromdate ||''' and  '''||p_dateto||''' ';
END IF;

IF(p_publication IS NOT NULL)
THEN
query2:=query2||' and PRIPUB='''||p_publication||'''';
END IF;

IF(p_pub_cent IS NOT NULL)
THEN
query2:=query2||'   and PUB_CENT_CODE='''||p_pub_cent||'''';
END IF;

IF(p_edition IS NOT NULL)
THEN
query2:=query2||'  and PEDITION='''||p_edition||'''';
END IF;

IF(p_branch IS NOT NULL)
THEN
query2:=query2||'  and  BRANCH_NAME ='''||p_branch||''' ';
END IF;

IF(p_region IS NOT NULL)
THEN
query2:=query2 ||' and REGION='''||p_region ||'''';
END IF;

IF(p_adtype IS NOT NULL)
THEN
query2:=query2 || ' and PADTYPE='''||p_adtype||'''';
END IF;

IF(p_agencytype IS NOT NULL)
THEN
query2:=query2 || ' and AGENCY_TYPE_CODE= '''||p_agencytype||'''';
END IF;

IF(p_adcat IS NOT NULL)
THEN
query2:=query2 || ' and PRIADCTG='''||p_adcat||'''';
END IF;

IF(p_adsubcat IS NOT NULL)
THEN
query2:=query2 || ' and SECADCTG ='''||p_adsubcat||'''';
END IF;

IF(p_adsubcat3 IS NOT NULL)
THEN
query2:=query2 || ' and AD_SUBCAT3 ='''||p_adsubcat3||'''';
END IF;

IF(p_adsubcat4 IS NOT NULL)
THEN
query2:=query2 || ' and AD_SUBCAT4 ='''||p_adsubcat4||'''';
END IF;

IF(p_adsubcat5 IS NOT NULL)
THEN
query2:=query2 || ' and AD_SUBCAT5 ='''||p_adsubcat5||'''';
END IF;

IF(p_package IS NOT NULL)
THEN
query2:=query2 || ' and PACKAGE_CODE='''||p_package||'''';
END IF;

IF(p_agency IS NOT NULL)
THEN
query2:=query2 || ' and AG_MAIN_CODE ='''||p_agency ||'''';
END IF;

IF(p_client IS NOT NULL)
THEN
query2:=query2 || ' and CLIENTCD='''||p_client ||'''';
END IF;

IF(p_executive IS NOT NULL)
THEN
query2:=query2 || ' and EXECUTIVE_NAME='''||p_executive||'''';
END IF;

IF(p_product IS NOT NULL)
THEN
query2:=query2 || ' and PRIPROCTG='''||p_product||'''';
END IF;

IF(p_brand IS NOT NULL)
THEN
query2:=query2 || ' and BRAND_CODE='''||p_brand||'''';
END IF;

IF(p_varient IS NOT NULL)
THEN
query2:=query2 || ' and   VARIENT_NAME='''||p_varient||'''';
END IF;

IF(p_pageprem IS NOT NULL)
THEN
query2:=query2 || ' and PAGE_PREM ='''||p_pageprem||'''';
END IF;

IF(p_postprem IS NOT NULL)
THEN
query2:=query2 || ' and PAGE_POST ='''||p_postprem||'''';
END IF;

IF(p_contractname  IS NOT NULL)
THEN
query2:=query2 || ' and CONTRACT_NAME ='''||p_contractname ||'''';
END IF;

IF(p_suppliment  IS NOT NULL)
THEN
query2:=query2 || ' and SUPP_CODE='''||p_suppliment||'''';
END IF;

IF(p_retainer IS NOT NULL)
THEN
query2:=query2 || ' and RETAINER_CODE='''||p_retainer||'''';
END IF;

IF(p_ratetype  IS NOT NULL)
THEN
query2:=query2 || ' and RATECD ='''||p_ratetype||'''';
END IF;

IF(p_scheme IS NOT NULL)
THEN
query2:=query2 || ' and PSCHEME='''||p_scheme||'''';
END IF;

IF(p_revcenter IS NOT NULL)
THEN
query2:=query2 ||' and REVENUE_CENTER='''||p_revcenter||'''';
END IF;

IF(p_rostatus IS NOT NULL)
THEN
query2:=query2 || ' and RO_STATUS='''||p_rostatus||'''';
END IF;

IF(p_pagetype IS NOT NULL)
THEN
query2:=query2 || ' and PAGE_TYPE ='''||p_pagetype||'''';
END IF;

IF(p_booktype IS NOT NULL)
THEN
query2:=query2 || ' and BOOKING_TYPE='''||p_booktype||'''';
END IF;



IF(p_city  IS NOT NULL)
THEN
query2:=query2 || ' and CITY_CODE ='''||p_city||'''';
END IF;

IF(p_zone  IS NOT NULL)
THEN
query2:=query2 || ' and ZONE_CODE ='''||p_zone||'''';
end if;

IF(p_district  IS NOT NULL)
THEN
query2:=query2 || ' and DIST_CODE ='''||p_district||'''';
end if;

IF(p_state  IS NOT NULL)
THEN
query2:=query2 || ' and STATE_CODE ='''||p_state||'''';
end if;

IF(p_taluka  IS NOT NULL)
THEN
query2:=query2 || ' and PTALUKA='''||p_taluka||'''  ';
end if;

if(p_base='2')then
query2:=query2 ||' and (EXECUTIVE_NAME   is not null and EXECUTIVE_NAME !=''0'')  ';
end if;

if(p_base='3')then
query2:=query2 ||' and (RETAINER_CODE  is not null  and RETAINER_CODE  !=''0'')  ';
end if;



query2:=query2 || ' group by BILLDATE   order by BILLDATE ';




OPEN p_recordset1 FOR
query2;

elsif(p_adcheck=3) then
query3:=query3 ||'SELECT  
to_char(b."Insert_Date" ,'''||p_dateformat||''') as "Date",
sum(a."No_of_insertion") as "noinsert",
sum(a."Paid_ins") as "Paidinsert",
sum(b."Size_Book") as "Area",
sum(a."Card_rate"*b."Size_Book") as "cardamt",
sum(a."Deviation") as "Deviationamt",
round(((sum(a."Deviation")*100)/sum(a."Card_rate"*b."Size_Book")),2) AS "Deviation(%)",
sum(b."Agreed_Rate")  as "aggamt",
(sum(a."Card_rate"*b."Size_Book")- DECODE(NVL(sum(b."Agreed_Rate"),0),0,sum(a."Card_rate"*b."Size_Book"),sum(b."Agreed_Rate"))) as "DiscAmt",
round((((sum(a."Card_rate"*b."Size_Book")- DECODE(NVL(sum(b."Agreed_Rate"),0),0,sum(a."Card_rate"*b."Size_Book"),sum(b."Agreed_Rate")))*100)/sum(a."Card_rate"*b."Size_Book")),2) as "Discper",
sum((select SUM(nvl(RAT,0)) from multipack_rat where cioid=a."cio_booking_id" and sess_id='||userenv('sessionid')||')) as  "posamt",
round(((sum((select SUM(nvl(RAT,0)) from multipack_rat where cioid=a."cio_booking_id" and sess_id='||userenv('sessionid')||'))*100)/sum(a."Card_rate"*b."Size_Book")),2)  as "pos(%)",
sum(a."Special_disc_per" * b."Size_Book" * a."Card_rate"/100) as "Spdiscamt",
round(((sum(a."Special_disc_per" * b."Size_Book" * a."Card_rate"/100)*100)/sum(a."Card_rate"*b."Size_Book")),2) as "Spdiscper",
sum(a."Space_disc_per" * b."Size_Book" * a."Card_rate"/100) as "Spacedisc",
round(((sum(a."Space_disc_per" * b."Size_Book" * a."Card_rate"/100)*100)/sum(a."Card_rate"*b."Size_Book")),2) as "Spacediscper",
sum(a."Special_charges") as "Specialcharge",
round(((sum(nvl((nvl(b."Gross_Rate" ,''0'')*nvl(a."ADD_AGENCY_COMM",''0'')/100),''0''))*100)/(sum(a."Card_rate"*b."Size_Book")+sum((select SUM(nvl(RAT,0)) from multipack_rat where cioid=a."cio_booking_id" and sess_id='||userenv('sessionid')||'))+sum(a."Special_charges") -sum(a."Deviation")-(sum(a."Card_rate"*b."Size_Book")- DECODE(NVL(sum(b."Agreed_Rate"),0),0,sum(a."Card_rate"*b."Size_Book"),sum(b."Agreed_Rate")))-sum(a."Special_discount")-sum(a."Space_discount"))),2) as "AgencyAddlTD(%)",
sum(nvl((nvl(b."Gross_Rate" ,''0'')*nvl(a."ADD_AGENCY_COMM",''0'')/100),''0'')) as "AgencyAddlTDAmt",
ROUND(sum(nvl(b."Gross_Rate",''0'') ))as "Grossamt",
case sum(nvl(b."Gross_Rate",''0'') )
 when  0 then 0
   else  round(((sum(nvl(b."Gross_Rate",''0'')*(select DISTINCT TO_NUMBER(NVL("Comm_Rate",''0''))    from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'')) AND ROWNUM<=1 )/100)*100)/sum(nvl(b."Gross_Rate",''0'') )),2)
 end  as "RetTD(%)",
sum(nvl(nvl(b."Gross_Rate",''0'')*(select DISTINCT TO_NUMBER(NVL("Comm_Rate",''0''))    from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'')) AND ROWNUM<=1 )/100
,''0''))as "RetTDAmt",

round(((sum((nvl(b."Gross_Rate",''0'')* nvl(a."Trade_disc",''0'' )/100 ))*100)/(sum(a."Card_rate"*b."Size_Book")+sum((select SUM(nvl(RAT,0)) from multipack_rat where cioid=a."cio_booking_id" and sess_id='||userenv('sessionid')||'))+sum(a."Special_charges") -sum(a."Deviation")-(sum(a."Card_rate"*b."Size_Book")- DECODE(NVL(sum(b."Agreed_Rate"),0),0,sum(a."Card_rate"*b."Size_Book"),sum(b."Agreed_Rate")))-sum(a."Special_discount")-sum(a."Space_discount"))),2) as "AgencyTD(%)",

sum((nvl(b."Gross_Rate",''0'')* nvl(a."Trade_disc",''0'' )/100 ))as "AgencyTDAmt",
ROUND(sum(NVL(b."Bill_Amt",''0'')),2) as "Billamt",
 case sum(nvl(b."Gross_Rate",''0'') )
 when  0 then 0
 else  round(((sum(nvl(
case( '''||prefer||''' ) 
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'')) AND ROWNUM<=1)
        when ''Gross'' then 
        
         (
                 CASE to_number(nvl(a.RETAINER_COMM,0))
                 WHEN 0 THEN 0
                 ELSE (to_number(nvl(a.RETAINER_COMM,''0''))-to_number(nvl(a."ADD_AGENCY_COMM",''0'' )))
               end   )
        
        
        
         when ''Net''   then  to_number(nvl(a.RETAINER_COMM,''0''))
          END )
        
          
       
       
    ELSE (select 0  from dual)
end
,''0'')) *100)/sum(nvl(b."Gross_Rate",''0'') )),2)
 
 end  as "RetComm(%)",

sum(nvl(
case( '''||prefer||''' ) 
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'')) AND ROWNUM<=1)
       when ''Gross'' then 
       
       
              
                
                 (
                 CASE to_number(nvl(a.RETAINER_COMM_AMT,0))
                 WHEN 0 THEN 0
                 ELSE (to_number(nvl(a.RETAINER_COMM_AMT,''0''))-(nvl((nvl(b."Gross_Rate",''0'')*to_number(nvl(a."ADD_AGENCY_COMM",''0''))/100),''0'')))
                 end )
       
       
        
         when ''Net''   then  (nvl(b."Gross_Rate",''0'')*(to_number(nvl(a.RETAINER_COMM,''0'')) )/100)
        END )
       
       
    ELSE (select 0  from dual)
end
,''0''))as "RetCommAmt",


minus_to_zero(ROUND(sum(nvl((  NVL(b."Bill_Amt",''0'')-nvl(
case( '''||prefer||''' ) 
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'')) AND ROWNUM<=1)
        when ''Gross'' then 
        (
                 CASE to_number(nvl(a.RETAINER_COMM_AMT,0))
                 WHEN 0 THEN 0
                 ELSE (to_number(nvl(a.RETAINER_COMM_AMT,''0''))-(nvl((nvl(b."Gross_Rate",''0'')*to_number(nvl(a."ADD_AGENCY_COMM",''0''))/100),''0'')))
                 end )
        
         
         when ''Net''   then  (nvl(b."Gross_Rate",''0'')*(to_number(nvl(a.RETAINER_COMM,''0'')) )/100)
        END )
       
    ELSE (select 0  from dual)
end
,''0'')  ),''0'')),2)) as "ActualBusiness"
,TBL_BOOKING_MAST."Userid" as USERID,(SELECT max("username") from login where com_code = TBL_BOOKING_MAST."Comp_code" and "userid"=TBL_BOOKING_MAST."Userid") as USERNAME
FROM TBL_BOOKING_MAST a,AGENCY_MAST ,TBL_BOOKING_insert b
WHERE a."Comp_code"='''||p_compcode||''' AND
a."Agency_sub_code"=AGENCY_MAST."code_subcode" AND
a."cio_booking_id"=b."Cio_Booking_Id"
and ((b."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id='''||p_puserid||''') and '''||p_chk_access||'''=''1'')
or  ('''||p_chk_access||'''=''0'') )'; 


if(p_base='2')then
query3:=query3 ||' and (a."Executive_code" is not null and a."Executive_code" !=''0'')  ';
end if;

if(p_base='3')then
query3:=query3 ||' and (a.RETAINER is not null  and a.RETAINER !=''0'')  ';
end if;


if(p_drpstatus is null) then
query3:=query3||' and lower("Insert_Status")!='''||'cancel'||'''';
end if;


if(p_insertstatus is not null) then
query3:=query3||' and lower("Insert_Status")='''||p_insertstatus||'''';
end if;


IF(p_fromdate IS NOT NULL AND p_dateto IS NULL )
THEN
query3:=query3 ||' and b."Insert_Date" ='''||p_fromdate||'''';
END IF;

IF(p_fromdate IS NOT NULL AND p_dateto IS NOT NULL)
THEN
query3:=query3 ||' and b."Insert_Date" between  '''||p_fromdate ||''' and  '''||p_dateto||''' ';
END IF;

IF(p_publication IS NOT NULL)
THEN
query3:=query3 ||' and b."Publication_Code"='''||p_publication||'''    ';
END IF;

--old version

IF(p_pub_cent IS NOT NULL)
THEN
query3:=query3||'  and a."branch" IN (SELECT "Branch_Name" FROM BRANCH_MST WHERE a."branch"="Branch_Name" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"='''||p_pub_cent||'''))';
END IF;

IF(p_branch IS NOT NULL)
THEN
query3:=query3 ||'  and a."branch" ='''||p_branch||'''';
END IF;

if (p_baxcode is not null) then
query3:=query3 || ' and tbl_booking_mast."Box_code" = '''||p_baxcode||'''';
end if;

--new version
/*
IF(p_pub_cent IS NOT NULL)
THEN
query3:=query3||'  and a."branch" IN (SELECT "Branch_Code" FROM BRANCH_MST WHERE a."branch"="Branch_Code" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"='''||p_pub_cent||'''))';
END IF;


IF(p_branch IS NOT NULL)
THEN
query3:=query3||'  and a."branch" = (SELECT "Branch_Code" FROM BRANCH_MST where "Branch_Name" ='''||p_branch||''') ';
END IF;
*/
IF(p_edition IS NOT NULL)
THEN
query3:=query3 ||'  and b."Edition_Code"='''||p_edition||'''';
END IF;

IF(p_region IS NOT NULL)
THEN
query3:=query3 ||'  and agency_mast."region" ='''||p_region||'''';
END IF;

IF(p_revcenter IS NOT NULL)
THEN
query3:=query3  ||' and a."Revenue_center" ='''||p_revcenter||'''';
END IF;

IF(p_adtype IS NOT NULL)
THEN
query3:=query3  || ' and a."Ad_type_code"='''||p_adtype||'''';
END IF;

IF(p_agencytype IS NOT NULL)
THEN
query3:=query3  || ' and a."Agency_type" ='''||p_agencytype||'''';
END IF;

IF(p_adcat IS NOT NULL)
THEN
query3:=query3  || ' and b."Ad_Cat" ='''||p_adcat||'''';
END IF;

IF(p_adsubcat IS NOT NULL)
THEN
query3:=query3  || ' and a."Ad_sub_cat_code" ='''||p_adsubcat||'''';
END IF;

IF(p_adsubcat3 IS NOT NULL)
THEN
query3:=query3  || ' and a."Ad_Subcat3" ='''||p_adsubcat3||'''';
END IF;

IF(p_adsubcat4 IS NOT NULL)
THEN
query3:=query3  || ' and a."Ad_Subcat4" ='''||p_adsubcat4||'''';
END IF;

IF(p_adsubcat5 IS NOT NULL)
THEN
query3:=query3  || ' and a."Ad_subcat5" ='''||p_adsubcat5||'''';
END IF;

IF(p_package IS NOT NULL)
THEN
query3:=query3  || ' and a."Package_code" ='''||p_package||'''';
END IF;

IF(p_scheme IS NOT NULL)
THEN
query3:=query3  || ' and a."Scheme_type_code" ='''||p_scheme||'''';
END IF;

IF(p_agency IS NOT NULL)
THEN
query3:=query3  || ' and a."Agency_code" ='''||p_agency||'''';
END IF;

IF(p_client IS NOT NULL)
THEN
query3:=query3  || ' and a."Client_code" ='''||p_client||'''';
END IF;

IF(p_executive IS NOT NULL)
THEN
query3:=query3  || ' and a."Executive_code" ='''||p_executive||'''';
END IF;

IF(p_retainer IS NOT NULL)
THEN
query3:=query3  || ' and a.RETAINER ='''||p_retainer||'''';
END IF;

IF(p_product IS NOT NULL)
THEN
query3:=query3 || ' and a."Product_code" ='''||p_product||'''';
END IF;

IF(p_brand IS NOT NULL)
THEN
query3:=query3  || ' and a."Brand_code" ='''||p_brand||'''';
END IF;

IF(p_varient IS NOT NULL)
THEN
query3:=query3  || ' and a."Variant_code" ='''||p_varient||'''';
END IF;

IF(p_pagetype IS NOT NULL)
THEN
query3:=query3  || ' and a."Page_type_code" ='''||p_pagetype||'''';
END IF;

IF(p_pageprem IS NOT NULL)
THEN
query3:=query3 || ' and b."Premium1" ='''||p_pageprem||'''';
END IF;

IF(p_postprem IS NOT NULL)
THEN
query3:=query3 || ' and b."Page_Post"  ='''||p_postprem||'''';
END IF;

IF(p_rostatus IS NOT NULL)
THEN
query3:=query3 || ' and a."ro_status" ='''||p_rostatus||'''';
END IF;

IF(p_booktype IS NOT NULL)
THEN
query3:=query3 || ' and a."Booking_type" ='''||p_booktype||'''';
END IF;

IF(p_contractname  IS NOT NULL)
THEN
query3:=query3 || ' and a."Contract_name" ='''||p_contractname ||'''';
END IF;

IF(p_suppliment  IS NOT NULL)
THEN
query3:=query3 || ' and b."Supp_Code" ='''||p_suppliment||'''';
END IF;

IF(p_ratetype  IS NOT NULL)
THEN
query3:=query3 || ' and a."Rate_code" ='''||p_ratetype||'''';
END IF;

IF(p_city  IS NOT NULL)
THEN
if(p_base='1')then
query3:=query3 || ' and AGENCY_MAST."City_Code" ='''||p_city||'''';
end if;

if(p_base='2')then
query3:=query3 || ' and a."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" ='''||p_city||''' )';
end if;

if(p_base='3')then
query3:=query3 || ' and a.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."City_Code"='''||p_city||''')';
end if;
END IF;

IF(p_zone  IS NOT NULL)
THEN
if(p_base='1')then
query3:=query3 || ' and AGENCY_MAST."zone_code" ='''||p_zone||'''';
end if;

if(p_base='2')then
query3:=query3 || ' and a."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" in (select city_mst."City_Code" from city_mst where city_mst."Zone_Code"= '''||p_zone||''') )';
end if;

if(p_base='3')then
query3:=query3 || ' and a.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Zone_Code"='''||p_zone||''')';
end if;
END IF;

IF(p_district  IS NOT NULL)
THEN
if(p_base='1')then
query3:=query3 || ' and AGENCY_MAST."Dist_Code" ='''||p_district||'''';
end if;

if(p_base='2')then
query3:=query3 || ' and a."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."dist_code" ='''||p_district||''' )';
end if;

if(p_base='3')then
query3:=query3 || ' and a.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Dist_Code"='''||p_district||''')';
end if;
END IF;

IF(p_state  IS NOT NULL)
THEN
if(p_base='1')then
query3:=query3 || ' and AGENCY_MAST."State_Code" ='''||p_state||'''';
end if;

if(p_base='2')then
query3:=query3 || ' and a."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."State_code" ='''||p_state||''' )';
end if;

if(p_base='3')then
query3:=query3 || ' and a.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."State_Code"='''||p_state||''')';
end if;
END IF;

IF(p_taluka  IS NOT NULL)
THEN
if(p_base='1')then
query3:=query3 || ' and AGENCY_MAST.TALUKA='''||p_taluka||''' ';
end if;

if(p_base='2')then
query3:=query3 || ' and a."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast.TALUKA ='''||p_taluka||''' )';
end if;

if(p_base='3')then
query3:=query3 || ' and a.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER.TALUKA='''||p_taluka||''')';
end if;
END IF;

query3:=query3 || ' group by b."Insert_Date" order by "Date" ';

OPEN p_recordset1 FOR
query3;

end if;
end if;




OPEN  p_accounts FOR
SELECT to_char( SYSDATE,p_dateformat) AS "Rundate",initcap("Comp_Name") AS "companyname" from comp_mst where "Comp_Code"=p_compcode;
delete from multipack_rep where sess_id=userenv('sessionid')  ;
delete from multipack_rat where sess_id=userenv('sessionid') ;
DELETE FROM multipack_ratnew where sess_id=userenv('sessionid')  ; commit;

END ;
/



/////////////////////////////////////////////////////////end////////////////////////////////////////////////////////////


/**********************ankit************* issue 6233***********16 jan*************/

CREATE OR REPLACE PROCEDURE getData_Export
(adtype_p in varchar2,
fromdate_p in varchar2,todate_p in varchar2,
p_Accounts OUT Cur_Type_New1.cursor_type
)
 is
    
begin

open p_Accounts for

SELECT RATE_MAST."rateuniqueid", RATE_MAST."Comp_code", RATE_MAST."Rate_Mast_Code", RATE_MAST."Adv_Type_Code", RATE_MAST."Adv_Cat_Code", RATE_MAST."Adv_subcat_code", RATE_MAST."Rate_Gr_Code", RATE_MAST."Currency", RATE_MAST."combin_desc", RATE_MAST."Combin_Code", RATE_MAST."Uom", to_char(RATE_MAST."Valid_From",'mm/dd/yyyy') as Valid_From, to_char(RATE_MAST."Valid_To",'mm/dd/yyyy') as Valid_To, RATE_MAST."Size_To", RATE_MAST."Size_From", RATE_MAST."consumption_Per", RATE_MAST."Color", RATE_MAST."Col_chr_typ", RATE_MAST."Remarks", RATE_MAST."Week_Day_Rate", RATE_MAST."Week_min_rate", RATE_MAST."Week_Extra_Rate", RATE_MAST."Focus_Day_Rate", RATE_MAST."Focus_min_rate", RATE_MAST."Focus_extra_rate", RATE_MAST."userid", RATE_MAST."Creation_DateTime", RATE_MAST."Premium", RATE_MAST."Premium_Charges", RATE_MAST."weekend_rate", RATE_MAST."weekend_min_rate", RATE_MAST."weekend_extra", RATE_MAST."chksolo", RATE_MAST."min_ad_area", RATE_MAST."Edition_from", RATE_MAST."Edition_to", RATE_MAST."floor_amount", RATE_MAST."floor_discount", RATE_MAST."Scheme_Name", RATE_MAST."Ad_Subcat4", RATE_MAST."Ad_Subcat5", RATE_MAST."Ad_subcat6", RATE_MAST."From_insertion", RATE_MAST."To_insertion", RATE_MAST."Agency_type", RATE_MAST."Client_cat", RATE_MAST."Max_Area", RATE_MAST."pub_center", RATE_MAST.SUN_RATE, RATE_MAST.MON_RATE, RATE_MAST.TUE_RATE, RATE_MAST.WED_RATE, RATE_MAST.THU_RATE, RATE_MAST.FRI_RATE, RATE_MAST.SAT_RATE, RATE_MAST.SUN_RATE_EXTRA, RATE_MAST.MON_RATE_EXTRA, RATE_MAST.TUE_RATE_EXTRA, RATE_MAST.WED_RATE_EXTRA, RATE_MAST.THU_RATE_EXTRA, RATE_MAST.FRI_RATE_EXTRA, RATE_MAST.SAT_RATE_EXTRA, RATE_MAST.MAXWIDTH, RATE_MAST.PRIORITY,RATE_MAST.VAT_DETAIL,RATE_MAST.ADON,RATE_MAST.REF_ID
,RATE_DETAILS."ratemastid", RATE_DETAILS."id", RATE_DETAILS."rate_code", RATE_DETAILS."edition_name", RATE_DETAILS."Week_Day_Rate", RATE_DETAILS."Week_min_rate", RATE_DETAILS."Week_Extra_Rate", RATE_DETAILS."Focus_Day_Rate", RATE_DETAILS."Focus_min_rate", RATE_DETAILS."Focus_extra_rate", RATE_DETAILS."userid", RATE_DETAILS."Creation_DateTime", RATE_DETAILS."Comp_Code", RATE_DETAILS."Solus_week_rate", RATE_DETAILS."Solus_focus_rate", RATE_DETAILS."weekend_rate", RATE_DETAILS."weekend_min", RATE_DETAILS."weekend_extra", RATE_DETAILS."Solo_weekendrate", RATE_DETAILS.SUN_RATE, RATE_DETAILS.MON_RATE, RATE_DETAILS.TUE_RATE, RATE_DETAILS.WED_RATE, RATE_DETAILS.THU_RATE, RATE_DETAILS.FRI_RATE, RATE_DETAILS.SAT_RATE, RATE_DETAILS.SUN_RATE_EXTRA, RATE_DETAILS.MON_RATE_EXTRA, RATE_DETAILS.TUE_RATE_EXTRA, RATE_DETAILS.WED_RATE_EXTRA, RATE_DETAILS.THU_RATE_EXTRA, RATE_DETAILS.FRI_RATE_EXTRA, RATE_DETAILS.SAT_RATE_EXTRA, RATE_DETAILS.PKGNAME
 FROM RATE_MAST FULL JOIN RATE_DETAILS ON
 RATE_MAST."rateuniqueid"=RATE_DETAILS."ratemastid" WHERE "Adv_Type_Code"=adtype_p and "Valid_From">=fromdate_p AND "Valid_To"<=todate_p
   ORDER BY RATE_MAST."rateuniqueid";


end ;
/

/*********end*************ankit************* issue 6233***********16 jan*************/

/*************mimoh 6196*************************************************/


CREATE OR REPLACE PACKAGE getautocodebox
IS
   TYPE t_accounts_cursor IS REF CURSOR;
   PROCEDURE getautocodebox_p (
      compcode     IN       VARCHAR2,
      auto1        IN       VARCHAR2,
      no1          IN       VARCHAR2,
      center1      IN       varchar2,
      agency_codescode      IN       varchar2,
       branch            IN VARCHAR2,
       save_val in varchar2,
      p_accounts   OUT      t_accounts_cursor,
      p_accounts1   OUT      t_accounts_cursor,
      p_accounts2   OUT      t_accounts_cursor
   );
END getautocodebox;
/




CREATE OR REPLACE PACKAGE BODY getautocodebox IS
    PROCEDURE getautocodebox_p (
        compcode            IN  VARCHAR2,
        auto1               IN  VARCHAR2,
        no1                 IN  VARCHAR2,
        center1             IN  varchar2,
        agency_codescode    IN  varchar2,
        branch              IN  VARCHAR2,
        save_val            in  varchar2,
        p_accounts          OUT t_accounts_cursor,
        p_accounts1         OUT t_accounts_cursor,
        p_accounts2         OUT t_accounts_cursor)
    AS
        idcou           NUMBER (10);
        maxid           NUMBER (10);
        countnum        int;
        fatchboxadd     VARCHAR2(1000);
        v_branch_nick   varchar2(10);
        v_getno         varchar2(50);
    begin

         select BOX_ADDRESS,UPPER(branch_nick) INTO fatchboxadd,v_branch_nick from branch_mst 
            where "Branch_Code"=branch and "Comp_Code"=compcode AND ROWNUM<=1;
        
         select MAX(TRANSLATE(upper("Box_no"),'ABCDEFGHIJKLMNOPQRSTUVWXYZ','0')) into idcou from ad_tableid
            where TRANSLATE(upper("Box_no"),'1234567890','')=v_branch_nick;
         
         if(auto1 is not null) then
         
             IF (idcou >0) THEN
                OPEN p_accounts FOR SELECT nvl(MAX(TO_NUMBER(SUBSTR("Box_no",3,LENGTH ("Box_no")))),0) AS "boxno" FROM ad_tableid;

                OPEN p_accounts1 FOR SELECT "Box_Charges_Native","Box_Charges_Type" FROM box_mast
                WHERE "Box_Code" = no1 AND "Comp_Code" = compcode;

               -- idcou := idcou + 1;
               
                select nvl(MAX(TO_NUMBER(SUBSTR("Box_no",3,LENGTH ("Box_no")))),0) + 1 into idcou from ad_tableid ;
                if nvl(save_val,'?')='S' then
                   UPDATE ad_tableid SET "Box_no" = auto1 || TO_CHAR (idcou);
                   commit;
                end if;   
             ELSE
                INSERT INTO ad_tableid ("Box_no")  VALUES (auto1 || '1');

                OPEN p_accounts FOR SELECT MAX(TO_NUMBER(SUBSTR("Box_no",3,LENGTH ("Box_no")))) AS "boxno" FROM ad_tableid;

                OPEN p_accounts1 FOR SELECT "Box_Charges_Native","Box_Charges_Type" FROM box_mast
                           WHERE "Box_Code" = no1 AND "Comp_Code" = compcode;
             END IF;
         else
                 OPEN p_accounts FOR select 'a' from dual;
                 OPEN p_accounts1 FOR select 'a' from dual; 
         end if;
         IF fatchboxadd = '' THEN
                 select count(*) into countnum from pub_cent_box_add where centercode=center1;
                 if(center1 is not null) then
                    if countnum>0 then
                      OPEN p_accounts2 FOR
                        select ENGLISH_BOX,HINDI_BOX,PUNJABI_BOX from pub_cent_box_add where CENTERCODE=center1;
                    else
                    OPEN p_accounts2 FOR
                         select BOXADDRESS,BOXADDRESS,BOXADDRESS from pub_cent_mast where "Pub_cent_Code"=center1;    
                    end if;
                  
                 else
                    OPEN p_accounts2 FOR
                    select BOXADDRESS from pub_cent_mast where "City_Code"=(select "City_Code" from agency_mast where "code_subcode"=agency_codescode);
                end if;
        ELSE
                OPEN p_accounts2 FOR
                 select BOX_ADDRESS AS BOXADDRESS from branch_mst where "Branch_Code"=branch and "Comp_Code"=compcode;        
        END IF;
      end getautocodebox_p;
end getautocodebox;
/


/*************mimoh 6196*************************************************/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@bhanu 17/01/2012@@@@@@@@@@@@@@@@@@@@@@@@@@@


CREATE OR REPLACE PACKAGE Executebookingdisp
IS
  TYPE T_Accounts_Cursor IS REF CURSOR;
  PROCEDURE executebookingdisp_p(
  compcode IN VARCHAR2,
  ciobookid IN VARCHAR2,
  docno IN VARCHAR2:=NULL,
  keyno IN VARCHAR2:=NULL,
  rono IN VARCHAR2:=NULL,
  agencycode IN VARCHAR2:=NULL,
  client IN VARCHAR2:=NULL,
  booking IN VARCHAR2,dateformat IN VARCHAR2,
  revenue in varchar2,
  P_Accounts  OUT  T_Accounts_Cursor,P_Accounts1  OUT  T_Accounts_Cursor,P_Accounts2  OUT  T_Accounts_Cursor,
  P_Accounts3  OUT  T_Accounts_Cursor);
END Executebookingdisp ;
/



CREATE OR REPLACE PACKAGE BODY Executebookingdisp
IS
   PROCEDURE executebookingdisp_p (
      compcode      IN       VARCHAR2,
      ciobookid     IN       VARCHAR2,
      docno         IN       VARCHAR2 := NULL,
      keyno         IN       VARCHAR2 := NULL,
      rono          IN       VARCHAR2 := NULL,
      agencycode    IN       VARCHAR2 := NULL,
      client        IN       VARCHAR2 := NULL,
      booking       IN       VARCHAR2,
      dateformat     IN          VARCHAR2,
      revenue in varchar2,
      p_accounts    OUT      t_accounts_cursor,
      p_accounts1   OUT      t_accounts_cursor,
      p_accounts2   OUT      t_accounts_cursor,
      P_Accounts3  OUT  T_Accounts_Cursor
    
   )
   AS
      VERSION1   NUMBER;
      count1    NUMBER;

   BEGIN

       DELETE FROM TEMPBOOKING_MAST;
        
      INSERT INTO TEMPBOOKING_MAST
         SELECT "date_time", "branch", "booked_by", "cio_booking_id",
                "prev_booking", "applied_by", "audit", "RO_No", "RO_Date",
                "Caption", "bill_status", "ro_status", "Agency_code",
                "Agency_address", "Client_code", "Client_address",
                "Agency_sub_code", "Dockit_no", "Executive_code",
                "Executive_zone", "Product_code", "Brand_code", "Key_no",
                "Bill_remarks", "Print_remark", "Package_code",
                "No_of_insertion", "Insertion_date", "Repeating_day",
                "Ad_type_code", "Ad_cat_code", "Ad_sub_cat_code",
                "Color_code", "Uom_code", "Page_position_code",
                "Page_type_code", "Page_no", "Ad_size_type_code",
                "Ad_size_height", "Ad_size_width", "Rate_code",
                "Scheme_type_code", "Currency_code", NVL("Agrred_rate",'0'),
                NVL("Agreed_amount",'0'), "Special_discount", "Space_discount",
                "Special_charges", "Agency_status", "Agency_type",
                "Agency_pay", "Agency_credit", "Total_area", "Card_rate",
                "Card_amount", NVL("Discount",'0'), "Discount_per", "Bill_cycle",
                "Revenue_center", "Bill_pay", "Bill_height", "Bill_width",
                "Bill_to", "Invoices", "Vts", "Bill_add", "Trade_disc",
                "Agency_out", "Box_code", "Box_no", "Box_agency",
                "Box_client", "Box_address", "Comp_code", "Userid",
                "Creation_datetime", "Booking_type", "Tfn", "Coupan_ad",
                "Campaign", "Bill_amount", "Page_prem", "Page_amount",
                "Prem_per", "Gross_amount", "Ad_size_column", "Bill_column",
                "Bill_area", "Special_disc_per", "Space_disc_per",
                "Paid_ins", "Contract_rate", "Deviation", "Variant_code",
                "Contract_name", "Contract_type", "Card_name", "Card_type",
                "Card_month", "Card_year", "Card_number", "Receipt_no",
                "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color",
                "Bullet_code", "Bullet_premium", "Material_status",
                TRUNC("Receipt_date"), "prev_cioid", "prev_receipt",
                "prev_grossamt", "Region", "Variant", "Colortype", "Logo_H",
                "Logo_W", "Logo_color", "Logo_Uom",sapid,RETAINER,"ADD_AGENCY_COMM",MOBILENO,ADD_AGENCY_COMM_AMT,RETAINER_COMM,RETAINER_COMM_AMT,CASH_RECIEVED,
                CIRAGENCY,CIRRATE,CIREDITION,CIRPUBLICATION,CIRAGENCY_SUBCODE,BARTER_TYPE,CASHDISCOUNT, CASHDISCTYPE, ATTACHMENT1, ATTACHMENT2, DISC_PREMIUM, CHKTRADEDISC,
                CHK_DATE, CHK_AMT, CHK_BANK_NAME, OUR_BANK, CHK_NO,DEALERPANEL, DEALER_H, DEALER_W, DEALERTYPE,ACTIVE_AGREEDRATE,ACTIVE_AGREEDAMT,
                LOCALGROSSAMT,LOCALBILLAMT,PACKAGE_TYPE, AD_REFID, RECEIPT_CURRENCY, CONV_CURR_RATE,REVISE_DATE,CLIENT_TYPE
           FROM TBL_BOOKING_MAST
          WHERE ("Comp_code" = compcode OR compcode IS NULL)
            AND (("cio_booking_id" = ciobookid OR ciobookid IS NULL
                ) OR("Receipt_no"=ciobookid OR ciobookid IS NULL))
            AND ("Dockit_no" = docno  OR docno IS NULL)
            AND ("Key_no" = keyno  OR keyno IS NULL)
            AND ("RO_No" = rono  OR rono IS NULL)
            AND ("Agency_sub_code" LIKE agencycode || '%'
                 OR agencycode IS NULL
                )
            AND ("Client_code" LIKE client || '%' OR client IS NULL)
            AND ("Ad_type_code" = booking  OR booking IS NULL)
            AND "branch" in(SELECT LTRIM(RTRIM(BRANCH_CODE)) FROM LOGIN_BRANCH_MAST WHERE USER_CODE=revenue and COMP_CODE=compcode and USER_FLAG='Y')
         --AND "branch"=revenue 
            ;

  -- Dbms_output.put_line('rinki--');
      OPEN p_accounts FOR
      SELECT CASE dateformat
                     WHEN 'mm/dd/yyyy' THEN TO_CHAR("date_time",'mm/dd/yyyy')
                  WHEN 'dd/mm/yyyy' THEN TO_CHAR("date_time",'dd/mm/yyyy')
                     WHEN 'yyyy/mm/dd' THEN TO_CHAR("date_time",'yyyy/mm/dd')  END AS date_time,
                     "branch",(select "Branch_Name" from branch_mst where "Branch_Code"="branch") as "BRANCH_NAME",
                     "booked_by", "cio_booking_id", "prev_booking", "applied_by","audit", "RO_No",
            CASE dateformat
                 WHEN 'mm/dd/yyyy' THEN TO_CHAR("RO_Date",'mm/dd/yyyy')
                 WHEN 'dd/mm/yyyy' THEN TO_CHAR("RO_Date",'dd/mm/yyyy')
                 WHEN 'yyyy/mm/dd' THEN TO_CHAR("RO_Date",'yyyy/mm/dd')  END AS "RO_Date",
                  TO_CHAR("RO_Date", 'dd/mm/yyyy') AS "RO_Date",
                "Caption", "bill_status", "ro_status", "Agency_code",
                "Agency_address", "Client_code", "Client_address",
                "Agency_sub_code", "Dockit_no", "Executive_code",
                "Executive_zone", "Product_code", "Brand_code", "Key_no",
                "Bill_remarks", "Print_remark", "Package_code","No_of_insertion",
            CASE dateformat
                    WHEN 'mm/dd/yyyy' THEN TO_CHAR("Insertion_date",'mm/dd/yyyy')
                    WHEN 'dd/mm/yyyy' THEN TO_CHAR("Insertion_date",'dd/mm/yyyy')
                    WHEN 'yyyy/mm/dd' THEN TO_CHAR("Insertion_date",'yyyy/mm/dd')  END    AS "Insertion_date",
                "Repeating_day", "Ad_type_code", "Ad_cat_code",
                "Ad_sub_cat_code", "Color_code", "Uom_code",
                "Page_position_code", "Page_type_code", "Page_no",
                "Ad_size_type_code", "Ad_size_height", "Ad_size_width", "Rate_code",
                (SELECT "Scheme_Name" FROM SCHEME_MASTER WHERE "Comp_code"=compcode and "scheme_id" =TEMPBOOKING_MAST."Scheme_type_code")AS "Scheme_type_code",
                 "Currency_code", "Agrred_rate", "Agreed_amount",
                "Special_discount", "Space_discount", "Special_charges",
                TEMPBOOKING_MAST."Comp_code", TEMPBOOKING_MAST."Userid",
                TEMPBOOKING_MAST."Agency_status", "Agency_type", "Agency_pay",
                "Agency_credit", "Total_area", "Card_rate", "Card_amount",
                "Discount", "Discount_per", "Bill_cycle", "Revenue_center",
                "Bill_pay", "Bill_height", "Bill_width",
                TEMPBOOKING_MAST."Bill_to", "Invoices", "Vts", "Bill_add",
                "Trade_disc", "Agency_out", "Booking_type", "Campaign",
                "Page_prem", "Page_amount", "Prem_per", "Gross_amount",
                "Bill_amount", "Box_code", "Box_no", "Box_agency",
                "Box_client", "Box_address", "Tfn", "Coupan_ad",
                "Ad_size_column", "Bill_column", "Bill_area",
                "Special_disc_per", "Space_disc_per",
                AGENCY_MAST."Agency_Name" || '(' || AGENCY_MAST."code_subcode" || ')' AS "AgencyName",
                (SELECT EXEC_MAST."Exec_name" || '(' || TO_CHAR(EXEC_MAST."Exe_no") || ')' FROM EXEC_MAST
                  WHERE TEMPBOOKING_MAST."Executive_code" = EXEC_MAST."Exe_no"
                    AND TEMPBOOKING_MAST."Comp_code" = EXEC_MAST."comp_code" and TEMPBOOKING_MAST."Comp_code"=compcode) AS "execname",
                    --91
                (SELECT  PRODUCT_CAT_MAST."prod_desc" || '(' || PRODUCT_CAT_MAST."prod_cat_code" || ')' FROM PRODUCT_CAT_MAST
                  WHERE TEMPBOOKING_MAST."Product_code" = PRODUCT_CAT_MAST."prod_cat_code"
                    AND TEMPBOOKING_MAST."Comp_code" = PRODUCT_CAT_MAST."comp_code" and TEMPBOOKING_MAST."Comp_code"=compcode) AS "product",
                    --92
                "Paid_ins", "Contract_rate", "Deviation", "Variant_code",
                 (select "deal_name" from contract_mast where "Deal_No"= (select "deal_code" from contract_detail where "ContractCode"= "Contract_name")) as "Contract_name", "Contract_type", "Card_name", "Card_type",
                --100
                "Card_month", "Card_year", "Card_number", "Receipt_no",
                "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color",
                "Bullet_code", "Bullet_premium",
                (SELECT "Agency_Name" FROM AGENCY_MAST WHERE "code_subcode" =TEMPBOOKING_MAST."Agency_sub_code" and agency_mast."Comp_Code"=compcode) AS "AgencySubCode",
              --111
                NVL ((SELECT DISTINCT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code" = "Client_code" and "Comp_Code"=compcode), '') AS "Client",                                       --112
                (SELECT DISTINCT "Payment_Mode_Name" FROM PAYMENT_MODE_MAST WHERE "Pay_Mode_Code" = "Agency_pay" and "Comp_Code"=compcode) AS "PayMode",
                (SELECT DISTINCT "Adv_Cat_Name" FROM ADV_CAT_MAST WHERE ADV_CAT_MAST."Adv_Cat_Code" =TEMPBOOKING_MAST."Ad_cat_code" and "Comp_Code"=compcode) AS "categoryname",
                (SELECT DISTINCT "Adv_Subcat_Name" FROM ADV_SUBCAT_MAST  WHERE ADV_SUBCAT_MAST."Adv_Subcat_Code" =TEMPBOOKING_MAST."Ad_sub_cat_code" and "Comp_Code"=compcode)
                 AS "subcategoryname",
                (SELECT DISTINCT "brand_name" FROM BRAND_MST WHERE "brand_code" =TEMPBOOKING_MAST."Brand_code" and "comp_code"=compcode) AS "Brand",
                (SELECT DISTINCT "Uom_Name" FROM UOM_MAST WHERE "Uom_Code" = TEMPBOOKING_MAST."Uom_code" and "Comp_Code"=compcode) AS "UOM",
                (SELECT "premiumname" FROM ADVPOS_PREM_MAST WHERE "Premiumcode" =TEMPBOOKING_MAST."Page_prem" and "comp_code"=compcode) AS "PagePremium",
                 (SELECT DISTINCT "Pos_Type" FROM ADVPOS_TYPE_MAST
                  WHERE "Pos_Type_Code" = TEMPBOOKING_MAST."Page_position_code" and "Comp_Code"=compcode) AS "PositionPremium",
                (SELECT DISTINCT "Curr_Name" FROM CURR_MAST WHERE "Curr_Code" = TEMPBOOKING_MAST."Currency_code" and "Comp_Code"=compcode) AS "Currency",
                "Material_status", TO_CHAR("Receipt_date",'dd/mm/yyyy') AS "Receipt_date", TEMPBOOKING_MAST."Region",
                "Variant", "Colortype",
                (SELECT DISTINCT "UOM_DESC" FROM UOM_MAST WHERE "Uom_Code" = TEMPBOOKING_MAST."Uom_code" and "Comp_Code"=compcode) AS "uom_desc",
                (SELECT DISTINCT "Logo" FROM UOM_MAST WHERE "Uom_Code" = TEMPBOOKING_MAST."Uom_code" and "Comp_Code"=compcode) AS "logo","Logo_H", "Logo_W", "Logo_color", "Logo_Uom",
                (SELECT DISTINCT "Logo_Uom" FROM UOM_MAST WHERE "Uom_Code" = TEMPBOOKING_MAST."Uom_code" and "Comp_Code"=compcode)  AS "logocode",
                (SELECT DISTINCT "Box_Charges_Native" FROM BOX_MAST WHERE BOX_MAST."Box_Code"=TEMPBOOKING_MAST."Box_code" and "Comp_Code"=compcode) AS "boxchrg",TEMPBOOKING_MAST.sapid,
                retainer,(SELECT "Retain_Name"||'('||"Retain_Code"||')' FROM RETAINERMASTER WHERE RETAINERMASTER."Retain_Code"=TEMPBOOKING_MAST.RETAINER and "Comp_Code"=compcode) AS "RETAINER1",
                (SELECT DISTINCT "Package_Name" FROM combin_mast WHERE "Combin_Code" =

                TEMPBOOKING_MAST."Package_code" and "Comp_Code"=compcode) as "Package_cod",(SELECT DISTINCT "Col_Name" FROM col_mast WHERE "Col_Code" = TEMPBOOKING_MAST."Color_code" and "Comp_Code"=compcode) as

                "Color_cod",(SELECT DISTINCT "Pos_Type" FROM advpos_type_mast WHERE "Pos_Type_Code" =

                TEMPBOOKING_MAST."Page_position_code" and "Comp_Code"=compcode) as "Page_position_cod",
                decode(TEMPBOOKING_MAST."Booking_type",'1','BARTER','2','FMG','3','NORMAL','4','INHOUSE') as "Book_type",
                (SELECT DISTINCT "catname"  FROM  AD_CAT3   WHERE

                AD_CAT3."catcode"=TEMPBOOKING_MAST."Ad_Subcat3" and "compcode"=compcode)  as "Subcat3",(SELECT DISTINCT "Cat_Name"  FROM  TBL_CAT4   WHERE

                TBL_CAT4."Cat_Code"=TEMPBOOKING_MAST."Ad_Subcat4" and "Comp_Code"=compcode) as "Subcat4",(SELECT DISTINCT "Cat_Name"  FROM  TBL_CAT5   WHERE

                TBL_CAT5."Cat_Code"=TEMPBOOKING_MAST."Ad_subcat5" and "Comp_Code"=compcode) as "subcat5",(SELECT DISTINCT "Comm_Rate" FROM ret_comm_details WHERE

                ret_comm_details."Retain_Code"=TEMPBOOKING_MAST.RETAINER and "Comp_code"=compcode and rowid=(select max(rowid) from ret_comm_details where ret_comm_details."Retain_Code"=TEMPBOOKING_MAST.RETAINER and "Comp_code"=compcode)) AS "RETAINER_COMM",(select AUDIT_COMMENT from tbl_booking_mast where tbl_booking_mast."cio_booking_id"=TEMPBOOKING_MAST."cio_booking_id" and tbl_booking_mast."Comp_code"=compcode) as "remarks","ADD_AGENCY_COMM",
                 (SELECT DISTINCT "Box_Charges_Type" FROM BOX_MAST WHERE BOX_MAST."Box_Code"=TEMPBOOKING_MAST."Box_code" and "Comp_code"=compcode) AS "boxchargetype",
                 ADD_AGENCY_COMM_AMT,RETAINER_COMM,RETAINER_COMM_AMT,TEMPBOOKING_MAST."Scheme_type_code" as "SCHEMEID",TEMPBOOKING_MAST.CASH_RECIEVED,
                 (select DISTINCT "pub_center" from branch_mst where "Branch_Code"=tempbooking_mast."branch" and "Comp_Code"=compcode) as "pub_center",
                  CIRAGENCY,CIRRATE,CIREDITION,CIRPUBLICATION,CIRAGENCY_SUBCODE,BARTERTYPE,(SELECT BARTE_DESC FROM AD_BARTER WHERE COMP_CODE=compcode AND BARTER_CODE=TEMPBOOKING_MAST.BARTERTYPE) AS BARTE_DESC,
                  (SELECT DISTINCT BARTER_AMOUNT FROM AD_BARTER WHERE COMP_CODE=compcode AND  BARTER_CODE=TEMPBOOKING_MAST.BARTERTYPE) AS BARTE_AMOUNT,
                  (SELECT DISTINCT ADDITIONAL_FLAG  FROM COMM_DETAILS WHERE "Agency_code"||"Agency_sub_code"=TEMPBOOKING_MAST."Agency_sub_code"
                 and "Comp_Code"=upper(compcode) and SYSDATE between "Eff_from_Date" and "Eff_Till_Date" AND ROWNUM<=1) AS ADDFLAG,
                  CASHDISCOUNT, CASHDISCTYPE, ATTACHMENT1, ATTACHMENT2, DISC_PREMIUM, CHKTRADE, CASE dateformat
                                     WHEN 'mm/dd/yyyy' THEN TO_CHAR(CHK_DATE,'mm/dd/yyyy')
                                  WHEN 'dd/mm/yyyy' THEN TO_CHAR(CHK_DATE,'dd/mm/yyyy')
                                     WHEN 'yyyy/mm/dd' THEN TO_CHAR(CHK_DATE,'yyyy/mm/dd')  END as CHK_DATE, CHK_AMT, CHK_BANK_NAME, OUR_BANK, CHK_NO, agency_mast.BOOKING_TYPE,
                                     DEALERPANEL, DEALER_H, DEALER_W, DEALERTYPE,MOBILENO,
                                     (select "Comm_Rate" from comm_details where "Agency_code" || "Agency_sub_code"=TEMPBOOKING_MAST."Agency_sub_code"
                 and "Comp_Code"=upper(compcode) and SYSDATE between "Eff_from_Date" and "Eff_Till_Date" AND ROWNUM<=1 ) as COMM_RATE,ACTIVE_AGREEDRATE,ACTIVE_AGREEDAMT, NVL(LOCALGROSSAMT,"Gross_amount") as LOCALGROSSAMT, NVL(LOCALBILLAMT,"Bill_amount") as LOCALBILLAMT, RECEIPT_CURRENCY, CONV_CURR_RATE,
                 CASE dateformat
                         WHEN 'mm/dd/yyyy' THEN TO_CHAR("REVISE_DATE",'mm/dd/yyyy')
                         WHEN 'dd/mm/yyyy' THEN TO_CHAR("REVISE_DATE",'dd/mm/yyyy')
                         WHEN 'yyyy/mm/dd' THEN TO_CHAR("REVISE_DATE",'yyyy/mm/dd')  END AS "REVISE_DATE",CLIENT_TYPE,
                         
                         CASE dateformat
                         WHEN 'mm/dd/yyyy' THEN TO_CHAR("Creation_datetime",'mm/dd/yyyy hh:mi:ss')
                         WHEN 'dd/mm/yyyy' THEN TO_CHAR("Creation_datetime",'dd/mm/yyyy hh:mi:ss')
                         WHEN 'yyyy/mm/dd' THEN TO_CHAR("Creation_datetime",'yyyy/mm/dd hh:mi:ss') END                        
                          as CREATION_DATETIME
/*for Display and classified*/
           FROM TEMPBOOKING_MAST, AGENCY_MAST
          WHERE AGENCY_MAST."code_subcode" =
                                            TEMPBOOKING_MAST."Agency_sub_code"
            AND AGENCY_MAST."Comp_Code" = compcode ORDER BY "Creation_datetime";


      Dbms_output.put_line('rinki--');
----------------------------------------------------Lata------------------------------------------------------

      OPEN p_accounts1 FOR
      SELECT 'A' AS A FROM DUAL;
    /*     SELECT NVL(COUNT (*),'0') AS "count"
                     FROM TBL_BOOKING_MAST_LOG WHERE "Receipt_no" = ciobookid AND "audit" IS NOT NULL;

      BEGIN
         SELECT MAX (VSEQNO) INTO VERSION1 FROM TBL_BOOKING_MAST_LOG
          WHERE "Receipt_no" = ciobookid AND VSEQNO < (SELECT MAX (VSEQNO) FROM TBL_BOOKING_MAST_LOG WHERE "Receipt_no" = ciobookid);
            EXCEPTION WHEN NO_DATA_FOUND THEN NULL;
      END;
*/
      OPEN p_accounts2 FOR
      SELECT 'A' AS A FROM DUAL;
         /*SELECT    CASE dateformat
                     WHEN 'mm/dd/yyyy' THEN TO_CHAR("date_time",'mm/dd/yyyy')
                  WHEN 'dd/mm/yyyy' THEN TO_CHAR("date_time",'dd/mm/yyyy')
                     WHEN 'yyyy/mm/dd' THEN TO_CHAR("date_time",'yyyy/mm/dd')  END AS "date_time",
                 "branch", "booked_by", "cio_booking_id", "prev_booking", "applied_by","audit", "RO_No",
               CASE dateformat
                     WHEN 'mm/dd/yyyy' THEN TO_CHAR("RO_Date",'mm/dd/yyyy')
                  WHEN 'dd/mm/yyyy' THEN TO_CHAR("RO_Date",'dd/mm/yyyy')
                     WHEN 'yyyy/mm/dd' THEN TO_CHAR("RO_Date",'yyyy/mm/dd')  END AS "RO_Date",
                "Caption","bill_status", "ro_status",
                TBL_BOOKING_MAST_LOG."Agency_code", "Agency_address",
                "Client_code", "Client_address", "Agency_sub_code",
                "Dockit_no", "Executive_code", "Executive_zone",
                "Product_code", "Brand_code", "Key_no", "Bill_remarks",
                "Print_remark", "Package_code", "No_of_insertion",
            CASE dateformat
                     WHEN 'mm/dd/yyyy' THEN TO_CHAR("Insertion_date",'mm/dd/yyyy')
                  WHEN 'dd/mm/yyyy' THEN TO_CHAR("Insertion_date",'dd/mm/yyyy')
                     WHEN 'yyyy/mm/dd' THEN TO_CHAR("Insertion_date",'yyyy/mm/dd')  END AS "Insertion_date",
               -- TO_CHAR ("Insertion_date", 'dd/mm/yyyy') AS "Insertion_date",
                "Repeating_day", "Ad_type_code", "Ad_cat_code",
                "Ad_sub_cat_code", "Color_code", "Uom_code",
                "Page_position_code", "Page_type_code", "Page_no",
                "Ad_size_type_code", "Ad_size_height", "Ad_size_width",
                "Rate_code", "Scheme_type_code", "Currency_code",
                "Agrred_rate", "Agreed_amount", "Special_discount",
                "Space_discount", "Special_charges",
                TBL_BOOKING_MAST_LOG."Comp_code",
                TBL_BOOKING_MAST_LOG."Userid",
                TBL_BOOKING_MAST_LOG."Agency_status", "Agency_type",
                "Agency_pay", "Agency_credit", "Total_area", "Card_rate",
                "Card_amount", "Discount", "Discount_per", "Bill_cycle",
                "Revenue_center", "Bill_pay", "Bill_height", "Bill_width",
                TBL_BOOKING_MAST_LOG."Bill_to", "Invoices", "Vts",
                "Bill_add", "Trade_disc", "Agency_out", "Booking_type",
                "Campaign", "Page_prem", "Page_amount", "Prem_per",
                "Gross_amount", "Bill_amount", "Box_code", "Box_no",
                "Box_agency", "Box_client", "Box_address", "Tfn" "Coupan_ad",
                "Ad_size_column", "Bill_column", "Bill_area",
                "Special_disc_per", "Space_disc_per",
                  AGENCY_MAST."Agency_Name"|| '('|| AGENCY_MAST."code_subcode"|| ')' AS "AgencyName",
                   (SELECT    EXEC_MAST."Exec_name" || '('|| TO_CHAR (EXEC_MAST."Exe_no") || ')'
                   FROM EXEC_MAST  WHERE TBL_BOOKING_MAST_LOG."Executive_code" =EXEC_MAST."Exe_no"
                    AND TBL_BOOKING_MAST_LOG."Comp_code" =EXEC_MAST."comp_code" and "comp_code"=compcode)AS "execname",
               (SELECT    PRODUCT_CAT_MAST."prod_desc"|| '('|| PRODUCT_CAT_MAST."prod_cat_code" || ')'
                   FROM PRODUCT_CAT_MAST WHERE TBL_BOOKING_MAST_LOG."Product_code" =PRODUCT_CAT_MAST."prod_cat_code"
                    AND TBL_BOOKING_MAST_LOG."Comp_code" =PRODUCT_CAT_MAST."comp_code")                                                                 AS "product",
                "Paid_ins", "Contract_rate", "Deviation", "Variant_code",
                "Contract_name", "Contract_type", "Card_name", "Card_type",
                "Card_month", "Card_year", "Card_number", "Receipt_no",
                "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color",
                (SELECT "Agency_Name" FROM AGENCY_MAST WHERE "code_subcode" = TBL_BOOKING_MAST_LOG."Agency_sub_code" and "Comp_Code"=compcode)AS "AgencySubCode",
               NVL ((SELECT "Cust_Name"  FROM CUST_MAST WHERE "Cust_Code" = "Client_code" and "Comp_Code"=compcode),'' ) AS "Client",
              (SELECT "Payment_Mode_Name"  FROM PAYMENT_MODE_MAST WHERE "Pay_Mode_Code" = "Agency_pay" and "Comp_Code"=compcode) AS "PayMode",
               (SELECT "Adv_Cat_Name" FROM ADV_CAT_MAST WHERE ADV_CAT_MAST."Adv_Cat_Code" =TBL_BOOKING_MAST_LOG."Ad_cat_code" and "Comp_Code"=compcode)AS "categoryname",
               (SELECT "Adv_Subcat_Name"  FROM ADV_SUBCAT_MAST WHERE ADV_SUBCAT_MAST."Adv_Subcat_Code" =TBL_BOOKING_MAST_LOG."Ad_sub_cat_code" and "Comp_Code"=compcode)
                 AS "subcategoryname",
               (SELECT "brand_name"  FROM BRAND_MST   WHERE "brand_code" = TBL_BOOKING_MAST_LOG."Brand_code" and "comp_code"=compcode)AS "Brand",
               (SELECT "Uom_Name" FROM UOM_MAST WHERE "Uom_Code" =TBL_BOOKING_MAST_LOG."Uom_code" and "Comp_Code"=compcode)AS "UOM",
               (SELECT "premiumname" FROM ADVPOS_PREM_MAST WHERE "Premiumcode" =TBL_BOOKING_MAST_LOG."Page_type_code" and "comp_code"=compcode)AS "PagePremium",
                (SELECT "Pos_Type" FROM ADVPOS_TYPE_MAST WHERE "Pos_Type_Code" =TBL_BOOKING_MAST_LOG."Page_position_code" and "Comp_Code"=compcode)AS "PositionPremium",
               (SELECT "Curr_Name"  FROM CURR_MAST WHERE "Curr_Code" =TBL_BOOKING_MAST_LOG."Currency_code" and "Comp_Code"=compcode) AS "Currency"
           FROM TBL_BOOKING_MAST_LOG, AGENCY_MAST
             WHERE TBL_BOOKING_MAST_LOG."Receipt_no" = ciobookid
            AND VSEQNO = VERSION1
            AND AGENCY_MAST."code_subcode" =
                                    TBL_BOOKING_MAST_LOG."Agency_sub_code"
            AND AGENCY_MAST."Comp_Code" = compcode;
*/
      OPEN p_accounts3 FOR
      SELECT 'A' AS A FROM DUAL;
--select * from tbl_booking_mast_log where cio_booking_id=@ciobookid and version=@version
      /*   SELECT    CASE dateformat
                     WHEN 'mm/dd/yyyy' THEN TO_CHAR("date_time",'mm/dd/yyyy')
                  WHEN 'dd/mm/yyyy' THEN TO_CHAR("date_time",'dd/mm/yyyy')
                     WHEN 'yyyy/mm/dd' THEN TO_CHAR("date_time",'yyyy/mm/dd')  END AS "date_time",
                   "branch","booked_by", "cio_booking_id", "prev_booking", "applied_by","audit", "RO_No",
              CASE dateformat
                     WHEN 'mm/dd/yyyy' THEN TO_CHAR("RO_Date",'mm/dd/yyyy')
                  WHEN 'dd/mm/yyyy' THEN TO_CHAR("RO_Date",'dd/mm/yyyy')
                     WHEN 'yyyy/mm/dd' THEN TO_CHAR("RO_Date",'yyyy/mm/dd')  END AS "RO_Date",
                "Caption","bill_status", "ro_status",
                TBL_BOOKING_MAST_LOG."Agency_code", "Agency_address",
                "Client_code", "Client_address", "Agency_sub_code",
                "Dockit_no", "Executive_code", "Executive_zone",
                "Product_code", "Brand_code", "Key_no", "Bill_remarks",
                "Print_remark", "Package_code", "No_of_insertion",
            CASE dateformat
                     WHEN 'mm/dd/yyyy' THEN TO_CHAR("Insertion_date",'mm/dd/yyyy')
                  WHEN 'dd/mm/yyyy' THEN TO_CHAR("Insertion_date",'dd/mm/yyyy')
                     WHEN 'yyyy/mm/dd' THEN TO_CHAR("Insertion_date",'yyyy/mm/dd')  END AS "Insertion_date",
                "Repeating_day", "Ad_type_code", "Ad_cat_code",
                "Ad_sub_cat_code", "Color_code", "Uom_code",
                "Page_position_code", "Page_type_code", "Page_no",
                "Ad_size_type_code", "Ad_size_height", "Ad_size_width",
                "Rate_code", "Scheme_type_code", "Currency_code",
                "Agrred_rate", "Agreed_amount", "Special_discount",
                "Space_discount", "Special_charges",
                TBL_BOOKING_MAST_LOG."Comp_code",
                TBL_BOOKING_MAST_LOG."Userid",
                TBL_BOOKING_MAST_LOG."Agency_status", "Agency_type",
                "Agency_pay", "Agency_credit", "Total_area", "Card_rate",
                "Card_amount", "Discount", "Discount_per", "Bill_cycle",
                "Revenue_center", "Bill_pay", "Bill_height", "Bill_width",
                TBL_BOOKING_MAST_LOG."Bill_to", "Invoices", "Vts",
                "Bill_add", "Trade_disc", "Agency_out", "Booking_type",
                "Campaign", "Page_prem", "Page_amount", "Prem_per",
                "Gross_amount", "Bill_amount", "Box_code", "Box_no",
                "Box_agency", "Box_client", "Box_address", "Tfn", "Coupan_ad",
                "Ad_size_column", "Bill_column", "Bill_area",
                "Special_disc_per", "Space_disc_per",
                 AGENCY_MAST."Agency_Name" || '('|| AGENCY_MAST."code_subcode"|| ')' AS "AgencyName",
                (SELECT    EXEC_MAST."Exec_name" || '('|| TO_CHAR (EXEC_MAST."Exe_no")|| ')'
                   FROM EXEC_MAST  WHERE TBL_BOOKING_MAST_LOG."Executive_code" = EXEC_MAST."Exe_no"
                    AND TBL_BOOKING_MAST_LOG."Comp_code" = EXEC_MAST."comp_code")AS "execname",
                (SELECT    PRODUCT_CAT_MAST."prod_desc" || '(' || PRODUCT_CAT_MAST."prod_cat_code" || ')'
                   FROM PRODUCT_CAT_MAST WHERE TBL_BOOKING_MAST_LOG."Product_code" =PRODUCT_CAT_MAST."prod_cat_code"
                    AND TBL_BOOKING_MAST_LOG."Comp_code" =PRODUCT_CAT_MAST."comp_code")AS "product",
                "Paid_ins", "Contract_rate", "Deviation", "Variant_code",
                "Contract_name", "Contract_type", "Card_name", "Card_type",
                "Card_month", "Card_year", "Card_number", "Receipt_no",
                "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color",
                "Bullet_code", "Bullet_premium",
                (SELECT "Agency_Name" FROM AGENCY_MAST WHERE "code_subcode" =TBL_BOOKING_MAST_LOG."Agency_sub_code" and "Comp_Code"=compcode)AS "AgencySubCode",
                NVL ((SELECT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code" = "Client_code" and "Comp_Code"=compcode),'' ) AS "Client",
                (SELECT "Payment_Mode_Name" FROM PAYMENT_MODE_MAST WHERE "Pay_Mode_Code" = "Agency_pay" and "Comp_Code"=compcode) AS "PayMode",
                (SELECT "Adv_Cat_Name" FROM ADV_CAT_MAST WHERE ADV_CAT_MAST."Adv_Cat_Code" =TBL_BOOKING_MAST_LOG."Ad_cat_code" and "Comp_Code"=compcode)AS "categoryname",
                (SELECT "Adv_Subcat_Name" FROM ADV_SUBCAT_MAST WHERE ADV_SUBCAT_MAST."Adv_Subcat_Code" =TBL_BOOKING_MAST_LOG."Ad_sub_cat_code" and "Comp_Code"=compcode)AS "subcategoryname",
                (SELECT "brand_name" FROM BRAND_MST WHERE "brand_code" =TBL_BOOKING_MAST_LOG."Brand_code" and "comp_code"=compcode)AS "Brand",
                (SELECT "Uom_Name" FROM UOM_MAST WHERE "Uom_Code" =TBL_BOOKING_MAST_LOG."Uom_code" and "Comp_Code"=compcode)AS "UOM",
                (SELECT "premiumname" FROM ADVPOS_PREM_MAST  WHERE "Premiumcode" =TBL_BOOKING_MAST_LOG."Page_type_code" and "comp_code"=compcode)AS "PagePremium",
                (SELECT "Pos_Type" FROM ADVPOS_TYPE_MAST WHERE "Pos_Type_Code" = TBL_BOOKING_MAST_LOG."Page_position_code" and "Comp_Code"=compcode)AS "PositionPremium",
                (SELECT "Curr_Name" FROM CURR_MAST WHERE "Curr_Code" =TBL_BOOKING_MAST_LOG."Currency_code" and "Comp_Code"=compcode)AS "Currency"
           FROM TBL_BOOKING_MAST_LOG, AGENCY_MAST
          WHERE TBL_BOOKING_MAST_LOG."Receipt_no" = ciobookid
            AND VSEQNO =(SELECT MAX (VSEQNO) FROM TBL_BOOKING_MAST_LOG WHERE "Receipt_no" = ciobookid AND VSEQNO <
            (SELECT MAX(VSEQNO) FROM TBL_BOOKING_MAST_LOG WHERE "Receipt_no" = ciobookid) AND "audit" IS NOT NULL)
                        AND AGENCY_MAST."code_subcode" =
             TBL_BOOKING_MAST_LOG."Agency_sub_code" AND AGENCY_MAST."Comp_Code" = compcode;
             */
            -- open P_Accounts4 for 
             -- select CASHAMOUNT as "cashreceived" from tbl_cashreceiptdetail where BOOKING_ID =ciobookid ; -- and RECEIPTNO=

   END executebookingdisp_p;
END Executebookingdisp;
/

/*********************************** issue end*****************************************************/


/*********************************** issue 6189*****************ankit*****************17 jan*******************/
CREATE OR REPLACE PACKAGE bindagencyforxls  Is
Type T_Accounts_Cursor Is Ref Cursor;

Procedure  bindagencyforxls_p (
compcode in varchar2,
agency in varchar2,

p_Accounts Out T_Accounts_Cursor);

End bindagencyforxls;
/





CREATE OR REPLACE PACKAGE BODY bindagencyforxls Is
Procedure bindagencyforxls_p(
compcode in varchar2,
agency in varchar2,
p_Accounts Out T_Accounts_Cursor)
 As

qry  varchar2(2000);
Begin
Open P_Accounts For

--select  distinct  "Agency_Code","Agency_Name","code_subcode" from Agency_mast where ("Comp_Code"=compcode) and "Agency_Name" like ''|| agency||'''%'  and ("Type"='P') order by "Agency_Name";

select  distinct  "Agency_Code","Agency_Name","code_subcode", "SUB_Agency_Code","EmailID" from Agency_mast where ("Comp_Code"=compcode) and "Agency_Name" like  '%'|| agency || '%'  and ("Type"='P') order by "Agency_Name";




End bindagencyforxls_p;

End bindagencyforxls;
/






CREATE OR REPLACE PACKAGE xlsBindexecnew
IS
   TYPE t_accounts_cursor IS REF CURSOR;
   PROCEDURE xlsBindexecnew_p (compcode IN VARCHAR2,userid IN VARCHAR2,name1 IN VARCHAR2,executive in varchar2,p_accounts OUT t_accounts_cursor);
END xlsBindexecnew;




CREATE OR REPLACE PACKAGE BODY xlsBindexecnew
IS
   PROCEDURE xlsBindexecnew_p (compcode IN VARCHAR2,
   userid IN VARCHAR2,
   name1 IN VARCHAR2,
   executive in varchar2,
   p_accounts OUT t_accounts_cursor)
   AS
   BEGIN
      OPEN p_accounts FOR
           SELECT "Exec_name", "Exe_no" FROM EXEC_MAST WHERE "comp_code" = compcode AND ("Team_code"=name1 or name1 is null) and "Exec_name" like  '%' || upper(executive) || '%' order by "Exec_name";
   END xlsBindexecnew_p;
END xlsBindexecnew;
/






CREATE OR REPLACE PACKAGE xlsRetainerbind
IS
  TYPE t_account_cursor IS REF CURSOR;
  PROCEDURE xlsRetainerbind_p(
  --Region VARCHAR2,
  Compcode VARCHAR2,
    retainer VARCHAR2,
  p_accounts OUT t_account_cursor
  );
  END xlsRetainerbind;
/




CREATE OR REPLACE PACKAGE BODY xlsRetainerbind
  IS
  PROCEDURE xlsRetainerbind_p(
  --Region VARCHAR2,
  Compcode VARCHAR2,
  retainer VARCHAR2,
  p_accounts OUT t_account_cursor
  )
  AS
  BEGIN
  OPEN p_accounts FOR
    SELECT  "Retain_Code","Retain_Name"  FROM RETAINERMASTER WHERE "Comp_Code"= Compcode and "Retain_Name" like '%' || upper(retainer) || '%' order by "Retain_Name" ;
END xlsRetainerbind_p;
END xlsRetainerbind;
/






CREATE OR REPLACE PROCEDURE Ro_Report
(pcompcode      in varchar2,
 pdateformat    in varchar2,
 puserid        in varchar2,
 chk_access     in varchar2,
 pfromdate      in varchar2,
 pdateto        in varchar2,
 pprint_cent    in varchar2,
 pagency        in varchar2,
 pbranch        in varchar2,
 pdistrict      in varchar2,
 ptaluka        in varchar2,
 pro_doc_status in varchar2,
 ppay_mode      in varchar2,
 pexecutive     in varchar2,
 pretainer      in varchar2,
 det_summry     in varchar2,
 age_exeret     in varchar2,
 pad_type       in varchar2,
 pad_cat        in varchar2,
 ptype          in varchar2,
 p_accounts     OUT Cur_Type_New1.cursor_type,
 p_accounts1    OUT Cur_Type_New1.cursor_type)
IS
query1      varchar2(10000);
vvar        varchar2(4000);
vvar_sum    varchar2(4000);
BEGIN
    if(age_exeret='1')then/*fot agency*/
        if(det_summry='1')then/*for detail*/
            query1:='select distinct a."cio_booking_id" as  "BOOKING_ID",b."Agency_Name" AS "AGENCY", 
            nvl((select EXEC_MAST."Exec_name" from exec_mast where a."Executive_code"=exec_mast."Exe_no") ,(select RETAINERMASTER."Retain_Name"  FROM  RETAINERMASTER where RETAINERMASTER."Retain_Code"=a.RETAINER )) as "EXE_RET",
            NVL((SELECT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code"="Client_code"),"Client_code")  AS "CLIENT",
            c."Adv_Cat_Name" as "Ad_Cat",
            "RO_No" AS "RONO",
            CASE "RODOCSTATUS"
            WHEN ''o'' THEN ''ORIGINAL''
            WHEN ''f'' THEN ''FAX''
            WHEN ''x'' THEN ''XEROX'' END AS "ROSTATUS",
            nvl(a."Bill_amount",''0'') as "BILLAMT",
            min(TO_CHAR(i."Insert_Date",'''||pdateformat||''')) as "Publish_Date",a.RO_COMMENT as RO_COMMENT
            from tbl_booking_mast a ,tbl_booking_insert i ,agency_mast b,adv_cat_mast c where
            a."Ad_type_code"=c."Adv_Type" and
            a."Ad_cat_code"=c."Adv_Cat_Code" and
            a."Comp_code"=c."Comp_Code" and
            a."Comp_code"='''||pcompcode||''' AND a."Comp_code"=i."Comp_Code" AND a."cio_booking_id"=i."Cio_Booking_Id" and
            a."Agency_sub_code"=b."code_subcode"';
        else/* for summary*/
            query1:='select DISTINCT b."Agency_Name" AS "AGENCY",
            b."Dist_Code"  as "DISTRICT",
            (SELECT "Branch_Name" FROM BRANCH_MST where  a."branch" = "Branch_Code") as "BRANCH",
          
            SUM(DECODE(RODOCSTATUS,''o'',1,0)) ORIGINAL
            ,SUM(DECODE(RODOCSTATUS,''f'',1,0)) FAX
            ,SUM(DECODE(RODOCSTATUS,''x'',1,0)) XEROX
            ,SUM(DECODE(RODOCSTATUS,''o'',0,''f'',0,''x'',0,1)) REMAIN
            from TBL_BOOKING_MAST a,tbl_booking_insert i ,agency_mast b/*,adv_cat_mast c*/
            where  
            a."Comp_code"='''||pcompcode||''' AND a."Comp_code"=i."Comp_Code" AND a."cio_booking_id"=i."Cio_Booking_Id" and
            a."Agency_sub_code"=b."code_subcode" and i."Insert_Status"<>''cancel''';
        end if;
    else/* for  executive/retainer*/
        if(det_summry='1')then/*for detail*/
           /* query1:='select a."cio_booking_id" as  "BOOKING_ID",
            b."Agency_Name" AS "AGENCY",
            --(select EXEC_MAST."Exec_name" from exec_mast where a."Executive_code"=exec_mast."Exe_no") AS "EXECUTIVE",
            --(select RETAINERMASTER."Retain_Name"  FROM  RETAINERMASTER where RETAINERMASTER."Retain_Code"=a.RETAINER ) AS "RETAINER",
            nvl((select EXEC_MAST."Exec_name" from exec_mast where a."Executive_code"=exec_mast."Exe_no") ,(select RETAINERMASTER."Retain_Name"  FROM  RETAINERMASTER where RETAINERMASTER."Retain_Code"=a.RETAINER )) as "EXE_RET",
            NVL((SELECT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code"="Client_code"),"Client_code")  AS "CLIENT",
            "RO_No" AS "RONO",
            CASE "RODOCSTATUS"
            WHEN ''o'' THEN ''ORIGINAL''
            WHEN ''f'' THEN ''FAX''
            WHEN ''x'' THEN ''XEROX'' END AS "ROSTATUS",
            nvl(a."Bill_amount",''0'') as "BILLAMT"
            from tbl_booking_mast a ,agency_mast b where
            a."Comp_code"='''||pcompcode||''' AND
            a."Agency_sub_code"=b."code_subcode"';*/
              if(age_exeret='2')then
            query1:='select distinct
            a."cio_booking_id" as  "BOOKING_ID",
            b."Agency_Name" AS "AGENCY",           
            EXEC_MAST."Exec_name"  as "EXE_RET",      
            NVL((SELECT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code"="Client_code"),"Client_code")  AS "CLIENT",
            c."Adv_Cat_Name" as "Ad_Cat",            
            "RO_No" AS "RONO",
            CASE "RODOCSTATUS"
            WHEN ''o'' THEN ''ORIGINAL''
            WHEN ''f'' THEN ''FAX''
            WHEN ''x'' THEN ''XEROX'' END AS "ROSTATUS",
            nvl(a."Bill_amount",''0'') as "BILLAMT",
            min(TO_CHAR(i."Insert_Date",'''||pdateformat||''')) as "Publish_Date",a.RO_COMMENT as RO_COMMENT
            from TBL_BOOKING_MAST a,tbl_booking_insert i ,EXEC_MAST,agency_mast b ,adv_cat_mast c
            where a."Ad_type_code"=c."Adv_Type" and
            a."Ad_cat_code"=c."Adv_Cat_Code" and
            a."Comp_code"=c."Comp_Code" and
            a."Comp_code"='''||pcompcode||''' AND a."Comp_code"=i."Comp_Code" AND a."cio_booking_id"=i."Cio_Booking_Id" and
            a."Executive_code"=exec_mast."Exe_no" AND 
             a."Agency_sub_code"=b."code_subcode" and i."Insert_Status"<>''cancel'' ';
         else
          query1:='select distinct
            a."cio_booking_id" as  "BOOKING_ID",
            b."Agency_Name" AS "AGENCY",  
             RETAINERMASTER."Retain_Name"     as "EXE_RET",
            NVL((SELECT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code"="Client_code"),"Client_code")  AS "CLIENT",
            c."Adv_Cat_Name" as "Ad_Cat",            
            "RO_No" AS "RONO",
            CASE "RODOCSTATUS"
            WHEN ''o'' THEN ''ORIGINAL''
            WHEN ''f'' THEN ''FAX''
            WHEN ''x'' THEN ''XEROX'' END AS "ROSTATUS",
            nvl(a."Bill_amount",''0'') as "BILLAMT",
            min(TO_CHAR(i."Insert_Date",'''||pdateformat||''')) as "Publish_Date",a.RO_COMMENT as RO_COMMENT
            from TBL_BOOKING_MAST a,tbl_booking_insert i ,RETAINERMASTER,agency_mast b ,adv_cat_mast c
            where a."Ad_type_code"=c."Adv_Type" and
            a."Ad_cat_code"=c."Adv_Cat_Code" and
            a."Comp_code"=c."Comp_Code" and
            a."Comp_code"='''||pcompcode||''' AND a."Comp_code"=i."Comp_Code" AND a."cio_booking_id"=i."Cio_Booking_Id" and
            RETAINERMASTER."Retain_Code"=a.RETAINER AND 
             a."Agency_sub_code"=b."code_subcode" and i."Insert_Status"<>''cancel'' ';
            end if;
        else/* for summary*/
         
         if(age_exeret='2')then
            query1:='select distinct  
             EXEC_MAST."Exec_name"  as "EXE_RET",      
             EXEC_MAST."dist_code"  as "DISTRICT",
            (SELECT "Branch_Name" FROM BRANCH_MST where  a."branch" = "Branch_Code") as "BRANCH",
             
            SUM(DECODE(a.RODOCSTATUS,''o'',1,0)) ORIGINAL
            ,SUM(DECODE(a.RODOCSTATUS,''f'',1,0)) FAX
            ,SUM(DECODE(a.RODOCSTATUS,''x'',1,0)) XEROX
            ,SUM(DECODE(a.RODOCSTATUS,''o'',0,''f'',0,''x'',0,1)) REMAIN
            from TBL_BOOKING_MAST a,tbl_booking_insert i ,EXEC_MAST ,agency_mast b /*,adv_cat_mast c*/
            where  
            a."Comp_code"='''||pcompcode||''' AND a."Comp_code"=i."Comp_Code" AND a."cio_booking_id"=i."Cio_Booking_Id" and
            a."Executive_code"=exec_mast."Exe_no" 
            and a."Agency_sub_code"=b."code_subcode" and i."Insert_Status"<>''cancel'' ';
         else
          query1:='select distinct 
            
             RETAINERMASTER."Retain_Name"     as "EXE_RET",
           
             RETAINERMASTER."Dist_Code"   as "DISTRICT",
            (SELECT "Branch_Name" FROM BRANCH_MST where  a."branch" = "Branch_Code") as "BRANCH",
           
            SUM(DECODE(a.RODOCSTATUS,''o'',1,0)) ORIGINAL
            ,SUM(DECODE(a.RODOCSTATUS,''f'',1,0)) FAX
            ,SUM(DECODE(a.RODOCSTATUS,''x'',1,0)) XEROX
            ,SUM(DECODE(a.RODOCSTATUS,''o'',0,''f'',0,''x'',0,1)) REMAIN
            from TBL_BOOKING_MAST a,tbl_booking_insert i ,RETAINERMASTER ,agency_mast b/*,adv_cat_mast c*/
            where 
            a."Comp_code"='''||pcompcode||''' AND a."Comp_code"=i."Comp_Code" AND a."cio_booking_id"=i."Cio_Booking_Id" and
            RETAINERMASTER."Retain_Code"=a.RETAINER 
            and a."Agency_sub_code"=b."code_subcode" and i."Insert_Status"<>''cancel'' ';
            end if;
        end if;
    end if;

    if(pfromdate is not null and pdateto is not null)then
        query1:=query1||' and a."date_time" between '''||pfromdate||''' and '''||pdateto||''' ';
    end if;
    
    if(pad_type is not null)then
        query1:=query1||' and a."Ad_type_code" = '''||pad_type||''' ';
    end if;

    if(pad_cat is not null)then
        query1:=query1||' and a."Ad_cat_code" = '''||pad_cat||''' ';
    end if;
    
    if(pagency is not null)then
        query1:=query1||' and a."Agency_code" = '''||pagency||''' ';
    end if;    
  --new version 

   if(pprint_cent is not null)then
        query1:=query1||' and a."branch" IN  (SELECT "Branch_Code" FROM BRANCH_MST WHERE a."branch"="Branch_Code"  and "pub_center"='''||pprint_cent||''') ';
    end if;

    if(pbranch is not null)then
        query1:=query1||'  and a."branch" = (SELECT "Branch_Code" FROM BRANCH_MST where "Branch_Name" ='''||pbranch||''') ';
    end if;
    
--old version
   /* 
    if(pprint_cent is not null)then
        query1:=query1||' and a."branch" IN (SELECT "Branch_Name" FROM BRANCH_MST WHERE a."branch"="Branch_Name" and "pub_center"='''||pprint_cent||''') ';
    end if;


    if(pbranch is not null)then
        query1:=query1||' and a."branch"='''||pbranch||'''';
    end if;
*/
    
    if(pdistrict is not null)then
        if(age_exeret='1')then
            query1:=query1||' and b."Dist_Code" = '''||pdistrict||''' ';
         elsif(age_exeret='2')then
            query1:=query1||' and (a."Executive_code" IS NOT NULL AND a."Executive_code" in(select exec_mast."Exe_no" from exec_mast  where EXEC_MAST."dist_code"='''||pdistrict||''' ) ) ';
        else
            query1:=query1||' and  (a.RETAINER IS NOT NULL AND a.RETAINER IN(SELECT RETAINERMASTER."Retain_Code" FROM RETAINERMASTER WHERE RETAINERMASTER."Dist_Code"='''||pdistrict||''')) ';
        end if;
    end if;
    if(ptaluka is not null)then
        if(age_exeret='1')then
            query1:=query1||' and b.TALUKA = '''||ptaluka||''' ';
        elsif(age_exeret='2')then
            query1:=query1||' and (a."Executive_code" IS NOT NULL AND a."Executive_code" in(select exec_mast."Exe_no" from exec_mast  where EXEC_MAST."TALUKA"='''||ptaluka||'''  ) ) ';
        else
            query1:=query1||' and (a.RETAINER IS NOT NULL AND a.RETAINER IN(SELECT RETAINERMASTER."Retain_Code" FROM RETAINERMASTER WHERE RETAINERMASTER."TALUKA"='''||ptaluka||''' )) ';
        end if;
    end if;

    if(pro_doc_status is not null)then
        query1:=query1||' and a."RODOCSTATUS" = '''||pro_doc_status||''' ';
    end if;

    if(ppay_mode is not null)then
        query1:=query1||' and a."Bill_pay" = '''||ppay_mode||''' ';
    end if;

    if(pexecutive is not null)then
        query1:=query1||' and a."Executive_code" = '''||pexecutive||''' ';
    end if;

    if(pretainer  is not null)then
        query1:=query1||' and a.RETAINER = '''||pretainer||''' ';
    end if;

--new version
  query1:=query1||' and a."branch" in(select lb.branch_code from login_branch_mast lb where  lb.user_code='''||puserid||''' and nvl(lb.user_flag,''N'')=''Y'') ' ;
--old version
   -- query1:=query1||' and a."branch" in(select branch_mst."Branch_Name" from branch_mst where branch_mst."Branch_Code" in (select lb.branch_code from login_branch_mast lb where  lb.user_code='''||puserid||''' and nvl(lb.user_flag,''N'')=''Y'')) ' ;

    if(ptype is not null)then
        if ptype='U' then
            query1:=query1||' and (i."Comp_Code"||i.bill_no||i.bill_date in(select /*+ (AD_OUTSTAND IND_OUT) */ o.comp_code||o.billno||o.billdt 
                        from ad_outstand o where o.comp_code=i."Comp_Code" and o.ag_main_code=b."Agency_Code" and 
                        o.ag_sub_code=b."SUB_Agency_Code" and o.billdt=i.bill_date and o.billno=i.bill_no 
                        group by o.comp_code,o.billno,o.billdt having sum(o.amount)>=10) OR i.bill_no IS NULL ) ';
        else 
            query1:=query1||' and i."Comp_Code"||i.bill_no||i.bill_date in(select /*+ (AD_OUTSTAND IND_OUT) */ o.comp_code||o.billno||o.billdt 
                        from ad_outstand o where o.comp_code=i."Comp_Code" and o.ag_main_code=b."Agency_Code" and 
                        o.ag_sub_code=b."SUB_Agency_Code" and o.billdt=i.bill_date and o.billno=i.bill_no 
                        group by o.comp_code,o.billno,o.billdt having sum(o.amount)=0)';
        end if;                
    end if;
    
    if(det_summry!='1')then/*for summary*/
        if(age_exeret='1')then/*fot agency*/
            query1:=query1||' GROUP BY b."Agency_Name" ,b."Dist_Code"  ,a."branch"';
        elsif(age_exeret='2')then
            query1:=query1||' group by EXEC_MAST."Exec_name",EXEC_MAST."dist_code",a."branch"';
        else
            query1:=query1||' GROUP BY RETAINERMASTER."Retain_Name",RETAINERMASTER."Dist_Code",a."branch"';
        end if;
        else
        
        if(age_exeret='1')then/*fot agency*/
            query1:=query1||' GROUP BY a."cio_booking_id"  ,b."Agency_Name"   ,a."Executive_code",a.RETAINER,"Client_code",c."Adv_Cat_Name","RO_No","RODOCSTATUS",a."Bill_amount",a.RO_COMMENT';
        elsif(age_exeret='2')then
            query1:=query1||' group by a."cio_booking_id"  ,b."Agency_Name",EXEC_MAST."Exec_name","Client_code",c."Adv_Cat_Name" ,"RO_No","RODOCSTATUS",a."Bill_amount",a.RO_COMMENT ';
        else
            query1:=query1||' GROUP BY a."cio_booking_id"  ,b."Agency_Name",RETAINERMASTER."Retain_Name","Client_code",c."Adv_Cat_Name" ,"RO_No","RODOCSTATUS",a."Bill_amount",a.RO_COMMENT';
        end if;
        
        
        
    end if;

  delete from searchtbl;
    insert into searchtbl values(query1);commit;


    OPEN p_accounts FOR query1;
    open p_accounts1 for
    select comp_mst."Comp_Name" from comp_mst where comp_mst."Comp_Code"=pcompcode;
END ;
/



/*********************************** issue 6189*****************ankit*****************17 jan*******************/

/*******18 jan**************************** issue 6344*************************************ankit**********/


CREATE OR REPLACE PACKAGE Currbindpreferpgld
IS
   TYPE t_account_cursor IS REF CURSOR;

   PROCEDURE currbindpreferpgld_p (
      compcode     IN       VARCHAR2,
      p_accounts   OUT      t_account_cursor
   );
END Currbindpreferpgld;
/



CREATE OR REPLACE PACKAGE BODY Currbindpreferpgld
IS
   PROCEDURE currbindpreferpgld_p (
      compcode     IN       VARCHAR2,
      p_accounts   OUT      t_account_cursor
   )
   AS
   BEGIN
      OPEN p_accounts FOR
         SELECT "date_format", "autogenerated", "currency_code",
                "rate_gr_code", "solo", "breakup", "blackwhitecode",
                "rostatus", "File_name", "Tfn", "Insert_breakup", "prefix",
                "suffix", "financestatus", "voucherst", "Ad_category",
                "Ro_datetime", "Vat", "Booking_status", "Cio_id",
                "Receipt_no","uom_code","Bgcolor_publication","chkfor_valid_pubdates","Agency_ratecode","audit","book_insert_date","agencycomm",
                "rate_audit","bill_audit","billtype","Premium_type","copy_booking","RATE_COMPANY_AGENCY","ADDITIONAL_AGENCY_COMM","AGENCY_RETAINER_COMM","SUBEDITIONRATE",CLS_BILLTYPE,DIS_BILLTYPE,
                "BILLING_FORMAT","RATE_CHECK","ALL_PACKAGE",dayrate,SCHEME_TYPE,DISP_CLSBILL,RECEIPT_FORMAT,CASH_RECEIPT_BILL, BILL_ORDERWSLAST, FLOOR_CHK,
                ROKEYCHECK, AGENCYCOMM_SEQ_COM, CREDIT_RECIPT,  DISP_CASHBILL, CLA_CASHBILL,
                RATE_AUDIT_PREF,BARCODING_ALLOWED, FMG_BILL_DIS,BILL_DISP_CASHBILL, BILL_CLA_CASHBILL,BACKDATERECEIPT,ROWISE_CASHBOOKING,CUTOFFTIME,DOCKIT_BOOKING,APPROVAL,BACK_DAYS,CASH_DISCOUNT,CASH_DISCOUNTTYPE,"Allowed_old_date",SEPRATE_CASHIER,
                CIR_MANY_TIME_POSTING, CIR_BACKDAYS_POSTING, CIR_MAX_RETURN_ALLOW, CIR_RETURN_LIMIT_ALLOW, CIR_NO_OF_CHQBOUNCE, CIR_DAYS_CHQBOUNCE, CIR_RETURN_DAYS, CIR_SUP_ORDER_LIMIT, DISP_BILLING_CRITERIA, CLSD_BILLING_CRITERIA,MAX_PUBLISHDAYS,
                BILLNO_PERIODICITY, SPECIALDISC_TRANS_EDIT, SHARING_TRANS, MULTIPACKAGE_SEL_TRANS,SCHEME_MINWORD, TRADE_SPLCHARGE,RATE_AUTHORIZATION,
           F2_RECORD,PUBLISHAD_EDIT_RATEAUDIT,BINDREVENUE_CENTER, FA_LEDGER_ALLOW,CLEARANCE_TYPE_ALLOW,REPEAT_DAY_TYPE,PREMIUM_EDIT,
           
           BILL_GENERATION_PRIOR,PUBLICATION_HO,SPLDISC_ALLOWPREM,BILL_SCHEME,ALLOWED_PDC_DAYS_RECEIPT,
           AD_TYPE_MANUL_BILL,OUTSTANDING_AMT_CRITERIA as RO_OUTSTAND,GENRATE_CIR_AGCD,DISP_AUDITBKG,CIR_DIS_AUTO_POSTING,RELAUTHREQON,
        CIR_AUTO_APPROVAL_UNSOLD, CIR_AUTO_PHYSICAL_UNSOLD, CIR_UNSOLD_INCLUDE_INCT, CIR_UNSOLD_INCLUDE_INSFEE, CIR_UNSOLD_ON_RECEIVED_DT,
        AGENCY_UNBLOCK_APPROVAL,UNBLOCK_APPROVAL_OUTSIDE_LIMIT,CIR_BILL_PUBLWISE ,RECORDS_ON_PAGE,RECORDS_ON_PRINT,HEADER_ON_PAGE,AGENCY_REQUIRED,REGION_REQUIRED,ALLOW_FOLLOW_DT_BOOOK,CRM_SUPPLY_TYPE_PAID,CRM_SUPPLY_TYPE_FREE,CURRENCY_MEASUREMENT,"Space_area"  
            FROM PREFERRENCES
          WHERE "comp_code" = compcode;
          
         
   END currbindpreferpgld_p;
END Currbindpreferpgld;
/


/*******18 jan*************end*************** issue 6344*************************************ankit**********/



/*******19 jan*************end*************** issue 6211*************************************mimoh**********/


CREATE OR REPLACE PACKAGE insertcontactmast
IS
   PROCEDURE insertcontactmast_p (
      compcode         IN   VARCHAR2,
      userid           IN   VARCHAR2,
      dealno           IN   VARCHAR2,
      dealname         IN   VARCHAR2,
      agencycode       IN   VARCHAR2,
      subagencycode    IN   VARCHAR2,
      product          IN   VARCHAR2,
      validfromdate    IN   DATE,
      validtill        IN   DATE,
      representative   IN   VARCHAR2,
      clientname       IN   VARCHAR2,
      totalvalue       IN   NUMBER,
      totalvolume      IN   NUMBER,
      currencys        IN   VARCHAR2,
      teamname         IN   VARCHAR2,
      dealtype         IN   VARCHAR2,
      adtype1           IN   VARCHAR2,
      REMARK           IN  VARCHAR2,
      executive_var           IN  VARCHAR2,
        retainer_var           IN  VARCHAR2,
        contdate_var           IN  DATE,
        closedate_var           IN  DATE,
        servicetax_var           IN  VARCHAR2,
        caption_var           IN  VARCHAR2,
        paymode_var in varchar2,
        b2b_var in varchar2,
        chkmulti_var in varchar2,
        chkseq_var in varchar2,
        seqno_var in varchar2,
        chkparti_var in varchar2,
        indus_var in varchar2,
        induspro_var in varchar2,
        dealon_var in varchar2,
        attachment1 in varchar2
   );
END insertcontactmast;
/




CREATE OR REPLACE PACKAGE BODY insertcontactmast
IS
   PROCEDURE insertcontactmast_p (
        compcode         IN   VARCHAR2,
        userid           IN   VARCHAR2,
        dealno           IN   VARCHAR2,
        dealname         IN   VARCHAR2,
        agencycode       IN   VARCHAR2,
        subagencycode    IN   VARCHAR2,
        product          IN   VARCHAR2,
        validfromdate    IN   DATE,
        validtill        IN   DATE,
        representative   IN   VARCHAR2,
        clientname       IN   VARCHAR2,
        totalvalue       IN   NUMBER,
        totalvolume      IN   NUMBER,
        currencys        IN   VARCHAR2,
        teamname         IN   VARCHAR2,
        dealtype         IN   VARCHAR2,
        adtype1           IN   VARCHAR2,
        REMARK           IN  VARCHAR2,
        executive_var           IN  VARCHAR2,
        retainer_var           IN  VARCHAR2,
        contdate_var           IN  DATE,
        closedate_var           IN  DATE,
        servicetax_var           IN  VARCHAR2,
        caption_var           IN  VARCHAR2,
        paymode_var in varchar2,
         b2b_var in varchar2,
        chkmulti_var in varchar2,
        chkseq_var in varchar2,
        seqno_var in varchar2,
        chkparti_var in varchar2,
        indus_var in varchar2,
        induspro_var in varchar2,
        dealon_var in varchar2,
        attachment1 in varchar2
        )
   AS
   BEGIN
      INSERT INTO contract_mast
                  ("Deal_No", "Comp_code", "Agency_code", "Sub_Agency_Code",
                   "Client_code", "Product_code", "From_date", "Till_date",
                   "representative", "Userid", "Total_val", "Total_volu",
                   "curr_code", "team_code", "deal_type", "deal_name",
                   "Ad_type","Creation_datetime","REMARKS",EXECUTIVE, RETAINER, CONTRACTDATE, CLOSEDATE, SERVICETAX, PAYMENTTYPE, CAPTION, B2B, CHKMULTIAD, SEQNO_ALLOW, SEQNO, AFT_PRTCLR_AD, INDUSTRY, INDUSTRY_PRODUCT, DEALON,ATTACHMENT
                  )
           VALUES (dealno, compcode, agencycode, subagencycode,
                   clientname, product, validfromdate, validtill,
                   representative, userid, totalvalue, totalvolume,
                   currencys, teamname, dealtype, dealname,
                   adtype1,sysdate,REMARK,executive_var,retainer_var,contdate_var,closedate_var,servicetax_var,paymode_var,caption_var,
                   b2b_var,chkmulti_var,chkseq_var,seqno_var,chkparti_var,indus_var,induspro_var,dealon_var,attachment1
                  );

      COMMIT;
   END insertcontactmast_p;
END insertcontactmast;
/
/*************************************/






CREATE OR REPLACE PACKAGE updatecontactmast
IS
   PROCEDURE updatecontactmast_p (
      compcode         IN   VARCHAR2,
      userid           IN   VARCHAR2,
      dealno           IN   VARCHAR2,
      dealname         IN   VARCHAR2,
      agencycode       IN   VARCHAR2,
      subagencycode    IN   VARCHAR2,
      product          IN   VARCHAR2,
      validfromdate    IN   DATE,
      validtill        IN   DATE,
      representative   IN   VARCHAR2,
      clientname       IN   VARCHAR2,
      totalvalue       IN   NUMBER,
      totalvolume      IN   NUMBER,
      currencys        IN   VARCHAR2,
      teamname         IN   VARCHAR2,
      dealtype         IN   VARCHAR2,
      adtype           IN   VARCHAR2,
       REMARK           IN  VARCHAR2,
      executive_var           IN  VARCHAR2,
        retainer_var           IN  VARCHAR2,
        contdate_var           IN  DATE,
        closedate_var           IN  DATE,
        servicetax_var           IN  VARCHAR2,
        caption_var           IN  VARCHAR2,
        paymode_var in varchar2,
         b2b_var in varchar2,
        chkmulti_var in varchar2,
        chkseq_var in varchar2,
        seqno_var in varchar2,
        chkparti_var in varchar2,
        indus_var in varchar2,
        induspro_var in varchar2,
        dealon_var in varchar2,
        attachment1 in varchar2
   );
END updatecontactmast;
/




CREATE OR REPLACE PACKAGE BODY updatecontactmast
IS
   PROCEDURE updatecontactmast_p (
      compcode         IN   VARCHAR2,
      userid           IN   VARCHAR2,
      dealno           IN   VARCHAR2,
      dealname         IN   VARCHAR2,
      agencycode       IN   VARCHAR2,
      subagencycode    IN   VARCHAR2,
      product          IN   VARCHAR2,
      validfromdate    IN   DATE,
      validtill        IN   DATE,
      representative   IN   VARCHAR2,
      clientname       IN   VARCHAR2,
      totalvalue       IN   NUMBER,
      totalvolume      IN   NUMBER,
      currencys        IN   VARCHAR2,
      teamname         IN   VARCHAR2,
      dealtype         IN   VARCHAR2,
      adtype           IN   VARCHAR2,
       REMARK           IN  VARCHAR2,
      executive_var           IN  VARCHAR2,
        retainer_var           IN  VARCHAR2,
        contdate_var           IN  DATE,
        closedate_var           IN  DATE,
        servicetax_var           IN  VARCHAR2,
        caption_var           IN  VARCHAR2,
        paymode_var in varchar2,
         b2b_var in varchar2,
        chkmulti_var in varchar2,
        chkseq_var in varchar2,
        seqno_var in varchar2,
        chkparti_var in varchar2,
        indus_var in varchar2,
        induspro_var in varchar2,
         dealon_var in varchar2,
         attachment1 in varchar2
   )
   AS
   BEGIN
      UPDATE contract_mast
         SET "deal_name" = dealname,
             "Agency_code" = agencycode,
             "Sub_Agency_Code" = subagencycode,
             "Client_code" = clientname,
             "Product_code" = product,
             "From_date" = validfromdate,
             "Till_date" = validtill,
             "representative" = representative,
             "Total_val" = totalvalue,
             "Total_volu" = totalvolume,
             "curr_code" = currencys,
             "team_code" = teamname,
             "deal_type" = dealtype,
             "Ad_type" = adtype,
             "REMARKS"=REMARK,
             EXECUTIVE=executive_var,
              RETAINER=retainer_var,
              CONTRACTDATE=contdate_var,
              CLOSEDATE=closedate_var,
               SERVICETAX=servicetax_var,
               PAYMENTTYPE=paymode_var,
                CAPTION=caption_var,
                B2B=b2b_var, CHKMULTIAD=chkmulti_var, SEQNO_ALLOW=chkseq_var, SEQNO=seqno_var, AFT_PRTCLR_AD=chkparti_var, INDUSTRY=indus_var, INDUSTRY_PRODUCT=induspro_var,
                DEALON=dealon_var,
                ATTACHMENT=attachment1
       WHERE "Deal_No" = dealno AND "Comp_code" = compcode;

      COMMIT;
   END updatecontactmast_p;
END updatecontactmast;
/

/******************************************/


CREATE OR REPLACE procedure BINDDEALforf2
(p_compcode in VARCHAR2,
p_dealname in  VARCHAR2,
P_Accounts OUT CUR_TYPE_NEW1.CURSOR_TYPE)
AS
BEGIN
OPEN P_Accounts FOR
SELECT DISTINCT "Deal_No", "deal_name"
                 FROM contract_mast  where  "Comp_code"=p_compcode 
                 AND ("deal_name" LIKE p_dealname || '%' OR p_dealname IS NULL) ;

END;
/

/*************************/



CREATE OR REPLACE PACKAGE executecontract IS
Type T_Accounts_Cursor is Ref Cursor;
PROCEDURE executecontract_P(
compcode in varchar2,
userid in varchar2,--
DealNo in varchar2,--
dealname in varchar2,--
agencycode in varchar2,--
subagencycode in varchar2,--
representative in varchar2,
dealtype in varchar2,
P_Accounts  OUT  T_Accounts_Cursor
);
end executecontract;
/





CREATE OR REPLACE PACKAGE BODY Executecontract
IS
  PROCEDURE executecontract_P(
  			compcode IN VARCHAR2,
			userid IN VARCHAR2,--
			DealNo IN VARCHAR2,--
			dealname IN VARCHAR2,--
			agencycode IN VARCHAR2,--
			subagencycode IN VARCHAR2,--
			Representative IN VARCHAR2,
			dealtype IN VARCHAR2,
			P_Accounts  OUT  T_Accounts_Cursor)
	AS
	BEGIN
		 OPEN P_Accounts FOR
		 SELECT  "Deal_No","Comp_code",(select "Agency_Name"||'('|| "Agency_Code" ||')' from agency_mast where "Agency_Code"="Agency_code" and agency_mast."SUB_Agency_Code"=contract_mast."Sub_Agency_Code") as "Agency_code","Sub_Agency_Code",(select "Cust_Name"||'('||"Cust_Code"||')' from cust_mast where "Cust_Code"="Client_code") as "Client_code","Product_code",TO_CHAR("From_date",'mm/dd/yyyy') as "From_date",TO_CHAR("Till_date",'mm/dd/yyyy') as "Till_date","representative","Userid","Total_val","Total_volu","team_code","deal_type","deal_name","contract_id","Ad_type",REMARKS,(select "Exec_name"||'('||"Exe_no"||')' from exec_mast where "Exe_no"=EXECUTIVE) as EXECUTIVE, (select "Retain_Name"||'(' || "Retain_Code" || ')' from  retainermaster where "Retain_Code"=RETAINER) as RETAINER, TO_CHAR(CONTRACTDATE,'mm/dd/yyyy') as CONTRACTDATE,TO_CHAR(CLOSEDATE,'mm/dd/yyyy') as  CLOSEDATE, SERVICETAX, PAYMENTTYPE, CAPTION, B2B, CHKMULTIAD, SEQNO_ALLOW, SEQNO, AFT_PRTCLR_AD, INDUSTRY, INDUSTRY_PRODUCT, DEALON,ATTACHMENT
          FROM CONTRACT_MAST
		 WHERE ("Comp_code" = compcode OR compcode IS NULL)
		 AND ("Deal_No" LIKE DealNo || '%' OR DealNo IS NULL)
		 AND("deal_name"  LIKE dealname ||'%'OR dealname IS NULL)
		 AND("Agency_code" LIKE agencycode||'%'OR agencycode IS NULL)
		 AND("deal_type" LIKE dealtype||'%'OR dealtype IS NULL)
		 AND("Sub_Agency_Code" LIKE subagencycode||'%'OR subagencycode IS NULL)
		 AND("representative" LIKE Representative||'%'OR Representative IS NULL);

END executecontract_P;
END Executecontract;
/

/**********************************/



CREATE OR REPLACE PROCEDURE cheackdeal
(
 compcode in varchar2,
 dealno in varchar2,
 P_Accounts OUT Cur_Type_New1.cursor_type
)
IS
BEGIN
    OPEN P_Accounts FOR
    SELECT AUDITBY, AUDIT_COMMENT FROM  CONTRACT_MAST WHERE "Comp_code"= compcode and "Deal_No"=dealno and AUDITBY is not null;
        
END;
/




/*******19 jan*************end*************** issue 6211*************************************mimoh**********/

//======================================issue no. 6257 kuldeep=======================================//
CREATE OR REPLACE PACKAGE advsubcattyp Is
 Type T_Accounts_Cursor Is Ref Cursor;
 Procedure advsubcattyp_P(
 compcode in varchar2,
 catcode in varchar2,
 p_Accounts Out T_Accounts_Cursor
 );
 End advsubcattyp;
/
CREATE OR REPLACE PACKAGE BODY advsubcattyp Is
Procedure advsubcattyp_P(
compcode in varchar2,
catcode in varchar2,
p_Accounts Out T_Accounts_Cursor
)As
Begin
Open P_Accounts For
select "Adv_Subcat_Code","Adv_Subcat_Name" from adv_subcat_mast where "Comp_Code"=compcode and (STATUS='1' or STATUS is null) and  "Adv_Cat_Code"=catcode
 order by "Adv_Subcat_Name";
End advsubcattyp_P;
End advsubcattyp;
/
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PROCEDURE ADB_GETBILLNOBILLDAET(
p_cioid          in varchar2,
p_insertno       in varchar2,
p_compcode       in varchar2,
p_dateformat     in varchar2,
extra1           in varchar2,
extra2           in varchar2,
extra3           in varchar2,
P_Accounts       OUT Cur_Type_New1.cursor_type
)
IS
BEGIN
OPEN P_Accounts FOR
  select BILL_NO,to_char(BILL_DATE,p_dateformat) as "BILL_DATE" from tbl_booking_insert where "Comp_Code"=p_compcode and "Cio_Booking_Id"=p_cioid and "No_Insert"=p_insertno;

END;
/
//============================================end 6257=============================================//

//============================================ 6338===========ankit==================================//

CREATE OR REPLACE PACKAGE check_status_code
IS
   TYPE t_accounts_cursor IS REF CURSOR;

   PROCEDURE check_status_code_p (
      compcode     IN       VARCHAR2,
      statuscode   IN       VARCHAR2,
      statusname   IN       VARCHAR2,
      p_accounts   OUT      t_accounts_cursor,
       p_accounts1   OUT      t_accounts_cursor
   );
END check_status_code;
/





CREATE OR REPLACE PACKAGE BODY check_status_code
IS
   PROCEDURE check_status_code_p (
      compcode     IN       VARCHAR2,
      statuscode   IN       VARCHAR2,
      statusname   IN       VARCHAR2,
      p_accounts   OUT      t_accounts_cursor,
       p_accounts1   OUT      t_accounts_cursor
   )
   AS
   BEGIN
      OPEN p_accounts FOR
         SELECT "Status_Code"
           FROM tblstatus
          WHERE "Status_Code" = statuscode AND "Comp_Code" = compcode;
          
       OPEN p_accounts1 FOR
       select "Status_Name" from tblstatus where  "Status_Name" = statusname  and "Comp_Code"=compcode;
   END check_status_code_p;
END check_status_code;
/

//============================================end 6338===========ankit==================================//

/************************mimoh *****************************************************************/


CREATE OR REPLACE PROCEDURE Bill_Saveclassified
(

orderno1 IN VARCHAR2,
invoice1 IN VARCHAR2,
amountforvat IN NUMBER ,
amt3 IN NUMBER,
boxchg1 IN NUMBER,
insnum_cou IN NUMBER,
doctyp IN VARCHAR2,
maxinsert IN VARCHAR2

)


IS


pubcode  VARCHAR2(5);
pub_cent_code  VARCHAR2(8000);
branch  VARCHAR2(8);
ro_num  VARCHAR2(40);
ro_date     DATE;
client_code  VARCHAR2(70);
client_name  VARCHAR2(70);
insert_date  DATE;
comp_code  VARCHAR2(8000);
userid  VARCHAR2(25);
package_code  VARCHAR2(8000);
agency_sub_code  VARCHAR2(50);
colour_code  VARCHAR2(3);
noofinsert  NUMBER;
bildt DATE;
agcode VARCHAR2(50);
cod_subcode VARCHAR2(50);
rate_code varchar2(100);
adcat_v varchar2(20);
adsubcat_v varchar2(20);
bl_remarks_v varchar2(40);
ag_comm_v  varchar2(50);
trade_disc number;
bill_rmk_v varchar2(500);
region_v varchar2(10);
retainer_v varchar2(10);
cont_name varchar2(100);
cont_type varchar2(100);
cont_rate varchar2(100);
exe_code varchar2(100);

special_disc varchar2(100);
space_disc varchar2(100);
bill_pay varchar2(100);
---------15DEC
scheme_type varchar2(100);
revcenter varchar2(100);
ro_status varchar2(100);
page_type varchar2(100);
booking_type varchar2(100);
prod_code varchar2(200);
page_no varchar2(200);
page_position varchar2(8);
billremark varchar2(500);
---------15DEC

BEGIN




begin
select    "Insertion_date" into bildt from tbl_booking_mast  where   "cio_booking_id"=orderno1;
EXCEPTION WHEN NO_DATA_FOUND THEN
NULL;
END;


--SELECT  MAX("Insert_Date")  INTO bildt FROM TBL_BOOKING_INSERT WHERE  "Cio_Booking_Id"=orderno1 ;

--UPDATE TBL_BOOKING_INSERT  SET "Insert_Status"='billed',BILL_NO=invoice1, BILL_DATE= bildt WHERE "Cio_Booking_Id"=orderno1 ;


SELECT DISTINCT "No_of_insertion" INTO noofinsert FROM TBL_BOOKING_MAST WHERE "cio_booking_id"=orderno1;

SELECT DISTINCT "Trade_disc" INTO trade_disc FROM TBL_BOOKING_MAST WHERE "cio_booking_id"=orderno1;



--SELECT DISTINCT  "Publication_Code" INTO pubcode FROM tbl_booking_insert WHERE  "Cio_Booking_Id"=orderno1 and rownum<1;
--SELECT DISTINCT "Retain_Code"  INTO branch FROM RetainerMaster,tbl_booking_mast WHERE RetainerMaster."Retain_Name"=tbl_booking_mast."branch" AND "cio_booking_id"=orderno1;

SELECT DISTINCT "Branch_Code" INTO  branch   FROM  BRANCH_MST
,TBL_BOOKING_MAST WHERE BRANCH_MST."Branch_Code"=TBL_BOOKING_MAST.
"branch" AND "cio_booking_id"=orderno1;
SELECT DISTINCT  "Agency_sub_code"  INTO agency_sub_code FROM TBL_BOOKING_MAST WHERE   "cio_booking_id"=orderno1;


SELECT DISTINCT  "Agency_Code" INTO agcode  FROM AGENCY_MAST  WHERE "code_subcode" =agency_sub_code ;
SELECT DISTINCT "SUB_Agency_Code" INTO  cod_subcode  FROM AGENCY_MAST WHERE "code_subcode" =agency_sub_code ;




SELECT DISTINCT "RO_No" INTO ro_num FROM TBL_BOOKING_MAST WHERE   "cio_booking_id"=orderno1;
SELECT DISTINCT  "RO_Date" INTO ro_date FROM TBL_BOOKING_MAST  WHERE    "cio_booking_id"=orderno1;
BEGIN
SELECT DISTINCT  "Client_code" INTO client_code FROM TBL_BOOKING_MAST  WHERE    "cio_booking_id"=orderno1;
EXCEPTION WHEN NO_DATA_FOUND THEN
NULL;
END;
BEGIN
SELECT DISTINCT  "Cust_Name" INTO client_name FROM CUST_MAST  WHERE    "Cust_Code"=client_code;
EXCEPTION WHEN NO_DATA_FOUND THEN
NULL;
END;
SELECT  DISTINCT "Insertion_date" INTO insert_date FROM TBL_BOOKING_MAST  WHERE    "cio_booking_id"=orderno1;

SELECT DISTINCT "Color_code"  INTO colour_code FROM TBL_BOOKING_MAST WHERE   "cio_booking_id"=orderno1;
SELECT DISTINCT "Comp_Code" INTO comp_code FROM TBL_BOOKING_INSERT WHERE  "Cio_Booking_Id"=orderno1;
SELECT  DISTINCT "Userid" INTO userid FROM TBL_BOOKING_INSERT WHERE  "Cio_Booking_Id"=orderno1;


SELECT DISTINCT "Bill_remarks"  INTO bill_rmk_v FROM TBL_BOOKING_MAST WHERE   "cio_booking_id"=orderno1;

select distinct "RETAINER" into retainer_v from tbl_booking_mast where "cio_booking_id"=orderno1;
select distinct "Contract_name" into cont_name from tbl_booking_mast WHERE   "cio_booking_id"=orderno1;
select distinct "Contract_type" into cont_type from tbl_booking_mast WHERE   "cio_booking_id"=orderno1;
select distinct "Contract_rate" into cont_rate from tbl_booking_mast WHERE   "cio_booking_id"=orderno1;
select distinct "Executive_code" into exe_code from tbl_booking_mast where "cio_booking_id"=orderno1;

select  "Special_discount" into special_disc from tbl_booking_mast where "cio_booking_id"=orderno1;
select "Space_discount" into space_disc from tbl_booking_mast where "cio_booking_id"=orderno1;
select "Bill_pay" into Bill_pay from tbl_booking_mast  where "cio_booking_id"=orderno1;


-------15dec
select "Scheme_type_code" into scheme_type from tbl_booking_mast where"cio_booking_id"=orderno1;
select "Revenue_center" into revcenter from tbl_booking_mast where "cio_booking_id"=orderno1;
select "ro_status" into ro_status from tbl_booking_mast where "cio_booking_id"=orderno1;
select "Page_type_code" into page_type from tbl_booking_mast where "cio_booking_id"=orderno1;
select "Booking_type" into booking_type from tbl_booking_mast where "cio_booking_id"=orderno1;
select "Product_code" into prod_code from tbl_booking_mast where "cio_booking_id"=orderno1;
select "Page_no" into page_no from tbl_booking_mast where "cio_booking_id"=orderno1;
select tbl_booking_mast."Page_position_code" into page_position from tbl_booking_mast where "cio_booking_id"=orderno1;
select tbl_booking_mast."Bill_remarks"  into billremark   from tbl_booking_mast where "cio_booking_id"=orderno1;

-------15dec

INSERT INTO AD_BILLS ("UNIT","IDNUM","AGCODE","BKFOR","BILDT","BILNO","BILLAMT","GROSS_AMT","RONUM","RODATE","CLIENTCD","CLIENTNAME","COLOUR","BOXCHRG","INSNUM","INSDATE","USRID","NOOFINSRT","AG_MAIN_CODE", "AG_SUB_CODE","DISCOUNT",REGION_CODE_V,RETAINER_CODE,"PRIPUB","CONTRACT_NAME","CONTRACT_TYPE","CONTRACT_RATE","EXECUTIVE_NAME","OVRDDISC","SPACEDISC","BILL_PAY" ,SCHEME,REVENUE_CENTER,RO_STATUS,PAGE_TYPE,BOOKING_TYPE,PRIPROCTG,PAGENUM,PAGE_POST,BILL_RMRK,COMP_CODE_V)
VALUES(branch ,orderno1,agency_sub_code,branch,TRUNC(bildt),invoice1,amt3, amountforvat,ro_num,ro_date,client_code,client_name,colour_code,boxchg1,maxinsert,TRUNC(insert_date),userid,insnum_cou,agcode,cod_subcode,trade_disc,region_v,retainer_v,pubcode,cont_name,cont_type,cont_rate,exe_code,special_disc,space_disc,Bill_pay,scheme_type,revcenter,ro_status,page_type,booking_type,prod_code,page_no,page_position,billremark,comp_code);


INSERT INTO AD_OUTSTAND("UNIT","AGCODE","PRIPUB","BKFOR","BILLNO","AMOUNT","NOOFINSRT","INSDATE","COMP_CODE","USERID","CREATION_DATETIME","DOCTYPE","BILLDT" ,"AG_MAIN_CODE", "AG_SUB_CODE", "REMARK")
VALUES(branch,agency_sub_code,pubcode,branch,invoice1,amt3,noofinsert,insert_date,comp_code,userid,TRUNC(bildt),doctyp,TRUNC(insert_date),agcode,cod_subcode,bill_rmk_v);


END;
/



/************************mimoh *****************************************************************/


@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@6051@@@KULDEEP@@@@@@@@@@

CREATE OR REPLACE PROCEDURE ADB_GETAGENCY_REMARKDETAIL(
p_agency_code          in varchar2,
p_subagency_code       in varchar2,
p_cust_code            in varchar2,
p_type                 in varchar2,
p_compcode             in varchar2,
p_dateformat           in varchar2,
extra                  in varchar2,
p_account             OUT Cur_Type_New1.cursor_type
)
IS
BEGIN
    IF p_type ='A' THEN
        BEGIN
        OPEN p_account FOR
        SELECT AGENCY_ALERT as "AGENCY_REMARK",TO_CHAR(CREATION_DATETIME,p_dateformat) as "CREATION_DATE" FROM  AGENCY_REMARK_DETAIL 
        WHERE COMP_CODE=p_compcode AND AGENCY_CODE=p_agency_code AND SUB_AGENCY_CODE=p_subagency_code order by CREATION_DATETIME;
        END;
    ELSE
        BEGIN
        OPEN p_account FOR
        SELECT CUST_REMARK,TO_CHAR(CREATION_DATETIME,p_dateformat) as "CREATION_DATE" FROM CUST_REMARK_DETAIL 
        WHERE COMP_CODE=p_compcode AND CUST_CODE=p_cust_code  order by CREATION_DATETIME;
        END;
    END IF;
END;
/


@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

//======================================Procedure=======================================//
CREATE OR REPLACE PROCEDURE ADB_GETAGENCY_REMARKDETAIL(
p_agency_code          in varchar2,
p_subagency_code       in varchar2,
p_cust_code            in varchar2,
p_type                 in varchar2,
p_compcode             in varchar2,
p_dateformat           in varchar2,
extra                  in varchar2,
p_account             OUT Cur_Type_New1.cursor_type
)
IS
BEGIN
    IF p_type ='A' THEN
        BEGIN
        OPEN p_account FOR
        SELECT AGENCY_REMARK,TO_CHAR(CREATION_DATETIME,p_dateformat) as "CREATION_DATE" FROM  AGENCY_REMARK_DETAIL 
        WHERE COMP_CODE=p_compcode AND AGENCY_CODE=p_agency_code AND SUB_AGENCY_CODE=p_subagency_code order by CREATION_DATETIME;
        END;
    ELSE
        BEGIN
        OPEN p_account FOR
        SELECT CUST_REMARK,TO_CHAR(CREATION_DATETIME,p_dateformat) as "CREATION_DATE" FROM CUST_REMARK_DETAIL 
        WHERE COMP_CODE=p_compcode AND CUST_CODE=p_cust_code  order by CREATION_DATETIME;
        END;
    END IF;
END;
/
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PACKAGE advsubcattyp Is
 Type T_Accounts_Cursor Is Ref Cursor;
 Procedure advsubcattyp_P(
 compcode in varchar2,
 catcode in varchar2,
 p_Accounts Out T_Accounts_Cursor
 );
 End advsubcattyp;
/

CREATE OR REPLACE PACKAGE BODY advsubcattyp Is
Procedure advsubcattyp_P(
compcode in varchar2,
catcode in varchar2,
p_Accounts Out T_Accounts_Cursor
)As
Begin
Open P_Accounts For
select "Adv_Subcat_Code","Adv_Subcat_Name" from adv_subcat_mast where "Comp_Code"=compcode and (STATUS='1' or STATUS is null) and  "Adv_Cat_Code"=catcode
 order by "Adv_Subcat_Name";
End advsubcattyp_P;
End advsubcattyp;
/


//==============================================6051 END===========================================//


//==============================================6336 ankit===========================================//


CREATE OR REPLACE PACKAGE paymentexe
IS
   TYPE t_accounts_cursor IS REF CURSOR;

   PROCEDURE paymentexe_p (
      compcode     IN       VARCHAR2,
      paycode      IN       VARCHAR2,
      payname      IN       VARCHAR2,
      userid in VARCHAR2,
      p_accounts   OUT      t_accounts_cursor
   );
END paymentexe;
/







CREATE OR REPLACE PACKAGE BODY paymentexe
IS
   PROCEDURE paymentexe_p (
      compcode     IN       VARCHAR2,
      paycode      IN       VARCHAR2,
      payname     IN       VARCHAR2,
      userid in VARCHAR2,
  p_accounts   OUT      t_accounts_cursor
   )
   AS
   BEGIN
      IF  payname is null
      THEN
         OPEN p_accounts FOR
       select "Comp_Code", "Pay_Mode_Code", "Payment_Mode_Name", "Userid",sysdate,PAYMENT_MODE_ALIAS,CASHDISCOUNT AS CASH  from   payment_mode_mast
         WHERE ("Comp_Code" = compcode OR compcode IS NULL)
               AND ("Pay_Mode_Code" =  paycode OR  paycode IS NULL)
               AND  "Payment_Mode_Name" LIKE   payname || '%' ;




      ELSE

         OPEN p_accounts FOR
          select "Comp_Code", "Pay_Mode_Code", "Payment_Mode_Name", "Userid",sysdate,PAYMENT_MODE_ALIAS,CASHDISCOUNT AS CASH  from   payment_mode_mast
         WHERE ("Comp_Code" = compcode OR compcode IS NULL)
               AND  "Payment_Mode_Name" LIKE   payname || '%' ;
      END IF;
   END  paymentexe_p;
END  paymentexe;
/


//==============================================6336 ankit===========end================================//

//===================================vishal=========== ankit===========================================//


CREATE OR REPLACE PACKAGE pub_modify is
procedure pub_modify_p(
comcode in varchar2,pubcode in varchar2,pubname in varchar2,pubalias in
varchar2,langcode in varchar2,priority in varchar2,estdate in date,contperson in varchar2,
phone in varchar2,fax in varchar2,emailid in varchar2,pubtype in  varchar2,preocity in varchar2,
phone2 in varchar2,fax2 in varchar2,gutter_space  in varchar2,column_space  in varchar2,
hr in varchar2,mint in  varchar2,prod in varchar2,noofcol in varchar2,publishcode in varchar2,PREFIX IN VARCHAR2);
end pub_modify;
/




CREATE OR REPLACE PACKAGE BODY pub_modify is

procedure pub_modify_p(
comcode in varchar2,pubcode in varchar2,pubname in varchar2,pubalias in varchar2,langcode in varchar2,priority in varchar2,estdate in date,contperson in varchar2,phone in varchar2,fax in varchar2,emailid in varchar2,pubtype in  varchar2,preocity in varchar2,phone2 in varchar2,fax2 in varchar2,gutter_space  in varchar2,column_space  in varchar2,hr in varchar2,mint in  varchar2,prod in varchar2,noofcol in varchar2,publishcode in varchar2,PREFIX IN VARCHAR2)as
begin
update PUB_MAST set "Pub_Name"=pubname, "pub_alias"=pubalias, "Lang_Code"=langcode, "Priority"=priority, "Establish_Date"=estdate, "Cont_Person"=contperson, "Phone"=phone, "Fax"=fax, "EmailID"=emailid,"publication_type"=pubtype,"preodicity"=preocity,"Phone1"=phone2,"Fax1"=fax2,"Gutter_Space"=gutter_space,"Column_Space"=column_space, "rotimehr"=hr, "rotimemin"=mint, "production"=prod ,"No_Of_collumn"=noofcol,PUBLISHER_CODE= publishcode,PREFIX_PUB_NAME=PREFIX where "Comp_Code"=comcode and "Pub_Code"=pubcode;


commit;
end  pub_modify_p;
end pub_modify;
/




CREATE OR REPLACE PACKAGE pubsave is
procedure pubsave_p(
comcode in varchar2,pubcode in varchar2,pubname in varchar2,pubalias in varchar2,langcode in  varchar2,priority  in varchar2,estdate in date,contperson in varchar2,phone in varchar2,fax in varchar2,emailid in varchar2,userid in varchar2,pubtype in varchar2,preocity in varchar2,phone2  in varchar2,fax2 in varchar2,gutter_space in varchar2,column_space in varchar2,hr in  varchar2,mint in  varchar2,prod in varchar2,
noofcol in varchar2,publish_code in varchar2,PREFIX IN VARCHAR2
);
end pubsave;
/





CREATE OR REPLACE PACKAGE BODY pubsave is

procedure pubsave_p(
comcode in varchar2,
pubcode in varchar2,
pubname in varchar2,
pubalias in varchar2,
langcode in  varchar2,
priority  in varchar2,
estdate in date,
contperson in varchar2,
phone in varchar2,
fax in varchar2,
emailid in varchar2,
userid in varchar2,
pubtype in varchar2,
preocity in varchar2,
phone2  in varchar2,
fax2 in varchar2,
gutter_space in varchar2,
column_space in varchar2,
hr in  varchar2,
mint in  varchar2,
prod in varchar2,
noofcol in varchar2,
publish_code in varchar2,
PREFIX IN VARCHAR2
)as
begin
insert into PUB_MAST("Comp_Code","Priority","Pub_Code","Pub_Name","pub_alias","Lang_Code","Establish_Date","Cont_Person","Phone","Fax","EmailID","UserId","Creation_Datetime","publication_type","preodicity","Phone1","Fax1","Gutter_Space","Column_Space","rotimehr","rotimemin","production","No_Of_collumn",PUBLISHER_CODE,PREFIX_PUB_NAME)
 values(comcode ,priority,pubcode,pubname,pubalias,langcode,estdate,contperson,phone,fax,emailid,userid, sysdate,pubtype,preocity,phone2,fax2,gutter_space,column_space,hr,mint,prod,noofcol,publish_code,PREFIX);

commit;
end  pubsave_p;
end pubsave;
/



//===================================vishal=========== ankit===========================================//


@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@6421@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@


CREATE OR REPLACE PACKAGE insertintobookchild
IS
   TYPE t_accounts_cursor IS REF CURSOR;

   PROCEDURE  insertintobookchild_p (


    insertdate in date,
edition in varchar2,
premium1 in varchar2,
premium2 in varchar2,
premallow in varchar2,
adcategory in varchar2,
latestdate in date,
material in varchar2,
cardrate in number,
matfilename in varchar2,
discrate in number,
insertstatus in varchar2,
billstatus in varchar2,
adsubcat1 in varchar2,
compcode in varchar2,
userid in varchar2,
cioid in varchar2,
height in number,
width in number,
totalsize in number,
pagepost in varchar2,
premper1 in number,
premper2 in number,
colid in varchar2,
repeat in date,
insertno in int,
paid in varchar2,
agrrate in number,
solorate in number,
grossrate in number,
insert_pageno in number,
insert_remarks in varchar2,
page_code in varchar2,
page_per in number,
noofcol in number,
billamt in number,
billrate in number,
logo_h in varchar2,
logo_w in varchar2,
logo_name in varchar2,
ad_cat_3 in varchar2,
ad_cat_4 in varchar2,
ad_cat_5 in varchar2,
pkgcode in varchar2,
gridins in number,
pkgalias in varchar2,
cirvts in varchar2,
cirpub in varchar2,
ciredi in varchar2,
cirrate in varchar2,
cirdate_v in date, 
ciragency_v in varchar2,
 ciragencysubcode_v in varchar2, 
 center_v in varchar2,
  branch_v in varchar2,
  splitdata_v in varchar2,
  subedidata in varchar2,
  splboldsizevalue IN VARCHAR2,
  vatrate_p in float,
  boxcharge_p in float,
  vat_inc_p in varchar2,
  grossamtlocal_p in varchar2,
  billamtlocal_p in varchar2,
  sectioncode_p in varchar2,
  resourceno_p in varchar2,
  caption_inserts_p in varchar2,
    p_error out varchar2

   );
END insertintobookchild;
/

CREATE OR REPLACE PACKAGE BODY insertintobookchild
IS
   PROCEDURE insertintobookchild_p (
      insertdate           IN       DATE,
      edition              IN       VARCHAR2,
      premium1             IN       VARCHAR2,
      premium2             IN       VARCHAR2,
      premallow            IN       VARCHAR2,
      adcategory           IN       VARCHAR2,
      latestdate           IN       DATE,
      material             IN       VARCHAR2,
      cardrate             IN       NUMBER,
      matfilename          IN       VARCHAR2,
      discrate             IN       NUMBER,
      insertstatus         IN       VARCHAR2,
      billstatus           IN       VARCHAR2,
      adsubcat1            IN       VARCHAR2,
      compcode             IN       VARCHAR2,
      userid               IN       VARCHAR2,
      cioid                IN       VARCHAR2,
      height               IN       NUMBER,
      width                IN       NUMBER,
      totalsize            IN       NUMBER,
      pagepost             IN       VARCHAR2,
      premper1             IN       NUMBER,
      premper2             IN       NUMBER,
      colid                IN       VARCHAR2,
      repeat               IN       DATE,
      insertno             IN       INT,
      paid                 IN       VARCHAR2,
      agrrate              IN       NUMBER,
      solorate             IN       NUMBER,
      grossrate            IN       NUMBER,
      insert_pageno        IN       NUMBER,
      insert_remarks       IN       VARCHAR2,
      page_code            IN       VARCHAR2,
      page_per             IN       NUMBER,
      noofcol              IN       NUMBER,
      billamt              IN       NUMBER,
      billrate             IN       NUMBER,
      logo_h               IN       VARCHAR2,
      logo_w               IN       VARCHAR2,
      logo_name            IN       VARCHAR2,
      ad_cat_3             IN       VARCHAR2,
      ad_cat_4             IN       VARCHAR2,
      ad_cat_5             IN       VARCHAR2,
      pkgcode              IN       VARCHAR2,
      gridins              IN       NUMBER,
      pkgalias             IN       VARCHAR2,
      cirvts               IN       VARCHAR2,
      cirpub               IN       VARCHAR2,
      ciredi               IN       VARCHAR2,
      cirrate              IN       VARCHAR2,
      cirdate_v            IN       DATE,
      ciragency_v          IN       VARCHAR2,
      ciragencysubcode_v   IN       VARCHAR2,
      center_v             IN       VARCHAR2,
      branch_v             IN       VARCHAR2,
        splitdata_v          IN       VARCHAR2,
         subedidata in varchar2,
         splboldsizevalue IN VARCHAR2,
          vatrate_p in float,
            boxcharge_p in float,
            vat_inc_p in varchar2,
            grossamtlocal_p in varchar2,
            billamtlocal_p in varchar2,
            sectioncode_p in varchar2,
              resourceno_p in varchar2,
              caption_inserts_p in varchar2,
      p_error              OUT      VARCHAR2
   )
   AS
      edi           VARCHAR2 (50);
      publi         VARCHAR2 (50);
      pub_cent      VARCHAR2 (50);
      supp          VARCHAR2 (50);
      cou1          NUMBER;
      ID            NUMBER;
      insertidval   NUMBER;
      receiptno_m varchar2(50);
      error1 varchar2(100);
   BEGIN
    BEGIN
    select Receipt_no into receiptno_m from tbl_booking_mast_g where cio_booking_id=cioid and rownum<=1;
     EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            NULL;
      END;
      BEGIN
         SELECT COUNT (*)
           INTO cou1
           FROM edition_mast
          WHERE ("Edition_Alias" = edition) AND ("Comp_Code" = compcode);
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            NULL;
      END;

      IF (cou1 > 0)
      THEN
         BEGIN
            SELECT "Edition_Code"
              INTO edi
              FROM edition_mast
             WHERE ("Edition_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         BEGIN
            SELECT "Pub_Code"
              INTO publi
              FROM edition_mast
             WHERE ("Edition_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         BEGIN
            SELECT "City_Code"
              INTO pub_cent
              FROM edition_mast
             WHERE ("Edition_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         supp := '';
      ELSE
         BEGIN
            SELECT "Edition_Code"
              INTO edi
              FROM supplement_mast
             WHERE ("Supp_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         BEGIN
            SELECT "Pub_Code"
              INTO publi
              FROM supplement_mast
             WHERE ("Supp_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         BEGIN
            SELECT "Supp_Code"
              INTO supp
              FROM supplement_mast
             WHERE ("Supp_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         BEGIN
            SELECT "City_Code"
              INTO pub_cent
              FROM edition_mast
             WHERE ("Edition_Code" = edi)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;
      END IF;

      IF (supp IS NULL)
      THEN
         supp := 'MN';
      END IF;

--insertidval:=INSERTID.nextval;
      SELECT insertid.NEXTVAL
        INTO insertidval
        FROM DUAL;
        INSERT INTO tbl_booking_insert_G
                  (CIO_BOOKING_ID, EDITION, INSERT_DATE, COL_CODE,
                   HEIGHT, WIDTH, SIZE_BOOK, PAGE_POST, PREMIUM1,
                   PREM_PER1, PREMIUM2, PREM_PER2, PREMIUM_ALLOW,
                   AD_CAT, AD_SUB_CAT, LATEST_BY, STATUS_MATERIAL,
                   FILE_NAME, CARD_RATE, DISC_RATE, INSERT_STATUS,
                   BILL_STATUS, COMP_CODE, USERID, REPEATING_DATE,
                   NO_INSERT, EDITION_CODE, PUBLICATION_CODE,
                   PUB_CENT_CODE, SUPP_CODE, PAI_FREE_INS,
                   AGREED_RATE, SOLO_RATE, GROSS_RATE, PAGE_NO,
                   REMARKS, PAGE_PREM, PAGE_PER, NO_OFCOLUMN,
                   BILL_AMT, BILL_RATE, LOGO_H, LOGO_W, LOGO_NAME,
                   INSERT_ID, AD_SUBCAT3, AD_SUBCAT4, AD_SUBCAT5,
                   PACKAGE_CODE, INSERTS, PKG_ALIAS, SESID,SPECIAL_SIZE1,VATAMT,BOXCHARGE,VAT_INC,LOCALGROSSAMT, LOCALBILLAMT, SECTIONCODE, RESOURCE_NO,CAPTION
                  )
           VALUES (cioid, edition, insertdate, colid,
                   height, width, totalsize, pagepost, premium1,
                   premper1, premium2, premper2, premallow,
                   adcategory, adsubcat1, latestdate, material,
                   matfilename, cardrate, discrate, insertstatus,
                   billstatus, compcode, userid, repeat,
                   insertno, edi, publi,
                   pub_cent, supp, paid,
                   agrrate, solorate, grossrate, insert_pageno,
                   insert_remarks, page_code, page_per, noofcol,
                   billamt, billrate, logo_h, logo_w, logo_name,
                   insertidval, ad_cat_3, ad_cat_4, ad_cat_5,
                   pkgcode, gridins, pkgalias,USERENV ('sessionid'),splboldsizevalue,vatrate_p,boxcharge_p,vat_inc_p,grossamtlocal_p,billamtlocal_p,sectioncode_p,  resourceno_p,caption_inserts_p
                  );
                  insert_split_details(splitdata_v,receiptno_m,cioid,insertidval,error1);
                 INSERT INTO TEST1 VALUES(edition,'EDITION');
                 insert_edition_details(subedidata,receiptno_m,cioid,insertidval,compcode,edi,insertdate,height,width,totalsize,insertstatus,pkgcode,insertno,error1);
                 commit;
                  --insert into abctest values(edition);
/*                 
      INSERT INTO tbl_booking_insert
                  ("Cio_Booking_Id", "Edition", "Insert_Date", "Col_Code",
                   "Height", "Width", "Size_Book", "Page_Post", "Premium1",
                   "Prem_Per1", "Premium2", "Prem_Per2", "Premium_Allow",
                   "Ad_Cat", "Ad_Sub_Cat", "Latest_By", "Status_Material",
                   "File_Name", "Card_Rate", "Disc_Rate", "Insert_Status",
                   "Bill_Status", "Comp_Code", "Userid", "Repeating_Date",
                   "No_Insert", "Edition_Code", "Publication_Code",
                   "Pub_Cent_Code", "Supp_Code", "Pai_Free_Ins",
                   "Agreed_Rate", "Solo_Rate", "Gross_Rate", "Page_No",
                   "Remarks", "Page_Prem", "Page_Per", "No_Ofcolumn",
                   "Bill_Amt", "Bill_Rate", "Logo_H", "Logo_W", "Logo_name",
                   "Insert_Id", "AD_SUBCAT3", "AD_SUBCAT4", "AD_SUBCAT5",
                   package_code, inserts, pkg_alias
                  )
           VALUES (cioid, edition, insertdate, colid,
                   height, width, totalsize, pagepost, premium1,
                   premper1, premium2, premper2, premallow,
                   adcategory, adsubcat1, latestdate, material,
                   matfilename, cardrate, discrate, insertstatus,
                   billstatus, compcode, userid, repeat,
                   insertno, edi, publi,
                   pub_cent, supp, paid,
                   agrrate, solorate, grossrate, insert_pageno,
                   insert_remarks, page_code, page_per, noofcol,
                   billamt, billrate, logo_h, logo_w, logo_name,
                   insertidval, ad_cat_3, ad_cat_4, ad_cat_5,
                   pkgcode, gridins, pkgalias
                  );
*/
      IF (cirvts IS NOT NULL)
      THEN
         INSERT INTO TBL_BOOKING_VTS_g
                     (compcode, cioid, insertid, vts, publication, edition,
                      rate, ciragcode, ciragsubcode, center,
                      branch, publishdate ,SESID
                     )
              VALUES (compcode, cioid, insertidval, cirvts, cirpub, ciredi,
                      cirrate, ciragency_v, ciragencysubcode_v, center_v,
                      branch_v, cirdate_v,USERENV ('sessionid')
                     );
      END IF;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_error := 'Error:' || SQLERRM;
   END insertintobookchild_p;
END insertintobookchild;
/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PROCEDURE committransaction(
    pcioid          in  varchar2,
    totalcount      in  int,
    pcompcode       in  varchar2,
    pcentname       in  varchar2,
    puserid         in  varchar2,
    pbkid_gentype   in  varchar2,
    pbk_type        in  varchar2,
    p_error         OUT VARCHAR2,
    p_new_cioid     OUT VARCHAR2) is
    
countnum        int;
newid           varchar2(100);
billpay         varchar2(20);
rostatus        varchar2(20);
remarks         varchar2(500);
clientname      varchar2(200);
v_cursor1       TYPES.cursor_type;
v_cursor2       TYPES.cursor_type;

v_cursor1_var1  varchar2(50);
v_cursor1_var2  varchar2(50);
v_cursor2_var1  varchar2(50);

begin
newid:=pcioid;

select count(*) into countnum from tbl_booking_insert_g where Cio_Booking_Id=pcioid;
if(countnum=totalcount) then 
     
    
   getautocodebooking.getautocodebooking_p (compcode        =>  pcompcode,
                                            auto1           =>  '0',
                                            no1             =>  '0',
                                            p_accounts      =>  v_cursor1,
                                            p_accounts1     =>  v_cursor2);
                                            
    FETCH v_cursor1 INTO v_cursor1_var1, v_cursor1_var2;
    
    FETCH v_cursor2 INTO v_cursor2_var1;
    
    if  pbkid_gentype='1' then--1 for First 3 character of Centre Name+Year + Slno  
        
        newid:=substr(pcentname,1,3)||v_cursor1_var2||LPAD(v_cursor1_var1,8,'0');
    
    elsif  pbkid_gentype='2' then--2 for First 3 character of Centre Name+Year + Userid + Slno
    
        newid:=substr(pcentname,1,3)||v_cursor1_var2||LPAD(v_cursor1_var1,8,'0')||puserid;

    elsif  pbkid_gentype='4' then--BK Type + Slno

        newid:=pbk_type||LPAD(v_cursor1_var1,8,'0');

    else

        newid:=LPAD(v_cursor1_var1,8,'0');

    end if; 
    
    p_error     :='Y';
    p_new_cioid := newid;

    INSERT INTO tbladid_ins(CIOID,COUNTNUM,FLAG) VALUES(newid,countnum,p_error);
    INSERT INTO TBL_BOOKING_MAST("date_time", "branch", "booked_by", "cio_booking_id", "prev_booking", "applied_by", "audit", "RO_No", "RO_Date", "Caption", "bill_status", "ro_status", "Agency_code", "Agency_address", "Client_code", "Client_address", "Agency_sub_code", "Dockit_no", "Executive_code", "Executive_zone", "Product_code", "Brand_code", "Key_no", "Bill_remarks", "Print_remark", "Package_code", "No_of_insertion", "Insertion_date", "Repeating_day", "Ad_type_code", "Ad_cat_code", "Ad_sub_cat_code", "Color_code", "Uom_code", "Page_position_code", "Page_type_code", "Page_no", "Ad_size_type_code", "Ad_size_height", "Ad_size_width", "Rate_code", "Scheme_type_code", "Currency_code", "Agrred_rate", "Agreed_amount", "Special_discount", "Space_discount", "Special_charges", "Agency_status", "Agency_type", "Agency_pay", "Agency_credit", "Total_area", "Card_rate", "Card_amount", "Discount", "Discount_per", "Bill_cycle", "Revenue_center", "Bill_pay", "Bill_height", "Bill_width", "Bill_to", "Invoices", "Vts", "Bill_add", "Trade_disc", "Agency_out", "Box_code", "Box_no", "Box_agency", "Box_client", "Box_address", "Comp_code", "Userid", "Creation_datetime", "Booking_type", "Tfn", "Coupan_ad", "Campaign", "Bill_amount", "Page_prem", "Page_amount", "Prem_per", "Gross_amount", "Ad_size_column", "Bill_column", "Bill_area", "Special_disc_per", "Space_disc_per", "Paid_ins", "Contract_rate", "Deviation", "Variant_code", "Contract_name", "Contract_type", "Card_name", "Card_type", "Card_month", "Card_year", "Card_number", "Receipt_no", "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color", "Bullet_code", "Bullet_premium", "Material_status", "Receipt_date", "prev_cioid", "prev_receipt", "prev_grossamt", "Region", "Variant", "Colortype", "Logo_H", "Logo_W", "Logo_color", "Logo_Uom", "SAPID", "RETAINER", "ADD_AGENCY_COMM", "AUDIT_COMMENT", "MOBILENO", "ADD_AGENCY_COMM_AMT", "RETAINER_COMM", "RETAINER_COMM_AMT", "CASH_RECIEVED", "CONT_GROSS", "CIRAGENCY", "CIRRATE", "CIREDITION", "CIRPUBLICATION", "CIRAGENCY_SUBCODE", "BARTER_TYPE", "APP_STATUS", "APP_REMARKS", "APP_DATE", "APP_USER", "RODOCSTATUS",CASHDISCOUNT, CASHDISCTYPE, ATTACHMENT1, ATTACHMENT2,DISC_PREMIUM,DOCTYPE,CHKTRADEDISC,CHK_NO,CHK_DATE,CHK_AMT,CHK_BANK_NAME,OUR_BANK,DEALERPANEL, DEALER_H, DEALER_W, DEALERTYPE,ACTIVE_AGREEDRATE, ACTIVE_AGREEDAMT,LOCALGROSSAMT, LOCALBILLAMT, PACKAGE_TYPE, AD_REFID,RECEIPT_CURRENCY, CONV_CURR_RATE,REVISE_DATE,CLIENT_TYPE) 
    SELECT DATE_TIME, BRANCH, BOOKED_BY, newid CIO_BOOKING_ID, PREV_BOOKING, APPLIED_BY, AUDIT_G, RO_NO, RO_DATE, CAPTION, BILL_STATUS, RO_STATUS, AGENCY_CODE, AGENCY_ADDRESS, CLIENT_CODE, CLIENT_ADDRESS, AGENCY_SUB_CODE, DOCKIT_NO, EXECUTIVE_CODE, EXECUTIVE_ZONE, PRODUCT_CODE, BRAND_CODE, KEY_NO, BILL_REMARKS, PRINT_REMARK, PACKAGE_CODE, NO_OF_INSERTION, INSERTION_DATE, REPEATING_DAY, AD_TYPE_CODE, AD_CAT_CODE, AD_SUB_CAT_CODE, COLOR_CODE, UOM_CODE, PAGE_POSITION_CODE, PAGE_TYPE_CODE, PAGE_NO, AD_SIZE_TYPE_CODE, AD_SIZE_HEIGHT, AD_SIZE_WIDTH, RATE_CODE, SCHEME_TYPE_CODE, CURRENCY_CODE, AGRRED_RATE, AGREED_AMOUNT, SPECIAL_DISCOUNT, SPACE_DISCOUNT, SPECIAL_CHARGES, AGENCY_STATUS, AGENCY_TYPE, AGENCY_PAY, AGENCY_CREDIT, TOTAL_AREA, CARD_RATE, CARD_AMOUNT, DISCOUNT, DISCOUNT_PER, BILL_CYCLE, REVENUE_CENTER, BILL_PAY, BILL_HEIGHT, BILL_WIDTH, BILL_TO, INVOICES, VTS, BILL_ADD, TRADE_DISC, AGENCY_OUT, BOX_CODE, BOX_NO, BOX_AGENCY, BOX_CLIENT, BOX_ADDRESS, COMP_CODE, USERID, CREATION_DATETIME, BOOKING_TYPE, TFN, COUPAN_AD, CAMPAIGN, BILL_AMOUNT, PAGE_PREM, PAGE_AMOUNT, PREM_PER, GROSS_AMOUNT, AD_SIZE_COLUMN, BILL_COLUMN, BILL_AREA, SPECIAL_DISC_PER, SPACE_DISC_PER, PAID_INS, CONTRACT_RATE, DEVIATION, VARIANT_CODE, CONTRACT_NAME, CONTRACT_TYPE, CARD_NAME, CARD_TYPE, CARD_MONTH, CARD_YEAR, CARD_NUMBER, RECEIPT_NO, AD_SUBCAT3, AD_SUBCAT4, AD_SUBCAT5, BG_COLOR, BULLET_CODE, BULLET_PREMIUM, MATERIAL_STATUS, RECEIPT_DATE, PREV_CIOID, PREV_RECEIPT, PREV_GROSSAMT, REGION, VARIANT, COLORTYPE, LOGO_H, LOGO_W, LOGO_COLOR, LOGO_UOM, SAPID, RETAINER, ADD_AGENCY_COMM, AUDIT_COMMENT, MOBILENO, ADD_AGENCY_COMM_AMT, RETAINER_COMM, RETAINER_COMM_AMT, CASH_RECIEVED, CONT_GROSS, CIRAGENCY, CIRRATE, CIREDITION, CIRPUBLICATION, CIRAGENCY_SUBCODE, BARTER_TYPE, APP_STATUS, APP_REMARKS, APP_DATE, APP_USER, RODOCSTATUS,CASHDISCOUNT, CASHDISCTYPE, ATTACHMENT1, ATTACHMENT2, DISC_PREMIUM, DOCTYPE,CHKTRADEDISC,CHK_NO,CHK_DATE,CHK_AMT,CHK_BANK_NAME,OUR_BANK, DEALERPANEL, DEALER_H, DEALER_W, DEALERTYPE,ACTIVE_AGREEDRATE, ACTIVE_AGREEDAMT,LOCALGROSSAMT, LOCALBILLAMT, PACKAGE_TYPE, AD_REFID, RECEIPT_CURRENCY, CONV_CURR_RATE,REVISE_DATE,CLIENT_TYPE FROM TBL_BOOKING_MAST_G WHERE  CIO_BOOKING_ID=pcioid;

    INSERT INTO TBL_BOOKING_insert("Insert_Id", "Cio_Booking_Id", "No_Insert", "Edition_Code", "Publication_Code", "Pub_Cent_Code", "Supp_Code", "Edition", "Insert_Date", "Col_Code", "Height", "Width", "Size_Book", "Page_Post", "Premium1", "Prem_Per1", "Premium2", "Prem_Per2", "Premium_Allow", "Ad_Cat", "Ad_Sub_Cat", "Latest_By", "Repeating_Date", "Status_Material", "File_Name", "Card_Rate", "Disc_Rate", "Insert_Status", "Bill_Status", "Agreed_Rate", "Pai_Free_Ins", "Solo_Rate", "Gross_Rate", "Comp_Code", "Userid", "Page_No", "Remarks", "Pub_Height", "Pub_Width", "Page_Prem", "Page_Per", "No_Ofcolumn", "Bill_Amt", "Bill_Rate", "Logo_H", "Logo_W", "Logo_name", "AD_SUBCAT3", "AD_SUBCAT4", "AD_SUBCAT5", "PACKAGE_CODE", "BILL_NO", "BILL_DATE", "INSERTS", "PKG_ALIAS", "CONT_GROSS_AMT", "APP_STATUS", "APP_REMARKS", "APP_DATE", "APP_USER",SPECIAL_SIZE1,VATAMT,BOXCHARGE,VAT_INC,LOCALGROSSAMT, LOCALBILLAMT,SECTIONCODE,RESOURCE_NO,CAPTION) 
    SELECT INSERT_ID, newid CIO_BOOKING_ID, NO_INSERT, EDITION_CODE, PUBLICATION_CODE, PUB_CENT_CODE, SUPP_CODE, EDITION, INSERT_DATE, COL_CODE, HEIGHT, WIDTH, SIZE_BOOK, PAGE_POST, PREMIUM1, PREM_PER1, PREMIUM2, PREM_PER2, PREMIUM_ALLOW, AD_CAT, AD_SUB_CAT, LATEST_BY, REPEATING_DATE, STATUS_MATERIAL, FILE_NAME, CARD_RATE, DISC_RATE, INSERT_STATUS, BILL_STATUS, AGREED_RATE, PAI_FREE_INS, SOLO_RATE, GROSS_RATE, COMP_CODE, USERID, PAGE_NO, REMARKS, PUB_HEIGHT, PUB_WIDTH, PAGE_PREM, PAGE_PER, NO_OFCOLUMN, BILL_AMT, BILL_RATE, LOGO_H, LOGO_W, LOGO_NAME, AD_SUBCAT3, AD_SUBCAT4, AD_SUBCAT5, PACKAGE_CODE, BILL_NO, BILL_DATE, INSERTS, PKG_ALIAS, CONT_GROSS_AMT, APP_STATUS, APP_REMARKS, APP_DATE, APP_USER, SPECIAL_SIZE1,VATAMT, BOXCHARGE, VAT_INC,LOCALGROSSAMT, LOCALBILLAMT, SECTIONCODE, RESOURCE_NO,CAPTION FROM TBL_BOOKING_INSERT_G WHERE  CIO_BOOKING_ID=pcioid;

    INSERT INTO TBL_BOOKING_VTS(COMPCODE, CIOID, INSERTID, VTS, PUBLICATION, EDITION, RATE, CREATIONDATETIME, CIRAGCODE, CIRAGSUBCODE, CENTER, BRANCH, PUBLISHDATE) 
    SELECT COMPCODE, newid CIOID, INSERTID, VTS, PUBLICATION, EDITION, RATE, CREATIONDATETIME, CIRAGCODE, CIRAGSUBCODE, CENTER, BRANCH, PUBLISHDATE FROM TBL_BOOKING_VTS_G WHERE  cioid=pcioid;

    insert into tbl_booking_insert_sizesplit(CIOID, RECEIPTNO, INSERTID, INSERTDATE, HEIGHT, WIDTH, AREA, SRNO, CREATIONDATETIME)
    select newid CIOID, RECEIPTNO, INSERTID, INSERTDATE, HEIGHT, WIDTH, AREA, SRNO, CREATIONDATETIME from tbl_booking_insert_sizesplit_g where cioid=pcioid;

    --INSERT INTO ABCTEST VALUES(newid,counttest);
    insert into tbl_booking_subedition(COMP_CODE, CIOID, INSERTID, PUBLICATION, EDITION, INSERTDATE, HEIGHT, WIDTH, TOTALAREA, INSERTSTATUS, RECEIPTNO,SRNO, NO_INSERT)
    select COMP_CODE, newid CIOID, INSERTID, PUBLICATION, EDITION, INSERTDATE, HEIGHT, WIDTH, TOTALAREA, INSERTSTATUS, RECEIPTNO, SRNO, NO_INSERT from tbl_booking_subedition_g
    where tbl_booking_subedition_g.CIOID=pcioid;

    insert into TBL_BOOKING_SHARING_TRANS(PUBLICATION, TYPE, SHARING, CIOID, SRNO)
    select PUBLICATION, TYPE, SHARING, newid CIOID, SRNO from TBL_BOOKING_SHARING_TRANS_g where CIOID=pcioid ;

    insert into TBL_BOOKING_FMG_TRANS(CIOID, INSERTID, CREATIONDATETIME)
    select newid CIOID, INSERTID, CREATIONDATETIME from TBL_BOOKING_FMG_TRANS_G where CIOID=cioid;

    select "Bill_pay","ro_status" into billpay,rostatus from tbl_booking_mast where "cio_booking_id"=newid;

    if billpay = 'CA0' and rostatus='1' then
        declare
            cursor c1 is
            select * from tbl_booking_mast where "cio_booking_id"=newid;
        v1 c1%rowtype;

        v_error      varchar2(2000);
        v_rcptno_r   varchar2(50);
        vrecpt       varchar2(20);
        branchcode   varchar2(20);
        vrepcode     varchar2(20);
        subagencyreg varchar2(20);
        prevcioid_v  varchar2(50);
        billamt_v    float;
        grossamt_v   float;
        v_curdate     date;
    begin
        open c1;
            fetch c1 into v1;
        Begin
            select "Branch_Code" into branchcode from branch_mst where "Comp_Code"=v1."Comp_code" and "Branch_Name"=v1."branch";
        Exception When no_data_found then
            branchcode:=v1."branch";
        End;
   
        Begin
            select "SUB_Agency_Code" into subagencyreg from agency_mast where "Comp_Code"=v1."Comp_code" and "code_subcode"=v1."Agency_sub_code";
        Exception When no_data_found then
            subagencyreg:='';
        End;
        vrecpt       :=v1."Receipt_no";
        prevcioid_v  :=v1."prev_cioid";
        if prevcioid_v is null or v1."prev_receipt" is null then
            billamt_v   :=v1."Bill_amount";
            grossamt_v  :=v1."Gross_amount";
            v_curdate   :=to_date(sysdate);
        else
            select "Bill_amount","Gross_amount" into  billamt_v,grossamt_v from tbl_booking_mast where "cio_booking_id"=prevcioid_v;
            billamt_v   :=v1."Bill_amount" - billamt_v;
            grossamt_v :=v1."Gross_amount" - grossamt_v;
            IF grossamt_v=0 OR grossamt_v IS NULL THEN
                grossamt_v:=v1."Gross_amount";
            END IF;
            v_curdate  :=to_date(sysdate);
        end if;

        -- select substr(max("recptno"),1,12)||lpad(substr(max("recptno"),-6)+1,6,'0') into vrecpt from ad_rcpthdr where "unit"=branchcode and "doctype"='RCP' and
        -- "recptdt" between '1-mar-2011' and '31-mar-2011';
         
        --receiptsave_booking.receiptsave_booking_P(pcompcode,puserid , punit ,ptype , precpt , prdate , ppaymodres ,preceivedreg ,pvouno  ,pamount  ,pagency , pothercd ,
        --pchno  ,pchedate , pbank  , pnarration ,prep   , pvdate , pag_main_code ,pag_sub_code , ourbank,  cioid , execname , retainer ,
        -- prevcioid , p_error)
        begin
            SELECT "Cust_Name" into clientname FROM CUST_MAST WHERE "Cust_Code" = v1."Client_code" and "Comp_Code"=v1."Comp_code";
        exception when NO_DATA_FOUND THEN
            clientname:=v1."Client_code";
        END;

        remarks:='RONO#'||v1."RO_No" ||' RODATE# ' || to_char(v1."RO_Date",'dd-mon-yyyy') || ' BOOKINGID# ' || v1."cio_booking_id" || ' CLIENT#' || clientname;

        receiptsave_booking.receiptsave_booking_p(v1."Comp_code",v1."Userid", v1."branch",V1.DOCTYPE,vrecpt,v_curdate,v1."Bill_pay",'','',billamt_v,v1."Agency_sub_code",grossamt_v,
            '','','',remarks,vrepcode,v1."date_time",v1."Agency_code",subagencyreg,'',v1."cio_booking_id",v1."Executive_code",v1.RETAINER,v1."prev_cioid",v_rcptno_r,v_error);
   
        update tbl_booking_mast set "Receipt_no"=v_rcptno_r,"Receipt_date"= v_curdate where "cio_booking_id"=v1."cio_booking_id";
    close c1;
    commit;
 end;
 end if;
 /*
 INSERT INTO TBL_BOOKING_MAST("date_time", "branch", "booked_by", "cio_booking_id", "prev_booking", "applied_by", "audit", "RO_No", "RO_Date", "Caption", "bill_status", "ro_status", "Agency_code", "Agency_address", "Client_code", "Client_address", "Agency_sub_code", "Dockit_no", "Executive_code", "Executive_zone", "Product_code", "Brand_code", "Key_no", "Bill_remarks", "Print_remark", "Package_code", "No_of_insertion", "Insertion_date", "Repeating_day", "Ad_type_code", "Ad_cat_code", "Ad_sub_cat_code", "Color_code", "Uom_code", "Page_position_code", "Page_type_code", "Page_no", "Ad_size_type_code", "Ad_size_height", "Ad_size_width", "Rate_code", "Scheme_type_code", "Currency_code", "Agrred_rate", "Agreed_amount", "Special_discount", "Space_discount", "Special_charges", "Agency_status", "Agency_type", "Agency_pay", "Agency_credit", "Total_area", "Card_rate", "Card_amount", "Discount", "Discount_per", "Bill_cycle", "Revenue_center", "Bill_pay", "Bill_height", "Bill_width", "Bill_to", "Invoices", "Vts", "Bill_add", "Trade_disc", "Agency_out", "Box_code", "Box_no", "Box_agency", "Box_client", "Box_address", "Comp_code", "Userid", "Creation_datetime", "Booking_type", "Tfn", "Coupan_ad", "Campaign", "Bill_amount", "Page_prem", "Page_amount", "Prem_per", "Gross_amount", "Ad_size_column", "Bill_column", "Bill_area", "Special_disc_per", "Space_disc_per", "Paid_ins", "Contract_rate", "Deviation", "Variant_code", "Contract_name", "Contract_type", "Card_name", "Card_type", "Card_month", "Card_year", "Card_number", "Receipt_no", "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color", "Bullet_code", "Bullet_premium", "Material_status", "Receipt_date", "prev_cioid", "prev_receipt", "prev_grossamt", "Region", "Variant", "Colortype", "Logo_H", "Logo_W", "Logo_color", "Logo_Uom", "SAPID", "RETAINER", "ADD_AGENCY_COMM", "AUDIT_COMMENT", "MOBILENO", "ADD_AGENCY_COMM_AMT", "RETAINER_COMM", "RETAINER_COMM_AMT", "CASH_RECIEVED", "CONT_GROSS", "CIRAGENCY", "CIRRATE", "CIREDITION", "CIRPUBLICATION", "CIRAGENCY_SUBCODE", "BARTER_TYPE", "APP_STATUS", "APP_REMARKS", "APP_DATE", "APP_USER", "RODOCSTATUS") 
SELECT DATE_TIME, BRANCH, BOOKED_BY, CIO_BOOKING_ID, PREV_BOOKING, APPLIED_BY, AUDIT_G, RO_NO, RO_DATE, CAPTION, BILL_STATUS, RO_STATUS, AGENCY_CODE, AGENCY_ADDRESS, CLIENT_CODE, CLIENT_ADDRESS, AGENCY_SUB_CODE, DOCKIT_NO, EXECUTIVE_CODE, EXECUTIVE_ZONE, PRODUCT_CODE, BRAND_CODE, KEY_NO, BILL_REMARKS, PRINT_REMARK, PACKAGE_CODE, NO_OF_INSERTION, INSERTION_DATE, REPEATING_DAY, AD_TYPE_CODE, AD_CAT_CODE, AD_SUB_CAT_CODE, COLOR_CODE, UOM_CODE, PAGE_POSITION_CODE, PAGE_TYPE_CODE, PAGE_NO, AD_SIZE_TYPE_CODE, AD_SIZE_HEIGHT, AD_SIZE_WIDTH, RATE_CODE, SCHEME_TYPE_CODE, CURRENCY_CODE, AGRRED_RATE, AGREED_AMOUNT, SPECIAL_DISCOUNT, SPACE_DISCOUNT, SPECIAL_CHARGES, AGENCY_STATUS, AGENCY_TYPE, AGENCY_PAY, AGENCY_CREDIT, TOTAL_AREA, CARD_RATE, CARD_AMOUNT, DISCOUNT, DISCOUNT_PER, BILL_CYCLE, REVENUE_CENTER, BILL_PAY, BILL_HEIGHT, BILL_WIDTH, BILL_TO, INVOICES, VTS, BILL_ADD, TRADE_DISC, AGENCY_OUT, BOX_CODE, BOX_NO, BOX_AGENCY, BOX_CLIENT, BOX_ADDRESS, COMP_CODE, USERID, CREATION_DATETIME, BOOKING_TYPE, TFN, COUPAN_AD, CAMPAIGN, BILL_AMOUNT, PAGE_PREM, PAGE_AMOUNT, PREM_PER, GROSS_AMOUNT, AD_SIZE_COLUMN, BILL_COLUMN, BILL_AREA, SPECIAL_DISC_PER, SPACE_DISC_PER, PAID_INS, CONTRACT_RATE, DEVIATION, VARIANT_CODE, CONTRACT_NAME, CONTRACT_TYPE, CARD_NAME, CARD_TYPE, CARD_MONTH, CARD_YEAR, CARD_NUMBER, RECEIPT_NO, AD_SUBCAT3, AD_SUBCAT4, AD_SUBCAT5, BG_COLOR, BULLET_CODE, BULLET_PREMIUM, MATERIAL_STATUS, RECEIPT_DATE, PREV_CIOID, PREV_RECEIPT, PREV_GROSSAMT, REGION, VARIANT, COLORTYPE, LOGO_H, LOGO_W, LOGO_COLOR, LOGO_UOM, SAPID, RETAINER, ADD_AGENCY_COMM, AUDIT_COMMENT, MOBILENO, ADD_AGENCY_COMM_AMT, RETAINER_COMM, RETAINER_COMM_AMT, CASH_RECIEVED, CONT_GROSS, CIRAGENCY, CIRRATE, CIREDITION, CIRPUBLICATION, CIRAGENCY_SUBCODE, BARTER_TYPE, APP_STATUS, APP_REMARKS, APP_DATE, APP_USER, RODOCSTATUS FROM TBL_BOOKING_MAST_G WHERE SESID=USERENV ('sessionid') and CIO_BOOKING_ID=cioid;

INSERT INTO TBL_BOOKING_insert("Insert_Id", "Cio_Booking_Id", "No_Insert", "Edition_Code", "Publication_Code", "Pub_Cent_Code", "Supp_Code", "Edition", "Insert_Date", "Col_Code", "Height", "Width", "Size_Book", "Page_Post", "Premium1", "Prem_Per1", "Premium2", "Prem_Per2", "Premium_Allow", "Ad_Cat", "Ad_Sub_Cat", "Latest_By", "Repeating_Date", "Status_Material", "File_Name", "Card_Rate", "Disc_Rate", "Insert_Status", "Bill_Status", "Agreed_Rate", "Pai_Free_Ins", "Solo_Rate", "Gross_Rate", "Comp_Code", "Userid", "Page_No", "Remarks", "Pub_Height", "Pub_Width", "Page_Prem", "Page_Per", "No_Ofcolumn", "Bill_Amt", "Bill_Rate", "Logo_H", "Logo_W", "Logo_name", "AD_SUBCAT3", "AD_SUBCAT4", "AD_SUBCAT5", "PACKAGE_CODE", "BILL_NO", "BILL_DATE", "INSERTS", "PKG_ALIAS", "CONT_GROSS_AMT", "APP_STATUS", "APP_REMARKS", "APP_DATE", "APP_USER") 
SELECT INSERT_ID, CIO_BOOKING_ID, NO_INSERT, EDITION_CODE, PUBLICATION_CODE, PUB_CENT_CODE, SUPP_CODE, EDITION, INSERT_DATE, COL_CODE, HEIGHT, WIDTH, SIZE_BOOK, PAGE_POST, PREMIUM1, PREM_PER1, PREMIUM2, PREM_PER2, PREMIUM_ALLOW, AD_CAT, AD_SUB_CAT, LATEST_BY, REPEATING_DATE, STATUS_MATERIAL, FILE_NAME, CARD_RATE, DISC_RATE, INSERT_STATUS, BILL_STATUS, AGREED_RATE, PAI_FREE_INS, SOLO_RATE, GROSS_RATE, COMP_CODE, USERID, PAGE_NO, REMARKS, PUB_HEIGHT, PUB_WIDTH, PAGE_PREM, PAGE_PER, NO_OFCOLUMN, BILL_AMT, BILL_RATE, LOGO_H, LOGO_W, LOGO_NAME, AD_SUBCAT3, AD_SUBCAT4, AD_SUBCAT5, PACKAGE_CODE, BILL_NO, BILL_DATE, INSERTS, PKG_ALIAS, CONT_GROSS_AMT, APP_STATUS, APP_REMARKS, APP_DATE, APP_USER FROM TBL_BOOKING_INSERT_G WHERE SESID=USERENV ('sessionid') and CIO_BOOKING_ID=cioid;

*/
else
rollback;
 p_error        :=  'N';
 p_new_cioid    :=  newid;
--DELETE FROM TBL_BOOKING_INSERT WHERE "Cio_Booking_Id"=cioid;
--DELETE FROM TBL_BOOKING_mast WHERE "cio_booking_id"=cioid;
INSERT INTO tbladid_ins(CIOID,COUNTNUM,FLAG) VALUES(newid,countnum,p_error);
end if;
--delete from tbl_booking_mast_g where  CIO_BOOKING_ID=cioid;
--delete from tbl_booking_insert_g where  CIO_BOOKING_ID=cioid;
--delete from tbl_booking_vts_g where  cioid=newid;
end;
/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PACKAGE getdataforexecute
IS
   TYPE t_accounts_cursor IS REF CURSOR;

   PROCEDURE  getdataforexecute_p (


compcode in varchar2,
ciobid  in varchar2,

      p_accounts   OUT      t_accounts_cursor,
      p_accounts1   OUT      t_accounts_cursor,
      p_accounts2   OUT      t_accounts_cursor,
      p_accounts3   OUT      t_accounts_cursor,
      p_accounts4   OUT      t_accounts_cursor,
      p_accounts5   OUT      t_accounts_cursor,
      p_accounts6   OUT      t_accounts_cursor,
      p_accounts7   OUT      t_accounts_cursor,
      p_accounts8   OUT      t_accounts_cursor,
      p_accounts9   out       t_accounts_cursor,
      p_accounts10   out       t_accounts_cursor,
      p_accounts11   out       t_accounts_cursor,
      p_accounts12   out       t_accounts_cursor

   );
END  getdataforexecute;
/

CREATE OR REPLACE PACKAGE BODY getdataforexecute
IS
   PROCEDURE  getdataforexecute_p (
           compcode in varchar2,
ciobid  in varchar2,
p_accounts   OUT      t_accounts_cursor,
p_accounts1   OUT      t_accounts_cursor,
p_accounts2   OUT      t_accounts_cursor,
p_accounts3   OUT      t_accounts_cursor,
p_accounts4   OUT      t_accounts_cursor,
p_accounts5   OUT      t_accounts_cursor,
p_accounts6   OUT      t_accounts_cursor,
p_accounts7   OUT      t_accounts_cursor,
p_accounts8   OUT      t_accounts_cursor,
p_accounts9   out      t_accounts_cursor,
p_accounts10   out       t_accounts_cursor,
p_accounts11   out       t_accounts_cursor,
p_accounts12   out       t_accounts_cursor
   )
   AS
   --adv_subcat_code   varchar2(20);
   --adcat3 varchar2(20);
   --adcat4 varchar2(20);
   BEGIN

    --BEGIN
        insert into advcategories select "Ad_Sub_Cat","AD_SUBCAT3","AD_SUBCAT4" from tbl_booking_insert where ("Comp_Code"=compcode) and ("Cio_Booking_Id"=ciobid);
       
        --EXCEPTION WHEN NO_DATA_FOUND
        --THEN NULL;
    --END;

    OPEN p_accounts FOR
        select "Cio_Booking_Id" as  "cio_booking_id","Edition","Insert_Date" as "Insert_date","Col_Code" as "Col_code" ,"Height","Width","Size_Book" as "Size_book","Page_Post" as "Page_post","Premium1","Prem_Per1" as "Prem_per1","Premium2",nvl("Prem_Per2",'0') as "Prem_per2","Premium_Allow" as "Premium_allow","Ad_Cat" as "Ad_cat","Ad_Sub_Cat" as "Ad_sub_cat","Latest_By"as "Latest_by","Status_Material" as "Status_material" ,"File_Name" as "File_name","Card_Rate" as "Card_rate",nvl("Disc_Rate",'0') as "Disc_rate","Insert_Status" as "Insert_status","Bill_Status" as "Bill_status","Comp_Code" as "comp_code","Userid","Repeating_Date" as "Repeating_date" ,"No_Insert" as "no_insert","Edition_Code" as "Edition_code","Publication_Code" as "Publication_code","Pub_Cent_Code" as "Pub_cent_code","Supp_Code" as "Supp_code",nvl("Agreed_Rate",'0') as "Agreed_rate","Pai_Free_Ins" as "Pai_free_ins",nvl("Solo_Rate",'0') as "Solo_rate","Insert_Id" as "insert_id","Gross_Rate" as "Gross_rate","Page_No" as "Page_no" ,"Remarks","Page_Prem" as "Page_prem",nvl("Page_Per",'0') as "page_per","No_Ofcolumn" as "No_ofcolumn","Bill_Amt" as "Bill_Amt","Bill_Rate" as "Bill_rate", "Logo_H" as "Logo_H", "Logo_W" as "Logo_W" , "Logo_name" as "Logo_name","AD_SUBCAT3","AD_SUBCAT4","AD_SUBCAT5",PACKAGE_CODE,INSERTS,PKG_ALIAS
        ,"Publication_Code" AS "PUBCODE",
 (SELECT VTS FROM TBL_BOOKING_VTS WHERE CIOID="Cio_Booking_Id" and INSERTID="Insert_Id") as VTS,
 (SELECT PUBLICATION FROM TBL_BOOKING_VTS WHERE CIOID="Cio_Booking_Id" and INSERTID="Insert_Id") as CIRPUBLICATION,
 (SELECT EDITION FROM TBL_BOOKING_VTS WHERE CIOID="Cio_Booking_Id" and INSERTID="Insert_Id") as CIREDITION,
 (SELECT RATE FROM TBL_BOOKING_VTS WHERE CIOID="Cio_Booking_Id" and INSERTID="Insert_Id") as CIRRATE,
 (SELECT PUBLISHDATE FROM TBL_BOOKING_VTS WHERE CIOID="Cio_Booking_Id" and INSERTID="Insert_Id") as CIRPUBLISHDATE,
 (SELECT edtn_name FROM cir_edtn_mast WHERE comp_code=compcode AND edtn=(SELECT EDITION FROM TBL_BOOKING_VTS WHERE CIOID="Cio_Booking_Id" and INSERTID="Insert_Id")) AS CIREDITIONNAME
 ,
(select NVL(PRIORITY,'1') FROM TBL_PRIORITY_UOM WHERE EDITION_CODE=TBL_BOOKING_INSERT."Edition_Code" and TBL_PRIORITY_UOM.COMBIN_CODE=TBL_BOOKING_INSERT.PACKAGE_CODE) AS PRIORITY,
(SELECT SPLIT FROM COMBIN_MAST WHERE "Combin_Code"=PACKAGE_CODE)  as SPLIT,SPECIAL_SIZE1,VATAMT, nvl(BOXCHARGE,'') as BOXCHARGE,NVL(VAT_INC,'0') as VAT_INC,nvl(LOCALGROSSAMT,"Gross_Rate") as LOCALGROSSAMT, nvl(LOCALBILLAMT,"Bill_Amt") AS LOCALBILLAMT,
NVL(SECTIONCODE,'') AS SECTIONCODE, NVL(RESOURCE_NO,'') AS RESOURCE_NO,NVL(CAPTION,'') AS CAPTION
         from tbl_booking_insert where ("Comp_Code"=compcode) and ("Cio_Booking_Id"=ciobid) order by "Insert_Id";


    OPEN p_accounts1 FOR
        select "Col_Name" as  "col_Name","Col_Code" as "col_Code" from col_mast where ("Comp_Code"=compcode);
    OPEN p_accounts2 FOR
        select "premiumname" as "premiumname","Premiumcode" as "Premiumcode" from ADVPOS_PREM_MAST where ("comp_code"=compcode);
    OPEN p_accounts3 FOR
        select "Adv_Subcat_Name","Adv_Subcat_Code" from adv_subcat_mast;
    OPEN p_accounts4 FOR
        select "Uom_Name" as "uom_name","Uom_Code" as "uom_code" from uom_mast where ("Comp_Code"=compcode);
    OPEN p_accounts5 FOR
        select "Adv_Type_Name" as "adv_type_name","Adv_Type_Code" as "adv_type_code" from adv_type_mast where "Comp_Code"=compcode;
    OPEN p_accounts6 FOR
        select "Adv_Cat_Name" as "adv_cat_name","Adv_Cat_Code" as "adv_cat_code" from ADV_CAT_MAST where ("Comp_Code"=compcode);
    OPEN p_accounts7 FOR
        select "Pos_Type_Code" as "pos_type_code","Pos_Type" as "pos_type" from advpos_type_mast where ("Comp_Code"=compcode);
    OPEN p_accounts8 FOR
        select   "Paid_permission"   from Module_DetaiButtonl  where ("comp_code"=compcode) and ("Form_Name"='Booking_master');

    open p_accounts9 for
        select "Logo_name" as "Logo_name"from tbl_booking_insert where "Comp_Code"=compcode and "Cio_Booking_Id"=ciobid and rownum<=1;

    open p_accounts10 for
        select "catname","catcode" from ad_cat3 where "subcatname" in (select AD_SUB_CAT from advcategories) order by "catname";

    open p_accounts11 for
        select "Cat_Name","Cat_Code" from tbl_cat4 where "Sub_Cat_Name" in (select AD_SUBCAT3 from advcategories) order by "Cat_Name";

    open p_accounts12 for
        select "Cat_Name","Cat_Code" from tbl_cat5 where "Sub_Cat_Name" in (select AD_SUBCAT4 from advcategories) order by "Cat_Name";
    
 
 
   END  getdataforexecute_P;
END  getdataforexecute;
/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PACKAGE insertintobookchild_display
IS
   TYPE t_accounts_cursor IS REF CURSOR;

   PROCEDURE  insertintobookchild_display_p (


    insertdate in date,
edition in varchar2,
premium1 in varchar2,
premium2 in varchar2,
premallow in varchar2,
adcategory in varchar2,
latestdate in date,
material in varchar2,
cardrate in number,
matfilename in varchar2,
discrate in number,
insertstatus in varchar2,
billstatus in varchar2,
adsubcat1 in varchar2,
compcode in varchar2,
userid in varchar2,
cioid in varchar2,
height in number,
width in number,
totalsize in number,
pagepost in varchar2,
premper1 in number,
premper2 in number,
colid in varchar2,
repeat in date,
insertno in int,
paid in varchar2,
agrrate in number,
solorate in number,
grossrate in number,
insert_pageno in number,
insert_remarks in varchar2,
page_code in varchar2,
page_per in number,
noofcol in number,
billamt in number,
billrate in number,
logo_h in varchar2,
logo_w in varchar2,
logo_name in varchar2,
ad_cat_3 in varchar2,
ad_cat_4 in varchar2,
ad_cat_5 in varchar2,
pkgcode in varchar2,
gridins in number,
pkgalias in varchar2,
insertid1 in number,
cirvts in varchar2,
cirpub in varchar2,
ciredi in varchar2,
cirrate in varchar2,
cirdate_v in date, 
ciragency_v in varchar2,
 ciragencysubcode_v in varchar2, 
 center_v in varchar2,
  branch_v in varchar2,
    boxcharge_p in float,
    vat_inc_p in varchar2,
    vatrate_p in float,
    grossamtlocal_p in number,
    billamtlocal_p in number,
    sectioncode_p in varchar2,
    resourceno_p in varchar2,
    caption_inserts_p in varchar2
   );
END insertintobookchild_display;
/

CREATE OR REPLACE PACKAGE BODY insertintobookchild_display
IS
   PROCEDURE insertintobookchild_display_p (
    insertdate in date,
    edition in varchar2,
    premium1 in varchar2,
    premium2 in varchar2,
    premallow in varchar2,
    adcategory in varchar2,
    latestdate in date,
    material in varchar2,
    cardrate in number,
    matfilename in varchar2,
    discrate in number,
    insertstatus in varchar2,
    billstatus in varchar2,
    adsubcat1 in varchar2,
    compcode in varchar2,
    userid in varchar2,
    cioid in varchar2,
    height in number,
    width in number,
    totalsize in number,
    pagepost in varchar2,
    premper1 in number,
    premper2 in number,
    colid in varchar2,
    repeat in date,
    insertno in int,
    paid in varchar2,
    agrrate in number,
    solorate in number,
    grossrate in number,
    insert_pageno in number,
    insert_remarks in varchar2,
    page_code in varchar2,
    page_per in number,
    noofcol in number,
    billamt in number,
    billrate in number,
    logo_h in varchar2,
    logo_w in varchar2,
    logo_name in varchar2,
    ad_cat_3 in varchar2,
    ad_cat_4 in varchar2,
    ad_cat_5 in varchar2,
    pkgcode in varchar2,
    gridins in number,
    pkgalias in varchar2,
    insertid1 in number,
    cirvts in varchar2,
cirpub in varchar2,
ciredi in varchar2,
cirrate in varchar2,
cirdate_v in date, 
ciragency_v in varchar2,
 ciragencysubcode_v in varchar2, 
 center_v in varchar2,
  branch_v in varchar2,
    boxcharge_p in float,
     vat_inc_p in varchar2,
     vatrate_p in float,
     grossamtlocal_p in number,
    billamtlocal_p in number,
    sectioncode_p in varchar2,
    resourceno_p in varchar2,
    caption_inserts_p in varchar2
    )
   
AS
    edi varchar2(50);
    publi varchar2(50);
    pub_cent varchar2(50);
    supp varchar2(50);
    cou1 number;
    id number;
    billnum varchar2(50);
    retain varchar2(50);
    executive varchar(50);    
insertidval number;
countcir number;
    BEGIN
        begin
            select count(*) into cou1 from edition_mast where ("Edition_Alias"=edition) and ("Comp_Code"=compcode);
            exception when no_data_found then NULL ;
        end;

    if(cou1 >0) then
        begin
            select "Edition_Code" into edi from edition_mast where ("Edition_Alias"=edition) and ("Comp_Code"=compcode);
            exception when no_data_found then NULL ;
        end;

        begin
            select "Pub_Code" into publi from edition_mast where ("Edition_Alias"=edition) and ("Comp_Code"=compcode);
            exception when no_data_found then NULL ;
        end;

        begin
            select "City_Code" into pub_cent from edition_mast where ("Edition_Alias"=edition) and ("Comp_Code"=compcode);
            exception when no_data_found then NULL ;
        end;

        supp:='';
    else
        begin
            select "Edition_Code" into edi from  supplement_mast where ("Supp_Alias"=edition) and ("Comp_Code"=compcode);
            exception when no_data_found then NULL ;
        end;

        begin
            select"Pub_Code" into publi from  supplement_mast where ("Supp_Alias"=edition) and ("Comp_Code"=compcode);
            exception when no_data_found then NULL ;
        end;

        begin
            select "Supp_Code"   into  supp  from  supplement_mast where ("Supp_Alias"=edition) and ("Comp_Code"=compcode);
            exception when no_data_found then NULL ;
        end;

        begin
            select "City_Code"  into pub_cent from edition_mast where ("Edition_Code"=edi) and ("Comp_Code"=compcode);
            exception when no_data_found then NULL ;
        end;
    end if;

    if(supp is null) then
        supp:='MN';
    end if;

    if(insertid1 is null or insertid1='0' or insertid1='') then
        select INSERTID.nextval into insertidval from dual;
        
        insert into tbl_booking_insert("Cio_Booking_Id","Edition","Insert_Date","Col_Code","Height","Width","Size_Book","Page_Post","Premium1","Prem_Per1","Premium2","Prem_Per2","Premium_Allow","Ad_Cat","Ad_Sub_Cat","Latest_By","Status_Material","File_Name","Card_Rate","Disc_Rate","Insert_Status","Bill_Status","Comp_Code","Userid","Repeating_Date","No_Insert","Edition_Code","Publication_Code","Pub_Cent_Code","Supp_Code","Pai_Free_Ins","Agreed_Rate","Solo_Rate","Gross_Rate","Page_No","Remarks","Page_Prem","Page_Per","No_Ofcolumn","Bill_Amt","Bill_Rate","Logo_H", "Logo_W", "Logo_name","Insert_Id","AD_SUBCAT3","AD_SUBCAT4","AD_SUBCAT5",PACKAGE_CODE,INSERTS,PKG_ALIAS,BOXCHARGE,VAT_INC,VATAMT,LOCALGROSSAMT,LOCALBILLAMT, SECTIONCODE,RESOURCE_NO,CAPTION)
        values(cioid,edition,insertdate,colid,height,width,totalsize,pagepost,premium1,premper1,premium2,premper2,premallow,adcategory,adsubcat1,latestdate,material,matfilename,cardrate,discrate,insertstatus,billstatus,compcode,userid,repeat,insertno,edi,publi,pub_cent,supp,paid,agrrate,solorate,grossrate,insert_pageno,insert_remarks,page_code,page_per,noofcol,billamt,billrate,logo_h,logo_w,logo_name,insertidval,ad_cat_3,ad_cat_4,ad_cat_5, pkgcode,gridins,pkgalias,boxcharge_p,vat_inc_p,vatrate_p,grossamtlocal_p,billamtlocal_p,sectioncode_p,resourceno_p,caption_inserts_p);
        if(cirvts is not null) then
        insert into tbl_booking_vts(COMPCODE,CIOID,INSERTID,VTS,PUBLICATION,EDITION,RATE,CIRAGCODE,CIRAGSUBCODE,CENTER,BRANCH,PUBLISHDATE)
                    values(compcode,cioid,insertidval,cirvts,cirpub,ciredi,cirrate,ciragency_v, ciragencysubcode_v, center_v, branch_v,cirdate_v);
        end if;            
    else
        update  tbl_booking_insert set "Edition"=edition,"Insert_Date"=insertdate,"Col_Code"=colid,"Height"=height,"Width"=width,"Size_Book"=totalsize,"Page_Post"=pagepost,"Premium1"=premium1,"Prem_Per1"=premper1,"Premium2"=premium2,"Prem_Per2"=premper2,"Premium_Allow"=premallow,"Ad_Cat"=adcategory,"Ad_Sub_Cat"=adsubcat1,"Latest_By"=latestdate,"Status_Material"=material,"File_Name"=matfilename,"Card_Rate"=cardrate,"Disc_Rate"=discrate,"Insert_Status"=insertstatus,"Bill_Status"=billstatus,"Comp_Code"=compcode,"Userid"=userid,"Repeating_Date"=repeat,"No_Insert"=insertno,"Edition_Code"=edi,"Publication_Code"=publi,"Pub_Cent_Code"=pub_cent,"Supp_Code"=supp,"Pai_Free_Ins"=paid,"Agreed_Rate"=agrrate,"Solo_Rate"=solorate,"Gross_Rate"=grossrate,"Page_No"=insert_pageno,"Remarks"=insert_remarks,"Page_Prem"=page_code,"Page_Per"=page_per,"No_Ofcolumn"=noofcol,"Bill_Amt"=billamt,"Bill_Rate"=billrate,"Logo_H"=logo_h, "Logo_W"=logo_w, "Logo_name"=logo_name,"AD_SUBCAT3"=ad_cat_3,"AD_SUBCAT4"=ad_cat_4,"AD_SUBCAT5"=ad_cat_5,PACKAGE_CODE=pkgcode,INSERTS=gridins,PKG_ALIAS=pkgalias,BOXCHARGE=boxcharge_p, VAT_INC=vat_inc_p,VATAMT=vatrate_p, LOCALGROSSAMT=grossamtlocal_p, LOCALBILLAMT=billamtlocal_p, SECTIONCODE=sectioncode_p, RESOURCE_NO=resourceno_p,CAPTION=caption_inserts_p where "Cio_Booking_Id"=cioid AND "Insert_Id"=insertid1;
        if insertstatus = 'cancel' then
            update tbl_booking_subedition set INSERTSTATUS='cancel' where tbl_booking_subedition.cioid=cioid and insertid=insertid1;
        end if;
         begin
            select count(*) into countcir from tbl_booking_vts where CIOID=cioid and INSERTID=insertid1;
            exception when no_data_found then countcir:=0 ;
        end;
        if(countcir=0) then
        insertidval:=insertid1;
        insert into tbl_booking_vts(COMPCODE,CIOID,INSERTID,VTS,PUBLICATION,EDITION,RATE,CIRAGCODE,CIRAGSUBCODE,CENTER,BRANCH,PUBLISHDATE)
                    values(compcode,cioid,insertidval,cirvts,cirpub,ciredi,cirrate,ciragency_v, ciragencysubcode_v, center_v, branch_v,cirdate_v);
        else
            update tbl_booking_vts set VTS=cirvts,PUBLICATION=cirpub,EDITION=ciredi,RATE=cirrate,CIRAGCODE=ciragency_v,CIRAGSUBCODE=ciragencysubcode_v,PUBLISHDATE=cirdate_v where  CIOID=cioid and INSERTID=insertid1;
        end if;

        
    if insertstatus = 'billed' then
        begin
            select BILL_NO into billnum from tbl_booking_insert where "Cio_Booking_Id"=cioid AND "Insert_Id"=insertid1;
            exception when no_data_found then NULL ;
        end;
        if billnum is not null then
            begin
                SELECT "Executive_code",RETAINER into executive, retain from tbl_booking_mast where "cio_booking_id"=cioid;
                exception when no_data_found then  NULL;
            end; 
            if retain is not null then
                update ad_bills set  retainer_code=retain,executive_name=NULL where bilno=billnum;
            end if;
            if executive is not null then
                update ad_bills set  executive_name=executive,retainer_code=NULL where bilno=billnum;
            end if;
        end if;
    
    end if;
end if;
   END insertintobookchild_display_p;
END insertintobookchild_display;
/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PACKAGE insertintobookchild_update
IS
   TYPE t_accounts_cursor IS REF CURSOR;

   PROCEDURE  insertintobookchild_update_p (


    insertdate in date,
edition in varchar2,
premium1 in varchar2,
premium2 in varchar2,
premallow in varchar2,
adcategory in varchar2,
latestdate in date,
material in varchar2,
cardrate in number,
matfilename in varchar2,
discrate in number,
insertstatus in varchar2,
billstatus in varchar2,
adsubcat1 in varchar2,
compcode in varchar2,
userid in varchar2,
cioid in varchar2,
height in number,
width in number,
totalsize in number,
pagepost in varchar2,
premper1 in number,
premper2 in number,
colid in varchar2,
repeat in date,
insertno in int,
paid in varchar2,
agrrate in number,
solorate in number,
grossrate in number,
insert_pageno in number,
insert_remarks in varchar2,
page_code in varchar2,
page_per in number,
noofcol in number,
billamt in number,
billrate in number,
logo_h in varchar2,
logo_w in varchar2,
logo_name in varchar2,
ad_cat_3 in varchar2,
ad_cat_4 in varchar2,
ad_cat_5 in varchar2,
pkgcode in varchar2,
gridins in number,
pkgalias in varchar2,
insertid1 in varchar2,
cirvts in varchar2,
cirpub in varchar2,
ciredi in varchar2,
cirrate in varchar2,
cirdate_v in date, 
ciragency_v in varchar2,
 ciragencysubcode_v in varchar2, 
 center_v in varchar2,
  branch_v in varchar2,
  splboldsizevalue VARCHAR2,
  vatrate_p float,
  boxcharge_p FLOAT,
  vat_inc_p varchar2,
  grossamtlocal_p float,
  billamtlocal_p float,
  sectioncode_p varchar2,
   resourceno_p varchar2,
   caption_inserts_p in varchar2

   );
END insertintobookchild_update;
/

CREATE OR REPLACE PACKAGE BODY insertintobookchild_update
IS
   PROCEDURE insertintobookchild_update_p (
    insertdate in date,
edition in varchar2,
premium1 in varchar2,
premium2 in varchar2,
premallow in varchar2,
adcategory in varchar2,
latestdate in date,
material in varchar2,
cardrate in number,
matfilename in varchar2,
discrate in number,
insertstatus in varchar2,
billstatus in varchar2,
adsubcat1 in varchar2,
compcode in varchar2,
userid in varchar2,
cioid in varchar2,
height in number,
width in number,
totalsize in number,
pagepost in varchar2,
premper1 in number,
premper2 in number,
colid in varchar2,
repeat in date,
insertno in int,
paid in varchar2,
agrrate in number,
solorate in number,
grossrate in number,
insert_pageno in number,
insert_remarks in varchar2,
page_code in varchar2,
page_per in number,
noofcol in number,
billamt in number,
billrate in number,
logo_h in varchar2,
logo_w in varchar2,
logo_name in varchar2,
ad_cat_3 in varchar2,
ad_cat_4 in varchar2,
ad_cat_5 in varchar2,
pkgcode in varchar2,
gridins in number,
pkgalias in varchar2,
insertid1 in varchar2,
cirvts in varchar2,
cirpub in varchar2,
ciredi in varchar2,
cirrate in varchar2,
cirdate_v in date, 
ciragency_v in varchar2,
 ciragencysubcode_v in varchar2, 
 center_v in varchar2,
  branch_v in varchar2,
   splboldsizevalue VARCHAR2,
   vatrate_p float,
   boxcharge_p FLOAT,
   vat_inc_p varchar2,
    grossamtlocal_p float,
  billamtlocal_p float,
  sectioncode_p varchar2,
  resourceno_p varchar2,
  caption_inserts_p in varchar2
   )
   AS




edi  varchar2(20);
publi  varchar2(20);
pub_cent   varchar2(20);
supp  varchar2(20);
cou1  number;
id  number;
insertidval number;
countcir number;
BEGIN
begin
select count(*) into  cou1   from edition_mast where ("Edition_Alias"=edition) and ("Comp_Code"=compcode);
exception when no_data_found then
NULL ;
end;

if(cou1 >0)
then
begin
select "Edition_Code" into edi from edition_mast where ("Edition_Alias"=edition) and ("Comp_Code"=compcode);
exception when no_data_found then
NULL ;
end;

begin
select "Pub_Code" into publi from edition_mast where ("Edition_Alias"=edition) and ("Comp_Code"=compcode);
exception when no_data_found then
NULL ;
end;

begin
select  "City_Code" into pub_cent from edition_mast where ("Edition_Alias"=edition) and ("Comp_Code"=compcode);
exception when no_data_found then
NULL ;
end;

 supp:='';


else

begin

select "Edition_Code" into edi from  supplement_mast where ("Supp_Alias"=edition) and ("Comp_Code"=compcode);
exception when no_data_found then
NULL ;
end;

begin
select"Pub_Code" into publi from  supplement_mast where ("Supp_Alias"=edition) and ("Comp_Code"=compcode);
exception when no_data_found then
NULL ;
end;

begin
select "Supp_Code"   into  supp  from  supplement_mast where ("Supp_Alias"=edition) and ("Comp_Code"=compcode);
exception when no_data_found then
NULL ;
end;

begin
select "City_Code"  into pub_cent from edition_mast where ("Edition_Code"=edi) and ("Comp_Code"=compcode);
exception when no_data_found then
NULL ;
end;

end if;

if(supp is null)
then

 supp:='MN';

end if;

if(insertid1 is null or insertid1='0' or insertid1='') then
 select INSERTID.nextval into insertidval from dual;
insert into tbl_booking_insert("Cio_Booking_Id","Edition","Insert_Date","Col_Code","Height","Width","Size_Book","Page_Post","Premium1","Prem_Per1","Premium2","Prem_Per2","Premium_Allow","Ad_Cat","Ad_Sub_Cat","Latest_By","Status_Material","File_Name","Card_Rate","Disc_Rate","Insert_Status","Bill_Status","Comp_Code","Userid","Repeating_Date","No_Insert","Edition_Code","Publication_Code","Pub_Cent_Code","Supp_Code","Pai_Free_Ins","Agreed_Rate","Solo_Rate","Gross_Rate","Page_No","Remarks","Page_Prem","Page_Per","No_Ofcolumn","Bill_Amt","Bill_Rate","Logo_H", "Logo_W", "Logo_name","Insert_Id","AD_SUBCAT3","AD_SUBCAT4","AD_SUBCAT5",PACKAGE_CODE,INSERTS,PKG_ALIAS,SPECIAL_SIZE1,VATAMT,BOXCHARGE,VAT_INC,LOCALGROSSAMT,LOCALBILLAMT, SECTIONCODE,RESOURCE_NO,CAPTION)
values(cioid,edition,insertdate,colid,height,width,totalsize,pagepost,premium1,premper1,premium2,premper2,premallow,adcategory,adsubcat1,latestdate,material,matfilename,cardrate,discrate,insertstatus,billstatus,compcode,userid,repeat,insertno,edi,publi,pub_cent,supp,paid,agrrate,solorate,grossrate,insert_pageno,insert_remarks,page_code,page_per,noofcol,billamt,billrate,logo_h,logo_w,logo_name,insertidval,ad_cat_3,ad_cat_4,ad_cat_5, pkgcode,gridins,pkgalias, splboldsizevalue,vatrate_p,boxcharge_p,vat_inc_p ,grossamtlocal_p,billamtlocal_p,sectioncode_p,resourceno_p,caption_inserts_p);
 if(cirvts is not null) then
        insert into tbl_booking_vts(COMPCODE,CIOID,INSERTID,VTS,PUBLICATION,EDITION,RATE,CIRAGCODE,CIRAGSUBCODE,CENTER,BRANCH,PUBLISHDATE)
                    values(compcode,cioid,insertidval,cirvts,cirpub,ciredi,cirrate,ciragency_v, ciragencysubcode_v, center_v, branch_v,cirdate_v);
        end if;
else

update  tbl_booking_insert set  "Edition"=edition,"Insert_Date"=insertdate,"Col_Code"=colid,"Height"=height,"Width"=width,"Size_Book"=totalsize,"Page_Post"=pagepost,"Premium1"=premium1,"Prem_Per1"=premper1,"Premium2"=premium2,"Prem_Per2"=premper2,"Premium_Allow"=premallow,"Ad_Cat"=adcategory,"Ad_Sub_Cat"=adsubcat1,"Latest_By"=latestdate,"Status_Material"=material,"File_Name"=matfilename,"Card_Rate"=cardrate,"Disc_Rate"=discrate,"Insert_Status"=insertstatus,"Bill_Status"=billstatus,"Comp_Code"=compcode,"Userid"=userid,"Repeating_Date"=repeat,"No_Insert"=insertno,"Edition_Code"=edi,"Publication_Code"=publi,"Pub_Cent_Code"=pub_cent,"Supp_Code"=supp,"Pai_Free_Ins"=paid,"Agreed_Rate"=agrrate,"Solo_Rate"=solorate,"Gross_Rate"=grossrate,"Page_No"=insert_pageno,"Remarks"=insert_remarks,"Page_Prem"=page_code,"Page_Per"=page_per,"No_Ofcolumn"=noofcol,"Bill_Amt"=billamt,"Bill_Rate"=billrate,"Logo_H"=logo_h, "Logo_W"=logo_w, "Logo_name"=logo_name,"AD_SUBCAT3"=ad_cat_3,"AD_SUBCAT4"=ad_cat_4,"AD_SUBCAT5"=ad_cat_5,PACKAGE_CODE=pkgcode,INSERTS=gridins,PKG_ALIAS=pkgalias, SPECIAL_SIZE1= splboldsizevalue,VATAMT=vatrate_p,BOXCHARGE=boxcharge_p,VAT_INC=vat_inc_p,LOCALGROSSAMT=grossamtlocal_p,LOCALBILLAMT=billamtlocal_p,SECTIONCODE=sectioncode_p,RESOURCE_NO=resourceno_p,CAPTION=caption_inserts_p  where "Cio_Booking_Id"=cioid and "Insert_Id" = insertid1;
if insertstatus = 'cancel' then
            update tbl_booking_subedition set INSERTSTATUS='cancel' where tbl_booking_subedition.cioid=cioid and insertid=insertid1;
        end if;
  begin
            select count(*) into countcir from tbl_booking_vts where CIOID=cioid and INSERTID=insertid1;
            exception when no_data_found then countcir:=0 ;
        end;
        if(countcir=0) then
        insertidval:=insertid1;
        insert into tbl_booking_vts(COMPCODE,CIOID,INSERTID,VTS,PUBLICATION,EDITION,RATE,CIRAGCODE,CIRAGSUBCODE,CENTER,BRANCH,PUBLISHDATE)
                    values(compcode,cioid,insertidval,cirvts,cirpub,ciredi,cirrate,ciragency_v, ciragencysubcode_v, center_v, branch_v,cirdate_v);
        else
            update tbl_booking_vts set VTS=cirvts,PUBLICATION=cirpub,EDITION=ciredi,RATE=cirrate,CIRAGCODE=ciragency_v,CIRAGSUBCODE=ciragencysubcode_v,PUBLISHDATE=cirdate_v where  CIOID=cioid and INSERTID=insertid1;
        end if;
end if;
   END insertintobookchild_update_p;
END insertintobookchild_update;
/


CREATE OR REPLACE PACKAGE insertintobookchild
IS
   TYPE t_accounts_cursor IS REF CURSOR;

   PROCEDURE  insertintobookchild_p (


    insertdate in date,
edition in varchar2,
premium1 in varchar2,
premium2 in varchar2,
premallow in varchar2,
adcategory in varchar2,
latestdate in date,
material in varchar2,
cardrate in number,
matfilename in varchar2,
discrate in number,
insertstatus in varchar2,
billstatus in varchar2,
adsubcat1 in varchar2,
compcode in varchar2,
userid in varchar2,
cioid in varchar2,
height in number,
width in number,
totalsize in number,
pagepost in varchar2,
premper1 in number,
premper2 in number,
colid in varchar2,
repeat in date,
insertno in int,
paid in varchar2,
agrrate in number,
solorate in number,
grossrate in number,
insert_pageno in number,
insert_remarks in varchar2,
page_code in varchar2,
page_per in number,
noofcol in number,
billamt in number,
billrate in number,
logo_h in varchar2,
logo_w in varchar2,
logo_name in varchar2,
ad_cat_3 in varchar2,
ad_cat_4 in varchar2,
ad_cat_5 in varchar2,
pkgcode in varchar2,
gridins in number,
pkgalias in varchar2,
cirvts in varchar2,
cirpub in varchar2,
ciredi in varchar2,
cirrate in varchar2,
cirdate_v in date, 
ciragency_v in varchar2,
 ciragencysubcode_v in varchar2, 
 center_v in varchar2,
  branch_v in varchar2,
  splitdata_v in varchar2,
  subedidata in varchar2,
  splboldsizevalue IN VARCHAR2,
  vatrate_p in float,
  boxcharge_p in float,
  vat_inc_p in varchar2,
  grossamtlocal_p in varchar2,
  billamtlocal_p in varchar2,
  sectioncode_p in varchar2,
  resourceno_p in varchar2,
  caption_inserts_p in varchar2,
    p_error out varchar2

   );
END insertintobookchild;
/

CREATE OR REPLACE PACKAGE BODY insertintobookchild
IS
   PROCEDURE insertintobookchild_p (
      insertdate           IN       DATE,
      edition              IN       VARCHAR2,
      premium1             IN       VARCHAR2,
      premium2             IN       VARCHAR2,
      premallow            IN       VARCHAR2,
      adcategory           IN       VARCHAR2,
      latestdate           IN       DATE,
      material             IN       VARCHAR2,
      cardrate             IN       NUMBER,
      matfilename          IN       VARCHAR2,
      discrate             IN       NUMBER,
      insertstatus         IN       VARCHAR2,
      billstatus           IN       VARCHAR2,
      adsubcat1            IN       VARCHAR2,
      compcode             IN       VARCHAR2,
      userid               IN       VARCHAR2,
      cioid                IN       VARCHAR2,
      height               IN       NUMBER,
      width                IN       NUMBER,
      totalsize            IN       NUMBER,
      pagepost             IN       VARCHAR2,
      premper1             IN       NUMBER,
      premper2             IN       NUMBER,
      colid                IN       VARCHAR2,
      repeat               IN       DATE,
      insertno             IN       INT,
      paid                 IN       VARCHAR2,
      agrrate              IN       NUMBER,
      solorate             IN       NUMBER,
      grossrate            IN       NUMBER,
      insert_pageno        IN       NUMBER,
      insert_remarks       IN       VARCHAR2,
      page_code            IN       VARCHAR2,
      page_per             IN       NUMBER,
      noofcol              IN       NUMBER,
      billamt              IN       NUMBER,
      billrate             IN       NUMBER,
      logo_h               IN       VARCHAR2,
      logo_w               IN       VARCHAR2,
      logo_name            IN       VARCHAR2,
      ad_cat_3             IN       VARCHAR2,
      ad_cat_4             IN       VARCHAR2,
      ad_cat_5             IN       VARCHAR2,
      pkgcode              IN       VARCHAR2,
      gridins              IN       NUMBER,
      pkgalias             IN       VARCHAR2,
      cirvts               IN       VARCHAR2,
      cirpub               IN       VARCHAR2,
      ciredi               IN       VARCHAR2,
      cirrate              IN       VARCHAR2,
      cirdate_v            IN       DATE,
      ciragency_v          IN       VARCHAR2,
      ciragencysubcode_v   IN       VARCHAR2,
      center_v             IN       VARCHAR2,
      branch_v             IN       VARCHAR2,
        splitdata_v          IN       VARCHAR2,
         subedidata in varchar2,
         splboldsizevalue IN VARCHAR2,
          vatrate_p in float,
            boxcharge_p in float,
            vat_inc_p in varchar2,
            grossamtlocal_p in varchar2,
            billamtlocal_p in varchar2,
            sectioncode_p in varchar2,
              resourceno_p in varchar2,
              caption_inserts_p in varchar2,
      p_error              OUT      VARCHAR2
   )
   AS
      edi           VARCHAR2 (50);
      publi         VARCHAR2 (50);
      pub_cent      VARCHAR2 (50);
      supp          VARCHAR2 (50);
      cou1          NUMBER;
      ID            NUMBER;
      insertidval   NUMBER;
      receiptno_m varchar2(50);
      error1 varchar2(100);
   BEGIN
    BEGIN
    select Receipt_no into receiptno_m from tbl_booking_mast_g where cio_booking_id=cioid and rownum<=1;
     EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            NULL;
      END;
      BEGIN
         SELECT COUNT (*)
           INTO cou1
           FROM edition_mast
          WHERE ("Edition_Alias" = edition) AND ("Comp_Code" = compcode);
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            NULL;
      END;

      IF (cou1 > 0)
      THEN
         BEGIN
            SELECT "Edition_Code"
              INTO edi
              FROM edition_mast
             WHERE ("Edition_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         BEGIN
            SELECT "Pub_Code"
              INTO publi
              FROM edition_mast
             WHERE ("Edition_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         BEGIN
            SELECT "City_Code"
              INTO pub_cent
              FROM edition_mast
             WHERE ("Edition_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         supp := '';
      ELSE
         BEGIN
            SELECT "Edition_Code"
              INTO edi
              FROM supplement_mast
             WHERE ("Supp_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         BEGIN
            SELECT "Pub_Code"
              INTO publi
              FROM supplement_mast
             WHERE ("Supp_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         BEGIN
            SELECT "Supp_Code"
              INTO supp
              FROM supplement_mast
             WHERE ("Supp_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         BEGIN
            SELECT "City_Code"
              INTO pub_cent
              FROM edition_mast
             WHERE ("Edition_Code" = edi)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;
      END IF;

      IF (supp IS NULL)
      THEN
         supp := 'MN';
      END IF;

--insertidval:=INSERTID.nextval;
      SELECT insertid.NEXTVAL
        INTO insertidval
        FROM DUAL;
        INSERT INTO tbl_booking_insert_G
                  (CIO_BOOKING_ID, EDITION, INSERT_DATE, COL_CODE,
                   HEIGHT, WIDTH, SIZE_BOOK, PAGE_POST, PREMIUM1,
                   PREM_PER1, PREMIUM2, PREM_PER2, PREMIUM_ALLOW,
                   AD_CAT, AD_SUB_CAT, LATEST_BY, STATUS_MATERIAL,
                   FILE_NAME, CARD_RATE, DISC_RATE, INSERT_STATUS,
                   BILL_STATUS, COMP_CODE, USERID, REPEATING_DATE,
                   NO_INSERT, EDITION_CODE, PUBLICATION_CODE,
                   PUB_CENT_CODE, SUPP_CODE, PAI_FREE_INS,
                   AGREED_RATE, SOLO_RATE, GROSS_RATE, PAGE_NO,
                   REMARKS, PAGE_PREM, PAGE_PER, NO_OFCOLUMN,
                   BILL_AMT, BILL_RATE, LOGO_H, LOGO_W, LOGO_NAME,
                   INSERT_ID, AD_SUBCAT3, AD_SUBCAT4, AD_SUBCAT5,
                   PACKAGE_CODE, INSERTS, PKG_ALIAS, SESID,SPECIAL_SIZE1,VATAMT,BOXCHARGE,VAT_INC,LOCALGROSSAMT, LOCALBILLAMT, SECTIONCODE, RESOURCE_NO,CAPTION
                  )
           VALUES (cioid, edition, insertdate, colid,
                   height, width, totalsize, pagepost, premium1,
                   premper1, premium2, premper2, premallow,
                   adcategory, adsubcat1, latestdate, material,
                   matfilename, cardrate, discrate, insertstatus,
                   billstatus, compcode, userid, repeat,
                   insertno, edi, publi,
                   pub_cent, supp, paid,
                   agrrate, solorate, grossrate, insert_pageno,
                   insert_remarks, page_code, page_per, noofcol,
                   billamt, billrate, logo_h, logo_w, logo_name,
                   insertidval, ad_cat_3, ad_cat_4, ad_cat_5,
                   pkgcode, gridins, pkgalias,USERENV ('sessionid'),splboldsizevalue,vatrate_p,boxcharge_p,vat_inc_p,grossamtlocal_p,billamtlocal_p,sectioncode_p,  resourceno_p,caption_inserts_p
                  );
                  insert_split_details(splitdata_v,receiptno_m,cioid,insertidval,error1);
                 INSERT INTO TEST1 VALUES(edition,'EDITION');
                 insert_edition_details(subedidata,receiptno_m,cioid,insertidval,compcode,edi,insertdate,height,width,totalsize,insertstatus,pkgcode,insertno,error1);
                 commit;
                  --insert into abctest values(edition);
/*                 
      INSERT INTO tbl_booking_insert
                  ("Cio_Booking_Id", "Edition", "Insert_Date", "Col_Code",
                   "Height", "Width", "Size_Book", "Page_Post", "Premium1",
                   "Prem_Per1", "Premium2", "Prem_Per2", "Premium_Allow",
                   "Ad_Cat", "Ad_Sub_Cat", "Latest_By", "Status_Material",
                   "File_Name", "Card_Rate", "Disc_Rate", "Insert_Status",
                   "Bill_Status", "Comp_Code", "Userid", "Repeating_Date",
                   "No_Insert", "Edition_Code", "Publication_Code",
                   "Pub_Cent_Code", "Supp_Code", "Pai_Free_Ins",
                   "Agreed_Rate", "Solo_Rate", "Gross_Rate", "Page_No",
                   "Remarks", "Page_Prem", "Page_Per", "No_Ofcolumn",
                   "Bill_Amt", "Bill_Rate", "Logo_H", "Logo_W", "Logo_name",
                   "Insert_Id", "AD_SUBCAT3", "AD_SUBCAT4", "AD_SUBCAT5",
                   package_code, inserts, pkg_alias
                  )
           VALUES (cioid, edition, insertdate, colid,
                   height, width, totalsize, pagepost, premium1,
                   premper1, premium2, premper2, premallow,
                   adcategory, adsubcat1, latestdate, material,
                   matfilename, cardrate, discrate, insertstatus,
                   billstatus, compcode, userid, repeat,
                   insertno, edi, publi,
                   pub_cent, supp, paid,
                   agrrate, solorate, grossrate, insert_pageno,
                   insert_remarks, page_code, page_per, noofcol,
                   billamt, billrate, logo_h, logo_w, logo_name,
                   insertidval, ad_cat_3, ad_cat_4, ad_cat_5,
                   pkgcode, gridins, pkgalias
                  );
*/
      IF (cirvts IS NOT NULL)
      THEN
         INSERT INTO TBL_BOOKING_VTS_g
                     (compcode, cioid, insertid, vts, publication, edition,
                      rate, ciragcode, ciragsubcode, center,
                      branch, publishdate ,SESID
                     )
              VALUES (compcode, cioid, insertidval, cirvts, cirpub, ciredi,
                      cirrate, ciragency_v, ciragencysubcode_v, center_v,
                      branch_v, cirdate_v,USERENV ('sessionid')
                     );
      END IF;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_error := 'Error:' || SQLERRM;
   END insertintobookchild_p;
END insertintobookchild;
/
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PACKAGE executebooking IS
TYPE T_Accounts_Cursor IS REF CURSOR;
PROCEDURE executebooking_p(
compcode in varchar2,
ciobookid in varchar2,
docno in varchar2:=null,
keyno in varchar2:=null,
rono in varchar2:=null,
agencycode in varchar2:=null,
client in varchar2:=null,
booking in varchar2,
 dateformat     IN          VARCHAR2,
      revenue in varchar2,
P_Accounts  OUT  T_Accounts_Cursor,P_Accounts1  OUT  T_Accounts_Cursor,P_Accounts2  OUT  T_Accounts_Cursor
,P_Accounts3  OUT  T_Accounts_Cursor
);
end executebooking ;
/
CREATE OR REPLACE PACKAGE BODY executebooking
IS
   PROCEDURE executebooking_p (
      compcode      IN       VARCHAR2,
      ciobookid     IN       VARCHAR2,
      docno         IN       VARCHAR2 := NULL,
      keyno         IN       VARCHAR2 := NULL,
      rono          IN       VARCHAR2 := NULL,
      agencycode    IN       VARCHAR2 := NULL,
      client        IN       VARCHAR2 := NULL,
      booking       IN       VARCHAR2,
       dateformat     IN          VARCHAR2,
      revenue in varchar2,
      p_accounts    OUT      t_accounts_cursor,
      p_accounts1   OUT      t_accounts_cursor,
      p_accounts2   OUT      t_accounts_cursor,
      P_Accounts3  OUT  T_Accounts_Cursor
   )
   AS
      VERSION1   NUMBER;
      count1    NUMBER;

   BEGIN

       DELETE from tempbooking_mast;

      INSERT INTO tempbooking_mast
         SELECT "date_time", "branch", "booked_by", "cio_booking_id",
                "prev_booking", "applied_by", "audit", "RO_No", "RO_Date",
                "Caption", "bill_status", "ro_status", "Agency_code",
                "Agency_address", "Client_code", "Client_address",
                "Agency_sub_code", "Dockit_no", "Executive_code",
                "Executive_zone", "Product_code", "Brand_code", "Key_no",
                "Bill_remarks", "Print_remark", "Package_code",
                "No_of_insertion", "Insertion_date", "Repeating_day",
                "Ad_type_code", "Ad_cat_code", "Ad_sub_cat_code",
                "Color_code", "Uom_code", "Page_position_code",
                "Page_type_code", "Page_no", "Ad_size_type_code",
                "Ad_size_height", "Ad_size_width", "Rate_code",
                "Scheme_type_code", "Currency_code", nvl("Agrred_rate",'0'),
                nvl("Agreed_amount",'0'), "Special_discount", "Space_discount",
                "Special_charges", "Agency_status", "Agency_type",
                "Agency_pay", "Agency_credit", "Total_area", "Card_rate",
                "Card_amount", nvl("Discount",'0'), "Discount_per", "Bill_cycle",
                "Revenue_center", "Bill_pay", "Bill_height", "Bill_width",
                "Bill_to", "Invoices", "Vts", "Bill_add", "Trade_disc",
                "Agency_out", "Box_code", "Box_no", "Box_agency",
                "Box_client", "Box_address", "Comp_code", "Userid",
                "Creation_datetime", "Booking_type", "Tfn", "Coupan_ad",
                "Campaign", "Bill_amount", "Page_prem", "Page_amount",
                "Prem_per", "Gross_amount", "Ad_size_column", "Bill_column",
                "Bill_area", "Special_disc_per", "Space_disc_per",
                "Paid_ins", "Contract_rate", "Deviation", "Variant_code",
                "Contract_name", "Contract_type", "Card_name", "Card_type",
                "Card_month", "Card_year", "Card_number", "Receipt_no",
                "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color",
                "Bullet_code", "Bullet_premium", "Material_status",
                trunc("Receipt_date"), "prev_cioid", "prev_receipt",
                "prev_grossamt", "Region", "Variant", "Colortype", "Logo_H",
                "Logo_W", "Logo_color", "Logo_Uom",sapid,RETAINER,"ADD_AGENCY_COMM",MOBILENO,ADD_AGENCY_COMM_AMT,RETAINER_COMM,RETAINER_COMM_AMT,CASH_RECIEVED,CIRAGENCY,CIRRATE,CIREDITION,CIRPUBLICATION,CIRAGENCY_SUBCODE,BARTER_TYPE,
                CASHDISCOUNT, CASHDISCTYPE, ATTACHMENT1, ATTACHMENT2, DISC_PREMIUM,CHKTRADEDISC,CHK_DATE, CHK_AMT, CHK_BANK_NAME, OUR_BANK, CHK_NO,DEALERPANEL, DEALER_H, DEALER_W, DEALERTYPE,ACTIVE_AGREEDRATE,ACTIVE_AGREEDAMT,
                LOCALGROSSAMT, LOCALBILLAMT,PACKAGE_TYPE,AD_REFID,RECEIPT_CURRENCY, CONV_CURR_RATE,REVISE_DATE, CLIENT_TYPE
           FROM tbl_booking_mast
          WHERE ("Comp_code" = compcode OR compcode IS NULL)
            AND (("cio_booking_id" = ciobookid OR ciobookid IS NULL
                ) OR("Receipt_no"=ciobookid OR ciobookid IS NULL))
            AND ("Dockit_no" LIKE docno || '%' OR docno IS NULL)
            AND ("Key_no" LIKE keyno || '%' OR keyno IS NULL)
            AND ("RO_No" LIKE rono || '%' OR rono IS NULL)
            AND ("Agency_sub_code" LIKE agencycode || '%' OR agencycode IS NULL)
            AND ("Client_code" LIKE client || '%' OR client IS NULL)
           AND ("Ad_type_code" LIKE booking || '%' OR booking IS NULL) 
           AND "branch" in(SELECT LTRIM(RTRIM(BRANCH_CODE)) FROM LOGIN_BRANCH_MAST WHERE USER_CODE=revenue and COMP_CODE=compcode and USER_FLAG='Y')
            ORDER BY "Creation_datetime";



  --Dbms_output.put_line('rinki--');
      OPEN p_accounts FOR
           SELECT CASE dateformat
                     WHEN 'mm/dd/yyyy' THEN TO_CHAR("date_time",'mm/dd/yyyy')
                  WHEN 'dd/mm/yyyy' THEN TO_CHAR("date_time",'dd/mm/yyyy')
                     WHEN 'yyyy/mm/dd' THEN TO_CHAR("date_time",'yyyy/mm/dd')  END AS date_time,
                      "branch","booked_by", "cio_booking_id", "prev_booking", "applied_by",
                "audit", "RO_No", TO_CHAR("RO_Date", 'dd/mm/yyyy') AS "RO_Date",
                "Caption", "bill_status", "ro_status", "Agency_code",
                "Agency_address", "Client_code", "Client_address",
                "Agency_sub_code", "Dockit_no", "Executive_code",
                "Executive_zone", "Product_code", "Brand_code", "Key_no",
                "Bill_remarks", "Print_remark", "Package_code",
                "No_of_insertion",
                TO_CHAR("Insertion_date", 'dd/mm/yyyy') AS "Insertion_date",
                "Repeating_day", "Ad_type_code", "Ad_cat_code",
                "Ad_sub_cat_code", "Color_code", "Uom_code",
                "Page_position_code", "Page_type_code", "Page_no",
                "Ad_size_type_code", "Ad_size_height", "Ad_size_width",
                "Rate_code",
                (SELECT "Scheme_Name" FROM scheme_master WHERE "scheme_id" =tempbooking_mast."Scheme_type_code")AS "Scheme_type_code",
                 "Currency_code", "Agrred_rate", "Agreed_amount",
                "Special_discount", "Space_discount", "Special_charges",
                tempbooking_mast."Comp_code", tempbooking_mast."Userid",
                tempbooking_mast."Agency_status", "Agency_type", "Agency_pay",
                "Agency_credit", "Total_area", "Card_rate", "Card_amount",
                "Discount", "Discount_per", "Bill_cycle", "Revenue_center",
                "Bill_pay", "Bill_height", "Bill_width",
                tempbooking_mast."Bill_to", "Invoices", "Vts", "Bill_add",
                "Trade_disc", "Agency_out", "Booking_type", "Campaign",
                "Page_prem", "Page_amount", "Prem_per", "Gross_amount",
                "Bill_amount", "Box_code", "Box_no", "Box_agency",
                "Box_client", "Box_address", "Tfn", "Coupan_ad",
                "Ad_size_column", "Bill_column", "Bill_area",
                "Special_disc_per", "Space_disc_per",
                   agency_mast."Agency_Name"
                || '('
                || agency_mast."code_subcode"
                || ')' AS "AgencyName",
                (SELECT   exec_mast."Exec_name"
                        || '('
                        || TO_CHAR(exec_mast."Exe_no")
                        || ')'
                   FROM exec_mast
                  WHERE tempbooking_mast."Executive_code" = exec_mast."Exe_no"
                    AND tempbooking_mast."Comp_code" = exec_mast."comp_code") AS "execname",
                    --91
                (SELECT    product_cat_mast."prod_desc"
                        || '('
                        || product_cat_mast."prod_cat_code"
                        || ')'
                   FROM product_cat_mast
                  WHERE tempbooking_mast."Product_code" = product_cat_mast."prod_cat_code"
                    AND tempbooking_mast."Comp_code" = product_cat_mast."comp_code") AS "product",
                    --92
                "Paid_ins", "Contract_rate", "Deviation", "Variant_code",
                (select "deal_name" from contract_mast where "Deal_No"= (select "deal_code" from contract_detail where "ContractCode"= "Contract_name")) as "Contract_name", "Contract_type", "Card_name", "Card_type",
                --100
                "Card_month", "Card_year", "Card_number", "Receipt_no",
                "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color",
                "Bullet_code", "Bullet_premium",
                (SELECT "Agency_Name" FROM agency_mast
                  WHERE "code_subcode" =tempbooking_mast."Agency_sub_code") AS "AgencySubCode",
              --111
                NVL ((SELECT "Cust_Name" FROM cust_mast WHERE "Cust_Code" = "Client_code"), '') AS "Client",                                       --112
                (SELECT "Payment_Mode_Name" FROM payment_mode_mast WHERE "Pay_Mode_Code" = "Agency_pay") AS "PayMode",
                (SELECT "Adv_Cat_Name" FROM adv_cat_mast WHERE adv_cat_mast."Adv_Cat_Code" =tempbooking_mast."Ad_cat_code") AS "categoryname",
                (SELECT "Adv_Subcat_Name" FROM adv_subcat_mast  WHERE adv_subcat_mast."Adv_Subcat_Code" =tempbooking_mast."Ad_sub_cat_code")
                 AS "subcategoryname",
                (SELECT "brand_name" FROM brand_mst WHERE "brand_code" =tempbooking_mast."Brand_code") AS "Brand",
                (SELECT "Uom_Name" FROM uom_mast WHERE "Uom_Code" = tempbooking_mast."Uom_code") AS "UOM",
                (SELECT "premiumname" FROM advpos_prem_mast WHERE "Premiumcode" =tempbooking_mast."Page_type_code")
                  AS "PagePremium",
                 (SELECT "Pos_Type"
                   FROM advpos_type_mast
                  WHERE "Pos_Type_Code" =
                           tempbooking_mast."Page_position_code")
                                                         AS "PositionPremium",
                (SELECT "Curr_Name"
                   FROM curr_mast
                  WHERE "Curr_Code" =
                               tempbooking_mast."Currency_code")
                                                                AS "Currency",
                "Material_status", TO_CHAR("Receipt_date",'dd/mm/yyyy') as "Receipt_date", tempbooking_mast."Region",
                "Variant", "Colortype",
                (SELECT "UOM_DESC"
                   FROM uom_mast
                  WHERE "Uom_Code" =
                                    tempbooking_mast."Uom_code")
                                                                AS "uom_desc",
                (SELECT "Logo"
                   FROM uom_mast
                  WHERE "Uom_Code" = tempbooking_mast."Uom_code") AS "logo",
                "Logo_H", "Logo_W", "Logo_color", "Logo_Uom",
                (SELECT "Logo_Uom"
                   FROM uom_mast
                  WHERE "Uom_Code" = tempbooking_mast."Uom_code")  AS "logocode",
                (select "Box_Charges_Native" from box_mast where box_mast."Box_Code"=tempbooking_mast."Box_code" and "pub_center"=(select "pub_center" from branch_mst where "Branch_Code"=tempbooking_mast."branch")) as "boxchrg",tempbooking_mast.sapid,
                retainer,(select "Retain_Name" from retainermaster where retainermaster."Retain_Code"=tempbooking_mast.retainer) as "RETAINER", (SELECT "Retain_Name"||'('||"Retain_Code"||')' FROM RETAINERMASTER WHERE RETAINERMASTER."Retain_Code"=TEMPBOOKING_MAST.RETAINER) AS "RETAINER1", (SELECT "Package_Name" FROM combin_mast WHERE "Combin_Code" = 

TEMPBOOKING_MAST."Package_code") as "Package_cod",(SELECT "Col_Name" FROM col_mast WHERE "Col_Code" = TEMPBOOKING_MAST."Color_code") as 

"Color_cod",(SELECT "Pos_Type" FROM advpos_type_mast WHERE "Pos_Type_Code" = 

TEMPBOOKING_MAST."Page_position_code") as "Page_position_cod",decode(TEMPBOOKING_MAST."Booking_type",'1','FMG','2','BARTER','3','NORMAL','4','COMPLIMEN

TRY') as "Book_type",(SELECT "catname"  FROM  AD_CAT3   WHERE 

AD_CAT3."catcode"=TEMPBOOKING_MAST."Ad_Subcat3")  as "Subcat3",(SELECT "Cat_Name"  FROM  TBL_CAT4   WHERE 

TBL_CAT4."Cat_Code"=TEMPBOOKING_MAST."Ad_Subcat4") as "Subcat4",(SELECT "Cat_Name"  FROM  TBL_CAT5   WHERE 

TBL_CAT5."Cat_Code"=TEMPBOOKING_MAST."Ad_subcat5") as "subcat5",(SELECT "Comm_Rate" FROM ret_comm_details WHERE 

ret_comm_details."Retain_Code"=TEMPBOOKING_MAST.RETAINER and rowid=(select max(rowid) from ret_comm_details where ret_comm_details."Retain_Code"=TEMPBOOKING_MAST.RETAINER)) AS "RETAINER_COMM","ADD_AGENCY_COMM",
tempbooking_mast."Scheme_type_code",MOBILENO,
CASHDISCOUNT, CASHDISCTYPE, ATTACHMENT1, ATTACHMENT2, DISC_PREMIUM,CHKTRADE,CHK_DATE, CHK_AMT, CHK_BANK_NAME, OUR_BANK, CHK_NO, agency_mast.BOOKING_TYPE,
DEALERPANEL, DEALER_H, DEALER_W, DEALERTYPE,MOBILENO,
                     (select "Comm_Rate" from comm_details where "Agency_code" || "Agency_sub_code"=TEMPBOOKING_MAST."Agency_sub_code"
 and "Comp_Code"=upper(compcode) and SYSDATE between "Eff_from_Date" and "Eff_Till_Date" AND ROWNUM<=1 ) as COMM_RATE,ACTIVE_AGREEDRATE,ACTIVE_AGREEDAMT, NVL(LOCALGROSSAMT,"Gross_amount") AS LOCALGROSSAMT, NVL(LOCALBILLAMT,"Bill_amount") as LOCALBILLAMT 
/*for Display and classified*/
           FROM tempbooking_mast, agency_mast
          WHERE agency_mast."code_subcode" =
                                            tempbooking_mast."Agency_sub_code"
            AND agency_mast."Comp_Code" = compcode order by "Creation_datetime";


      Dbms_output.put_line('rinki--');
----------------------------------------------------Lata------------------------------------------------------

      OPEN p_accounts1 FOR
      SELECT 'A' AS A FROM DUAL;
      /*   SELECT NVL(COUNT (*),'0') AS "count"
                     FROM tbl_booking_mast_LOG
          WHERE "Receipt_no" = ciobookid AND "audit" IS NOT NULL;


      BEGIN

         SELECT MAX (VSEQNO)
           INTO VERSION1
           FROM tbl_booking_mast_LOG
          WHERE "Receipt_no" = ciobookid
            AND VSEQNO < (SELECT MAX (VSEQNO)
                               FROM tbl_booking_mast_LOG
                              WHERE "Receipt_no" = ciobookid);
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            NULL;
      END;
*/
      OPEN p_accounts2 FOR
      SELECT 'A' AS A FROM DUAL;
        /* SELECT TO_CHAR ("date_time", 'dd/mm/yyyy') AS "date_time", "branch",
                "booked_by", "cio_booking_id", "prev_booking", "applied_by",
                "audit", "RO_No",
                TO_CHAR ("RO_Date", 'dd/mm/yyyy') AS "RO_Date", "Caption",
                "bill_status", "ro_status",
                tbl_booking_mast_log."Agency_code", "Agency_address",
                "Client_code", "Client_address", "Agency_sub_code",
                "Dockit_no", "Executive_code", "Executive_zone",
                "Product_code", "Brand_code", "Key_no", "Bill_remarks",
                "Print_remark", "Package_code", "No_of_insertion",
                TO_CHAR ("Insertion_date", 'dd/mm/yyyy') AS "Insertion_date",
                "Repeating_day", "Ad_type_code", "Ad_cat_code",
                "Ad_sub_cat_code", "Color_code", "Uom_code",
                "Page_position_code", "Page_type_code", "Page_no",
                "Ad_size_type_code", "Ad_size_height", "Ad_size_width",
                "Rate_code", "Scheme_type_code", "Currency_code",
                "Agrred_rate", "Agreed_amount", "Special_discount",
                "Space_discount", "Special_charges",
                tbl_booking_mast_log."Comp_code",
                tbl_booking_mast_log."Userid",
                tbl_booking_mast_log."Agency_status", "Agency_type",
                "Agency_pay", "Agency_credit", "Total_area", "Card_rate",
                "Card_amount", "Discount", "Discount_per", "Bill_cycle",
                "Revenue_center", "Bill_pay", "Bill_height", "Bill_width",
                tbl_booking_mast_log."Bill_to", "Invoices", "Vts",
                "Bill_add", "Trade_disc", "Agency_out", "Booking_type",
                "Campaign", "Page_prem", "Page_amount", "Prem_per",
                "Gross_amount", "Bill_amount", "Box_code", "Box_no",
                "Box_agency", "Box_client", "Box_address", "Tfn" "Coupan_ad",
                "Ad_size_column", "Bill_column", "Bill_area",
                "Special_disc_per", "Space_disc_per",
                  agency_mast."Agency_Name"|| '('|| agency_mast."code_subcode"|| ')' AS "AgencyName",
                   (SELECT    exec_mast."Exec_name" || '('|| TO_CHAR (exec_mast."Exe_no") || ')'
                   FROM exec_mast  WHERE tbl_booking_mast_log."Executive_code" =exec_mast."Exe_no"
                    AND tbl_booking_mast_log."Comp_code" =exec_mast."comp_code")AS "execname",
               (SELECT    product_cat_mast."prod_desc"|| '('|| product_cat_mast."prod_cat_code" || ')'
                   FROM product_cat_mast WHERE tbl_booking_mast_log."Product_code" =product_cat_mast."prod_cat_code"
                    AND tbl_booking_mast_log."Comp_code" =product_cat_mast."comp_code")                                                                 AS "product",
                "Paid_ins", "Contract_rate", "Deviation", "Variant_code",
                "Contract_name", "Contract_type", "Card_name", "Card_type",
                "Card_month", "Card_year", "Card_number", "Receipt_no",
                "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color",
                (SELECT "Agency_Name" FROM agency_mast WHERE "code_subcode" = tbl_booking_mast_log."Agency_sub_code")AS "AgencySubCode",
               NVL ((SELECT "Cust_Name"  FROM cust_mast WHERE "Cust_Code" = "Client_code"),'' ) AS "Client",
              (SELECT "Payment_Mode_Name"  FROM payment_mode_mast WHERE "Pay_Mode_Code" = "Agency_pay") AS "PayMode",
               (SELECT "Adv_Cat_Name" FROM adv_cat_mast WHERE adv_cat_mast."Adv_Cat_Code" =tbl_booking_mast_log."Ad_cat_code")AS "categoryname",
               (SELECT "Adv_Subcat_Name"  FROM adv_subcat_mast WHERE adv_subcat_mast."Adv_Subcat_Code" =tbl_booking_mast_log."Ad_sub_cat_code")
                 AS "subcategoryname",
               (SELECT "brand_name"  FROM brand_mst   WHERE "brand_code" = tbl_booking_mast_log."Brand_code")AS "Brand",
               (SELECT "Uom_Name" FROM uom_mast WHERE "Uom_Code" =tbl_booking_mast_log."Uom_code")AS "UOM",
               (SELECT "premiumname" FROM advpos_prem_mast WHERE "Premiumcode" =tbl_booking_mast_log."Page_type_code")AS "PagePremium",
                (SELECT "Pos_Type" FROM advpos_type_mast WHERE "Pos_Type_Code" =tbl_booking_mast_log."Page_position_code")AS "PositionPremium",
               (SELECT "Curr_Name"  FROM curr_mast WHERE "Curr_Code" =tbl_booking_mast_log."Currency_code") AS "Currency"
           FROM tbl_booking_mast_log, agency_mast
             WHERE tbl_booking_mast_log."Receipt_no" = ciobookid
            AND VSEQNO = VERSION1
            AND agency_mast."code_subcode" =
                                    tbl_booking_mast_log."Agency_sub_code"
            AND agency_mast."Comp_Code" = compcode;
*/
      OPEN p_accounts3 FOR
      SELECT 'A' AS A FROM DUAL;
--select * from tbl_booking_mast_log where cio_booking_id=@ciobookid and version=@version
       /*   SELECT TO_CHAR ("date_time", 'dd/mm/yyyy') AS "date_time", "branch",
                "booked_by", "cio_booking_id", "prev_booking", "applied_by",
                "audit", "RO_No",
                TO_CHAR ("RO_Date", 'dd/mm/yyyy') AS "RO_Date", "Caption",
                "bill_status", "ro_status",
                tbl_booking_mast_log."Agency_code", "Agency_address",
                "Client_code", "Client_address", "Agency_sub_code",
                "Dockit_no", "Executive_code", "Executive_zone",
                "Product_code", "Brand_code", "Key_no", "Bill_remarks",
                "Print_remark", "Package_code", "No_of_insertion",
                TO_CHAR ("Insertion_date", 'dd/mm/yyyy') AS "Insertion_date",
                "Repeating_day", "Ad_type_code", "Ad_cat_code",
                "Ad_sub_cat_code", "Color_code", "Uom_code",
                "Page_position_code", "Page_type_code", "Page_no",
                "Ad_size_type_code", "Ad_size_height", "Ad_size_width",
                "Rate_code", "Scheme_type_code", "Currency_code",
                "Agrred_rate", "Agreed_amount", "Special_discount",
                "Space_discount", "Special_charges",
                tbl_booking_mast_log."Comp_code",
                tbl_booking_mast_log."Userid",
                tbl_booking_mast_log."Agency_status", "Agency_type",
                "Agency_pay", "Agency_credit", "Total_area", "Card_rate",
                "Card_amount", "Discount", "Discount_per", "Bill_cycle",
                "Revenue_center", "Bill_pay", "Bill_height", "Bill_width",
                tbl_booking_mast_log."Bill_to", "Invoices", "Vts",
                "Bill_add", "Trade_disc", "Agency_out", "Booking_type",
                "Campaign", "Page_prem", "Page_amount", "Prem_per",
                "Gross_amount", "Bill_amount", "Box_code", "Box_no",
                "Box_agency", "Box_client", "Box_address", "Tfn", "Coupan_ad",
                "Ad_size_column", "Bill_column", "Bill_area",
                "Special_disc_per", "Space_disc_per",
                 agency_mast."Agency_Name" || '('|| agency_mast."code_subcode"|| ')' AS "AgencyName",
                (SELECT    exec_mast."Exec_name" || '('|| TO_CHAR (exec_mast."Exe_no")|| ')'
                   FROM exec_mast  WHERE tbl_booking_mast_log."Executive_code" = exec_mast."Exe_no"
                    AND tbl_booking_mast_log."Comp_code" = exec_mast."comp_code")AS "execname",
                (SELECT    product_cat_mast."prod_desc" || '(' || product_cat_mast."prod_cat_code" || ')'
                   FROM product_cat_mast WHERE tbl_booking_mast_log."Product_code" =product_cat_mast."prod_cat_code"
                    AND tbl_booking_mast_log."Comp_code" =product_cat_mast."comp_code")AS "product",
                "Paid_ins", "Contract_rate", "Deviation", "Variant_code",
                "Contract_name", "Contract_type", "Card_name", "Card_type",
                "Card_month", "Card_year", "Card_number", "Receipt_no",
                "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color",
                "Bullet_code", "Bullet_premium",
                (SELECT "Agency_Name" FROM agency_mast WHERE "code_subcode" =tbl_booking_mast_log."Agency_sub_code")AS "AgencySubCode",
                NVL ((SELECT "Cust_Name" FROM cust_mast WHERE "Cust_Code" = "Client_code"),'' ) AS "Client",
                (SELECT "Payment_Mode_Name" FROM payment_mode_mast WHERE "Pay_Mode_Code" = "Agency_pay") AS "PayMode",
                (SELECT "Adv_Cat_Name" FROM adv_cat_mast WHERE adv_cat_mast."Adv_Cat_Code" =tbl_booking_mast_log."Ad_cat_code")AS "categoryname",
                (SELECT "Adv_Subcat_Name" FROM adv_subcat_mast WHERE adv_subcat_mast."Adv_Subcat_Code" =tbl_booking_mast_log."Ad_sub_cat_code")AS "subcategoryname",
                (SELECT "brand_name" FROM brand_mst WHERE "brand_code" =tbl_booking_mast_log."Brand_code")AS "Brand",
                (SELECT "Uom_Name" FROM uom_mast WHERE "Uom_Code" =tbl_booking_mast_log."Uom_code")AS "UOM",
                (SELECT "premiumname" FROM advpos_prem_mast  WHERE "Premiumcode" =tbl_booking_mast_log."Page_type_code")AS "PagePremium",
                (SELECT "Pos_Type" FROM advpos_type_mast WHERE "Pos_Type_Code" = tbl_booking_mast_log."Page_position_code")AS "PositionPremium",
                (SELECT "Curr_Name" FROM curr_mast WHERE "Curr_Code" =tbl_booking_mast_log."Currency_code")AS "Currency"
           FROM tbl_booking_mast_log, agency_mast
          WHERE tbl_booking_mast_log."Receipt_no" = ciobookid
            AND VSEQNO =(SELECT MAX (VSEQNO) FROM tbl_booking_mast_log WHERE "Receipt_no" = ciobookid AND VSEQNO <
            (SELECT MAX(VSEQNO) FROM tbl_booking_mast_log WHERE "Receipt_no" = ciobookid) AND "audit" IS NOT NULL)
                        AND agency_mast."code_subcode" =
             tbl_booking_mast_log."Agency_sub_code" AND agency_mast."Comp_Code" = compcode;
*/
   END executebooking_p;
END executebooking;
/



@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@6421@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@


@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@kuldeep 21/01/12@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//==============*********************Start Scripting****************==================//
CREATE OR REPLACE PACKAGE rate_bindgrid is
Type T_Accounts_Cursor is ref Cursor;
procedure rate_bindgrid_p
(
compcode in varchar2,
packagecode in  varchar2,
dateformat in  varchar2,
p_Accounts out T_Accounts_Cursor
);
end rate_bindgrid;
/
CREATE OR REPLACE PACKAGE BODY rate_bindgrid is
procedure rate_bindgrid_p
(
compcode in varchar2,
packagecode in  varchar2,
dateformat in  varchar2,
p_Accounts out T_Accounts_Cursor
)
as
 begin

if(dateformat='mm/dd/yyyy') then

open p_Accounts for

select "combin_desc","Week_Day_Rate","Focus_Day_Rate","weekend_rate","Week_Extra_Rate",

(select "Adv_Cat_Name" from adv_cat_mast where  adv_cat_mast."Adv_Cat_Code"=rate_mast."Adv_Cat_Code") as Catname,

(select "Adv_Type_Name" from Adv_type_mast where Adv_type_mast."Adv_Type_Code"=rate_mast."Adv_Type_Code") as type,

(select "Uom_Name" from uom_mast where "Uom_Code"=rate_mast."Uom") as uom,

(select "Curr_Name" from curr_mast where "Curr_Code"=rate_mast."Currency") as currency,

(select "Adv_Subcat_Name" from adv_subcat_mast where adv_subcat_mast."Adv_Subcat_Code"=rate_mast."Adv_subcat_code") as subcat,

To_Char("Valid_From",'mm/dd/yyyy') as Valid_From ,

To_Char("Valid_To",'mm/dd/yyyy') as Valid_To,

(select "Col_Name" from col_mast where rate_mast."Color"="Col_Code") as color,

(select "premiumname" from ADVPOS_PREM_MAST where "Premiumcode"="Premium" and "comp_code"=compcode) as premium

from rate_mast where "Combin_Code"=packagecode and "Comp_code"=compcode order by Valid_From,color,Catname;

end if;

if(dateformat='dd/mm/yyyy')
then

open p_Accounts for
select "combin_desc","Week_Day_Rate","Focus_Day_Rate","weekend_rate","Week_Extra_Rate",

(select "Adv_Cat_Name" from adv_cat_mast where  adv_cat_mast."Adv_Cat_Code"=rate_mast."Adv_Cat_Code") as Catname,

(select "Adv_Type_Name" from Adv_type_mast where Adv_type_mast."Adv_Type_Code"=rate_mast."Adv_Type_Code") as type,

(select "Uom_Name" from uom_mast where "Uom_Code"=rate_mast."Uom") as uom,

(select "Curr_Name" from curr_mast where "Curr_Code"=rate_mast."Currency") as currency,

(select "Adv_Subcat_Name" from adv_subcat_mast where adv_subcat_mast."Adv_Subcat_Code"=rate_mast."Adv_subcat_code") as subcat,

To_Char("Valid_From",'dd/mm/yyyy') as Valid_From ,

To_Char("Valid_To",'dd/mm/yyyy') as Valid_To,

(select "Col_Name" from col_mast where rate_mast."Color"="Col_Code") as color,

(select "premiumname" from ADVPOS_PREM_MAST where "Premiumcode"="Premium" and "comp_code"=compcode) as premium

from rate_mast where "Combin_Code"=packagecode and "Comp_code"=compcode order by Valid_From,color,Catname;


end if;

if(dateformat='yyyy/mm/dd')
then
open p_Accounts for

select "combin_desc","Week_Day_Rate","Focus_Day_Rate","weekend_rate","Week_Extra_Rate",

(select "Adv_Cat_Name" from adv_cat_mast where  adv_cat_mast."Adv_Cat_Code"=rate_mast."Adv_Cat_Code") as Catname,

(select "Adv_Type_Name" from Adv_type_mast where Adv_type_mast."Adv_Type_Code"=rate_mast."Adv_Type_Code") as type,

(select "Uom_Name" from uom_mast where "Uom_Code"=rate_mast."Uom") as uom,

(select "Curr_Name" from curr_mast where "Curr_Code"=rate_mast."Currency") as currency,

(select "Adv_Subcat_Name" from adv_subcat_mast where adv_subcat_mast."Adv_Subcat_Code"=rate_mast."Adv_subcat_code") as subcat,

To_Char("Valid_From",'yyyy/mm/dd') as Valid_From ,

To_Char("Valid_To",'yyyy/mm/dd') as Valid_To,

(select "Col_Name" from col_mast where rate_mast."Color"="Col_Code") as color,

(select "premiumname" from ADVPOS_PREM_MAST where "Premiumcode"="Premium" and "comp_code"=compcode) as premium

from rate_mast where "Combin_Code"=packagecode and "Comp_code"=compcode order by Valid_From,color,Catname;

end if;

end  rate_bindgrid_p;

end  rate_bindgrid;
/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PACKAGE getpageamount
IS
   TYPE t_accounts_cursor IS REF CURSOR;

   PROCEDURE  getpageamount_p (
    compcode     IN       VARCHAR2,
	pagecode     in VARCHAR2,
	bookingdate     in date,
      p_accounts   OUT      t_accounts_cursor
   );
END getpageamount;
/

CREATE OR REPLACE PACKAGE BODY getpageamount
IS
   PROCEDURE  getpageamount_p (

     compcode     IN       VARCHAR2,
	  pagecode in VARCHAR2,
      bookingdate     in date,
      p_accounts   OUT      t_accounts_cursor
   )
   AS
   BEGIN
      OPEN p_accounts FOR
         select "Amount","Premium" from advpos_type_mast where ("Pos_Type_Code"=pagecode) and ("Comp_Code"=compcode)
         and bookingdate between FROM_DATE and "TO_DATE";
   END  getpageamount_p;
END getpageamount;
/


//==============*********************Start Scripting****************==================//

CREATE OR REPLACE PROCEDURE committransaction(
    pcioid          in  varchar2,
    totalcount      in  int,
    pcompcode       in  varchar2,
    pcentname       in  varchar2,
    puserid         in  varchar2,
    pbkid_gentype   in  varchar2,
    pbk_type        in  varchar2,
    p_error         OUT VARCHAR2,
    p_new_cioid     OUT VARCHAR2) is
    
countnum        int;
newid           varchar2(100);
billpay         varchar2(20);
rostatus        varchar2(20);
remarks         varchar2(500);
clientname      varchar2(200);
v_cursor1       TYPES.cursor_type;
v_cursor2       TYPES.cursor_type;

v_cursor1_var1  varchar2(50);
v_cursor1_var2  varchar2(50);
v_cursor2_var1  varchar2(50);

begin
newid:=pcioid;

select count(*) into countnum from tbl_booking_insert_g where Cio_Booking_Id=pcioid;
if(countnum=totalcount) then 
     
    
   getautocodebooking.getautocodebooking_p (compcode        =>  pcompcode,
                                            auto1           =>  '0',
                                            no1             =>  '0',
                                            p_accounts      =>  v_cursor1,
                                            p_accounts1     =>  v_cursor2);
                                            
    FETCH v_cursor1 INTO v_cursor1_var1, v_cursor1_var2;
    
    FETCH v_cursor2 INTO v_cursor2_var1;
    
    if  pbkid_gentype='1' then--1 for First 3 character of Centre Name+Year + Slno  
        
        newid:=substr(pcentname,1,3)||v_cursor1_var2||LPAD(v_cursor1_var1,8,'0');
    
    elsif  pbkid_gentype='2' then--2 for First 3 character of Centre Name+Year + Userid + Slno
    
        newid:=substr(pcentname,1,3)||v_cursor1_var2||LPAD(v_cursor1_var1,8,'0')||puserid;

    elsif  pbkid_gentype='4' then--BK Type + Slno

        newid:=pbk_type||LPAD(v_cursor1_var1,8,'0');

    else

        newid:=LPAD(v_cursor1_var1,8,'0');

    end if; 
    
    p_error     :='Y';
    p_new_cioid := newid;

    INSERT INTO tbladid_ins(CIOID,COUNTNUM,FLAG) VALUES(newid,countnum,p_error);
    INSERT INTO TBL_BOOKING_MAST("date_time", "branch", "booked_by", "cio_booking_id", "prev_booking", "applied_by", "audit", "RO_No", "RO_Date", "Caption", "bill_status", "ro_status", "Agency_code", "Agency_address", "Client_code", "Client_address", "Agency_sub_code", "Dockit_no", "Executive_code", "Executive_zone", "Product_code", "Brand_code", "Key_no", "Bill_remarks", "Print_remark", "Package_code", "No_of_insertion", "Insertion_date", "Repeating_day", "Ad_type_code", "Ad_cat_code", "Ad_sub_cat_code", "Color_code", "Uom_code", "Page_position_code", "Page_type_code", "Page_no", "Ad_size_type_code", "Ad_size_height", "Ad_size_width", "Rate_code", "Scheme_type_code", "Currency_code", "Agrred_rate", "Agreed_amount", "Special_discount", "Space_discount", "Special_charges", "Agency_status", "Agency_type", "Agency_pay", "Agency_credit", "Total_area", "Card_rate", "Card_amount", "Discount", "Discount_per", "Bill_cycle", "Revenue_center", "Bill_pay", "Bill_height", "Bill_width", "Bill_to", "Invoices", "Vts", "Bill_add", "Trade_disc", "Agency_out", "Box_code", "Box_no", "Box_agency", "Box_client", "Box_address", "Comp_code", "Userid", "Creation_datetime", "Booking_type", "Tfn", "Coupan_ad", "Campaign", "Bill_amount", "Page_prem", "Page_amount", "Prem_per", "Gross_amount", "Ad_size_column", "Bill_column", "Bill_area", "Special_disc_per", "Space_disc_per", "Paid_ins", "Contract_rate", "Deviation", "Variant_code", "Contract_name", "Contract_type", "Card_name", "Card_type", "Card_month", "Card_year", "Card_number", "Receipt_no", "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color", "Bullet_code", "Bullet_premium", "Material_status", "Receipt_date", "prev_cioid", "prev_receipt", "prev_grossamt", "Region", "Variant", "Colortype", "Logo_H", "Logo_W", "Logo_color", "Logo_Uom", "SAPID", "RETAINER", "ADD_AGENCY_COMM", "AUDIT_COMMENT", "MOBILENO", "ADD_AGENCY_COMM_AMT", "RETAINER_COMM", "RETAINER_COMM_AMT", "CASH_RECIEVED", "CONT_GROSS", "CIRAGENCY", "CIRRATE", "CIREDITION", "CIRPUBLICATION", "CIRAGENCY_SUBCODE", "BARTER_TYPE", "APP_STATUS", "APP_REMARKS", "APP_DATE", "APP_USER", "RODOCSTATUS",CASHDISCOUNT, CASHDISCTYPE, ATTACHMENT1, ATTACHMENT2,DISC_PREMIUM,DOCTYPE,CHKTRADEDISC,CHK_NO,CHK_DATE,CHK_AMT,CHK_BANK_NAME,OUR_BANK,DEALERPANEL, DEALER_H, DEALER_W, DEALERTYPE,ACTIVE_AGREEDRATE, ACTIVE_AGREEDAMT,LOCALGROSSAMT, LOCALBILLAMT, PACKAGE_TYPE, AD_REFID,RECEIPT_CURRENCY, CONV_CURR_RATE,REVISE_DATE,CLIENT_TYPE) 
    SELECT DATE_TIME, BRANCH, BOOKED_BY, newid CIO_BOOKING_ID, PREV_BOOKING, APPLIED_BY, AUDIT_G, RO_NO, RO_DATE, CAPTION, BILL_STATUS, RO_STATUS, AGENCY_CODE, AGENCY_ADDRESS, CLIENT_CODE, CLIENT_ADDRESS, AGENCY_SUB_CODE, DOCKIT_NO, EXECUTIVE_CODE, EXECUTIVE_ZONE, PRODUCT_CODE, BRAND_CODE, KEY_NO, BILL_REMARKS, PRINT_REMARK, PACKAGE_CODE, NO_OF_INSERTION, INSERTION_DATE, REPEATING_DAY, AD_TYPE_CODE, AD_CAT_CODE, AD_SUB_CAT_CODE, COLOR_CODE, UOM_CODE, PAGE_POSITION_CODE, PAGE_TYPE_CODE, PAGE_NO, AD_SIZE_TYPE_CODE, AD_SIZE_HEIGHT, AD_SIZE_WIDTH, RATE_CODE, SCHEME_TYPE_CODE, CURRENCY_CODE, AGRRED_RATE, AGREED_AMOUNT, SPECIAL_DISCOUNT, SPACE_DISCOUNT, SPECIAL_CHARGES, AGENCY_STATUS, AGENCY_TYPE, AGENCY_PAY, AGENCY_CREDIT, TOTAL_AREA, CARD_RATE, CARD_AMOUNT, DISCOUNT, DISCOUNT_PER, BILL_CYCLE, REVENUE_CENTER, BILL_PAY, BILL_HEIGHT, BILL_WIDTH, BILL_TO, INVOICES, VTS, BILL_ADD, TRADE_DISC, AGENCY_OUT, BOX_CODE, BOX_NO, BOX_AGENCY, BOX_CLIENT, BOX_ADDRESS, COMP_CODE, USERID, CREATION_DATETIME, BOOKING_TYPE, TFN, COUPAN_AD, CAMPAIGN, BILL_AMOUNT, PAGE_PREM, PAGE_AMOUNT, PREM_PER, GROSS_AMOUNT, AD_SIZE_COLUMN, BILL_COLUMN, BILL_AREA, SPECIAL_DISC_PER, SPACE_DISC_PER, PAID_INS, CONTRACT_RATE, DEVIATION, VARIANT_CODE, CONTRACT_NAME, CONTRACT_TYPE, CARD_NAME, CARD_TYPE, CARD_MONTH, CARD_YEAR, CARD_NUMBER, RECEIPT_NO, AD_SUBCAT3, AD_SUBCAT4, AD_SUBCAT5, BG_COLOR, BULLET_CODE, BULLET_PREMIUM, MATERIAL_STATUS, RECEIPT_DATE, PREV_CIOID, PREV_RECEIPT, PREV_GROSSAMT, REGION, VARIANT, COLORTYPE, LOGO_H, LOGO_W, LOGO_COLOR, LOGO_UOM, SAPID, RETAINER, ADD_AGENCY_COMM, AUDIT_COMMENT, MOBILENO, ADD_AGENCY_COMM_AMT, RETAINER_COMM, RETAINER_COMM_AMT, CASH_RECIEVED, CONT_GROSS, CIRAGENCY, CIRRATE, CIREDITION, CIRPUBLICATION, CIRAGENCY_SUBCODE, BARTER_TYPE, APP_STATUS, APP_REMARKS, APP_DATE, APP_USER, RODOCSTATUS,CASHDISCOUNT, CASHDISCTYPE, ATTACHMENT1, ATTACHMENT2, DISC_PREMIUM, DOCTYPE,CHKTRADEDISC,CHK_NO,CHK_DATE,CHK_AMT,CHK_BANK_NAME,OUR_BANK, DEALERPANEL, DEALER_H, DEALER_W, DEALERTYPE,ACTIVE_AGREEDRATE, ACTIVE_AGREEDAMT,LOCALGROSSAMT, LOCALBILLAMT, PACKAGE_TYPE, AD_REFID, RECEIPT_CURRENCY, CONV_CURR_RATE,REVISE_DATE,CLIENT_TYPE FROM TBL_BOOKING_MAST_G WHERE  CIO_BOOKING_ID=pcioid;

    INSERT INTO TBL_BOOKING_insert("Insert_Id", "Cio_Booking_Id", "No_Insert", "Edition_Code", "Publication_Code", "Pub_Cent_Code", "Supp_Code", "Edition", "Insert_Date", "Col_Code", "Height", "Width", "Size_Book", "Page_Post", "Premium1", "Prem_Per1", "Premium2", "Prem_Per2", "Premium_Allow", "Ad_Cat", "Ad_Sub_Cat", "Latest_By", "Repeating_Date", "Status_Material", "File_Name", "Card_Rate", "Disc_Rate", "Insert_Status", "Bill_Status", "Agreed_Rate", "Pai_Free_Ins", "Solo_Rate", "Gross_Rate", "Comp_Code", "Userid", "Page_No", "Remarks", "Pub_Height", "Pub_Width", "Page_Prem", "Page_Per", "No_Ofcolumn", "Bill_Amt", "Bill_Rate", "Logo_H", "Logo_W", "Logo_name", "AD_SUBCAT3", "AD_SUBCAT4", "AD_SUBCAT5", "PACKAGE_CODE", "BILL_NO", "BILL_DATE", "INSERTS", "PKG_ALIAS", "CONT_GROSS_AMT", "APP_STATUS", "APP_REMARKS", "APP_DATE", "APP_USER",SPECIAL_SIZE1,VATAMT,BOXCHARGE,VAT_INC,LOCALGROSSAMT, LOCALBILLAMT,SECTIONCODE,RESOURCE_NO,CAPTION) 
    SELECT INSERT_ID, newid CIO_BOOKING_ID, NO_INSERT, EDITION_CODE, PUBLICATION_CODE, PUB_CENT_CODE, SUPP_CODE, EDITION, INSERT_DATE, COL_CODE, HEIGHT, WIDTH, SIZE_BOOK, PAGE_POST, PREMIUM1, PREM_PER1, PREMIUM2, PREM_PER2, PREMIUM_ALLOW, AD_CAT, AD_SUB_CAT, LATEST_BY, REPEATING_DATE, STATUS_MATERIAL, FILE_NAME, CARD_RATE, DISC_RATE, INSERT_STATUS, BILL_STATUS, AGREED_RATE, PAI_FREE_INS, SOLO_RATE, GROSS_RATE, COMP_CODE, USERID, PAGE_NO, REMARKS, PUB_HEIGHT, PUB_WIDTH, PAGE_PREM, PAGE_PER, NO_OFCOLUMN, BILL_AMT, BILL_RATE, LOGO_H, LOGO_W, LOGO_NAME, AD_SUBCAT3, AD_SUBCAT4, AD_SUBCAT5, PACKAGE_CODE, BILL_NO, BILL_DATE, INSERTS, PKG_ALIAS, CONT_GROSS_AMT, APP_STATUS, APP_REMARKS, APP_DATE, APP_USER, SPECIAL_SIZE1,VATAMT, BOXCHARGE, VAT_INC,LOCALGROSSAMT, LOCALBILLAMT, SECTIONCODE, RESOURCE_NO,CAPTION FROM TBL_BOOKING_INSERT_G WHERE  CIO_BOOKING_ID=pcioid;

    INSERT INTO TBL_BOOKING_VTS(COMPCODE, CIOID, INSERTID, VTS, PUBLICATION, EDITION, RATE, CREATIONDATETIME, CIRAGCODE, CIRAGSUBCODE, CENTER, BRANCH, PUBLISHDATE) 
    SELECT COMPCODE, newid CIOID, INSERTID, VTS, PUBLICATION, EDITION, RATE, CREATIONDATETIME, CIRAGCODE, CIRAGSUBCODE, CENTER, BRANCH, PUBLISHDATE FROM TBL_BOOKING_VTS_G WHERE  cioid=pcioid;

    insert into tbl_booking_insert_sizesplit(CIOID, RECEIPTNO, INSERTID, INSERTDATE, HEIGHT, WIDTH, AREA, SRNO, CREATIONDATETIME)
    select newid CIOID, RECEIPTNO, INSERTID, INSERTDATE, HEIGHT, WIDTH, AREA, SRNO, CREATIONDATETIME from tbl_booking_insert_sizesplit_g where cioid=pcioid;

    --INSERT INTO ABCTEST VALUES(newid,counttest);
    insert into tbl_booking_subedition(COMP_CODE, CIOID, INSERTID, PUBLICATION, EDITION, INSERTDATE, HEIGHT, WIDTH, TOTALAREA, INSERTSTATUS, RECEIPTNO,SRNO, NO_INSERT)
    select COMP_CODE, newid CIOID, INSERTID, PUBLICATION, EDITION, INSERTDATE, HEIGHT, WIDTH, TOTALAREA, INSERTSTATUS, RECEIPTNO, SRNO, NO_INSERT from tbl_booking_subedition_g
    where tbl_booking_subedition_g.CIOID=pcioid;

    insert into TBL_BOOKING_SHARING_TRANS(PUBLICATION, TYPE, SHARING, CIOID, SRNO)
    select PUBLICATION, TYPE, SHARING, newid CIOID, SRNO from TBL_BOOKING_SHARING_TRANS_g where CIOID=pcioid ;

    insert into TBL_BOOKING_FMG_TRANS(CIOID, INSERTID, CREATIONDATETIME)
    select newid CIOID, INSERTID, CREATIONDATETIME from TBL_BOOKING_FMG_TRANS_G where CIOID=pcioid;
    
    update tbl_matter set "cioid"=newid where "cioid"=pcioid; 

    select "Bill_pay","ro_status" into billpay,rostatus from tbl_booking_mast where "cio_booking_id"=newid;

    if billpay = 'CA0' and rostatus='1' then
        declare
            cursor c1 is
            select * from tbl_booking_mast where "cio_booking_id"=newid;
        v1 c1%rowtype;

        v_error      varchar2(2000);
        v_rcptno_r   varchar2(50);
        vrecpt       varchar2(20);
        branchcode   varchar2(20);
        vrepcode     varchar2(20);
        subagencyreg varchar2(20);
        prevcioid_v  varchar2(50);
        billamt_v    float;
        grossamt_v   float;
        v_curdate     date;
    begin
        open c1;
            fetch c1 into v1;
        Begin
            select "Branch_Code" into branchcode from branch_mst where "Comp_Code"=v1."Comp_code" and "Branch_Name"=v1."branch";
        Exception When no_data_found then
            branchcode:=v1."branch";
        End;
   
        Begin
            select "SUB_Agency_Code" into subagencyreg from agency_mast where "Comp_Code"=v1."Comp_code" and "code_subcode"=v1."Agency_sub_code";
        Exception When no_data_found then
            subagencyreg:='';
        End;
        vrecpt       :=v1."Receipt_no";
        prevcioid_v  :=v1."prev_cioid";
        if prevcioid_v is null or v1."prev_receipt" is null then
            billamt_v   :=v1."Bill_amount";
            grossamt_v  :=v1."Gross_amount";
            v_curdate   :=to_date(sysdate);
        else
            select "Bill_amount","Gross_amount" into  billamt_v,grossamt_v from tbl_booking_mast where "cio_booking_id"=prevcioid_v;
            billamt_v   :=v1."Bill_amount" - billamt_v;
            grossamt_v :=v1."Gross_amount" - grossamt_v;
            IF grossamt_v=0 OR grossamt_v IS NULL THEN
                grossamt_v:=v1."Gross_amount";
            END IF;
            v_curdate  :=to_date(sysdate);
        end if;

        -- select substr(max("recptno"),1,12)||lpad(substr(max("recptno"),-6)+1,6,'0') into vrecpt from ad_rcpthdr where "unit"=branchcode and "doctype"='RCP' and
        -- "recptdt" between '1-mar-2011' and '31-mar-2011';
         
        --receiptsave_booking.receiptsave_booking_P(pcompcode,puserid , punit ,ptype , precpt , prdate , ppaymodres ,preceivedreg ,pvouno  ,pamount  ,pagency , pothercd ,
        --pchno  ,pchedate , pbank  , pnarration ,prep   , pvdate , pag_main_code ,pag_sub_code , ourbank,  cioid , execname , retainer ,
        -- prevcioid , p_error)
        begin
            SELECT "Cust_Name" into clientname FROM CUST_MAST WHERE "Cust_Code" = v1."Client_code" and "Comp_Code"=v1."Comp_code";
        exception when NO_DATA_FOUND THEN
            clientname:=v1."Client_code";
        END;

        remarks:='RONO#'||v1."RO_No" ||' RODATE# ' || to_char(v1."RO_Date",'dd-mon-yyyy') || ' BOOKINGID# ' || v1."cio_booking_id" || ' CLIENT#' || clientname;

        receiptsave_booking.receiptsave_booking_p(v1."Comp_code",v1."Userid", v1."branch",V1.DOCTYPE,vrecpt,v_curdate,v1."Bill_pay",'','',billamt_v,v1."Agency_sub_code",grossamt_v,
            '','','',remarks,vrepcode,v1."date_time",v1."Agency_code",subagencyreg,'',v1."cio_booking_id",v1."Executive_code",v1.RETAINER,v1."prev_cioid",v_rcptno_r,v_error);
   
        update tbl_booking_mast set "Receipt_no"=v_rcptno_r,"Receipt_date"= v_curdate where "cio_booking_id"=v1."cio_booking_id";
    close c1;
    commit;
 end;
 end if;
 /*
 INSERT INTO TBL_BOOKING_MAST("date_time", "branch", "booked_by", "cio_booking_id", "prev_booking", "applied_by", "audit", "RO_No", "RO_Date", "Caption", "bill_status", "ro_status", "Agency_code", "Agency_address", "Client_code", "Client_address", "Agency_sub_code", "Dockit_no", "Executive_code", "Executive_zone", "Product_code", "Brand_code", "Key_no", "Bill_remarks", "Print_remark", "Package_code", "No_of_insertion", "Insertion_date", "Repeating_day", "Ad_type_code", "Ad_cat_code", "Ad_sub_cat_code", "Color_code", "Uom_code", "Page_position_code", "Page_type_code", "Page_no", "Ad_size_type_code", "Ad_size_height", "Ad_size_width", "Rate_code", "Scheme_type_code", "Currency_code", "Agrred_rate", "Agreed_amount", "Special_discount", "Space_discount", "Special_charges", "Agency_status", "Agency_type", "Agency_pay", "Agency_credit", "Total_area", "Card_rate", "Card_amount", "Discount", "Discount_per", "Bill_cycle", "Revenue_center", "Bill_pay", "Bill_height", "Bill_width", "Bill_to", "Invoices", "Vts", "Bill_add", "Trade_disc", "Agency_out", "Box_code", "Box_no", "Box_agency", "Box_client", "Box_address", "Comp_code", "Userid", "Creation_datetime", "Booking_type", "Tfn", "Coupan_ad", "Campaign", "Bill_amount", "Page_prem", "Page_amount", "Prem_per", "Gross_amount", "Ad_size_column", "Bill_column", "Bill_area", "Special_disc_per", "Space_disc_per", "Paid_ins", "Contract_rate", "Deviation", "Variant_code", "Contract_name", "Contract_type", "Card_name", "Card_type", "Card_month", "Card_year", "Card_number", "Receipt_no", "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color", "Bullet_code", "Bullet_premium", "Material_status", "Receipt_date", "prev_cioid", "prev_receipt", "prev_grossamt", "Region", "Variant", "Colortype", "Logo_H", "Logo_W", "Logo_color", "Logo_Uom", "SAPID", "RETAINER", "ADD_AGENCY_COMM", "AUDIT_COMMENT", "MOBILENO", "ADD_AGENCY_COMM_AMT", "RETAINER_COMM", "RETAINER_COMM_AMT", "CASH_RECIEVED", "CONT_GROSS", "CIRAGENCY", "CIRRATE", "CIREDITION", "CIRPUBLICATION", "CIRAGENCY_SUBCODE", "BARTER_TYPE", "APP_STATUS", "APP_REMARKS", "APP_DATE", "APP_USER", "RODOCSTATUS") 
SELECT DATE_TIME, BRANCH, BOOKED_BY, CIO_BOOKING_ID, PREV_BOOKING, APPLIED_BY, AUDIT_G, RO_NO, RO_DATE, CAPTION, BILL_STATUS, RO_STATUS, AGENCY_CODE, AGENCY_ADDRESS, CLIENT_CODE, CLIENT_ADDRESS, AGENCY_SUB_CODE, DOCKIT_NO, EXECUTIVE_CODE, EXECUTIVE_ZONE, PRODUCT_CODE, BRAND_CODE, KEY_NO, BILL_REMARKS, PRINT_REMARK, PACKAGE_CODE, NO_OF_INSERTION, INSERTION_DATE, REPEATING_DAY, AD_TYPE_CODE, AD_CAT_CODE, AD_SUB_CAT_CODE, COLOR_CODE, UOM_CODE, PAGE_POSITION_CODE, PAGE_TYPE_CODE, PAGE_NO, AD_SIZE_TYPE_CODE, AD_SIZE_HEIGHT, AD_SIZE_WIDTH, RATE_CODE, SCHEME_TYPE_CODE, CURRENCY_CODE, AGRRED_RATE, AGREED_AMOUNT, SPECIAL_DISCOUNT, SPACE_DISCOUNT, SPECIAL_CHARGES, AGENCY_STATUS, AGENCY_TYPE, AGENCY_PAY, AGENCY_CREDIT, TOTAL_AREA, CARD_RATE, CARD_AMOUNT, DISCOUNT, DISCOUNT_PER, BILL_CYCLE, REVENUE_CENTER, BILL_PAY, BILL_HEIGHT, BILL_WIDTH, BILL_TO, INVOICES, VTS, BILL_ADD, TRADE_DISC, AGENCY_OUT, BOX_CODE, BOX_NO, BOX_AGENCY, BOX_CLIENT, BOX_ADDRESS, COMP_CODE, USERID, CREATION_DATETIME, BOOKING_TYPE, TFN, COUPAN_AD, CAMPAIGN, BILL_AMOUNT, PAGE_PREM, PAGE_AMOUNT, PREM_PER, GROSS_AMOUNT, AD_SIZE_COLUMN, BILL_COLUMN, BILL_AREA, SPECIAL_DISC_PER, SPACE_DISC_PER, PAID_INS, CONTRACT_RATE, DEVIATION, VARIANT_CODE, CONTRACT_NAME, CONTRACT_TYPE, CARD_NAME, CARD_TYPE, CARD_MONTH, CARD_YEAR, CARD_NUMBER, RECEIPT_NO, AD_SUBCAT3, AD_SUBCAT4, AD_SUBCAT5, BG_COLOR, BULLET_CODE, BULLET_PREMIUM, MATERIAL_STATUS, RECEIPT_DATE, PREV_CIOID, PREV_RECEIPT, PREV_GROSSAMT, REGION, VARIANT, COLORTYPE, LOGO_H, LOGO_W, LOGO_COLOR, LOGO_UOM, SAPID, RETAINER, ADD_AGENCY_COMM, AUDIT_COMMENT, MOBILENO, ADD_AGENCY_COMM_AMT, RETAINER_COMM, RETAINER_COMM_AMT, CASH_RECIEVED, CONT_GROSS, CIRAGENCY, CIRRATE, CIREDITION, CIRPUBLICATION, CIRAGENCY_SUBCODE, BARTER_TYPE, APP_STATUS, APP_REMARKS, APP_DATE, APP_USER, RODOCSTATUS FROM TBL_BOOKING_MAST_G WHERE SESID=USERENV ('sessionid') and CIO_BOOKING_ID=cioid;

INSERT INTO TBL_BOOKING_insert("Insert_Id", "Cio_Booking_Id", "No_Insert", "Edition_Code", "Publication_Code", "Pub_Cent_Code", "Supp_Code", "Edition", "Insert_Date", "Col_Code", "Height", "Width", "Size_Book", "Page_Post", "Premium1", "Prem_Per1", "Premium2", "Prem_Per2", "Premium_Allow", "Ad_Cat", "Ad_Sub_Cat", "Latest_By", "Repeating_Date", "Status_Material", "File_Name", "Card_Rate", "Disc_Rate", "Insert_Status", "Bill_Status", "Agreed_Rate", "Pai_Free_Ins", "Solo_Rate", "Gross_Rate", "Comp_Code", "Userid", "Page_No", "Remarks", "Pub_Height", "Pub_Width", "Page_Prem", "Page_Per", "No_Ofcolumn", "Bill_Amt", "Bill_Rate", "Logo_H", "Logo_W", "Logo_name", "AD_SUBCAT3", "AD_SUBCAT4", "AD_SUBCAT5", "PACKAGE_CODE", "BILL_NO", "BILL_DATE", "INSERTS", "PKG_ALIAS", "CONT_GROSS_AMT", "APP_STATUS", "APP_REMARKS", "APP_DATE", "APP_USER") 
SELECT INSERT_ID, CIO_BOOKING_ID, NO_INSERT, EDITION_CODE, PUBLICATION_CODE, PUB_CENT_CODE, SUPP_CODE, EDITION, INSERT_DATE, COL_CODE, HEIGHT, WIDTH, SIZE_BOOK, PAGE_POST, PREMIUM1, PREM_PER1, PREMIUM2, PREM_PER2, PREMIUM_ALLOW, AD_CAT, AD_SUB_CAT, LATEST_BY, REPEATING_DATE, STATUS_MATERIAL, FILE_NAME, CARD_RATE, DISC_RATE, INSERT_STATUS, BILL_STATUS, AGREED_RATE, PAI_FREE_INS, SOLO_RATE, GROSS_RATE, COMP_CODE, USERID, PAGE_NO, REMARKS, PUB_HEIGHT, PUB_WIDTH, PAGE_PREM, PAGE_PER, NO_OFCOLUMN, BILL_AMT, BILL_RATE, LOGO_H, LOGO_W, LOGO_NAME, AD_SUBCAT3, AD_SUBCAT4, AD_SUBCAT5, PACKAGE_CODE, BILL_NO, BILL_DATE, INSERTS, PKG_ALIAS, CONT_GROSS_AMT, APP_STATUS, APP_REMARKS, APP_DATE, APP_USER FROM TBL_BOOKING_INSERT_G WHERE SESID=USERENV ('sessionid') and CIO_BOOKING_ID=cioid;

*/
else
rollback;
 p_error        :=  'N';
 p_new_cioid    :=  newid;
--DELETE FROM TBL_BOOKING_INSERT WHERE "Cio_Booking_Id"=cioid;
--DELETE FROM TBL_BOOKING_mast WHERE "cio_booking_id"=cioid;
INSERT INTO tbladid_ins(CIOID,COUNTNUM,FLAG) VALUES(newid,countnum,p_error);
end if;
--delete from tbl_booking_mast_g where  CIO_BOOKING_ID=cioid;
--delete from tbl_booking_insert_g where  CIO_BOOKING_ID=cioid;
--delete from tbl_booking_vts_g where  cioid=newid;
end;
/


@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@kuldeep 21/01/12@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@


//=============23 JAN=*********************Start PAYMENT MODE***************ANKIT*==================//


CREATE OR REPLACE PACKAGE paymantinsert is
procedure   paymantinsert_p (paycode  in varchar2,
payname  in varchar2,
compcode  in varchar2,
userid  in varchar2,
alias1 in varchar2,CASH IN VARCHAR2);

end   paymantinsert;
/





CREATE OR REPLACE PACKAGE BODY paymantinsert is
procedure   paymantinsert_p (paycode  in varchar2,
payname  in varchar2,
compcode  in varchar2,
userid  in varchar2,
alias1 in varchar2,CASH IN VARCHAR2) as
begin
insert into payment_mode_mast("Comp_Code", "Pay_Mode_Code", "Payment_Mode_Name", "Userid", "Creation_Datetime",PAYMENT_MODE_ALIAS,CASHDISCOUNT)
values( compcode, paycode, payname, userid, SYSDATE ,alias1,CASH);
commit;
end   paymantinsert_p;
end   paymantinsert;
/









CREATE OR REPLACE PACKAGE paymentexe
IS
   TYPE t_accounts_cursor IS REF CURSOR;

   PROCEDURE paymentexe_p (
      compcode     IN       VARCHAR2,
      paycode      IN       VARCHAR2,
      payname      IN       VARCHAR2,
      userid in VARCHAR2,
      p_accounts   OUT      t_accounts_cursor
   );
END paymentexe;
/






CREATE OR REPLACE PACKAGE BODY paymentexe
IS
   PROCEDURE paymentexe_p (
      compcode     IN       VARCHAR2,
      paycode      IN       VARCHAR2,
      payname     IN       VARCHAR2,
      userid in VARCHAR2,
  p_accounts   OUT      t_accounts_cursor
   )
   AS
   BEGIN
      IF  payname is null
      THEN
         OPEN p_accounts FOR
       select "Comp_Code", "Pay_Mode_Code", "Payment_Mode_Name", "Userid",sysdate,PAYMENT_MODE_ALIAS,CASHDISCOUNT AS CASH  from   payment_mode_mast
         WHERE ("Comp_Code" = compcode OR compcode IS NULL)
               AND ("Pay_Mode_Code" =  paycode OR  paycode IS NULL)
               AND  "Payment_Mode_Name" LIKE   payname || '%' ;




      ELSE

         OPEN p_accounts FOR
          select "Comp_Code", "Pay_Mode_Code", "Payment_Mode_Name", "Userid",sysdate,PAYMENT_MODE_ALIAS,CASHDISCOUNT AS CASH  from   payment_mode_mast
         WHERE ("Comp_Code" = compcode OR compcode IS NULL)
               AND  "Payment_Mode_Name" LIKE   payname || '%' ;
      END IF;
   END  paymentexe_p;
END  paymentexe;
/






CREATE OR REPLACE PACKAGE paymantmodify is
procedure  paymantmodify_p (paycode  in varchar2,
payname  in varchar2,
compcode  in varchar2,
userid  in varchar2,
alias1 in varchar2,CASH IN VARCHAR2);

end   paymantmodify;
/






CREATE OR REPLACE PACKAGE BODY HT18JULY.paymantmodify is
procedure  paymantmodify_p (paycode  in varchar2,
payname  in varchar2,
compcode  in varchar2,
userid  in varchar2,
alias1 in varchar2,CASH IN VARCHAR2) as
begin
update payment_mode_mast set "Payment_Mode_Name"=payname,PAYMENT_MODE_ALIAS=alias1,CASHDISCOUNT=CASH where "Comp_Code"=compcode and "Pay_Mode_Code"=paycode;
commit;
end   paymantmodify_p;
end   paymantmodify;
/



@@@@@


//=============23 JAN=*********************Start PAYMENT MODE***************ANKIT*==================//



     
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@Issue no. 5584,6349,6022@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                                                                
                                                                     
                                                                     
                                             
CREATE OR REPLACE PROCEDURE completereport(
    p_compcode      IN VARCHAR2:= NULL,
    p_fromdate      IN VARCHAR2:= NULL,
    p_dateto        IN VARCHAR2:= NULL,
    p_dateformat    IN VARCHAR2:= NULL,
    p_publication   IN VARCHAR2:= NULL,
    p_pub_cent      IN VARCHAR2:= NULL,
    p_edition       IN VARCHAR2:= NULL,
    p_suppliment    IN VARCHAR2:= NULL,
    p_zone          IN VARCHAR2:= NULL,
    p_branch        IN VARCHAR2:= NULL,
    p_district      IN VARCHAR2:= NULL,
    p_region        IN VARCHAR2:= NULL,
    p_city          IN VARCHAR2:= NULL,
    p_revcenter     IN VARCHAR2:= NULL,
    p_adtype        IN VARCHAR2:= NULL,
    p_agencytype    IN VARCHAR2:= NULL,
    p_ratetype      IN VARCHAR2:= NULL,
    p_adcat         IN VARCHAR2:= NULL,
    p_adsubcat      IN VARCHAR2:= NULL,
    p_adsubcat3     IN VARCHAR2:= NULL,
    p_adsubcat4     IN VARCHAR2:= NULL,
    p_adsubcat5     IN VARCHAR2:= NULL,
    p_package       IN VARCHAR2:= NULL,
    p_scheme        IN VARCHAR2:= NULL,
    p_agency        IN VARCHAR2:= NULL,
    p_client        IN VARCHAR2:= NULL,
    p_executive     IN VARCHAR2:= NULL,
    p_retainer      IN VARCHAR2:= NULL,
    p_product       IN VARCHAR2:= NULL,
    p_brand         IN VARCHAR2:= NULL,
    p_varient       IN VARCHAR2:= NULL,
    p_pagetype      IN VARCHAR2:= NULL,
    p_pageprem      IN VARCHAR2:= NULL,
    p_postprem      IN VARCHAR2:= NULL,
    p_rostatus      IN VARCHAR2:= NULL,
    p_booktype      IN VARCHAR2:= NULL,
    p_contractname  IN varchar2:= NULL,
    p_filterby      IN varchar2:= NULL,
    p_adcheck       in varchar2:=null,
    p_state         in varchar2:=null,
    p_taluka        in varchar2:=null,
    p_base          in varchar2:=null,
    p_drpstatus     in varchar2:=null,
    p_chkdetail     in varchar2:=null,
    p_insertstatus  in varchar2:=null,
    p_puserid       in varchar2:=null,
    p_baxcode       in varchar2:=null, 
    p_chk_access    in varchar2:=null,
    p_recordset1    OUT Cur_Type_New1.cursor_type,
    p_accounts      OUT Cur_Type_New1.cursor_type)

IS
query1          VARCHAR2(20000);
v_val           number(5);
query2          VARCHAR2(20000);
query3          VARCHAR2(20000);


bookdate        varchar2(50);
noinsert        varchar2(50);
Paidinsert      varchar2(50);
Area            varchar2(50);
Pagepremium     varchar2(50);
cardamt         varchar2(50);
Deviationamt    varchar2(50);
Deviationper    varchar2(50);
aggamt          varchar2(50);
DiscAmt         varchar2(50);
Discper         varchar2(50);
posamt          varchar2(50);
posper          varchar2(50);
Spdiscamt       varchar2(50);
Spdiscper       varchar2(50);
Spacedisc       varchar2(50);
Spacediscper    varchar2(50);
Specialcharge   varchar2(50);
AgencyAddlTDper varchar2(50);
AgencyAddlTDAmt varchar2(50);
Grossamt        varchar2(50);
RetTDper        varchar2(50);
RetTDAmt        varchar2(50);
AgencyTDper     varchar2(50);
AgencyTDAmt     varchar2(50);
Billamt         varchar2(50);
RetCommper      varchar2(50);
RetCommAmt      varchar2(50);
ActualBusines   varchar2(50);



Cursor C1 Is
SELECT /*+ index(TBL_BOOKING_MAST IND_TBL_BOOKING_MAST) index(TBL_BOOKING_INSERT  INSERT_I) */  distinct m."cio_booking_id" AS "CIOID",
m."Package_code" as package_code,m."Gross_amount" as Crate,'1' as chk_var
FROM TBL_BOOKING_MAST m, TBL_BOOKING_INSERT i,agency_mast a
WHERE m."Comp_code"=p_compcode and m."Comp_code"=a."Comp_Code"
AND m."cio_booking_id"=i."Cio_Booking_Id"
AND ((m."Insertion_date" BETWEEN p_fromdate AND p_dateto and p_filterby='Publish Date') or (m."date_time" BETWEEN p_fromdate AND p_dateto and p_filterby='Booking Date'))
AND i."Publication_Code"=nvl(p_publication,i."Publication_Code")
--old version
--and m."branch" IN (SELECT "Branch_Name" FROM BRANCH_MST WHERE m."branch"="Branch_Name" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"=p_pub_cent or p_pub_cent is null))
and m."branch" IN (SELECT "Branch_Code" FROM BRANCH_MST WHERE m."branch"="Branch_Code" and "pub_center"=nvl(p_pub_cent,"pub_center"))
and m."branch" =nvl(p_branch,m."branch")

AND m."Ad_type_code"=nvl(p_adtype,m."Ad_type_code")
AND i."Ad_Cat"=nvl(p_adcat,i."Ad_Cat")
AND i."Edition_Code"=nvl(p_edition,i."Edition_Code")
and m."Agency_sub_code"= a."code_subcode" 
and (a."region" =p_region  or p_region is null)
and (m."Revenue_center" =p_revcenter or p_revcenter is null)
and (m."Agency_type" =p_agencytype or p_agencytype is null)
and (i."Ad_Sub_Cat" =p_adsubcat or p_adsubcat is null)
and (i."AD_SUBCAT3" =p_adsubcat3 or p_adsubcat3 is null)
and (i."AD_SUBCAT4" =p_adsubcat4 or p_adsubcat4 is null)
and (i."AD_SUBCAT5" =p_adsubcat5 or p_adsubcat5 is null)
and (m."Package_code" =p_package or p_package is null)
and (m."Scheme_type_code" =p_scheme or p_scheme is null)
and a."Agency_Code" =nvl(p_agency,a."Agency_Code")
and (m."Client_code" =p_client or p_client is null)
and (m."Executive_code" =p_executive or p_executive is null)
and (m.RETAINER =p_retainer or p_retainer is null)
and (m."Product_code" =p_product  or p_product is null)
and (m."Brand_code" =p_brand or p_brand is null)
and (m."Variant_code" =p_varient or p_varient is null)
and (m."Page_type_code" =p_pagetype or p_pagetype is null)
and (m."Page_prem" =p_pageprem or p_pageprem is null)
and (m."Page_position_code" =p_postprem or p_postprem is null)
and (m."ro_status" =p_rostatus or p_rostatus is null)
and (m."Booking_type" =p_booktype or p_booktype is null)
and (m."Contract_name" =p_contractname or p_contractname is null)
and (i."Supp_Code" =p_suppliment or p_suppliment is null)
and (m."Rate_code" =p_ratetype or p_ratetype is null)

and ((p_base='1' and a."City_Code" =p_city or p_city is null)
or (p_base='2' and m."Executive_code"  in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" =p_city or p_city is null))
or (p_base='3' and m.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."City_Code"=p_city or p_city is null)))

and ((p_base='1' and a."zone_code" =p_zone or p_zone is null)
or (p_base='2' and m."Executive_code"  in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" in (select city_mst."City_Code" from city_mst where city_mst."Zone_Code"= p_zone or p_zone is null) ))
or (p_base='3' and m.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Zone_Code"=p_zone or p_zone is null)))

and ((p_base='1' and a."Dist_Code" =p_district or p_district is null)
or (p_base='2' and m."Executive_code"  in(select exec_mast."Exe_no" from exec_mast where exec_mast."dist_code"= p_district or p_district is null ))
or (p_base='3' and m.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Dist_Code"=p_district or p_district is null)))

and ((p_base='1' and a."State_Code" =p_state or p_state is null)
or (p_base='2' and m."Executive_code"  in(select exec_mast."Exe_no" from exec_mast where exec_mast."State_code"= p_state or p_state is null ))
or (p_base='3' and m.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."State_Code"=p_state or p_state is null)))

and ((p_base='1' and a.TALUKA=p_taluka or p_taluka is null)
or (p_base='2' and m."Executive_code"  in(select exec_mast."Exe_no" from exec_mast where exec_mast.TALUKA= p_taluka or p_taluka is null ))
or (p_base='3' and m.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER.TALUKA=p_taluka or p_taluka is null)))

and ((p_base='1' and m."Agency_sub_code" IS NOT NULL AND m."Agency_sub_code"!='0')
or (p_base='2' and m."Executive_code"    is not null and m."Executive_code" !='0' )
or (p_base='3' and m.RETAINER is not null  and m.RETAINER !='0'))

and ((p_drpstatus is  not null and  i."Insert_Status"!='XYZ') or 
(p_drpstatus is  null and  lower(i."Insert_Status")!='cancel'))
and (lower(i."Insert_Status")=p_insertstatus or p_insertstatus is null)

and ((i."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id=p_puserid) and p_chk_access=1)
or  (p_chk_access=0) )
and p_adcheck='1'

union

SELECT /*+ index(TBL_BOOKING_MAST IND_TBL_BOOKING_MAST) index(TBL_BOOKING_INSERT  INSERT_I) */ distinct m."cio_booking_id" AS "CIOID",
m."Package_code" as package_code,i."Gross_Rate" as Crate,'1' as chk_var
FROM TBL_BOOKING_MAST m, TBL_BOOKING_INSERT i,AGENCY_MAST a
WHERE m."Comp_code"=p_compcode
AND m."Comp_code"=i."Comp_Code" AND m."Comp_code"=a."Comp_Code"
AND m."cio_booking_id"=i."Cio_Booking_Id"
AND (i."Insert_Date" BETWEEN p_fromdate AND p_dateto )
AND (i."Publication_Code"=p_publication or p_publication is null)
--old version

--and m."branch" IN (SELECT "Branch_Name" FROM BRANCH_MST WHERE m."branch"="Branch_Name" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"=p_pub_cent or p_pub_cent is null))
and m."branch" IN (SELECT "Branch_Code" FROM BRANCH_MST WHERE m."branch"="Branch_Code" and "pub_center" =nvl(p_pub_cent,"pub_center"))
and m."branch" =nvl(p_branch,m."branch")

AND m."Ad_type_code"=nvl(p_adtype,m."Ad_type_code")
AND i."Ad_Cat" =nvl(p_adcat,i."Ad_Cat")
AND i."Edition_Code"=nvl(p_edition,i."Edition_Code")
and m."Agency_sub_code"  =a."code_subcode" 
and (a."region" =p_region  or p_region is null)
and (m."Revenue_center" =p_revcenter or p_revcenter is null)
and (m."Agency_type" =p_agencytype or p_agencytype is null)
and (m."Ad_sub_cat_code" =p_adsubcat or p_adsubcat is null)
and (i."AD_SUBCAT3" =p_adsubcat3 or p_adsubcat3 is null)
and (i."AD_SUBCAT4" =p_adsubcat4 or p_adsubcat4 is null)
and (i."AD_SUBCAT5" =p_adsubcat5 or p_adsubcat5 is null)
and (m."Package_code" =p_package or p_package is null)
and (m."Scheme_type_code" =p_scheme or p_scheme is null)
and a."Agency_Code" =nvl(p_agency,a."Agency_Code")
and (m."Client_code" =p_client or p_client is null)
and (m."Executive_code" =p_executive or p_executive is null)
and (m.RETAINER =p_retainer or p_retainer is null)
and (m."Product_code" =p_product  or p_product is null)
and (m."Brand_code" =p_brand or p_brand is null)
and (m."Variant_code" =p_varient or p_varient is null)
and (m."Page_type_code" =p_pagetype or p_pagetype is null)
and (i."Premium1"  =p_pageprem or p_pageprem is null)
and (i."Page_Post" =p_postprem or p_postprem is null)
and (m."ro_status" =p_rostatus or p_rostatus is null)
and (m."Booking_type" =p_booktype or p_booktype is null)
and (m."Contract_name" =p_contractname or p_contractname is null)
and (i."Supp_Code" =p_suppliment or p_suppliment is null)
and (m."Rate_code" =p_ratetype or p_ratetype is null)
and ((p_base='1' and a."City_Code" =p_city or p_city is null)
or (p_base='2' and m."Executive_code"  in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" =p_city or p_city is null))
or (p_base='3' and m.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."City_Code"=p_city or p_city is null)))
and ((p_base='1' and a."zone_code" =p_zone or p_zone is null)
or (p_base='2' and m."Executive_code"  in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" in (select /*+ index(city_mst ind_city_mst) */ city_mst."City_Code" from city_mst where city_mst."Zone_Code"= p_zone or p_zone is null)
))
or (p_base='3' and m.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Zone_Code"=p_zone or p_zone is null)))
and ((p_base='1' and a."Dist_Code" =p_district or p_district is null)
or (p_base='2' and m."Executive_code"  in(select exec_mast."Exe_no" from exec_mast where exec_mast."dist_code"= p_district or p_district is null ))
or (p_base='3' and m.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Dist_Code"=p_district or p_district is null)))
and ((p_base='1' and a."State_Code" =p_state or p_state is null)
or (p_base='2' and m."Executive_code"  in(select exec_mast."Exe_no" from exec_mast where exec_mast."State_code"= p_state or p_state is null ))
or (p_base='3' and m.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."State_Code"=p_state or p_state is null)))
and ((p_base='1' and a.TALUKA=p_taluka or p_taluka is null)
or (p_base='2' and m."Executive_code"  in(select exec_mast."Exe_no" from exec_mast where exec_mast.TALUKA= p_taluka or p_taluka is null ))
or (p_base='3' and m.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER.TALUKA=p_taluka or p_taluka is null)))
and ((p_base='1' and m."Agency_sub_code" IS NOT NULL AND m."Agency_sub_code"!='0')
or (p_base='2' and m."Executive_code"    is not null and m."Executive_code" !='0' )
or (p_base='3' and m.RETAINER is not null  and m.RETAINER !='0'))
and ((p_drpstatus is  not null and i."Insert_Status"!='XYZ')
or (p_drpstatus is  null and  lower(i."Insert_Status")!='cancel'))
and (lower(i."Insert_Status")=p_insertstatus or p_insertstatus is null)

and ((i."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id=p_puserid) and p_chk_access=1)
or  (p_chk_access=0) )

and p_adcheck='3'

union

SELECT /*+ index (ad_bills_det ind1_ad_bills_det) */distinct bl."IDNUM" AS "CIOID",
bld.PACKAGE_CODE as package_code,bl.GROSS_AMT as Crate,'2' as chk_var
FROM ad_bills bl, ad_bills_det bld,agency_mast a,branch_mst b
WHERE bl.IDNUM=bld.IDNUM
AND bl.BILDT >= p_fromdate and bl.BILDT <= p_dateto
and (bl."PRIPUB"=p_publication  or p_publication is null)
and (bld."EDITION"=p_edition or p_edition is null)
and bl.AGCODE =a."code_subcode" and (a."region" =p_region  or p_region is null)
and (bld."AD_TYPE_V"=p_adtype or p_adtype is null)
and (a."Agency_Type_Code" =p_agencytype or p_agencytype is null)
and (bld.PRIADCTG =p_adcat or p_adcat is null)
and (bld.SECADCTG =p_adsubcat or p_adsubcat is null)
and (bld."AD_SUBCAT3"  =p_adsubcat3 or p_adsubcat3 is null)
and (bld.AD_SUBCAT4 =p_adsubcat4 or p_adsubcat4 is null)
and (bld.AD_SUBCAT5 =p_adsubcat5 or p_adsubcat5 is null)
and (bld.PACKAGE_CODE =p_package or p_package is null)
and (a."Agency_Code" =p_agency or p_agency is null)
and (bl."CLIENTCD"=p_client or p_client is null)
and (bl."EXECUTIVE_NAME"=p_executive or p_executive is null)
and (bl."PRIPROCTG"=p_product or p_product is null)
and ((bl."PRIPROCTG" in (select /*+ index(brand_mst brand_mst_pk)*/ brand_mst."prod_cat_code" from brand_mst where brand_mst."brand_code"=p_brand or p_brand is null)
and bl."PRIPROCTG" is not null)or (bl."PRIPROCTG" is null))
and ((bl."PRIPROCTG" in (select /*+ index(brand_mst brand_mst_pk)*/ brand_mst."prod_cat_code" from brand_mst where brand_mst."brand_code" in(select /*+ index(varient_mst ind_varient_mst) */ varient_mst."Brand_Code" from varient_mst where varient_mst."Varient_Name"=p_varient or p_varient is null))
and bl."PRIPROCTG" is not null) or (bl."PRIPROCTG" is null))
and (bld.PAGE_PREM =p_pageprem or p_pageprem is null)
and (bld.PAGE_POST =p_postprem or p_postprem is null)
and (bl.CONTRACT_NAME =p_contractname or p_contractname is null)
and (bld.SUPP_CODE =p_suppliment or p_suppliment is null)
and (bl.RETAINER_CODE =p_retainer or p_retainer is null)
and (bld.RATECD =p_ratetype or p_ratetype is null)
and bl.UNIT = b."Branch_Code" and b."Branch_Code" =nvl(p_branch,b."Branch_Code")
and (b."pub_center"=p_pub_cent or p_pub_cent is null)
and (bl.SCHEME=scheme or scheme is null)
and (bl.REVENUE_CENTER =p_revcenter or p_revcenter is null)
and (bl.RO_STATUS =p_rostatus or p_rostatus is null)
and (bl.PAGE_TYPE =p_pagetype or p_pagetype is null)
and (bl.BOOKING_TYPE =p_booktype or p_booktype is null)
 and (bl.SCHEME=p_scheme or p_scheme is null)
 and (bl.REVENUE_CENTER =p_revcenter or p_revcenter is null)
 and (bl.RO_STATUS =p_rostatus or p_rostatus is null)
 and (bl.PAGE_TYPE =p_pagetype or p_pagetype is null)
 and (bl.BOOKING_TYPE =p_booktype or p_booktype is null)
and ((p_base='1' and (a."City_Code" =p_city or p_city is null))
or (p_base='2' and bl.EXECUTIVE_NAME in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" =p_city or p_city is null))
or (p_base='3' and bl.RETAINER_CODE in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."City_Code"=p_city or p_city is null)))

and ((p_base='1' and (a."zone_code" =p_zone or p_zone is null))
or (p_base='2' and bl.EXECUTIVE_NAME in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" in (select city_mst."City_Code" from city_mst where city_mst."Zone_Code"= p_zone or p_zone is null) ))
or (p_base='3' and bl.RETAINER_CODE in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Zone_Code"=p_zone or p_zone is null)))

and ((p_base='1' and (a."Dist_Code" =p_district or p_district is null))
or (p_base='2' and bl.EXECUTIVE_NAME in(select exec_mast."Exe_no" from exec_mast where exec_mast."dist_code"= p_district or p_district is null ))
or (p_base='3' and bl.RETAINER_CODE in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Dist_Code"=p_district or p_district is null)))

and ((p_base='1' and (a."State_Code" =p_state or p_state is null))
or (p_base='2' and bl.EXECUTIVE_NAME in(select exec_mast."Exe_no" from exec_mast where exec_mast."State_code"= p_state or p_state is null ))
or (p_base='3' and bl.RETAINER_CODE in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."State_Code"=p_state or p_state is null)))

and ((p_base='1' and (a.TALUKA=p_taluka or p_taluka is null) )
or (p_base='2' and bl.EXECUTIVE_NAME   in(select exec_mast."Exe_no" from exec_mast where exec_mast.TALUKA= p_taluka or p_taluka is null ))
or (p_base='3' and bl.RETAINER_CODE  in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER.TALUKA=p_taluka or p_taluka is null)))

and ((p_base='1' and bl.AGCODE IS NOT NULL AND bl.AGCODE!='0')
or (p_base='2' and bl.EXECUTIVE_NAME   is not null and bl.EXECUTIVE_NAME !='0' )
or (p_base='3' and bl.RETAINER_CODE  is not null  and bl.RETAINER_CODE !='0'))

and ((bld."BKFOR" in (select distinct pub_center from login_center where newuser_id=p_puserid) and p_chk_access=1)
or  (p_chk_access=0) )

and p_adcheck='2';

v1 c1%rowtype;


---**************************************  For Billing Data*************************
Cursor C2 Is
SELECT distinct bl."IDNUM" AS "CIOID",bl.BILNO as "BILLNO" ,bl.ag_main_code as "AGMAINCODE",
bl.ag_sub_code as "AG_SUB_CODE",bl.agcode as "AGCODE",
a."Agency_Name" as "AGNAME",nvl(bl.executive_name,0) as "EXECCODE",
AD_GET_EXECNAME(bl.comp_code_v,bl.EXECUTIVE_NAME) as "EXECNAME",bl.RETAINER_CODE as "RETCODE",
AD_GET_RETAINER(bl.comp_code_v,bl.RETAINER_CODE) as "RETNAME"
FROM ad_bills bl ,AGENCY_MAST a,branch_mst b WHERE bl.comp_code_v=p_compcode
and bl.UNIT=b."Branch_Code" and b."Branch_Code" =nvl(p_branch,b."Branch_Code")
and bl.BILDT >= p_fromdate and bl.bildt <=p_dateto
and b."pub_center" =nvl(p_pub_cent,b."pub_center")
and bl.ag_main_code =a."Agency_Code" and bl.ag_sub_code =a."SUB_Agency_Code" and 
(a."region" =p_region  or p_region is null)
and a."Agency_Type_Code" =nvl(p_agencytype,a."Agency_Type_Code")
and (bl."PRIPUB"=p_publication  or p_publication is null)
and a."Agency_Code" =nvl(p_agency,a."Agency_Code")
and (bl."CLIENTCD"=p_client or p_client is null)
and (bl."EXECUTIVE_NAME"=p_executive or p_executive is null)
and (bl."PRIPROCTG"=p_product or p_product is null)
and ((bl."PRIPROCTG" in (select brand_mst."prod_cat_code" from brand_mst where brand_mst."brand_code"=p_brand or p_brand is null) 
and bl."PRIPROCTG" is not null)or (bl."PRIPROCTG" is null))
and ((bl."PRIPROCTG" in (select brand_mst."prod_cat_code" from brand_mst where brand_mst."brand_code" 
in(select varient_mst."Brand_Code" from varient_mst where varient_mst."Varient_Name"=p_varient or p_varient is null)) 
and bl."PRIPROCTG" is not null) or (bl."PRIPROCTG" is null))
and (bl.CONTRACT_NAME =p_contractname or p_contractname is null)
and (bl.RETAINER_CODE =p_retainer or p_retainer is null)
and (bl.SCHEME=p_scheme or p_scheme is null)
and (bl.REVENUE_CENTER =p_revcenter or p_revcenter is null)
and (bl.RO_STATUS =p_rostatus or p_rostatus is null)
and (bl.PAGE_TYPE =p_pagetype or p_pagetype is null)
and (bl.BOOKING_TYPE =p_booktype or p_booktype is null)
and ((p_base='1' and (a."City_Code" =p_city or p_city is null))
or (p_base='2' and bl.EXECUTIVE_NAME in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" =p_city or p_city is null))
or (p_base='3' and bl.RETAINER_CODE in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."City_Code"=p_city or p_city is null)))
and ((p_base='1' and (a."zone_code" =p_zone or p_zone is null))
or (p_base='2' and bl.EXECUTIVE_NAME in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" in (select city_mst."City_Code" from city_mst where city_mst."Zone_Code"= p_zone or p_zone is null) ))
or (p_base='3' and bl.RETAINER_CODE in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Zone_Code"=p_zone or p_zone is null)))
and ((p_base='1' and (a."Dist_Code" =p_district or p_district is null))
or (p_base='2' and bl.EXECUTIVE_NAME in(select exec_mast."Exe_no" from exec_mast where exec_mast."dist_code"= p_district or p_district is null ))
or (p_base='3' and bl.RETAINER_CODE in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Dist_Code"=p_district or p_district is null)))
and ((p_base='1' and (a."State_Code" =p_state or p_state is null))
or (p_base='2' and bl.EXECUTIVE_NAME in(select exec_mast."Exe_no" from exec_mast where exec_mast."State_code"= p_state or p_state is null ))
or (p_base='3' and bl.RETAINER_CODE in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."State_Code"=p_state or p_state is null)))
and ((p_base='1' and (a.TALUKA=p_taluka or p_taluka is null) )
or (p_base='2' and bl.EXECUTIVE_NAME   in(select exec_mast."Exe_no" from exec_mast where exec_mast.TALUKA= p_taluka or p_taluka is null ))
or (p_base='3' and bl.RETAINER_CODE  in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER.TALUKA=p_taluka or p_taluka is null)))
and ((p_base='1' and bl.AGCODE IS NOT NULL AND bl.AGCODE!='0')
or (p_base='2' and bl.EXECUTIVE_NAME   is not null and bl.EXECUTIVE_NAME !='0' )
or (p_base='3' and bl.RETAINER_CODE  is not null  and bl.RETAINER_CODE !='0'));

v2 C2%rowtype;

--**********************************************************************************

v_edition varchar2(100);
v_edipkg varchar2(500);
prefer   varchar2(10);

BEGIN
/*insert into dbgstr(rdate,str,seq) values(sysdate,'Start of Complete Report',dbg_seq.nextval);commit;
delete from searchtbl;
insert into searchtbl values('compcode-'||p_compcode||'fromdate-'||p_fromdate||'dateto-'||p_dateto||'dateformat-'||p_dateformat||'publication-'||p_publication
||'pub_cent-'||p_pub_cent||'edition-'||p_edition||'suppliment-'||p_suppliment||'zone-'||p_zone||'branch-'||p_branch||'district-'||p_district||'region-'||p_region||
'city-'||p_city||'revcenter-'||p_revcenter||'adtype-'||p_adtype||'agencytype-'||p_agencytype||'ratetype-'||p_ratetype||'adcat-'||p_adcat||'adsubcat-'||p_adsubcat||
'adsubcat3-'||p_adsubcat3||'adsubcat4-'||p_adsubcat4||'adsubcat5-'||p_adsubcat5||'package-'||p_package||'scheme-'||p_scheme||'agency-'||p_agency||'client-'||p_client||
'executive-'||p_executive||'retainer-'||p_retainer||'product-'||p_product||'brand-'||p_brand||'varient-'||p_varient||'pagetype-'||p_pagetype||'pageprem-'||p_pageprem||
'postprem-'||p_postprem||'rostatus-'||p_rostatus||'booktype-'||p_booktype||'contractname-'||p_contractname||'filterby-'||p_filterby||'adcheck-'||p_adcheck||'state-'||p_state||
'taluka-'||p_taluka||'base-'||p_base||'drpstatus-'||p_drpstatus||'chkdetail-'||p_chkdetail||'insertstatus-'||p_insertstatus||'puserid-'||p_puserid||'chk_access-'||p_chk_access);

commit;*/








select DISTINCT AGENCY_RETAINER_COMM into prefer from preferrences where "comp_code"=p_compcode;

delete from multipack_rep where sess_id=userenv('sessionid')  ;
delete from multipack_rat where sess_id=userenv('sessionid') ;
DELETE FROM multipack_ratnew where sess_id=userenv('sessionid')  ;

commit;
--insert into dbgstr(rdate,str,seq) values(sysdate,'Delete multipack tables',dbg_seq.nextval);commit;
open c1;
loop
fetch c1 into v1;
exit when c1%notfound;
    --insert into dbgstr(rdate,str,seq) values(sysdate,'Open C1',dbg_seq.nextval);commit;
    
     v_val:=multipack_report(v1.CIOID,v1.package_code,v1.Crate,v1.chk_var);
   -- insert into dbgstr(rdate,str,seq) values(sysdate,'Open C1 multipack_report',dbg_seq.nextval);commit;
    v_edition:=null;v_edipkg:=null;
end loop;
close c1;
--insert into dbgstr(rdate,str,seq) values(sysdate,'close C1',dbg_seq.nextval);commit;
commit;

if(p_chkdetail='Detail')then

if(p_adcheck=1)
then
query1:=query1||'SELECT distinct m."cio_booking_id" AS "CIOID",
to_char(m."date_time",'''||p_dateformat||''') as "BookDate",
a."Agency_Name" AS "Agency",
NVL((SELECT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code"=m."Client_code"),m."Client_code")  AS "Client",
m."RO_No" AS "RoNo.",
CASE '''||p_dateformat||'''
WHEN ''mm/dd/yyyy'' THEN TO_CHAR(m."RO_Date",''mm/dd/yyyy'')
WHEN ''dd/mm/yyyy'' THEN TO_CHAR(m."RO_Date" ,''dd/mm/yyyy'')
WHEN ''yyyy/mm/dd'' THEN TO_CHAR(m."RO_Date",''yyyy/mm/dd'') END AS "Ro.Date",
(select EXEC_MAST."Exec_name" from exec_mast where m."Executive_code"=to_char(exec_mast."Exe_no")) AS "Executive",
(select RETAINERMASTER."Retain_Name"  FROM  RETAINERMASTER where RETAINERMASTER."Retain_Code"=m.RETAINER ) AS "Retainer",
decode(m."Booking_type",''1'',''Barter'',''2'',''FMG'',''3'',''Normal'',''4'',''InHouse'',''5'',''Complimentary'',''Normal'') as "BookType",
(select col_mast."Col_Alias" from col_mast where m."Color_code"=col_mast."Col_Code") as "Color",
adv_cat_mast."Adv_Cat_Name" as "Adcat",
(select adv_subcat_mast."Adv_Subcat_Name" from adv_subcat_mast where i."Ad_Sub_Cat"=adv_subcat_mast."Adv_Subcat_Code" and  adv_cat_mast."Adv_Cat_Code"=adv_subcat_mast."Adv_Cat_Code")as "Adsubcat",
(select ad_cat3."catname" from ad_cat3,adv_subcat_mast  where m."Ad_Subcat3"=ad_cat3."catcode" and ad_cat3."subcatname"=adv_subcat_mast."Adv_Subcat_Code" and i."Ad_Sub_Cat"=adv_subcat_mast."Adv_Subcat_Code" and  adv_cat_mast."Adv_Cat_Code"=adv_subcat_mast."Adv_Cat_Code") as "Adsubcat3",
(select tbl_cat4."Cat_Name" from tbl_cat4,adv_subcat_mast where i."AD_SUBCAT4"=tbl_cat4."Cat_Code" and tbl_cat4."Sub_Cat_Name"=adv_subcat_mast."Adv_Subcat_Code" and i."Ad_Sub_Cat"=adv_subcat_mast."Adv_Subcat_Code" and  adv_cat_mast."Adv_Cat_Code"=adv_subcat_mast."Adv_Cat_Code") as "Adsubcat4",
(select tbl_cat5."Cat_Name" from tbl_cat5,adv_subcat_mast where i."AD_SUBCAT5"=tbl_cat5."Cat_Code" and tbl_cat5."Sub_Cat_Name"=adv_subcat_mast."Adv_Subcat_Code" and i."Ad_Sub_Cat"=adv_subcat_mast."Adv_Subcat_Code" and  adv_cat_mast."Adv_Cat_Code"=adv_subcat_mast."Adv_Cat_Code") as "Adsubcat5",
--FETCH_PACK(m."cio_booking_id") AS "Package",
case when instr(m."Package_code",'','') >0 then
    FETCH_PACK_new(m."cio_booking_id", m."Package_code" ) 
else
(select distinct min("Combin_Desc") from combin_mast where "Combin_Code"=m."Package_code")
end AS "Package",   
to_char(m."Insertion_date",'''||p_dateformat||''') as "PubDate",
m."No_of_insertion" as "noinsert",
m."Paid_ins" as "Paidinsert",
m."Ad_size_height" as "height",
m."Ad_size_width" as "width",
m."Total_area" as "Area",
(select ADVPOS_PREM_MAST."premiumname" from advpos_prem_mast where m."Page_prem"=ADVPOS_PREM_MAST."Premiumcode") as "Pagepremium",
(select advpos_type_mast."Pos_Type" from advpos_type_mast where m."Page_position_code"=advpos_type_mast."Pos_Type_Code") as "Postprem",
(select scheme_master."Scheme_Name" from scheme_master where m."Scheme_type_code"=scheme_master."scheme_id") as "scheme",
m."Rate_code" as "Ratecode",
m."Card_rate" as "cardrate",
m."Card_amount" as "cardamt",
m."Contract_rate" as "contractrate",
m."Deviation" as "Deviationamt",
m."Deviation" AS "Deviation(%)",
m."Agrred_rate" as "Aggrate",
m."Agreed_amount" as "aggamt",
(m."Card_amount" - DECODE(NVL(m."Agreed_amount",0),0,m."Card_amount",m."Agreed_amount")) as "DiscAmt",
m."Discount_per" as "Discper",
(select SUM(nvl(RAT,0)) from multipack_rat where cioid=m."cio_booking_id"  and sess_id='||userenv('sessionid')||') as  "posamt",
(select SUM(nvl(PER_AMT,0)) from multipack_rat where cioid=m."cio_booking_id"   and sess_id='||userenv('sessionid')||') as "pos(%)",
round(((m."Special_disc_per" * m."Total_area" * m."Card_rate")/100),2) as "Spdiscamt",
m."Special_disc_per" as "Spdiscper",
round(((m."Space_disc_per" * m."Total_area" * m."Card_rate")/100),2) as "Spacedisc",
m."Space_disc_per" as "Spacediscper",
m."Special_charges" as "Specialcharge",
nvl(m."ADD_AGENCY_COMM",''0'') as "AgencyAddlTD(%)",
nvl((nvl(m."Gross_amount",''0'')*nvl(m."ADD_AGENCY_COMM",''0'')/100),''0'') as "AgencyAddlTDAmt",
nvl(m."Gross_amount",''0'') as "Grossamt",
(select DISTINCT TO_NUMBER(NVL("Comm_Rate",''0''))    from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(m."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(m."RETAINER",''0'')) AND ROWNUM<=1 ) as "RetTD(%)",
nvl(m."Gross_amount",''0'')*(select DISTINCT TO_NUMBER(NVL("Comm_Rate",''0''))    from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(m."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(m."RETAINER",''0'')) AND ROWNUM<=1 )/100 as "RetTDAmt",
nvl(m."Trade_disc",''0'' )as "AgencyTD(%)",
(nvl(m."Gross_amount",''0'')* nvl(m."Trade_disc",''0'' )/100 )as "AgencyTDAmt",
nvl(m."Bill_amount",''0'') as "Billamt",
nvl(case( '''||prefer||''' )
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(m."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(m."RETAINER",''0'')) AND ROWNUM<=1)
         when ''Gross'' then
                (
                 CASE to_number(nvl(m.RETAINER_COMM,0))
                 WHEN 0 THEN 0
                 ELSE (to_number(nvl(m.RETAINER_COMM,''0''))-to_number(nvl(m."ADD_AGENCY_COMM",''0'' )))
                 end )
         when ''Net''   then  to_number(nvl(m.RETAINER_COMM,''0''))
        END )

    ELSE (select 0  from dual)
end  ,''0'') as "RetComm(%)",
nvl(
case( '''||prefer||''' )
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(m."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(m."RETAINER",''0'')) AND ROWNUM<=1)
         when ''Gross'' then
                 (
                 CASE to_number(nvl(m.RETAINER_COMM_AMT,0))
                 WHEN 0 THEN 0
                 ELSE (to_number(nvl(m.RETAINER_COMM_AMT,''0''))-(nvl((nvl(m."Gross_amount",''0'')*to_number(nvl(m."ADD_AGENCY_COMM",''0''))/100),''0'')))
                 end )


         when ''Net''   then  (nvl(m."Gross_amount",''0'')*(to_number(nvl(m.RETAINER_COMM,''0'')) )/100)
        END )

    ELSE (select 0  from dual)
end
,''0'') as "RetCommAmt",
minus_to_zero(nvl((  NVL(m."Bill_amount",''0'')-
nvl(
case( '''||prefer||''' )
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(m."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(m."RETAINER",''0'')) AND ROWNUM<=1)
         when ''Gross'' then

                 (
                 CASE to_number(nvl(m.RETAINER_COMM_AMT,0))
                 WHEN 0 THEN 0
                 ELSE (to_number(nvl(m.RETAINER_COMM_AMT,''0''))-(nvl((nvl(m."Gross_amount",''0'')*to_number(nvl(m."ADD_AGENCY_COMM",''0''))/100),''0'')))
                 end )


         when ''Net''   then  (nvl(m."Gross_amount",''0'')*(to_number(nvl(m.RETAINER_COMM,''0'')) )/100)
        END )

    ELSE (select 0  from dual)
end
,''0'') ),''0'')) as "ActualBusiness",

(SELECT BRANCH_MST."Branch_Name" FROM BRANCH_MST WHERE m."Revenue_center"=BRANCH_MST."Branch_Code" )as "Revcenter",
UOM_MAST."Uom_Name"  AS "Uom",
uom_mast.UOM_DESC as "uomdesc"
,(select pub_cent_mast."Pub_Cent_name" from pub_cent_mast where pub_cent_mast."Pub_cent_Code" in(select "pub_center" from  BRANCH_MST WHERE m."branch"="Branch_Code") ) as "Printcenter"
,(SELECT "Branch_Name" FROM BRANCH_MST where  m."branch" = "Branch_Code") as "Branch"


,case '''||p_base||'''
when ''1'' then  a."Dist_Code"
when ''2'' then (select dist_mst."Dist_Name" from dist_mst where dist_mst."Dist_Code" in(select exec_mast."dist_code" from exec_mast where  to_char(exec_mast."Exe_no")=m."Executive_code" )  )
when ''3'' then (select dist_mst."Dist_Name" from dist_mst where dist_mst."Dist_Code" in(select RETAINERMASTER."Dist_Code" from RETAINERMASTER where  RETAINERMASTER."Retain_Code"= m.RETAINER )  ) end as "District"
,case '''||p_base||'''
when ''1'' then (select taluka_mast.TALU_NAME  from taluka_mast where a.TALUKA=taluka_mast.TALU_CODE )
when ''2'' then (select taluka_mast.TALU_NAME  from taluka_mast where taluka_mast.TALU_CODE in(select exec_mast.TALUKA from exec_mast where  to_char(exec_mast."Exe_no")=m."Executive_code" )  )
when ''3'' then (select taluka_mast.TALU_NAME  from taluka_mast where taluka_mast.TALU_CODE in(select RETAINERMASTER.TALUKA from RETAINERMASTER where  RETAINERMASTER."Retain_Code"= m.RETAINER )  ) end as "Taluka"
,nvl(m."Page_no",0) as "Page_No"
,m.CASHDISCOUNT as "Cash_Disc"
,m."Box_code" as "BoxCode",m."Userid" as USERID,(SELECT max("username") from login where com_code = m."Comp_code" and "userid"=m."Userid") as USERNAME
FROM TBL_BOOKING_MAST m,AGENCY_MAST a ,UOM_MAST,
adv_cat_mast,
adv_type_mast,
TBL_BOOKING_insert i
WHERE m."Comp_code"='''||p_compcode||''' AND
m."cio_booking_id"=i."Cio_Booking_Id" AND
UOM_MAST."Uom_Code"=m."Uom_code" and
m."Agency_sub_code"=a."Agency_Code"||a."SUB_Agency_Code" AND
i."Ad_Cat"=adv_cat_mast."Adv_Cat_Code" and
m."Ad_type_code"=adv_type_mast."Adv_Type_Code"
and adv_type_mast."Adv_Type_Code"=adv_cat_mast."Adv_Type" and
((i."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id='''||p_puserid||''') and '''||p_chk_access||'''=''1'')
or  ('''||p_chk_access||'''=''0'') )' ;


if(p_base='2')then
query1:=query1||' and (m."Executive_code" is not null and m."Executive_code" !=''0'')  ';
end if;

if(p_base='3')then
query1:=query1||' and (m.RETAINER is not null  and m.RETAINER !=''0'')  ';
end if;


if(p_drpstatus is null) then
query1:=query1||' and lower(i."Insert_Status")!='''||'cancel'||'''';
end if;

if(p_insertstatus is not null) then
query1:=query1||' and lower(i."Insert_Status")='''||p_insertstatus||'''';
end if;

IF(p_fromdate IS NOT NULL AND p_dateto IS NULL  and  p_filterby='Booking Date')
THEN
query1:=query1||' and m."date_time" ='''||p_fromdate||'''';
END IF;

IF(p_fromdate IS NOT NULL AND p_dateto IS NOT NULL and p_filterby='Booking Date' )
THEN
query1:=query1||' and m."date_time" between  '''||p_fromdate ||''' and  '''||p_dateto||''' ';
END IF;

IF(p_fromdate IS NOT NULL AND p_dateto IS NULL  and  p_filterby='Publish Date')
THEN
--query1:=query1||' and m."Insertion_date" ='''||p_fromdate||'''';
query1:=query1||' and i."Insert_Date" ='''||p_fromdate||'''';
END IF;

IF(p_fromdate IS NOT NULL AND p_dateto IS NOT NULL and p_filterby='Publish Date' )
THEN
--query1:=query1||' and m."Insertion_date"  between  '''||p_fromdate ||''' and  '''||p_dateto||''' ';
query1:=query1||' and i."Insert_Date"  between  '''||p_fromdate ||''' and  '''||p_dateto||''' ';
END IF;

IF(p_publication IS NOT NULL)
THEN
query1:=query1||' and i."Publication_Code"='''||p_publication||'''    ';
END IF;

IF(p_pub_cent IS NOT NULL)
THEN
query1:=query1||'  and m."branch" IN (SELECT "Branch_Code" FROM BRANCH_MST WHERE m."branch"="Branch_Code" and "pub_center" ='''||p_pub_cent||''')';
END IF;


IF(p_branch IS NOT NULL)
THEN
query1:=query1||'  and m."branch" ='''||p_branch||'''';
END IF;


IF(p_edition IS NOT NULL)
THEN
query1:=query1||'  and i."Edition_Code"='''||p_edition||'''';
END IF;

IF(p_region IS NOT NULL)
THEN
query1:=query1 ||' and a."region" ='''||p_region ||''' ';
END IF;

IF(p_revcenter IS NOT NULL)
THEN
query1:=query1 ||' and m."Revenue_center" ='''||p_revcenter||'''';
END IF;

IF(p_adtype IS NOT NULL)
THEN
query1:=query1 || ' and m."Ad_type_code"='''||p_adtype||'''';
END IF;

IF(p_agencytype IS NOT NULL)
THEN
query1:=query1 || ' and m."Agency_type" ='''||p_agencytype||'''';
END IF;

IF(p_adcat IS NOT NULL)
THEN
query1:=query1 || ' and i."Ad_Cat" ='''||p_adcat||'''';
END IF;

IF(p_adsubcat IS NOT NULL)
THEN
query1:=query1 || ' and i."Ad_Sub_Cat" ='''||p_adsubcat||'''';
END IF;

IF(p_adsubcat3 IS NOT NULL)
THEN
query1:=query1 || ' and i."AD_SUBCAT3" ='''||p_adsubcat3||'''';
END IF;

IF(p_adsubcat4 IS NOT NULL)
THEN
query1:=query1 || ' and i."AD_SUBCAT4" ='''||p_adsubcat4||'''';
END IF;

IF(p_adsubcat5 IS NOT NULL)
THEN
query1:=query1 || ' and i."AD_SUBCAT5" ='''||p_adsubcat5||'''';
END IF;

IF(p_package IS NOT NULL)
THEN
query1:=query1 || ' and m."Package_code" ='''||p_package||'''';
END IF;

IF(p_scheme IS NOT NULL)
THEN
query1:=query1 || ' and m."Scheme_type_code" ='''||p_scheme||'''';
END IF;

IF(p_agency IS NOT NULL)
THEN
query1:=query1 || ' and m."Agency_code" ='''||p_agency||'''';
END IF;

IF(p_client IS NOT NULL)
THEN
query1:=query1 || ' and m."Client_code" ='''||p_client||'''';
END IF;

IF(p_executive IS NOT NULL)
THEN
query1:=query1 || ' and m."Executive_code" ='''||p_executive||'''';
END IF;

IF(p_retainer IS NOT NULL)
THEN
query1:=query1 || ' and m.RETAINER ='''||p_retainer||'''';
END IF;

IF(p_product IS NOT NULL)
THEN
query1:=query1 || ' and m."Product_code" ='''||p_product||'''';
END IF;

IF(p_brand IS NOT NULL)
THEN
query1:=query1 || ' and m."Brand_code" ='''||p_brand||'''';
END IF;

IF(p_varient IS NOT NULL)
THEN
query1:=query1 || ' and m."Variant_code" ='''||p_varient||'''';
END IF;

IF(p_pagetype IS NOT NULL)
THEN
query1:=query1 || ' and m."Page_type_code" ='''||p_pagetype||'''';
END IF;

IF(p_pageprem IS NOT NULL)
THEN
query1:=query1 || ' and m."Page_prem" ='''||p_pageprem||'''';
END IF;

IF(p_postprem IS NOT NULL)
THEN
query1:=query1 || ' and m."Page_position_code" ='''||p_postprem||'''';
END IF;

IF(p_rostatus IS NOT NULL)
THEN
query1:=query1 || ' and m."ro_status" ='''||p_rostatus||'''';
END IF;

IF(p_booktype IS NOT NULL)
THEN
query1:=query1 || ' and m."Booking_type" ='''||p_booktype||'''';
END IF;

IF(p_contractname  IS NOT NULL)
THEN
query1:=query1 || ' and m."Contract_name" ='''||p_contractname ||'''';
END IF;

IF(p_suppliment  IS NOT NULL)
THEN
query1:=query1 || ' and i."Supp_Code" ='''||p_suppliment||'''';
END IF;

IF(p_ratetype  IS NOT NULL)
THEN
query1:=query1 || ' and m."Rate_code" ='''||p_ratetype||'''';
END IF;

IF(p_city  IS NOT NULL)
THEN
if(p_base='1')then
query1:=query1 || ' and a."City_Code" ='''||p_city||'''';
end if;

if(p_base='2')then
query1:=query1 || ' and m."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" ='''||p_city||''' )';
end if;

if(p_base='3')then
query1:=query1 || ' and m.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."City_Code"='''||p_city||''')';
end if;
END IF;

IF(p_zone  IS NOT NULL)
THEN
if(p_base='1')then
query1:=query1 || ' and a."zone_code" ='''||p_zone||'''';
end if;

if(p_base='2')then
query1:=query1 || ' and m."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" in (select city_mst."City_Code" from city_mst where city_mst."Zone_Code"= '''||p_zone||''') )';
end if;

if(p_base='3')then
query1:=query1 || ' and m.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Zone_Code"='''||p_zone||''')';
end if;
END IF;

IF(p_district  IS NOT NULL)
THEN
if(p_base='1')then
query1:=query1 || ' and a."Dist_Code" ='''||p_district||'''';
end if;

if(p_base='2')then
query1:=query1 || ' and m."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."dist_code" ='''||p_district||''' )';
end if;

if(p_base='3')then
query1:=query1 || ' and m.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Dist_Code"='''||p_district||''')';
end if;
END IF;

IF(p_state  IS NOT NULL)
THEN
if(p_base='1')then
query1:=query1 || ' and a."State_Code" ='''||p_state||'''';
end if;

if(p_base='2')then
query1:=query1 || ' and m."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."State_code" ='''||p_state||''' )';
end if;

if(p_base='3')then
query1:=query1 || ' and m.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."State_Code"='''||p_state||''')';
end if;
END IF;

IF(p_taluka  IS NOT NULL)
THEN
if(p_base='1')then
query1:=query1 || ' and a.TALUKA='''||p_taluka||'''  ';
end if;

if(p_base='2')then
query1:=query1 || ' and m."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast.TALUKA ='''||p_taluka||''' )';
end if;

if(p_base='3')then
query1:=query1 || ' and m.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER.TALUKA='''||p_taluka||''')';
end if;
END IF;

query1:=query1 || ' order by m."cio_booking_id"';

DELETE FROM searchtbl;
insert into searchtbl values(query1);commit;
--insert into dbgstr(rdate,str,seq) values(sysdate,'OPEN p_recordset1 FOR '||query1,dbg_seq.nextval);commit;
OPEN p_recordset1 FOR
query1;


elsif(p_adcheck=2)then
delete from temp_ad_bills_report where sess_id=userenv('sessionid')  ;
--insert into dbgstr(rdate,str,seq) values(sysdate,'open c2  ',dbg_seq.nextval);commit;
open c2;
loop
fetch c2 into v2;
exit when c2%notfound;
--insert into test_amit(a,b)values('amit-',v2.BILLNO);commit;
--insert into dbgstr(rdate,str,seq) values(sysdate,'before FUN_BILL_INSERT  ',dbg_seq.nextval);commit;
         v_val:=FUN_BILL_INSERT(p_compcode,v2.CIOID,v2.BILLNO,prefer,p_dateformat,v2.AGMAINCODE,v2.AG_SUB_CODE,v2.AGCODE,v2.AGNAME,v2.EXECCODE,v2.EXECNAME,v2.RETCODE,v2.RETNAME,p_base );
--insert into dbgstr(rdate,str,seq) values(sysdate,'after FUN_BILL_INSERT  ',dbg_seq.nextval);commit;         
end loop;
close c2;
commit;
--insert into dbgstr(rdate,str,seq) values(sysdate,'close c2  ',dbg_seq.nextval);commit;
query2:=query2 || 'select CIOID AS "CIOID",BILLNO AS "Billno" ,AGENCY AS "Agency", CLIENT AS "Client" ,
RONO  AS "RoNo.",
CASE '''||p_dateformat||'''
WHEN ''mm/dd/yyyy'' THEN TO_CHAR(RODATE ,''mm/dd/yyyy'')
WHEN ''dd/mm/yyyy'' THEN TO_CHAR(RODATE ,''dd/mm/yyyy'')
WHEN ''yyyy/mm/dd'' THEN TO_CHAR(RODATE,''yyyy/mm/dd'') END AS "Ro.Date",
EXECUTIVE  AS "Executive",RETAINER  AS "Retainer" ,BOOKTYPE as "BookType",COLOR as "Color",ADCAT as "Adcat",
ADSUBCAT as "Adsubcat",ADSUBCAT3 as "Adsubcat3",ADSUBCAT4  as "Adsubcat4",ADSUBCAT5 as "Adsubcat5",PACKAG AS "Package",
to_char(BILLDATE,'''||p_dateformat||''') as "BillDate",
NOINSERT as "noinsert",PAIDINSERT as "Paidinsert" ,HEIGHT as "height",WIDTH as "width",AREA as "Area",PAGEPREMIUM as "Pagepremium",POSTPREM as "Postprem",
SCHEME as "scheme",RATECOD as "Ratecode",CARDRATE as "cardrate",CARDAMT as "cardamt",
CONTRACTRATE as "contractrate",DEVIATIONAMT as "Deviationamt",DEVIATIONPER AS "Deviation(%)",
AGGRATE as "Aggrate",AGGAMT as "aggamt",DISCAMT as "DiscAmt",DISCPER as "Discper",
POSAMT as  "posamt",POSPER as "pos(%)",SPDISCAMT as "Spdiscamt",
SPDISCPER as "Spdiscper",SPACEDISC as "Spacedisc",SPACEDISCPER as "Spacediscper",SPECIALCHARGE as "Specialcharge",AGENCYADDLTDPER  as "AgencyAddlTD(%)",
AGENCYADDLTDAMT as "AgencyAddlTDAmt",GROSSAMT as "Grossamt",
RETTDPER as "RetTD(%)",RETTDAMT as "RetTDAmt",AGENCYTDPER as "AgencyTD(%)",AGENCYTDAMT as "AgencyTDAmt",BILLAMT as "Billamt",
RETCOMMPER as "RetComm(%)",RETCOMMAMT as "RetCommAmt",minus_to_zero(ACTUALBUSINESS) as "ActualBusiness",
REVCENTER as "Revcenter",UOM AS "Uom",UOMDESC as "uomdesc"
,PUB_CENT_NAME as "Printcenter"
,BRANCH_NAME  as "Branch"
,DIST_NAME as "District"
,TALU_NAME as "Taluka"
,PAGE_NO as "Page_No"
from temp_ad_bills_report where sess_id='||userenv('sessionid');

IF(p_fromdate IS NOT NULL AND p_dateto IS NOT NULL )
THEN
query2:=query2||' and BILLDATE between  '''||p_fromdate ||''' and  '''||p_dateto||''' ';
END IF;

IF(p_publication IS NOT NULL)
THEN
query2:=query2||' and PRIPUB='''||p_publication||'''';
END IF;

IF(p_pub_cent IS NOT NULL)
THEN
query2:=query2||'   and PUB_CENT_CODE='''||p_pub_cent||'''';
END IF;

IF(p_edition IS NOT NULL)
THEN
query2:=query2||'  and PEDITION='''||p_edition||'''';
END IF;

IF(p_branch IS NOT NULL)
THEN
query2:=query2||'  and  BRANCH_NAME ='''||p_branch||''' ';
END IF;

IF(p_region IS NOT NULL)
THEN
query2:=query2 ||' and REGION='''||p_region ||'''';
END IF;

IF(p_adtype IS NOT NULL)
THEN
query2:=query2 || ' and PADTYPE='''||p_adtype||'''';
END IF;

IF(p_agencytype IS NOT NULL)
THEN
query2:=query2 || ' and AGENCY_TYPE_CODE= '''||p_agencytype||'''';
END IF;

IF(p_adcat IS NOT NULL)
THEN
query2:=query2 || ' and PRIADCTG='''||p_adcat||'''';
END IF;

IF(p_adsubcat IS NOT NULL)
THEN
query2:=query2 || ' and SECADCTG ='''||p_adsubcat||'''';
END IF;

IF(p_adsubcat3 IS NOT NULL)
THEN
query2:=query2 || ' and AD_SUBCAT3 ='''||p_adsubcat3||'''';
END IF;

IF(p_adsubcat4 IS NOT NULL)
THEN
query2:=query2 || ' and AD_SUBCAT4 ='''||p_adsubcat4||'''';
END IF;

IF(p_adsubcat5 IS NOT NULL)
THEN
query2:=query2 || ' and AD_SUBCAT5 ='''||p_adsubcat5||'''';
END IF;

IF(p_package IS NOT NULL)
THEN
query2:=query2 || ' and PACKAGE_CODE='''||p_package||'''';
END IF;

IF(p_agency IS NOT NULL)
THEN
query2:=query2 || ' and AG_MAIN_CODE ='''||p_agency ||'''';
END IF;

IF(p_client IS NOT NULL)
THEN
query2:=query2 || ' and CLIENTCD='''||p_client ||'''';
END IF;

IF(p_executive IS NOT NULL)
THEN
query2:=query2 || ' and EXECUTIVE_NAME='''||p_executive||'''';
END IF;

IF(p_product IS NOT NULL)
THEN
query2:=query2 || ' and PRIPROCTG='''||p_product||'''';
END IF;

IF(p_brand IS NOT NULL)
THEN
query2:=query2 || ' and BRAND_CODE='''||p_brand||'''';
END IF;

IF(p_varient IS NOT NULL)
THEN
query2:=query2 || ' and   VARIENT_NAME='''||p_varient||'''';
END IF;

IF(p_pageprem IS NOT NULL)
THEN
query2:=query2 || ' and PAGE_PREM ='''||p_pageprem||'''';
END IF;

IF(p_postprem IS NOT NULL)
THEN
query2:=query2 || ' and PAGE_POST ='''||p_postprem||'''';
END IF;

IF(p_contractname  IS NOT NULL)
THEN
query2:=query2 || ' and CONTRACT_NAME ='''||p_contractname ||'''';
END IF;

IF(p_suppliment  IS NOT NULL)
THEN
query2:=query2 || ' and SUPP_CODE='''||p_suppliment||'''';
END IF;

IF(p_retainer IS NOT NULL)
THEN
query2:=query2 || ' and RETAINER_CODE='''||p_retainer||'''';
END IF;

IF(p_ratetype  IS NOT NULL)
THEN
query2:=query2 || ' and RATECD ='''||p_ratetype||'''';
END IF;

IF(p_scheme IS NOT NULL)
THEN
query2:=query2 || ' and PSCHEME='''||p_scheme||'''';
END IF;

IF(p_revcenter IS NOT NULL)
THEN
query2:=query2 ||' and REVENUE_CENTER='''||p_revcenter||'''';
END IF;

IF(p_rostatus IS NOT NULL)
THEN
query2:=query2 || ' and RO_STATUS='''||p_rostatus||'''';
END IF;

IF(p_pagetype IS NOT NULL)
THEN
query2:=query2 || ' and PAGE_TYPE ='''||p_pagetype||'''';
END IF;

IF(p_booktype IS NOT NULL)
THEN
query2:=query2 || ' and BOOKING_TYPE='''||p_booktype||'''';
END IF;

IF(p_city  IS NOT NULL)
THEN
query2:=query2 || ' and CITY_CODE ='''||p_city||'''';
END IF;

IF(p_zone  IS NOT NULL)
THEN
query2:=query2 || ' and ZONE_CODE ='''||p_zone||'''';
end if;

IF(p_district  IS NOT NULL)
THEN
query2:=query2 || ' and DIST_CODE ='''||p_district||'''';
end if;

IF(p_state  IS NOT NULL)
THEN
query2:=query2 || ' and STATE_CODE ='''||p_state||'''';
end if;

IF(p_taluka  IS NOT NULL)
THEN
query2:=query2 || ' and PTALUKA='''||p_taluka||'''  ';
end if;


if(p_base='2')then
query2:=query2 ||' and (EXECUTIVE_NAME   is not null and EXECUTIVE_NAME !=''0'')  ';
end if;

if(p_base='3')then
query2:=query2 ||' and (RETAINER_CODE  is not null  and RETAINER_CODE  !=''0'')  ';
end if;



query2:=query2 || ' order by CIOID';

delete from searchtbl;
insert into searchtbl values(query2);commit;
--insert into dbgstr(rdate,str,seq) values(sysdate,'OPEN p_recordset1 FOR   '||query2,dbg_seq.nextval);commit;
OPEN p_recordset1 FOR
query2;

elsif(p_adcheck=3) then
query3:=query3 ||'SELECT m."cio_booking_id" AS "CIOID",
to_char(m."date_time",'''||p_dateformat||''') as "BookDate",
a."Agency_Name" AS "Agency",
NVL((SELECT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code"=m."Client_code"),m."Client_code")  AS "Client",
m."RO_No" AS "RoNo.",
CASE '''||p_dateformat||'''
WHEN ''mm/dd/yyyy'' THEN TO_CHAR(m."RO_Date",''mm/dd/yyyy'')
WHEN ''dd/mm/yyyy'' THEN TO_CHAR(m."RO_Date" ,''dd/mm/yyyy'')
WHEN ''yyyy/mm/dd'' THEN TO_CHAR(m."RO_Date",''yyyy/mm/dd'') END AS "Ro.Date",
(select EXEC_MAST."Exec_name" from exec_mast where m."Executive_code"=to_char(exec_mast."Exe_no")) AS "Executive",
(select RETAINERMASTER."Retain_Name"  FROM  RETAINERMASTER where RETAINERMASTER."Retain_Code"=m.RETAINER ) AS "Retainer",
decode(m."Booking_type",''1'',''Barter'',''2'',''FMG'',''3'',''Normal'',''4'',''InHouse'',''5'',''Complimentary'',''Normal'') as "BookType",
(select col_mast."Col_Alias" from col_mast where i."Col_Code" =col_mast."Col_Code") as "Color",
adv_cat_mast."Adv_Cat_Name" as "Adcat",
(select adv_subcat_mast."Adv_Subcat_Name" from adv_subcat_mast where i."Ad_Sub_Cat"=adv_subcat_mast."Adv_Subcat_Code" and  adv_cat_mast."Adv_Cat_Code"=adv_subcat_mast."Adv_Cat_Code")as "Adsubcat",
(select ad_cat3."catname" from ad_cat3,adv_subcat_mast  where m."Ad_Subcat3"=ad_cat3."catcode" and ad_cat3."subcatname"=adv_subcat_mast."Adv_Subcat_Code" and i."Ad_Sub_Cat"=adv_subcat_mast."Adv_Subcat_Code" and  adv_cat_mast."Adv_Cat_Code"=adv_subcat_mast."Adv_Cat_Code") as "Adsubcat3",
(select tbl_cat4."Cat_Name" from tbl_cat4,adv_subcat_mast where i."AD_SUBCAT4"=tbl_cat4."Cat_Code" and tbl_cat4."Sub_Cat_Name"=adv_subcat_mast."Adv_Subcat_Code" and i."Ad_Sub_Cat"=adv_subcat_mast."Adv_Subcat_Code" and  adv_cat_mast."Adv_Cat_Code"=adv_subcat_mast."Adv_Cat_Code") as "Adsubcat4",
(select tbl_cat5."Cat_Name" from tbl_cat5,adv_subcat_mast where i."AD_SUBCAT5"=tbl_cat5."Cat_Code" and tbl_cat5."Sub_Cat_Name"=adv_subcat_mast."Adv_Subcat_Code" and i."Ad_Sub_Cat"=adv_subcat_mast."Adv_Subcat_Code" and  adv_cat_mast."Adv_Cat_Code"=adv_subcat_mast."Adv_Cat_Code") as "Adsubcat5",
-- FETCH_PACK(m."cio_booking_id") AS "Package",
FETCH_PACK_new(m."cio_booking_id", m."Package_code" ) AS "Package",
to_char(i."Insert_Date" ,'''||p_dateformat||''') as "PubDate",
 i."Height" as "height",
 i."Width"  as "width",
i."Size_Book" as "Area",
(select ADVPOS_PREM_MAST."premiumname" from advpos_prem_mast where i."Premium1" =ADVPOS_PREM_MAST."Premiumcode") as "Pagepremium",
(select advpos_type_mast."Pos_Type" from advpos_type_mast where i."Page_Post" =advpos_type_mast."Pos_Type_Code") as "Postprem",
(select scheme_master."Scheme_Name" from scheme_master where m."Scheme_type_code"=scheme_master."scheme_id") as "scheme",
m."Rate_code" as "Ratecode",
m."Card_rate" as "cardrate",
m."Card_rate"*i."Size_Book" as "cardamt",
m."Contract_rate" as "contractrate",
m."Deviation" as "Deviationamt",
m."Deviation" AS "Deviation(%)",
m."Agrred_rate" as "Aggrate",
i."Agreed_Rate"  as "aggamt",
((m."Card_rate"*i."Size_Book") - DECODE(NVL(i."Agreed_Rate",0),0,(m."Card_rate"*i."Size_Book"),i."Agreed_Rate")) as "DiscAmt",
m."Discount_per" as "Discper",
(select SUM(nvl(RAT,0)) from multipack_rat where cioid=m."cio_booking_id"  and sess_id='||userenv('sessionid')||') as  "posamt",
(select SUM(nvl(PER_AMT,0)) from multipack_rat where cioid=m."cio_booking_id"   and sess_id='||userenv('sessionid')||') as "pos(%)",
round(((m."Special_disc_per" * i."Size_Book" * m."Card_rate")/100),2) as "Spdiscamt",
m."Special_disc_per" as "Spdiscper",
round(((m."Space_disc_per" * i."Size_Book" * m."Card_rate")/100),2) as "Spacedisc",
m."Space_disc_per" as "Spacediscper",
m."Special_charges" as "Specialcharge",
nvl(m."ADD_AGENCY_COMM",''0'') as "AgencyAddlTD(%)",
nvl((nvl(i."Gross_Rate" ,''0'')*nvl(m."ADD_AGENCY_COMM",''0'')/100),''0'') as "AgencyAddlTDAmt",
nvl(i."Gross_Rate",''0'') as "Grossamt",
(select DISTINCT TO_NUMBER(NVL("Comm_Rate",''0''))    from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(m."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(m."RETAINER",''0'')) AND ROWNUM<=1 ) as "RetTD(%)",
nvl(i."Gross_Rate",''0'')*(select DISTINCT TO_NUMBER(NVL("Comm_Rate",''0''))    from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(m."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(m."RETAINER",''0'')) AND ROWNUM<=1 )/100 as "RetTDAmt",
nvl(m."Trade_disc",''0'' )as "AgencyTD(%)",
(nvl(i."Gross_Rate",''0'')* nvl(m."Trade_disc",''0'' )/100 )as "AgencyTDAmt",
NVL(i."Bill_Amt",''0'') as "Billamt",
nvl(case( '''||prefer||''' )
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(m."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(m."RETAINER",''0'')) AND ROWNUM<=1)
         when ''Gross'' then

               (
                 CASE to_number(nvl(m.RETAINER_COMM,0))
                 WHEN 0 THEN 0
                 ELSE (to_number(nvl(m.RETAINER_COMM,''0''))-to_number(nvl(m."ADD_AGENCY_COMM",''0'') ))
                end  )


         when ''Net''   then  to_number(nvl(m.RETAINER_COMM,''0''))
        END )

    ELSE (select 0  from dual)
end  ,''0'') as "RetComm(%)",

nvl(
case( '''||prefer||''' )
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(m."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(m."RETAINER",''0'')) AND ROWNUM<=1)
         when ''Gross'' then



                (
                 CASE to_number(nvl(m.RETAINER_COMM_AMT,0))
                 WHEN 0 THEN 0
                 ELSE (to_number(nvl(m.RETAINER_COMM_AMT,''0''))-(nvl((nvl(i."Gross_Rate",''0'')*to_number(nvl(m."ADD_AGENCY_COMM",''0''))/100),''0'')))
                 end )


         when ''Net''   then  (nvl(i."Gross_Rate",''0'')*(to_number(nvl(m.RETAINER_COMM,''0'')) )/100)
        END )

    ELSE (select 0  from dual)
end
,''0'') as "RetCommAmt",


minus_to_zero(nvl((  NVL(i."Bill_Amt",''0'')-
nvl(
case( '''||prefer||''' )
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(m."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(m."RETAINER",''0'')) AND ROWNUM<=1)
         when ''Gross'' then
           (
                 CASE to_number(nvl(m.RETAINER_COMM_AMT,0))
                 WHEN 0 THEN 0
                 ELSE (to_number(nvl(m.RETAINER_COMM_AMT,''0''))-(nvl((nvl(i."Gross_Rate",''0'')*to_number(nvl(m."ADD_AGENCY_COMM",''0''))/100),''0'')))
                 end )

         when ''Net''   then  (nvl(i."Gross_Rate",''0'')*(to_number(nvl(m.RETAINER_COMM,''0'')) )/100)
        END )



    ELSE (select 0  from dual)
end
,''0'') ),''0'')) as "ActualBusiness",
(SELECT BRANCH_MST."Branch_Name" FROM BRANCH_MST WHERE m."Revenue_center"=BRANCH_MST."Branch_Code" )as "Revcenter"
,UOM_MAST."Uom_Name"  AS "Uom",
pub_mast."Pub_Name" as "Publication",
i."Edition" as "Edition",
uom_mast.UOM_DESC as "uomdesc"
,(select pub_cent_mast."Pub_Cent_name" from pub_cent_mast where pub_cent_mast."Pub_cent_Code" in(select "pub_center" from  BRANCH_MST WHERE m."branch"="Branch_Code") ) as "Printcenter"
,(SELECT "Branch_Name" FROM BRANCH_MST where  m."branch" = "Branch_Code") as "Branch"

,case '''||p_base||'''
when ''1'' then  a."Dist_Code"
when ''2'' then (select dist_mst."Dist_Name" from dist_mst where dist_mst."Dist_Code" in(select exec_mast."dist_code" from exec_mast where  to_char(exec_mast."Exe_no")=m."Executive_code" )  )
when ''3'' then (select dist_mst."Dist_Name" from dist_mst where dist_mst."Dist_Code" in(select RETAINERMASTER."Dist_Code" from RETAINERMASTER where  RETAINERMASTER."Retain_Code"= m.RETAINER )  ) end as "District"
,case '''||p_base||'''
when ''1'' then (select taluka_mast.TALU_NAME  from taluka_mast where a.TALUKA=taluka_mast.TALU_CODE )
when ''2'' then (select taluka_mast.TALU_NAME  from taluka_mast where taluka_mast.TALU_CODE in(select exec_mast.TALUKA from exec_mast where  to_char(exec_mast."Exe_no")=m."Executive_code" )  )
when ''3'' then (select taluka_mast.TALU_NAME  from taluka_mast where taluka_mast.TALU_CODE in(select RETAINERMASTER.TALUKA from RETAINERMASTER where  RETAINERMASTER."Retain_Code"= m.RETAINER )  ) end as "Taluka"
,i."Page_No" as "Page_No"
,m.CASHDISCOUNT as "Cash_Disc",i."Insert_Status" as "Status"
,m."Box_code" as "BoxCode",m."Userid" as USERID,(SELECT max("username") from login where com_code = m."Comp_code" and "userid"=m."Userid") as USERNAME
FROM TBL_BOOKING_MAST m,AGENCY_MAST a ,uom_mast,
adv_cat_mast,
adv_type_mast,pub_mast,
TBL_BOOKING_insert i
WHERE m."Comp_code"='''||p_compcode||''' AND
m."cio_booking_id"=i."Cio_Booking_Id" and
UOM_MAST."Uom_Code"=m."Uom_code" and
m."Agency_sub_code"=a."code_subcode" AND
i."Ad_Cat" =adv_cat_mast."Adv_Cat_Code" and
m."Ad_type_code"=adv_type_mast."Adv_Type_Code"
and adv_type_mast."Adv_Type_Code"=adv_cat_mast."Adv_Type" and
pub_mast."Pub_Code"=i."Publication_Code" and
((i."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id='''||p_puserid||''') and '''||p_chk_access||'''=''1'')
or  ('''||p_chk_access||'''=''0'') )' ;

if(p_base='2')then
query3:=query3 ||' and (m."Executive_code" is not null and m."Executive_code" !=''0'')  ';
end if;

if(p_base='3')then
query3:=query3 ||' and (m.RETAINER is not null  and m.RETAINER !=''0'')  ';
end if;


if(p_drpstatus is null) then
query3:=query3||' and lower(i."Insert_Status")!='''||'cancel'||'''';
end if;


if(p_insertstatus is not null) then
query3:=query3||' and lower(i."Insert_Status")='''||p_insertstatus||'''';
end if;


IF(p_fromdate IS NOT NULL AND p_dateto IS NULL )
THEN
query3:=query3 ||' and i."Insert_Date" ='''||p_fromdate||'''';
END IF;

IF(p_fromdate IS NOT NULL AND p_dateto IS NOT NULL)
THEN
query3:=query3 ||' and i."Insert_Date" between  '''||p_fromdate ||''' and  '''||p_dateto||''' ';
END IF;

IF(p_publication IS NOT NULL)
THEN
query3:=query3 ||' and i."Publication_Code"='''||p_publication||'''    ';
END IF;

IF(p_pub_cent IS NOT NULL)
THEN
query3:=query3||'  and m."branch" IN (SELECT "Branch_Code" FROM BRANCH_MST WHERE m."branch"="Branch_Code" and "pub_center"='''||p_pub_cent||''')';
END IF;

IF(p_branch IS NOT NULL)
THEN
query3:=query3 ||'  and m."branch" ='''||p_branch||'''';
END IF;

IF(p_edition IS NOT NULL)
THEN
query3:=query3 ||'  and i."Edition_Code"='''||p_edition||'''';
END IF;
IF(p_region IS NOT NULL)
THEN
query3:=query3  ||' and a."region" ='''||p_region||'''';
END IF;

IF(p_revcenter IS NOT NULL)
THEN
query3:=query3  ||' and m."Revenue_center" ='''||p_revcenter||'''';
END IF;

IF(p_adtype IS NOT NULL)
THEN
query3:=query3  || ' and m."Ad_type_code"='''||p_adtype||'''';
END IF;

IF(p_agencytype IS NOT NULL)
THEN
query3:=query3  || ' and m."Agency_type" ='''||p_agencytype||'''';
END IF;

IF(p_adcat IS NOT NULL)
THEN
query3:=query3  || ' and i."Ad_Cat" ='''||p_adcat||'''';
END IF;

IF(p_adsubcat IS NOT NULL)
THEN
query3:=query3  || ' and i."Ad_Sub_Cat" ='''||p_adsubcat||'''';
END IF;

IF(p_adsubcat3 IS NOT NULL)
THEN
query3:=query3  || ' and i."AD_SUBCAT3" ='''||p_adsubcat3||'''';
END IF;

IF(p_adsubcat4 IS NOT NULL)
THEN
query3:=query3  || ' and i."AD_SUBCAT4" ='''||p_adsubcat4||'''';
END IF;

IF(p_adsubcat5 IS NOT NULL)
THEN
query3:=query3  || ' and i."AD_SUBCAT5" ='''||p_adsubcat5||'''';
END IF;

IF(p_package IS NOT NULL)
THEN
query3:=query3  || ' and m."Package_code" ='''||p_package||'''';
END IF;

IF(p_scheme IS NOT NULL)
THEN
query3:=query3  || ' and m."Scheme_type_code" ='''||p_scheme||'''';
END IF;

IF(p_agency IS NOT NULL)
THEN
query3:=query3  || ' and a."Agency_Code" ='''||p_agency||'''';
END IF;

IF(p_client IS NOT NULL)
THEN
query3:=query3  || ' and m."Client_code" ='''||p_client||'''';
END IF;

IF(p_executive IS NOT NULL)
THEN
query3:=query3  || ' and m."Executive_code" ='''||p_executive||'''';
END IF;

IF(p_retainer IS NOT NULL)
THEN
query3:=query3  || ' and m.RETAINER ='''||p_retainer||'''';
END IF;

IF(p_product IS NOT NULL)
THEN
query3:=query3 || ' and m."Product_code" ='''||p_product||'''';
END IF;

IF(p_brand IS NOT NULL)
THEN
query3:=query3  || ' and m."Brand_code" ='''||p_brand||'''';
END IF;

IF(p_varient IS NOT NULL)
THEN
query3:=query3  || ' and m."Variant_code" ='''||p_varient||'''';
END IF;

IF(p_pagetype IS NOT NULL)
THEN
query3:=query3  || ' and m."Page_type_code" ='''||p_pagetype||'''';
END IF;

IF(p_pageprem IS NOT NULL)
THEN
query3:=query3 || ' and i."Premium1" ='''||p_pageprem||'''';
END IF;

IF(p_postprem IS NOT NULL)
THEN
query3:=query3 || ' and i."Page_Post" ='''||p_postprem||'''';
END IF;

IF(p_rostatus IS NOT NULL)
THEN
query3:=query3 || ' and m."ro_status" ='''||p_rostatus||'''';
END IF;

IF(p_booktype IS NOT NULL)
THEN
query3:=query3 || ' and m."Booking_type" ='''||p_booktype||'''';
END IF;

IF(p_contractname  IS NOT NULL)
THEN
query3:=query3 || ' and m."Contract_name" ='''||p_contractname ||'''';
END IF;

IF(p_suppliment  IS NOT NULL)
THEN
query3:=query3 || ' and i."Supp_Code" ='''||p_suppliment||'''';
END IF;

IF(p_ratetype  IS NOT NULL)
THEN
query3:=query3 || ' and m."Rate_code" ='''||p_ratetype||'''';
END IF;

IF(p_city  IS NOT NULL)
THEN
if(p_base='1')then
query3:=query3 || ' and a."City_Code" ='''||p_city||'''';
end if;

if(p_base='2')then
query3:=query3 || ' and m."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" ='''||p_city||''' )';
end if;

if(p_base='3')then
query3:=query3 || ' and m.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."City_Code"='''||p_city||''')';
end if;
END IF;

IF(p_zone  IS NOT NULL)
THEN
if(p_base='1')then
query3:=query3 || ' and a."zone_code" ='''||p_zone||'''';
end if;

if(p_base='2')then
query3:=query3 || ' and m."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" in (select city_mst."City_Code" from city_mst where city_mst."Zone_Code"= '''||p_zone||''') )';
end if;

if(p_base='3')then
query3:=query3 || ' and m.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Zone_Code"='''||p_zone||''')';
end if;
END IF;

IF(p_district  IS NOT NULL)
THEN
if(p_base='1')then
query3:=query3 || ' and a."Dist_Code" ='''||p_district||'''';
end if;

if(p_base='2')then
query3:=query3 || ' and m."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."dist_code" ='''||p_district||''' )';
end if;

if(p_base='3')then
query3:=query3 || ' and m.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Dist_Code"='''||p_district||''')';
end if;
END IF;

IF(p_state  IS NOT NULL)
THEN
if(p_base='1')then
query3:=query3 || ' and a."State_Code" ='''||p_state||'''';
end if;

if(p_base='2')then
query3:=query3 || ' and m."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."State_code" ='''||p_state||''' )';
end if;

if(p_base='3')then
query3:=query3 || ' and m.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."State_Code"='''||p_state||''')';
end if;
END IF;

IF(p_taluka  IS NOT NULL)
THEN
if(p_base='1')then
query3:=query3 || ' and a.TALUKA='''||p_taluka||'''  ';
end if;

if(p_base='2')then
query3:=query3 || ' and m."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast.TALUKA ='''||p_taluka||''' )';
end if;

if(p_base='3')then
query3:=query3 || ' and m.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER.TALUKA='''||p_taluka||''')';
end if;
END IF;

query3:=query3 || ' order by i."Insert_Date" ,m."cio_booking_id"';

insert into searchtbl values(query3);commit;
--insert into dbgstr(rdate,str,seq) values(sysdate,'OPEN p_recordset1 FOR   '||query3,dbg_seq.nextval);commit;
OPEN p_recordset1 FOR
query3;

end if;

else

if(p_adcheck=1)
then


query1:=query1||'SELECT
to_char(a."date_time",''dd/mm/yyyy'') as "Date",
sum(a."No_of_insertion") as "noinsert",
sum(a."Paid_ins") as "Paidinsert",sum(a."Total_area") as "Area",
sum(a."Card_amount") as "cardamt",
sum(a."Deviation") as "Deviationamt",
round(((nvl(sum(a."Deviation"),0)*100)/sum(a."Card_amount")),2) AS "Deviation(%)",
sum(a."Agreed_amount") as "aggamt",
(sum(a."Card_amount")- DECODE(NVL(sum(a."Agreed_amount"),0),0,sum(a."Card_amount"),sum(a."Agreed_amount"))) as "DiscAmt",
round((((sum(a."Card_amount")- DECODE(NVL(sum(a."Agreed_amount"),0),0,sum(a."Card_amount"),sum(a."Agreed_amount"))) *100)/sum(a."Card_amount")),2)  as "Discper",
sum((select SUM(nvl(RAT,0)) from multipack_rat where cioid=a."cio_booking_id"  and sess_id='||userenv('sessionid')||')) as  "posamt",
round(((sum((select SUM(nvl(RAT,0)) from multipack_rat where cioid=a."cio_booking_id"  and sess_id='||userenv('sessionid')||'))*100)/sum(a."Card_amount")),2)   as "pos(%)",
sum(a."Special_disc_per" * a."Total_area" * a."Card_rate"/100) as "Spdiscamt",
round(((sum(a."Special_disc_per" * a."Total_area" * a."Card_rate"/100)*100)/sum(a."Card_amount")),2)  as "Spdiscper",
sum(a."Space_disc_per" * a."Total_area" * a."Card_rate"/100) as "Spacedisc",
round(((sum(a."Space_disc_per" * a."Total_area" * a."Card_rate"/100) *100)/sum(a."Card_amount")),2) as "Spacediscper",
sum(a."Special_charges") as "Specialcharge",
round(((sum(nvl((nvl(a."Gross_amount",''0'')*nvl(a."ADD_AGENCY_COMM",''0'')/100),''0''))*100)/(sum(a."Card_amount")+sum((select SUM(nvl(RAT,0)) from multipack_rat where cioid=a."cio_booking_id" and sess_id='||userenv('sessionid')||'))+sum(a."Special_charges")-sum(a."Deviation")-(sum(a."Card_amount")- DECODE(NVL(sum(a."Agreed_amount"),0),0,sum(a."Card_amount"),sum(a."Agreed_amount"))) -sum(a."Space_disc_per" * a."Total_area" * a."Card_rate"/100)-sum(a."Special_disc_per" * a."Total_area" * a."Card_rate"/100))),2) as "AgencyAddlTD(%)",
sum(nvl((nvl(a."Gross_amount",''0'')*nvl(a."ADD_AGENCY_COMM",''0'')/100),''0'')) as "AgencyAddlTDAmt",
sum(nvl(a."Gross_amount",''0'')) as "Grossamt",
round(((sum(nvl(nvl(a."Gross_amount",''0'')*(select DISTINCT TO_NUMBER(NVL("Comm_Rate",''0''))    from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'')) AND ROWNUM<=1 )/100,''0''))*100)/sum(nvl(a."Gross_amount",''0''))),2) as "RetTD(%)",
sum(nvl(nvl(a."Gross_amount",''0'')*(select DISTINCT TO_NUMBER(NVL("Comm_Rate",''0''))    from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'')) AND ROWNUM<=1 )/100,''0''))as "RetTDAmt",
round(((sum((nvl(a."Gross_amount",''0'')* nvl(a."Trade_disc",''0'' )/100) )*100)/(sum(a."Card_amount")+sum((select SUM(nvl(RAT,0)) from multipack_rat where cioid=a."cio_booking_id"  and sess_id='||userenv('sessionid')||'))+sum(a."Special_charges")-sum(a."Deviation")-(sum(a."Card_amount")- DECODE(NVL(sum(a."Agreed_amount"),0),0,sum(a."Card_amount"),sum(a."Agreed_amount"))) -sum(a."Space_disc_per" * a."Total_area" * a."Card_rate"/100)-sum(a."Special_disc_per" * a."Total_area" * a."Card_rate"/100))),2)as "AgencyTD(%)",
sum((nvl(a."Gross_amount",''0'')* nvl(a."Trade_disc",''0'' )/100) )as "AgencyTDAmt",
sum(nvl(a."Bill_amount",''0'')) as "Billamt",
round(((sum(nvl(
case( '''||prefer||''' )
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'')) AND ROWNUM<=1)
       when ''Gross'' then

         (
                 CASE to_number(nvl(a.RETAINER_COMM,0))
                 WHEN 0 THEN 0
                 ELSE (to_number(nvl(a.RETAINER_COMM,''0''))-to_number(nvl(a."ADD_AGENCY_COMM",''0'') ))
                 end )


         when ''Net''   then  to_number(nvl(a.RETAINER_COMM,''0''))
          END )



    ELSE (select 0  from dual)
end
,''0''))*100)/sum(nvl(a."Gross_amount",''0''))),2) as "RetComm(%)",
sum(nvl(
case( '''||prefer||''' )
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'')) AND ROWNUM<=1)
       when ''Gross'' then


                 (
                 CASE to_number(nvl(a.RETAINER_COMM_AMT,0))
                 WHEN 0 THEN 0
                 ELSE (to_number(nvl(a.RETAINER_COMM_AMT,''0''))-(nvl((nvl(a."Gross_amount",''0'')*to_number(nvl(a."ADD_AGENCY_COMM",''0''))/100),''0'')))
                 end )

         when ''Net''   then  (nvl(a."Gross_amount",''0'')*(to_number(nvl(a.RETAINER_COMM,''0'')) )/100)
            END )




    ELSE (select 0  from dual)
end
,''0'')) as "RetCommAmt",

minus_to_zero(sum(nvl((a."Bill_amount"-nvl(
case( '''||prefer||''' )
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'')) AND ROWNUM<=1)
       when ''Gross'' then
       (
                 CASE to_number(nvl(a.RETAINER_COMM_AMT,0))
                 WHEN 0 THEN 0
                 ELSE (to_number(nvl(a.RETAINER_COMM_AMT,''0''))-(nvl((nvl(a."Gross_amount",''0'')*to_number(nvl(a."ADD_AGENCY_COMM",''0''))/100),''0'')))
                 end )


         when ''Net''   then  (nvl(a."Gross_amount",''0'')*(to_number(nvl(a.RETAINER_COMM,''0'')) )/100)
           END )

    ELSE (select 0  from dual)
end
,''0'')  ),''0'') ))as "ActualBusiness"

FROM TBL_BOOKING_MAST a,
agency_mast
WHERE a."Comp_code"='''||p_compcode||''' AND
a."Agency_sub_code"=AGENCY_MAST."code_subcode"' ;


if(p_chk_access='1')then
query1:=query1||' and a."cio_booking_id"  in (select distinct b."Cio_Booking_Id" from tbl_booking_insert b where a."cio_booking_id"=b."Cio_Booking_Id" and b."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id='''||p_puserid||''')) ';
end if;

if(p_base='2')then
query1:=query1||' and (a."Executive_code" is not null and a."Executive_code" !=''0'')  ';
end if;

if(p_base='3')then
query1:=query1||' and (a.RETAINER is not null  and a.RETAINER !=''0'')  ';
end if;


if(p_drpstatus is null) then
query1:=query1||' and a."cio_booking_id"  in (select distinct b."Cio_Booking_Id" from tbl_booking_insert b where a."cio_booking_id"=b."Cio_Booking_Id" AND lower("Insert_Status")!='''||'cancel'||''' )';
end if;

if(p_insertstatus is not null) then
query1:=query1||' and a."cio_booking_id"  in (select distinct b."Cio_Booking_Id" from tbl_booking_insert b where a."cio_booking_id"=b."Cio_Booking_Id" AND lower("Insert_Status")='''||p_insertstatus||''' )';
end if;


IF(p_fromdate IS NOT NULL AND p_dateto IS NULL  and  p_filterby='Booking Date')
THEN
query1:=query1||' and a."date_time" ='''||p_fromdate||'''';
END IF;

IF(p_fromdate IS NOT NULL AND p_dateto IS NOT NULL and p_filterby='Booking Date' )
THEN
query1:=query1||' and a."date_time" between  '''||p_fromdate ||''' and  '''||p_dateto||''' ';
END IF;

IF(p_fromdate IS NOT NULL AND p_dateto IS NULL  and  p_filterby='Publish Date')
THEN
query1:=query1||' and a."Insertion_date" ='''||p_fromdate||'''';
END IF;

IF(p_fromdate IS NOT NULL AND p_dateto IS NOT NULL and p_filterby='Publish Date' )
THEN
query1:=query1||' and a."Insertion_date"  between  '''||p_fromdate ||''' and  '''||p_dateto||''' ';
END IF;

IF(p_publication IS NOT NULL)
THEN
query1:=query1||'  and a."cio_booking_id"  in (select distinct b."Cio_Booking_Id" from tbl_booking_insert b where b."Publication_Code"='''||p_publication||''' )    ';
END IF;

--old version
IF(p_pub_cent IS NOT NULL)
THEN
query1:=query1||'  and a."branch" IN (SELECT "Branch_Name" FROM BRANCH_MST WHERE a."branch"="Branch_Name" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"='''||p_pub_cent||'''))';
END IF;


IF(p_branch IS NOT NULL)
THEN
query1:=query1||' and a."branch" ='''||p_branch||'''';
END IF;


--new version
/*
IF(p_pub_cent IS NOT NULL)
THEN
query1:=query1||'  and a."branch" IN (SELECT "Branch_Code" FROM BRANCH_MST WHERE a."branch"="Branch_Code" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"='''||p_pub_cent||'''))';
END IF;


IF(p_branch IS NOT NULL)
THEN
query1:=query1||'  and a."branch" = (SELECT "Branch_Code" FROM BRANCH_MST where "Branch_Name" ='''||p_branch||''') ';
END IF;
*/

IF(p_edition IS NOT NULL)
THEN
query1:=query1||' and a."cio_booking_id"  in (select distinct b."Cio_Booking_Id" from tbl_booking_insert b where b."Edition_Code"='''||p_edition||''' )';
END IF;

IF(p_region IS NOT NULL)
THEN
query1:=query1 ||'  and agency_mast."region" ='''||p_region||'''';
END IF;

IF(p_suppliment  IS NOT NULL)
THEN
query1:=query1 || '  and a."cio_booking_id"  in (select distinct b."Cio_Booking_Id" from tbl_booking_insert b where b."Supp_Code" ='''||p_suppliment||''' )';
END IF;

IF(p_revcenter IS NOT NULL)
THEN
query1:=query1 ||' and a."Revenue_center" ='''||p_revcenter||'''';
END IF;

IF(p_adtype IS NOT NULL)
THEN
query1:=query1 || ' and a."Ad_type_code"='''||p_adtype||'''';
END IF;

IF(p_agencytype IS NOT NULL)
THEN
query1:=query1 || ' and a."Agency_type" ='''||p_agencytype||'''';
END IF;

IF(p_adcat IS NOT NULL)
THEN
query1:=query1 || ' and a."Ad_cat_code" ='''||p_adcat||'''';
END IF;

IF(p_adsubcat IS NOT NULL)
THEN
query1:=query1 || ' and a."Ad_sub_cat_code" ='''||p_adsubcat||'''';
END IF;

IF(p_adsubcat3 IS NOT NULL)
THEN
query1:=query1 || ' and a."Ad_Subcat3" ='''||p_adsubcat3||'''';
END IF;

IF(p_adsubcat4 IS NOT NULL)
THEN
query1:=query1 || ' and a."Ad_Subcat4" ='''||p_adsubcat4||'''';
END IF;

IF(p_adsubcat5 IS NOT NULL)
THEN
query1:=query1 || ' and a."Ad_subcat5" ='''||p_adsubcat5||'''';
END IF;

IF(p_package IS NOT NULL)
THEN
query1:=query1 || ' and a."Package_code" ='''||p_package||'''';
END IF;

IF(p_scheme IS NOT NULL)
THEN
query1:=query1 || ' and a."Scheme_type_code" ='''||p_scheme||'''';
END IF;

IF(p_agency IS NOT NULL)
THEN
query1:=query1 || ' and a."Agency_code" ='''||p_agency||'''';
END IF;

IF(p_client IS NOT NULL)
THEN
query1:=query1 || ' and a."Client_code" ='''||p_client||'''';
END IF;

IF(p_executive IS NOT NULL)
THEN
query1:=query1 || ' and a."Executive_code" ='''||p_executive||'''';
END IF;

IF(p_retainer IS NOT NULL)
THEN
query1:=query1 || ' and a.RETAINER ='''||p_retainer||'''';
END IF;

IF(p_product IS NOT NULL)
THEN
query1:=query1 || ' and a."Product_code" ='''||p_product||'''';
END IF;

IF(p_brand IS NOT NULL)
THEN
query1:=query1 || ' and a."Brand_code" ='''||p_brand||'''';
END IF;

IF(p_varient IS NOT NULL)
THEN
query1:=query1 || ' and a."Variant_code" ='''||p_varient||'''';
END IF;

IF(p_pagetype IS NOT NULL)
THEN
query1:=query1 || ' and a."Page_type_code" ='''||p_pagetype||'''';
END IF;

IF(p_pageprem IS NOT NULL)
THEN
query1:=query1 || ' and a."Page_prem" ='''||p_pageprem||'''';
END IF;

IF(p_postprem IS NOT NULL)
THEN
query1:=query1 || ' and a."Page_position_code" ='''||p_postprem||'''';
END IF;

IF(p_rostatus IS NOT NULL)
THEN
query1:=query1 || ' and a."ro_status" ='''||p_rostatus||'''';
END IF;

IF(p_booktype IS NOT NULL)
THEN
query1:=query1 || ' and a."Booking_type" ='''||p_booktype||'''';
END IF;

IF(p_contractname  IS NOT NULL)
THEN
query1:=query1 || ' and a."Contract_name" ='''||p_contractname ||'''';
END IF;



IF(p_ratetype  IS NOT NULL)
THEN
query1:=query1 || ' and a."Rate_code" ='''||p_ratetype||'''';
END IF;

IF(p_city  IS NOT NULL)
THEN
if(p_base='1')then
query1:=query1 || ' and AGENCY_MAST."City_Code" ='''||p_city||'''';
end if;

if(p_base='2')then
query1:=query1 || ' and a."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" ='''||p_city||''' )';
end if;

if(p_base='3')then
query1:=query1 || ' and a.RETAINER in(select RET."Retain_Code" from  RETAINERMASTER RET where  RET."City_Code"='''||p_city||''')';
end if;
END IF;

IF(p_zone  IS NOT NULL)
THEN
if(p_base='1')then
query1:=query1 || ' and AGENCY_MAST."zone_code" ='''||p_zone||'''';
end if;

if(p_base='2')then
query1:=query1 || ' and a."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" in (select city_mst."City_Code" from city_mst where city_mst."Zone_Code"= '''||p_zone||''') )';
end if;

if(p_base='3')then
query1:=query1 || ' and a.RETAINER in(select RET."Retain_Code" from  RETAINERMASTER RET where  RET."Zone_Code"='''||p_zone||''')';
end if;
END IF;

IF(p_district  IS NOT NULL)
THEN
if(p_base='1')then
query1:=query1 || ' and AGENCY_MAST."Dist_Code" ='''||p_district||'''';
end if;

if(p_base='2')then
query1:=query1 || ' and a."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."dist_code" ='''||p_district||''' )';
end if;

if(p_base='3')then
query1:=query1 || ' and a.RETAINER in(select RET."Retain_Code" from  RETAINERMASTER RET where  RET."Dist_Code"='''||p_district||''')';
end if;
END IF;

IF(p_state  IS NOT NULL)
THEN
if(p_base='1')then
query1:=query1 || ' and AGENCY_MAST."State_Code" ='''||p_state||'''';
end if;

if(p_base='2')then
query1:=query1 || ' and a."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."State_code" ='''||p_state||''' )';
end if;

if(p_base='3')then
query1:=query1 || ' and a.RETAINER in(select RET."Retain_Code" from  RETAINERMASTER RET where  RET."State_Code"='''||p_state||''')';
end if;
END IF;

IF(p_taluka  IS NOT NULL)
THEN
if(p_base='1')then
query1:=query1 || ' and AGENCY_MAST.TALUKA='''||p_taluka||'''  ';
end if;

if(p_base='2')then
query1:=query1 || ' and a."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast.TALUKA ='''||p_taluka||''' )';
end if;

if(p_base='3')then
query1:=query1 || ' and a.RETAINER in(select RET."Retain_Code" from  RETAINERMASTER RET where  RET.TALUKA='''||p_taluka||''')';
end if;
END IF;

query1:=query1 || ' group by a."date_time" order by "Date" ';

--insert into dbgstr(rdate,str,seq) values(sysdate,'OPEN p_recordset1 FOR1   '||query1,dbg_seq.nextval);commit;

OPEN p_recordset1 FOR
query1;



elsif(p_adcheck=2)then

delete from temp_ad_bills_report where sess_id=userenv('sessionid');
open c2;
loop
fetch c2 into v2;
exit when c2%notfound;
--insert into dbgstr(rdate,str,seq) values(sysdate,'before FUN_BILL_INSERT1   ',dbg_seq.nextval);commit;
     v_val:=FUN_BILL_INSERT(p_compcode,v2.CIOID,v2.BILLNO,prefer,p_dateformat,v2.AGMAINCODE,v2.AG_SUB_CODE,v2.AGCODE,v2.AGNAME,v2.EXECCODE,v2.EXECNAME,v2.RETCODE,v2.RETNAME,p_base );
--insert into dbgstr(rdate,str,seq) values(sysdate,'after FUN_BILL_INSERT1   ',dbg_seq.nextval);commit;     
end loop;
close c2;
commit;
--insert into dbgstr(rdate,str,seq) values(sysdate,'close c2   ',dbg_seq.nextval);commit;

query2:=query2||'SELECT
to_char(BILLDATE,'''||p_dateformat||''') as "Date",
sum(NOINSERT) as "noinsert",
sum(PAIDINSERT) as "Paidinsert" ,
sum(AREA) as "Area",
sum(CARDAMT) as "cardamt",
sum(DEVIATIONAMT) as "Deviationamt",
round(((nvl(sum(DEVIATIONAMT),0) *100)/nvl(sum(CARDAMT),0)),2)   AS "Deviation(%)",
sum(AGGAMT)  as "aggamt",
sum(DISCAMT) as "DiscAmt",
round(((nvl(sum(DISCAMT),0) *100)/nvl(sum(CARDAMT),0)),2) as "Discper",
sum(POSAMT)as  "posamt",
round(((nvl(sum(POSAMT),0) *100)/nvl(sum(CARDAMT),0)),2)  as "pos(%)",
sum(SPDISCAMT) as "Spdiscamt",
round(((nvl(sum(SPDISCAMT),0)*100)/nvl(sum(CARDAMT),0)),2)  as "Spdiscper",
sum(SPACEDISC) as "Spacedisc",
round(((nvl(sum(SPACEDISC),0)*100)/nvl(sum(CARDAMT),0)),2)  as "Spacediscper",
sum(SPECIALCHARGE) as "Specialcharge",
sum(AGENCYADDLTDAMT) as "AgencyAddlTDAmt",
round(((nvl(sum(AGENCYADDLTDAMT),0)*100)/(nvl(sum(CARDAMT),0)+nvl(sum(POSAMT),0)+nvl(sum(SPECIALCHARGE),0)-nvl(sum(DEVIATIONAMT),0)-nvl(sum(DISCAMT),0)-nvl(sum(SPDISCAMT),0)-nvl(sum(SPACEDISC),0))),2) as "AgencyAddlTD(%)",
sum(GROSSAMT)  as "Grossamt",
sum(RETTDAMT)as "RetTDAmt",
round(((nvl(sum(RETTDAMT),0)*100)/nvl(sum(GROSSAMT),0) ),2) as "RetTD(%)",
sum(AGENCYTDAMT)as "AgencyTDAmt",
round(((nvl(sum(AGENCYTDAMT),0)*100)/(nvl(sum(CARDAMT),0)+nvl(sum(POSAMT),0)+nvl(sum(SPECIALCHARGE),0)-nvl(sum(DEVIATIONAMT),0)-nvl(sum(DISCAMT),0)-nvl(sum(SPDISCAMT),0)-nvl(sum(SPACEDISC),0))),2)as "AgencyTD(%)",
sum(BILLAMT )as "Billamt",
sum(RETCOMMAMT)as "RetCommAmt",
round(((nvl(sum(RETCOMMAMT),0)*100)/nvl(sum(GROSSAMT),0)),2) as "RetComm(%)",
minus_to_zero(sum(ACTUALBUSINESS))as "ActualBusiness"
from temp_ad_bills_report where sess_id='||userenv('sessionid');




IF(p_fromdate IS NOT NULL AND p_dateto IS NOT NULL )
THEN
query2:=query2||' and BILLDATE between  '''||p_fromdate ||''' and  '''||p_dateto||''' ';
END IF;

IF(p_publication IS NOT NULL)
THEN
query2:=query2||' and PRIPUB='''||p_publication||'''';
END IF;

IF(p_pub_cent IS NOT NULL)
THEN
query2:=query2||'   and PUB_CENT_CODE='''||p_pub_cent||'''';
END IF;

IF(p_edition IS NOT NULL)
THEN
query2:=query2||'  and PEDITION='''||p_edition||'''';
END IF;

IF(p_branch IS NOT NULL)
THEN
query2:=query2||'  and  BRANCH_NAME ='''||p_branch||''' ';
END IF;

IF(p_region IS NOT NULL)
THEN
query2:=query2 ||' and REGION='''||p_region ||'''';
END IF;

IF(p_adtype IS NOT NULL)
THEN
query2:=query2 || ' and PADTYPE='''||p_adtype||'''';
END IF;

IF(p_agencytype IS NOT NULL)
THEN
query2:=query2 || ' and AGENCY_TYPE_CODE= '''||p_agencytype||'''';
END IF;

IF(p_adcat IS NOT NULL)
THEN
query2:=query2 || ' and PRIADCTG='''||p_adcat||'''';
END IF;

IF(p_adsubcat IS NOT NULL)
THEN
query2:=query2 || ' and SECADCTG ='''||p_adsubcat||'''';
END IF;

IF(p_adsubcat3 IS NOT NULL)
THEN
query2:=query2 || ' and AD_SUBCAT3 ='''||p_adsubcat3||'''';
END IF;

IF(p_adsubcat4 IS NOT NULL)
THEN
query2:=query2 || ' and AD_SUBCAT4 ='''||p_adsubcat4||'''';
END IF;

IF(p_adsubcat5 IS NOT NULL)
THEN
query2:=query2 || ' and AD_SUBCAT5 ='''||p_adsubcat5||'''';
END IF;

IF(p_package IS NOT NULL)
THEN
query2:=query2 || ' and PACKAGE_CODE='''||p_package||'''';
END IF;

IF(p_agency IS NOT NULL)
THEN
query2:=query2 || ' and AG_MAIN_CODE ='''||p_agency ||'''';
END IF;

IF(p_client IS NOT NULL)
THEN
query2:=query2 || ' and CLIENTCD='''||p_client ||'''';
END IF;

IF(p_executive IS NOT NULL)
THEN
query2:=query2 || ' and EXECUTIVE_NAME='''||p_executive||'''';
END IF;

IF(p_product IS NOT NULL)
THEN
query2:=query2 || ' and PRIPROCTG='''||p_product||'''';
END IF;

IF(p_brand IS NOT NULL)
THEN
query2:=query2 || ' and BRAND_CODE='''||p_brand||'''';
END IF;

IF(p_varient IS NOT NULL)
THEN
query2:=query2 || ' and   VARIENT_NAME='''||p_varient||'''';
END IF;

IF(p_pageprem IS NOT NULL)
THEN
query2:=query2 || ' and PAGE_PREM ='''||p_pageprem||'''';
END IF;

IF(p_postprem IS NOT NULL)
THEN
query2:=query2 || ' and PAGE_POST ='''||p_postprem||'''';
END IF;

IF(p_contractname  IS NOT NULL)
THEN
query2:=query2 || ' and CONTRACT_NAME ='''||p_contractname ||'''';
END IF;

IF(p_suppliment  IS NOT NULL)
THEN
query2:=query2 || ' and SUPP_CODE='''||p_suppliment||'''';
END IF;

IF(p_retainer IS NOT NULL)
THEN
query2:=query2 || ' and RETAINER_CODE='''||p_retainer||'''';
END IF;

IF(p_ratetype  IS NOT NULL)
THEN
query2:=query2 || ' and RATECD ='''||p_ratetype||'''';
END IF;

IF(p_scheme IS NOT NULL)
THEN
query2:=query2 || ' and PSCHEME='''||p_scheme||'''';
END IF;

IF(p_revcenter IS NOT NULL)
THEN
query2:=query2 ||' and REVENUE_CENTER='''||p_revcenter||'''';
END IF;

IF(p_rostatus IS NOT NULL)
THEN
query2:=query2 || ' and RO_STATUS='''||p_rostatus||'''';
END IF;

IF(p_pagetype IS NOT NULL)
THEN
query2:=query2 || ' and PAGE_TYPE ='''||p_pagetype||'''';
END IF;

IF(p_booktype IS NOT NULL)
THEN
query2:=query2 || ' and BOOKING_TYPE='''||p_booktype||'''';
END IF;



IF(p_city  IS NOT NULL)
THEN
query2:=query2 || ' and CITY_CODE ='''||p_city||'''';
END IF;

IF(p_zone  IS NOT NULL)
THEN
query2:=query2 || ' and ZONE_CODE ='''||p_zone||'''';
end if;

IF(p_district  IS NOT NULL)
THEN
query2:=query2 || ' and DIST_CODE ='''||p_district||'''';
end if;

IF(p_state  IS NOT NULL)
THEN
query2:=query2 || ' and STATE_CODE ='''||p_state||'''';
end if;

IF(p_taluka  IS NOT NULL)
THEN
query2:=query2 || ' and PTALUKA='''||p_taluka||'''  ';
end if;

if(p_base='2')then
query2:=query2 ||' and (EXECUTIVE_NAME   is not null and EXECUTIVE_NAME !=''0'')  ';
end if;

if(p_base='3')then
query2:=query2 ||' and (RETAINER_CODE  is not null  and RETAINER_CODE  !=''0'')  ';
end if;



query2:=query2 || ' group by BILLDATE   order by BILLDATE ';




OPEN p_recordset1 FOR
query2;

elsif(p_adcheck=3) then
query3:=query3 ||'SELECT
to_char(b."Insert_Date" ,'''||p_dateformat||''') as "Date",
sum(a."No_of_insertion") as "noinsert",
sum(a."Paid_ins") as "Paidinsert",
sum(b."Size_Book") as "Area",
sum(a."Card_rate"*b."Size_Book") as "cardamt",
sum(a."Deviation") as "Deviationamt",
round(((sum(a."Deviation")*100)/sum(a."Card_rate"*b."Size_Book")),2) AS "Deviation(%)",
sum(b."Agreed_Rate")  as "aggamt",
(sum(a."Card_rate"*b."Size_Book")- DECODE(NVL(sum(b."Agreed_Rate"),0),0,sum(a."Card_rate"*b."Size_Book"),sum(b."Agreed_Rate"))) as "DiscAmt",
round((((sum(a."Card_rate"*b."Size_Book")- DECODE(NVL(sum(b."Agreed_Rate"),0),0,sum(a."Card_rate"*b."Size_Book"),sum(b."Agreed_Rate")))*100)/sum(a."Card_rate"*b."Size_Book")),2) as "Discper",
sum((select SUM(nvl(RAT,0)) from multipack_rat where cioid=a."cio_booking_id" and sess_id='||userenv('sessionid')||')) as  "posamt",
round(((sum((select SUM(nvl(RAT,0)) from multipack_rat where cioid=a."cio_booking_id" and sess_id='||userenv('sessionid')||'))*100)/sum(a."Card_rate"*b."Size_Book")),2)  as "pos(%)",
sum(a."Special_disc_per" * b."Size_Book" * a."Card_rate"/100) as "Spdiscamt",
round(((sum(a."Special_disc_per" * b."Size_Book" * a."Card_rate"/100)*100)/sum(a."Card_rate"*b."Size_Book")),2) as "Spdiscper",
sum(a."Space_disc_per" * b."Size_Book" * a."Card_rate"/100) as "Spacedisc",
round(((sum(a."Space_disc_per" * b."Size_Book" * a."Card_rate"/100)*100)/sum(a."Card_rate"*b."Size_Book")),2) as "Spacediscper",
sum(a."Special_charges") as "Specialcharge",
round(((sum(nvl((nvl(b."Gross_Rate" ,''0'')*nvl(a."ADD_AGENCY_COMM",''0'')/100),''0''))*100)/(sum(a."Card_rate"*b."Size_Book")+sum((select SUM(nvl(RAT,0)) from multipack_rat where cioid=a."cio_booking_id" and sess_id='||userenv('sessionid')||'))+sum(a."Special_charges") -sum(a."Deviation")-(sum(a."Card_rate"*b."Size_Book")- DECODE(NVL(sum(b."Agreed_Rate"),0),0,sum(a."Card_rate"*b."Size_Book"),sum(b."Agreed_Rate")))-sum(a."Special_discount")-sum(a."Space_discount"))),2) as "AgencyAddlTD(%)",
sum(nvl((nvl(b."Gross_Rate" ,''0'')*nvl(a."ADD_AGENCY_COMM",''0'')/100),''0'')) as "AgencyAddlTDAmt",
ROUND(sum(nvl(b."Gross_Rate",''0'') ))as "Grossamt",
case sum(nvl(b."Gross_Rate",''0'') )
 when  0 then 0
   else  round(((sum(nvl(b."Gross_Rate",''0'')*(select DISTINCT TO_NUMBER(NVL("Comm_Rate",''0''))    from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'')) AND ROWNUM<=1 )/100)*100)/sum(nvl(b."Gross_Rate",''0'') )),2)
 end  as "RetTD(%)",
sum(nvl(nvl(b."Gross_Rate",''0'')*(select DISTINCT TO_NUMBER(NVL("Comm_Rate",''0''))    from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'')) AND ROWNUM<=1 )/100
,''0''))as "RetTDAmt",

round(((sum((nvl(b."Gross_Rate",''0'')* nvl(a."Trade_disc",''0'' )/100 ))*100)/(sum(a."Card_rate"*b."Size_Book")+sum((select SUM(nvl(RAT,0)) from multipack_rat where cioid=a."cio_booking_id" and sess_id='||userenv('sessionid')||'))+sum(a."Special_charges") -sum(a."Deviation")-(sum(a."Card_rate"*b."Size_Book")- DECODE(NVL(sum(b."Agreed_Rate"),0),0,sum(a."Card_rate"*b."Size_Book"),sum(b."Agreed_Rate")))-sum(a."Special_discount")-sum(a."Space_discount"))),2) as "AgencyTD(%)",

sum((nvl(b."Gross_Rate",''0'')* nvl(a."Trade_disc",''0'' )/100 ))as "AgencyTDAmt",
ROUND(sum(NVL(b."Bill_Amt",''0'')),2) as "Billamt",
 case sum(nvl(b."Gross_Rate",''0'') )
 when  0 then 0
 else  round(((sum(nvl(
case( '''||prefer||''' )
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'')) AND ROWNUM<=1)
        when ''Gross'' then

         (
                 CASE to_number(nvl(a.RETAINER_COMM,0))
                 WHEN 0 THEN 0
                 ELSE (to_number(nvl(a.RETAINER_COMM,''0''))-to_number(nvl(a."ADD_AGENCY_COMM",''0'' )))
               end   )



         when ''Net''   then  to_number(nvl(a.RETAINER_COMM,''0''))
          END )




    ELSE (select 0  from dual)
end
,''0'')) *100)/sum(nvl(b."Gross_Rate",''0'') )),2)

 end  as "RetComm(%)",

sum(nvl(
case( '''||prefer||''' )
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'')) AND ROWNUM<=1)
       when ''Gross'' then




                 (
                 CASE to_number(nvl(a.RETAINER_COMM_AMT,0))
                 WHEN 0 THEN 0
                 ELSE (to_number(nvl(a.RETAINER_COMM_AMT,''0''))-(nvl((nvl(b."Gross_Rate",''0'')*to_number(nvl(a."ADD_AGENCY_COMM",''0''))/100),''0'')))
                 end )



         when ''Net''   then  (nvl(b."Gross_Rate",''0'')*(to_number(nvl(a.RETAINER_COMM,''0'')) )/100)
        END )


    ELSE (select 0  from dual)
end
,''0''))as "RetCommAmt",


minus_to_zero(ROUND(sum(nvl((  NVL(b."Bill_Amt",''0'')-nvl(
case( '''||prefer||''' )
    when ''Y'' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"='''|| p_compcode ||''' and "Retain_Code"=nvl(a."RETAINER",''0'')) AND ROWNUM<=1)
        when ''Gross'' then
        (
                 CASE to_number(nvl(a.RETAINER_COMM_AMT,0))
                 WHEN 0 THEN 0
                 ELSE (to_number(nvl(a.RETAINER_COMM_AMT,''0''))-(nvl((nvl(b."Gross_Rate",''0'')*to_number(nvl(a."ADD_AGENCY_COMM",''0''))/100),''0'')))
                 end )


         when ''Net''   then  (nvl(b."Gross_Rate",''0'')*(to_number(nvl(a.RETAINER_COMM,''0'')) )/100)
        END )

    ELSE (select 0  from dual)
end
,''0'')  ),''0'')),2)) as "ActualBusiness"
FROM TBL_BOOKING_MAST a,AGENCY_MAST ,TBL_BOOKING_insert b
WHERE a."Comp_code"='''||p_compcode||''' AND
a."Agency_sub_code"=AGENCY_MAST."code_subcode" AND
a."cio_booking_id"=b."Cio_Booking_Id"
and ((b."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id='''||p_puserid||''') and '''||p_chk_access||'''=''1'')
or  ('''||p_chk_access||'''=''0'') )';


if(p_base='2')then
query3:=query3 ||' and (a."Executive_code" is not null and a."Executive_code" !=''0'')  ';
end if;

if(p_base='3')then
query3:=query3 ||' and (a.RETAINER is not null  and a.RETAINER !=''0'')  ';
end if;


if(p_drpstatus is null) then
query3:=query3||' and lower("Insert_Status")!='''||'cancel'||'''';
end if;


if(p_insertstatus is not null) then
query3:=query3||' and lower("Insert_Status")='''||p_insertstatus||'''';
end if;


IF(p_fromdate IS NOT NULL AND p_dateto IS NULL )
THEN
query3:=query3 ||' and b."Insert_Date" ='''||p_fromdate||'''';
END IF;

IF(p_fromdate IS NOT NULL AND p_dateto IS NOT NULL)
THEN
query3:=query3 ||' and b."Insert_Date" between  '''||p_fromdate ||''' and  '''||p_dateto||''' ';
END IF;

IF(p_publication IS NOT NULL)
THEN
query3:=query3 ||' and b."Publication_Code"='''||p_publication||'''    ';
END IF;

--old version

IF(p_pub_cent IS NOT NULL)
THEN
query3:=query3||'  and a."branch" IN (SELECT "Branch_Name" FROM BRANCH_MST WHERE a."branch"="Branch_Name" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"='''||p_pub_cent||'''))';
END IF;

IF(p_branch IS NOT NULL)
THEN
query3:=query3 ||'  and a."branch" ='''||p_branch||'''';
END IF;

--new version
/*
IF(p_pub_cent IS NOT NULL)
THEN
query3:=query3||'  and a."branch" IN (SELECT "Branch_Code" FROM BRANCH_MST WHERE a."branch"="Branch_Code" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"='''||p_pub_cent||'''))';
END IF;


IF(p_branch IS NOT NULL)
THEN
query3:=query3||'  and a."branch" = (SELECT "Branch_Code" FROM BRANCH_MST where "Branch_Name" ='''||p_branch||''') ';
END IF;
*/
IF(p_edition IS NOT NULL)
THEN
query3:=query3 ||'  and b."Edition_Code"='''||p_edition||'''';
END IF;

IF(p_region IS NOT NULL)
THEN
query3:=query3 ||'  and agency_mast."region" ='''||p_region||'''';
END IF;

IF(p_revcenter IS NOT NULL)
THEN
query3:=query3  ||' and a."Revenue_center" ='''||p_revcenter||'''';
END IF;

IF(p_adtype IS NOT NULL)
THEN
query3:=query3  || ' and a."Ad_type_code"='''||p_adtype||'''';
END IF;

IF(p_agencytype IS NOT NULL)
THEN
query3:=query3  || ' and a."Agency_type" ='''||p_agencytype||'''';
END IF;

IF(p_adcat IS NOT NULL)
THEN
query3:=query3  || ' and b."Ad_Cat" ='''||p_adcat||'''';
END IF;

IF(p_adsubcat IS NOT NULL)
THEN
query3:=query3  || ' and a."Ad_sub_cat_code" ='''||p_adsubcat||'''';
END IF;

IF(p_adsubcat3 IS NOT NULL)
THEN
query3:=query3  || ' and a."Ad_Subcat3" ='''||p_adsubcat3||'''';
END IF;

IF(p_adsubcat4 IS NOT NULL)
THEN
query3:=query3  || ' and a."Ad_Subcat4" ='''||p_adsubcat4||'''';
END IF;

IF(p_adsubcat5 IS NOT NULL)
THEN
query3:=query3  || ' and a."Ad_subcat5" ='''||p_adsubcat5||'''';
END IF;

IF(p_package IS NOT NULL)
THEN
query3:=query3  || ' and a."Package_code" ='''||p_package||'''';
END IF;

IF(p_scheme IS NOT NULL)
THEN
query3:=query3  || ' and a."Scheme_type_code" ='''||p_scheme||'''';
END IF;

IF(p_agency IS NOT NULL)
THEN
query3:=query3  || ' and a."Agency_code" ='''||p_agency||'''';
END IF;

IF(p_client IS NOT NULL)
THEN
query3:=query3  || ' and a."Client_code" ='''||p_client||'''';
END IF;

IF(p_executive IS NOT NULL)
THEN
query3:=query3  || ' and a."Executive_code" ='''||p_executive||'''';
END IF;

IF(p_retainer IS NOT NULL)
THEN
query3:=query3  || ' and a.RETAINER ='''||p_retainer||'''';
END IF;

IF(p_product IS NOT NULL)
THEN
query3:=query3 || ' and a."Product_code" ='''||p_product||'''';
END IF;

IF(p_brand IS NOT NULL)
THEN
query3:=query3  || ' and a."Brand_code" ='''||p_brand||'''';
END IF;

IF(p_varient IS NOT NULL)
THEN
query3:=query3  || ' and a."Variant_code" ='''||p_varient||'''';
END IF;

IF(p_pagetype IS NOT NULL)
THEN
query3:=query3  || ' and a."Page_type_code" ='''||p_pagetype||'''';
END IF;

IF(p_pageprem IS NOT NULL)
THEN
query3:=query3 || ' and b."Premium1" ='''||p_pageprem||'''';
END IF;

IF(p_postprem IS NOT NULL)
THEN
query3:=query3 || ' and b."Page_Post"  ='''||p_postprem||'''';
END IF;

IF(p_rostatus IS NOT NULL)
THEN
query3:=query3 || ' and a."ro_status" ='''||p_rostatus||'''';
END IF;

IF(p_booktype IS NOT NULL)
THEN
query3:=query3 || ' and a."Booking_type" ='''||p_booktype||'''';
END IF;

IF(p_contractname  IS NOT NULL)
THEN
query3:=query3 || ' and a."Contract_name" ='''||p_contractname ||'''';
END IF;

IF(p_suppliment  IS NOT NULL)
THEN
query3:=query3 || ' and b."Supp_Code" ='''||p_suppliment||'''';
END IF;

IF(p_ratetype  IS NOT NULL)
THEN
query3:=query3 || ' and a."Rate_code" ='''||p_ratetype||'''';
END IF;

IF(p_city  IS NOT NULL)
THEN
if(p_base='1')then
query3:=query3 || ' and AGENCY_MAST."City_Code" ='''||p_city||'''';
end if;

if(p_base='2')then
query3:=query3 || ' and a."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" ='''||p_city||''' )';
end if;

if(p_base='3')then
query3:=query3 || ' and a.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."City_Code"='''||p_city||''')';
end if;
END IF;

IF(p_zone  IS NOT NULL)
THEN
if(p_base='1')then
query3:=query3 || ' and AGENCY_MAST."zone_code" ='''||p_zone||'''';
end if;

if(p_base='2')then
query3:=query3 || ' and a."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."city_code" in (select city_mst."City_Code" from city_mst where city_mst."Zone_Code"= '''||p_zone||''') )';
end if;

if(p_base='3')then
query3:=query3 || ' and a.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Zone_Code"='''||p_zone||''')';
end if;
END IF;

IF(p_district  IS NOT NULL)
THEN
if(p_base='1')then
query3:=query3 || ' and AGENCY_MAST."Dist_Code" ='''||p_district||'''';
end if;

if(p_base='2')then
query3:=query3 || ' and a."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."dist_code" ='''||p_district||''' )';
end if;

if(p_base='3')then
query3:=query3 || ' and a.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."Dist_Code"='''||p_district||''')';
end if;
END IF;

IF(p_state  IS NOT NULL)
THEN
if(p_base='1')then
query3:=query3 || ' and AGENCY_MAST."State_Code" ='''||p_state||'''';
end if;

if(p_base='2')then
query3:=query3 || ' and a."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast."State_code" ='''||p_state||''' )';
end if;

if(p_base='3')then
query3:=query3 || ' and a.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER."State_Code"='''||p_state||''')';
end if;
END IF;

IF(p_taluka  IS NOT NULL)
THEN
if(p_base='1')then
query3:=query3 || ' and AGENCY_MAST.TALUKA='''||p_taluka||''' ';
end if;

if(p_base='2')then
query3:=query3 || ' and a."Executive_code" in(select exec_mast."Exe_no" from exec_mast where exec_mast.TALUKA ='''||p_taluka||''' )';
end if;

if(p_base='3')then
query3:=query3 || ' and a.RETAINER in(select RETAINERMASTER."Retain_Code" from  RETAINERMASTER where  RETAINERMASTER.TALUKA='''||p_taluka||''')';
end if;
END IF;

query3:=query3 || ' group by b."Insert_Date" order by "Date" ';

OPEN p_recordset1 FOR
query3;

end if;
end if;




OPEN  p_accounts FOR
SELECT to_char( SYSDATE,p_dateformat) AS "Rundate",initcap("Comp_Name") AS "companyname" from comp_mst where "Comp_Code"=p_compcode;
delete from multipack_rep where sess_id=userenv('sessionid')  ;
delete from multipack_rat where sess_id=userenv('sessionid') ;
DELETE FROM multipack_ratnew where sess_id=userenv('sessionid')  ; commit;

END ;
/



@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@Issue no. 5584,6349,6022@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ laxman sir@@@23/01/12@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

                                                                     
                                                                     
                                             
CREATE OR REPLACE FUNCTION FETCH_PACK_new(PCOMP_CD VARCHAR2,v_pack varchar2) RETURN VARCHAR2 as
v_vals          varchar2(2000);
NumSegments     number;
CurrentSegment  number;
SegmentVal      VARCHAR2(500);
vtxt            varchar2(8000);
Delim           varchar2(1):=',';
v_pack_name     varchar2(8000);
BEGIN

NumSegments     := (length(v_pack) - length(replace(v_pack, Delim, ''))) + 1;
CurrentSegment  := 1;
vtxt            := v_pack;

WHILE (CurrentSegment < NumSegments)loop
    SegmentVal  := substr(vtxt,1, instr(vtxt,Delim)-1);
    vtxt        := substr(vtxt, instr(vtxt,Delim)+1, length(vtxt));

    begin
        select "Combin_Desc" into v_vals from combin_mast where "Combin_Code"=ltrim(SegmentVal);
    exception when no_data_found then
        v_vals:=ltrim(SegmentVal);
    end;

    if v_pack_name is null then
        v_pack_name:=v_vals;
    else
        v_pack_name:=v_pack_name||','||v_vals;
    end if;

    CurrentSegment:= CurrentSegment + 1;
END loop;
    begin
        select "Combin_Desc" into v_vals from combin_mast where "Combin_Code"=ltrim(vtxt);
    exception when no_data_found then
        v_vals:=ltrim(vtxt);
    end;

    if v_pack_name is null then
        v_pack_name:=v_vals;
    else
        v_pack_name:=v_pack_name||','||v_vals;
    end if;

    return v_pack_name;
END;
/



                                                                     
                                                                     
                                                                     
                                             
CREATE OR REPLACE PROCEDURE Reportnew1(
    agname          IN  VARCHAR2:=NULL,
    clientname      IN  VARCHAR2:=NULL,
    adtype1         IN  VARCHAR2,
    Adcategory      IN  VARCHAR2,
    Adsubcategory   IN  VARCHAR2,
    fromdate        IN  VARCHAR2,
    dateto          IN  VARCHAR2,
    compcode        IN  VARCHAR2,
    pub_name        IN  VARCHAR2,
    pub_cent        IN  VARCHAR2,
    status          IN  VARCHAR2:=NULL,
    edition         IN  VARCHAR2,
    dateformat      IN  VARCHAR2,
    hold            IN  VARCHAR2:=NULL,
    descid          IN  VARCHAR2:=NULL,
    ascdesc         IN  VARCHAR2:=NULL,
    agtype          in  varchar2:=null,
    puserid         in  varchar2:=null,
    chk_access      in  varchar2:=null,
    pbranch         in  varchar2:=null,
    pprint_center   in  varchar2:=null,
    pwithout_rono   in  varchar2:=null,--it is for without agency ro no. list Y or N or All
    pdate_flag      in  varchar2:=null,--it is used for booking date B or publish date P
    pextra1         in  varchar2:=null,
    pextra2         in  varchar2:=null,
    pextra3         in  varchar2:=null,
    pextra4         in  varchar2:=null,
    pextra5         in  varchar2:=null,
    p_reportnew     OUT Cur_Type_New1.cursor_type)
IS

center      VARCHAR(50);
from_date   DATE;
date_to     DATE;
v_query     VARCHAR(8000);
a           number;
BEGIN
    v_query:=' SELECT m."cio_booking_id" AS "CIOID",i."Edition" as "edition",
    CASE '''||dateformat||'''WHEN ''mm/dd/yyyy'' THEN TO_CHAR(i."Insert_Date",''mm/dd/yyyy'')
    WHEN ''dd/mm/yyyy'' THEN TO_CHAR(i."Insert_Date",''dd/mm/yyyy'')
    WHEN ''yyyy/mm/dd'' THEN TO_CHAR(i."Insert_Date",''yyyy/mm/dd'')  END AS "Ins.date" ,
    a."Agency_Name" AS "Agency",
    NVL((SELECT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code"=m."Client_code"),m."Client_code")  AS "Client",
    /*(select COMBIN_MAST."Package_Name" from combin_mast where COMBIN_MAST."Combin_Code"  in(m."Package_code"))AS "Package",*/
    case when instr(m."Package_code",'','') >0 then 
        FETCH_PACK_new('''||compcode||''', m."Package_code" ) 
    else
        (select distinct min("Combin_Desc") from combin_mast where "Combin_Code"=m."Package_code")
    end AS "Package",
    i."Height" AS "Depth",i."Width"   AS "Width",round(i."Size_Book",2) AS "Area",
    (select uom_mast.UOM_DESC from uom_mast where m."Uom_code"=uom_mast."Uom_Code")as "uom",i."Col_Code" AS "Color_code",
    (SELECT ADVPOS_TYPE_MAST."Pos_Type_Alias" FROM ADVPOS_TYPE_MAST WHERE i."Page_Post"=ADVPOS_TYPE_MAST."Pos_Type_Code") AS "Page",
    m."Bullet_code" AS "BulletPremium" ,i."Page_Post" AS "PositionPremium" ,i."Premium1" AS "PagePremium" ,
    m."RO_No" AS "RoNo.",CASE m."ro_status" WHEN ''2'' THEN ''Reservation'' WHEN ''1'' THEN ''Confirm'' END AS "RoStatus",
    (SELECT ADV_CAT_MAST."Adv_Cat_Name" FROM ADV_CAT_MAST WHERE ADV_CAT_MAST."Adv_Cat_Code"=i."Ad_Cat") AS "AdCat",
    m."Card_rate" AS "CardRate",NVL("Agrred_rate",0) AS "AgreedRate",i."Bill_Amt" AS "Amt",m."Caption" AS "Cap",m."Key_no" AS "Key",
    (SELECT initcap("Comp_Name") from comp_mst where "Comp_Code"='''||compcode||''') AS "companyname",
    sysdate as "Rundate",
    m.CASHDISCOUNT as "Cash_Disc", m."AUDIT_COMMENT" as "COMMENT",m."Dockit_no" as "DOCKIT_NO"
    FROM TBL_BOOKING_MAST m,TBL_BOOKING_INSERT i,AGENCY_MAST a
    WHERE m."Comp_code"='''||compcode||'''
    AND m."cio_booking_id"=i."Cio_Booking_Id"
    AND m."Agency_code"=a."Agency_Code"
    and m."Agency_sub_code"=a."code_subcode"
    AND m."cio_booking_id" not in(select distinct "prev_cioid" from tbl_booking_mast where "prev_cioid" is not null)
    and  lower(i."Insert_Status") !=''cancel''
    and ((i."Pub_Cent_Code" in (select distinct pub_center from login_center where  newuser_id='''||puserid||''') and '''||chk_access||'''=''1'')
    or  ('''||chk_access||'''=''0'') )';


/*
IF(hold IS NOT NULL)THEN
v_query:=v_query||' and m."Insert_Status"!='''||'Cancel'||'''';

END IF;
*/
IF(agname IS NOT NULL) THEN
    v_query:=v_query||' and m."Agency_code" ='''||agname||'''';
END IF;

IF(clientname IS NOT NULL) THEN
    v_query:=v_query||' and m."Client_code"='''||clientname ||'''';
END IF;

IF(status IS NOT NULL) THEN
    v_query:=v_query||' and i."Insert_Status"='''||status||'''';
END IF;

IF(adtype1 IS NOT NULL) THEN
    v_query:=v_query||' and m."Ad_type_code"='''||adtype1||'''';
END IF;

IF(Adcategory IS NOT NULL) THEN
    a:=Fn_Splitfield(Adcategory,',');
    --v_query:=v_query||' and m."Ad_cat_code" in('''||Adcategory||''' )';
    v_query:=v_query||' and i."Ad_Cat" in(select "EDITION_NAME" from result  )';
END IF;

IF(Adsubcategory IS NOT NULL) THEN
    a:=fn_SplitField_new(Adsubcategory,',');
    v_query:=v_query||' and m."Ad_sub_cat_code" in(select "EDITION_NAME" from result_new where sess_id='||userenv('sessionid')||' )';
END IF;

IF(pub_cent IS NOT NULL) THEN
    v_query:=v_query||'  and i."Pub_Cent_Code"='''||pub_cent||'''';
END IF;

If pdate_flag='B' then
    IF(fromdate IS NOT NULL AND dateto IS NULL ) THEN
        v_query:=v_query||' and m."date_time" ='''||fromdate||'''';

    END IF;

    IF(fromdate IS NOT NULL AND dateto IS NOT NULL ) THEN
        v_query:=v_query||' and m."date_time" between  '''||fromdate ||''' and  '''||dateto||''' ';
    END IF;
Else
    IF(fromdate IS NOT NULL AND dateto IS NULL ) THEN
        v_query:=v_query||' and i."Insert_Date" ='''||fromdate||'''';
    END IF;

    IF(fromdate IS NOT NULL AND dateto IS NOT NULL ) THEN
        v_query:=v_query||' and i."Insert_Date" between  '''||fromdate ||''' and  '''||dateto||''' ';
    END IF;
End If;    

IF(edition IS NOT NULL) THEN
    v_query:=v_query||'  and i."Edition_Code"='''||edition||'''';
END IF;

IF(pub_name IS NOT NULL) THEN
    v_query:=v_query||' and  i."Publication_Code"='''||pub_name||'''';
END IF;

IF((agtype IS NOT NULL) AND (agtype <> 'Package') AND (agtype <> 'Solo')) THEN
    v_query:=v_query||' and  m."Agency_type"='''||upper(agtype)||'''';
END IF;


if(pprint_center is not null)then
    v_query:=v_query||' and m."branch" IN (SELECT "Branch_Code" FROM BRANCH_MST WHERE m."branch"="Branch_Code" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"='''||pprint_center||''')) ';
end if;

if(pbranch is not null)then
    v_query:=v_query||' and m."branch" = '''||pbranch||''' ';
end if;

If pwithout_rono='Y' then
    
    v_query:=v_query||' and (m."RO_No" is null or m."RO_No"='''') ';
End if;    

If pwithout_rono='N' then
    
    v_query:=v_query||' and (m."RO_No" is not null or m."RO_No"<>'''') ';
    
End if;

IF(descid IS NOT  NULL) THEN
    v_query:=v_query||'  order by "'||descid||'"';
    v_query:=v_query||''||ascdesc||'';
ELSE
    v_query:=v_query||'  order by i."Insert_Date",m."cio_booking_id"';
END IF;

--delete from searchtbl;insert into searchtbl values(v_query);commit;

OPEN p_reportnew FOR v_query;

END Reportnew1;
/



                                                                     
                                                                     
                                                                     
                                             
CREATE OR REPLACE PROCEDURE Reportnew1(
    agname          IN  VARCHAR2:=NULL,
    clientname      IN  VARCHAR2:=NULL,
    adtype1         IN  VARCHAR2,
    Adcategory      IN  VARCHAR2,
    Adsubcategory   IN  VARCHAR2,
    fromdate        IN  VARCHAR2,
    dateto          IN  VARCHAR2,
    compcode        IN  VARCHAR2,
    pub_name        IN  VARCHAR2,
    pub_cent        IN  VARCHAR2,
    status          IN  VARCHAR2:=NULL,
    edition         IN  VARCHAR2,
    dateformat      IN  VARCHAR2,
    hold            IN  VARCHAR2:=NULL,
    descid          IN  VARCHAR2:=NULL,
    ascdesc         IN  VARCHAR2:=NULL,
    agtype          in  varchar2:=null,
    puserid         in  varchar2:=null,
    chk_access      in  varchar2:=null,
    pbranch         in  varchar2:=null,
    pprint_center   in  varchar2:=null,
    pwithout_rono   in  varchar2:=null,--it is for without agency ro no. list Y or N or All
    pdate_flag      in  varchar2:=null,--it is used for booking date B or publish date P
    pextra1         in  varchar2:=null,
    pextra2         in  varchar2:=null,
    pextra3         in  varchar2:=null,
    pextra4         in  varchar2:=null,
    pextra5         in  varchar2:=null,
    p_reportnew     OUT Cur_Type_New1.cursor_type)
IS

center      VARCHAR(50);
from_date   DATE;
date_to     DATE;
v_query     VARCHAR(8000);
a           number;
BEGIN
    v_query:=' SELECT m."cio_booking_id" AS "CIOID",i."Edition" as "edition",
    CASE '''||dateformat||'''WHEN ''mm/dd/yyyy'' THEN TO_CHAR(i."Insert_Date",''mm/dd/yyyy'')
    WHEN ''dd/mm/yyyy'' THEN TO_CHAR(i."Insert_Date",''dd/mm/yyyy'')
    WHEN ''yyyy/mm/dd'' THEN TO_CHAR(i."Insert_Date",''yyyy/mm/dd'')  END AS "Ins.date" ,
    a."Agency_Name" AS "Agency",
    NVL((SELECT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code"=m."Client_code"),m."Client_code")  AS "Client",
    /*(select COMBIN_MAST."Package_Name" from combin_mast where COMBIN_MAST."Combin_Code"  in(m."Package_code"))AS "Package",*/
    case when instr(m."Package_code",'','') >0 then 
        FETCH_PACK_new('''||compcode||''', m."Package_code" ) 
    else
        (select distinct min("Combin_Desc") from combin_mast where "Combin_Code"=m."Package_code")
    end AS "Package",
    i."Height" AS "Depth",i."Width"   AS "Width",round(i."Size_Book",2) AS "Area",
    (select uom_mast.UOM_DESC from uom_mast where m."Uom_code"=uom_mast."Uom_Code")as "uom",i."Col_Code" AS "Color_code",
    (SELECT ADVPOS_TYPE_MAST."Pos_Type_Alias" FROM ADVPOS_TYPE_MAST WHERE i."Page_Post"=ADVPOS_TYPE_MAST."Pos_Type_Code") AS "Page",
    m."Bullet_code" AS "BulletPremium" ,i."Page_Post" AS "PositionPremium" ,i."Premium1" AS "PagePremium" ,
    m."RO_No" AS "RoNo.",CASE m."ro_status" WHEN ''2'' THEN ''Reservation'' WHEN ''1'' THEN ''Confirm'' END AS "RoStatus",
    (SELECT ADV_CAT_MAST."Adv_Cat_Name" FROM ADV_CAT_MAST WHERE ADV_CAT_MAST."Adv_Cat_Code"=i."Ad_Cat") AS "AdCat",
    m."Card_rate" AS "CardRate",NVL("Agrred_rate",0) AS "AgreedRate",i."Bill_Amt" AS "Amt",m."Caption" AS "Cap",m."Key_no" AS "Key",
    (SELECT initcap("Comp_Name") from comp_mst where "Comp_Code"='''||compcode||''') AS "companyname",
    sysdate as "Rundate",
    m.CASHDISCOUNT as "Cash_Disc", m."AUDIT_COMMENT" as "COMMENT",m."Dockit_no" as "DOCKIT_NO"
    FROM TBL_BOOKING_MAST m,TBL_BOOKING_INSERT i,AGENCY_MAST a
    WHERE m."Comp_code"='''||compcode||'''
    AND m."cio_booking_id"=i."Cio_Booking_Id"
    AND m."Agency_code"=a."Agency_Code"
    and m."Agency_sub_code"=a."code_subcode"
    AND m."cio_booking_id" not in(select distinct "prev_cioid" from tbl_booking_mast where "prev_cioid" is not null)
    and  lower(i."Insert_Status") !=''cancel''
    and ((i."Pub_Cent_Code" in (select distinct pub_center from login_center where  newuser_id='''||puserid||''') and '''||chk_access||'''=''1'')
    or  ('''||chk_access||'''=''0'') )';


/*
IF(hold IS NOT NULL)THEN
v_query:=v_query||' and m."Insert_Status"!='''||'Cancel'||'''';

END IF;
*/
IF(agname IS NOT NULL) THEN
    v_query:=v_query||' and m."Agency_code" ='''||agname||'''';
END IF;

IF(clientname IS NOT NULL) THEN
    v_query:=v_query||' and m."Client_code"='''||clientname ||'''';
END IF;

IF(status IS NOT NULL) THEN
    v_query:=v_query||' and i."Insert_Status"='''||status||'''';
END IF;

IF(adtype1 IS NOT NULL) THEN
    v_query:=v_query||' and m."Ad_type_code"='''||adtype1||'''';
END IF;

IF(Adcategory IS NOT NULL) THEN
    a:=Fn_Splitfield(Adcategory,',');
    --v_query:=v_query||' and m."Ad_cat_code" in('''||Adcategory||''' )';
    v_query:=v_query||' and i."Ad_Cat" in(select "EDITION_NAME" from result  )';
END IF;

IF(Adsubcategory IS NOT NULL) THEN
    a:=fn_SplitField_new(Adsubcategory,',');
    v_query:=v_query||' and m."Ad_sub_cat_code" in(select "EDITION_NAME" from result_new where sess_id='||userenv('sessionid')||' )';
END IF;

IF(pub_cent IS NOT NULL) THEN
    v_query:=v_query||'  and i."Pub_Cent_Code"='''||pub_cent||'''';
END IF;

If pdate_flag='B' then
    IF(fromdate IS NOT NULL AND dateto IS NULL ) THEN
        v_query:=v_query||' and m."date_time" ='''||fromdate||'''';

    END IF;

    IF(fromdate IS NOT NULL AND dateto IS NOT NULL ) THEN
        v_query:=v_query||' and m."date_time" between  '''||fromdate ||''' and  '''||dateto||''' ';
    END IF;
Else
    IF(fromdate IS NOT NULL AND dateto IS NULL ) THEN
        v_query:=v_query||' and i."Insert_Date" ='''||fromdate||'''';
    END IF;

    IF(fromdate IS NOT NULL AND dateto IS NOT NULL ) THEN
        v_query:=v_query||' and i."Insert_Date" between  '''||fromdate ||''' and  '''||dateto||''' ';
    END IF;
End If;    

IF(edition IS NOT NULL) THEN
    v_query:=v_query||'  and i."Edition_Code"='''||edition||'''';
END IF;

IF(pub_name IS NOT NULL) THEN
    v_query:=v_query||' and  i."Publication_Code"='''||pub_name||'''';
END IF;

IF((agtype IS NOT NULL) AND (agtype <> 'Package') AND (agtype <> 'Solo')) THEN
    v_query:=v_query||' and  m."Agency_type"='''||upper(agtype)||'''';
END IF;


if(pprint_center is not null)then
    v_query:=v_query||' and m."branch" IN (SELECT "Branch_Code" FROM BRANCH_MST WHERE m."branch"="Branch_Code" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"='''||pprint_center||''')) ';
end if;

if(pbranch is not null)then
    v_query:=v_query||' and m."branch" = '''||pbranch||''' ';
end if;

If pwithout_rono='Y' then
    
    v_query:=v_query||' and (m."RO_No" is null or m."RO_No"='''') ';
End if;    

If pwithout_rono='N' then
    
    v_query:=v_query||' and (m."RO_No" is not null or m."RO_No"<>'''') ';
    
End if;

IF(descid IS NOT  NULL) THEN
    v_query:=v_query||'  order by "'||descid||'"';
    v_query:=v_query||''||ascdesc||'';
ELSE
    v_query:=v_query||'  order by i."Insert_Date",m."cio_booking_id"';
END IF;

--delete from searchtbl;insert into searchtbl values(v_query);commit;

OPEN p_reportnew FOR v_query;

END Reportnew1;
/
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ laxman sir@@@23/01/12@@@@@@@@@@@@@END@@@@@@@@@@@@@@@@@@@@

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@6384@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

                                                                     
                                                                     
                                                                     
                                             
CREATE OR REPLACE PROCEDURE Schedulereport1(
    fromdate        IN VARCHAR2,
    dateto          IN VARCHAR2,
    compcode        IN VARCHAR2,
    pub_name        IN VARCHAR2,
    pub_cent        IN VARCHAR2,
    dateformat      IN VARCHAR2,
    descid          IN VARCHAR2:=NULL,
    ascdesc         IN VARCHAR2:=NULL,
    adtyp           IN VARCHAR2,
    adcatg          IN VARCHAR2,
    edition_name    in varchar2,
    drpstatus       in varchar2,
    supplement_name in varchar2,
    packagecode     in varchar2,
    editiondtl      in varchar2,
    puserid         in varchar2:=null,
    chk_access      in varchar2:=null,
    p_branch        in varchar2:=null,
    p_accounts      OUT Cur_Type_New1.cursor_type,
    p_accounts1     OUT Cur_Type_New1.cursor_type,
    p_accounts2     OUT Cur_Type_New1.cursor_type,
    p_accounts3     out Cur_Type_New1.cursor_type,
    p_accounts4     out Cur_Type_New1.cursor_type) IS
query1 VARCHAR2(10000);
v_gau number:=17;
v_val number(4);
vs_gau number(4);

--if(drpstatus ='cancel') then
Cursor p1 Is
select TBL_BOOKING_INSERT."Edition" as "edition",count(*) as "tot"
FROM TBL_BOOKING_MAST,TBL_BOOKING_INSERT,AGENCY_MAST ,COL_MAST, UOM_MAST
WHERE TBL_BOOKING_MAST."Comp_code"=compcode AND
TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id" AND
TBL_BOOKING_MAST."Agency_sub_code"=AGENCY_MAST."code_subcode" AND
TBL_BOOKING_insert."Col_Code" =COL_MAST."Col_Code" AND
UOM_MAST."Uom_Code"=TBL_BOOKING_MAST."Uom_code"
AND TBL_BOOKING_INSERT."Insert_Date" BETWEEN fromdate AND dateto
 and (TBL_BOOKING_INSERT."Insert_Status"!=drpstatus or drpstatus is null)
AND (TBL_BOOKING_INSERT."Publication_Code"=pub_name or pub_name is null)
AND (TBL_BOOKING_INSERT."Pub_Cent_Code"=pub_cent or pub_cent is null)
AND (TBL_BOOKING_MAST."Ad_type_code"=Adtyp or Adtyp is null)
AND (tbl_booking_insert."Ad_Cat"=adcatg or adcatg is null)
AND (TBL_BOOKING_INSERT."Edition_Code"=edition_name or edition_name is null)
AND (TBL_BOOKING_insert."Supp_Code" =supplement_name or supplement_name is null)
AND (TBL_BOOKING_mast."branch"  = p_branch  OR	p_branch  is null)
and (packagecode in (tbl_booking_mast."Package_code") or packagecode is null)
and ((tbl_booking_insert."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id=puserid) and chk_access=1)
or  (chk_access=0) )
group by TBL_BOOKING_INSERT."Edition" order by TBL_BOOKING_INSERT."Edition";

g1 p1%rowtype;

Cursor C1 Is
SELECT distinct TBL_BOOKING_INSERT."Cio_Booking_Id" AS "CIOID",TBL_BOOKING_MAST."Package_code" as package_code
,TBL_BOOKING_mast."Gross_amount" as Crate
FROM TBL_BOOKING_MAST, TBL_BOOKING_INSERT--,multipack_rep
WHERE TBL_BOOKING_MAST."Comp_code"=compcode AND
TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"
AND TBL_BOOKING_INSERT."Insert_Date" BETWEEN fromdate AND dateto
AND (TBL_BOOKING_INSERT."Publication_Code"=pub_name or pub_name is null)
AND (TBL_BOOKING_INSERT."Pub_Cent_Code"=pub_cent or pub_cent is null)
AND (TBL_BOOKING_MAST."Ad_type_code"=Adtyp or Adtyp is null)
AND (tbl_booking_insert."Ad_Cat"=adcatg or adcatg is null)
AND (TBL_BOOKING_INSERT."Edition_Code"=edition_name or edition_name is null)
AND (TBL_BOOKING_insert."Supp_Code" =supplement_name or supplement_name is null)
AND (TBL_BOOKING_mast."branch"  = p_branch  OR	p_branch  is null)
and (packagecode in (tbl_booking_mast."Package_code") or packagecode is null)
and ((tbl_booking_insert."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id=puserid) and chk_access=1)
or  (chk_access=0) );
v1 c1%rowtype;

Cursor C2 Is
SELECT distinct "Edition" from TBL_BOOKING_INSERT where "Cio_Booking_Id"=v1.cioid;
v_edition varchar2(100);
v_edipkg varchar2(500);

BEGIN
delete temp_edi;

delete from MULTIPAGE_BREAK where sess_id=userenv('sessionid');commit;


open p1;
loop
fetch p1 into g1;
exit when p1%notfound;
--multipage_brek(packag VARCHAR2,PCOMP_CD number,bre number)
vs_gau:=multipage_brek(g1."edition", g1."tot",v_gau);
     end loop;
close p1;
commit;

--------- fetch multiple  edition  ( ad by rinki)-----------
delete from multipack_rep where sess_id=userenv('sessionid');commit;
open c1;
loop
fetch c1 into v1;
exit when c1%notfound;

    
      v_val:=multipack_report(v1.CIOID,v1.package_code,v1.Crate,'1');
    open C2;
    Loop
    fetch C2 into v_edition;
    exit when C2%notfound;
    if v_edipkg is null then
        v_edipkg :=v_edition;
    else
        v_edipkg :=v_edipkg|| ',' ||v_edition;
    end if;
    end loop;
    close C2;

    v_edition:=null;v_edipkg:=null;
end loop;
close c1;
commit;
---------------------end -------------------------------
if(packagecode is null or editiondtl='1')then
    if(drpstatus ='includecancel' or drpstatus ='includehold') then
    
    query1:='SELECT TBL_BOOKING_MAST ."cio_booking_id" AS "CIOID",
        AGENCY_MAST."Agency_Name" AS "Agency",
        NVL((SELECT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code"="Client_code" and tbl_booking_mast."Comp_code"=cust_mast."Comp_Code" ),"Client_code")  AS "Client",
        multipack_rep.PACK  AS "Package",
        COL_MAST ."Col_Alias" AS "Hue",
        TBL_BOOKING_MAST."Card_rate" AS "CardRate",
        NVL("Agrred_rate",TBL_BOOKING_MAST."Card_rate") AS "AgreedRate",
        tbl_booking_insert."Status_Material" as "InsertStatus",
        TBL_BOOKING_MAST."Caption" as "Caption",
        TBL_BOOKING_MAST."Key_no" as "Key_no",
        TBL_BOOKING_INSERT."Edition" as "edition",
        TBL_BOOKING_MAST."RO_No" as "RO_No",
        (select ADVPOS_PREM_MAST."premiumname" from advpos_prem_mast where ADVPOS_PREM_MAST."Premiumcode"=TBL_BOOKING_INSERT."Premium1" and ADVPOS_PREM_MAST."comp_code"=tbl_booking_insert."Comp_Code" ) as "PagePremium",
        (select advpos_type_mast."Pos_Type" from advpos_type_mast where advpos_type_mast."Pos_Type_Code"=tbl_booking_insert."Page_Post" and advpos_type_mast."Comp_Code"=tbl_booking_insert."Comp_Code" ) as "PosPremium",
        round(TBL_BOOKING_insert."Size_Book",2) AS "Area",
        TBL_BOOKING_MAST."Bill_remarks" AS "Spl Instruction",
        CASE '''||dateformat||'''
        WHEN ''mm/dd/yyyy'' THEN TO_CHAR("Insert_Date",''MM-DD-YY'')
        WHEN ''dd/mm/yyyy'' THEN TO_CHAR("Insert_Date",''DD-MM-YY'')
        WHEN ''yyyy/mm/dd'' THEN TO_CHAR("Insert_Date",''YY-MM-DD'') END AS "Ins.date" ,
        tbl_booking_insert."Width"  AS "Width",
        tbl_booking_insert."Height" AS "Depth"
        ,(SELECT ADV_CAT_MAST."Adv_Cat_Name" FROM ADV_CAT_MAST WHERE ADV_CAT_MAST."Adv_Cat_Code"=tbl_booking_insert."Ad_Cat" and ADV_CAT_MAST."Comp_Code"=tbl_booking_insert."Comp_Code" ) as "Adcat",
         (select ADV_SUBCAT_MAST."Adv_Subcat_Name"   FROM ADV_SUBCAT_MAST WHERE  ADV_SUBCAT_MAST."Adv_Subcat_Code"=tbl_booking_insert."Ad_Sub_Cat" and ADV_SUBCAT_MAST."Comp_Code"=tbl_booking_insert."Comp_Code" ) AS "AdSubcat",
         (select AD_CAT3."catname"   FROM AD_CAT3 WHERE  AD_CAT3."catcode"=tbl_booking_mast."Ad_Subcat3" and AD_CAT3."compcode"=tbl_booking_mast."Comp_code" ) AS "AdSubcat3",
        TBL_BOOKING_INSERT."Page_No" as "Pageno",
        TBL_BOOKING_MAST."Paid_ins" as "Paidins",
        TBL_BOOKING_MAST."Rate_code" as ratecd,
        UOM_MAST."Uom_Name"  AS "Uom",
        (select uom_mast.UOM_DESC from uom_mast where tbl_booking_mast."Uom_code"=uom_mast."Uom_Code" and tbl_booking_mast."Comp_code"=uom_mast."Comp_Code"  )as "uomdesc"
        ,TBL_BOOKING_MAST."Booking_type" AS "booktype"
        ,tbl_booking_mast."audit" as "audit"
        ,tbl_booking_insert."File_Name" as "FILE_NAME",TBL_BOOKING_MAST.APP_STATUS as "APP_STATUS",tbl_booking_insert."No_Insert" as "NO_INSERT",
        (select distinct "Branch_Name" from branch_mst where "Branch_Code"=TBL_BOOKING_MAST."branch") as "BRANCH_NAME"
        FROM TBL_BOOKING_MAST,TBL_BOOKING_INSERT,AGENCY_MAST ,multipack_rep,COL_MAST ,UOM_MAST
        WHERE TBL_BOOKING_MAST."Comp_code"='''||compcode||'''AND
        TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id" AND
        tbl_booking_mast."Comp_code"=tbl_booking_insert."Comp_Code" and
        TBL_BOOKING_MAST."Agency_sub_code"=AGENCY_MAST."code_subcode" AND
        TBL_BOOKING_insert."Col_Code"=COL_MAST."Col_Code" AND
         UOM_MAST."Uom_Code"=TBL_BOOKING_MAST."Uom_code"
        and  multipack_rep.CIOID=tbl_booking_mast."cio_booking_id"
        and sess_id='||userenv('sessionid')||'
        and "cio_booking_id" not in(select distinct "prev_cioid" from tbl_booking_mast where "prev_cioid" is not null)
        and (('''||drpstatus||''' =''includecancel'' and  lower("Insert_Status") !=''hold'') or ('''||drpstatus||''' =''includehold'' and lower("Insert_Status") !=''cancel''))
        and ((tbl_booking_insert."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id='''||puserid||''') and '''||chk_access||'''=''1'')
        or  ('''||chk_access||'''=''0'') )';

else

    query1:='SELECT TBL_BOOKING_MAST ."cio_booking_id" AS "CIOID",
    AGENCY_MAST."Agency_Name" AS "Agency",
    NVL((SELECT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code"="Client_code" and tbl_booking_mast."Comp_code"=cust_mast."Comp_Code" ),"Client_code")  AS "Client",
    multipack_rep.PACK  AS "Package",
    COL_MAST ."Col_Alias" AS "Hue",
    TBL_BOOKING_MAST."Card_rate" AS "CardRate",
    NVL("Agrred_rate",TBL_BOOKING_MAST."Card_rate") AS "AgreedRate",
    tbl_booking_insert."Status_Material" as "InsertStatus",
    TBL_BOOKING_MAST."Caption" as "Caption",
    TBL_BOOKING_MAST."Key_no" as "Key_no",
    TBL_BOOKING_INSERT."Edition" as "edition",
    TBL_BOOKING_MAST."RO_No" as "RO_No",
    (select ADVPOS_PREM_MAST."premiumname" from advpos_prem_mast where ADVPOS_PREM_MAST."Premiumcode"=TBL_BOOKING_INSERT."Premium1" and ADVPOS_PREM_MAST."comp_code"=tbl_booking_insert."Comp_Code" ) as "PagePremium",
    (select advpos_type_mast."Pos_Type" from advpos_type_mast where advpos_type_mast."Pos_Type_Code"=tbl_booking_insert."Page_Post" and advpos_type_mast."Comp_Code"=tbl_booking_insert."Comp_Code" ) as "PosPremium",
    round(TBL_BOOKING_insert."Size_Book",2) AS "Area",
    TBL_BOOKING_MAST."Bill_remarks" AS "Spl Instruction",
    CASE '''||dateformat||'''
    WHEN ''mm/dd/yyyy'' THEN TO_CHAR("Insert_Date",''MM-DD-YY'')
    WHEN ''dd/mm/yyyy'' THEN TO_CHAR("Insert_Date",''DD-MM-YY'')
    WHEN ''yyyy/mm/dd'' THEN TO_CHAR("Insert_Date",''YY-MM-DD'') END
     AS "Ins.date" ,
    tbl_booking_insert."Width"  AS "Width",
    tbl_booking_insert."Height" AS "Depth"
    ,(SELECT ADV_CAT_MAST."Adv_Cat_Name" FROM ADV_CAT_MAST WHERE ADV_CAT_MAST."Adv_Cat_Code"=tbl_booking_insert."Ad_Cat" and ADV_CAT_MAST."Comp_Code"=tbl_booking_insert."Comp_Code" ) as "Adcat",
     (select ADV_SUBCAT_MAST."Adv_Subcat_Name"   FROM ADV_SUBCAT_MAST WHERE  ADV_SUBCAT_MAST."Adv_Subcat_Code"=tbl_booking_insert."Ad_Sub_Cat" and ADV_SUBCAT_MAST."Comp_Code"=tbl_booking_insert."Comp_Code" ) AS "AdSubcat",
     (select AD_CAT3."catname"   FROM AD_CAT3 WHERE  AD_CAT3."catcode"=tbl_booking_mast."Ad_Subcat3" and AD_CAT3."compcode"=tbl_booking_mast."Comp_code" ) AS "AdSubcat3",
    TBL_BOOKING_INSERT."Page_No" as "Pageno",
    TBL_BOOKING_MAST."Paid_ins" as "Paidins",
    TBL_BOOKING_MAST."Rate_code" as ratecd,
    UOM_MAST."Uom_Name"  AS "Uom",
    (select uom_mast.UOM_DESC from uom_mast where tbl_booking_mast."Uom_code"=uom_mast."Uom_Code" and tbl_booking_mast."Comp_code"=uom_mast."Comp_Code"  )as "uomdesc"
    ,TBL_BOOKING_MAST."Booking_type" AS "booktype"
    ,tbl_booking_mast."audit" as "audit"
    ,tbl_booking_insert."File_Name" as "FILE_NAME",TBL_BOOKING_MAST.APP_STATUS as "APP_STATUS",tbl_booking_insert."No_Insert" as "NO_INSERT",
    (select distinct "Branch_Name" from branch_mst where "Branch_Code"=TBL_BOOKING_MAST."branch") as "BRANCH_NAME"
    FROM TBL_BOOKING_MAST,TBL_BOOKING_INSERT,AGENCY_MAST ,multipack_rep,COL_MAST,UOM_MAST
    WHERE TBL_BOOKING_MAST."Comp_code"='''||compcode||'''AND
    TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id" AND
    tbl_booking_mast."Comp_code"=tbl_booking_insert."Comp_Code" and
    TBL_BOOKING_MAST."Agency_sub_code"=AGENCY_MAST."code_subcode" AND
    TBL_BOOKING_insert."Col_Code"=COL_MAST."Col_Code"
    and  multipack_rep.CIOID=tbl_booking_mast."cio_booking_id"
    and sess_id='||userenv('sessionid')||'
    and lower("Insert_Status") !=''cancel''
    and lower("Insert_Status") !=''hold''
    and  UOM_MAST."Uom_Code"=TBL_BOOKING_MAST."Uom_code"
    and "cio_booking_id" not in(select distinct "prev_cioid" from tbl_booking_mast where "prev_cioid" is not null) 
    and ((tbl_booking_insert."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id='''||puserid||''') and '''||chk_access||'''=''1'')
    or  ('''||chk_access||'''=''0'') ) ';

end if;

else
if(drpstatus ='includecancel' or drpstatus ='includehold') then

    query1:='SELECT distinct TBL_BOOKING_MAST ."cio_booking_id" AS "CIOID",
    AGENCY_MAST."Agency_Name" AS "Agency",
    NVL((SELECT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code"="Client_code" and tbl_booking_mast."Comp_code"=cust_mast."Comp_Code" ),"Client_code")  AS "Client",
    multipack_rep.PACK  AS "Package",
    COL_MAST ."Col_Alias" AS "Hue",
    TBL_BOOKING_MAST."Card_rate" AS "CardRate",
    NVL("Agrred_rate",TBL_BOOKING_MAST."Card_rate") AS "AgreedRate",
    tbl_booking_insert."Status_Material" as "InsertStatus",
    TBL_BOOKING_MAST."Caption" as "Caption",
    TBL_BOOKING_MAST."Key_no" as "Key_no",
    TBL_BOOKING_MAST."RO_No" as "RO_No",
    (select ADVPOS_PREM_MAST."premiumname" from advpos_prem_mast where ADVPOS_PREM_MAST."Premiumcode"=TBL_BOOKING_INSERT."Premium1" and ADVPOS_PREM_MAST."comp_code"=tbl_booking_insert."Comp_Code" ) as "PagePremium",
    (select advpos_type_mast."Pos_Type" from advpos_type_mast where advpos_type_mast."Pos_Type_Code"=tbl_booking_insert."Page_Post" and advpos_type_mast."Comp_Code"=tbl_booking_insert."Comp_Code" ) as "PosPremium",
    round(TBL_BOOKING_insert."Size_Book",2) AS "Area",
    TBL_BOOKING_MAST."Bill_remarks" AS "Spl Instruction",
    CASE '''||dateformat||'''
    WHEN ''mm/dd/yyyy'' THEN TO_CHAR("Insert_Date",''MM-DD-YY'')
    WHEN ''dd/mm/yyyy'' THEN TO_CHAR("Insert_Date",''DD-MM-YY'')
    WHEN ''yyyy/mm/dd'' THEN TO_CHAR("Insert_Date",''YY-MM-DD'') END AS "Ins.date" ,
    tbl_booking_insert."Width"  AS "Width",
    tbl_booking_insert."Height" AS "Depth"
    ,(SELECT ADV_CAT_MAST."Adv_Cat_Name" FROM ADV_CAT_MAST WHERE ADV_CAT_MAST."Adv_Cat_Code"=tbl_booking_insert."Ad_Cat" and ADV_CAT_MAST."Comp_Code"=tbl_booking_insert."Comp_Code" ) as "Adcat",
     (select ADV_SUBCAT_MAST."Adv_Subcat_Name"   FROM ADV_SUBCAT_MAST WHERE  ADV_SUBCAT_MAST."Adv_Subcat_Code"=tbl_booking_insert."Ad_Sub_Cat" and ADV_SUBCAT_MAST."Comp_Code"=tbl_booking_insert."Comp_Code" ) AS "AdSubcat",
     (select AD_CAT3."catname"   FROM AD_CAT3 WHERE  AD_CAT3."catcode"=tbl_booking_mast."Ad_Subcat3" and AD_CAT3."compcode"=tbl_booking_mast."Comp_code" ) AS "AdSubcat3",
    TBL_BOOKING_INSERT."Page_No" as "Pageno",
    TBL_BOOKING_MAST."Paid_ins" as "Paidins",
    TBL_BOOKING_MAST."Rate_code" as ratecd,
    UOM_MAST."Uom_Name"  AS "Uom",
    (select uom_mast.UOM_DESC from uom_mast where tbl_booking_mast."Uom_code"=uom_mast."Uom_Code" and tbl_booking_mast."Comp_code"=uom_mast."Comp_Code"  )as "uomdesc"
    ,TBL_BOOKING_MAST."Booking_type" AS "booktype"
    ,tbl_booking_mast."audit" as "audit"
    ,tbl_booking_insert."File_Name" as "FILE_NAME",TBL_BOOKING_MAST.APP_STATUS as "APP_STATUS",tbl_booking_insert."No_Insert" as "NO_INSERT"
    FROM TBL_BOOKING_MAST,TBL_BOOKING_INSERT,AGENCY_MAST ,multipack_rep,COL_MAST,UOM_MAST
    WHERE TBL_BOOKING_MAST."Comp_code"='''||compcode||'''AND
    TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id" AND
    tbl_booking_mast."Comp_code"=tbl_booking_insert."Comp_Code" and
    TBL_BOOKING_MAST."Agency_sub_code"=AGENCY_MAST."code_subcode" AND
    TBL_BOOKING_insert."Col_Code"=COL_MAST."Col_Code" AND
     UOM_MAST."Uom_Code"=TBL_BOOKING_MAST."Uom_code"
    and  multipack_rep.CIOID=tbl_booking_mast."cio_booking_id"
    and sess_id='||userenv('sessionid')||'
    and "cio_booking_id" not in(select distinct "prev_cioid" from tbl_booking_mast where "prev_cioid" is not null)
    and (('''||drpstatus||''' =''includecancel'' and  lower("Insert_Status") !=''hold'') or ('''||drpstatus||''' =''includehold'' and lower("Insert_Status") !=''cancel''))
    and ((tbl_booking_insert."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id='''||puserid||''') and '''||chk_access||'''=''1'')
    or  ('''||chk_access||'''=''0'') )';

else

    query1:='SELECT distinct TBL_BOOKING_MAST ."cio_booking_id" AS "CIOID",
    AGENCY_MAST."Agency_Name" AS "Agency",
    NVL((SELECT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code"="Client_code" and tbl_booking_mast."Comp_code"=cust_mast."Comp_Code" ),"Client_code")  AS "Client",
    multipack_rep.PACK  AS "Package",
    COL_MAST ."Col_Alias" AS "Hue",
    TBL_BOOKING_MAST."Card_rate" AS "CardRate",
    NVL("Agrred_rate",TBL_BOOKING_MAST."Card_rate") AS "AgreedRate",
    tbl_booking_insert."Status_Material" as "InsertStatus",
    TBL_BOOKING_MAST."Caption" as "Caption",
    TBL_BOOKING_MAST."Key_no" as "Key_no",
    TBL_BOOKING_MAST."RO_No" as "RO_No",
    (select ADVPOS_PREM_MAST."premiumname" from advpos_prem_mast where ADVPOS_PREM_MAST."Premiumcode"=TBL_BOOKING_INSERT."Premium1" and ADVPOS_PREM_MAST."comp_code"=tbl_booking_insert."Comp_Code" ) as "PagePremium",
    (select advpos_type_mast."Pos_Type" from advpos_type_mast where advpos_type_mast."Pos_Type_Code"=tbl_booking_insert."Page_Post" and advpos_type_mast."Comp_Code"=tbl_booking_insert."Comp_Code" ) as "PosPremium",
    round(TBL_BOOKING_insert."Size_Book",2) AS "Area",
    TBL_BOOKING_MAST."Bill_remarks" AS "Spl Instruction",
    CASE '''||dateformat||'''
    WHEN ''mm/dd/yyyy'' THEN TO_CHAR("Insert_Date",''MM-DD-YY'')
    WHEN ''dd/mm/yyyy'' THEN TO_CHAR("Insert_Date",''DD-MM-YY'')
    WHEN ''yyyy/mm/dd'' THEN TO_CHAR("Insert_Date",''YY-MM-DD'') END
     AS "Ins.date" ,
    tbl_booking_insert."Width"  AS "Width",
    tbl_booking_insert."Height" AS "Depth"
    ,(SELECT ADV_CAT_MAST."Adv_Cat_Name" FROM ADV_CAT_MAST WHERE ADV_CAT_MAST."Adv_Cat_Code"=tbl_booking_insert."Ad_Cat" and ADV_CAT_MAST."Comp_Code"=tbl_booking_insert."Comp_Code" ) as "Adcat",
     (select ADV_SUBCAT_MAST."Adv_Subcat_Name"   FROM ADV_SUBCAT_MAST WHERE  ADV_SUBCAT_MAST."Adv_Subcat_Code"=tbl_booking_insert."Ad_Sub_Cat" and ADV_SUBCAT_MAST."Comp_Code"=tbl_booking_insert."Comp_Code" ) AS "AdSubcat",
     (select AD_CAT3."catname"   FROM AD_CAT3 WHERE  AD_CAT3."catcode"=tbl_booking_mast."Ad_Subcat3" and AD_CAT3."compcode"=tbl_booking_mast."Comp_code" ) AS "AdSubcat3",
    TBL_BOOKING_INSERT."Page_No" as "Pageno",
    TBL_BOOKING_MAST."Paid_ins" as "Paidins",
    TBL_BOOKING_MAST."Rate_code" as ratecd,
    UOM_MAST."Uom_Name"  AS "Uom",
    (select uom_mast.UOM_DESC from uom_mast where tbl_booking_mast."Uom_code"=uom_mast."Uom_Code" and tbl_booking_mast."Comp_code"=uom_mast."Comp_Code"  )as "uomdesc"
    ,TBL_BOOKING_MAST."Booking_type" AS "booktype"
    ,tbl_booking_mast."audit" as "audit"
    ,tbl_booking_insert."File_Name" as "FILE_NAME",TBL_BOOKING_MAST.APP_STATUS as "APP_STATUS",tbl_booking_insert."No_Insert" as "NO_INSERT",
    (select distinct "Branch_Name" from branch_mst where "Branch_Code"=TBL_BOOKING_MAST."branch") as "BRANCH_NAME"
    FROM TBL_BOOKING_MAST,TBL_BOOKING_INSERT,AGENCY_MAST ,multipack_rep,COL_MAST,UOM_MAST
    WHERE TBL_BOOKING_MAST."Comp_code"='''||compcode||'''AND
    TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id" AND
    tbl_booking_mast."Comp_code"=tbl_booking_insert."Comp_Code" and
    TBL_BOOKING_MAST."Agency_sub_code"=AGENCY_MAST."code_subcode" AND
    TBL_BOOKING_insert."Col_Code"=COL_MAST."Col_Code"
    and  multipack_rep.CIOID=tbl_booking_mast."cio_booking_id"
    and sess_id='||userenv('sessionid')||'
    and lower("Insert_Status") !=''cancel''
    and lower("Insert_Status") !=''hold''
    and  UOM_MAST."Uom_Code"=TBL_BOOKING_MAST."Uom_code"
    and "cio_booking_id" not in(select distinct "prev_cioid" from tbl_booking_mast where "prev_cioid" is not null)
    and ((tbl_booking_insert."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id='''||puserid||''') and '''||chk_access||'''=''1'')
    or  ('''||chk_access||'''=''0'') )';

end if;
end if;


IF(fromdate IS NOT NULL AND dateto IS NOT NULL ) THEN
    query1:=query1||' AND TBL_BOOKING_INSERT."Insert_Date" BETWEEN '''||fromdate||''' AND '''||dateto||''' ';
END IF;


IF(pub_name IS NOT NULL )THEN
    query1:=query1||' AND TBL_BOOKING_INSERT."Publication_Code"='''||pub_name||'''';
END IF;

IF(p_branch IS NOT NULL )THEN
    query1:=query1||' AND TBL_BOOKING_MAST."branch"='''||p_branch||'''';
END IF;

IF(pub_cent IS NOT NULL) THEN
    query1:=query1||'  AND TBL_BOOKING_INSERT."Pub_Cent_Code"='''||pub_cent||'''';
END IF;


IF(adtyp IS NOT NULL) THEN
    query1:=query1|| ' AND TBL_BOOKING_MAST."Ad_type_code"='''||Adtyp||''' ';
END IF;

IF(adcatg IS NOT NULL) THEN
    query1:=query1|| ' AND tbl_booking_insert."Ad_Cat" in ('''||adcatg||''' )';
END IF;

IF(edition_name IS NOT NULL ) THEN
    query1:=query1||'  AND TBL_BOOKING_INSERT."Edition_Code"='''||edition_name||'''';
END IF;

IF(supplement_name IS NOT NULL ) THEN
    query1:=query1||' AND (TBL_BOOKING_insert."Supp_Code" ='''||supplement_name||''' )';
END IF;

IF(packagecode IS NOT NULL ) THEN
    query1:=query1||' AND ('''||packagecode||''' in (tbl_booking_mast."Package_code") )';
END IF;

if(packagecode is null)then

    IF(descid IS NOT  NULL) THEN
        query1:=query1||'  order by "'||descid||'",TBL_BOOKING_INSERT."Edition"';
        query1:=query1||''||ascdesc||'';
    else
        query1:=query1||' order by TBL_BOOKING_INSERT."Edition",TBL_BOOKING_MAST."cio_booking_id"';
    END IF;

else
    IF(descid IS NOT  NULL) THEN
        query1:=query1||'  order by "'||descid||'"';
        query1:=query1||''||ascdesc||'';
    else
        query1:=query1||' order by TBL_BOOKING_MAST."cio_booking_id"';
    END IF;
end if;
delete from searchtbl;insert into searchtbl values(query1); commit;

OPEN p_accounts FOR query1;

OPEN p_accounts1 FOR
select "Edition_Alias"  as "Editions"  from edition_mast where ("Pub_Code"=pub_name or pub_name is null)  and "Edition_Type"='Main Edition';

OPEN p_accounts2 FOR
select sysdate from dual;
/*SELECT 
CASE dateformat
WHEN 'mm/dd/yyyy' THEN TO_CHAR("Insert_Date",'MM-DD-YY')
WHEN 'dd/mm/yyyy' THEN TO_CHAR("Insert_Date",'DD-MM-YY')
WHEN 'yyyy/mm/dd' THEN TO_CHAR("Insert_Date",'YY-MM-DD') END as "Insdate"
,TBL_BOOKING_INSERT."Edition" from TBL_BOOKING_INSERT
where  TBL_BOOKING_INSERT."Edition"
in (select "Edition_Alias"  as "Editions"
from edition_mast where ("Pub_Code"=pub_name or pub_name is null));*/


OPEN p_accounts3 FOR
select PACK, TOT from  MULTIPAGE_BREAK where  sess_id=userenv('sessionid') order by PACK,TOT desc;

OPEN  p_accounts4 FOR
SELECT SYSDATE,initcap("Comp_Name") from comp_mst where "Comp_Code"=compcode;

delete from multipack_rep where sess_id=userenv('sessionid')  ;
delete from multipack_rat where sess_id=userenv('sessionid') ;
DELETE FROM multipack_ratnew where sess_id=userenv('sessionid')  ; 
DELETE FROM MULTIPAGE_BREAK where sess_id=userenv('sessionid')  ;commit;
END ;
/





//==============**********6306***********Start Scripting****************==================//
CREATE OR REPLACE PROCEDURE WEBSP_GETPAGEPOSITION_DATEWISE
(
compcode        IN VARCHAR2,
bookingdate     in date,
p_accounts      OUT Cur_Type_New1.cursor_type
)
AS
BEGIN
OPEN p_accounts FOR
         SELECT "Pos_Type_Code", "Pos_Type" FROM advpos_type_mast
          WHERE "Comp_Code" = compcode and bookingdate between FROM_DATE and "TO_DATE" order by "Pos_Type";


END;
/
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PACKAGE getpageamount
IS
   TYPE t_accounts_cursor IS REF CURSOR;

   PROCEDURE  getpageamount_p (
    compcode     IN       VARCHAR2,
	pagecode     in VARCHAR2,
	--bookingdate     in date,
      p_accounts   OUT      t_accounts_cursor
   );
END getpageamount;
/

CREATE OR REPLACE PACKAGE BODY getpageamount
IS
   PROCEDURE  getpageamount_p (

     compcode     IN       VARCHAR2,
	  pagecode in VARCHAR2,
      --bookingdate     in date,
      p_accounts   OUT      t_accounts_cursor
   )
   AS
   BEGIN
      OPEN p_accounts FOR
         select "Amount","Premium" from advpos_type_mast where ("Pos_Type_Code"=pagecode) and ("Comp_Code"=compcode);
   END  getpageamount_p;
END getpageamount;
/

//==================================*******6306*****End*********************==================//


@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ 5584,6349,6022@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@


                                                                     
                                                                     
                                                                     
                                             
ALTER procedure completereport(
	@compcode		as varchar(50)= NULL,
	@fromdate		as varchar(50)= NULL,
	@dateto			as varchar(50)= NULL,
	@dateformat		as varchar(50)= NULL,
	@publication	as varchar(50)= NULL,
	@pub_cent		as varchar(50)= NULL,
	@edition		as varchar(50)= NULL,
	@suppliment		as varchar(50)= NULL,
	@zone			as varchar(50)= NULL,
	@branch			as varchar(50)= NULL,
	@district		as varchar(50)= NULL,
	@region			as varchar(50)= NULL,
	@city			as varchar(50)= NULL,
	@revcenter		as varchar(50)= NULL,
	@adtype			as varchar(50)= NULL,
	@agencytype		as varchar(50)= NULL,
	@ratetype		as varchar(50)= NULL,
	@adcat			as varchar(50)= NULL,
	@adsubcat		as varchar(50)= NULL,
	@adsubcat3		as varchar(50)= NULL,
	@adsubcat4		as varchar(50)= NULL,
	@adsubcat5		as varchar(50)= NULL,
	@package		as varchar(50)= NULL,
	@scheme			as varchar(50)= NULL,
	@agency			as varchar(50)= NULL,
	@client			as varchar(50)= NULL,
	@executive		as varchar(50)= NULL,
	@retainer		as varchar(50)= NULL,
	@product		as varchar(50)= NULL,
	@brand			as varchar(50)= NULL,
	@varient		as varchar(50)= NULL,
	@pagetype		as varchar(50)= NULL,
	@pageprem		as varchar(50)= NULL,
	@postprem		as varchar(50)= NULL,
	@rostatus		as varchar(50)= NULL,
	@booktype		as varchar(50)= NULL,
	@contractname	as varchar(50)= NULL,
	@filterby		as varchar(50)= NULL,
	@adcheck		as varchar(50)=null,
	@state			as varchar(50)=null,
	@taluka			as varchar(50)=null,
	@base			as varchar(50)=null,
	@drpstatus		as varchar(50)=null,
	@chkdetail		as varchar(50)=null,
	@insertstatus	as varchar(50)=null,
	@puserid		as varchar(50)=null,
	@p_baxcode      as varchar(20)=null,
	@chk_access		as varchar(2)=null)
AS
declare @query1 as VARCHAR(8000)
declare @v_val  as int
declare @query2 as VARCHAR(8000)
declare @query4 as VARCHAR(8000)
declare @query3 as VARCHAR(8000)

declare @bookdate as VARCHAR(50)
declare @noinsert as VARCHAR(50)
declare @Paidinsert as VARCHAR(50)
declare @Area as VARCHAR(50)
declare @Pagepremium as VARCHAR(50)
declare @cardamt as VARCHAR(50)
declare @Deviationamt as VARCHAR(50)
declare @Deviationper as VARCHAR(50)
declare @aggamt as VARCHAR(50)
declare @DiscAmt as VARCHAR(50)
declare @Discper as VARCHAR(50)
declare @posamt as VARCHAR(50)
declare @posper as VARCHAR(50)
declare @Spdiscamt as VARCHAR(50)
declare @Spdiscper as VARCHAR(50)
declare @Spacedisc as VARCHAR(50)
declare @Spacediscper as VARCHAR(50)
declare @Specialcharge as VARCHAR(50)
declare @AgencyAddlTDper as VARCHAR(50)
declare @AgencyAddlTDAmt as VARCHAR(50)
declare @Grossamt as VARCHAR(50)
declare @RetTDper as VARCHAR(50)
declare @RetTDAmt as VARCHAR(50)
declare @AgencyTDper as VARCHAR(50)
declare @AgencyTDAmt as VARCHAR(50)
declare @Billamt as VARCHAR(50)
declare @RetCommper as VARCHAR(50)
declare @RetCommAmt as VARCHAR(50)
declare @ActualBusines as VARCHAR(50)
----------------------------------------
declare @v_edition  as VARCHAR(100)
declare @v_edipkg  as VARCHAR(500)
declare @prefer    as VARCHAR(10)
declare @v_frdt as varchar(10)
declare @v_todt as varchar(10)
-----------cursor variables--------------
declare @c1cioid as varchar(50)
declare @c1pckcode as varchar(50)
declare @c1gramt as float
declare @c1chkvar as varchar(4)
/********************************for billing***********************************************/
declare @v2_CIOID as varchar(100)
declare @v2_BILLNO as varchar(100) 
declare @v2_AGMAINCODE as varchar(100) 
declare @v2_AG_SUB_CODE as varchar(100)
declare @v2_AGCODE as varchar(100)
declare @v2_AGNAME as varchar(200)
declare @v2_EXECCODE as varchar(100)
declare @v2_EXECNAME as varchar(200)
declare @v2_RETCODE as varchar(100)
declare @v2_RETNAME as varchar(200)
declare @q_n as varchar(8000)


/*********************************for billing************************************************/
/*
CREATE TABLE #TEMP_COMPLETE_DYNAMIC_REPORT(  ROW_CODE    VARCHAR(50),  ROW_DESC    VARCHAR(150),  COL_CODE    VARCHAR(50),  COL_DESC    VARCHAR(150),  COL_BILAMT  float,  COL_ACTAMT  float)
CREATE TABLE #MULTIPACK_REP(  CIOID  VARCHAR(500),  PACK   VARCHAR(500))
CREATE TABLE #MULTIPACK_RAT(  CIOID    VARCHAR(500),  RAT      VARCHAR(500),  PER_AMT  int)
CREATE TABLE #MULTIPACK_RATNEW(  CIOID    VARCHAR(500),  RAT      VARCHAR(500),  PER_AMT  int)
*/
create table #temp_ad_bills_report 
( CIOID             varchar(50),
  BILLNO            varchar(25),
  AGENCY            varchar(50),
  CLIENT            varchar(200),
  RONO              varchar(40),
  RODATE            DATEtime,
  EXECUTIVE         varchar(50),
  RETAINER          varchar(80),
  BOOKTYPE          varchar(8),
  COLOR             varchar(20),
  ADCAT             varchar(50),
  ADSUBCAT          varchar(50),
  ADSUBCAT3         varchar(50),
  ADSUBCAT4         varchar(50),
  ADSUBCAT5         varchar(50),
  PACKAG            varchar(500),
  BILLDATE          DATEtime,
  NOINSERT          int,
  PAIDINSERT        int,
  HEIGHT            int,
  WIDTH             int,
  AREA              int,
  PAGEPREMIUM       varchar(30),
  POSTPREM          varchar(30),
  SCHEME            varchar(50),
  RATECOD           varchar(40),
  CARDRATE          FLOAT,
  CARDAMT           FLOAT,
  CONTRACTRATE      int,
  DEVIATIONAMT      int,
  DEVIATIONPER      int,
  AGGRATE           int,
  AGGAMT            int,
  DISCAMT           FLOAT,
  DISCPER           int,
  POSAMT            int,
  POSPER            int,
  SPDISCAMT         int,
  SPDISCPER         int,
  SPACEDISC         int,
  SPACEDISCPER      int,
  SPECIALCHARGE     int,
  AGENCYADDLTDPER   varchar(8),
  AGENCYADDLTDAMT   int,
  GROSSAMT          int,
  RETTDPER          int,
  RETTDAMT          int,
  AGENCYTDPER       int,
  AGENCYTDAMT       int,
  BILLAMT           int,
  RETCOMMPER        int,
  RETCOMMAMT        int,
  ACTUALBUSINESS    int,
  REVCENTER         varchar(50),
  UOM               varchar(20),
  UOMDESC           varchar(50),
  COMP_CODE         varchar(10),
  PADTYPE           varchar(20),
  PRIPUB            varchar(10),
  PEDITION          varchar(50),
  BRANCH_NAME       varchar(50),
  PUB_CENT_CODE     varchar(50),
  REGION            varchar(12),
  AGENCY_TYPE_CODE  varchar(10),
  PRIADCTG          varchar(40),
  SECADCTG          varchar(40),
  AD_SUBCAT3        varchar(15),
  AD_SUBCAT4        varchar(15),
  AD_SUBCAT5        varchar(15),
  PACKAGE_CODE      varchar(500),
  AG_MAIN_CODE      varchar(10),
  AG_SUB_CODE       varchar(10),
  CLIENTCD          varchar(200),
  EXECUTIVE_NAME    varchar(100),
  PRIPROCTG         varchar(10),
  BRAND_CODE        varchar(10),
  VARIENT_NAME      varchar(25),
  PAGE_PREM         varchar(10),
  PAGE_POST         varchar(10),
  CONTRACT_NAME     varchar(50),
  SUPP_CODE         varchar(50),
  RETAINER_CODE     varchar(10),
  RATECD            varchar(40),
  CITY_CODE         varchar(20),
  ZONE_CODE         varchar(20),
  DIST_CODE         varchar(20),
  STATE_CODE        varchar(20),
  PTALUKA           varchar(20),
  PSCHEME           varchar(18),
  REVENUE_CENTER    varchar(10),
  RO_STATUS         varchar(10),
  PAGE_TYPE         varchar(100),
  BOOKING_TYPE      varchar(10),
  PUB_CENT_PERMIT   varchar(50),
  SESS_ID           int                      ,
  DIST_NAME         varchar(50),
  TALU_NAME         varchar(50),
  PUB_CENT_NAME     varchar(50),
  CITY_NAME         varchar(30),
  ZONE_NAME         varchar(30),
  STATE_NAME        varchar(30),
PAGE_NO int

)
declare c1 cursor for
		SELECT distinct TBL_BOOKING_mast.cio_booking_id AS "CIOID",
		TBL_BOOKING_MAST.Package_code as "package_code",TBL_BOOKING_mast.Gross_amount as "Crate",'1' as "chk_var"
		FROM TBL_BOOKING_MAST, TBL_BOOKING_INSERT
		WHERE TBL_BOOKING_MAST.Comp_code=@compcode
		AND TBL_BOOKING_MAST.cio_booking_id=TBL_BOOKING_INSERT.Cio_Booking_Id
		AND ((tbl_booking_mast.Insertion_date BETWEEN @fromdate AND @dateto and @filterby='Publish Date') or (tbl_booking_mast.date_time BETWEEN @fromdate AND @dateto and @filterby='Booking Date'))
		AND (TBL_BOOKING_INSERT.Publication_Code=@publication or @publication is null)
		--and TBL_BOOKING_MAST.branch IN (SELECT Branch_Name FROM BRANCH_MST WHERE TBL_BOOKING_MAST.branch=Branch_Name and pub_center in (SELECT Pub_cent_Code FROM PUB_CENT_MAST WHERE  branch_mst.pub_center=pub_cent_mast.Pub_cent_Code and Pub_cent_Code=@pub_cent or @pub_cent is null))
		and TBL_BOOKING_MAST."branch" IN (SELECT  "Branch_Code" FROM BRANCH_MST WHERE TBL_BOOKING_MAST."branch"="Branch_Code" and "pub_center" in (SELECT  "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"=@pub_cent or @pub_cent is null))
		and((@branch is null) or  (tbl_booking_mast."branch" = (SELECT "Branch_Code" FROM BRANCH_MST where "Branch_Name" =@branch) ))

		AND (TBL_BOOKING_MAST.Ad_type_code=@adtype or @adtype is null)
		AND (TBL_BOOKING_MAST.Ad_cat_code=@adcat or @adcat is null)
		AND (TBL_BOOKING_INSERT.Edition_Code=@edition or @edition is null)
		and (tbl_booking_mast.branch =@branch or @branch is null)
		and (TBL_BOOKING_MAST.Agency_sub_code  in (select AGENCY_MAST.code_subcode from agency_mast where agency_mast.region =@region  or @region is null))
		and (tbl_booking_mast.Revenue_center =@revcenter or @revcenter is null)
		and (TBL_BOOKING_MAST.Agency_type =@agencytype or @agencytype is null)
		and (TBL_BOOKING_MAST.Ad_sub_cat_code =@adsubcat or @adsubcat is null)
		and (TBL_BOOKING_MAST.Ad_Subcat3 =@adsubcat3 or @adsubcat3 is null)
		and (TBL_BOOKING_MAST.Ad_Subcat4 =@adsubcat4 or @adsubcat4 is null or @adsubcat4='')
		and (TBL_BOOKING_MAST.Ad_subcat5 =@adsubcat5 or @adsubcat5 is null or @adsubcat5='')
		and (TBL_BOOKING_MAST.Package_code =@package or @package is null)
		and (TBL_BOOKING_MAST.Scheme_type_code =@scheme or @scheme is null)
		and (TBL_BOOKING_MAST.Agency_code =@agency or @agency is null)
		and (TBL_BOOKING_MAST.Client_code =@client or @client is null)
		and (TBL_BOOKING_MAST.Executive_code =@executive or @executive is null)
		and (TBL_BOOKING_MAST.RETAINER =@retainer or @retainer is null)
		and (TBL_BOOKING_MAST.Product_code =@product  or @product is null)
		and (TBL_BOOKING_MAST.Brand_code =@brand or @brand is null)
		and (TBL_BOOKING_MAST.Variant_code =@varient or @varient is null)
		and (TBL_BOOKING_MAST.Page_type_code =@pagetype or @pagetype is null)
		and (TBL_BOOKING_MAST.Page_prem =@pageprem or @pageprem is null)
		and (TBL_BOOKING_MAST.Page_position_code =@postprem or @postprem is null)
		and (TBL_BOOKING_MAST.ro_status =@rostatus or @rostatus is null)
		and (TBL_BOOKING_MAST.Booking_type =@booktype or @booktype is null)
		and (TBL_BOOKING_MAST.Contract_name =@contractname or @contractname is null)
		and (tbl_booking_insert.Supp_Code =@suppliment or @suppliment is null)
		and (tbl_booking_MAST.Rate_code =@ratetype or @ratetype is null)
		and (tbl_booking_mast.Box_code = @p_baxcode or @p_baxcode is null)
		and ((@base='1' and TBL_BOOKING_MAST.Agency_sub_code  in (select AGENCY_MAST.code_subcode from agency_mast where AGENCY_MAST.City_Code =@city or @city is null))
		or (@base='2' and tbl_booking_mast.Executive_code  in(select exec_mast.Exe_no from exec_mast where exec_mast.city_code =@city or @city is null))
		or (@base='3' and tbl_booking_mast.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.City_Code=@city or @city is null)))
		and ((@base='1' and TBL_BOOKING_MAST.Agency_sub_code  in (select AGENCY_MAST.code_subcode from agency_mast where AGENCY_MAST.zone_code =@zone or @zone is null))
		or (@base='2' and tbl_booking_mast.Executive_code  in(select exec_mast.Exe_no from exec_mast where exec_mast.city_code in (select city_mst.City_Code from city_mst where city_mst.Zone_Code= @zone or @zone is null) ))
		or (@base='3' and tbl_booking_mast.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.Zone_Code=@zone or @zone is null)))
		and ((@base='1' and TBL_BOOKING_MAST.Agency_sub_code  in (select AGENCY_MAST.code_subcode from agency_mast where AGENCY_MAST.Dist_Code =@district or @district is null))
		or (@base='2' and tbl_booking_mast.Executive_code  in(select exec_mast.Exe_no from exec_mast where exec_mast.dist_code= @district or @district is null ))
		or (@base='3' and tbl_booking_mast.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.Dist_Code=@district or @district is null)))
		and ((@base='1' and TBL_BOOKING_MAST.Agency_sub_code  in (select AGENCY_MAST.code_subcode from agency_mast where AGENCY_MAST.State_Code =@state or @state is null))
		or (@base='2' and tbl_booking_mast.Executive_code  in(select exec_mast.Exe_no from exec_mast where exec_mast.State_code= @state or @state is null ))
		or (@base='3' and tbl_booking_mast.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.State_Code=@state or @state is null)))
		and ((@base='1' and TBL_BOOKING_MAST.Agency_sub_code  in (select AGENCY_MAST.code_subcode from agency_mast where AGENCY_MAST.TALUKA=@taluka or @taluka is null ))
		or (@base='2' and tbl_booking_mast.Executive_code  in(select exec_mast.Exe_no from exec_mast where exec_mast.TALUKA= @taluka or @taluka is null ))
		or (@base='3' and tbl_booking_mast.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.TALUKA=@taluka or @taluka is null)))
		and ((@base='1' and TBL_BOOKING_MAST.Agency_sub_code IS NOT NULL AND TBL_BOOKING_MAST.Agency_sub_code!='0')
		or (@base='2' and tbl_booking_mast.Executive_code    is not null and tbl_booking_mast.Executive_code !='0' )
		or (@base='3' and tbl_booking_mast.RETAINER is not null  and tbl_booking_mast.RETAINER !='0'))
		and ((@drpstatus is  not null and  TBL_BOOKING_INSERT.Insert_Status!='XYZ')
		or (@drpstatus is  null and  lower(Insert_Status)!='cancel'))
        and (lower(Insert_Status)=@insertstatus or @insertstatus is null)
      -- and ((tbl_booking_insert.Pub_Cent_Code in (select distinct pub_center from login_center where newuser_id=@puserid) and @chk_access='1')
      -- or  (@chk_access='0') )
		and @adcheck='1'
		union--************** union****************************
		SELECT distinct TBL_BOOKING_mast.cio_booking_id AS "CIOID",
		TBL_BOOKING_MAST.Package_code as "package_code",tbl_booking_insert.Gross_Rate as "Crate",'1' as "chk_var"
		FROM TBL_BOOKING_MAST, TBL_BOOKING_INSERT
		WHERE TBL_BOOKING_MAST.Comp_code=@compcode
		AND TBL_BOOKING_MAST.cio_booking_id=TBL_BOOKING_INSERT.Cio_Booking_Id
		AND (tbl_booking_insert.Insert_Date BETWEEN @fromdate AND @dateto )
		AND (TBL_BOOKING_INSERT.Publication_Code=@publication or @publication is null)
		--and TBL_BOOKING_MAST.branch IN (SELECT Branch_Name FROM BRANCH_MST WHERE TBL_BOOKING_MAST.branch=Branch_Name and pub_center in (SELECT Pub_cent_Code FROM PUB_CENT_MAST WHERE  branch_mst.pub_center=pub_cent_mast.Pub_cent_Code and Pub_cent_Code=@pub_cent or @pub_cent is null))

and TBL_BOOKING_MAST."branch" IN (SELECT "Branch_Code" FROM BRANCH_MST WHERE TBL_BOOKING_MAST."branch"="Branch_Code" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"=@pub_cent or @pub_cent is null))
and (tbl_booking_mast."branch" = (SELECT "Branch_Code" FROM BRANCH_MST where "Branch_Name" =@branch))

		AND (TBL_BOOKING_MAST.Ad_type_code=@adtype or @adtype is null)
		AND (TBL_BOOKING_insert.Ad_Cat=@adcat or @adcat is null)
		AND (TBL_BOOKING_INSERT.Edition_Code=@edition or @edition is null)
		and (tbl_booking_mast.branch =@branch or @branch is null)
		and (TBL_BOOKING_MAST.Agency_sub_code  in (select AGENCY_MAST.code_subcode from agency_mast where agency_mast.region =@region  or @region is null))
		and (tbl_booking_mast.Revenue_center =@revcenter or @revcenter is null)
		and (TBL_BOOKING_MAST.Agency_type =@agencytype or @agencytype is null)
		and (TBL_BOOKING_MAST.Ad_sub_cat_code =@adsubcat or @adsubcat is null)
		and (TBL_BOOKING_MAST.Ad_Subcat3 =@adsubcat3 or @adsubcat3 is null)
		and (TBL_BOOKING_MAST.Ad_Subcat4 =@adsubcat4 or @adsubcat4 is null)
		and (TBL_BOOKING_MAST.Ad_subcat5 =@adsubcat5 or @adsubcat5 is null)
		and (TBL_BOOKING_MAST.Package_code =@package or @package is null)
		and (TBL_BOOKING_MAST.Scheme_type_code =@scheme or @scheme is null)
		and (TBL_BOOKING_MAST.Agency_code =@agency or @agency is null)
		and (TBL_BOOKING_MAST.Client_code =@client or @client is null)
		and (TBL_BOOKING_MAST.Executive_code =@executive or @executive is null)
		and (TBL_BOOKING_MAST.RETAINER =@retainer or @retainer is null)
		and (TBL_BOOKING_MAST.Product_code =@product  or @product is null)
		and (TBL_BOOKING_MAST.Brand_code =@brand or @brand is null)
		and (TBL_BOOKING_MAST.Variant_code =@varient or @varient is null)
		and (TBL_BOOKING_MAST.Page_type_code =@pagetype or @pagetype is null)
		and (TBL_BOOKING_insert.Premium1 =@pageprem or @pageprem is null)
		and (tbl_booking_insert.Page_Post =@postprem or @postprem is null)
		and (TBL_BOOKING_MAST.ro_status =@rostatus or @rostatus is null)
		and (TBL_BOOKING_MAST.Booking_type =@booktype or @booktype is null)
		and (TBL_BOOKING_MAST.Contract_name =@contractname or @contractname is null)
		and (tbl_booking_insert.Supp_Code =@suppliment or @suppliment is null)
		and (tbl_booking_MAST.Rate_code =@ratetype or @ratetype is null)
		and (tbl_booking_mast.Box_code = @p_baxcode or @p_baxcode is null)
		and ((@base='1' and TBL_BOOKING_MAST.Agency_sub_code  in (select AGENCY_MAST.code_subcode from agency_mast where AGENCY_MAST.City_Code =@city or @city is null))
		or (@base='2' and tbl_booking_mast.Executive_code  in(select exec_mast.Exe_no from exec_mast where exec_mast.city_code =@city or @city is null))
		or (@base='3' and tbl_booking_mast.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.City_Code=@city or @city is null)))
		and ((@base='1' and TBL_BOOKING_MAST.Agency_sub_code  in (select AGENCY_MAST.code_subcode from agency_mast where AGENCY_MAST.zone_code =@zone or @zone is null))
		or (@base='2' and tbl_booking_mast.Executive_code  in(select exec_mast.Exe_no from exec_mast where exec_mast.city_code in (select city_mst.City_Code from city_mst where city_mst.Zone_Code= @zone or @zone is null) ))
		or (@base='3' and tbl_booking_mast.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.Zone_Code=@zone or @zone is null)))
		and ((@base='1' and TBL_BOOKING_MAST.Agency_sub_code  in (select AGENCY_MAST.code_subcode from agency_mast where AGENCY_MAST.Dist_Code =@district or @district is null))
		or (@base='2' and tbl_booking_mast.Executive_code  in(select exec_mast.Exe_no from exec_mast where exec_mast.dist_code= @district or @district is null ))
		or (@base='3' and tbl_booking_mast.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.Dist_Code=@district or @district is null)))
		and ((@base='1' and TBL_BOOKING_MAST.Agency_sub_code  in (select AGENCY_MAST.code_subcode from agency_mast where AGENCY_MAST.State_Code =@state or @state is null))
		or (@base='2' and tbl_booking_mast.Executive_code  in(select exec_mast.Exe_no from exec_mast where exec_mast.State_code= @state or @state is null ))
		or (@base='3' and tbl_booking_mast.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.State_Code=@state or @state is null)))
		and ((@base='1' and TBL_BOOKING_MAST.Agency_sub_code  in (select AGENCY_MAST.code_subcode from agency_mast where AGENCY_MAST.TALUKA=@taluka or @taluka is null) )  
		or (@base='2' and tbl_booking_mast.Executive_code  in(select exec_mast.Exe_no from exec_mast where exec_mast.TALUKA= @taluka or @taluka is null ))
		or (@base='3' and tbl_booking_mast.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.TALUKA=@taluka or @taluka is null)))
		and ((@base='1' and TBL_BOOKING_MAST.Agency_sub_code IS NOT NULL AND TBL_BOOKING_MAST.Agency_sub_code!='0')
		or (@base='2' and tbl_booking_mast.Executive_code    is not null and tbl_booking_mast.Executive_code !='0' )
		or (@base='3' and tbl_booking_mast.RETAINER is not null  and tbl_booking_mast.RETAINER !='0'))
		and ((@drpstatus is  not null and  TBL_BOOKING_INSERT.Insert_Status!='XYZ')
		or (@drpstatus is  null and  lower(Insert_Status)!='cancel'))
and (lower(Insert_Status)=@insertstatus or @insertstatus is null)
--and ((tbl_booking_insert.Pub_Cent_Code in (select distinct pub_center from login_center where newuser_id=@puserid) and @chk_access='1')
--or  (@chk_access='0') )
		and @adcheck='3'
		union--***********************Union*****************************
		SELECT distinct ad_bills.IDNUM AS "CIOID",
		ad_bills_det.PACKAGE_CODE as "package_code",ad_bills.GROSS_AMT as "Crate",'2' as "chk_var"
		FROM ad_bills, ad_bills_det
		WHERE ad_bills.IDNUM=ad_bills_det.IDNUM
		AND (ad_bills.BILDT between @fromdate and @dateto)
		and (ad_bills.PRIPUB=@publication  or @publication is null)
		and (ad_bills_det.EDITION=@edition or @edition is null)
		and (ad_bills.AGCODE in (select AGENCY_MAST.code_subcode from agency_mast where agency_mast.region =@region  or @region is null))
		and (ad_bills_det.AD_TYPE_V=@adtype or @adtype is null)
		and (ad_bills.AGCODE in (select AGENCY_MAST.code_subcode from agency_mast where agency_mast.Agency_Type_Code =@agencytype or @agencytype is null))
		and (ad_bills_det.PRIADCTG =@adcat or @adcat is null)
		and (ad_bills_det.SECADCTG =@adsubcat or @adsubcat is null)
		and (ad_bills_det.AD_SUBCAT3  =@adsubcat3 or @adsubcat3 is null)
		and (ad_bills_det.AD_SUBCAT4 =@adsubcat4 or @adsubcat4 is null)
		and (ad_bills_det.AD_SUBCAT5 =@adsubcat5 or @adsubcat5 is null)
		and (ad_bills_det.PACKAGE_CODE =@package or @package is null)
		--and (ad_bills.AGCODE =@agency  or @agency is null)
and (ad_bills.AGCODE in (select AGENCY_MAST.code_subcode from agency_mast where agency_mast.Agency_Code =@agency or @agency is null))
		and (ad_bills.CLIENTCD=@client or @client is null)
		and (ad_bills.EXECUTIVE_NAME=@executive or @executive is null)
		and (ad_bills.PRIPROCTG=@product or @product is null)
		and ((ad_bills.PRIPROCTG in (select brand_mst.prod_cat_code from brand_mst where brand_mst.brand_code=@brand or @brand is null) and ad_bills.PRIPROCTG is not null)or (ad_bills.PRIPROCTG is null))
		and ((ad_bills.PRIPROCTG in (select brand_mst.prod_cat_code from brand_mst where brand_mst.brand_code in(select varient_mst.Brand_Code from varient_mst where varient_mst.Varient_Name=@varient or @varient is null)) and ad_bills.PRIPROCTG is not null) or (ad_bills.PRIPROCTG is null))
		and (ad_bills_det.PAGE_PREM =@pageprem or @pageprem is null)
		and (ad_bills_det.PAGE_POST =@postprem or @postprem is null)
		and (ad_bills.CONTRACT_NAME =@contractname or @contractname is null)
		and (ad_bills_det.SUPP_CODE =@suppliment or @suppliment is null)
		and (ad_bills.RETAINER_CODE =@retainer or @retainer is null)
		and (ad_bills_det.RATECD =@ratetype or @ratetype is null)
		and ((ad_bills.UNIT  in(select branch_mst.Branch_Code from branch_mst where  branch_mst.Branch_Name =@branch or @branch is null) and ad_bills.UNIT is not null ) or (ad_bills.UNIT is not null))
		and ad_bills.UNIT IN (SELECT Branch_Code FROM BRANCH_MST WHERE ad_bills.UNIT=Branch_Code and pub_center in (SELECT Pub_cent_Code FROM PUB_CENT_MAST WHERE  branch_mst.pub_center=pub_cent_mast.Pub_cent_Code and Pub_cent_Code=@pub_cent or @pub_cent is null))
		and (ad_bills.SCHEME=@scheme or @scheme is null)
		and (AD_BILLS.REVENUE_CENTER =@revcenter or @revcenter is null)
		and (AD_BILLS.RO_STATUS =@rostatus or @rostatus is null)
		and (AD_BILLS.PAGE_TYPE =@pagetype or @pagetype is null)
		and (AD_BILLS.BOOKING_TYPE =@booktype or @booktype is null)
		and ((@base='1' and ad_bills.AGCODE in (select AGENCY_MAST.code_subcode from agency_mast where AGENCY_MAST.City_Code =@city or @city is null))
		or (@base='2' and ad_bills.EXECUTIVE_NAME in(select exec_mast.Exe_no from exec_mast where exec_mast.city_code =@city or @city is null))
		or (@base='3' and ad_bills.RETAINER_CODE in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.City_Code=@city or @city is null)))
		and ((@base='1' and ad_bills.AGCODE in (select AGENCY_MAST.code_subcode from agency_mast where AGENCY_MAST.zone_code =@zone or @zone is null))
		or (@base='2' and ad_bills.EXECUTIVE_NAME in(select exec_mast.Exe_no from exec_mast where exec_mast.city_code in (select city_mst.City_Code from city_mst where city_mst.Zone_Code= @zone or @zone is null) ))
		or (@base='3' and ad_bills.RETAINER_CODE in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.Zone_Code=@zone or @zone is null)))
		and ((@base='1' and ad_bills.AGCODE in (select AGENCY_MAST.code_subcode from agency_mast where AGENCY_MAST.Dist_Code =@district or @district is null))
		or (@base='2' and ad_bills.EXECUTIVE_NAME in(select exec_mast.Exe_no from exec_mast where exec_mast.dist_code= @district or @district is null ))
		or (@base='3' and ad_bills.RETAINER_CODE in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.Dist_Code=@district or @district is null)))
		and ((@base='1' and ad_bills.AGCODE in (select AGENCY_MAST.code_subcode from agency_mast where AGENCY_MAST.State_Code =@state or @state is null))
		or (@base='2' and ad_bills.EXECUTIVE_NAME in(select exec_mast.Exe_no from exec_mast where exec_mast.State_code= @state or @state is null ))
		or (@base='3' and ad_bills.RETAINER_CODE in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.State_Code=@state or @state is null)))
		and ((@base='1' and ad_bills.AGCODE   in (select AGENCY_MAST.code_subcode from agency_mast where AGENCY_MAST.TALUKA=@taluka or @taluka is null) )  
		or (@base='2' and ad_bills.EXECUTIVE_NAME   in(select exec_mast.Exe_no from exec_mast where exec_mast.TALUKA= @taluka or @taluka is null ))
		or (@base='3' and ad_bills.RETAINER_CODE  in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.TALUKA=@taluka or @taluka is null)))
		and ((@base='1' and ad_bills.AGCODE IS NOT NULL AND ad_bills.AGCODE!='0')
		or (@base='2' and ad_bills.EXECUTIVE_NAME   is not null and ad_bills.EXECUTIVE_NAME !='0' )
		or (@base='3' and ad_bills.RETAINER_CODE  is not null  and ad_bills.RETAINER_CODE !='0'))
       --and ((ad_bills_det.BKFOR in (select distinct pub_center from login_center where newuser_id=@puserid) and @chk_access='1')
       --or  (@chk_access='0') )
		and @adcheck='2'

declare  C2 Cursor for
SELECT distinct ad_bills.IDNUM AS "CIOID",ad_bills.BILNO as "BILLNO" ,ag_main_code as "AGMAINCODE",ag_sub_code as "AG_SUB_CODE",agcode as "AGCODE",
dbo.agename(@compcode,agcode) as "AGNAME",
isnull(executive_name,0) as "EXECCODE",
dbo.AD_GET_EXECNAME(@compcode,EXECUTIVE_NAME) as "EXECNAME",
RETAINER_CODE as "RETCODE",
dbo.AD_GET_RETAINER(@compcode,RETAINER_CODE) as "RETNAME"
FROM ad_bills WHERE ((ad_bills.UNIT  in(select branch_mst.Branch_Code from branch_mst where  branch_mst.Branch_Name =@branch or @branch is null) and ad_bills.UNIT is not null ) or (ad_bills.UNIT is  null))
and ad_bills.UNIT IN (SELECT Branch_Code FROM BRANCH_MST WHERE ad_bills.UNIT=Branch_Code and pub_center in (SELECT Pub_cent_Code FROM PUB_CENT_MAST WHERE  branch_mst.pub_center=pub_cent_mast.Pub_cent_Code and Pub_cent_Code=@pub_cent or @pub_cent is null))
and (ad_bills.BILDT between @fromdate and @dateto)
and (ad_bills.AGCODE in (select AGENCY_MAST.code_subcode from agency_mast where agency_mast.region =@region  or @region is null))
and (ad_bills.AGCODE in (select AGENCY_MAST.code_subcode from agency_mast where agency_mast.Agency_Type_Code =@agencytype or @agencytype is null))
and (ad_bills.PRIPUB=@publication  or @publication is null)
and (ad_bills.AGCODE in (select AGENCY_MAST.code_subcode from agency_mast where agency_mast.Agency_Code =@agency or @agency is null))
and (ad_bills.CLIENTCD=@client or @client is null)
and (ad_bills.EXECUTIVE_NAME=@executive or @executive is null)
and (ad_bills.PRIPROCTG=@product or @product is null)
and ((ad_bills.PRIPROCTG in (select brand_mst.prod_cat_code from brand_mst where brand_mst.brand_code=@brand or @brand is null) and ad_bills.PRIPROCTG is not null)or (ad_bills.PRIPROCTG is null or ad_bills.PRIPROCTG=''))
and ((ad_bills.PRIPROCTG in (select brand_mst.prod_cat_code from brand_mst where brand_mst.brand_code in(select varient_mst.Brand_Code from varient_mst where varient_mst.Varient_Name=@varient or @varient is null)) and ad_bills.PRIPROCTG is not null) or (ad_bills.PRIPROCTG is null or ad_bills.PRIPROCTG=''))
and (ad_bills.CONTRACT_NAME =@contractname or @contractname is null)
and (ad_bills.RETAINER_CODE =@retainer or @retainer is null)
and (ad_bills.SCHEME=@scheme or @scheme is null)
and (AD_BILLS.REVENUE_CENTER =@revcenter or @revcenter is null)
and (AD_BILLS.RO_STATUS =@rostatus or @rostatus is null)
and (AD_BILLS.PAGE_TYPE =@pagetype or @pagetype is null)
and (AD_BILLS.BOOKING_TYPE =@booktype or @booktype is null)
and ((@base='1' and ad_bills.AGCODE in (select AGENCY_MAST.code_subcode from agency_mast where AGENCY_MAST.City_Code =@city or @city is null))
or (@base='2' and ad_bills.EXECUTIVE_NAME in(select exec_mast.Exe_no from exec_mast where exec_mast.city_code =@city or @city is null))
or (@base='3' and ad_bills.RETAINER_CODE in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.City_Code=@city or @city is null)))
and ((@base='1' and ad_bills.AGCODE in (select AGENCY_MAST.code_subcode from agency_mast where AGENCY_MAST.zone_code =@zone or @zone is null))
or (@base='2' and ad_bills.EXECUTIVE_NAME in(select exec_mast.Exe_no from exec_mast where exec_mast.city_code in (select city_mst.City_Code from city_mst where city_mst.Zone_Code= @zone or @zone is null) ))
or (@base='3' and ad_bills.RETAINER_CODE in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.Zone_Code=@zone or @zone is null)))
and ((@base='1' and ad_bills.AGCODE in (select AGENCY_MAST.code_subcode from agency_mast where AGENCY_MAST.Dist_Code =@district  or @district  is null))
or (@base='2' and ad_bills.EXECUTIVE_NAME in(select exec_mast.Exe_no from exec_mast where exec_mast.dist_code= @district  or @district  is null ))
or (@base='3' and ad_bills.RETAINER_CODE in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.Dist_Code=@district  or @district  is null)))
and ((@base='1' and ad_bills.AGCODE in (select AGENCY_MAST.code_subcode from agency_mast where AGENCY_MAST.State_Code =@state or @state is null))
or (@base='2' and ad_bills.EXECUTIVE_NAME in(select exec_mast.Exe_no from exec_mast where exec_mast.State_code= @state or @state is null ))
or (@base='3' and ad_bills.RETAINER_CODE in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.State_Code=@state or @state is null)))
and ((@base='1' and ad_bills.AGCODE   in (select AGENCY_MAST.code_subcode from agency_mast where AGENCY_MAST.TALUKA=@taluka or @taluka is null) )
or (@base='2' and ad_bills.EXECUTIVE_NAME   in(select exec_mast.Exe_no from exec_mast where exec_mast.TALUKA= @taluka or @taluka is null ))
or (@base='3' and ad_bills.RETAINER_CODE  in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.TALUKA=@taluka or @taluka is null)))
and ((@base='1' and ad_bills.AGCODE IS NOT NULL AND ad_bills.AGCODE!='0')
or (@base='2' and ad_bills.EXECUTIVE_NAME   is not null and ad_bills.EXECUTIVE_NAME !='0' )
or (@base='3' and ad_bills.RETAINER_CODE  is not null  and ad_bills.RETAINER_CODE !='0'))



set @v_frdt=@fromdate
set @v_todt=@dateto
select distinct @prefer= AGENCY_RETAINER_COMM from preferrences where comp_code=@compcode
delete from temp_complete_dynamic_report


delete from MULTIPACK_REP	
delete from MULTIPACK_RAT
delete from MULTIPACK_RATNEW
open c1
fetch next from c1 into @c1cioid ,@c1pckcode,@c1gramt,@c1chkvar
	PRINT(@@FETCH_STATUS)
	while @@FETCH_STATUS=0 begin
		PRINT('KHARE')
		PRINT(@c1chkvar)
	if(@c1chkvar='1')begin	
		insert into MULTIPACK_REP select * from dbo.multipack_report1(@c1cioid, @c1pckcode, @c1gramt, '1')

	end
	else if(@c1chkvar='3') begin
		insert into MULTIPACK_RAT select * from dbo.multipack_report3(@c1cioid, @c1pckcode, @c1gramt, '3')
	end
	else begin
		insert into MULTIPACK_RATNEW select * from dbo.multipack_report2(@c1cioid, @c1pckcode, @c1gramt, '2')
	end
	set @v_edition=null
	set @v_edipkg=null
fetch next from c1 into @c1cioid ,@c1pckcode,@c1gramt,@c1chkvar
end
close c1

print('145466')
print(@chkdetail)
print(@adcheck)
print('xz')
if(@chkdetail='Detail')begin
	if(@adcheck=1) begin
	set @query1='SELECT distinct a.cio_booking_id AS CIOID
	,CASE '''+@dateformat+'''
	 WHEN ''mm/dd/yyyy'' THEN CONVERT(varchar(10),a.date_time,101)
	WHEN ''dd/mm/yyyy'' THEN CONVERT(varchar(10),a.date_time,103)
	WHEN ''yyyy/mm/dd'' THEN CONVERT(varchar(10),a.date_time,111) END as BookDate,
	AGENCY_MAST.Agency_Name AS Agency,
	isnull((SELECT Cust_Name FROM CUST_MAST WHERE Cust_Code=Client_code),Client_code)  AS Client,
	RO_No AS "RoNo.",
	CASE '''+@dateformat+'''
	WHEN ''mm/dd/yyyy'' then CONVERT(varchar(10),RO_Date,101)
	WHEN ''dd/mm/yyyy'' then CONVERT(varchar(10),RO_Date,103)
	WHEN ''yyyy/mm/dd'' then CONVERT(varchar(10),RO_Date,111) END AS "Ro.Date",
	(select EXEC_MAST.Exec_name from exec_mast where a.Executive_code=exec_mast.Exe_no) AS Executive,
	(select RETAINERMASTER.Retain_Name  FROM  RETAINERMASTER where RETAINERMASTER.Retain_Code=a.RETAINER ) AS Retainer,
	case a.Booking_type
	when ''1'' then ''Barter''
	when ''2'' then ''FMG''
	when ''3'' then ''Normal''
	when ''4'' then ''InHouse''
	when ''5'' then ''Complimentary''
	else ''Normal'' end as BookType,
	(select col_mast.Col_Alias from col_mast where a.Color_code=col_mast.Col_Code) as Color,
	adv_cat_mast.Adv_Cat_Name as Adcat,
	(select adv_subcat_mast.Adv_Subcat_Name from adv_subcat_mast where a.Ad_sub_cat_code=adv_subcat_mast.Adv_Subcat_Code and  adv_cat_mast.Adv_Cat_Code=adv_subcat_mast.Adv_Cat_Code)as Adsubcat,
	(select ad_cat3.catname from ad_cat3,adv_subcat_mast  where a.Ad_Subcat3=ad_cat3.catcode and ad_cat3.subcatname=adv_subcat_mast.Adv_Subcat_Code and a.Ad_sub_cat_code=adv_subcat_mast.Adv_Subcat_Code and  adv_cat_mast.Adv_Cat_Code=adv_subcat_mast.Adv_Cat_Code) as Adsubcat3,
	(select tbl_cat4.Cat_Name from tbl_cat4 where tbl_cat4.Cat_Code=a.Ad_Subcat4) as Adsubcat4,
	(select tbl_cat5.Cat_Name from tbl_cat5 where tbl_cat5.Cat_Code=a.Ad_subcat5) as Adsubcat5,
	/*dbo.FETCH_PACK(a.cio_booking_id) AS Package,*/
	case when CHARINDEX('','', a."Package_code")>0 then
		dbo.FETCH_PACK_new('''+ @compcode +''', a."Package_code" ) 
	else
		(select distinct min("Combin_Desc") from combin_mast where "Combin_Code"=a."Package_code")
	end AS "Package",
	CASE '''+@dateformat+'''
	WHEN ''mm/dd/yyyy'' then CONVERT(varchar(10),a.Insertion_date,101)
	WHEN ''dd/mm/yyyy'' then CONVERT(varchar(10),a.Insertion_date,103)
	WHEN ''yyyy/mm/dd'' then CONVERT(varchar(10),a.Insertion_date,111) END as PubDate,
	a.No_of_insertion as noinsert,
	a.Paid_ins as Paidinsert,
	a.Ad_size_height as height,
	a.Ad_size_width as width,
	a.Total_area as Area,
	(select ADVPOS_PREM_MAST.premiumname from advpos_prem_mast where a.Page_prem=ADVPOS_PREM_MAST.Premiumcode) as Pagepremium,
	(select advpos_type_mast.Pos_Type from advpos_type_mast where a.Page_position_code=advpos_type_mast.Pos_Type_Code) as Postprem,
	(select scheme_master.Scheme_Name from scheme_master where a.Scheme_type_code=scheme_master.scheme_id) as scheme,
	a.Rate_code as Ratecode,
	a.Card_rate as cardrate,
	a.Card_amount as cardamt,
	a.Contract_rate as contractrate,
	a.Deviation as Deviationamt,
	a.Deviation AS  "Deviation(%)",
	a.Agrred_rate as Aggrate,
	a.Agreed_amount as aggamt,
	(a.Card_amount - 
	case isnull(a.Agreed_amount,0)
	when 0 then a.Card_amount
	else a.Agreed_amount end)  as DiscAmt,
	a.Discount_per as Discper,
	dbo.FETCH_RATAMT(a.cio_booking_id ,''1'',''1'') as  posamt,
	dbo.FETCH_RATAMT(a.cio_booking_id,''2'',''1'')  as  "pos(%)",
	round(((a.Special_disc_per * a.Total_area * a.Card_rate)/100),2) as Spdiscamt,
	a.Special_disc_per as Spdiscper,
	round(((a.Space_disc_per * a.Total_area * a.Card_rate)/100),2) as Spacedisc,
	a.Space_disc_per as Spacediscper,
	a.Special_charges as Specialcharge,
	isnull(a.ADD_AGENCY_COMM,''0'') as  "AgencyAddlTD(%)",
	isnull((isnull(a.Gross_amount,''0'')*isnull(a.ADD_AGENCY_COMM,''0'')/100),''0'') as AgencyAddlTDAmt,
	isnull(a.Gross_amount,''0'') as Grossamt,
	isnull(dbo.fun_actual('''+ @compcode +''',isnull(a.ADD_AGENCY_COMM,''0'' ),isnull(a.RETAINER,''0''),isnull(a.Gross_amount,''0''),'''+@prefer+''',''3'' ),''0'')as  "RetTD(%)",
	isnull(dbo.fun_actual('''+ @compcode +''',isnull(a.ADD_AGENCY_COMM,''0'' ),isnull(a.RETAINER,''0''),isnull(a.Gross_amount,''0''),'''+@prefer+''',''4'' ),''0'')as RetTDAmt,
	isnull(a.Trade_disc,''0'' )as "AgencyTD(%)",
	(isnull(a.Gross_amount,''0'')* isnull(a.Trade_disc,''0'' )/100 )as AgencyTDAmt,
	isnull(a.Bill_amount,''0'') as Billamt,
	isnull(dbo.fun_actual('''+ @compcode +''',isnull(a.ADD_AGENCY_COMM,''0'' ),isnull(a.RETAINER,''0''),isnull(a.Gross_amount,''0''),'''+@prefer+''',''1'' ),''0'') as "RetComm(%)",
	isnull(dbo.fun_actual('''+ @compcode +''',isnull(a.ADD_AGENCY_COMM,''0'' ),isnull(a.RETAINER,''0''),isnull(a.Gross_amount,''0''),'''+@prefer+''',''2'' ),''0'') as RetCommAmt,
	isnull((a.Bill_amount-isnull(dbo.fun_actual('''+ @compcode +''',isnull(a.ADD_AGENCY_COMM,''0'' ),isnull(a.RETAINER,''0''),isnull(a.Gross_amount,''0''),'''+@prefer+''',''2'' ),''0'')  ),''0'') as ActualBusiness,
	(SELECT BRANCH_MST.Branch_Name FROM BRANCH_MST WHERE a.Revenue_center=BRANCH_MST.Branch_Code )as Revcenter,
	UOM_MAST.Uom_Name  AS Uom,
	uom_mast.UOM_DESC as uomdesc
	,(select top 1 pub_cent_mast.Pub_Cent_name from pub_cent_mast where pub_cent_mast.Pub_cent_Code in(select pub_center from  BRANCH_MST WHERE a.branch=Branch_Name) ) as Printcenter
	,(SELECT "Branch_Name" FROM BRANCH_MST where  a."branch" = "Branch_Code") as Branch
	,case '''+@base+'''
	when ''1'' then  AGENCY_MAST.Dist_Code
	when ''2'' then (select dist_mst.Dist_Name from dist_mst where dist_mst.Dist_Code in(select exec_mast.dist_code from exec_mast where  exec_mast.Exe_no=a.Executive_code )  )
	when ''3'' then (select dist_mst.Dist_Name from dist_mst where dist_mst.Dist_Code in(select RETAINERMASTER.Dist_Code from RETAINERMASTER where  RETAINERMASTER.Retain_Code= a.RETAINER )  ) end as District
	,case '''+@base+'''
	when ''1'' then (select taluka_mast.TALU_NAME  from taluka_mast where AGENCY_MAST.TALUKA=taluka_mast.TALU_CODE )
	when ''2'' then (select taluka_mast.TALU_NAME  from taluka_mast where taluka_mast.TALU_CODE in(select exec_mast.TALUKA from exec_mast where  exec_mast.Exe_no=a.Executive_code )  )
	when ''3'' then (select taluka_mast.TALU_NAME  from taluka_mast where taluka_mast.TALU_CODE in(select RETAINERMASTER.TALUKA from RETAINERMASTER where  RETAINERMASTER.Retain_Code= a.RETAINER )  ) end as Taluka
	,isnull(a.Page_no,0) as "Page_No"
	,CASHDISCOUNT as "Cash_Disc"
	,(select distinct "Box_Name" from box_mast where "Box_Code"=a."Box_code") as "BoxCode",
	a.Userid as USERID,(SELECT max(username) from login where com_code = a.Comp_code and userid=a.Userid) as USERNAME
	FROM TBL_BOOKING_MAST a,AGENCY_MAST ,UOM_MAST,
	adv_cat_mast,adv_type_mast,
	TBL_BOOKING_insert
	WHERE a.Comp_code='''+@compcode+''' AND
	 UOM_MAST.Uom_Code=a.Uom_code and
	a.Agency_sub_code=AGENCY_MAST.code_subcode AND
	a.Ad_cat_code=adv_cat_mast.Adv_Cat_Code and
	a.Ad_type_code=adv_type_mast.Adv_Type_Code
	and adv_type_mast.Adv_Type_Code=adv_cat_mast.Adv_Type and
	a.cio_booking_id=tbl_booking_insert.Cio_Booking_Id'
	--and ((tbl_booking_insert.Pub_Cent_Code in (select distinct pub_center from login_center where newuser_id='''+@puserid+''') and '''+@chk_access+'''=''1'')
	--or  ('''+@chk_access+'''=''0'') )' 
	--

	if(@query4='' or @query4 is null)begin
		IF(@fromdate IS NOT NULL AND @dateto IS NOT NULL and @filterby='Booking Date' ) begin
			set @query4=' and a.date_time between  '''+@fromdate +''' and  '''+@dateto+''' '
		END 

		IF(@fromdate IS NOT NULL AND @dateto IS NOT NULL and @filterby='Publish Date' ) begin
			set @query4=' and a.Insertion_date  between  '''+@fromdate +''' and  '''+@dateto+''' '
		END 
	end
	else begin
		IF(@fromdate IS NOT NULL AND @dateto IS NOT NULL and @filterby='Booking Date' ) begin
			set @query4=@query4+' and a.date_time between  '''+@fromdate +''' and  '''+@dateto+''' '
		END 

		IF(@fromdate IS NOT NULL AND @dateto IS NOT NULL and @filterby='Publish Date' ) begin
			set @query4=@query4+' and a.Insertion_date  between  '''+@fromdate +''' and  '''+@dateto+''' '
		END 
	end
	if(@base='2')begin
		set @query4=@query4+' and (a.Executive_code is not null and a.Executive_code<>'''' and a.Executive_code !=''0'')  '
	end 

	if(@base='3')begin
		set @query4=@query4+' and (a.RETAINER is not null and a.RETAINER<>''''  and a.RETAINER !=''0'')  '
	end 

	if(@drpstatus is null or  @drpstatus = '') begin
		set @query4=@query4+' and lower(Insert_Status)!=''cancel'''
	end 

	if(@insertstatus is not null and @insertstatus<>'') begin
		set @query4=@query4+' and lower(Insert_Status)='''+@insertstatus+''''
	end 


	IF(@publication IS NOT NULL) begin
		set @query4=@query4+' and TBL_BOOKING_insert.publication_Code='''+@publication+'''    '
	END 

	IF(@pub_cent IS NOT NULL) begin
		set @query4=@query4+'  and a."branch" IN (SELECT "Branch_Code" FROM BRANCH_MST WHERE a."branch"="Branch_Code" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"='''+@pub_cent+'''))'
	END 

	IF(@branch IS NOT NULL  and @branch<>'') begin
		set @query4=@query4+'  and a."branch" = (SELECT "Branch_Code" FROM BRANCH_MST where "Branch_Name" ='''+@branch+''') ';
	END 

	IF(@edition IS NOT NULL  and @edition<>'') begin
		set @query4=@query4+'  and tbl_booking_insert.Edition_Code='''+@edition+''''
	END 
	
 
	IF(@region IS NOT NULL and @region <>'') begin
		--set @query4=@query4 +' and tbl_booking_insert.Pub_Cent_Code in(select pub_cent_mast.Pub_cent_Code from pub_cent_mast where pub_cent_mast.Region_code ='''+region +''')'
		set @query4=@query4 +' and agency_mast.region ='''+@region +''' '
	END 

	IF(@revcenter IS NOT NULL and @revcenter <>'') begin
		set @query4=@query4 +' and a.Revenue_center ='''+@revcenter+''''
	END 

	IF(@adtype IS NOT NULL and @adtype <>'') begin
		set @query4=@query4 + ' and a.Ad_type_code='''+@adtype+''''
	END 

	IF(@agencytype IS NOT NULL and @agencytype <>'') begin
		set @query4=@query4 + ' and a.Agency_type ='''+@agencytype+''''
	END 

	IF(@adcat IS NOT NULL and @adcat <>'') begin
		set @query4=@query4 + ' and a.Ad_cat_code ='''+@adcat+''''
	END 

	IF(@adsubcat IS NOT NULL and @adsubcat <>'') begin
		set @query4=@query4 + ' and a.Ad_sub_cat_code ='''+@adsubcat+''''
	END 

	IF(@adsubcat3 IS NOT NULL and @adsubcat3 <>'') begin
		set @query4=@query4 + ' and a.Ad_Subcat3 ='''+@adsubcat3+''''
	END 

	IF(@adsubcat4 IS NOT NULL and @adsubcat4 <>'') begin
		set @query4=@query4 + ' and a.Ad_Subcat4 ='''+@adsubcat4+''''
	END 

	IF(@adsubcat5 IS NOT NULL and @adsubcat5 <>'') begin
		set @query4=@query4 + ' and a.Ad_subcat5 ='''+@adsubcat5+''''
	END 

	IF(@package IS NOT NULL and @package <>'') begin
		set @query4=@query4 + ' and a.Package_code ='''+@package+''''
	END 

	IF(@scheme IS NOT NULL and @scheme <>'') begin
		set @query4=@query4 + ' and a.Scheme_type_code ='''+@scheme+''''
	END 

	IF(@agency IS NOT NULL and @agency <>'') begin
		set @query4=@query4 + ' and a.Agency_code ='''+@agency+''''
	END 

	IF(@client IS NOT NULL and @client  <>'') begin
		set @query4=@query4 + ' and a.Client_code ='''+@client+''''
	END 

	IF(@executive IS NOT NULL and @executive <>'') begin
		set @query4=@query4 + ' and a.Executive_code ='''+@executive+''''
	END 

	IF(@retainer IS NOT NULL and @retainer <>'') begin
		set @query4=@query4 + ' and a.RETAINER ='''+@retainer+''''
	END 

	IF(@product IS NOT NULL and @product <>'') begin
		set @query4=@query4 + ' and a.Product_code ='''+@product+''''
	END 

	IF(@brand IS NOT NULL and @brand <>'') begin
		set @query4=@query4 + ' and a.Brand_code ='''+@brand+''''
	END 

	IF(@varient IS NOT NULL and @varient <>'') begin
		set @query4=@query4 + ' and a.Variant_code ='''+@varient+''''
	END 

	IF(@pagetype IS NOT NULL and @pagetype <>'') begin
		set @query4=@query4 + ' and a.Page_type_code ='''+@pagetype+''''
	END 

	IF(@pageprem IS NOT NULL and @pageprem <>'') begin
		set @query4=@query4 + ' and a.Page_prem ='''+@pageprem+''''
	END 

	IF(@postprem IS NOT NULL and @postprem <>'') begin
		set @query4=@query4 + ' and a.Page_position_code ='''+@postprem+''''
	END 

	IF(@rostatus IS NOT NULL and @rostatus <>'') begin
		set @query4=@query4 + ' and a.ro_status ='''+@rostatus+''''
	END 

	IF(@booktype IS NOT NULL and @booktype <>'') begin
		set @query4=@query4 + ' and a.Booking_type ='''+@booktype+''''
	END 

	IF(@contractname  IS NOT NULL and @contractname  <>'') begin
		set @query4=@query4 + ' and a.Contract_name ='''+@contractname +''''
	END 

	IF(@suppliment  IS NOT NULL and @suppliment  <>'') begin
		set @query4=@query4 + ' and tbl_booking_insert.Supp_Code ='''+@suppliment+''''
	END 

	IF(@ratetype  IS NOT NULL and @ratetype  <>'') begin
		set @query4=@query4 + ' and a.Rate_code ='''+@ratetype+''''
	END 

	IF(@p_baxcode IS NOT NULL and @p_baxcode <>'') begin
		set @query4=@query4 + ' and a.Box_code ='''+@p_baxcode+''''
	END 

	IF(@city  IS NOT NULL and @city  <>'') begin
		if(@base='1')begin
			set @query4=@query4 + ' and AGENCY_MAST.City_Code ='''+@city+''''
		end 

		if(@base='2')begin
			set @query4=@query4 + ' and a.Executive_code in(select exec_mast.Exe_no from exec_mast where exec_mast.city_code ='''+@city+''' )'
		end 

		if(@base='3')begin
			set @query4=@query4 + ' and a.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.City_Code='''+@city+''')'
		end 
	END 

	IF(@zone  IS NOT NULL and @zone  <>'') begin
		if(@base='1')begin
			set @query4=@query4 + ' and AGENCY_MAST.zone_code ='''+@zone+''''
		end 

		if(@base='2')begin
			set @query4=@query4 + ' and a.Executive_code in(select exec_mast.Exe_no from exec_mast where exec_mast.city_code in (select city_mst.City_Code from city_mst where city_mst.Zone_Code= '''+@zone+''') )'
		end 

		if(@base='3')begin
			set @query4=@query4 + ' and a.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.Zone_Code='''+@zone+''')'
		end 
	END 

	IF(@district  IS NOT NULL and @district  <>'') begin
		if(@base='1')begin
			set @query4=@query4 + ' and AGENCY_MAST.Dist_Code ='''+@district+''''
		end 

		if(@base='2')begin
			set @query4=@query4 + ' and a.Executive_code in(select exec_mast.Exe_no from exec_mast where exec_mast.dist_code ='''+@district+''' )'
		end 

		if(@base='3')begin
			set @query4=@query4 + ' and a.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.Dist_Code='''+@district+''')'
		end 
	END 

	IF(@state  IS NOT NULL and @state  <>'') begin
		if(@base='1')begin
			set @query4=@query4 + ' and AGENCY_MAST.State_Code ='''+@state+''''
		end 

		if(@base='2')begin
			set @query4=@query4 + ' and a.Executive_code in(select exec_mast.Exe_no from exec_mast where exec_mast.State_code ='''+@state+''' )'
		end 

		if(@base='3')begin
			set @query4=@query4 + ' and a.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.State_Code='''+@state+''')'
		end 
	END 

	IF(@taluka  IS NOT NULL and @taluka  <>'') begin
		if(@base='1')begin	
			set @query4=@query4 + ' and AGENCY_MAST.TALUKA='''+@taluka+'''  '
		end 

		if(@base='2')begin
			set @query4=@query4 + ' and a.Executive_code in(select exec_mast.Exe_no from exec_mast where exec_mast.TALUKA ='''+@taluka+''' )'
		end 

		if(@base='3')begin
			set @query4=@query4 + ' and a.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.TALUKA='''+@taluka+''')'
		end 
	END 

	set @query4=@query4 + ' order by a.cio_booking_id'
	PRINT 'LL'
	print(@query1+@query4)
	
	exec(@query1+@query4)

	--print(@query1)
	--exec(@query1)
end 

else if(@adcheck=2)begin
open c2
fetch next from c2 into @v2_CIOID,@v2_BILLNO,@v2_AGMAINCODE,@v2_AG_SUB_CODE,@v2_AGCODE,@v2_AGNAME,@v2_EXECCODE,@v2_EXECNAME,@v2_RETCODE,@v2_RETNAME

print(@@FETCH_STATUS)
while @@FETCH_STATUS=0 begin

insert into #temp_ad_bills_report select * from dbo.FUN_BILL_INSERT(@compcode,@v2_CIOID,@v2_BILLNO,@prefer,@dateformat,@v2_AGMAINCODE,@v2_AG_SUB_CODE,@v2_AGCODE,@v2_AGNAME,@v2_EXECCODE,@v2_EXECNAME,@v2_RETCODE,@v2_RETNAME,@base )  

fetch next from c2 into @v2_CIOID,@v2_BILLNO,@v2_AGMAINCODE,@v2_AG_SUB_CODE,@v2_AGCODE,@v2_AGNAME,@v2_EXECCODE,@v2_EXECNAME,@v2_RETCODE,@v2_RETNAME

end
close c2


set @query2='select CIOID AS "CIOID",BILLNO AS "Billno" ,AGENCY AS "Agency", CLIENT AS "Client" ,
RONO  AS "RoNo.",
CASE '''+@dateformat+'''
WHEN ''mm/dd/yyyy'' then CONVERT(varchar(10),RODATE,101)
WHEN ''dd/mm/yyyy'' then CONVERT(varchar(10),RODATE,103)
WHEN ''yyyy/mm/dd'' then CONVERT(varchar(10),RODATE,111) END AS "Ro.Date",
EXECUTIVE  AS "Executive",RETAINER  AS "Retainer" ,BOOKTYPE as "BookType",COLOR as "Color",ADCAT as "Adcat",
ADSUBCAT as "Adsubcat",ADSUBCAT3 as "Adsubcat3",ADSUBCAT4  as "Adsubcat4",ADSUBCAT5 as "Adsubcat5",PACKAG AS "Package",
CASE '''+@dateformat+'''
WHEN ''mm/dd/yyyy'' then CONVERT(varchar(10),BILLDATE,101)
WHEN ''dd/mm/yyyy'' then CONVERT(varchar(10),BILLDATE,103)
WHEN ''yyyy/mm/dd'' then CONVERT(varchar(10),BILLDATE,111) END AS "BillDate",
NOINSERT as "noinsert",PAIDINSERT as "Paidinsert" ,HEIGHT as "height",WIDTH as "width",AREA as "Area",PAGEPREMIUM as "Pagepremium",POSTPREM as "Postprem",
SCHEME as "scheme",RATECOD as "Ratecode",CARDRATE as "cardrate",CARDAMT as "cardamt",
CONTRACTRATE as "contractrate",DEVIATIONAMT as "Deviationamt",DEVIATIONPER AS "Deviation(%)",
AGGRATE as "Aggrate",AGGAMT as "aggamt",DISCAMT as "DiscAmt",DISCPER as "Discper",
POSAMT as  "posamt",POSPER as "pos(%)",SPDISCAMT as "Spdiscamt",
SPDISCPER as "Spdiscper",SPACEDISC as "Spacedisc",SPACEDISCPER as "Spacediscper",SPECIALCHARGE as "Specialcharge",AGENCYADDLTDPER  as "AgencyAddlTD(%)",
AGENCYADDLTDAMT as "AgencyAddlTDAmt",GROSSAMT as "Grossamt",
RETTDPER as "RetTD(%)",RETTDAMT as "RetTDAmt",AGENCYTDPER as "AgencyTD(%)",AGENCYTDAMT as "AgencyTDAmt",BILLAMT as "Billamt",
RETCOMMPER as "RetComm(%)",RETCOMMAMT as "RetCommAmt",ACTUALBUSINESS as "ActualBusiness",
REVCENTER as "Revcenter",UOM AS "Uom",UOMDESC as "uomdesc"
,PUB_CENT_NAME as "Printcenter"
,BRANCH_NAME  as "Branch"
,DIST_NAME as "District"
,TALU_NAME as "Taluka"
,PAGE_NO as "Page_No"
from #temp_ad_bills_report where'

IF(@fromdate IS NOT NULL AND @dateto IS NOT NULL ) begin
	set @query4= '  BILLDATE between  '''+@fromdate +''' and  '''+@dateto+''' '
END 

IF(@publication IS NOT NULL and @publication<>'') begin
	set @query4=@query4+ ' and PRIPUB='''+@publication+''''
END 

IF(@pub_cent IS NOT NULL and @pub_cent<>'')	begin
	set @query4=@query4+ '   and PUB_CENT_CODE='''+@pub_cent+''''
END 

IF(@edition IS NOT NULL and @edition<>'')begin
	set @query4=@query4+ '  and PEDITION='''+@edition+''''
END 

IF(@branch IS NOT NULL and @branch<>'')begin
	set @query4=@query4+ '  and  BRANCH_NAME ='''+@branch+''' '
END 

IF(@region IS NOT NULL and @region<>'') begin
	set @query4=@query4 +' and REGION='''+@region +''''
END 

IF(@adtype IS NOT NULL and @adtype<>'') begin
	set @query4=@query4 + ' and PADTYPE='''+@adtype+''''
END 

IF(@agencytype IS NOT NULL and @agencytype<>'') begin
	set @query4=@query4 + ' and AGENCY_TYPE_CODE= '''+@agencytype+''''
END 

IF(@adcat IS NOT NULL and @adcat<>'') begin
	set @query4=@query4 + ' and PRIADCTG='''+@adcat+''''
END 

IF(@adsubcat IS NOT NULL and @adsubcat<>'') begin
	set @query4=@query4 + ' and SECADCTG ='''+@adsubcat+''''
END 

IF(@adsubcat3 IS NOT NULL and @adsubcat3<>'') begin
	set @query4=@query4 + ' and AD_SUBCAT3 ='''+@adsubcat3+''''
END 

IF(@adsubcat4 IS NOT NULL and @adsubcat4<>'') begin
	set @query4=@query4 + ' and AD_SUBCAT4 ='''+@adsubcat4+''''
END 

IF(@adsubcat5 IS NOT NULL and @adsubcat5<>'') begin
	set @query4=@query4 + ' and AD_SUBCAT5 ='''+@adsubcat5+''''
END 

IF(@package IS NOT NULL and @package<>'') begin
	set @query4=@query4 + ' and PACKAGE_CODE='''+@package+''''
END 

IF(@agency IS NOT NULL and @agency<>'') begin
	set @query4=@query4 + ' and AG_MAIN_CODE ='''+@agency +''''
END 

IF(@client IS NOT NULL and @client<>'') begin
	set @query4=@query4 + ' and CLIENTCD='''+@client +''''
END 

IF(@executive IS NOT NULL and @executive<>'') begin
	set @query4=@query4 + ' and EXECUTIVE_NAME='''+@executive+''''
END 

IF(@product IS NOT NULL and @product<>'') begin
	set @query4=@query4 + ' and PRIPROCTG='''+@product+''''
END 

IF(@brand IS NOT NULL and @brand<>'') begin
	set @query4=@query4 + ' and BRAND_CODE='''+@brand+''''
END 

IF(@varient IS NOT NULL and @varient<>'') begin
	set @query4=@query4 + ' and   VARIENT_NAME='''+@varient+''''
END 

IF(@pageprem IS NOT NULL and @pageprem<>'') begin
	set @query4=@query4 + ' and PAGE_PREM ='''+@pageprem+''''
END 

IF(@postprem IS NOT NULL and @postprem<>'') begin
	set @query4=@query4 + ' and PAGE_POST ='''+@postprem+''''
END 

IF(@contractname  IS NOT NULL and @contractname<>'') begin
	set @query4=@query4 + ' and CONTRACT_NAME ='''+@contractname +''''
END 

IF(@suppliment  IS NOT NULL and @suppliment<>'') begin
	set @query4=@query4 + ' and SUPP_CODE='''+@suppliment+''''
END 

IF(@retainer IS NOT NULL and @retainer<>'') begin
	set @query4=@query4 + ' and RETAINER_CODE='''+@retainer+''''
END 

IF(@ratetype  IS NOT NULL and @ratetype<>'') begin
	set @query4=@query4 + ' and RATECD ='''+@ratetype+''''
END 

IF(@scheme IS NOT NULL and @scheme<>'') begin
	set @query4=@query4 + ' and PSCHEME='''+@scheme+''''
END 

IF(@revcenter IS NOT NULL and @revcenter<>'') begin
	set @query4=@query4 +' and REVENUE_CENTER='''+@revcenter+''''
END 

IF(@rostatus IS NOT NULL and @rostatus<>'') begin
	set @query4=@query4 + ' and RO_STATUS='''+@rostatus+''''
END 

IF(@pagetype IS NOT NULL and @pagetype<>'') begin
	set @query4=@query4 + ' and PAGE_TYPE ='''+@pagetype+''''
END 

IF(@booktype IS NOT NULL and @booktype<>'') begin
	set @query4=@query4 + ' and BOOKING_TYPE='''+@booktype+''''
END 

IF(@city  IS NOT NULL and @city<>'') begin
	set @query4=@query4 + ' and CITY_CODE ='''+@city+''''
END 

IF(@zone  IS NOT NULL and @zone<>'') begin
	set @query4=@query4 + ' and ZONE_CODE ='''+@zone+''''
end 

IF(@district  IS NOT NULL and @district<>'') begin
	set @query4=@query4 + ' and DIST_CODE ='''+@district+''''
end 

IF(@state  IS NOT NULL and @state<>'') begin
	set @query4=@query4 + ' and STATE_CODE ='''+@state+''''
end 

IF(@taluka  IS NOT NULL and @taluka<>'') begin
	set @query4=@query4 + ' and PTALUKA='''+@taluka+'''  '
end 


if(@base='2')begin
	set @query4=@query4 +' and (EXECUTIVE_NAME   is not null and EXECUTIVE_NAME !=''0'')  '
end 

if(@base='3')begin
	set @query4=@query4 +' and (RETAINER_CODE  is not null  and RETAINER_CODE  !=''0'')  '
end 



set @query4=@query4 + ' order by CIOID'


print(@query2+@query4)
exec(@query2+@query4)
end 

else if(@adcheck=3) begin
set @query3='SELECT  TBL_BOOKING_MAST.cio_booking_id AS CIOID,
CASE '''+@dateformat+'''
WHEN ''mm/dd/yyyy'' then CONVERT(varchar(10),TBL_BOOKING_MAST.date_time,101)
WHEN ''dd/mm/yyyy'' then CONVERT(varchar(10),TBL_BOOKING_MAST.date_time,103)
WHEN ''yyyy/mm/dd'' then CONVERT(varchar(10),TBL_BOOKING_MAST.date_time,111) END as BookDate,
AGENCY_MAST.Agency_Name AS Agency,
isnull((SELECT Cust_Name FROM CUST_MAST WHERE Cust_Code=Client_code),Client_code)  AS Client,
RO_No AS "RoNo.",
CASE '''+@dateformat+'''
WHEN ''mm/dd/yyyy'' then CONVERT(varchar(10),RO_Date,101)
WHEN ''dd/mm/yyyy'' then CONVERT(varchar(10),RO_Date,103)
WHEN ''yyyy/mm/dd'' then CONVERT(varchar(10),RO_Date,111) END AS "Ro.Date",
(select EXEC_MAST.Exec_name from exec_mast where tbl_booking_mast.Executive_code=exec_mast.Exe_no) AS Executive,
(select RETAINERMASTER.Retain_Name  FROM  RETAINERMASTER where RETAINERMASTER.Retain_Code=tbl_booking_mast.RETAINER ) AS Retainer,
case tbl_booking_mast.Booking_type
when ''1'' then ''Barter''
when ''2'' then ''FMG''
when ''3'' then ''Normal''
when ''4'' then ''InHouse''
when ''5'' then ''Complimentary''
else ''Normal'' end as BookType,
(select col_mast.Col_Alias from col_mast where tbl_booking_insert.Col_Code =col_mast.Col_Code) as Color,
adv_cat_mast.Adv_Cat_Name as Adcat,
(select adv_subcat_mast.Adv_Subcat_Name from adv_subcat_mast where tbl_booking_mast.Ad_sub_cat_code=adv_subcat_mast.Adv_Subcat_Code and  adv_cat_mast.Adv_Cat_Code=adv_subcat_mast.Adv_Cat_Code)as Adsubcat,
(select ad_cat3.catname from ad_cat3,adv_subcat_mast  where tbl_booking_mast.Ad_Subcat3=ad_cat3.catcode and ad_cat3.subcatname=adv_subcat_mast.Adv_Subcat_Code and tbl_booking_mast.Ad_sub_cat_code=adv_subcat_mast.Adv_Subcat_Code and  adv_cat_mast.Adv_Cat_Code=adv_subcat_mast.Adv_Cat_Code) as Adsubcat3,
(select tbl_cat4.Cat_Name from tbl_cat4,adv_subcat_mast where tbl_booking_mast.Ad_Subcat4=tbl_cat4.Cat_Code and tbl_cat4.Sub_Cat_Name=adv_subcat_mast.Adv_Subcat_Code and tbl_booking_mast.Ad_sub_cat_code=adv_subcat_mast.Adv_Subcat_Code and  adv_cat_mast.Adv_Cat_Code=adv_subcat_mast.Adv_Cat_Code) as Adsubcat4,
(select tbl_cat5.Cat_Name from tbl_cat5,adv_subcat_mast where tbl_booking_mast.Ad_subcat5=tbl_cat5.Cat_Code and tbl_cat5.Sub_Cat_Name=adv_subcat_mast.Adv_Subcat_Code and tbl_booking_mast.Ad_sub_cat_code=adv_subcat_mast.Adv_Subcat_Code and  adv_cat_mast.Adv_Cat_Code=adv_subcat_mast.Adv_Cat_Code) as Adsubcat5,
/*dbo.FETCH_PACK(tbl_booking_mast.cio_booking_id) AS Package,*/
case when CHARINDEX('','', TBL_BOOKING_MAST."Package_code")>0 then
	dbo.FETCH_PACK_new('''+ @compcode +''', TBL_BOOKING_MAST."Package_code" ) 
else
	(select distinct min("Combin_Desc") from combin_mast where "Combin_Code"=TBL_BOOKING_MAST."Package_code")
end AS "Package",
CASE '''+@dateformat+'''
WHEN ''mm/dd/yyyy'' then CONVERT(varchar(10),tbl_booking_insert.Insert_Date,101)
WHEN ''dd/mm/yyyy'' then CONVERT(varchar(10),tbl_booking_insert.Insert_Date,103)
WHEN ''yyyy/mm/dd'' then CONVERT(varchar(10),tbl_booking_insert.Insert_Date,111) END as PubDate,
 tbl_booking_insert.Height as "height",
 tbl_booking_insert.Width  as "width",
tbl_booking_insert.Size_Book as Area,
(select ADVPOS_PREM_MAST.premiumname from advpos_prem_mast where tbl_booking_insert.Premium1=ADVPOS_PREM_MAST.Premiumcode) as Pagepremium,
(select advpos_type_mast.Pos_Type from advpos_type_mast where tbl_booking_insert.Page_Post=advpos_type_mast.Pos_Type_Code) as Postprem,
(select scheme_master.Scheme_Name from scheme_master where tbl_booking_mast.Scheme_type_code=scheme_master.scheme_id) as scheme,
tbl_booking_mast.Rate_code as Ratecode,
tbl_booking_mast.Card_rate as cardrate,
tbl_booking_mast.Card_rate*tbl_booking_insert.Size_Book as cardamt,
tbl_booking_mast.Contract_rate as contractrate,
TBL_BOOKING_mast.Deviation as Deviationamt,
TBL_BOOKING_mast.Deviation AS  "Deviation(%)",
tbl_booking_mast.Agrred_rate as Aggrate,
tbl_booking_insert.Agreed_Rate  as aggamt,
((tbl_booking_mast.Card_rate*tbl_booking_insert.Size_Book) - 
case isnull(tbl_booking_insert.Agreed_Rate,0)
when 0 then (tbl_booking_mast.Card_rate*tbl_booking_insert.Size_Book)
else tbl_booking_insert.Agreed_Rate end)  as DiscAmt,
tbl_booking_mast.Discount_per as Discper,
dbo.FETCH_RATAMT(tbl_booking_mast.cio_booking_id ,''1'',''1'') as  posamt,
dbo.FETCH_RATAMT(tbl_booking_mast.cio_booking_id,''2'',''1'')  as  "pos(%)",
round(((tbl_booking_mast.Special_disc_per * tbl_booking_insert.Size_Book * tbl_booking_mast.Card_rate)/100),2) as Spdiscamt,
tbl_booking_mast.Special_disc_per as Spdiscper,
round(((tbl_booking_mast.Space_disc_per * tbl_booking_insert.Size_Book * tbl_booking_mast.Card_rate)/100),2) as Spacedisc,
tbl_booking_mast.Space_disc_per as Spacediscper,
tbl_booking_mast.Special_charges as Specialcharge,
isnull(tbl_booking_mast.ADD_AGENCY_COMM,''0'') as  "AgencyAddlTD(%)",
isnull((isnull(tbl_booking_insert.Gross_Rate ,''0'')*isnull(tbl_booking_mast.ADD_AGENCY_COMM,''0'')/100),''0'') as AgencyAddlTDAmt,
isnull(tbl_booking_insert.Gross_Rate,''0'') as Grossamt,
isnull(dbo.fun_actual('''+ @compcode +''',isnull(tbl_booking_mast.ADD_AGENCY_COMM,''0'' ),isnull(tbl_booking_mast.RETAINER,''0''),isnull(tbl_booking_insert.Gross_Rate,''0''),'''+@prefer+''',''3'' ),''0'')as  "RetTD(%)",
isnull(dbo.fun_actual('''+ @compcode +''',isnull(tbl_booking_mast.ADD_AGENCY_COMM,''0'' ),isnull(tbl_booking_mast.RETAINER,''0''),isnull(tbl_booking_insert.Gross_Rate,''0''),'''+@prefer+''',''4'' ),''0'')as RetTDAmt,
isnull(tbl_booking_mast.Trade_disc,''0'' )as "AgencyTD(%)",
(isnull(tbl_booking_insert.Gross_Rate,''0'')* isnull(tbl_booking_mast.Trade_disc,''0'' )/100 )as AgencyTDAmt,
isnull(TBL_BOOKING_INSERT.Bill_Amt,''0'') as Billamt,
isnull(dbo.fun_actual('''+ @compcode +''',isnull(tbl_booking_mast.ADD_AGENCY_COMM,''0'' ),isnull(tbl_booking_mast.RETAINER,''0''),isnull(tbl_booking_insert.Gross_Rate,''0''),'''+@prefer+''',''1'' ),''0'') as "RetComm(%)",
isnull(dbo.fun_actual('''+ @compcode +''',isnull(tbl_booking_mast.ADD_AGENCY_COMM,''0'' ),isnull(tbl_booking_mast.RETAINER,''0''),isnull(tbl_booking_insert.Gross_Rate,''0''),'''+@prefer+''',''2'' ),''0'') as RetCommAmt,
isnull((  isnull(TBL_BOOKING_INSERT.Bill_Amt,''0'')-isnull(dbo.fun_actual('''+ @compcode +''',isnull(tbl_booking_mast.ADD_AGENCY_COMM,''0'' ),isnull(tbl_booking_mast.RETAINER,''0''),isnull(tbl_booking_insert.Gross_Rate,''0''),'''+@prefer+''',''2'' ),''0'')  ),''0'') as ActualBusiness,
(SELECT BRANCH_MST.Branch_Name FROM BRANCH_MST WHERE tbl_booking_mast.Revenue_center=BRANCH_MST.Branch_Code )as Revcenter
,UOM_MAST.Uom_Name  AS Uom,
pub_mast.Pub_Name as publication,
TBL_BOOKING_INSERT.Edition as Edition,
uom_mast.UOM_DESC as uomdesc
,(select top 1 pub_cent_mast.Pub_Cent_name from pub_cent_mast where pub_cent_mast.Pub_cent_Code in(select pub_center from  BRANCH_MST WHERE TBL_BOOKING_MAST.branch=Branch_Name) ) as Printcenter
,tbl_booking_mast.branch as Branch
,case '''+@base+'''
when ''1'' then  AGENCY_MAST.Dist_Code
when ''2'' then (select dist_mst.Dist_Name from dist_mst where dist_mst.Dist_Code in(select exec_mast.dist_code from exec_mast where  exec_mast.Exe_no=tbl_booking_mast.Executive_code )  )
when ''3'' then (select dist_mst.Dist_Name from dist_mst where dist_mst.Dist_Code in(select RETAINERMASTER.Dist_Code from RETAINERMASTER where  RETAINERMASTER.Retain_Code= tbl_booking_mast.RETAINER )  ) end as District
,case '''+@base+'''
when ''1'' then (select taluka_mast.TALU_NAME  from taluka_mast where AGENCY_MAST.TALUKA=taluka_mast.TALU_CODE )
when ''2'' then (select taluka_mast.TALU_NAME  from taluka_mast where taluka_mast.TALU_CODE in(select exec_mast.TALUKA from exec_mast where  exec_mast.Exe_no=tbl_booking_mast.Executive_code )  )
when ''3'' then (select taluka_mast.TALU_NAME  from taluka_mast where taluka_mast.TALU_CODE in(select RETAINERMASTER.TALUKA from RETAINERMASTER where  RETAINERMASTER.Retain_Code= tbl_booking_mast.RETAINER )  ) end as Taluka,
tbl_booking_insert.Page_No as "Page_No"
,CASHDISCOUNT as "Cash_Disc"
,Insert_Status as "Status"
,(select distinct "Box_Name" from box_mast where "Box_Code"=TBL_BOOKING_MAST."Box_code") as "BoxCode",
TBL_BOOKING_MAST.Userid as USERID,(SELECT max(username) from login where com_code = TBL_BOOKING_MAST.Comp_code and userid=TBL_BOOKING_MAST.Userid) as USERNAME
FROM TBL_BOOKING_MAST,AGENCY_MAST ,uom_mast,
adv_cat_mast,adv_type_mast,pub_mast,TBL_BOOKING_insert'

set @query4=' WHERE TBL_BOOKING_MAST.Comp_code='''+@compcode+''' AND
UOM_MAST.Uom_Code=TBL_BOOKING_MAST.Uom_code and
TBL_BOOKING_MAST.Agency_sub_code=AGENCY_MAST.code_subcode AND
tbl_booking_insert.Ad_Cat=adv_cat_mast.Adv_Cat_Code and
tbl_booking_mast.Ad_type_code=adv_type_mast.Adv_Type_Code
and adv_type_mast.Adv_Type_Code=adv_cat_mast.Adv_Type and
pub_mast.Pub_Code=TBL_BOOKING_insert.publication_Code and
tbl_booking_mast.cio_booking_id=tbl_booking_insert.Cio_Booking_Id '
--and ((tbl_booking_insert.Pub_Cent_Code in (select distinct pub_center from login_center where newuser_id='''+@puserid+''') and '''+@chk_access+'''=''1'')
--or  ('''+@chk_access+'''=''0'') )' 

IF(@fromdate IS NOT NULL AND @dateto IS NOT NULL) begin
	set @query4=@query4+' and tbl_booking_insert.Insert_Date between  '''+@fromdate +''' and  '''+@dateto+''' '
END

IF(@p_baxcode IS NOT NULL and @p_baxcode <>'') begin
	set @query4=@query4 + ' and tbl_booking_mast.Box_code ='''+@p_baxcode+''''
END 

if(@base='2')begin
	set @query4=@query4 +' and (tbl_booking_mast.Executive_code is not null and tbl_booking_mast.Executive_code !=''0'')  '
end 

if(@base='3')begin
	set @query4=@query4 +' and (tbl_booking_mast.retainer IS NOT NULL and retainer <>''''  and tbl_booking_mast.RETAINER !=''0'')  '
end 


if(@drpstatus is null or  @drpstatus = '') begin
	set @query4=@query4+' and lower(Insert_Status)!=''cancel'''
end 

if(@insertstatus is not null and @insertstatus<>'' ) begin
	set @query4=@query4+' and lower(Insert_Status)='''+@insertstatus+''''
end 





IF(@publication IS NOT NULL) begin
	set @query4=@query4 +' and TBL_BOOKING_insert.publication_Code='''+@publication+'''    '
END 

/*IF(@pub_cent IS NOT NULL and @pub_cent <>'')
begin
--set @query4=@query4 +'  and tbl_booking_insert.Pub_Cent_Code='''+@pub_cent+''''
set @query4=@query4+'  and TBL_BOOKING_MAST.branch IN (SELECT Branch_Name FROM BRANCH_MST WHERE TBL_BOOKING_MAST.branch=Branch_Name and pub_center in (SELECT Pub_cent_Code FROM PUB_CENT_MAST WHERE  branch_mst.pub_center=pub_cent_mast.Pub_cent_Code and Pub_cent_Code='''+@pub_cent+'''))'

END 
IF(@branch IS NOT NULL and @branch<>'')
begin
set @query4=@query4 +'  and tbl_booking_mast.branch ='''+@branch+''''
END 

*/

IF(@pub_cent IS NOT NULL) begin
	set @query4=@query4+'  and TBL_BOOKING_MAST."branch" IN (SELECT "Branch_Code" FROM BRANCH_MST WHERE TBL_BOOKING_MAST."branch"="Branch_Code" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"='''+@pub_cent+'''))'
END 


IF(@branch IS NOT NULL  and @branch<>'') begin
	set @query4=@query4+'  and TBL_BOOKING_mast."branch" = (SELECT "Branch_Code" FROM BRANCH_MST where "Branch_Name" ='''+@branch+''') ';
END 


IF(@edition IS NOT NULL and @edition<>'') begin
	set @query4=@query4 +'  and tbl_booking_insert.Edition_Code='''+@edition+''''
END 



IF(@region IS NOT NULL and @region <>'') begin
	--set @query4=@query4  +' and tbl_booking_insert.Pub_Cent_Code in(select pub_cent_mast.Pub_cent_Code from pub_cent_mast where pub_cent_mast.Region_code ='''+@region +''')'
	set @query4=@query4  +' and agency_mast.region ='''+@region+''''
END 

IF(@revcenter IS NOT NULL and @revcenter <>'') begin
	set @query4=@query4  +' and tbl_booking_mast.Revenue_center ='''+@revcenter+''''
END 

IF(@adtype IS NOT NULL and @adtype <>'') begin
	set @query4=@query4  + ' and TBL_BOOKING_MAST.Ad_type_code='''+@adtype+''''
END 

IF(@agencytype IS NOT NULL and @agencytype <>'') begin
	set @query4=@query4  + ' and TBL_BOOKING_MAST.Agency_type ='''+@agencytype+''''
END 

IF(@adcat IS NOT NULL and @adcat <>'') begin
	set @query4=@query4  + ' and TBL_BOOKING_insert.Ad_Cat ='''+@adcat+''''
END 

IF(@adsubcat IS NOT NULL and @adsubcat <>'') begin
	set @query4=@query4  + ' and TBL_BOOKING_MAST.Ad_sub_cat_code ='''+@adsubcat+''''
END 

IF(@adsubcat3 IS NOT NULL and @adsubcat3 <>'') begin
	set @query4=@query4  + ' and TBL_BOOKING_MAST.Ad_Subcat3 ='''+@adsubcat3+''''
END 

IF(@adsubcat4 IS NOT NULL and @adsubcat4 <>'') begin
	set @query4=@query4  + ' and TBL_BOOKING_MAST.Ad_Subcat4 ='''+@adsubcat4+''''
END 

IF(@adsubcat5 IS NOT NULL and @adsubcat5 <>'') begin
	set @query4=@query4  + ' and TBL_BOOKING_MAST.Ad_subcat5 ='''+@adsubcat5+''''
END 

IF(@package IS NOT NULL and @package <>'') begin
	set @query4=@query4  + ' and TBL_BOOKING_MAST.Package_code ='''+@package+''''
END 

IF(@scheme IS NOT NULL and @scheme <>'') begin
	set @query4=@query4  + ' and TBL_BOOKING_MAST.Scheme_type_code ='''+@scheme+''''
END 

IF(@agency IS NOT NULL and @agency <>'') begin
	set @query4=@query4  + ' and TBL_BOOKING_MAST.Agency_code ='''+@agency+''''
END 

IF(@client IS NOT NULL and @client  <>'') begin
	set @query4=@query4  + ' and TBL_BOOKING_MAST.Client_code ='''+@client+''''
END 

IF(@executive IS NOT NULL and @executive <>'') begin
	set @query4=@query4  + ' and TBL_BOOKING_MAST.Executive_code ='''+@executive+''''
END 

IF(@retainer IS NOT NULL and @retainer <>'') begin
	set @query4=@query4  + ' and TBL_BOOKING_MAST.RETAINER ='''+@retainer+''''
END 

IF(@product IS NOT NULL and @product <>'') begin
	set @query4=@query4 + ' and TBL_BOOKING_MAST.Product_code ='''+@product+''''
END 

IF(@brand IS NOT NULL and @brand <>'') begin
	set @query4=@query4  + ' and TBL_BOOKING_MAST.Brand_code ='''+@brand+''''
END 

IF(@varient IS NOT NULL and @varient <>'') begin
	set @query4=@query4  + ' and TBL_BOOKING_MAST.Variant_code ='''+@varient+''''
END 

IF(@pagetype IS NOT NULL and @pagetype <>'') begin
	set @query4=@query4  + ' and TBL_BOOKING_MAST.Page_type_code ='''+@pagetype+''''
END 

IF(@pageprem IS NOT NULL and @pageprem <>'') begin
	set @query4=@query4 + ' and TBL_BOOKING_insert.Premium1 ='''+@pageprem+''''
END 

IF(@postprem IS NOT NULL and @postprem <>'') begin
	set @query4=@query4 + ' and TBL_BOOKING_insert.Page_Post ='''+@postprem+''''
END 

IF(@rostatus IS NOT NULL and @rostatus <>'') begin
	set @query4=@query4 + ' and TBL_BOOKING_MAST.ro_status ='''+@rostatus+''''
END 

IF(@booktype IS NOT NULL and @booktype <>'') begin
	set @query4=@query4 + ' and TBL_BOOKING_MAST.Booking_type ='''+@booktype+''''
END 

IF(@contractname  IS NOT NULL and @contractname<>'') begin
	set @query4=@query4 + ' and TBL_BOOKING_MAST.Contract_name ='''+@contractname +''''
END 

IF(@suppliment  IS NOT NULL and @suppliment  <>'') begin
	set @query4=@query4 + ' and tbl_booking_insert.Supp_Code ='''+@suppliment+''''
END 

IF(@ratetype  IS NOT NULL and @ratetype  <>'') begin
	set @query4=@query4 + ' and tbl_booking_MAST.Rate_code ='''+@ratetype+''''
END 

IF(@city  IS NOT NULL and @city  <>'') begin
	if(@base='1')begin
		set @query4=@query4 + ' and AGENCY_MAST.City_Code ='''+@city+''''
	end 

	if(@base='2')begin
		set @query4=@query4 + ' and tbl_booking_mast.Executive_code in(select exec_mast.Exe_no from exec_mast where exec_mast.city_code ='''+@city+''' )'
	end 

	if(@base='3')begin
		set @query4=@query4 + ' and tbl_booking_mast.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.City_Code='''+@city+''')'
	end 
END 

IF(@zone  IS NOT NULL and @zone  <>'') begin
	if(@base='1')begin
		set @query4=@query4 + ' and AGENCY_MAST.zone_code ='''+@zone+''''
	end 

	if(@base='2')begin
		set @query4=@query4 + ' and tbl_booking_mast.Executive_code in(select exec_mast.Exe_no from exec_mast where exec_mast.city_code in (select city_mst.City_Code from city_mst where city_mst.Zone_Code= '''+@zone+''') )'
	end 

	if(@base='3')begin
		set @query4=@query4 + ' and tbl_booking_mast.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.Zone_Code='''+@zone+''')'
	end 
END 

IF(@district  IS NOT NULL and @district  <>'') begin
	if(@base='1')begin
		set @query4=@query4 + ' and AGENCY_MAST.Dist_Code ='''+@district+''''
	end 

	if(@base='2')begin
		set @query4=@query4 + ' and tbl_booking_mast.Executive_code in(select exec_mast.Exe_no from exec_mast where exec_mast.dist_code ='''+@district+''' )'
	end 

	if(@base='3')begin
		set @query4=@query4 + ' and tbl_booking_mast.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.Dist_Code='''+@district+''')'
	end
END 

IF(@state  IS NOT NULL and @state  <>'') begin
	if(@base='1')begin
		set @query4=@query4 + ' and AGENCY_MAST.State_Code ='''+@state+''''
	end 

	if(@base='2')begin
		set @query4=@query4 + ' and tbl_booking_mast.Executive_code in(select exec_mast.Exe_no from exec_mast where exec_mast.State_code ='''+@state+''' )'
	end 

	if(@base='3')begin
		set @query4=@query4 + ' and tbl_booking_mast.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.State_Code='''+@state+''')'
	end
END 

IF(@taluka  IS NOT NULL and @taluka  <>'') begin
	if(@base='1')begin
		set @query4=@query4 + ' and AGENCY_MAST.TALUKA='''+@taluka+'''  '
	end 

	if(@base='2')begin
		set @query4=@query4 + ' and tbl_booking_mast.Executive_code in(select exec_mast.Exe_no from exec_mast where exec_mast.TALUKA ='''+@taluka+''' )'
	end 

	if(@base='3')begin
		set @query4=@query4 + ' and tbl_booking_mast.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.TALUKA='''+@taluka+''')'
	end
END 

set @query4=@query4 + ' order by tbl_booking_insert.Insert_Date ,TBL_BOOKING_MAST.cio_booking_id'

print(@query3+@query4)
exec(@query3+@query4)

end end

else

if(@adcheck=1) begin
print('prachi')
print(@adsubcat3)
print(@adsubcat4)
set @query1='SELECT
CASE '''+@dateformat+'''
WHEN ''mm/dd/yyyy'' then CONVERT(varchar(10),a.date_time,101)
WHEN ''dd/mm/yyyy'' then CONVERT(varchar(10),a.date_time,103)
WHEN ''yyyy/mm/dd'' then CONVERT(varchar(10),a.date_time,111) END as "Date",
sum(a.No_of_insertion) as noinsert,
sum(a.Paid_ins) as Paidinsert,sum(a.Total_area) as Area,
sum(a.Card_amount) as cardamt,
sum(a.Deviation) as Deviationamt,
round(((isnull(sum(a.Deviation),0)*100)/sum(a.Card_amount)),2) AS  "Deviation(%)",
sum(a.Agreed_amount) as aggamt,
(sum(a.Card_amount)-
case isnull(sum(a.Agreed_amount),0)
when 0 then sum(a.Card_amount)
else sum(a.Agreed_amount) end)  as DiscAmt,
round((((sum(a.Card_amount)- 
case isnull(sum(a.Agreed_amount),0)
when 0 then sum(a.Card_amount)
else sum(a.Agreed_amount) end ) *100) /sum(a.Card_amount)),2)  as Discper,
sum(dbo.FETCH_RATAMT(a.cio_booking_id ,''1'',''1'')) as  posamt,
round(((sum(dbo.FETCH_RATAMT(a.cio_booking_id ,''1'',''1''))*100)/sum(a.Card_amount)),2)   as  "pos(%)",
sum(a.Special_disc_per * a.Total_area * a.Card_rate/100) as Spdiscamt,
round(((sum(a.Special_disc_per * a.Total_area * a.Card_rate/100)*100)/sum(a.Card_amount)),2)  as Spdiscper,
sum(a.Space_disc_per * a.Total_area * a.Card_rate/100) as Spacedisc,
round(((sum(a.Space_disc_per * a.Total_area * a.Card_rate/100) *100)/sum(a.Card_amount)),2) as Spacediscper,
sum(a.Special_charges) as Specialcharge,
round(((sum(isnull((isnull(a.Gross_amount,''0'')*isnull(a.ADD_AGENCY_COMM,''0'')/100),''0''))*100)/(sum(a.Card_amount)+sum(dbo.FETCH_RATAMT(a.cio_booking_id ,''1'',''1''))+sum(a.Special_charges)-sum(a.Deviation)-(sum(a.Card_amount)- 
case isnull(sum(a.Agreed_amount),0)
when 0 then sum(a.Card_amount)
else sum(a.Agreed_amount) end) -sum(a.Space_disc_per * a.Total_area * a.Card_rate/100)-sum(a.Special_disc_per * a.Total_area * a.Card_rate/100))),2) as  "AgencyAddlTD(%)",
sum(isnull((isnull(a.Gross_amount,''0'')*isnull(a.ADD_AGENCY_COMM,''0'')/100),''0'')) as AgencyAddlTDAmt,
sum(isnull(a.Gross_amount,''0'')) as Grossamt,
round(((sum(isnull(dbo.fun_actual('''+@compcode+''',isnull(a.ADD_AGENCY_COMM,''0'' ),isnull(a.RETAINER,''0''),isnull(a.Gross_amount,''0''),'''+@prefer+''',''4'' ),''0''))*100)/sum(isnull(a.Gross_amount,''0''))),2) as  "RetTD(%)",
sum(isnull(dbo.fun_actual('''+@compcode+''',isnull(a.ADD_AGENCY_COMM,''0'' ),isnull(a.RETAINER,''0''),isnull(a.Gross_amount,''0''),'''+@prefer+''',''4'' ),''0''))as RetTDAmt,
round(((sum((isnull(a.Gross_amount,''0'')* isnull(a.Trade_disc,''0'' )/100) )*100)/(sum(a.Card_amount)+sum(dbo.FETCH_RATAMT(a.cio_booking_id ,''1'',''1''))+sum(a.Special_charges)-sum(a.Deviation)-(sum(a.Card_amount)- 
case isnull(sum(a.Agreed_amount),0)
when 0 then sum(a.Card_amount)
else sum(a.Agreed_amount)end) -sum(a.Space_disc_per * a.Total_area * a.Card_rate/100)-sum(a.Special_disc_per * a.Total_area * a.Card_rate/100))),2)as "AgencyTD(%)",
sum((isnull(a.Gross_amount,''0'')* isnull(a.Trade_disc,''0'' )/100) )as AgencyTDAmt,
sum(isnull(a.Bill_amount,''0'')) as Billamt,
round(((sum(isnull(dbo.fun_actual('''+@compcode+''',isnull(a.ADD_AGENCY_COMM,''0'' ),isnull(a.RETAINER,''0''),isnull(a.Gross_amount,''0''),'''+@prefer+''',''2'' ),''0''))*100)/sum(isnull(a.Gross_amount,''0''))),2) as "RetComm(%)",
sum(isnull(dbo.fun_actual('''+@compcode+''',isnull(a.ADD_AGENCY_COMM,''0'' ),isnull(a.RETAINER,''0''),isnull(a.Gross_amount,''0''),'''+@prefer+''',''2'' ),''0'')) as RetCommAmt,
sum(isnull((a.Bill_amount-isnull(dbo.fun_actual('''+@compcode+''',isnull(a.ADD_AGENCY_COMM,''0'' ),isnull(a.RETAINER,''0''),isnull(a.Gross_amount,''0''),'''+@prefer+''',''2'' ),''0'')  ),''0'') )as ActualBusiness
FROM TBL_BOOKING_MAST a,
agency_mast
WHERE a.Comp_code='''+@compcode+''' AND
a.Agency_sub_code=AGENCY_MAST.code_subcode' 
PRINT 'SSK'
PRINT @QUERY1

if(@query4='' or @query4 is null) begin

	IF(@fromdate IS NOT NULL AND @dateto IS NOT NULL and @filterby='Booking Date' ) begin
		set @query4=' and a.date_time between  '''+@fromdate +''' and  '''+@dateto+''' '
	END 


	IF(@fromdate IS NOT NULL AND @dateto IS NOT NULL and @filterby='Publish Date' ) begin
		set @query4=' and a.Insertion_date  between  '''+@fromdate +''' and  '''+@dateto+''' '
	END 

end
else begin 

	IF(@fromdate IS NOT NULL AND @dateto IS NOT NULL and @filterby='Booking Date' ) begin
		set @query4=@query4+' and a.date_time between  '''+@fromdate +''' and  '''+@dateto+''' '
	END 

	IF(@fromdate IS NOT NULL AND @dateto IS NOT NULL and @filterby='Publish Date' ) begin
		set @query4=@query4+' and a.Insertion_date  between  '''+@fromdate +''' and  '''+@dateto+''' '
	END 

end
/*if(@chk_access='1')begin
	set @query4=@query4+' and a.cio_booking_id  in (select distinct b.Cio_Booking_Id from tbl_booking_insert b where a.cio_booking_id=b.Cio_Booking_Id and b.Pub_Cent_Code in (select distinct pub_center from login_center where newuser_id='''+@puserid+''')) ';
end 
*/
if(@base='2')begin
	set @query4=@query4+' and (a.Executive_code is not null and a.Executive_code !=''0'')  '
end 

if(@base='3')begin
	set @query4=@query4+' and (a.retainer IS NOT NULL and retainer <>''  and a.RETAINER !=''0'')  '
end 


if(@drpstatus is null or  @drpstatus = '') begin
	set @query4=@query4+' and a.cio_booking_id  in (select distinct b.Cio_Booking_Id from tbl_booking_insert b where a.cio_booking_id=b.Cio_Booking_Id AND lower(Insert_Status)!='''+'cancel'+''' )'
end 

if(@insertstatus is not null and @insertstatus<>'') begin
	set @query4=@query4+' and a.cio_booking_id  in (select distinct b.Cio_Booking_Id from tbl_booking_insert b where a.cio_booking_id=b.Cio_Booking_Id AND lower(Insert_Status)='''+@insertstatus+''' )';
end 


IF(@publication IS NOT NULL) begin
	set @query4=@query4+'  and a.cio_booking_id  in (select distinct b.Cio_Booking_Id from tbl_booking_insert b where b.publication_Code='''+@publication+''' )    '
END 

/*
IF(@pub_cent IS NOT NULL and @pub_cent <>'') begin
	--set @query4=@query4+' and a.cio_booking_id  in (select distinct b.Cio_Booking_Id from tbl_booking_insert b where b.Pub_Cent_Code='''+@pub_cent+''' )  '
	set @query4=@query4+'  and a.branch IN (SELECT Branch_Name FROM BRANCH_MST WHERE a.branch=Branch_Name and pub_center in (SELECT Pub_cent_Code FROM PUB_CENT_MAST WHERE  branch_mst.pub_center=pub_cent_mast.Pub_cent_Code and Pub_cent_Code='''+@pub_cent+'''))'
END 
IF(@branch IS NOT NULL and @branch<>'') begin
	set @query4=@query4+' and a.branch ='''+@branch+''''
END */



IF(@pub_cent IS NOT NULL) begin
	set @query4=@query4+'  and a."branch" IN (SELECT "Branch_Code" FROM BRANCH_MST WHERE a."branch"="Branch_Code" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"='''+@pub_cent+'''))'
END 


IF(@branch IS NOT NULL  and @branch<>'') begin
	set @query4=@query4+'  and a."branch" = (SELECT "Branch_Code" FROM BRANCH_MST where "Branch_Name" ='''+@branch+''') ';
END 


IF(@edition IS NOT NULL and @edition<>'') begin
	set @query4=@query4+' and a.cio_booking_id  in (select distinct b.Cio_Booking_Id from tbl_booking_insert b where b.Edition_Code='''+@edition+''' )'
END 



IF(@region IS NOT NULL and @region <>'') begin
	--set @query4=@query4 +'  and a.cio_booking_id  in (select distinct b.Cio_Booking_Id from tbl_booking_insert b where b.Pub_Cent_Code in(select pub_cent_mast.Pub_cent_Code from pub_cent_mast where pub_cent_mast.Region_code ='''+@region +''') )'
	set @query4=@query4 +'  and agency_mast.region ='''+@region+''''
END 

IF(@suppliment  IS NOT NULL and @suppliment  <>'') begin
	set @query4=@query4 + '  and a.cio_booking_id  in (select distinct b.Cio_Booking_Id from tbl_booking_insert b where b.Supp_Code ='''+@suppliment+''' )'
END 


IF(@revcenter IS NOT NULL and @revcenter <>'') begin
	set @query4=@query4 +' and a.Revenue_center ='''+@revcenter+''''
END 

IF(@adtype IS NOT NULL and @adtype <>'') begin
	set @query4=@query4 + ' and a.Ad_type_code='''+@adtype+''''
END 

IF(@agencytype IS NOT NULL and @agencytype <>'') begin
	set @query4=@query4 + ' and a.Agency_type ='''+@agencytype+''''
END 

IF(@adcat IS NOT NULL and @adcat <>'') begin
	set @query4=@query4 + ' and a.Ad_cat_code ='''+@adcat+''''
END 

IF(@adsubcat IS NOT NULL and @adsubcat <>'') begin
	set @query4=@query4 + ' and a.Ad_sub_cat_code ='''+@adsubcat+''''
END 

IF(@adsubcat3 IS NOT NULL and @adsubcat3 <>'') begin
	set @query4=@query4 + ' and a.Ad_Subcat3 ='''+@adsubcat3+''''
END 

IF(@adsubcat4 IS NOT NULL and @adsubcat4 <>'') begin
	set @query4=@query4 + ' and a.Ad_Subcat4 ='''+@adsubcat4+''''
END 

IF(@adsubcat5 IS NOT NULL and @adsubcat5 <>'') begin
	set @query4=@query4 + ' and a.Ad_subcat5 ='''+@adsubcat5+''''
END 

IF(@package IS NOT NULL and @package <>'') begin
	set @query4=@query4 + ' and a.Package_code ='''+@package+''''
END 

IF(@scheme IS NOT NULL and @scheme <>'') begin
	set @query4=@query4 + ' and a.Scheme_type_code ='''+@scheme+''''
END 

IF(@agency IS NOT NULL and @agency <>'') begin
	set @query4=@query4 + ' and a.Agency_code ='''+@agency+''''
END 

IF(@client IS NOT NULL and @client  <>'') begin
	set @query4=@query4 + ' and a.Client_code ='''+@client+''''
END 

IF(@executive IS NOT NULL and @executive <>'') begin
	set @query4=@query4 + ' and a.Executive_code ='''+@executive+''''
END 

IF(@retainer IS NOT NULL and @retainer <>'') begin
	set @query4=@query4 + ' and a.RETAINER ='''+@retainer+''''
END 

IF(@product IS NOT NULL and @product <>'') begin
	set @query4=@query4 + ' and a.Product_code ='''+@product+''''
END 

IF(@brand IS NOT NULL and @brand <>'') begin
	set @query4=@query4 + ' and a.Brand_code ='''+@brand+''''
END 

IF(@varient IS NOT NULL and @varient <>'') begin
	set @query4=@query4 + ' and a.Variant_code ='''+@varient+''''
END 

IF(@pagetype IS NOT NULL and @pagetype <>'') begin
	set @query4=@query4 + ' and a.Page_type_code ='''+@pagetype+''''
END 

IF(@pageprem IS NOT NULL and @pageprem <>'') begin
	set @query4=@query4 + ' and a.Page_prem ='''+@pageprem+''''
END 

IF(@postprem IS NOT NULL and @postprem <>'') begin
	set @query4=@query4 + ' and a.Page_position_code ='''+@postprem+''''
END 

IF(@rostatus IS NOT NULL and @rostatus <>'') begin
	set @query4=@query4 + ' and a.ro_status ='''+@rostatus+''''
END 

IF(@booktype IS NOT NULL and @booktype <>'') begin
	set @query4=@query4 + ' and a.Booking_type ='''+@booktype+''''
END 

IF(@contractname  IS NOT NULL and @contractname<>'') begin
	set @query4=@query4 + ' and a.Contract_name ='''+@contractname +''''
END 



IF(@ratetype  IS NOT NULL and @ratetype  <>'') begin
	set @query4=@query4 + ' and a.Rate_code ='''+@ratetype+''''
END 

IF(@city  IS NOT NULL and @city  <>'') begin
	if(@base='1')begin
		set @query4=@query4 + ' and AGENCY_MAST.City_Code ='''+@city+''''
	end 

	if(@base='2')begin
		set @query4=@query4 + ' and a.Executive_code in(select exec_mast.Exe_no from exec_mast where exec_mast.city_code ='''+@city+''' )'
	end 

	if(@base='3')begin
		set @query4=@query4 + ' and a.RETAINER in(select RET.Retain_Code from  RETAINERMASTER RET where  RET.City_Code='''+@city+''')'
	end 
END 

IF(@zone  IS NOT NULL and @zone  <>'') begin
	if(@base='1')begin
		set @query4=@query4 + ' and AGENCY_MAST.zone_code ='''+@zone+''''
	end 

	if(@base='2')begin
		set @query4=@query4 + ' and a.Executive_code in(select exec_mast.Exe_no from exec_mast where exec_mast.city_code in (select city_mst.City_Code from city_mst where city_mst.Zone_Code= '''+@zone+''') )'
	end 

	if(@base='3')begin
		set @query4=@query4 + ' and a.RETAINER in(select RET.Retain_Code from  RETAINERMASTER RET where  RET.Zone_Code='''+@zone+''')'
	end 
END 

IF(@district  IS NOT NULL and @district  <>'') begin
	if(@base='1')begin
		set @query4=@query4 + ' and AGENCY_MAST.Dist_Code ='''+@district+''''
	end 

	if(@base='2')begin
		set @query4=@query4 + ' and a.Executive_code in(select exec_mast.Exe_no from exec_mast where exec_mast.dist_code ='''+@district+''' )'
	end 

	if(@base='3')begin
		set @query4=@query4 + ' and a.RETAINER in(select RET.Retain_Code from  RETAINERMASTER RET where  RET.Dist_Code='''+@district+''')'
	end 
END 

IF(@state  IS NOT NULL and @state  <>'') begin
	if(@base='1')begin
		set @query4=@query4 + ' and AGENCY_MAST.State_Code ='''+@state+''''
	end 

	if(@base='2')begin
		set @query4=@query4 + ' and a.Executive_code in(select exec_mast.Exe_no from exec_mast where exec_mast.State_code ='''+@state+''' )'
	end 

	if(@base='3')begin
		set @query4=@query4 + ' and a.RETAINER in(select RET.Retain_Code from  RETAINERMASTER RET where  RET.State_Code='''+@state+''')'
	end 
END 

IF(@taluka  IS NOT NULL and @taluka  <>'') begin
	if(@base='1')begin
		set @query4=@query4 + ' and AGENCY_MAST.TALUKA='''+@taluka+'''  '
	end 

	if(@base='2')begin
		set @query4=@query4 + ' and a.Executive_code in(select exec_mast.Exe_no from exec_mast where exec_mast.TALUKA ='''+@taluka+''' )'
	end 

	if(@base='3')begin
		set @query4=@query4 + ' and a.RETAINER in(select RET.Retain_Code from  RETAINERMASTER RET where  RET.TALUKA='''+@taluka+''')'
	end 
END 

set @query4=@query4 + ' group by a.date_time order by Date '


print(@query1+@query4)
exec(@query1+@query4)
end

else if(@adcheck=2)begin


open c2
fetch next from c2 into @v2_CIOID,@v2_BILLNO,@v2_AGMAINCODE,@v2_AG_SUB_CODE,@v2_AGCODE,@v2_AGNAME,@v2_EXECCODE,@v2_EXECNAME,@v2_RETCODE,@v2_RETNAME
	while @@FETCH_STATUS=0 begin
		insert into #temp_ad_bills_report select * from dbo.FUN_BILL_INSERT(@compcode,@v2_CIOID,@v2_BILLNO,@prefer,@dateformat,@v2_AGMAINCODE,@v2_AG_SUB_CODE,@v2_AGCODE,@v2_AGNAME,@v2_EXECCODE,@v2_EXECNAME,@v2_RETCODE,@v2_RETNAME,@base )  

fetch next from c2 into @v2_CIOID,@v2_BILLNO,@v2_AGMAINCODE,@v2_AG_SUB_CODE,@v2_AGCODE,@v2_AGNAME,@v2_EXECCODE,@v2_EXECNAME,@v2_RETCODE,@v2_RETNAME

end
close c2



set @query2='SELECT 
CASE '''+@dateformat+'''
WHEN ''mm/dd/yyyy'' then CONVERT(varchar(10),BILLDATE,101)
WHEN ''dd/mm/yyyy'' then CONVERT(varchar(10),BILLDATE,103)
WHEN ''yyyy/mm/dd'' then CONVERT(varchar(10),BILLDATE,111) END AS "Date",
sum(NOINSERT) as "noinsert",
sum(PAIDINSERT) as "Paidinsert" ,
sum(AREA) as "Area",
sum(CARDAMT) as "cardamt",
sum(DEVIATIONAMT) as "Deviationamt",
case isnull(sum(CARDAMT),0)
when 0 then 0
else round(((isnull(sum(DEVIATIONAMT),0) *100)/isnull(sum(CARDAMT),0)),2) end  AS "Deviation(%)",

sum(AGGAMT)  as "aggamt",
sum(DISCAMT) as "DiscAmt",
case isnull(sum(CARDAMT),0)
when 0 then 0
else round(((isnull(sum(DISCAMT),0) *100)/isnull(sum(CARDAMT),0)),2) end as "Discper",

sum(POSAMT)as  "posamt",
case isnull(sum(CARDAMT),0)
when 0 then 0
else round(((isnull(sum(POSAMT),0) *100)/isnull(sum(CARDAMT),0)),2) end as "pos(%)",

sum(SPDISCAMT) as "Spdiscamt",
case isnull(sum(CARDAMT),0)
when 0 then 0
else round(((isnull(sum(SPDISCAMT),0)*100)/isnull(sum(CARDAMT),0)),2) end as "Spdiscper",

sum(SPACEDISC) as "Spacedisc",
case isnull(sum(CARDAMT),0)
when 0 then 0
else round(((isnull(sum(SPACEDISC),0)*100)/isnull(sum(CARDAMT),0)),2) end as "Spacediscper",

sum(SPECIALCHARGE) as "Specialcharge",
sum(AGENCYADDLTDAMT) as "AgencyAddlTDAmt",
case (isnull(sum(CARDAMT),0)+isnull(sum(POSAMT),0)+isnull(sum(SPECIALCHARGE),0)-isnull(sum(DEVIATIONAMT),0)-isnull(sum(DISCAMT),0)-isnull(sum(SPDISCAMT),0)-isnull(sum(SPACEDISC),0))
when 0 then 0
else round(((isnull(sum(AGENCYADDLTDAMT),0)*100)/(isnull(sum(CARDAMT),0)+isnull(sum(POSAMT),0)+isnull(sum(SPECIALCHARGE),0)-isnull(sum(DEVIATIONAMT),0)-isnull(sum(DISCAMT),0)-isnull(sum(SPDISCAMT),0)-isnull(sum(SPACEDISC),0))),2) end as "AgencyAddlTD(%)",

sum(GROSSAMT)  as "Grossamt",
sum(RETTDAMT)as "RetTDAmt",
case isnull(sum(GROSSAMT),0) 
when 0 then 0
else round(((isnull(sum(RETTDAMT),0)*100)/isnull(sum(GROSSAMT),0) ),2) end as "RetTD(%)",

sum(AGENCYTDAMT)as "AgencyTDAmt",
case (isnull(sum(CARDAMT),0)+isnull(sum(POSAMT),0)+isnull(sum(SPECIALCHARGE),0)-isnull(sum(DEVIATIONAMT),0)-isnull(sum(DISCAMT),0)-isnull(sum(SPDISCAMT),0)-isnull(sum(SPACEDISC),0))
when 0 then 0
else round(((isnull(sum(AGENCYTDAMT),0)*100)/(isnull(sum(CARDAMT),0)+isnull(sum(POSAMT),0)+isnull(sum(SPECIALCHARGE),0)-isnull(sum(DEVIATIONAMT),0)-isnull(sum(DISCAMT),0)-isnull(sum(SPDISCAMT),0)-isnull(sum(SPACEDISC),0))),2) end as "AgencyTD(%)",

sum(BILLAMT )as "Billamt",
sum(RETCOMMAMT)as "RetCommAmt",
case isnull(sum(GROSSAMT),0)
when 0 then 0
else round(((isnull(sum(RETCOMMAMT),0)*100)/isnull(sum(GROSSAMT),0)),2) end as "RetComm(%)",

sum(ACTUALBUSINESS)as "ActualBusiness"
from #temp_ad_bills_report where '



IF(@fromdate IS NOT NULL AND @dateto IS NOT NULL ) begin
	set @query4= '  BILLDATE between  '''+@fromdate +''' and  '''+@dateto+''' '
END 

IF(@publication IS NOT NULL and @publication<>'') begin
	set @query4=@query4+ ' and PRIPUB='''+@publication+''''
END 

IF(@pub_cent IS NOT NULL and @pub_cent<>'') begin
	set @query4=@query4+ '   and PUB_CENT_CODE='''+@pub_cent+''''
END 

IF(@edition IS NOT NULL and @edition<>'') begin
	set @query4=@query4+ '  and PEDITION='''+@edition+''''
END 

IF(@branch IS NOT NULL and @branch<>'') begin
	set @query4=@query4+ '  and  BRANCH_NAME ='''+@branch+''' '
END 

IF(@region IS NOT NULL and @region<>'') begin
	set @query4=@query4 +' and REGION='''+@region +''''
END 

IF(@adtype IS NOT NULL and @adtype<>'') begin
	set @query4=@query4 + ' and PADTYPE='''+@adtype+''''
END 

IF(@agencytype IS NOT NULL and @agencytype<>'') begin
	set @query4=@query4 + ' and AGENCY_TYPE_CODE= '''+@agencytype+''''
END 

IF(@adcat IS NOT NULL and @adcat<>'') begin
	set @query4=@query4 + ' and PRIADCTG='''+@adcat+''''
END 

IF(@adsubcat IS NOT NULL and @adsubcat<>'') begin
	set @query4=@query4 + ' and SECADCTG ='''+@adsubcat+''''
END 

IF(@adsubcat3 IS NOT NULL and @adsubcat3<>'') begin
	set @query4=@query4 + ' and AD_SUBCAT3 ='''+@adsubcat3+''''
END 

IF(@adsubcat4 IS NOT NULL and @adsubcat4<>'') begin
	set @query4=@query4 + ' and AD_SUBCAT4 ='''+@adsubcat4+''''
END 

IF(@adsubcat5 IS NOT NULL and @adsubcat5<>'') begin
	set @query4=@query4 + ' and AD_SUBCAT5 ='''+@adsubcat5+''''
END 

IF(@package IS NOT NULL and @package<>'') begin
	set @query4=@query4 + ' and PACKAGE_CODE='''+@package+''''
END 

IF(@agency IS NOT NULL and @agency<>'') begin
	set @query4=@query4 + ' and AG_MAIN_CODE ='''+@agency +''''
END 

IF(@client IS NOT NULL and @client<>'') begin
	set @query4=@query4 + ' and CLIENTCD='''+@client +''''
END 

IF(@executive IS NOT NULL and @executive<>'') begin
	set @query4=@query4 + ' and EXECUTIVE_NAME='''+@executive+''''
END 

IF(@product IS NOT NULL and @product<>'') begin
	set @query4=@query4 + ' and PRIPROCTG='''+@product+''''
END 

IF(@brand IS NOT NULL and @brand<>'') begin
	set @query4=@query4 + ' and BRAND_CODE='''+@brand+''''
END 

IF(@varient IS NOT NULL and @varient<>'') begin
	set @query4=@query4 + ' and   VARIENT_NAME='''+@varient+''''
END 

IF(@pageprem IS NOT NULL and @pageprem<>'') begin
	set @query4=@query4 + ' and PAGE_PREM ='''+@pageprem+''''
END 

IF(@postprem IS NOT NULL and @postprem<>'') begin
	set @query4=@query4 + ' and PAGE_POST ='''+@postprem+''''
END 

IF(@contractname  IS NOT NULL and @contractname<>'') begin
	set @query4=@query4 + ' and CONTRACT_NAME ='''+@contractname +''''
END 

IF(@suppliment  IS NOT NULL and @suppliment<>'') begin
	set @query4=@query4 + ' and SUPP_CODE='''+@suppliment+''''
END 

IF(@retainer IS NOT NULL and @retainer<>'') begin
	set @query4=@query4 + ' and RETAINER_CODE='''+@retainer+''''
END 

IF(@ratetype  IS NOT NULL and @ratetype<>'') begin
	set @query4=@query4 + ' and RATECD ='''+@ratetype+''''
END 

IF(@scheme IS NOT NULL and @scheme<>'') begin
	set @query4=@query4 + ' and PSCHEME='''+@scheme+''''
END 

IF(@revcenter IS NOT NULL and @revcenter<>'') begin
	set @query4=@query4 +' and REVENUE_CENTER='''+@revcenter+''''
END 

IF(@rostatus IS NOT NULL and @rostatus<>'') begin
	set @query4=@query4 + ' and RO_STATUS='''+@rostatus+''''
END 

IF(@pagetype IS NOT NULL and @pagetype<>'') begin
	set @query4=@query4 + ' and PAGE_TYPE ='''+@pagetype+''''
END 

IF(@booktype IS NOT NULL and @booktype<>'') begin
	set @query4=@query4 + ' and BOOKING_TYPE='''+@booktype+''''
END 

IF(@city  IS NOT NULL and @city<>'') begin
	set @query4=@query4 + ' and CITY_CODE ='''+@city+''''
END 

IF(@zone  IS NOT NULL and @zone<>'') begin
	set @query4=@query4 + ' and ZONE_CODE ='''+@zone+''''
end 

IF(@district  IS NOT NULL and @district<>'') begin
	set @query4=@query4 + ' and DIST_CODE ='''+@district+''''
end 

IF(@state  IS NOT NULL and @state<>'') begin
	set @query4=@query4 + ' and STATE_CODE ='''+@state+''''
end 

IF(@taluka  IS NOT NULL and @taluka<>'') begin
	set @query4=@query4 + ' and PTALUKA='''+@taluka+'''  '
end 


if(@base='2')begin
	set @query4=@query4 +' and (EXECUTIVE_NAME   is not null and EXECUTIVE_NAME !=''0'')  '
end 

if(@base='3')begin
	set @query4=@query4 +' and (RETAINER_CODE  is not null  and RETAINER_CODE  !=''0'')  '
end 

set @query4=@query4 + ' group by BILLDATE'
set @query4=@query4 + ' order by BILLDATE'


print(@query2+@query4)
exec(@query2+@query4)
end 

else if(@adcheck=3) begin
set @query3='SELECT  distinct
CASE '''+@dateformat+'''
WHEN ''mm/dd/yyyy'' then CONVERT(varchar(10),b.Insert_Date,101)
WHEN ''dd/mm/yyyy'' then CONVERT(varchar(10),b.Insert_Date,103)
WHEN ''yyyy/mm/dd'' then CONVERT(varchar(10),b.Insert_Date,111) END as Date,
sum(a.No_of_insertion) as noinsert,
sum(a.Paid_ins) as Paidinsert,
sum(b.Size_Book) as Area,
sum(a.Card_rate*b.Size_Book) as cardamt,
sum(a.Deviation) as Deviationamt,
round(((sum(a.Deviation)*100)/sum(a.Card_rate*b.Size_Book)),2) AS  "Deviation(%)",
sum(b.Agreed_Rate)  as aggamt,
(sum(a.Card_rate*b.Size_Book)- 
case isnull(sum(b.Agreed_Rate),0)
when 0 then sum(a.Card_rate*b.Size_Book)
else sum(b.Agreed_Rate)end) as DiscAmt,
round((((sum(a.Card_rate*b.Size_Book)- 
case isnull(sum(b.Agreed_Rate),0)
when 0 then sum(a.Card_rate*b.Size_Book)
else sum(b.Agreed_Rate)end)*100)/sum(a.Card_rate*b.Size_Book)),2) as Discper,
sum(dbo.FETCH_RATAMT(a.cio_booking_id ,''1'',''1'') )as  posamt,
round(((sum(dbo.FETCH_RATAMT(a.cio_booking_id,''1'',''1''))*100)/sum(a.Card_rate*b.Size_Book)),2)  as  "pos(%)",
sum(a.Special_disc_per * b.Size_Book * a.Card_rate/100) as Spdiscamt,
round(((sum(a.Special_disc_per * b.Size_Book * a.Card_rate/100)*100)/sum(a.Card_rate*b.Size_Book)),2) as Spdiscper,
sum(a.Space_disc_per * b.Size_Book * a.Card_rate/100) as Spacedisc,
round(((sum(a.Space_disc_per * b.Size_Book * a.Card_rate/100)*100)/sum(a.Card_rate*b.Size_Book)),2) as Spacediscper,
sum(a.Special_charges) as Specialcharge,
round(((sum(isnull((isnull(b.Gross_Rate ,''0'')*isnull(a.ADD_AGENCY_COMM,''0'')/100),''0''))*100)/(sum(a.Card_rate*b.Size_Book)+sum(dbo.FETCH_RATAMT(a.cio_booking_id ,''1'',''1'') )+sum(a.Special_charges) -sum(a.Deviation)-(sum(a.Card_rate*b.Size_Book)- 
case isnull(sum(b.Agreed_Rate),0)
when 0 then sum(a.Card_rate*b.Size_Book)
else sum(b.Agreed_Rate)end)-sum(a.Special_discount)-sum(a.Space_discount))),2) as  "AgencyAddlTD(%)",
sum(isnull((isnull(b.Gross_Rate ,''0'')*isnull(a.ADD_AGENCY_COMM,''0'')/100),''0'')) as AgencyAddlTDAmt,
ROUND(sum(isnull(b.Gross_Rate,''0'') ),2)as Grossamt,
 case sum(isnull(b.Gross_Rate,''0'') )
 when  0 then 0
 else  round(((sum(isnull(dbo.fun_actual('''+ @compcode +''',isnull(a.ADD_AGENCY_COMM,''0'' ),isnull(a.RETAINER,''0''),isnull(b.Gross_Rate,''0''),'''+@prefer+''',''4'' ),''0''))*100)/sum(isnull(b.Gross_Rate,''0'') )),2)  
 end  as  "RetTD(%)",
sum(isnull(dbo.fun_actual('''+ @compcode +''',isnull(a.ADD_AGENCY_COMM,''0'' ),isnull(a.RETAINER,''0''),isnull(b.Gross_Rate,''0''),'''+@prefer+''',''4'' ),''0''))as RetTDAmt,
round(((sum((isnull(b.Gross_Rate,''0'')* isnull(a.Trade_disc,''0'' )/100 ))*100)/(sum(a.Card_rate*b.Size_Book)+sum(dbo.FETCH_RATAMT(a.cio_booking_id ,''1'',''1'') )+sum(a.Special_charges) -sum(a.Deviation)-(sum(a.Card_rate*b.Size_Book)- 
case isnull(sum(b.Agreed_Rate),0)
when 0 then sum(a.Card_rate*b.Size_Book)
else sum(b.Agreed_Rate)end)-sum(a.Special_discount)-sum(a.Space_discount))),2) as "AgencyTD(%)",
sum((isnull(b.Gross_Rate,''0'')* isnull(a.Trade_disc,''0'' )/100 ))as AgencyTDAmt,
ROUND(sum(isnull(b.Bill_Amt,''0'')),2) as Billamt,
 case sum(isnull(b.Gross_Rate,''0'') )
 when  0 then 0
 else  round(((sum(isnull(dbo.fun_actual('''+ @compcode +''',isnull(a.ADD_AGENCY_COMM,''0'' ),isnull(a.RETAINER,''0''),isnull(b.Gross_Rate,''0''),'''+@prefer+''',''2'' ),''0'') ) *100)/sum(isnull(b.Gross_Rate,''0'') )),2)  
 end  as "RetComm(%)",
sum(isnull(dbo.fun_actual('''+ @compcode +''',isnull(a.ADD_AGENCY_COMM,''0'' ),isnull(a.RETAINER,''0''),isnull(b.Gross_Rate,''0''),'''+@prefer+''',''2'' ),''0'') )as RetCommAmt,
ROUND(sum(isnull((  isnull(b.Bill_Amt,''0'')-isnull(dbo.fun_actual('''+ @compcode +''',isnull(a.ADD_AGENCY_COMM,''0'' ),isnull(a.RETAINER,''0''),isnull(b.Gross_Rate,''0''),'''+@prefer+''',''2'' ),''0'')  ),''0'')),2) as ActualBusiness
FROM TBL_BOOKING_MAST a,AGENCY_MAST ,
TBL_BOOKING_insert b
WHERE a.Comp_code='''+@compcode+''' AND
a.Agency_sub_code=AGENCY_MAST.code_subcode AND
a.cio_booking_id=b.Cio_Booking_Id '
--and ((b.Pub_Cent_Code in (select distinct pub_center from login_center where newuser_id='''+@puserid+''') and '''+@chk_access+'''=''1'')
--or  ('''+@chk_access+'''=''0'') )' 

IF(@fromdate IS NOT NULL AND @dateto IS NOT NULL) begin
	set @query4=' and b.Insert_Date between  '''+@fromdate +''' and  '''+@dateto+''' '
END 

if(@base='2')begin
	set @query4=@query4 +' and (a.Executive_code is not null and a.Executive_code !=''0'')  '
end 

if(@base='3')begin
	set @query4=@query4 +' and (a.retainer IS NOT NULL and retainer <>''  and a.RETAINER !=''0'')  '
end 


if(@drpstatus is null or  @drpstatus = '') begin
	set @query4=@query4+' and lower(Insert_Status)!='''+'cancel'+''''
end 

if(@insertstatus is not null and @insertstatus<>'' ) begin
	set @query4=@query4+' and lower(Insert_Status)='''+@insertstatus+''''
end 


IF(@publication IS NOT NULL) begin
	set @query4=@query4 +' and b.publication_Code='''+@publication+'''    '
END 

/*IF(@pub_cent IS NOT NULL and @pub_cent <>'')
begin
--set @query4=@query4 +'  and b.Pub_Cent_Code='''+@pub_cent+''''
set @query4=@query4+'  and a.branch IN (SELECT Branch_Name FROM BRANCH_MST WHERE a.branch=Branch_Name and pub_center in (SELECT Pub_cent_Code FROM PUB_CENT_MAST WHERE  branch_mst.pub_center=pub_cent_mast.Pub_cent_Code and Pub_cent_Code='''+@pub_cent+'''))'

END 
IF(@branch IS NOT NULL and @branch<>'')
begin
set @query4=@query4 +'  and a.branch ='''+@branch+''''
END */

IF(@pub_cent IS NOT NULL) begin
	set @query4=@query4+'  and a."branch" IN (SELECT "Branch_Code" FROM BRANCH_MST WHERE a."branch"="Branch_Code" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"='''+@pub_cent+'''))'
END 


IF(@branch IS NOT NULL  and @branch<>'') begin
	set @query4=@query4+'  and a."branch" = (SELECT "Branch_Code" FROM BRANCH_MST where "Branch_Name" ='''+@branch+''') ';
END 

IF(@edition IS NOT NULL and @edition<>'') begin
	set @query4=@query4 +'  and b.Edition_Code='''+@edition+''''
END 

IF(@region IS NOT NULL and @region <>'') begin
	--set @query4=@query4  +' and b.Pub_Cent_Code in(select pub_cent_mast.Pub_cent_Code from pub_cent_mast where pub_cent_mast.Region_code ='''+@region +''')'
	set @query4=@query4  +' and agency_mast.region ='''+@region+''''

END 

IF(@revcenter IS NOT NULL and @revcenter <>'') begin
	set @query4=@query4  +' and a.Revenue_center ='''+@revcenter+''''
END 

IF(@adtype IS NOT NULL and @adtype <>'') begin
	set @query4=@query4  + ' and a.Ad_type_code='''+@adtype+''''
END 

IF(@agencytype IS NOT NULL and @agencytype <>'') begin
	set @query4=@query4  + ' and a.Agency_type ='''+@agencytype+''''
END 

IF(@adcat IS NOT NULL and @adcat <>'') begin
	set @query4=@query4  + ' and b.Ad_Cat ='''+@adcat+''''
END 

IF(@adsubcat IS NOT NULL and @adsubcat <>'') begin
	set @query4=@query4  + ' and a.Ad_sub_cat_code ='''+@adsubcat+''''
END 

IF(@adsubcat3 IS NOT NULL and @adsubcat3 <>'') begin
	set @query4=@query4  + ' and a.Ad_Subcat3 ='''+@adsubcat3+''''
END 

IF(@adsubcat4 IS NOT NULL and @adsubcat4 <>'') begin
	set @query4=@query4  + ' and a.Ad_Subcat4 ='''+@adsubcat4+''''
END 

IF(@adsubcat5 IS NOT NULL and @adsubcat5 <>'') begin
	set @query4=@query4  + ' and a.Ad_subcat5 ='''+@adsubcat5+''''
END 

IF(@package IS NOT NULL and @package <>'') begin
	set @query4=@query4  + ' and a.Package_code ='''+@package+''''
END 

IF(@scheme IS NOT NULL and @scheme <>'') begin
	set @query4=@query4  + ' and a.Scheme_type_code ='''+@scheme+''''
END 

IF(@agency IS NOT NULL and @agency <>'') begin
	set @query4=@query4  + ' and a.Agency_code ='''+@agency+''''
END 

IF(@client IS NOT NULL and @client  <>'') begin
	set @query4=@query4  + ' and a.Client_code ='''+@client+''''
END 

IF(@executive IS NOT NULL and @executive <>'') begin
	set @query4=@query4  + ' and a.Executive_code ='''+@executive+''''
END 

IF(@retainer IS NOT NULL and @retainer <>'') begin
	set @query4=@query4  + ' and a.RETAINER ='''+@retainer+''''
END 

IF(@product IS NOT NULL and @product <>'') begin
	set @query4=@query4 + ' and a.Product_code ='''+@product+''''
END 

IF(@brand IS NOT NULL and @brand <>'') begin
	set @query4=@query4  + ' and a.Brand_code ='''+@brand+''''
END 

IF(@varient IS NOT NULL and @varient <>'') begin
	set @query4=@query4  + ' and a.Variant_code ='''+@varient+''''
END 

IF(@pagetype IS NOT NULL and @pagetype <>'') begin
	set @query4=@query4  + ' and a.Page_type_code ='''+@pagetype+''''
END 

IF(@pageprem IS NOT NULL and @pageprem <>'') begin
	set @query4=@query4 + ' and b.Premium1 ='''+@pageprem+''''
END 

IF(@postprem IS NOT NULL and @postprem <>'') begin
	set @query4=@query4 + ' and b.Page_Post ='''+@postprem+''''
END 

IF(@rostatus IS NOT NULL and @rostatus <>'') begin
	set @query4=@query4 + ' and a.ro_status ='''+@rostatus+''''
END 

IF(@booktype IS NOT NULL and @booktype <>'') begin
	set @query4=@query4 + ' and a.Booking_type ='''+@booktype+''''
END 

IF(@contractname  IS NOT NULL and @contractname<>'') begin
	set @query4=@query4 + ' and a.Contract_name ='''+@contractname +''''
END 

IF(@suppliment  IS NOT NULL and @suppliment  <>'') begin
	set @query4=@query4 + ' and b.Supp_Code ='''+@suppliment+''''
END 

IF(@ratetype  IS NOT NULL and @ratetype  <>'') begin
	set @query4=@query4 + ' and a.Rate_code ='''+@ratetype+''''
END 

IF(@city  IS NOT NULL and @city  <>'') begin
	if(@base='1')begin
		set @query4=@query4 + ' and AGENCY_MAST.City_Code ='''+@city+''''
	end 

	if(@base='2')begin
		set @query4=@query4 + ' and a.Executive_code in(select exec_mast.Exe_no from exec_mast where exec_mast.city_code ='''+@city+''' )'
	end 

	if(@base='3')begin
		set @query4=@query4 + ' and a.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.City_Code='''+@city+''')'
	end 
END 

IF(@zone  IS NOT NULL and @zone  <>'') begin
	if(@base='1')begin
		set @query4=@query4 + ' and AGENCY_MAST.zone_code ='''+@zone+''''
	end 
	
	if(@base='2')begin
		set @query4=@query4 + ' and a.Executive_code in(select exec_mast.Exe_no from exec_mast where exec_mast.city_code in (select city_mst.City_Code from city_mst where city_mst.Zone_Code= '''+@zone+''') )'
	end 

	if(@base='3')begin
		set @query4=@query4 + ' and a.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.Zone_Code='''+@zone+''')'
	end 
END 

IF(@district  IS NOT NULL and @district  <>'') begin
	if(@base='1')begin
		set @query4=@query4 + ' and AGENCY_MAST.Dist_Code ='''+@district+''''
	end 

	if(@base='2')begin
		set @query4=@query4 + ' and a.Executive_code in(select exec_mast.Exe_no from exec_mast where exec_mast.dist_code ='''+@district+''' )'
	end 

	if(@base='3')begin
		set @query4=@query4 + ' and a.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.Dist_Code='''+@district+''')'
	end 
END 

IF(@state  IS NOT NULL and @state  <>'') begin
	if(@base='1')begin
		set @query4=@query4 + ' and AGENCY_MAST.State_Code ='''+@state+''''
	end 

	if(@base='2')begin
		set @query4=@query4 + ' and a.Executive_code in(select exec_mast.Exe_no from exec_mast where exec_mast.State_code ='''+@state+''' )'
	end 

	if(@base='3')begin
		set @query4=@query4 + ' and a.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.State_Code='''+@state+''')'
	end 
END 

IF(@taluka  IS NOT NULL and @taluka  <>'') begin
	if(@base='1')begin
		set @query4=@query4 + ' and AGENCY_MAST.TALUKA='''+@taluka+'''  '
	end 

	if(@base='2')begin	
		set @query4=@query4 + ' and a.Executive_code in(select exec_mast.Exe_no from exec_mast where exec_mast.TALUKA ='''+@taluka+''' )'
	end 

	if(@base='3')begin
		set @query4=@query4 + ' and a.RETAINER in(select RETAINERMASTER.Retain_Code from  RETAINERMASTER where  RETAINERMASTER.TALUKA='''+@taluka+''')'
	end 
END 

set @query4=@query4 + ' group by b.Insert_Date order by Date'

print(@query3+@query4)
exec(@query3+@query4)

end 
 
SELECT getdate() AS "Rundate",dbo.initcap(Comp_Name) AS "companyname" from comp_mst where Comp_Code=@compcode
select * from  #temp_ad_bills_report

deallocate c1
deallocate c2

drop table #temp_ad_bills_report
/*drop table #temp_complete_dynamic_report
drop table #MULTIPACK_REP	
drop table #MULTIPACK_RAT
drop table #MULTIPACK_RATNEW*/



@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ 5584,6349,6022@@@@@@end@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ 6384@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

                                                                     
                                                                     
                                                                     
                                             
ALTER PROCEDURE Schedulereport1(
	@fromdate               VARCHAR(50) ,
	@dateto                 VARCHAR(50) ,
	@compcode               VARCHAR(50) ,
	@pub_name               VARCHAR(50) ,
	@pub_cent               VARCHAR(50) ,
	@dateformat             VARCHAR(50) ,
	@descid                 VARCHAR(50)= null ,
	@ascdesc                VARCHAR(50)= null ,
	@adtyp                  VARCHAR(400) ,
	@adcatg                 VARCHAR(400) ,
	@edition_name           VARCHAR(50) ,
	@drpstatus              VARCHAR(50) ,
	@supplement_name        VARCHAR(50),
	@packagecode 			varchar(50),
	@editiondtl 			varchar(50),
	@puserid				varchar(50),
	@chk_access				varchar(2),
	@p_branch				varchar(50)) 
	
AS 
	CREATE TABLE #MULTIPACK_RAT(CIOID VARCHAR(500),RAT VARCHAR(500),PER_AMT numeric(12,2)) 
	--CREATE TABLE #MULTIPACK_RATNEW (CIOID VARCHAR(500),RAT VARCHAR(500),PER_AMT numeric(12,2))
	CREATE TABLE #MULTIPACK_REP(CIOID  VARCHAR(500),PACK  VARCHAR(500))
	CREATE TABLE #MULTIPAGE_BREK(TOT  int,PACK  VARCHAR(500))

BEGIN
		DECLARE @query1       VARCHAR(8000) 
		DECLARE @v_gau        FLOAT                           
		SET @v_gau = 17 
		DECLARE @v_val        NUMERIC(4) 
		DECLARE @vs_gau       NUMERIC(4) 

		
		DECLARE p1 Cursor LOCAL FOR 
		SELECT  i.Edition as "edition", COUNT(*) as "tot"
		FROM TBL_BOOKING_MAST m, TBL_BOOKING_INSERT i, AGENCY_MAST a, COL_MAST c, UOM_MAST u
		WHERE m.Comp_code  = @compcode AND m.cio_booking_id  = i.Cio_Booking_Id
		 AND m.Agency_sub_code  = a.code_subcode
		 AND i.Col_Code  = c.Col_Code
		 AND u.Uom_Code  = m.Uom_code
		 AND i.Insert_Date  BETWEEN @fromdate  AND  @dateto
		 AND (i.Insert_Status  != @drpstatus OR	@drpstatus is null)
		 AND i.Publication_Code  = isnull(@pub_name,i.Publication_Code)
		 AND i.Pub_Cent_Code = isnull(@pub_cent,i.Pub_Cent_Code)
		 AND m.Ad_type_code  = isnull(@Adtyp,m.Ad_type_code)
		 AND (i.Ad_Cat= @adcatg OR @adcatg  is null)
		 AND i.Edition_Code  = isnull(@edition_name,i.Edition_Code)
		 AND (i.Supp_Code  = @supplement_name  OR	@supplement_name  is null)
		 AND (m."branch"  = @p_branch  OR	@p_branch  is null)
		and   (@packagecode in (m.Package_code) or @packagecode is null)
		and ((i.Pub_Cent_Code in (select distinct pub_center from login_center where newuser_id=@puserid) and @chk_access='1')
		or  (@chk_access='0') )
		and m.cio_booking_id not in (select distinct prev_cioid from tbl_booking_mast where prev_cioid is not null)
		GROUP BY  i.Edition 
		ORDER BY i.Edition 
		
		DECLARE @g1_edition  VARCHAR(200) 
		declare @g1_tot varchar(200)

		DECLARE C1 Cursor LOCAL FOR 
		SELECT DISTINCT i.Cio_Booking_Id AS "CIOID", m.Package_code as package_code,
		m.Gross_amount as Crate
		FROM  TBL_BOOKING_MAST m, TBL_BOOKING_INSERT i
		WHERE m.Comp_code=@compcode AND m.cio_booking_id=i.Cio_Booking_Id
		AND i.Insert_Date BETWEEN @fromdate AND @dateto
		AND i.Publication_Code  = isnull(@pub_name,i.Publication_Code)
		AND i.Pub_Cent_Code = isnull(@pub_cent,i.Pub_Cent_Code)
		AND m.Ad_type_code  = isnull(@Adtyp,m.Ad_type_code)
		AND (i.Ad_Cat=@adcatg or @adcatg is null)
		AND i.Edition_Code  = isnull(@edition_name,i.Edition_Code)
		AND (i.Supp_Code =@supplement_name or @supplement_name is null)
		AND m."branch"  = isnull(@p_branch,m."branch")
		and (@packagecode in (m.Package_code) or @packagecode is null)
		and ((i.Pub_Cent_Code in (select distinct pub_center from login_center where newuser_id=@puserid) and @chk_access='1')
		or  (@chk_access='0') )
		and m.cio_booking_id not in (select distinct prev_cioid from tbl_booking_mast where prev_cioid is not null)

		DECLARE @v1_cioid  VARCHAR(200)
		declare @v1_package_code varchar(200) 
		declare @v1_crate float

		DECLARE C2 Cursor LOCAL FOR 
		SELECT DISTINCT Edition	FROM  TBL_BOOKING_INSERT WHERE Cio_Booking_Id  = @v1_cioid
		
		DECLARE @v_edition    VARCHAR(100) 
		DECLARE @v_edipkg     VARCHAR(500) 
		--DELETE  temp_edi  
		
		--DELETE FROM  MULTIPAGE_BREAK 		
		delete from #multipage_brek

		OPEN p1 
		DECLARE @count	INT 
		SET @count = 1 
		fetch NEXT FROM p1 INTO @g1_edition,@g1_tot
		WHILE (@@FETCH_STATUS != -1) BEGIN
			
			insert into #multipage_brek SELECT  * from dbo.multipage_brek(@g1_edition, @g1_tot, @v_gau) --@vs_gau  =			
			SET @count=@count +1
			fetch NEXT FROM p1 INTO @g1_edition,@g1_tot
		END 		
		close p1
  
		delete from #MULTIPACK_REP	
		delete from #MULTIPACK_RAT
		
		OPEN c1 
		SET @count = 1 
		fetch NEXT FROM c1 INTO @v1_cioid,@v1_package_code,@v1_crate
		WHILE (@@FETCH_STATUS != -1) BEGIN 
			--exec multipack_report @v1_cioid, @v1_package_code, @v1_crate, '1'
			insert into #MULTIPACK_REP select * from dbo.multipack_report1(@v1_cioid, @v1_package_code, @v1_crate, '1')
			insert into #MULTIPACK_RAT select * from dbo.multipack_report3(@v1_cioid, @v1_package_code, @v1_crate, '1')
			OPEN C2 
			SET @count = 1 
			fetch NEXT FROM C2 INTO	@v_edition
			WHILE (@@FETCH_STATUS != -1) BEGIN 
				IF @v_edipkg is null BEGIN 
					SET @v_edipkg  = @v_edition 
				END
				ELSE BEGIN 
					SET @v_edipkg  = @v_edipkg + ',' + @v_edition 
				END
   
				SET @count=@count +1
				fetch NEXT FROM C2 INTO	@v_edition
			END
			close C2
			
			SET @v_edition  = null 
			SET @v_edipkg  = null 
			SET @count=@count +1	
			fetch NEXT FROM c1 INTO @v1_cioid,@v1_package_code,@v1_crate
		end	
		close c1		
			

		---------------------- Changes done by gaurav 14 june 10-------------------------------------------
		if (@packagecode is null or @editiondtl ='1') begin
			print('1')
			IF ( @drpstatus = 'includecancel'  or @drpstatus ='includehold') BEGIN 
				print('2')
				SET @query1  = 'SELECT TBL_BOOKING_MAST.cio_booking_id AS "CIOID", AGENCY_MAST.Agency_Name AS "Agency", 
				isnull((SELECT Cust_Name FROM CUST_MAST WHERE Cust_Code=Client_code),Client_code)  AS "Client", 
				#multipack_rep.PACK  AS "Package", COL_MAST.Col_Alias AS "Hue", TBL_BOOKING_MAST.Card_rate AS "CardRate",
				isnull(Agrred_rate,TBL_BOOKING_MAST.Card_rate) AS "AgreedRate", tbl_booking_insert.Status_Material as "InsertStatus", TBL_BOOKING_MAST.Caption as "Caption", 
				TBL_BOOKING_MAST.Key_no as "Key_no", TBL_BOOKING_INSERT.Edition as "edition", TBL_BOOKING_MAST.RO_No as "RO_No",
				(SELECT ADVPOS_PREM_MAST.Premiumcode FROM ADVPOS_PREM_MAST WHERE TBL_BOOKING_INSERT.Premium1=ADVPOS_PREM_MAST.Premiumcode AND TBL_BOOKING_INSERT.Col_Code= ADVPOS_PREM_MAST.col_code) AS PagePremium,
				(SELECT ADVPOS_TYPE_MAST.Pos_Type_Code FROM ADVPOS_TYPE_MAST WHERE TBL_BOOKING_INSERT.Page_Post=ADVPOS_TYPE_MAST.Pos_Type_Code) AS "PosPremium", 
				round(TBL_BOOKING_insert.Size_Book,2)  AS "Area", TBL_BOOKING_MAST.Bill_remarks AS "Spl Instruction", 
				CASE ''' + @dateformat + '''  WHEN ''mm/dd/yyyy'' THEN convert(varchar(20),Insert_Date,101)  
				WHEN ''dd/mm/yyyy'' THEN convert(varchar(20),Insert_Date,103)  
				WHEN ''yyyy/mm/dd'' THEN convert(varchar(20),Insert_Date,112)  END AS "Ins.date" ,
				tbl_booking_insert.Width  AS "Width",  tbl_booking_insert.Height AS "Depth",
				(SELECT ADV_CAT_MAST.Adv_Cat_Name FROM ADV_CAT_MAST WHERE ADV_CAT_MAST.Adv_Cat_Code=tbl_booking_insert.Ad_Cat) as "Adcat", 
				(select ADV_SUBCAT_MAST.Adv_Subcat_Name FROM ADV_SUBCAT_MAST WHERE  ADV_SUBCAT_MAST.Adv_Subcat_Code=tbl_booking_insert.Ad_Sub_Cat) AS "AdSubcat", 
				(select AD_CAT3."catname"   FROM AD_CAT3 WHERE  AD_CAT3."catcode"=tbl_booking_mast."Ad_Subcat3" and AD_CAT3."compcode"=tbl_booking_mast."Comp_code" ) AS "AdSubcat3",
				TBL_BOOKING_INSERT.Page_No as "Pageno", TBL_BOOKING_MAST.Paid_ins as "Paidins",  
				TBL_BOOKING_MAST.Rate_code as ratecd, UOM_MAST.Uom_Name  AS "Uom",
				(select uom_mast.UOM_DESC from uom_mast where tbl_booking_mast.Uom_code=uom_mast.Uom_Code)as "uomdesc" 
				,TBL_BOOKING_MAST.Booking_type AS "booktype"   ,tbl_booking_mast.audit as "audit"	
				,tbl_booking_insert."File_Name" as "FILE_NAME",TBL_BOOKING_MAST.APP_STATUS as "APP_STATUS",tbl_booking_insert."No_Insert" as "NO_INSERT",
				(select distinct "Branch_Name" from branch_mst where "Branch_Code"=TBL_BOOKING_MAST."branch") as "BRANCH_NAME"
				FROM TBL_BOOKING_MAST,
				TBL_BOOKING_INSERT,AGENCY_MAST,#multipack_rep,COL_MAST,UOM_MAST  
				WHERE TBL_BOOKING_MAST.Comp_code=''' + @compcode + '''
				AND TBL_BOOKING_MAST.cio_booking_id=TBL_BOOKING_INSERT.Cio_Booking_Id 
				AND  TBL_BOOKING_MAST.Agency_sub_code=AGENCY_MAST.code_subcode
				AND  TBL_BOOKING_insert.Col_Code=COL_MAST.Col_Code 
				AND UOM_MAST.Uom_Code=TBL_BOOKING_MAST.Uom_code 
				and #multipack_rep.CIOID=tbl_booking_mast.cio_booking_id
				and tbl_booking_mast.cio_booking_id not in (select distinct prev_cioid from tbl_booking_mast where prev_cioid is not null)
				and (('''+@drpstatus+''' =''includecancel'' and  lower(Insert_Status) !=''hold'') or ('''+@drpstatus+''' =''includehold'' and lower(Insert_Status) !=''cancel''))
				and ((tbl_booking_insert.Pub_Cent_Code in (select distinct pub_center from login_center where newuser_id='''+@puserid+''') and '''+@chk_access+'''=''1'')
				or  ('''+@chk_access+'''=''0'') )' 
					
			END
			ELSE BEGIN 
				print ('3')

				SET @query1  = 'SELECT TBL_BOOKING_MAST.cio_booking_id AS "CIOID", AGENCY_MAST.Agency_Name AS "Agency", 
				isnull((SELECT Cust_Name FROM CUST_MAST WHERE Cust_Code=Client_code),Client_code)  AS "Client", 
				#multipack_rep.PACK  AS "Package", COL_MAST.Col_Alias AS "Hue", TBL_BOOKING_MAST.Card_rate AS "CardRate",
				isnull(Agrred_rate,TBL_BOOKING_MAST.Card_rate) AS "AgreedRate", tbl_booking_insert.Status_Material as "InsertStatus", TBL_BOOKING_MAST.Caption as "Caption", 
				TBL_BOOKING_MAST.Key_no as "Key_no", TBL_BOOKING_INSERT.Edition as "edition", TBL_BOOKING_MAST.RO_No as "RO_No",
				(SELECT ADVPOS_PREM_MAST.Premiumcode FROM ADVPOS_PREM_MAST WHERE TBL_BOOKING_INSERT.Premium1=ADVPOS_PREM_MAST.Premiumcode AND TBL_BOOKING_INSERT.Col_Code= ADVPOS_PREM_MAST.col_code) AS PagePremium,
				(SELECT ADVPOS_TYPE_MAST.Pos_Type_Code FROM ADVPOS_TYPE_MAST WHERE TBL_BOOKING_INSERT.Page_Post=ADVPOS_TYPE_MAST.Pos_Type_Code) AS "PosPremium", 
				round(TBL_BOOKING_insert.Size_Book,2)  AS "Area", TBL_BOOKING_MAST.Bill_remarks AS "Spl Instruction", 
				CASE ''' + @dateformat + '''  WHEN ''mm/dd/yyyy'' THEN convert(varchar(20),Insert_Date,101)  
				WHEN ''dd/mm/yyyy'' THEN convert(varchar(20),Insert_Date,103)  
				WHEN ''yyyy/mm/dd'' THEN convert(varchar(20),Insert_Date,112)  END AS "Ins.date" ,
				tbl_booking_insert.Width  AS "Width",  tbl_booking_insert.Height AS "Depth",
				(SELECT ADV_CAT_MAST.Adv_Cat_Name FROM ADV_CAT_MAST WHERE ADV_CAT_MAST.Adv_Cat_Code=tbl_booking_insert.Ad_Cat) as "Adcat", 
				(select ADV_SUBCAT_MAST.Adv_Subcat_Name FROM ADV_SUBCAT_MAST WHERE  ADV_SUBCAT_MAST.Adv_Subcat_Code=tbl_booking_insert.Ad_Sub_Cat) AS "AdSubcat",
				(select AD_CAT3."catname"   FROM AD_CAT3 WHERE  AD_CAT3."catcode"=tbl_booking_mast."Ad_Subcat3" and AD_CAT3."compcode"=tbl_booking_mast."Comp_code" ) AS "AdSubcat3",
				TBL_BOOKING_INSERT.Page_No as "Pageno", TBL_BOOKING_MAST.Paid_ins as "Paidins",  
				TBL_BOOKING_MAST.Rate_code as ratecd, UOM_MAST.Uom_Name  AS "Uom",
				(select uom_mast.UOM_DESC from uom_mast where tbl_booking_mast.Uom_code=uom_mast.Uom_Code)as "uomdesc" 
				,TBL_BOOKING_MAST.Booking_type AS "booktype"   ,tbl_booking_mast.audit as "audit"	
				,tbl_booking_insert."File_Name" as "FILE_NAME",TBL_BOOKING_MAST.APP_STATUS as "APP_STATUS",tbl_booking_insert."No_Insert" as "NO_INSERT",
				(select distinct "Branch_Name" from branch_mst where "Branch_Code"=TBL_BOOKING_MAST."branch") as "BRANCH_NAME"
				FROM TBL_BOOKING_MAST,
				TBL_BOOKING_INSERT,AGENCY_MAST,#multipack_rep,COL_MAST,UOM_MAST  
				WHERE TBL_BOOKING_MAST.Comp_code=''' + @compcode + '''
				AND TBL_BOOKING_MAST.cio_booking_id=TBL_BOOKING_INSERT.Cio_Booking_Id 
				AND  TBL_BOOKING_MAST.Agency_sub_code=AGENCY_MAST.code_subcode
				AND  TBL_BOOKING_insert.Col_Code=COL_MAST.Col_Code 
				AND UOM_MAST.Uom_Code=TBL_BOOKING_MAST.Uom_code 
				and #multipack_rep.CIOID=tbl_booking_mast.cio_booking_id
				and tbl_booking_mast.cio_booking_id not in (select distinct prev_cioid from tbl_booking_mast where prev_cioid is not null)					
				and lower(Insert_Status) !=''cancel''
				and lower(Insert_Status) !=''hold''
				and ((tbl_booking_insert.Pub_Cent_Code in (select distinct pub_center from login_center where newuser_id='''+@puserid+''') and '''+@chk_access+'''=''1'')
				or  ('''+@chk_access+'''=''0'') )' 
		
			END
		end
		else begin
			print('4')
			IF ( @drpstatus = 'includecancel'  or @drpstatus ='includehold') BEGIN 				
				print ('5')
				SET @query1  = 'SELECT distinct TBL_BOOKING_MAST.cio_booking_id AS "CIOID", AGENCY_MAST.Agency_Name AS "Agency", 
				isnull((SELECT Cust_Name FROM CUST_MAST WHERE Cust_Code=Client_code),Client_code)  AS "Client", 
				#multipack_rep.PACK  AS "Package", COL_MAST.Col_Alias AS "Hue", TBL_BOOKING_MAST.Card_rate AS "CardRate",
				isnull(TBL_BOOKING_MAST.Agrred_rate, TBL_BOOKING_MAST.Card_rate) AS "AgreedRate", tbl_booking_insert.Status_Material as "InsertStatus", TBL_BOOKING_MAST.Caption as "Caption", 
				TBL_BOOKING_MAST.Key_no as "Key_no", TBL_BOOKING_MAST.RO_No as "RO_No",
				(SELECT ADVPOS_PREM_MAST.Premiumcode FROM ADVPOS_PREM_MAST WHERE TBL_BOOKING_INSERT.Premium1=ADVPOS_PREM_MAST.Premiumcode AND TBL_BOOKING_INSERT.Col_Code= ADVPOS_PREM_MAST.col_code) AS PagePremium,
				(SELECT ADVPOS_TYPE_MAST.Pos_Type_Code FROM ADVPOS_TYPE_MAST WHERE TBL_BOOKING_INSERT.Page_Post=ADVPOS_TYPE_MAST.Pos_Type_Code) AS "PosPremium", 
				round(TBL_BOOKING_insert.Size_Book,2)  AS "Area", TBL_BOOKING_MAST.Bill_remarks AS "Spl Instruction", 
				CASE ''' + @dateformat + '''  WHEN ''mm/dd/yyyy'' THEN convert(varchar(20),Insert_Date,101)  
				WHEN ''dd/mm/yyyy'' THEN convert(varchar(20),Insert_Date,103)  
				WHEN ''yyyy/mm/dd'' THEN convert(varchar(20),Insert_Date,112) 
				END AS "Ins.date" ,
				tbl_booking_insert.Width  AS "Width",
				tbl_booking_insert.Height AS "Depth",
				(SELECT ADV_CAT_MAST.Adv_Cat_Name FROM ADV_CAT_MAST WHERE ADV_CAT_MAST.Adv_Cat_Code=tbl_booking_insert.Ad_Cat) as "Adcat", 
				(select ADV_SUBCAT_MAST.Adv_Subcat_Name FROM ADV_SUBCAT_MAST WHERE  ADV_SUBCAT_MAST.Adv_Subcat_Code=tbl_booking_insert.Ad_Sub_Cat) AS "AdSubcat",
				(select AD_CAT3."catname"   FROM AD_CAT3 WHERE  AD_CAT3."catcode"=tbl_booking_mast."Ad_Subcat3" and AD_CAT3."compcode"=tbl_booking_mast."Comp_code" ) AS "AdSubcat3", 
				TBL_BOOKING_INSERT.Page_No as "Pageno", TBL_BOOKING_MAST.Paid_ins as "Paidins",  
				TBL_BOOKING_MAST.Rate_code as ratecd, UOM_MAST.Uom_Name  AS "Uom"
				,(select uom_mast.UOM_DESC from uom_mast where tbl_booking_mast."Uom_code"=uom_mast."Uom_Code")as "uomdesc"
				,TBL_BOOKING_MAST.Booking_type AS "booktype"   ,tbl_booking_mast.audit as "audit"	
				,tbl_booking_insert."File_Name" as "FILE_NAME",TBL_BOOKING_MAST.APP_STATUS as "APP_STATUS",tbl_booking_insert."No_Insert" as "NO_INSERT",
				(select distinct "Branch_Name" from branch_mst where "Branch_Code"=TBL_BOOKING_MAST."branch") as "BRANCH_NAME"
				FROM TBL_BOOKING_MAST,
				TBL_BOOKING_INSERT,AGENCY_MAST,#multipack_rep,COL_MAST,UOM_MAST  
				WHERE TBL_BOOKING_MAST.Comp_code=''' + @compcode + '''AND TBL_BOOKING_MAST.cio_booking_id=TBL_BOOKING_INSERT.Cio_Booking_Id 
				AND  TBL_BOOKING_MAST.Agency_sub_code=AGENCY_MAST.code_subcode AND  TBL_BOOKING_insert.Col_Code=COL_MAST.Col_Code 
				AND UOM_MAST.Uom_Code=TBL_BOOKING_MAST.Uom_code and #multipack_rep.CIOID=tbl_booking_mast.cio_booking_id						
				and tbl_booking_mast.cio_booking_id not in (select distinct prev_cioid from tbl_booking_mast where prev_cioid is not null)
				and  (('''+@drpstatus+''' =''includecancel'' and  lower(Insert_Status) !=''hold'') or ('''+@drpstatus+''' =''includehold'' and lower(Insert_Status) !=''cancel'')) 	
				and ((tbl_booking_insert.Pub_Cent_Code in (select distinct pub_center from login_center where newuser_id='''+@puserid+''') and '''+@chk_access+'''=''1'')
				or  ('''+@chk_access+'''=''0'') )' 
			
			END
			ELSE BEGIN 
				print('7')			
				SET @query1 = 'SELECT distinct TBL_BOOKING_MAST.cio_booking_id AS "CIOID", AGENCY_MAST.Agency_Name AS "Agency", 
				isnull((SELECT Cust_Name FROM CUST_MAST WHERE Cust_Code=Client_code),Client_code)  AS "Client", 
				#multipack_rep.PACK  AS "Package", COL_MAST.Col_Alias AS "Hue", TBL_BOOKING_MAST.Card_rate AS "CardRate",
				isnull(TBL_BOOKING_MAST.Agrred_rate, TBL_BOOKING_MAST.Card_rate) AS "AgreedRate", tbl_booking_insert.Status_Material as "InsertStatus", TBL_BOOKING_MAST.Caption as "Caption", 
				TBL_BOOKING_MAST.Key_no as "Key_no", TBL_BOOKING_MAST.RO_No as "RO_No",
				(SELECT ADVPOS_PREM_MAST.Premiumcode FROM ADVPOS_PREM_MAST WHERE TBL_BOOKING_INSERT.Premium1=ADVPOS_PREM_MAST.Premiumcode AND TBL_BOOKING_INSERT.Col_Code= ADVPOS_PREM_MAST.col_code) AS PagePremium,
				(SELECT ADVPOS_TYPE_MAST.Pos_Type_Code FROM ADVPOS_TYPE_MAST WHERE TBL_BOOKING_INSERT.Page_Post=ADVPOS_TYPE_MAST.Pos_Type_Code) AS "PosPremium", 
				round(TBL_BOOKING_insert.Size_Book,2)  AS "Area", TBL_BOOKING_MAST.Bill_remarks AS "Spl Instruction", 
				CASE ''' + @dateformat + '''  WHEN ''mm/dd/yyyy'' THEN convert(varchar(20),Insert_Date,101)  
				WHEN ''dd/mm/yyyy'' THEN convert(varchar(20),Insert_Date,103)  
				WHEN ''yyyy/mm/dd'' THEN convert(varchar(20),Insert_Date,112) 
				END AS "Ins.date" ,
				tbl_booking_insert.Width  AS "Width",
				tbl_booking_insert.Height AS "Depth",
				(SELECT ADV_CAT_MAST.Adv_Cat_Name FROM ADV_CAT_MAST WHERE ADV_CAT_MAST.Adv_Cat_Code=tbl_booking_insert.Ad_Cat) as "Adcat", 
				(select ADV_SUBCAT_MAST.Adv_Subcat_Name FROM ADV_SUBCAT_MAST WHERE  ADV_SUBCAT_MAST.Adv_Subcat_Code=tbl_booking_insert.Ad_Sub_Cat) AS "AdSubcat", 
				(select AD_CAT3."catname"   FROM AD_CAT3 WHERE  AD_CAT3."catcode"=tbl_booking_mast."Ad_Subcat3" and AD_CAT3."compcode"=tbl_booking_mast."Comp_code" ) AS "AdSubcat3",
				TBL_BOOKING_INSERT.Page_No as "Pageno", TBL_BOOKING_MAST.Paid_ins as "Paidins",  
				TBL_BOOKING_MAST.Rate_code as ratecd, UOM_MAST.Uom_Name  AS "Uom"
				,(select uom_mast.UOM_DESC from uom_mast where tbl_booking_mast."Uom_code"=uom_mast."Uom_Code")as "uomdesc"
				,TBL_BOOKING_MAST.Booking_type AS "booktype"   ,tbl_booking_mast.audit as "audit"	
				,tbl_booking_insert."File_Name" as "FILE_NAME",TBL_BOOKING_MAST.APP_STATUS as "APP_STATUS",tbl_booking_insert."No_Insert" as "NO_INSERT",
				(select distinct "Branch_Name" from branch_mst where "Branch_Code"=TBL_BOOKING_MAST."branch") as "BRANCH_NAME"
				FROM TBL_BOOKING_MAST,
				TBL_BOOKING_INSERT,AGENCY_MAST,#multipack_rep,COL_MAST,UOM_MAST  
				WHERE TBL_BOOKING_MAST.Comp_code=''' + @compcode + '''AND TBL_BOOKING_MAST.cio_booking_id=TBL_BOOKING_INSERT.Cio_Booking_Id 
				AND  TBL_BOOKING_MAST.Agency_sub_code=AGENCY_MAST.code_subcode AND  TBL_BOOKING_insert.Col_Code=COL_MAST.Col_Code 
				AND UOM_MAST.Uom_Code=TBL_BOOKING_MAST.Uom_code and #multipack_rep.CIOID=tbl_booking_mast.cio_booking_id
				and lower(Insert_Status) !=''cancel''
				and lower(Insert_Status) !=''hold''
				and tbl_booking_mast.cio_booking_id not in (select distinct prev_cioid from tbl_booking_mast where prev_cioid is not null)	
				and ((tbl_booking_insert.Pub_Cent_Code in (select distinct pub_center from login_center where newuser_id='''+@puserid+''') and '''+@chk_access+'''=''1'')
				or  ('''+@chk_access+'''=''0'') )' 

			END
		end

		IF ( @fromdate IS NOT NULL AND @dateto IS NOT NULL ) BEGIN 
			SET @query1  = @query1 + ' AND TBL_BOOKING_INSERT.Insert_Date BETWEEN ''' + @fromdate + ''' AND''' + @dateto + '''' 
		END
   
		IF ( @pub_name IS NOT NULL ) BEGIN 
			SET @query1  = @query1 + ' AND TBL_BOOKING_INSERT.Publication_Code=''' + @pub_name + '''' 
		END

		IF ( @p_branch IS NOT NULL ) BEGIN 
			SET @query1  = @query1 + ' AND TBL_BOOKING_mast.branch=''' + @p_branch + '''' 
		END

		IF ( @pub_cent IS NOT NULL ) BEGIN 
			SET @query1  = @query1 + '  AND TBL_BOOKING_INSERT.Pub_Cent_Code=''' + @pub_cent + '''' 
		END
   
		IF ( @adtyp IS NOT NULL ) BEGIN 
			SET @query1  = @query1 + 'AND TBL_BOOKING_MAST.Ad_type_code=''' + @adtyp + '''' 
		END
   
		IF ( @adcatg IS NOT NULL ) BEGIN 
			SET @query1  = @query1 + 'AND  tbl_booking_insert.Ad_Cat in (''' + @adcatg + ''' )' 
		END
   
		IF ( @edition_name IS NOT NULL ) BEGIN 
			SET @query1  = @query1 + '  AND TBL_BOOKING_INSERT.Edition_Code=''' + @edition_name + '''' 
		END
   
		IF ( @supplement_name IS NOT NULL ) BEGIN 
			SET @query1  = @query1 + 'AND (TBL_BOOKING_insert.Supp_Code =''' + @supplement_name + ''' )' 
		END
		IF(@packagecode IS NOT NULL ) begin
			SET @query1=@query1+' AND ('''+@packagecode+''' in (tbl_booking_mast.Package_code) )'
		END 
   		
		if(@packagecode is null) begin
			IF ( @descid IS NOT NULL ) BEGIN 
				SET @query1  = @query1 + '  order by "' + @descid + '"' 
				if(@descid='edition')begin
					SET @query1  = @query1 + '' + @ascdesc + '' + '  '
				end
				else begin
					SET @query1  = @query1 + '' + @ascdesc + '' + ' ,TBL_BOOKING_INSERT.Edition '
				end
			END
			ELSE BEGIN 
				SET @query1  = @query1 + ' order by TBL_BOOKING_INSERT.Edition' 
			END
		end
		else begin
			IF ( @descid IS NOT NULL ) BEGIN 
				SET @query1  = @query1 + '  order by "' + @descid + '"'
				SET @query1  = @query1 + '' + @ascdesc + '' 
			END
			ELSE BEGIN 
				SET @query1  = @query1 + 'order by TBL_BOOKING_MAST.cio_booking_id ' 
			END
		End
	
		
		print(@query1)
		EXEC(@query1) 
		
		SELECT Edition_Alias as "Editions" FROM  edition_mast WHERE Pub_Code  = @pub_name AND Edition_Type  = 'Main Edition'

		SELECT CASE @dateformat 
				WHEN 'mm/dd/yyyy'  THEN CONVERT(VARCHAR(23), Insert_Date, 10)
				WHEN 'dd/mm/yyyy'  THEN CONVERT(VARCHAR(23), Insert_Date, 5)
				WHEN 'yyyy/mm/dd'  THEN CONVERT(VARCHAR(23), Insert_Date)
			 END as "Insdate",TBL_BOOKING_INSERT.Edition
				FROM  TBL_BOOKING_INSERT 
				WHERE TBL_BOOKING_INSERT.Edition in 
				(SELECT Edition_Alias as "Editions" FROM  edition_mast WHERE	Pub_Code = @pub_name)
		
		SELECT PACK,TOT FROM #MULTIPAGE_BREK ORDER BY PACK,TOT DESC 		
		
		SELECT GETDATE(),dbo.initcap("Comp_Name") FROM  comp_mst WHERE Comp_Code  = @compcode
		
 DEALLOCATE p1
 DEALLOCATE C1
 DEALLOCATE C2

END

--select * from  #MULTIPAGE_BREK

drop table  #MULTIPACK_RAT
drop table  #MULTIPACK_REP
drop table  #MULTIPAGE_BREK

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ 6384@@@end@@@@@@@@@@@@@@@@@@@@@@@@@@@

@@@@@@@@@@@@@@@@@@@@@@@@@@@@ laxman sir@@@@@@@@@24/01/12@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

                                                                     
                                                                     
                                                                     
                                             
ALTER PROCEDURE Reportnew1
@agname		as	VARCHAR(500)=NULL,
@clientname		as	VARCHAR(500)=NULL,
@adtype1		as	VARCHAR(50),
@Adcategory		as	VARCHAR(500),
@Adsubcategory	as	VARCHAR(500),
@fromdate		as	VARCHAR(20),
@dateto			as	VARCHAR(20),
@compcode		as  VARCHAR(10),
@pub_name		as	VARCHAR(200),
@pub_cent		as  VARCHAR(200),
@status			as	VARCHAR(50)=NULL,
@edition		as	VARCHAR(100),
@dateformat		as	VARCHAR(20),
@hold			as	VARCHAR(20)=NULL,
@descid			as	VARCHAR(20)=NULL,
@ascdesc		as	VARCHAR(20)=NULL,
@agtype			as	varchar(20)=null,
@puserid		as	varchar(10)=null,
@chk_access		as	varchar(2),
@pbranch		as	varchar(50)=null,
@pprint_center	as	varchar(50)=null,
@pwithout_rono  as  varchar(50)=null,
@pdate_flag     as  varchar(5)=null,--it is used for booking date B or publish date P
@pextra1        as  varchar(50)=null,
@pextra2        as  varchar(50)=null,
@pextra3        as  varchar(50)=null,
@pextra4        as  varchar(50)=null,
@pextra5        as  varchar(50)=null
AS
	declare @center			VARCHAR(50)
	declare @from_date		DATETIME
	declare @date_to		DATETIME
	declare @v_query		VARCHAR(8000)
	declare @v_query1		VARCHAR(200)
	declare @v_query2		VARCHAR(200)
BEGIN

create table #Results(SegmentNum INT, Edition_Name  VARCHAR(255))
create table #result_new(SegmentNum INT, Edition_Name  VARCHAR(255))
insert into #Results select * from dbo.Fn_Splitfield(@Adcategory,',')
insert into #result_new select * from dbo.Fn_Splitfield_NEW(@Adsubcategory,',')


set	@v_query='SELECT m.cio_booking_id AS "CIOID",i.Edition as "edition",
CASE '''+@dateformat+'''
WHEN ''mm/dd/yyyy'' THEN CONVERT(varchar(10),i.Insert_Date,101)
WHEN ''dd/mm/yyyy'' THEN CONVERT(varchar(10),i.Insert_Date,103)
WHEN ''yyyy/mm/dd'' THEN CONVERT(varchar(10),i.Insert_Date,111)  END AS "Ins.date" ,
a.Agency_Name AS "Agency",
isnull((SELECT Cust_Name FROM CUST_MAST WHERE Cust_Code=m.Client_code and CUST_MAST.comp_code=m.comp_code),m.Client_code)  AS "Client",
/*(select COMBIN_MAST.Package_Name from combin_mast where COMBIN_MAST.comp_code=m.comp_code and COMBIN_MAST.Combin_Code  in(m.Package_code))AS "Package",*/
case when CHARINDEX('','', m."Package_code") >0 then 
	dbo.FETCH_PACK_new('''+@compcode+''', m."Package_code" ) 
else
    (select distinct min("Combin_Desc") from combin_mast where "Combin_Code"=m."Package_code")
end AS "Package",
i.Height AS "Depth",i.Width   AS "Width",
round(i.Size_Book,2) AS "Area",
(select uom_mast.UOM_DESC from uom_mast where m.Uom_code=uom_mast.Uom_Code and m.comp_code=uom_mast.comp_code)as "uom",
i.Col_Code AS "Color_code",
(SELECT ADVPOS_TYPE_MAST.Pos_Type_Alias FROM ADVPOS_TYPE_MAST WHERE i.Page_Post=ADVPOS_TYPE_MAST.Pos_Type_Code  and i.comp_code=ADVPOS_TYPE_MAST.comp_code) AS "Page",
m.Bullet_code AS "BulletPremium" ,i.Page_Post AS "PositionPremium" ,i.Premium1 AS "PagePremium" ,
m.RO_No AS "RoNo.",CASE m.ro_status WHEN ''2'' THEN ''Reservation'' WHEN ''1'' THEN ''Confirm'' END AS "RoStatus",
(SELECT ADV_CAT_MAST.Adv_Cat_Name FROM ADV_CAT_MAST WHERE ADV_CAT_MAST.Adv_Cat_Code=i.Ad_Cat and ADV_CAT_MAST.comp_code=i.comp_code) AS "AdCat",
m.Card_rate AS "CardRate",isnull(Agrred_rate,0) AS "AgreedRate",i.Bill_Amt AS "Amt",m.Caption AS "Cap",Key_no AS "Key",
(SELECT dbo.InitCap(Comp_Name) from comp_mst where Comp_Code='''+@compcode+''')  AS "companyname",
getdate() as "Rundate",CASHDISCOUNT as "Cash_Disc",m.AUDIT_COMMENT as "COMMENT",m."Dockit_no" as "DOCKIT_NO"
FROM TBL_BOOKING_MAST m,TBL_BOOKING_INSERT i,AGENCY_MAST a
 WHERE m.Comp_code='''+@compcode+''' AND m.cio_booking_id=i.Cio_Booking_Id
 AND m.Agency_code=a.Agency_Code and m.Agency_sub_code=a.code_subcode
 AND m.cio_booking_id not in(select distinct prev_cioid from tbl_booking_mast where prev_cioid is not null)
 and  lower(i.Insert_Status) !=''cancel''
and ((i.Pub_Cent_Code in (select distinct pub_center from login_center where newuser_id='''+@puserid+''') and '''+@chk_access+'''=''1'') 
or  ('''+@chk_access+'''=''0'') )'


IF(@agname IS NOT NULL and @agname <> '') Begin
	set @v_query=@v_query+' and m.Agency_code ='''+@agname+''''
END

IF(@clientname IS NOT NULL and @clientname <> '') Begin
	set @v_query=@v_query+' and m.Client_code='''+@clientname +''''
END

IF(@status IS NOT NULL and @status<>'') Begin
	set @v_query=@v_query+' and i.Insert_Status='''+@status+''''
END

IF(@adtype1 IS NOT NULL and @adtype1 <>'') Begin
	set @v_query=@v_query+' and m.Ad_type_code='''+@adtype1+''''
END

IF(@Adcategory IS NOT NULL and @Adcategory<>'') Begin
	set @v_query=@v_query+' and i.Ad_Cat in(select EDITION_NAME from #Results  )'
	--set @v_query=@v_query+' and TBL_BOOKING_MAST.Ad_cat_code in('''+@Adcategory+''' )'
END

IF(@Adsubcategory IS NOT NULL and @Adsubcategory<>'') Begin
	set @v_query=@v_query+' and m.Ad_sub_cat_code in(select EDITION_NAME from #result_new )'
	--set @v_query=@v_query+' and TBL_BOOKING_MAST.Ad_sub_cat_code in('''+@Adsubcategory+''' )'
END

IF(@pub_cent IS NOT NULL and @pub_cent<>'') Begin
	set @v_query=@v_query+'  and i.Pub_Cent_Code='''+@pub_cent+''''
END

If @pdate_flag='B' Begin

	IF(@fromdate IS NOT NULL AND @dateto IS NOT NULL ) Begin
		set @v_query=@v_query+' and m."date_time" between  '''+@fromdate +''' and  '''+@dateto+''' '
	END

	IF( @fromdate<>'' and @dateto<>'') Begin
		set @v_query=@v_query+' and m."date_time" between  '''+@fromdate +''' and  '''+@dateto+''' '
	END
End

If @pdate_flag='P' Begin

	IF(@fromdate IS NOT NULL AND @dateto IS NOT NULL ) Begin
		set @v_query=@v_query+' and i.Insert_Date between  '''+@fromdate +''' and  '''+@dateto+''' '
	END

	IF( @fromdate<>'' and @dateto<>'') Begin
		set @v_query=@v_query+' and i.Insert_Date between  '''+@fromdate +''' and  '''+@dateto+''' '
	END
End

IF(@edition IS NOT NULL and @edition<>'') Begin
	set @v_query=@v_query+'  and i.Edition_Code='''+@edition+''''
END

IF(@pub_name IS NOT NULL and @pub_name<>'') Begin
	set @v_query=@v_query+' and  i.Publication_Code='''+@pub_name+''''
END

IF((@agtype IS NOT NULL and @agtype<>'') AND (@agtype <> 'Package') AND (@agtype <> 'Solo')) Begin
	set @v_query=@v_query+' and  m.Agency_type='''+upper(@agtype)+''''
END

if(@pprint_center is not null and @pprint_center<>'')Begin
	set @v_query=@v_query+' and m."branch" IN (SELECT "Branch_Code" FROM BRANCH_MST WHERE m."branch"="Branch_Code" and "pub_center" in (SELECT "Pub_cent_Code" FROM PUB_CENT_MAST WHERE  branch_mst."pub_center"=pub_cent_mast."Pub_cent_Code" and "Pub_cent_Code"='''+@pprint_center+''')) '
end 

if(@pbranch is not null and @pbranch<>'') Begin
	set @v_query=@v_query+' and m."branch" = (SELECT "Branch_Code" FROM BRANCH_MST where "Branch_Name" ='''+@pbranch+''') '
end 

if(@pwithout_rono='Y') Begin
    set @v_query=@v_query+' and (m."RO_No" is null or m."RO_No"='''') ';
End

if(@pwithout_rono='N') Begin
    set @v_query=@v_query+' and (m."RO_No" is not null or m."RO_No"<>'''') ';
End

IF(@descid IS NOT  NULL and @descid<>'') Begin
	set @v_query=@v_query+'  order by "'+@descid+'"'
	set @v_query=@v_query+''+@ascdesc+''
end
ELSE Begin
	set @v_query=@v_query+'  order by i.Insert_Date,m.cio_booking_id'
END

print(@v_query)
exec(@v_query)

set @v_query='select EDITION_NAME from #Results '
set @v_query='select EDITION_NAME from #result_new '

print(@v_query1)
exec(@v_query1)
print(@v_query2)
exec(@v_query2)

END

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@end@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

////////**************************************ISSUE NO.0006384 ***********************************//////////////////////
CREATE OR REPLACE PROCEDURE Schedulereport1(
    fromdate        IN VARCHAR2,
    dateto          IN VARCHAR2,
    compcode        IN VARCHAR2,
    pub_name        IN VARCHAR2,
    pub_cent        IN VARCHAR2,
    dateformat      IN VARCHAR2,
    descid          IN VARCHAR2:=NULL,
    ascdesc         IN VARCHAR2:=NULL,
    adtyp           IN VARCHAR2,
    adcatg          IN VARCHAR2,
    edition_name    in varchar2,
    drpstatus       in varchar2,
    supplement_name in varchar2,
    packagecode     in varchar2,
    editiondtl      in varchar2,
    puserid         in varchar2:=null,
    chk_access      in varchar2:=null,
    p_branch        in varchar2:=null,
    p_accounts      OUT Cur_Type_New1.cursor_type,
    p_accounts1     OUT Cur_Type_New1.cursor_type,
    p_accounts2     OUT Cur_Type_New1.cursor_type,
    p_accounts3     out Cur_Type_New1.cursor_type,
    p_accounts4     out Cur_Type_New1.cursor_type) IS
query1 VARCHAR2(10000);
v_gau number:=17;
v_val number(4);
vs_gau number(4);

--if(drpstatus ='cancel') then
Cursor p1 Is
select TBL_BOOKING_INSERT."Edition" as "edition",count(*) as "tot"
FROM TBL_BOOKING_MAST,TBL_BOOKING_INSERT,AGENCY_MAST ,COL_MAST, UOM_MAST
WHERE TBL_BOOKING_MAST."Comp_code"=compcode AND
TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id" AND
TBL_BOOKING_MAST."Agency_sub_code"=AGENCY_MAST."code_subcode" AND
TBL_BOOKING_insert."Col_Code" =COL_MAST."Col_Code" AND
UOM_MAST."Uom_Code"=TBL_BOOKING_MAST."Uom_code"
AND TBL_BOOKING_INSERT."Insert_Date" BETWEEN fromdate AND dateto
 and (TBL_BOOKING_INSERT."Insert_Status"!=drpstatus or drpstatus is null)
AND (TBL_BOOKING_INSERT."Publication_Code"=pub_name or pub_name is null)
AND (TBL_BOOKING_INSERT."Pub_Cent_Code"=pub_cent or pub_cent is null)
AND (TBL_BOOKING_MAST."Ad_type_code"=Adtyp or Adtyp is null)
AND (tbl_booking_insert."Ad_Cat"=adcatg or adcatg is null)
AND (TBL_BOOKING_INSERT."Edition_Code"=edition_name or edition_name is null)
AND (TBL_BOOKING_insert."Supp_Code" =supplement_name or supplement_name is null)
AND (TBL_BOOKING_mast."branch"  = p_branch  OR	p_branch  is null)
and (packagecode in (tbl_booking_mast."Package_code") or packagecode is null)
and ((tbl_booking_insert."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id=puserid) and chk_access=1)
or  (chk_access=0) )
group by TBL_BOOKING_INSERT."Edition" order by TBL_BOOKING_INSERT."Edition";

g1 p1%rowtype;

Cursor C1 Is
SELECT distinct TBL_BOOKING_INSERT."Cio_Booking_Id" AS "CIOID",TBL_BOOKING_MAST."Package_code" as package_code
,TBL_BOOKING_mast."Gross_amount" as Crate
FROM TBL_BOOKING_MAST, TBL_BOOKING_INSERT--,multipack_rep
WHERE TBL_BOOKING_MAST."Comp_code"=compcode AND
TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"
AND TBL_BOOKING_INSERT."Insert_Date" BETWEEN fromdate AND dateto
AND (TBL_BOOKING_INSERT."Publication_Code"=pub_name or pub_name is null)
AND (TBL_BOOKING_INSERT."Pub_Cent_Code"=pub_cent or pub_cent is null)
AND (TBL_BOOKING_MAST."Ad_type_code"=Adtyp or Adtyp is null)
AND (tbl_booking_insert."Ad_Cat"=adcatg or adcatg is null)
AND (TBL_BOOKING_INSERT."Edition_Code"=edition_name or edition_name is null)
AND (TBL_BOOKING_insert."Supp_Code" =supplement_name or supplement_name is null)
AND (TBL_BOOKING_mast."branch"  = p_branch  OR	p_branch  is null)
and (packagecode in (tbl_booking_mast."Package_code") or packagecode is null)
and ((tbl_booking_insert."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id=puserid) and chk_access=1)
or  (chk_access=0) );
v1 c1%rowtype;

Cursor C2 Is
SELECT distinct "Edition" from TBL_BOOKING_INSERT where "Cio_Booking_Id"=v1.cioid;
v_edition varchar2(100);
v_edipkg varchar2(500);

BEGIN
delete temp_edi;

delete from MULTIPAGE_BREAK where sess_id=userenv('sessionid');commit;


open p1;
loop
fetch p1 into g1;
exit when p1%notfound;
--multipage_brek(packag VARCHAR2,PCOMP_CD number,bre number)
vs_gau:=multipage_brek(g1."edition", g1."tot",v_gau);
     end loop;
close p1;
commit;

--------- fetch multiple  edition  ( ad by rinki)-----------
delete from multipack_rep where sess_id=userenv('sessionid');commit;
open c1;
loop
fetch c1 into v1;
exit when c1%notfound;

    
      v_val:=multipack_report(v1.CIOID,v1.package_code,v1.Crate,'1');
    open C2;
    Loop
    fetch C2 into v_edition;
    exit when C2%notfound;
    if v_edipkg is null then
        v_edipkg :=v_edition;
    else
        v_edipkg :=v_edipkg|| ',' ||v_edition;
    end if;
    end loop;
    close C2;

    v_edition:=null;v_edipkg:=null;
end loop;
close c1;
commit;
---------------------end -------------------------------
if(packagecode is null or editiondtl='1')then
    if(drpstatus ='includecancel' or drpstatus ='includehold') then
    
    query1:='SELECT TBL_BOOKING_MAST ."cio_booking_id" AS "CIOID",
        AGENCY_MAST."Agency_Name" AS "Agency",
        NVL((SELECT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code"="Client_code" and tbl_booking_mast."Comp_code"=cust_mast."Comp_Code" ),"Client_code")  AS "Client",
        multipack_rep.PACK  AS "Package",
        COL_MAST ."Col_Alias" AS "Hue",
        TBL_BOOKING_MAST."Card_rate" AS "CardRate",
        NVL("Agrred_rate",TBL_BOOKING_MAST."Card_rate") AS "AgreedRate",
        tbl_booking_insert."Status_Material" as "InsertStatus",
        TBL_BOOKING_MAST."Caption" as "Caption",
        TBL_BOOKING_MAST."Key_no" as "Key_no",
        TBL_BOOKING_INSERT."Edition" as "edition",
        TBL_BOOKING_MAST."RO_No" as "RO_No",
        (select ADVPOS_PREM_MAST."premiumname" from advpos_prem_mast where ADVPOS_PREM_MAST."Premiumcode"=TBL_BOOKING_INSERT."Premium1" and ADVPOS_PREM_MAST."comp_code"=tbl_booking_insert."Comp_Code" ) as "PagePremium",
        (select advpos_type_mast."Pos_Type" from advpos_type_mast where advpos_type_mast."Pos_Type_Code"=tbl_booking_insert."Page_Post" and advpos_type_mast."Comp_Code"=tbl_booking_insert."Comp_Code" ) as "PosPremium",
        round(TBL_BOOKING_insert."Size_Book",2) AS "Area",
        TBL_BOOKING_MAST."Bill_remarks" AS "Spl Instruction",
        CASE '''||dateformat||'''
        WHEN ''mm/dd/yyyy'' THEN TO_CHAR("Insert_Date",''MM-DD-YY'')
        WHEN ''dd/mm/yyyy'' THEN TO_CHAR("Insert_Date",''DD-MM-YY'')
        WHEN ''yyyy/mm/dd'' THEN TO_CHAR("Insert_Date",''YY-MM-DD'') END AS "Ins.date" ,
        tbl_booking_insert."Width"  AS "Width",
        tbl_booking_insert."Height" AS "Depth"
        ,(SELECT ADV_CAT_MAST."Adv_Cat_Name" FROM ADV_CAT_MAST WHERE ADV_CAT_MAST."Adv_Cat_Code"=tbl_booking_insert."Ad_Cat" and ADV_CAT_MAST."Comp_Code"=tbl_booking_insert."Comp_Code" ) as "Adcat",
         (select ADV_SUBCAT_MAST."Adv_Subcat_Name"   FROM ADV_SUBCAT_MAST WHERE  ADV_SUBCAT_MAST."Adv_Subcat_Code"=tbl_booking_insert."Ad_Sub_Cat" and ADV_SUBCAT_MAST."Comp_Code"=tbl_booking_insert."Comp_Code" ) AS "AdSubcat",
         (select AD_CAT3."catname"   FROM AD_CAT3 WHERE  AD_CAT3."catcode"=tbl_booking_mast."Ad_Subcat3" and AD_CAT3."compcode"=tbl_booking_mast."Comp_code" ) AS "AdSubcat3",
        TBL_BOOKING_INSERT."Page_No" as "Pageno",
        TBL_BOOKING_MAST."Paid_ins" as "Paidins",
        TBL_BOOKING_MAST."Rate_code" as ratecd,
        UOM_MAST."Uom_Name"  AS "Uom",
        (select uom_mast.UOM_DESC from uom_mast where tbl_booking_mast."Uom_code"=uom_mast."Uom_Code" and tbl_booking_mast."Comp_code"=uom_mast."Comp_Code"  )as "uomdesc"
        ,TBL_BOOKING_MAST."Booking_type" AS "booktype"
        ,tbl_booking_mast."audit" as "audit"
        ,tbl_booking_insert."File_Name" as "FILE_NAME",TBL_BOOKING_MAST.APP_STATUS as "APP_STATUS",tbl_booking_insert."No_Insert" as "NO_INSERT",
        (select distinct "Branch_Name" from branch_mst where "Branch_Code"=TBL_BOOKING_MAST."branch") as "BRANCH_NAME"
        FROM TBL_BOOKING_MAST,TBL_BOOKING_INSERT,AGENCY_MAST ,multipack_rep,COL_MAST ,UOM_MAST
        WHERE TBL_BOOKING_MAST."Comp_code"='''||compcode||'''AND
        TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id" AND
        tbl_booking_mast."Comp_code"=tbl_booking_insert."Comp_Code" and
        TBL_BOOKING_MAST."Agency_sub_code"=AGENCY_MAST."code_subcode" AND
        TBL_BOOKING_insert."Col_Code"=COL_MAST."Col_Code" AND
         UOM_MAST."Uom_Code"=TBL_BOOKING_MAST."Uom_code"
        and  multipack_rep.CIOID=tbl_booking_mast."cio_booking_id"
        and sess_id='||userenv('sessionid')||'
        and "cio_booking_id" not in(select distinct "prev_cioid" from tbl_booking_mast where "prev_cioid" is not null)
        and (('''||drpstatus||''' =''includecancel'' and  lower("Insert_Status") !=''hold'') or ('''||drpstatus||''' =''includehold'' and lower("Insert_Status") !=''cancel''))
        and ((tbl_booking_insert."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id='''||puserid||''') and '''||chk_access||'''=''1'')
        or  ('''||chk_access||'''=''0'') )';

else

    query1:='SELECT TBL_BOOKING_MAST ."cio_booking_id" AS "CIOID",
    AGENCY_MAST."Agency_Name" AS "Agency",
    NVL((SELECT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code"="Client_code" and tbl_booking_mast."Comp_code"=cust_mast."Comp_Code" ),"Client_code")  AS "Client",
    multipack_rep.PACK  AS "Package",
    COL_MAST ."Col_Alias" AS "Hue",
    TBL_BOOKING_MAST."Card_rate" AS "CardRate",
    NVL("Agrred_rate",TBL_BOOKING_MAST."Card_rate") AS "AgreedRate",
    tbl_booking_insert."Status_Material" as "InsertStatus",
    TBL_BOOKING_MAST."Caption" as "Caption",
    TBL_BOOKING_MAST."Key_no" as "Key_no",
    TBL_BOOKING_INSERT."Edition" as "edition",
    TBL_BOOKING_MAST."RO_No" as "RO_No",
    (select ADVPOS_PREM_MAST."premiumname" from advpos_prem_mast where ADVPOS_PREM_MAST."Premiumcode"=TBL_BOOKING_INSERT."Premium1" and ADVPOS_PREM_MAST."comp_code"=tbl_booking_insert."Comp_Code" ) as "PagePremium",
    (select advpos_type_mast."Pos_Type" from advpos_type_mast where advpos_type_mast."Pos_Type_Code"=tbl_booking_insert."Page_Post" and advpos_type_mast."Comp_Code"=tbl_booking_insert."Comp_Code" ) as "PosPremium",
    round(TBL_BOOKING_insert."Size_Book",2) AS "Area",
    TBL_BOOKING_MAST."Bill_remarks" AS "Spl Instruction",
    CASE '''||dateformat||'''
    WHEN ''mm/dd/yyyy'' THEN TO_CHAR("Insert_Date",''MM-DD-YY'')
    WHEN ''dd/mm/yyyy'' THEN TO_CHAR("Insert_Date",''DD-MM-YY'')
    WHEN ''yyyy/mm/dd'' THEN TO_CHAR("Insert_Date",''YY-MM-DD'') END
     AS "Ins.date" ,
    tbl_booking_insert."Width"  AS "Width",
    tbl_booking_insert."Height" AS "Depth"
    ,(SELECT ADV_CAT_MAST."Adv_Cat_Name" FROM ADV_CAT_MAST WHERE ADV_CAT_MAST."Adv_Cat_Code"=tbl_booking_insert."Ad_Cat" and ADV_CAT_MAST."Comp_Code"=tbl_booking_insert."Comp_Code" ) as "Adcat",
     (select ADV_SUBCAT_MAST."Adv_Subcat_Name"   FROM ADV_SUBCAT_MAST WHERE  ADV_SUBCAT_MAST."Adv_Subcat_Code"=tbl_booking_insert."Ad_Sub_Cat" and ADV_SUBCAT_MAST."Comp_Code"=tbl_booking_insert."Comp_Code" ) AS "AdSubcat",
     (select AD_CAT3."catname"   FROM AD_CAT3 WHERE  AD_CAT3."catcode"=tbl_booking_mast."Ad_Subcat3" and AD_CAT3."compcode"=tbl_booking_mast."Comp_code" ) AS "AdSubcat3",
    TBL_BOOKING_INSERT."Page_No" as "Pageno",
    TBL_BOOKING_MAST."Paid_ins" as "Paidins",
    TBL_BOOKING_MAST."Rate_code" as ratecd,
    UOM_MAST."Uom_Name"  AS "Uom",
    (select uom_mast.UOM_DESC from uom_mast where tbl_booking_mast."Uom_code"=uom_mast."Uom_Code" and tbl_booking_mast."Comp_code"=uom_mast."Comp_Code"  )as "uomdesc"
    ,TBL_BOOKING_MAST."Booking_type" AS "booktype"
    ,tbl_booking_mast."audit" as "audit"
    ,tbl_booking_insert."File_Name" as "FILE_NAME",TBL_BOOKING_MAST.APP_STATUS as "APP_STATUS",tbl_booking_insert."No_Insert" as "NO_INSERT",
    (select distinct "Branch_Name" from branch_mst where "Branch_Code"=TBL_BOOKING_MAST."branch") as "BRANCH_NAME"
    FROM TBL_BOOKING_MAST,TBL_BOOKING_INSERT,AGENCY_MAST ,multipack_rep,COL_MAST,UOM_MAST
    WHERE TBL_BOOKING_MAST."Comp_code"='''||compcode||'''AND
    TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id" AND
    tbl_booking_mast."Comp_code"=tbl_booking_insert."Comp_Code" and
    TBL_BOOKING_MAST."Agency_sub_code"=AGENCY_MAST."code_subcode" AND
    TBL_BOOKING_insert."Col_Code"=COL_MAST."Col_Code"
    and  multipack_rep.CIOID=tbl_booking_mast."cio_booking_id"
    and sess_id='||userenv('sessionid')||'
    and lower("Insert_Status") !=''cancel''
    and lower("Insert_Status") !=''hold''
    and  UOM_MAST."Uom_Code"=TBL_BOOKING_MAST."Uom_code"
    and "cio_booking_id" not in(select distinct "prev_cioid" from tbl_booking_mast where "prev_cioid" is not null) 
    and ((tbl_booking_insert."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id='''||puserid||''') and '''||chk_access||'''=''1'')
    or  ('''||chk_access||'''=''0'') ) ';

end if;

else
if(drpstatus ='includecancel' or drpstatus ='includehold') then

    query1:='SELECT distinct TBL_BOOKING_MAST ."cio_booking_id" AS "CIOID",
    AGENCY_MAST."Agency_Name" AS "Agency",
    NVL((SELECT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code"="Client_code" and tbl_booking_mast."Comp_code"=cust_mast."Comp_Code" ),"Client_code")  AS "Client",
    multipack_rep.PACK  AS "Package",
    COL_MAST ."Col_Alias" AS "Hue",
    TBL_BOOKING_MAST."Card_rate" AS "CardRate",
    NVL("Agrred_rate",TBL_BOOKING_MAST."Card_rate") AS "AgreedRate",
    tbl_booking_insert."Status_Material" as "InsertStatus",
    TBL_BOOKING_MAST."Caption" as "Caption",
    TBL_BOOKING_MAST."Key_no" as "Key_no",
    TBL_BOOKING_MAST."RO_No" as "RO_No",
    (select ADVPOS_PREM_MAST."premiumname" from advpos_prem_mast where ADVPOS_PREM_MAST."Premiumcode"=TBL_BOOKING_INSERT."Premium1" and ADVPOS_PREM_MAST."comp_code"=tbl_booking_insert."Comp_Code" ) as "PagePremium",
    (select advpos_type_mast."Pos_Type" from advpos_type_mast where advpos_type_mast."Pos_Type_Code"=tbl_booking_insert."Page_Post" and advpos_type_mast."Comp_Code"=tbl_booking_insert."Comp_Code" ) as "PosPremium",
    round(TBL_BOOKING_insert."Size_Book",2) AS "Area",
    TBL_BOOKING_MAST."Bill_remarks" AS "Spl Instruction",
    CASE '''||dateformat||'''
    WHEN ''mm/dd/yyyy'' THEN TO_CHAR("Insert_Date",''MM-DD-YY'')
    WHEN ''dd/mm/yyyy'' THEN TO_CHAR("Insert_Date",''DD-MM-YY'')
    WHEN ''yyyy/mm/dd'' THEN TO_CHAR("Insert_Date",''YY-MM-DD'') END AS "Ins.date" ,
    tbl_booking_insert."Width"  AS "Width",
    tbl_booking_insert."Height" AS "Depth"
    ,(SELECT ADV_CAT_MAST."Adv_Cat_Name" FROM ADV_CAT_MAST WHERE ADV_CAT_MAST."Adv_Cat_Code"=tbl_booking_insert."Ad_Cat" and ADV_CAT_MAST."Comp_Code"=tbl_booking_insert."Comp_Code" ) as "Adcat",
     (select ADV_SUBCAT_MAST."Adv_Subcat_Name"   FROM ADV_SUBCAT_MAST WHERE  ADV_SUBCAT_MAST."Adv_Subcat_Code"=tbl_booking_insert."Ad_Sub_Cat" and ADV_SUBCAT_MAST."Comp_Code"=tbl_booking_insert."Comp_Code" ) AS "AdSubcat",
     (select AD_CAT3."catname"   FROM AD_CAT3 WHERE  AD_CAT3."catcode"=tbl_booking_mast."Ad_Subcat3" and AD_CAT3."compcode"=tbl_booking_mast."Comp_code" ) AS "AdSubcat3",
    TBL_BOOKING_INSERT."Page_No" as "Pageno",
    TBL_BOOKING_MAST."Paid_ins" as "Paidins",
    TBL_BOOKING_MAST."Rate_code" as ratecd,
    UOM_MAST."Uom_Name"  AS "Uom",
    (select uom_mast.UOM_DESC from uom_mast where tbl_booking_mast."Uom_code"=uom_mast."Uom_Code" and tbl_booking_mast."Comp_code"=uom_mast."Comp_Code"  )as "uomdesc"
    ,TBL_BOOKING_MAST."Booking_type" AS "booktype"
    ,tbl_booking_mast."audit" as "audit"
    ,tbl_booking_insert."File_Name" as "FILE_NAME",TBL_BOOKING_MAST.APP_STATUS as "APP_STATUS",tbl_booking_insert."No_Insert" as "NO_INSERT"
    FROM TBL_BOOKING_MAST,TBL_BOOKING_INSERT,AGENCY_MAST ,multipack_rep,COL_MAST,UOM_MAST
    WHERE TBL_BOOKING_MAST."Comp_code"='''||compcode||'''AND
    TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id" AND
    tbl_booking_mast."Comp_code"=tbl_booking_insert."Comp_Code" and
    TBL_BOOKING_MAST."Agency_sub_code"=AGENCY_MAST."code_subcode" AND
    TBL_BOOKING_insert."Col_Code"=COL_MAST."Col_Code" AND
     UOM_MAST."Uom_Code"=TBL_BOOKING_MAST."Uom_code"
    and  multipack_rep.CIOID=tbl_booking_mast."cio_booking_id"
    and sess_id='||userenv('sessionid')||'
    and "cio_booking_id" not in(select distinct "prev_cioid" from tbl_booking_mast where "prev_cioid" is not null)
    and (('''||drpstatus||''' =''includecancel'' and  lower("Insert_Status") !=''hold'') or ('''||drpstatus||''' =''includehold'' and lower("Insert_Status") !=''cancel''))
    and ((tbl_booking_insert."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id='''||puserid||''') and '''||chk_access||'''=''1'')
    or  ('''||chk_access||'''=''0'') )';

else

    query1:='SELECT distinct TBL_BOOKING_MAST ."cio_booking_id" AS "CIOID",
    AGENCY_MAST."Agency_Name" AS "Agency",
    NVL((SELECT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code"="Client_code" and tbl_booking_mast."Comp_code"=cust_mast."Comp_Code" ),"Client_code")  AS "Client",
    multipack_rep.PACK  AS "Package",
    COL_MAST ."Col_Alias" AS "Hue",
    TBL_BOOKING_MAST."Card_rate" AS "CardRate",
    NVL("Agrred_rate",TBL_BOOKING_MAST."Card_rate") AS "AgreedRate",
    tbl_booking_insert."Status_Material" as "InsertStatus",
    TBL_BOOKING_MAST."Caption" as "Caption",
    TBL_BOOKING_MAST."Key_no" as "Key_no",
    TBL_BOOKING_MAST."RO_No" as "RO_No",
    (select ADVPOS_PREM_MAST."premiumname" from advpos_prem_mast where ADVPOS_PREM_MAST."Premiumcode"=TBL_BOOKING_INSERT."Premium1" and ADVPOS_PREM_MAST."comp_code"=tbl_booking_insert."Comp_Code" ) as "PagePremium",
    (select advpos_type_mast."Pos_Type" from advpos_type_mast where advpos_type_mast."Pos_Type_Code"=tbl_booking_insert."Page_Post" and advpos_type_mast."Comp_Code"=tbl_booking_insert."Comp_Code" ) as "PosPremium",
    round(TBL_BOOKING_insert."Size_Book",2) AS "Area",
    TBL_BOOKING_MAST."Bill_remarks" AS "Spl Instruction",
    CASE '''||dateformat||'''
    WHEN ''mm/dd/yyyy'' THEN TO_CHAR("Insert_Date",''MM-DD-YY'')
    WHEN ''dd/mm/yyyy'' THEN TO_CHAR("Insert_Date",''DD-MM-YY'')
    WHEN ''yyyy/mm/dd'' THEN TO_CHAR("Insert_Date",''YY-MM-DD'') END
     AS "Ins.date" ,
    tbl_booking_insert."Width"  AS "Width",
    tbl_booking_insert."Height" AS "Depth"
    ,(SELECT ADV_CAT_MAST."Adv_Cat_Name" FROM ADV_CAT_MAST WHERE ADV_CAT_MAST."Adv_Cat_Code"=tbl_booking_insert."Ad_Cat" and ADV_CAT_MAST."Comp_Code"=tbl_booking_insert."Comp_Code" ) as "Adcat",
     (select ADV_SUBCAT_MAST."Adv_Subcat_Name"   FROM ADV_SUBCAT_MAST WHERE  ADV_SUBCAT_MAST."Adv_Subcat_Code"=tbl_booking_insert."Ad_Sub_Cat" and ADV_SUBCAT_MAST."Comp_Code"=tbl_booking_insert."Comp_Code" ) AS "AdSubcat",
     (select AD_CAT3."catname"   FROM AD_CAT3 WHERE  AD_CAT3."catcode"=tbl_booking_mast."Ad_Subcat3" and AD_CAT3."compcode"=tbl_booking_mast."Comp_code" ) AS "AdSubcat3",
    TBL_BOOKING_INSERT."Page_No" as "Pageno",
    TBL_BOOKING_MAST."Paid_ins" as "Paidins",
    TBL_BOOKING_MAST."Rate_code" as ratecd,
    UOM_MAST."Uom_Name"  AS "Uom",
    (select uom_mast.UOM_DESC from uom_mast where tbl_booking_mast."Uom_code"=uom_mast."Uom_Code" and tbl_booking_mast."Comp_code"=uom_mast."Comp_Code"  )as "uomdesc"
    ,TBL_BOOKING_MAST."Booking_type" AS "booktype"
    ,tbl_booking_mast."audit" as "audit"
    ,tbl_booking_insert."File_Name" as "FILE_NAME",TBL_BOOKING_MAST.APP_STATUS as "APP_STATUS",tbl_booking_insert."No_Insert" as "NO_INSERT",
    (select distinct "Branch_Name" from branch_mst where "Branch_Code"=TBL_BOOKING_MAST."branch") as "BRANCH_NAME"
    FROM TBL_BOOKING_MAST,TBL_BOOKING_INSERT,AGENCY_MAST ,multipack_rep,COL_MAST,UOM_MAST
    WHERE TBL_BOOKING_MAST."Comp_code"='''||compcode||'''AND
    TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id" AND
    tbl_booking_mast."Comp_code"=tbl_booking_insert."Comp_Code" and
    TBL_BOOKING_MAST."Agency_sub_code"=AGENCY_MAST."code_subcode" AND
    TBL_BOOKING_insert."Col_Code"=COL_MAST."Col_Code"
    and  multipack_rep.CIOID=tbl_booking_mast."cio_booking_id"
    and sess_id='||userenv('sessionid')||'
    and lower("Insert_Status") !=''cancel''
    and lower("Insert_Status") !=''hold''
    and  UOM_MAST."Uom_Code"=TBL_BOOKING_MAST."Uom_code"
    and "cio_booking_id" not in(select distinct "prev_cioid" from tbl_booking_mast where "prev_cioid" is not null)
    and ((tbl_booking_insert."Pub_Cent_Code" in (select distinct pub_center from login_center where newuser_id='''||puserid||''') and '''||chk_access||'''=''1'')
    or  ('''||chk_access||'''=''0'') )';

end if;
end if;


IF(fromdate IS NOT NULL AND dateto IS NOT NULL ) THEN
    query1:=query1||' AND TBL_BOOKING_INSERT."Insert_Date" BETWEEN '''||fromdate||''' AND '''||dateto||''' ';
END IF;


IF(pub_name IS NOT NULL )THEN
    query1:=query1||' AND TBL_BOOKING_INSERT."Publication_Code"='''||pub_name||'''';
END IF;

IF(p_branch IS NOT NULL )THEN
    query1:=query1||' AND TBL_BOOKING_MAST."branch"='''||p_branch||'''';
END IF;

IF(pub_cent IS NOT NULL) THEN
    query1:=query1||'  AND TBL_BOOKING_INSERT."Pub_Cent_Code"='''||pub_cent||'''';
END IF;


IF(adtyp IS NOT NULL) THEN
    query1:=query1|| ' AND TBL_BOOKING_MAST."Ad_type_code"='''||Adtyp||''' ';
END IF;

IF(adcatg IS NOT NULL) THEN
    query1:=query1|| ' AND tbl_booking_insert."Ad_Cat" in ('''||adcatg||''' )';
END IF;

IF(edition_name IS NOT NULL ) THEN
    query1:=query1||'  AND TBL_BOOKING_INSERT."Edition_Code"='''||edition_name||'''';
END IF;

IF(supplement_name IS NOT NULL ) THEN
    query1:=query1||' AND (TBL_BOOKING_insert."Supp_Code" ='''||supplement_name||''' )';
END IF;

IF(packagecode IS NOT NULL ) THEN
    query1:=query1||' AND ('''||packagecode||''' in (tbl_booking_mast."Package_code") )';
END IF;

if(packagecode is null)then

    IF(descid IS NOT  NULL) THEN
        query1:=query1||'  order by "'||descid||'",TBL_BOOKING_INSERT."Edition"';
        query1:=query1||''||ascdesc||'';
    else
        query1:=query1||' order by TBL_BOOKING_INSERT."Edition",TBL_BOOKING_MAST."cio_booking_id"';
    END IF;

else
    IF(descid IS NOT  NULL) THEN
        query1:=query1||'  order by "'||descid||'"';
        query1:=query1||''||ascdesc||'';
    else
        query1:=query1||' order by TBL_BOOKING_MAST."cio_booking_id"';
    END IF;
end if;
delete from searchtbl;insert into searchtbl values(query1); commit;

OPEN p_accounts FOR query1;

OPEN p_accounts1 FOR
select "Edition_Alias"  as "Editions"  from edition_mast where ("Pub_Code"=pub_name or pub_name is null)  and "Edition_Type"='Main Edition';

OPEN p_accounts2 FOR
select sysdate from dual;
/*SELECT 
CASE dateformat
WHEN 'mm/dd/yyyy' THEN TO_CHAR("Insert_Date",'MM-DD-YY')
WHEN 'dd/mm/yyyy' THEN TO_CHAR("Insert_Date",'DD-MM-YY')
WHEN 'yyyy/mm/dd' THEN TO_CHAR("Insert_Date",'YY-MM-DD') END as "Insdate"
,TBL_BOOKING_INSERT."Edition" from TBL_BOOKING_INSERT
where  TBL_BOOKING_INSERT."Edition"
in (select "Edition_Alias"  as "Editions"
from edition_mast where ("Pub_Code"=pub_name or pub_name is null));*/


OPEN p_accounts3 FOR
select PACK, TOT from  MULTIPAGE_BREAK where  sess_id=userenv('sessionid') order by PACK,TOT desc;

OPEN  p_accounts4 FOR
SELECT SYSDATE,initcap("Comp_Name") from comp_mst where "Comp_Code"=compcode;

delete from multipack_rep where sess_id=userenv('sessionid')  ;
delete from multipack_rat where sess_id=userenv('sessionid') ;
DELETE FROM multipack_ratnew where sess_id=userenv('sessionid')  ; 
DELETE FROM MULTIPAGE_BREAK where sess_id=userenv('sessionid')  ;commit;
END ;
/



////////************************************** END OF ISSUE NO.0006384 ***********************************//////////////////////




////////************************************** 6339 *********************ankit**************//////////////////////

CREATE OR REPLACE PACKAGE chkcurrcode Is

Type T_Accounts_Cursor Is Ref Cursor;

Procedure chkcurrcode_P (
code in varchar2,
compcode in varchar2,
 userid  in varchar2,
p_Accounts Out T_Accounts_Cursor,p_Accounts1 Out T_Accounts_Cursor);

End chkcurrcode;
/



CREATE OR REPLACE PACKAGE BODY chkcurrcode Is


Procedure chkcurrcode_P (
code in varchar2,
compcode in varchar2,
 userid  in varchar2,
p_Accounts Out T_Accounts_Cursor,
p_Accounts1 Out T_Accounts_Cursor)As

Begin

Open P_Accounts For
select "Curr_Code" from  CURR_MAST where ("Comp_Code"=compcode) and ("Curr_Code"=code);

Open P_Accounts1 For
select  "Curr_Code" from CURR_CONV_DET where ("Comp_code"=compcode) and ("Curr_Code"=code);



Commit;

End chkcurrcode_P;

End chkcurrcode;
/



CREATE OR REPLACE PACKAGE chkcurrencycodename
is
Type T_Account_cursor is Ref cursor;
procedure chkcurrencycodename_p (str in varchar2,
country in varchar2,
cod in varchar2,P_ACCOUNTS out T_Account_cursor,P_ACCOUNTS1 out T_Account_cursor);
end  chkcurrencycodename ;
/







CREATE OR REPLACE PACKAGE BODY chkcurrencycodename
is

procedure chkcurrencycodename_p (str in varchar2,
country in varchar2,
cod in varchar2,P_ACCOUNTS out T_Account_cursor,P_ACCOUNTS1 out T_Account_cursor) as

begin
open  P_ACCOUNTS for
select * from CURR_MAST where  "Country_Code"=country and "Curr_Name"=str;

open  P_ACCOUNTS1 for
select MAX(TO_NUMBER(NVL(translate("Curr_Code",'ABCDEFGHIJKLMNOPQRSTUVWXYZ~@#$%^&*()!><?/_+|=-',0),0))) AS "Curr_Code" from CURR_MAST where  "Curr_Code" like cod||'%';

end  chkcurrencycodename_p ;
end  chkcurrencycodename ;
/
////////************************************** 6339 *********************ankit**************//////////////////////

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@6455@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@


                                                                     
                                                                     
                                                                     
                                             
CREATE OR REPLACE FUNCTION FUN_BILL_INSERT ( comp_cod varchar2, cio_id varchar2,bil_no varchar2,prefer varchar2,dateformate varchar2,f_agmain varchar2,f_agsub varchar2,f_agcode varchar2,f_agname varchar2,f_execcode varchar2,f_execname varchar2,f_retcode varchar2,f_retname varchar2,base varchar2) RETURN number IS

FCIOID      varchar2(50);
FBillno     varchar2(25);
FAgency     varchar2(50);
FClient     varchar2(200);
FRoNo       varchar2(40);
FRoDate     date;
FExecutive  varchar2(50);
FRetainer   varchar2(80);
FBookType   varchar2(50);
FColor      varchar2(20);
FAdcat      varchar2(50);
FAdsubcat   varchar2(50);
FAdsubcat3  varchar2(50);
FAdsubcat4  varchar2(50);
FAdsubcat5  varchar2(50);
FPackag     varchar2(500);
FBillDate   date;
Fnoinsert   number;
FPaidinsert         number;
Fheight             number;
Fwidth              number;
FArea               number;
FPagepremium        varchar2(30);
FPostprem           varchar2(30);
Fscheme             varchar2(50);
FRatecod            varchar2(40);
Fcardrate           float;
Fcardamt            float;
Fcontractrate       number;
FDeviationamt       number;
FDeviationper       number;
FAggrate            number;
Faggamt             number;
FDiscAmt            float;
FDiscper            number;
Fposamt             number;
Fposper             number;
FSpdiscamt          number;
FSpdiscper          number;
FSpacedisc          number;
FSpacediscper       number;
FSpecialcharge      number;
FAgencyAddlTDper    varchar2(8);
FAgencyAddlTDAmt    number;
FGrossamt           number;
FRetTDPer           number;
FRetTDAmt           number;
FAgencyTDPer        number;
FAgencyTDAmt        number;
FBillamt            number;
FRetCommPer         number;
FRetCommAmt         number;
FActualBusiness     number;
FRevcenter          varchar2(50);
FUom                varchar(20);
FUomDesc            varchar2(50);
FCOMP_CODE          varCHAR2(10);
Fpadtype            varchar2(20);
FPRIPUB             varchar2(10);
FPEDITION           varchar2(50);
FBranch_Name        varchar2(50);
FPub_cent_Code      varchar2(50);
Fregion             varchar2(12);
FAgency_Type_Code   varchar2(10);
FPRIADCTG           varchar2(40);
FSECADCTG           varchar2(40);
FAD_SUBCAT3         varchar2(15);
FAD_SUBCAT4         varchar2(15);
FAD_SUBCAT5         varchar2(15);
FPACKAGE_CODE       varchar2(1000);
FAG_MAIN_CODE       varchar2(10);
FAG_SUB_CODE        varchar2(10);
FCLIENTCD           varchar2(200);
FEXECUTIVE_NAME     varchar2(100);
FPRIPROCTG          varchar2(10);
Fbrand_code         varchar2(10);
FVarient_Name       varchar2(25);
FPAGE_PREM          varchar2(10);
FPAGE_POST          varchar2(10);
FCONTRACT_NAME      varchar2(50);
FSUPP_CODE          varchar2(50);
FRETAINER_CODE      varchar2(10);
FRATECD             varchar2(40);
FCity_Code          varchar2(10);
Fzone_code          varchar2(10);
FDist_Code          varchar2(10);
FState_Code         varchar2(10);
FPTALUKA            varchar2(10);
FPSCHEME            varchar2(18);
FREVENUE_CENTER     varchar2(10);
FRO_STATUS          varchar2(10);
FPAGE_TYPE          varchar2(100);
FBOOKING_TYPE       varchar2(10);
FPUB_CENT_PERMIT    VARCHAR2(50);

FfAdcat             varchar2(50);
FfAdsubcat          varchar2(50);
FfAdsubcat3         varchar2(50);
FfAdsubcat4         varchar2(50);
FfAdsubcat5         varchar2(50);
FfPagepremium       varchar2(50);
Ffscheme            varchar2(50);
f_bil_amt           number;
FfAgencyAddlTDAmt   number;
FfUom               varchar2(50);
FfBranch_Name       varchar2(50);
FfClient            varchar2(100);
FfColor             varchar2(20);
FfPub_cent_Code     varchar2(30);
FffPub_cent_Code    varchar2(30);
FffBranch_Name      varchar2(50);
ffPRIPROCTG         varchar2(30);

Fag_dist_code       varchar2(50);
Fag_talu_code       varchar2(50);
Fdist_name          varchar2(50);
Ftalu_name          varchar2(50);
FPub_cent_Name      varchar2(50);

Fag_city_code       varchar2(50);
Fag_zone_code       varchar2(50);
Fag_state_code      varchar2(50);
Fcity_name          varchar2(30);
Fzone_name          varchar2(30);
Fstate_name         varchar2(30);
f_exec_city         varchar2(8);
f_city_zone         varchar2(8);
f_page_no           varchar(8);

begin

/****************************  For Ad_bills  *******************************/
SELECT max(ad_bills.IDNUM),max(AD_BILLS.BILNO),max(ad_bills.RONUM),MAX(ad_bills.RODATE),
max(decode(AD_BILLS.BOOKING_TYPE ,'1','Barter','2','FMG','3','Normal','4','InHouse','5','Complimentary','Normal')),
max(FETCH_PACK(ad_bills.idnum)), --PACKAGE
MAX(ad_bills.BILDT),max(ad_bills.CONTRACT_RATE),
max(FETCH_RATAMT(ad_bills.idnum,'1','2')),   --posamt
max(FETCH_RATAMT(ad_bills.idnum,'2','2')) ,  --POSPER
max(ad_bills.GROSS_AMT),max(ad_bills.BILLAMT) ,max(nvl(ad_bills.DISCOUNT ,0 )),
max((nvl(ad_bills.GROSS_AMT,0)* nvl(ad_bills.DISCOUNT,0 )/100 ))   ,MAX(COMP_CODE_V)
,max(ad_bills.CLIENTCD),max("COLOUR"),
max(SCHEME),sum(nvl(ad_bills.GROSS_AMT,0)),sum(BILLAMT),max(UNIT),
max(ad_bills.UNIT),max(ad_bills."PRIPUB") ,max(ad_bills.AG_MAIN_CODE),MAX(AD_BILLS.AG_SUB_CODE),max(ad_bills."CLIENTCD"),max( ad_bills."EXECUTIVE_NAME"),max(ad_bills."PRIPROCTG"),
max(ad_bills.CONTRACT_NAME),max(ad_bills.RETAINER_CODE),max(ad_bills.SCHEME),max(AD_BILLS.REVENUE_CENTER),max(AD_BILLS.RO_STATUS),
max(AD_BILLS.PAGE_TYPE),max(AD_BILLS.BOOKING_TYPE ),max("PRIPROCTG"),max(PAGENUM)
INTO FCIOID,FBillno,FRoNo,FRoDate,FBookType,FPackag,FBillDate,Fcontractrate,Fposamt,Fposper ,FGrossamt,FBillamt,FAgencyTDPer,FAgencyTDAmt,FCOMP_CODE
,FfClient,FfColor,
FfPagepremium,FAgencyAddlTDAmt,f_bil_amt,FfPub_cent_Code,
FfBranch_Name,FPRIPUB ,FAG_MAIN_CODE,FAG_SUB_CODE,FCLIENTCD,FEXECUTIVE_NAME,FPRIPROCTG,FCONTRACT_NAME,FRETAINER_CODE,FPSCHEME,FREVENUE_CENTER,FRO_STATUS,FPAGE_TYPE,FBOOKING_TYPE
,ffPRIPROCTG,f_page_no  FROM AD_BILLS WHERE ad_bills.COMP_CODE_V=comp_cod AND ad_bills.BILNO=bil_no and ad_bills.IDNUM=cio_id ;
/**************************************  For Ad_bills_det  ***********************************/
select max(PRIADCTG),max(SECADCTG),max(AD_SUBCAT3),max(AD_SUBCAT4),max(AD_SUBCAT5) ,max(PAGE_PREM)
,max(ad_bills_det.HEIGHT),max(ad_bills_det.WIDTH),max(ad_bills_det."SIZE_BOOK"),max(ad_bills_det.RATECD)
,sum(ad_bills_det.CARD_RATE_V),max(ad_bills_det."EDITION"),max(ad_bills_det."AD_TYPE_V"),max(ad_bills_det.PRIADCTG) ,max(ad_bills_det.SECADCTG),max(ad_bills_det."AD_SUBCAT3"),
max(ad_bills_det.AD_SUBCAT4),max(ad_bills_det.AD_SUBCAT5),max(ad_bills_det.PACKAGE_CODE),max(ad_bills_det.PAGE_PREM),max(ad_bills_det.PAGE_POST),
max(ad_bills_det.SUPP_CODE),max(ad_bills_det.RATECD),MAX(ad_bills_det."BKFOR")
into FfAdcat,FfAdsubcat,FfAdsubcat3,FfAdsubcat4,FfAdsubcat5,FfPagepremium
,Fheight,Fwidth,FArea,FRatecod,Fcardrate,FPEDITION,Fpadtype,FPRIADCTG,FSECADCTG,FAD_SUBCAT3,FAD_SUBCAT4,FAD_SUBCAT5,FPACKAGE_CODE,FPAGE_PREM,FPAGE_POST,FSUPP_CODE ,FRATECD
,FPUB_CENT_PERMIT from ad_bills_det where ad_bills_det.COMP_CODE_V=comp_cod AND ad_bills_det.bilno=bil_no;
/**************************  For Tbl_booking_mast  *********************************************/
--select max(nvl(fun_actual(comp_cod,nvl(tbl_booking_mast."ADD_AGENCY_COMM",0 ),nvl(tbl_booking_mast."RETAINER",0),nvl(tbl_booking_mast."Gross_amount",0),prefer,1 ),0)),-- "RetComm(%)"
select max(
nvl(case(prefer)
    when 'Y' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"=comp_cod and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",0) AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"=comp_cod and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",0)) AND ROWNUM<=1)


          when 'Gross' then
                 (
                 CASE to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM,0))
                 WHEN 0 THEN 0
                 ELSE (to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM,0))-to_number(nvl(tbl_booking_mast."ADD_AGENCY_COMM",0 )))
                end )

         when 'Net'   then  to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM,'0'))


         --when 'Gross' then ((select DISTINCT TO_NUMBER(NVL("Comm_Rate",'0'))    from RET_COMM_DETAILS WHERE "Comp_code"=comp_cod and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",'0') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"=comp_cod and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",'0')) AND ROWNUM<=1 )-nvl(tbl_booking_mast."ADD_AGENCY_COMM",'0' ))
         --when 'Net'   then  (select DISTINCT TO_NUMBER(NVL("Comm_Rate",'0'))    from RET_COMM_DETAILS WHERE "Comp_code"=comp_cod and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",'0') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"=comp_cod and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",'0')) AND ROWNUM<=1 )
        END )

    ELSE (select 0  from dual)
end  ,'0')),
--max(nvl(fun_actual(comp_cod,nvl(tbl_booking_mast."ADD_AGENCY_COMM",0 ),nvl(tbl_booking_mast."RETAINER",0),nvl(tbl_booking_mast."Gross_amount",0),prefer,2 ),0)),--"RetCommAmt"
max(nvl(
case( prefer )
    when 'Y' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"=comp_cod and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",'0') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"=comp_cod and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",'0')) AND ROWNUM<=1)

        when 'Gross' then


         (

                 --CASE to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM_AMT,0))
                    -- WHEN 0 THEN 0
                    -- ELSE (to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM_AMT,'0'))-(nvl((nvl(FGrossamt,'0')*to_number(nvl(tbl_booking_mast."ADD_AGENCY_COMM",'0'))/100),'0')))

                -- end

                 CASE to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM,0))
                 WHEN 0 THEN 0
                 ELSE (nvl(FGrossamt,0)*(to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM,'0'))-to_number(nvl(tbl_booking_mast."ADD_AGENCY_COMM",'0')) )/100)
                 end
                )

         when 'Net'   then  (nvl(FGrossamt,0)*(to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM,'0')) )/100)




         --when 'Gross' then (nvl(tbl_booking_mast."Gross_amount",'0')*((select DISTINCT TO_NUMBER(NVL("Comm_Rate",'0'))    from RET_COMM_DETAILS WHERE "Comp_code"=comp_cod and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",'0') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"=comp_cod and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",'0')) AND ROWNUM<=1 )-nvl(tbl_booking_mast."ADD_AGENCY_COMM",'0' ))/100)
         --when 'Net'   then  (nvl(tbl_booking_mast."Gross_amount",'0')*(select DISTINCT TO_NUMBER(NVL("Comm_Rate",'0'))    from RET_COMM_DETAILS WHERE "Comp_code"=comp_cod and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",'0') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"=comp_cod and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",'0')) AND ROWNUM<=1 )/100)
        END )

    ELSE (select 0  from dual)
end
,'0')),

--max(nvl(fun_actual(comp_cod,nvl(tbl_booking_mast."ADD_AGENCY_COMM",0 ),nvl(tbl_booking_mast."RETAINER",0),nvl(tbl_booking_mast."Gross_amount",0),prefer,3 ),0)),--"RetTD(%)"
max((select DISTINCT TO_NUMBER(NVL("Comm_Rate",'0'))    from RET_COMM_DETAILS WHERE "Comp_code"=comp_cod and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",'0') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"=comp_cod and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",'0')) AND ROWNUM<=1 )),

--max(nvl(fun_actual(comp_cod,nvl(tbl_booking_mast."ADD_AGENCY_COMM",0 ),nvl(tbl_booking_mast."RETAINER",0),nvl(tbl_booking_mast."Gross_amount",0),prefer,4 ),0)),--"RetTDAmt"
max(nvl(FGrossamt,'0')*(select DISTINCT TO_NUMBER(NVL("Comm_Rate",'0'))    from RET_COMM_DETAILS WHERE "Comp_code"=comp_cod and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",'0') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"=comp_cod and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",'0')) AND ROWNUM<=1 )/100),

--max(nvl((f_bil_amt-nvl(fun_actual(comp_cod,nvl(tbl_booking_mast."ADD_AGENCY_COMM",0 ),nvl(tbl_booking_mast."RETAINER",0),nvl(tbl_booking_mast."Gross_amount",0),prefer,2 ),0)  ),0))--"ActualBusiness"
max(nvl((f_bil_amt-nvl(
case( prefer )
    when 'Y' then
        ( CASE (select DISTINCT "Discount" from RET_COMM_DETAILS WHERE "Comp_code"=comp_cod and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",'0') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"=comp_cod and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",'0')) AND ROWNUM<=1)
         when 'Gross' then
                 (
                -- CASE to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM_AMT,0))
                -- WHEN 0 THEN 0
                -- ELSE (to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM_AMT,'0'))-(nvl((nvl(FGrossamt,'0')*to_number(nvl(tbl_booking_mast."ADD_AGENCY_COMM",'0'))/100),'0')))
                -- end

                CASE to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM,0))
                 WHEN 0 THEN 0
                 ELSE (nvl(FGrossamt,0)*(to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM,'0'))-to_number(nvl(tbl_booking_mast."ADD_AGENCY_COMM",'0')) )/100)
                 end



                 )

         when 'Net'   then  (nvl(FGrossamt,'0')*(to_number(nvl(TBL_BOOKING_MAST.RETAINER_COMM,'0')) )/100)

         --when 'Gross' then (nvl(tbl_booking_mast."Gross_amount",'0')*((select DISTINCT TO_NUMBER(NVL("Comm_Rate",'0'))    from RET_COMM_DETAILS WHERE "Comp_code"=comp_cod and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",'0') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"=comp_cod and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",'0')) AND ROWNUM<=1 )-nvl(tbl_booking_mast."ADD_AGENCY_COMM",'0' ))/100)
         --when 'Net'   then  (nvl(tbl_booking_mast."Gross_amount",'0')*(select DISTINCT TO_NUMBER(NVL("Comm_Rate",'0'))    from RET_COMM_DETAILS WHERE "Comp_code"=comp_cod and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",'0') AND "Eff_from_Date"=(SELECT MAX("Eff_from_Date") FROM RET_COMM_DETAILS WHERE "Comp_code"=comp_cod and "Retain_Code"=nvl(tbl_booking_mast."RETAINER",'0')) AND ROWNUM<=1 )/100)
        END )

    ELSE (select 0  from dual)
end
,'0')  ),0))--"ActualBusiness"

,max(tbl_booking_mast."No_of_insertion"),max(tbl_booking_mast."Paid_ins"),
max(tbl_booking_mast."Deviation"),max(tbl_booking_mast."Deviation") ,max(tbl_booking_mast."Agrred_rate"),max(tbl_booking_mast."Agreed_amount"),
max(tbl_booking_mast."Discount_per") ,max(tbl_booking_mast."Special_disc_per"),max(tbl_booking_mast."Space_disc_per"),
max(tbl_booking_mast."Special_charges"),max(nvl(tbl_booking_mast."ADD_AGENCY_COMM",0)),
max(nvl((FAgencyAddlTDAmt*nvl(tbl_booking_mast."ADD_AGENCY_COMM",0)/100),0))
,max("Uom_code") into FRetCommPer,FRetCommAmt,FRetTDPer,FRetTDAmt,FActualBusiness
,Fnoinsert,FPaidinsert,FDeviationamt,FDeviationper,FAggrate,Faggamt,FDiscper,FSpdiscper,FSpacediscper,FSpecialcharge,FAgencyAddlTDper,FAgencyAddlTDAmt
,FfUom  from tbl_booking_mast where tbl_booking_mast."cio_booking_id"=FCIOID;
--***************************  variables  ***********************************************************
Fagency:=f_agname;
FClient:=AD_GET_CLIENTNAME (comp_cod,FfClient);
FExecutive:=f_execname;
FRetainer:=f_retname;
FAdcat:=AD_GET_catnameE(comp_cod,FfAdcat,'cat');
FAdsubcat:=AD_GET_catnameE(comp_cod,FfAdsubcat,'subcat');
FAdsubcat3:=AD_GET_catnameE(comp_cod,FfAdsubcat3,'cat3');
FAdsubcat4:=AD_GET_catnameE(comp_cod,FfAdsubcat4,'cat4');
FAdsubcat5:=AD_GET_catnameE(comp_cod,FfAdsubcat5,'cat5');
FPagepremium:=AD_GET_catnameE(comp_cod,FfPagepremium,'pprem');
Fscheme:=AD_GET_catnameE(comp_cod,Ffscheme,'fschem');
FColor:=AD_GET_catnameE(comp_cod,FfColor,'fcol');
FSpdiscamt:= (round((( nvl(FSpdiscper,0) * nvl(FArea,0) * nvl(Fcardrate,0))/100),2)) ;
FSpacedisc:= (round(((nvl(FSpacediscper,0) * nvl(FArea,0) * nvl(Fcardrate,0))/100),2))  ;
Fcardamt:=(nvl(Fcardrate,0) * nvl(FArea,0) * nvl(Fnoinsert,0))     ;
select max((nvl(Fcardrate,0) * nvl(FArea,0) * nvl(Fnoinsert,0)) - DECODE(NVL(Faggamt,0) ,0,(nvl(Fcardrate,0) * nvl(FArea,0) * nvl(Fnoinsert,0)),NVL(Faggamt,0) )) into FDiscAmt from dual  ;
select max(UOM_MAST."Uom_Name"),max(uom_mast.UOM_DESC)  into FUom,FUomDesc   from uom_mast where "Uom_Code" =FfUom;
select "pub_center" into FffPub_cent_Code from BRANCH_MST where "Branch_Code"=FfPub_cent_Code;
select max("Pub_cent_Code"),MAX("Pub_Cent_name") into FPub_cent_Code,FPub_cent_Name from PUB_CENT_MAST where "Pub_cent_Code"=FffPub_cent_Code;
select max(branch_mst."Branch_Name") into FBranch_Name from branch_mst where branch_mst."Branch_Code"= FfBranch_Name;
select max(agency_mast."region"),max(agency_mast."Agency_Type_Code") into Fregion,FAgency_Type_Code from agency_mast where AGENCY_MAST."code_subcode"=f_agcode;
select max(brand_mst."brand_code") into Fbrand_code from brand_mst where brand_mst."prod_cat_code"=ffPRIPROCTG;
select max(varient_mst."Varient_Name") into FVarient_Name from varient_mst where varient_mst."Brand_Code"=Fbrand_code;
--**********************************************************************************************************************

select max(exec_mast."city_code") into f_exec_city from exec_mast where "Exe_no"=f_execcode;
select max(city_mst."Zone_Code") into f_city_zone from city_mst where city_mst."City_Code"=f_exec_city;

if(base='1') then
     select max(Agency_mast."Dist_Code"),max(AGENCY_MAST.TALUKA) ,max(AGENCY_MAST."City_Code"),max(AGENCY_MAST."zone_code"),max(AGENCY_MAST."State_Code")
     into Fag_dist_code,Fag_talu_code,Fag_city_code,Fag_zone_code,Fag_state_code
     from agency_mast where "code_subcode"=f_agcode ;

 elsif(base='2') then
      select max(exec_mast."dist_code"),max(exec_mast.TALUKA) ,max(exec_mast."city_code"),f_city_zone,max(exec_mast."State_code")
      into Fag_dist_code,Fag_talu_code,Fag_city_code,Fag_zone_code,Fag_state_code
      from exec_mast where "Exe_no"=f_execcode ;

 else
       select max(RETAINERMASTER."Dist_Code"),max(RETAINERMASTER.TALUKA) ,max(RETAINERMASTER."City_Code"),max(RETAINERMASTER."Zone_Code"),max(RETAINERMASTER."State_Code")
       into Fag_dist_code,Fag_talu_code,Fag_city_code,Fag_zone_code,Fag_state_code
       from RETAINERMASTER where "Retain_Code" =f_retcode;

  end if;

select max(dist_mst."Dist_Name") into Fdist_name from dist_mst where "Dist_Name"=Fag_dist_code;

select max(taluka_mast.TALU_NAME) into Ftalu_name from taluka_mast where TALU_CODE=Fag_talu_code;

select max(city_mst."City_Name") into Fcity_name  from city_mst where "City_Code"=Fag_city_code;

select max(zone_mast."Zone_Name") into Fzone_name from zone_mast where  "Zone_Code"=Fag_zone_code;

select max(state_mst."State_Name") into Fstate_name from state_mst where  "State_Code"=Fag_state_code;

insert into temp_ad_bills_report
(
CIOID,Billno,Agency,Client,RoNo,RoDate,Executive,Retainer,BookType,Color,Adcat,Adsubcat,Adsubcat3,Adsubcat4,Adsubcat5,Packag,BillDate,
noinsert,Paidinsert,height,width,Area,Pagepremium,Postprem,scheme,Ratecod,cardrate,cardamt,contractrate,Deviationamt,Deviationper,
Aggrate,aggamt,DiscAmt,Discper,posamt,posper,Spdiscamt,Spdiscper,Spacedisc,Spacediscper,Specialcharge,AgencyAddlTDper,AgencyAddlTDAmt,
Grossamt,RetTDPer,RetTDAmt,AgencyTDPer,AgencyTDAmt,Billamt,RetCommPer,RetCommAmt,ActualBusiness,Revcenter,Uom,UomDesc,
    PADTYPE ,  PRIPUB,  PEDITION,  BRANCH_NAME ,  PUB_CENT_CODE ,  REGION,  AGENCY_TYPE_CODE,  PRIADCTG,  SECADCTG,  AD_SUBCAT3,  AD_SUBCAT4,
  AD_SUBCAT5,  PACKAGE_CODE,  AG_MAIN_CODE,   CLIENTCD,  EXECUTIVE_NAME,  PRIPROCTG ,  BRAND_CODE,  VARIENT_NAME,  PAGE_PREM ,  PAGE_POST ,
  CONTRACT_NAME ,  SUPP_CODE ,  RETAINER_CODE ,  RATECD,    PSCHEME ,  REVENUE_CENTER,  RO_STATUS ,  PAGE_TYPE ,  BOOKING_TYPE,COMP_CODE,AG_SUB_CODE,
  PUB_CENT_PERMIT,sess_id,DIST_NAME,TALU_NAME,PUB_CENT_NAME,
  CITY_CODE,ZONE_CODE,DIST_CODE,STATE_CODE,PTALUKA,CITY_NAME,ZONE_NAME,STATE_NAME,PAGE_NO
)
values
(
FCIOID  ,FBillno  ,FAgency  ,FClient  ,FRoNo  ,FRoDate  ,FExecutive  ,FRetainer  ,FBookType  ,FColor  ,FAdcat  ,FAdsubcat  ,FAdsubcat3  ,FAdsubcat4  ,
FAdsubcat5  ,FPackag  ,FBillDate  ,Fnoinsert  ,FPaidinsert  ,Fheight  ,Fwidth  ,FArea  ,FPagepremium  ,FPostprem  ,Fscheme  ,FRatecod  ,Fcardrate  ,
Fcardamt  ,Fcontractrate  ,FDeviationamt  ,FDeviationper  ,FAggrate  ,Faggamt  ,FDiscAmt  ,FDiscper  ,Fposamt  ,Fposper  ,FSpdiscamt  ,FSpdiscper  ,
FSpacedisc  ,FSpacediscper  ,FSpecialcharge  ,FAgencyAddlTDper  ,FAgencyAddlTDAmt  ,FGrossamt  ,FRetTDPer   ,FRetTDAmt  ,FAgencyTDPer  ,
FAgencyTDAmt  ,FBillamt  ,FRetCommPer  ,FRetCommAmt   ,FActualBusiness  ,FRevcenter   ,FUom ,FUomDesc,
Fpadtype,FPRIPUB,FPEDITION,FBranch_Name,FPub_cent_Code,Fregion,FAgency_Type_Code,FPRIADCTG,FSECADCTG,FAD_SUBCAT3,FAD_SUBCAT4,
FAD_SUBCAT5,FPACKAGE_CODE,FAG_MAIN_CODE,FCLIENTCD,FEXECUTIVE_NAME,FPRIPROCTG,Fbrand_code,FVarient_Name,FPAGE_PREM,FPAGE_POST,
FCONTRACT_NAME,FSUPP_CODE,FRETAINER_CODE,FRATECD,FPSCHEME,FREVENUE_CENTER,FRO_STATUS,FPAGE_TYPE,FBOOKING_TYPE,FCOMP_CODE,FAG_SUB_CODE,
FPUB_CENT_PERMIT,userenv('sessionid'),Fdist_name,Ftalu_name,FPub_cent_Name,
Fag_city_code,Fag_zone_code,Fag_dist_code,Fag_state_code,Fag_talu_code,Fcity_name,Fzone_name, Fstate_name,f_page_no
);
commit;


return 0;

--exception when others then
--insert into amit_amit(COMPCODE,subcode,name) values(comp_cod,cio_id,bil_no);  commit;
END;
/


@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@6455@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@6450@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@


CREATE OR REPLACE PROCEDURE bookingdetailgrid (
      cioid     IN       VARCHAR2,
     P_Accounts OUT Cur_Type_New1.cursor_type

   )
is
newcioid varchar2(50);
countmatter number;
countinsert number;
filename varchar2(50);
BEGIN
newcioid:=cioid;
select count(*) into countmatter from tbl_matter where "cioid"=newcioid;
select count(*) into countinsert from tbl_booking_insert where "Cio_Booking_Id"=cioid and "File_Name" is not null;
if countmatter>countinsert then
    select "matter_filename" into filename from tbl_matter where "cioid"=newcioid and rownum<=1;
    update tbl_booking_insert set "File_Name"=filename where "Cio_Booking_Id"=cioid;
    commit;
end if;
OPEN p_Accounts FOR
select "No_Insert",
(select "pub_alias" from pub_mast where "Pub_Code"=tbl_booking_insert."Publication_Code") as Publication,
"Pub_Cent_Code" as Center,
"Edition",to_char("Insert_Date",'dd-mon-yyyy') as "Insert_Date","Col_Code","Page_No","Size_Book",
(select "Adv_Cat_Alias" from adv_cat_mast where "Adv_Cat_Code"=tbl_booking_insert."Ad_Cat" ) as AdCategory,
(select "Adv_Subcat_Alias" from adv_subcat_mast where "Adv_Subcat_Code"=tbl_booking_insert."Ad_Sub_Cat") as AdSubcategory,
"File_Name","Insert_Status",
case "Pai_Free_Ins"
when 'Y' then 'Yes'
when 'N' then 'No'
end as "Pai_Free_Ins"
,nvl("Gross_Rate",'0') as "Gross_Rate","Bill_Amt",BILL_NO,
SECTIONCODE,RESOURCE_NO,"Remarks"



from tbl_booking_insert where "Cio_Booking_Id"=cioid order by "Insert_Id";


END ;
/


@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

CREATE OR REPLACE FUNCTION getRate_Code(center varchar2,PKGCODE varchar2,adtype varchar2,ADCAT1 varchar2,COL varchar2,currency varchar2,RATECHKDATE date,uom varchar2,INSERTIONNUM number,ADCAT2 varchar2,ADCAT3 varchar2,ADCAT4 varchar2,ADCAT5 varchar2,premiumval varchar2,rCode varchar2,num number,LINE NUMBER,chkadon_p varchar2) RETURN varchar2 IS
tmpVar varchar2(500);

BEGIN

IF rCode='qbc' then

        IF num=0 then
          DBMS_OUTPUT.PUT_LINE('1');
             SELECT MAX(ROWID) into tmpvar FROM
                       rate_mast
                       WHERE "pub_center"=UPPER(center)
                       AND "Combin_Code" = PKGCODE
                       AND "Adv_Type_Code" = UPPER(adtype)
                       AND "Adv_Cat_Code" = ADCAT1
                       AND "Color" = COL
                       AND "Currency" = UPPER(currency)
                       AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                       AND "Uom" = UPPER(uom)
                       AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                       AND "Adv_subcat_code" = ADCAT2
                       AND "Ad_Subcat4" = ADCAT3
                       AND "Ad_Subcat5" = ADCAT4
                       AND "Ad_subcat6" = ADCAT5
                       AND "Premium" = premiumval  AND (ADON=chkadon_p or ADON is null) ;
         END IF;
        IF num=1 then
                SELECT MAX(ROWID) into tmpvar FROM
                           rate_mast
                           WHERE "pub_center"=UPPER(center)
                           AND "Combin_Code" = PKGCODE
                           AND "Adv_Type_Code" = UPPER(adtype)
                           AND "Adv_Cat_Code" = ADCAT1
                           AND "Color" = COL
                           AND "Currency" = UPPER(currency)
                           AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                           AND "Uom" = UPPER(uom)
                           AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                           AND LINE BETWEEN "Size_From" AND "Size_To"
                           AND "Adv_subcat_code" = ADCAT2
                           AND "Ad_Subcat4" = ADCAT3
                           AND "Ad_Subcat5" = ADCAT4
                           AND "Ad_subcat6" = ADCAT5
                         AND "Premium" = premiumval  AND (ADON=chkadon_p or ADON is null) ;
         END IF;
        IF num=2 then
                SELECT MAX(ROWID) into tmpvar FROM
                               rate_mast
                               WHERE "pub_center"=UPPER(center)
                               AND "Combin_Code" = PKGCODE
                               AND "Adv_Type_Code" = UPPER(adtype)
                               AND "Adv_Cat_Code" = ADCAT1
                               AND "Color" = COL
                               AND "Currency" = UPPER(currency)
                               AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                               AND "Uom" = UPPER(uom)
                               AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                               AND "Size_To" < TO_NUMBER (LINE)
                               AND "Adv_subcat_code" = ADCAT2
                               AND "Ad_Subcat4" = ADCAT3
                               AND "Ad_Subcat5" = ADCAT4
                               AND "Ad_subcat6" = ADCAT5
                              AND "Premium" = premiumval  AND (ADON=chkadon_p or ADON is null) ;
        END IF;

else
        IF num=0 then
            IF premiumval is not null then--add new change for page preimum
                SELECT MAX(ROWID) into tmpvar FROM
                           rate_mast
                           WHERE "Rate_Mast_Code"=rCode
                           AND "pub_center"=UPPER(center)
                           AND "Combin_Code" = PKGCODE
                           AND "Adv_Type_Code" = UPPER(adtype)
                           AND "Adv_Cat_Code" = ADCAT1
                           AND "Color" = COL
                           AND "Currency" = UPPER(currency)
                           AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                           AND "Uom" = UPPER(uom)
                           AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                           AND "Adv_subcat_code" = ADCAT2
                           AND "Ad_Subcat4" = ADCAT3
                           AND "Ad_Subcat5" = ADCAT4
                           AND "Ad_subcat6" = ADCAT5
                           AND "Premium" = premiumval 
                            AND (ADON=chkadon_p or ADON is null) ;
            ELSE
                SELECT MAX(ROWID) into tmpvar FROM
                           rate_mast
                           WHERE "Rate_Mast_Code"=rCode
                           AND "pub_center"=UPPER(center)
                           AND "Combin_Code" = PKGCODE
                           AND "Adv_Type_Code" = UPPER(adtype)
                           AND "Adv_Cat_Code" = ADCAT1
                           AND "Color" = COL
                           AND "Currency" = UPPER(currency)
                           AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                           AND "Uom" = UPPER(uom)
                           AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                           AND "Adv_subcat_code" = ADCAT2
                           AND "Ad_Subcat4" = ADCAT3
                           AND "Ad_Subcat5" = ADCAT4
                           AND "Ad_subcat6" = ADCAT5
                          -- AND "Premium" = premiumval
                           AND ("Premium" is null or "Premium"='0' or "Premium"='0')
                           AND (ADON=chkadon_p or ADON is null) ;            
            END IF;                           
         END IF;
        IF num=1 then
            SELECT MAX(ROWID) into tmpvar FROM
                           rate_mast
                           WHERE "Rate_Mast_Code"=rCode
                           AND "pub_center"=UPPER(center)
                           AND "Combin_Code" = PKGCODE
                           AND "Adv_Type_Code" = UPPER(adtype)
                           AND "Adv_Cat_Code" = ADCAT1
                           AND "Color" = COL
                           AND "Currency" = UPPER(currency)
                           AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                           AND "Uom" = UPPER(uom)
                           AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                           AND LINE BETWEEN "Size_From" AND "Size_To"
                           AND "Adv_subcat_code" = ADCAT2
                           AND "Ad_Subcat4" = ADCAT3
                           AND "Ad_Subcat5" = ADCAT4
                           AND "Ad_subcat6" = ADCAT5
                      AND "Premium" = premiumval  AND (ADON=chkadon_p or ADON is null) ;
         END IF;
        IF num=2 then
              IF premiumval is not null then--add new change for page preimum
                if adtype = 'DI0' THEN
                 SELECT MAX(ROWID) into tmpvar FROM
                               rate_mast
                               WHERE "Rate_Mast_Code"=rCode
                               AND "pub_center"=UPPER(center)
                               AND "Combin_Code" = PKGCODE
                               AND "Adv_Type_Code" = UPPER(adtype)
                               AND "Adv_Cat_Code" = ADCAT1
                               AND "Color" = COL
                               AND "Currency" = UPPER(currency)
                               AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                               AND "Uom" = UPPER(uom)
                               AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                               AND "Size_To" < TO_NUMBER (LINE)
                               AND "Adv_subcat_code" = ADCAT2
                               AND "Ad_Subcat4" = ADCAT3
                               AND "Ad_Subcat5" = ADCAT4
                               AND "Ad_subcat6" = ADCAT5
                             AND "Premium" = premiumval  
                             AND (ADON=chkadon_p or ADON is null)  AND "Size_From" ='0' AND "Size_To"='0' ;
                ELSE
                SELECT MAX(ROWID) into tmpvar FROM
                               rate_mast
                               WHERE "Rate_Mast_Code"=rCode
                               AND "pub_center"=UPPER(center)
                               AND "Combin_Code" = PKGCODE
                               AND "Adv_Type_Code" = UPPER(adtype)
                               AND "Adv_Cat_Code" = ADCAT1
                               AND "Color" = COL
                               AND "Currency" = UPPER(currency)
                               AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                               AND "Uom" = UPPER(uom)
                               AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                               AND "Size_To" < TO_NUMBER (LINE)
                               AND "Adv_subcat_code" = ADCAT2
                               AND "Ad_Subcat4" = ADCAT3
                               AND "Ad_Subcat5" = ADCAT4
                               AND "Ad_subcat6" = ADCAT5
                             AND "Premium" = premiumval  AND (ADON=chkadon_p or ADON is null)  ;
                END IF; 
          else
          
             if adtype = 'DI0' THEN
                 SELECT MAX(ROWID) into tmpvar FROM
                               rate_mast
                               WHERE "Rate_Mast_Code"=rCode
                               AND "pub_center"=UPPER(center)
                               AND "Combin_Code" = PKGCODE
                               AND "Adv_Type_Code" = UPPER(adtype)
                               AND "Adv_Cat_Code" = ADCAT1
                               AND "Color" = COL
                               AND "Currency" = UPPER(currency)
                               AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                               AND "Uom" = UPPER(uom)
                               AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                               AND "Size_To" < TO_NUMBER (LINE)
                               AND "Adv_subcat_code" = ADCAT2
                               AND "Ad_Subcat4" = ADCAT3
                               AND "Ad_Subcat5" = ADCAT4
                               AND "Ad_subcat6" = ADCAT5
                            AND ("Premium" is null or "Premium"='0' or "Premium"='0')
                             AND (ADON=chkadon_p or ADON is null)  
                             AND "Size_From" ='0' AND "Size_To"='0' ;
                ELSE
                SELECT MAX(ROWID) into tmpvar FROM
                               rate_mast
                               WHERE "Rate_Mast_Code"=rCode
                               AND "pub_center"=UPPER(center)
                               AND "Combin_Code" = PKGCODE
                               AND "Adv_Type_Code" = UPPER(adtype)
                               AND "Adv_Cat_Code" = ADCAT1
                               AND "Color" = COL
                               AND "Currency" = UPPER(currency)
                               AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                               AND "Uom" = UPPER(uom)
                               AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                               AND "Size_To" < TO_NUMBER (LINE)
                               AND "Adv_subcat_code" = ADCAT2
                               AND "Ad_Subcat4" = ADCAT3
                               AND "Ad_Subcat5" = ADCAT4
                               AND "Ad_subcat6" = ADCAT5
                            AND ("Premium" is null or "Premium"='0' or "Premium"='0')
                             AND (ADON=chkadon_p or ADON is null)  ;
                END IF;
          
          end if;            
        END IF;
end if;


   RETURN tmpVar;
   EXCEPTION
     WHEN NO_DATA_FOUND THEN
       NULL;
     WHEN OTHERS THEN
       -- Consider logging the error and then re-raise
       RAISE;
END getRate_Code;
/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

CREATE OR REPLACE PACKAGE rate_qbc is
Type T_Accounts_Cursor  is ref Cursor;
procedure rate_qbc_p(
noofinsertion in varchar2,
dateformat in varchar2,
compcode in varchar2,
uom in varchar2,
adtype in varchar2,
currency in varchar2,
ratecode in varchar2,
clientcode in varchar2,
uomdesc in varchar2,
openreferExtra in varchar2,
agencycode in varchar2,
newcode in clob,
center in varchar2,
ratepremtype in varchar2,
premiumval in varchar2,
schemetype in varchar2,
fDate in date,
lDate in date,
counter int,
rateflag in varchar2,
chkadon_p in varchar2,
P_Accounts out T_Accounts_Cursor,
P_Accounts1 out T_Accounts_Cursor,
P_Accounts2 out T_Accounts_Cursor,
P_Accounts3 out T_Accounts_Cursor
);
end rate_qbc;
/


CREATE OR REPLACE PACKAGE BODY Rate_Qbc IS
    PROCEDURE rate_qbc_p (
    noofinsertion IN VARCHAR2,
    dateformat IN VARCHAR2,
    compcode IN VARCHAR2,
    uom IN VARCHAR2,
    Adtype IN VARCHAR2,
    currency IN VARCHAR2,
    RATECODE IN VARCHAR2,
    clientcode IN VARCHAR2,
    uomdesc IN VARCHAR2,
    openreferExtra IN VARCHAR2,
    agencycode IN VARCHAR2,
    newcode IN clob,
    center IN VARCHAR2,
    ratepremtype IN VARCHAR2,
    premiumval IN VARCHAR2,
    schemetype in varchar2,
    fDate in date,
    lDate in date,
    counter int,
    rateflag in varchar2,
    chkadon_p in varchar2,
    P_Accounts OUT T_Accounts_Cursor,
    P_Accounts1 OUT T_Accounts_Cursor,
    P_Accounts2 OUT T_Accounts_Cursor,
    P_Accounts3 OUT T_Accounts_Cursor
       )
   AS
   SIZEFROM_FIX NUMBER;
   RATEGROUP VARCHAR2(20);
   FLOORAMT FLOAT;
   specialsize varchar2(20);
   specialsizerate float;
   compcode_M varchar2(50);
    combindesc_M varchar2(1000);
    advcatcode_M varchar2(50);
    advsubcatcode_M varchar2(50);
    rategroupcode_M varchar2(50);
    weekdayrate_M float;
    weekextrarate_M float;
    validfrom_M date;
    validto_M date;
   EDITIONNAME VARCHAR(100);
   AEDITIONNAME VARCHAR(100);
   PKGCODE VARCHAR(50);
   ADCAT1 VARCHAR(50);
   ADCAT2 VARCHAR(50);
   ADCAT3 VARCHAR(50);
   ADCAT4 VARCHAR(50);
   ADCAT5 VARCHAR(50);
   DUMMY_ADCAT1 VARCHAR(50);
   DUMMY_ADCAT2 VARCHAR(50);
   DUMMY_ADCAT3 VARCHAR(50);
   DUMMY_ADCAT4 VARCHAR(50);
   DUMMY_ADCAT5 VARCHAR(50);
   COL VARCHAR(50);
   DUMMY_COL VARCHAR(50);
   LINE VARCHAR(50);
   RLINE VARCHAR(50);
   BDATE DATE;-- DATE FOR DAYWISE RATE
   RATECHKDATE DATE;-- FOR VALID RATECARD
   COUNTRATE NUMBER;
   COUNTRATE1 NUMBER;
   RATEUNIQUEID VARCHAR2(100);
   FRATEUNIQUEID VARCHAR2(100);
   ARATEUNIQUEID VARCHAR(100);
   COLREFER VARCHAR(50);
   PERC NUMBER;
   CARD_RATE NUMBER;
   EXTRA_RATE NUMBER;
   FCARD_RATE NUMBER;
   FEXTRA_RATE NUMBER;
   SOLORATEWEEK     FLOAT;
   DAY1     VARCHAR(10);
   FINALRATE     VARCHAR(100);
   PKGNAME     VARCHAR(1000);
   EXTRALINE    NUMBER;
   MIN_AREA     NUMBER;
   MAX_AREA     NUMBER;
   WIDTH        NUMBER;
   CONSUM       NUMBER;
   INSERTIONNUM NUMBER;
   AD_WIDTH     NUMBER;
   PKGALIAS     VARCHAR(100);
   PREM         VARCHAR2(50);
   PAGEPREMNO         VARCHAR2(50);
   DAYDIFF      NUMBER;
   HRDIFF       NUMBER;
   MINDIFF      NUMBER;
   CDAYDIFF      NUMBER;
   CHRDIFF       NUMBER;
   CMINDIFF      NUMBER;
   CRODATETIME  VARCHAR(20);
   COUNTSCHEMEEDITION NUMBER;
   COUNTADON NUMBER;
   COUNTADONEDITION  VARCHAR(100);
   COUNTADONINSERT  NUMBER;
   PAGEPREMNODUMMY VARCHAR2(50);
   uomcode varchar2(10);
   comm_rec number;
   MIN_SIZE VARCHAR2(20);
   DIFFSIZE NUMBER;
   PREMTYPE VARCHAR2(10);
   BEGIN
   DELETE FROM RATESPLIT;
   DELETE FROM FINALRATE;
   DELETE FROM ERRORMESSAGE;
   DELETE FROM SCHEME_TEMP;
   COMMIT;

    --EDITION_NAME $ PACKAGE_CODE $ COLOR $ CAT1 $ CAT2 $ CAT3 $ CAT4 $ CAT5 $ LINES $ BOOKINGDATE & RATECHECKDATE
    Splittest(newcode,'$',',');
    uomcode:=uom;
       
    UPDATE RATECHECK SET MINSIZE=(SELECT MIN(LINES) FROM RATECHECK);
    COMMIT;

     DECLARE CURSOR R_CURSOR
      IS
            SELECT UPPER(EDITION_NAME) , UPPER(PACKAGE_CODE) , UPPER(COLOR), UPPER(CAT1) , UPPER(CAT2) , UPPER(CAT3) , UPPER(CAT4) , UPPER(CAT5) , LINES , BOOKINGDATE , RATECODEDATE, INSERTION, WIDTH, UPPER(LTRIM(RTRIM(PKG_ALIAS))), PREMIUM, UPPER(PAGEPREM),MINSIZE, SPECIALSIZE1 FROM RATECHECK;
      BEGIN
       OPEN R_CURSOR;

         LOOP
            FETCH R_CURSOR
             INTO EDITIONNAME, PKGCODE, COL, ADCAT1, ADCAT2, ADCAT3, ADCAT4, ADCAT5, LINE , BDATE, RATECHKDATE, INSERTIONNUM, AD_WIDTH, PKGALIAS, PREM, PAGEPREMNO,MIN_SIZE,specialsize;--RATECHECKDATE FOR VALID RATECARD AND BDATE FOR DAYWISE RATE

            EXIT WHEN R_CURSOR%NOTFOUND;
            DUMMY_ADCAT1:=ADCAT1;
            DUMMY_ADCAT2:=ADCAT2;
            DUMMY_ADCAT3:=ADCAT3;
            DUMMY_ADCAT4:=ADCAT4;
            DUMMY_ADCAT5:=ADCAT5;
            DUMMY_COL:=COL;
            INSERTIONNUM:=INSERTIONNUM * noofinsertion;
            --DBMS_OUTPUT.PUT_LINE('PAGEPREMNO-*'||PAGEPREMNO);
            --IF umdesc != 'CD' THEN
                BEGIN
                 SELECT COUNT(*) INTO COUNTRATE FROM RATE_MAST
                       WHERE "pub_center"=UPPER(center)
                       AND "Combin_Code" = PKGCODE
                       AND "Adv_Type_Code" = UPPER(Adtype)
                       AND "Adv_Cat_Code" = ADCAT1
                       AND "Color" = COL
                       AND "Currency" = UPPER(currency)
                       AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                       AND "Uom" = UPPER(uom)
                       AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                       AND "Adv_subcat_code" = ADCAT2
                       AND "Ad_Subcat4" = ADCAT3
                       AND "Ad_Subcat5" = ADCAT4
                       AND "Ad_subcat6" = ADCAT5
                      AND "Premium" = PAGEPREMNO
                      AND (ADON=chkadon_p or ADON is null)
                       AND ROWID=(Getrate_Code(center,PKGCODE,Adtype,ADCAT1,COL,currency,RATECHKDATE,uom,INSERTIONNUM,ADCAT2,ADCAT3,ADCAT4,ADCAT5,PAGEPREMNO,RATECODE,0,LINE,chkadon_p));


                EXCEPTION
                  WHEN NO_DATA_FOUND THEN  NULL;
                END;
                
                IF COUNTRATE IS NULL OR COUNTRATE=0 THEN

                 SELECT COUNT(*) INTO COUNTRATE FROM RATE_MAST
                       WHERE "pub_center"=UPPER(center)
                       AND "Combin_Code" = PKGCODE
                       AND "Adv_Type_Code" = UPPER(Adtype)
                       AND "Adv_Cat_Code" = ADCAT1
                       AND "Color" = COL
                       AND "Currency" = UPPER(currency)
                       AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                       AND "Uom" = UPPER(uom)
                       AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                       AND "Adv_subcat_code" = ADCAT2
                       AND "Ad_Subcat4" = ADCAT3
                       AND "Ad_Subcat5" = ADCAT4
                       AND "Ad_subcat6" = ADCAT5
                       --AND "Premium" = PAGEPREMNO
                       AND ("Premium" is null or "Premium"='' or "Premium"='0')
                       AND (ADON=chkadon_p or ADON is null)
                       AND ROWID=(Getrate_Code(center,PKGCODE,Adtype,ADCAT1,COL,currency,RATECHKDATE,uom,INSERTIONNUM,ADCAT2,ADCAT3,ADCAT4,ADCAT5,null,RATECODE,0,LINE,chkadon_p));

                END IF;
   
                  DBMS_OUTPUT.PUT_LINE('COUNTRATE-*'||COUNTRATE);
                  DBMS_OUTPUT.PUT_LINE('RATECHKDATE-*'||RATECHKDATE);
                 IF COUNTRATE IS NULL OR COUNTRATE=0 THEN
                       ADCAT5:=0;
                       DBMS_OUTPUT.PUT_LINE('ADCAT5-*'||ADCAT5);
                 BEGIN
                   SELECT COUNT(*) INTO COUNTRATE FROM RATE_MAST
                       WHERE "pub_center"=UPPER(center)
                       AND "Combin_Code" = PKGCODE
                       AND "Adv_Type_Code" = UPPER(Adtype)
                       AND "Adv_Cat_Code" = ADCAT1
                       AND "Color" = COL
                       AND "Currency" = UPPER(currency)
                       AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                       AND "Uom" = UPPER(uom)
                       AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                       AND "Adv_subcat_code" = ADCAT2
                       AND "Ad_Subcat4" = ADCAT3
                       AND "Ad_Subcat5" = ADCAT4
                       AND "Ad_subcat6" = ADCAT5
                     AND "Premium" = PAGEPREMNO
                      AND (ADON=chkadon_p or ADON is null)
                       AND ROWID=(Getrate_Code(center,PKGCODE,Adtype,ADCAT1,COL,currency,RATECHKDATE,uom,INSERTIONNUM,ADCAT2,ADCAT3,ADCAT4,ADCAT5,PAGEPREMNO,RATECODE,0,LINE,chkadon_p));
                 EXCEPTION
                   WHEN NO_DATA_FOUND THEN  NULL;
                 END;
                 END IF;

                 IF COUNTRATE IS NULL OR COUNTRATE=0 THEN
                       ADCAT4:=0;
                 BEGIN
                  SELECT COUNT(*) INTO COUNTRATE FROM RATE_MAST
                       WHERE "pub_center"=UPPER(center)
                       AND "Combin_Code" = PKGCODE
                       AND "Adv_Type_Code" = UPPER(Adtype)
                       AND "Adv_Cat_Code" = ADCAT1
                       AND "Color" = COL
                       AND "Currency" = UPPER(currency)
                       AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                       AND "Uom" = UPPER(uom)
                       AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                       AND "Adv_subcat_code" = ADCAT2
                       AND "Ad_Subcat4" = ADCAT3
                       AND "Ad_Subcat5" = ADCAT4
                       AND "Ad_subcat6" = ADCAT5
                       AND "Premium" = PAGEPREMNO
                        AND (ADON=chkadon_p or ADON is null)
                       AND ROWID=(Getrate_Code(center,PKGCODE,Adtype,ADCAT1,COL,currency,RATECHKDATE,uom,INSERTIONNUM,ADCAT2,ADCAT3,ADCAT4,ADCAT5,PAGEPREMNO,RATECODE,0,LINE,chkadon_p));
                 EXCEPTION
                   WHEN NO_DATA_FOUND THEN  NULL;
                 END;
                 END IF;

                 IF COUNTRATE IS NULL OR COUNTRATE=0 THEN
                       ADCAT3:=0;
                 BEGIN
                  SELECT COUNT(*) INTO COUNTRATE FROM RATE_MAST
                       WHERE "pub_center"=UPPER(center)
                       AND "Combin_Code" = PKGCODE
                       AND "Adv_Type_Code" = UPPER(Adtype)
                       AND "Adv_Cat_Code" = ADCAT1
                       AND "Color" = COL
                       AND "Currency" = UPPER(currency)
                       AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                       AND "Uom" = UPPER(uom)
                       AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                       AND "Adv_subcat_code" = ADCAT2
                       AND "Ad_Subcat4" = ADCAT3
                       AND "Ad_Subcat5" = ADCAT4
                       AND "Ad_subcat6" = ADCAT5
                       AND "Premium" = PAGEPREMNO
                        AND (ADON=chkadon_p or ADON is null)
                       AND ROWID=(Getrate_Code(center,PKGCODE,Adtype,ADCAT1,COL,currency,RATECHKDATE,uom,INSERTIONNUM,ADCAT2,ADCAT3,ADCAT4,ADCAT5,PAGEPREMNO,RATECODE,0,LINE,chkadon_p));
                 EXCEPTION
                   WHEN NO_DATA_FOUND THEN  NULL;
                 END;
                 END IF;

                 IF COUNTRATE IS NULL OR COUNTRATE=0 THEN
                       ADCAT2:=0;
                       DBMS_OUTPUT.PUT_LINE('ADCAT2-*'||ADCAT2 || '****' || center);
                 BEGIN
                  SELECT COUNT(*) INTO COUNTRATE FROM RATE_MAST
                       WHERE "pub_center"=UPPER(center)
                       AND "Combin_Code" = PKGCODE
                       AND "Adv_Type_Code" = UPPER(Adtype)
                       AND "Adv_Cat_Code" = ADCAT1
                       AND "Color" = COL
                       AND "Currency" = UPPER(currency)
                       AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                       AND "Uom" = UPPER(uom)
                       AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                       AND "Adv_subcat_code" = ADCAT2
                       AND "Ad_Subcat4" = ADCAT3
                       AND "Ad_Subcat5" = ADCAT4
                       AND "Ad_subcat6" = ADCAT5
                       AND "Premium" = PAGEPREMNO
                        AND (ADON=chkadon_p or ADON is null)
                       AND ROWID=(Getrate_Code(center,PKGCODE,Adtype,ADCAT1,COL,currency,RATECHKDATE,uom,INSERTIONNUM,ADCAT2,ADCAT3,ADCAT4,ADCAT5,PAGEPREMNO,RATECODE,0,LINE,chkadon_p));

                 EXCEPTION
                   WHEN NO_DATA_FOUND THEN  NULL;
                 END;
                 END IF;

                 DBMS_OUTPUT.PUT_LINE(COUNTRATE||'***');
                 IF COUNTRATE IS NOT NULL THEN
                        BEGIN
                        SELECT "rateuniqueid" INTO RATEUNIQUEID FROM RATE_MAST
                           WHERE "pub_center"=UPPER(center)
                           AND "Combin_Code" = PKGCODE
                           AND "Adv_Type_Code" = UPPER(Adtype)
                           AND "Adv_Cat_Code" = ADCAT1
                           AND "Color" = COL
                           AND "Currency" = UPPER(currency)
                           AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                           AND "Uom" = UPPER(uom)
                           AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                           AND LINE BETWEEN "Size_From" AND "Size_To"
                           AND "Adv_subcat_code" = ADCAT2
                           AND "Ad_Subcat4" = ADCAT3
                           AND "Ad_Subcat5" = ADCAT4
                           AND "Ad_subcat6" = ADCAT5
                           AND "Premium" = PAGEPREMNO
                           AND (ADON=chkadon_p or ADON is null)
                           AND ROWID=(Getrate_Code(center,PKGCODE,Adtype,ADCAT1,COL,currency,RATECHKDATE,uom,INSERTIONNUM,ADCAT2,ADCAT3,ADCAT4,ADCAT5,PAGEPREMNO,RATECODE,1,LINE,chkadon_p));
                        EXCEPTION
                            WHEN NO_DATA_FOUND THEN  NULL;
                        END;

                     IF RATEUNIQUEID IS NULL THEN
                          BEGIN
                            SELECT "rateuniqueid" INTO RATEUNIQUEID FROM RATE_MAST
                               WHERE "pub_center"=UPPER(center)
                               AND "Combin_Code" = PKGCODE
                               AND "Adv_Type_Code" = UPPER(Adtype)
                               AND "Adv_Cat_Code" = ADCAT1
                               AND "Color" = COL
                               AND "Currency" = UPPER(currency)
                               AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                               AND "Uom" = UPPER(uom)
                               AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                               AND "Size_To" < TO_NUMBER (LINE)
                               AND "Adv_subcat_code" = ADCAT2
                               AND "Ad_Subcat4" = ADCAT3
                               AND "Ad_Subcat5" = ADCAT4
                               AND "Ad_subcat6" = ADCAT5
                               AND "Premium" = PAGEPREMNO
                               AND (ADON=chkadon_p or ADON is null)
                               AND ROWID=(Getrate_Code(center,PKGCODE,Adtype,ADCAT1,COL,currency,RATECHKDATE,uom,INSERTIONNUM,ADCAT2,ADCAT3,ADCAT4,ADCAT5,PAGEPREMNO,RATECODE,2,LINE,chkadon_p));
                          EXCEPTION
                                WHEN NO_DATA_FOUND THEN  NULL;
                            END;
                     END IF;
                    
                     IF RATEUNIQUEID IS NULL THEN
                     BEGIN
                        SELECT "rateuniqueid" INTO RATEUNIQUEID FROM RATE_MAST
                           WHERE "pub_center"=UPPER(center)
                           AND "Combin_Code" = PKGCODE
                           AND "Adv_Type_Code" = UPPER(Adtype)
                           AND "Adv_Cat_Code" = ADCAT1
                           AND "Color" = COL
                           AND "Currency" = UPPER(currency)
                           AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                           AND "Uom" = UPPER(uom)
                           AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                           AND LINE BETWEEN "Size_From" AND "Size_To"
                           AND "Adv_subcat_code" = ADCAT2
                           AND "Ad_Subcat4" = ADCAT3
                           AND "Ad_Subcat5" = ADCAT4
                           AND "Ad_subcat6" = ADCAT5
                          AND ("Premium" is null or "Premium"='' or "Premium"='0')
                           AND (ADON=chkadon_p or ADON is null)
                           AND ROWID=(Getrate_Code(center,PKGCODE,Adtype,ADCAT1,COL,currency,RATECHKDATE,uom,INSERTIONNUM,ADCAT2,ADCAT3,ADCAT4,ADCAT5,PAGEPREMNO,RATECODE,1,LINE,chkadon_p));
                        EXCEPTION
                            WHEN NO_DATA_FOUND THEN  NULL;
                        END;
                        
                    END IF;
                        
                     IF RATEUNIQUEID IS NULL THEN
                          BEGIN
                            SELECT "rateuniqueid" INTO RATEUNIQUEID FROM RATE_MAST
                               WHERE "pub_center"=UPPER(center)
                               AND "Combin_Code" = PKGCODE
                               AND "Adv_Type_Code" = UPPER(Adtype)
                               AND "Adv_Cat_Code" = ADCAT1
                               AND "Color" = COL
                               AND "Currency" = UPPER(currency)
                               AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                               AND "Uom" = UPPER(uom)
                               AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                               AND "Size_To" < TO_NUMBER (LINE)
                               AND "Adv_subcat_code" = ADCAT2
                               AND "Ad_Subcat4" = ADCAT3
                               AND "Ad_Subcat5" = ADCAT4
                               AND "Ad_subcat6" = ADCAT5
                               AND ("Premium" is null or "Premium"='' or "Premium"='0')
                               AND (ADON=chkadon_p or ADON is null)
                               AND ROWID=(Getrate_Code(center,PKGCODE,Adtype,ADCAT1,COL,currency,RATECHKDATE,uom,INSERTIONNUM,ADCAT2,ADCAT3,ADCAT4,ADCAT5,null,RATECODE,2,LINE,chkadon_p));
                          EXCEPTION
                                WHEN NO_DATA_FOUND THEN  NULL;
                            END;
                     END IF;
                  END IF;
              
               -- for color reference
                 IF RATEUNIQUEID IS NULL AND COL !='B' THEN
                    ADCAT1:=DUMMY_ADCAT1;
                    ADCAT2:=DUMMY_ADCAT2;
                    ADCAT3:=DUMMY_ADCAT3;
                    ADCAT4:=DUMMY_ADCAT4;
                    ADCAT5:=DUMMY_ADCAT5;

                    BEGIN
                        SELECT DISTINCT "color_rate","prcent_pr" INTO COLREFER,PERC FROM COLORRATEGROUPMAST WHERE "color_name" = COL AND "pkg_code"=PKGCODE;
                    EXCEPTION
                      WHEN NO_DATA_FOUND THEN  NULL;
                    END;
                    dbms_output.put_line('lata'||COL);
                    IF COLREFER = '2' THEN
                        COL:='B';
                        BEGIN
                         SELECT COUNT(*) INTO COUNTRATE FROM RATE_MAST
                               WHERE "pub_center"=UPPER(center)
                               AND "Combin_Code" = PKGCODE
                               AND "Adv_Type_Code" = UPPER(Adtype)
                               AND "Adv_Cat_Code" = ADCAT1
                               AND "Color" = COL
                               AND "Currency" = UPPER(currency)
                               AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                               AND "Uom" = UPPER(uom)
                               AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                               AND "Adv_subcat_code" = ADCAT2
                               AND "Ad_Subcat4" = ADCAT3
                               AND "Ad_Subcat5" = ADCAT4
                               AND "Ad_subcat6" = ADCAT5
                               AND "Premium" = PAGEPREMNO
                                AND (ADON=chkadon_p or ADON is null)
                              AND ROWID=(Getrate_Code(center,PKGCODE,Adtype,ADCAT1,COL,currency,RATECHKDATE,uom,INSERTIONNUM,ADCAT2,ADCAT3,ADCAT4,ADCAT5,PAGEPREMNO,RATECODE,0,LINE,chkadon_p));
                        EXCEPTION
                          WHEN NO_DATA_FOUND THEN  NULL;
                        END;

                         IF COUNTRATE IS NULL OR COUNTRATE=0 THEN
                               ADCAT5:=0;
                         BEGIN
                           SELECT COUNT(*) INTO COUNTRATE FROM RATE_MAST
                               WHERE "pub_center"=UPPER(center)
                               AND "Combin_Code" = PKGCODE
                               AND "Adv_Type_Code" = UPPER(Adtype)
                               AND "Adv_Cat_Code" = ADCAT1
                               AND "Color" = COL
                               AND "Currency" = UPPER(currency)
                               AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                               AND "Uom" = UPPER(uom)
                               AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                               AND "Adv_subcat_code" = ADCAT2
                               AND "Ad_Subcat4" = ADCAT3
                               AND "Ad_Subcat5" = ADCAT4
                               AND "Ad_subcat6" = ADCAT5
                              AND "Premium" = PAGEPREMNO
                               AND (ADON=chkadon_p or ADON is null)
                               AND ROWID=(Getrate_Code(center,PKGCODE,Adtype,ADCAT1,COL,currency,RATECHKDATE,uom,INSERTIONNUM,ADCAT2,ADCAT3,ADCAT4,ADCAT5,PAGEPREMNO,RATECODE,0,LINE,chkadon_p));
                         EXCEPTION
                           WHEN NO_DATA_FOUND THEN  NULL;
                         END;
                         END IF;

                         IF COUNTRATE IS NULL OR COUNTRATE=0 THEN
                               ADCAT4:=0;
                         BEGIN
                          SELECT COUNT(*) INTO COUNTRATE FROM RATE_MAST
                               WHERE "pub_center"=UPPER(center)
                               AND "Combin_Code" = PKGCODE
                               AND "Adv_Type_Code" = UPPER(Adtype)
                               AND "Adv_Cat_Code" = ADCAT1
                               AND "Color" = COL
                               AND "Currency" = UPPER(currency)
                               AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                               AND "Uom" = UPPER(uom)
                               AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                               AND "Adv_subcat_code" = ADCAT2
                               AND "Ad_Subcat4" = ADCAT3
                               AND "Ad_Subcat5" = ADCAT4
                               AND "Ad_subcat6" = ADCAT5
                               AND "Premium" = PAGEPREMNO
                                AND (ADON=chkadon_p or ADON is null)
                               AND ROWID=(Getrate_Code(center,PKGCODE,Adtype,ADCAT1,COL,currency,RATECHKDATE,uom,INSERTIONNUM,ADCAT2,ADCAT3,ADCAT4,ADCAT5,PAGEPREMNO,RATECODE,0,LINE,chkadon_p));
                         EXCEPTION
                           WHEN NO_DATA_FOUND THEN  NULL;
                         END;
                         END IF;

                         IF COUNTRATE IS NULL OR COUNTRATE=0 THEN
                               ADCAT3:=0;
                         BEGIN
                          SELECT COUNT(*) INTO COUNTRATE FROM RATE_MAST
                               WHERE "pub_center"=UPPER(center)
                               AND "Combin_Code" = PKGCODE
                               AND "Adv_Type_Code" = UPPER(Adtype)
                               AND "Adv_Cat_Code" = ADCAT1
                               AND "Color" = COL
                               AND "Currency" = UPPER(currency)
                               AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                               AND "Uom" = UPPER(uom)
                               AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                               AND "Adv_subcat_code" = ADCAT2
                               AND "Ad_Subcat4" = ADCAT3
                               AND "Ad_Subcat5" = ADCAT4
                               AND "Ad_subcat6" = ADCAT5
                              AND "Premium" = PAGEPREMNO
                               AND (ADON=chkadon_p or ADON is null)
                               AND ROWID=(Getrate_Code(center,PKGCODE,Adtype,ADCAT1,COL,currency,RATECHKDATE,uom,INSERTIONNUM,ADCAT2,ADCAT3,ADCAT4,ADCAT5,PAGEPREMNO,RATECODE,0,LINE,chkadon_p));
                         EXCEPTION
                           WHEN NO_DATA_FOUND THEN  NULL;
                         END;
                         END IF;

                         IF COUNTRATE IS NULL OR COUNTRATE=0 THEN
                               ADCAT2:=0;
                         BEGIN
                          SELECT COUNT(*) INTO COUNTRATE FROM RATE_MAST
                               WHERE "pub_center"=UPPER(center)
                               AND "Combin_Code" = PKGCODE
                               AND "Adv_Type_Code" = UPPER(Adtype)
                               AND "Adv_Cat_Code" = ADCAT1
                               AND "Color" = COL
                               AND "Currency" = UPPER(currency)
                               AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                               AND "Uom" = UPPER(uom)
                               AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                               AND "Adv_subcat_code" = ADCAT2
                               AND "Ad_Subcat4" = ADCAT3
                               AND "Ad_Subcat5" = ADCAT4
                               AND "Ad_subcat6" = ADCAT5
                            AND "Premium" = PAGEPREMNO
                             AND (ADON=chkadon_p or ADON is null)
                              AND ROWID=(Getrate_Code(center,PKGCODE,Adtype,ADCAT1,COL,currency,RATECHKDATE,uom,INSERTIONNUM,ADCAT2,ADCAT3,ADCAT4,ADCAT5,PAGEPREMNO,RATECODE,0,LINE,chkadon_p));
                         EXCEPTION
                           WHEN NO_DATA_FOUND THEN  NULL;
                         END;
                         END IF;

                        DBMS_OUTPUT.PUT_LINE('COUNTRATE*-'||COUNTRATE);
                        IF COUNTRATE IS NOT NULL THEN
                            BEGIN
                            SELECT "rateuniqueid" INTO RATEUNIQUEID FROM RATE_MAST
                               WHERE "pub_center"=UPPER(center)
                               AND "Combin_Code" = PKGCODE
                               AND "Adv_Type_Code" = UPPER(Adtype)
                               AND "Adv_Cat_Code" = ADCAT1
                               AND "Color" = COL
                               AND "Currency" = UPPER(currency)
                               AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                               AND "Uom" = UPPER(uom)
                               AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                               AND LINE BETWEEN "Size_From" AND "Size_To"
                               AND "Adv_subcat_code" = ADCAT2
                               AND "Ad_Subcat4" = ADCAT3
                               AND "Ad_Subcat5" = ADCAT4
                               AND "Ad_subcat6" = ADCAT5
                              AND "Premium" = PAGEPREMNO
                               AND (ADON=chkadon_p or ADON is null)
                               AND ROWID=(Getrate_Code(center,PKGCODE,Adtype,ADCAT1,COL,currency,RATECHKDATE,uom,INSERTIONNUM,ADCAT2,ADCAT3,ADCAT4,ADCAT5,PAGEPREMNO,RATECODE,1,LINE,chkadon_p));
                            EXCEPTION
                                WHEN NO_DATA_FOUND THEN  NULL;
                            END;

                             IF RATEUNIQUEID IS NULL THEN
                                  BEGIN
                                    SELECT "rateuniqueid" INTO RATEUNIQUEID FROM RATE_MAST
                                       WHERE "pub_center"=UPPER(center)
                                       AND "Combin_Code" = PKGCODE
                                       AND "Adv_Type_Code" = UPPER(Adtype)
                                       AND "Adv_Cat_Code" = ADCAT1
                                       AND "Color" = COL
                                       AND "Currency" = UPPER(currency)
                                       AND RATECHKDATE BETWEEN "Valid_From" AND "Valid_To"
                                       AND "Uom" = UPPER(uom)
                                       AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion"
                                       AND "Size_To" < TO_NUMBER (LINE)
                                       AND "Adv_subcat_code" = ADCAT2
                                       AND "Ad_Subcat4" = ADCAT3
                                       AND "Ad_Subcat5" = ADCAT4
                                       AND "Ad_subcat6" = ADCAT5
                                     AND "Premium" = PAGEPREMNO
                                      AND (ADON=chkadon_p or ADON is null)
                                      AND ROWID=(Getrate_Code(center,PKGCODE,Adtype,ADCAT1,COL,currency,RATECHKDATE,uom,INSERTIONNUM,ADCAT2,ADCAT3,ADCAT4,ADCAT5,PAGEPREMNO,RATECODE,2,LINE,chkadon_p));
                                  EXCEPTION
                                        WHEN NO_DATA_FOUND THEN  NULL;
                                    END;
                             END IF;

                            END IF;
                    END IF;

                END IF;

          -- END IF;

            BEGIN
                SELECT "min_ad_area","Max_Area","MAXWIDTH","consumption_Per","Premium_Charges" INTO MIN_AREA, MAX_AREA, WIDTH,CONSUM, specialsizerate FROM RATE_MAST WHERE "rateuniqueid"=RATEUNIQUEID;
                 EXCEPTION
                    WHEN NO_DATA_FOUND THEN  NULL;
                 END;

            BEGIN
                SELECT "Package_Alias" INTO PKGNAME FROM COMBIN_MAST WHERE "Combin_Code" = PKGCODE;
             EXCEPTION
             WHEN NO_DATA_FOUND THEN  NULL;
             END;
            --    CHECK FOR  FIXED AND VARIABLE SIZE
            IF WIDTH IS NOT NULL AND WIDTH != '0' AND WIDTH != 0  THEN
                IF AD_WIDTH != WIDTH THEN
                    INSERT INTO ERRORMESSAGE(MESSAGE) VALUES('FOR PACKAGE ' || PKGNAME ||' SIZE CAN NOT BE GREATER OR LESS THAN '|| WIDTH);
                    COMMIT;
                    GOTO L;
                END IF;
            END IF;

            IF MAX_AREA IS NOT NULL AND MAX_AREA!='0' THEN
                IF LINE>MAX_AREA THEN
                     INSERT INTO ERRORMESSAGE(MESSAGE) VALUES('FOR PACKAGE ' || PKGNAME ||' SIZE CAN NOT BE GREATER THAN ' || MAX_AREA);
                     COMMIT;
                     GOTO L;
                END IF;
            END IF;
           
             IF MIN_AREA IS NOT NULL AND MIN_AREA!='0' THEN
                IF LINE<MIN_AREA  THEN
                     INSERT INTO ERRORMESSAGE(MESSAGE) VALUES('FOR PACKAGE ' || PKGNAME ||' SIZE CAN NOT BE LESS THAN ' || MIN_AREA);
                     COMMIT;
                     GOTO L;
                END IF;
            END IF;

            IF RATEUNIQUEID IS NULL THEN
                DELETE FROM RATESPLIT;
                INSERT INTO ERRORMESSAGE(MESSAGE) VALUES('RATES ARE NOT DEFINED FOR PACKAGE '|| PKGNAME);
                COMMIT;
                GOTO L;
             END IF;

            -- FOR CHECKING RO BOOKING DATETIME
            BEGIN
            SELECT "Ro_datetime" INTO CRODATETIME FROM PREFERRENCES WHERE "comp_code"=compcode;
             EXCEPTION
                        WHEN NO_DATA_FOUND THEN  NULL;
             END;
           
             IF(CONSUM IS NOT NULL  AND lDate IS NOT NULL AND fDate IS NOT NULL) THEN
             DAYDIFF:=0;
                     
               SELECT to_char(TO_DATE(lDate,'dd-mm-yy')-TO_DATE(fDate,'dd-mm-yy')) INTO DAYDIFF FROM DUAL;
            IF(DAYDIFF>CONSUM) THEN
                INSERT INTO ERRORMESSAGE(MESSAGE) VALUES('Consumption Period Exceed');
                 COMMIT;
                 GOTO L;
              END IF;
             END IF;
            IF CRODATETIME !='no' AND CRODATETIME IS NOT NULL THEN
                    SELECT to_char(TO_DATE(BDATE,'dd-mm-yy')-SYSDATE) INTO DAYDIFF FROM DUAL;
                    BEGIN
                    SELECT NVL("Production",0) INTO CDAYDIFF FROM EDITION_MAST WHERE "Edition_Alias"=EDITIONNAME;
                    EXCEPTION
                             WHEN NO_DATA_FOUND THEN  NULL;
                     END;
                    IF CDAYDIFF!=0 THEN
                        IF TO_NUMBER(DAYDIFF) <= TO_NUMBER(CDAYDIFF) THEN
                             DELETE FROM RATESPLIT;
                             INSERT INTO ERRORMESSAGE(MESSAGE) VALUES('FOR ' || EDITIONNAME ||' AD CAN BE TAKE BEFORE '|| CDAYDIFF || ' DAY OF PRODUCTION');
                             COMMIT;
                             GOTO L;
                        END IF;
                    END IF;
                    SELECT to_char((to_date(BDATE,'dd-mon-yy')-SYSDATE)*24) INTO HRDIFF from DUAL;
                    BEGIN
                    SELECT NVL("RO_hr",0) INTO CHRDIFF FROM EDITION_MAST  WHERE "Edition_Alias"=EDITIONNAME;
                    EXCEPTION
                             WHEN NO_DATA_FOUND THEN  NULL;
                     END;
                    IF CHRDIFF!=0 THEN
                        IF TO_NUMBER(HRDIFF) <= TO_NUMBER(CHRDIFF) THEN
                             DELETE FROM RATESPLIT;
                             INSERT INTO ERRORMESSAGE(MESSAGE) VALUES('FOR ' || EDITIONNAME ||' AD CAN BE TAKE BEFORE '|| CHRDIFF || ' HRs OF PRODUCTION');
                             COMMIT;
                             GOTO L;
                        END IF;
                    END IF;
                    select to_char((to_date(BDATE,'dd-mon-yy')-SYSDATE)*1440) INTO MINDIFF from DUAL;
                    BEGIN
                    SELECT NVL("RO_min",0) INTO CMINDIFF FROM EDITION_MAST  WHERE "Edition_Alias"=EDITIONNAME;
                    EXCEPTION
                             WHEN NO_DATA_FOUND THEN  NULL;
                     END;
                    IF CMINDIFF!=0 THEN
                         IF TO_NUMBER(MINDIFF) <= (CMINDIFF) THEN
                             DELETE FROM RATESPLIT;
                             INSERT INTO ERRORMESSAGE(MESSAGE) VALUES('FOR ' || EDITIONNAME ||' AD CAN BE TAKE BEFORE '|| CMINDIFF || ' MINs OF PRODUCTION');
                             COMMIT;
                             GOTO L;
                         END IF;
                     END IF;
                  
            END IF;
           SELECT "floor_amount","Rate_Gr_Code" INTO FLOORAMT,RATEGROUP  FROM RATE_MAST WHERE "rateuniqueid"=RATEUNIQUEID;
            IF COLREFER = '2' THEN
           
                  BEGIN
                        SELECT DISTINCT "prcent_pr" INTO PERC FROM COLORRATEGROUPMAST WHERE "color_name" = 'CO0' AND "pkg_code"=PKGCODE AND COLORRATEGP_CODE=RATEGROUP;
                    EXCEPTION
                      WHEN NO_DATA_FOUND THEN 
                      SELECT DISTINCT "prcent_pr" INTO PERC FROM COLORRATEGROUPMAST WHERE "color_name" = 'CO0' AND "pkg_code"=PKGCODE;
                    END;
            END IF;
            -- INSERT RATEUBIQUEID, EDITION AND PKGCODE IN TEMP TABLE RATESPLIT
            IF DUMMY_COL != COL THEN
                INSERT INTO RATESPLIT(PCODE, EDITION_NAME, RATEID, COLORREF,PERCENTAGE,BOOKINGDATE,LINES,ADVCAT1,ADVCAT2,ADVCAT3,ADVCAT4,ADVCAT5,INSERTS,PKG_ALIAS,PREMIUM,PAGEPREM,MINSIZE, SPECIALSIZE1) VALUES(PKGCODE,EDITIONNAME,RATEUNIQUEID,1,PERC,BDATE,LINE,ADCAT1,ADCAT2,ADCAT3,ADCAT4,ADCAT5,INSERTIONNUM,PKGALIAS,PREM,PAGEPREMNO,MIN_SIZE,specialsize);
            ELSE
                INSERT INTO RATESPLIT(PCODE, EDITION_NAME, RATEID, COLORREF,PERCENTAGE,BOOKINGDATE,LINES,ADVCAT1,ADVCAT2,ADVCAT3,ADVCAT4,ADVCAT5,INSERTS,PKG_ALIAS,PREMIUM,PAGEPREM,MINSIZE,SPECIALSIZE1) VALUES(PKGCODE,EDITIONNAME,RATEUNIQUEID,0,0,BDATE,LINE,ADCAT1,ADCAT2,ADCAT3,ADCAT4,ADCAT5,INSERTIONNUM,PKGALIAS,PREM,PAGEPREMNO,MIN_SIZE,specialsize);
            END IF;
            COUNTRATE:=NULL;
            RATEUNIQUEID:=NULL;
        END LOOP;
        END;
        BEGIN
        SELECT COUNT(*) INTO COUNTSCHEMEEDITION FROM SCHEME_MASTER_EDITION;
        EXCEPTION
                             WHEN NO_DATA_FOUND THEN  COUNTSCHEMEEDITION:=0;
        END;
        COUNTRATE:=NULL;
        RATEUNIQUEID:=NULL;
        PKGCODE:=NULL;
        EDITIONNAME:=NULL;
        BDATE:=NULL;
        PERC:=NULL;
        COLREFER:=NULL;
        LINE:=NULL;
        ADCAT1:=NULL;
        ADCAT2:=NULL;
        ADCAT3:=NULL;
        ADCAT4:=NULL;
        ADCAT5:=NULL;
        INSERTIONNUM:=0;
        PKGALIAS:='';
        PREM:='';
        PAGEPREMNO:='';
        MIN_SIZE:='';
        specialsize:='';
        -- CURSOR FOR FETCHING RATE INSERTWISE WITH RATEUNIQUEID
       DECLARE CURSOR R1_CURSOR
        IS
                SELECT PCODE,EDITION_NAME,RATEID,COLORREF,PERCENTAGE,BOOKINGDATE,LINES,ADVCAT1,ADVCAT2,ADVCAT3,ADVCAT4,ADVCAT5,INSERTS, PKG_ALIAS, PREMIUM, PAGEPREM,MINSIZE, SPECIALSIZE1 FROM RATESPLIT ORDER BY RATEID;
        BEGIN
           OPEN R1_CURSOR;

             LOOP
                FETCH R1_CURSOR
                 INTO PKGCODE, EDITIONNAME, FRATEUNIQUEID, COLREFER, PERC, BDATE, LINE, ADCAT1, ADCAT2, ADCAT3, ADCAT4, ADCAT5, INSERTIONNUM, PKGALIAS, PREM, PAGEPREMNO,MIN_SIZE,specialsize;
                   EXIT WHEN R1_CURSOR%NOTFOUND;
                     BEGIN
                        --SELECT COUNT(*) INTO COUNTRATE FROM RATESPLIT WHERE RATEID=FRATEUNIQUEID GROUP BY RATEID HAVING COUNT(*) > 1;
                        DBMS_OUTPUT.PUT_LINE(FRATEUNIQUEID);
                        SELECT COUNT(*) INTO COUNTRATE FROM RATE_DETAILS WHERE "ratemastid"=FRATEUNIQUEID GROUP BY "ratemastid" HAVING COUNT(*) > 1;
                     EXCEPTION
                        WHEN NO_DATA_FOUND THEN  NULL;
                     END;
                     CARD_RATE:=NULL;
                     EXTRA_RATE:=NULL;
                     FCARD_RATE:=NULL;
                     FEXTRA_RATE:=NULL;

                    DAY1 := TO_CHAR (BDATE, 'Dy');
                    DBMS_OUTPUT.PUT_LINE('DAY-*'||DAY1);
                   -- IF uomdesc != 'CD' THEN
                        SELECT "Size_To" INTO RLINE FROM RATE_MAST WHERE "rateuniqueid"=FRATEUNIQUEID AND ROWNUM<=1;
                    --END IF;

                    IF COUNTRATE IS NULL THEN
                    -- NOT PACKAGE
                        IF COLREFER = '0' THEN
                                IF ratepremtype = 'per' THEN
                                    BEGIN
                                    SELECT CASE WHEN DAY1='Sun' THEN "Week_Day_Rate" + ("Week_Day_Rate" * "SUN_RATE")/100  || '$' || ("Week_Extra_Rate" + ("Week_Extra_Rate" * "SUN_RATE_EXTRA")/100)
                                                WHEN DAY1='Mon' THEN "Week_Day_Rate" + ("Week_Day_Rate" * "MON_RATE")/100  || '$' || ("Week_Extra_Rate" + ("Week_Extra_Rate" * "MON_RATE_EXTRA")/100)
                                                WHEN DAY1='Tue' THEN "Week_Day_Rate" + ("Week_Day_Rate" * "TUE_RATE")/100  || '$' || ("Week_Extra_Rate" + ("Week_Extra_Rate" * "TUE_RATE_EXTRA")/100)
                                                WHEN DAY1='Wed' THEN "Week_Day_Rate" + ("Week_Day_Rate" * "WED_RATE")/100  || '$' || ("Week_Extra_Rate" + ("Week_Extra_Rate" * "WED_RATE_EXTRA")/100)
                                                WHEN DAY1='Thu' THEN "Week_Day_Rate" + ("Week_Day_Rate" * "THU_RATE")/100  || '$' || ("Week_Extra_Rate" + ("Week_Extra_Rate" * "THU_RATE_EXTRA")/100)
                                                WHEN DAY1='Fri' THEN "Week_Day_Rate" + ("Week_Day_Rate" * "FRI_RATE")/100  || '$' || ("Week_Extra_Rate" + ("Week_Extra_Rate" * "FRI_RATE_EXTRA")/100)
                                                WHEN DAY1='Sat' THEN "Week_Day_Rate" + ("Week_Day_Rate" * "SAT_RATE")/100  || '$' || ("Week_Extra_Rate" + ("Week_Extra_Rate" * "SAT_RATE_EXTRA")/100)
                                     END
                                    INTO FINALRATE
                                    FROM RATE_MAST WHERE "rateuniqueid"=FRATEUNIQUEID;
                                    EXCEPTION
                                        WHEN NO_DATA_FOUND THEN  NULL;
                                      END;
                                ELSE
                                     BEGIN
                                        SELECT CASE WHEN DAY1='Sun' THEN ("Week_Day_Rate" + "SUN_RATE")  || '$' || ("Week_Extra_Rate" + "SUN_RATE_EXTRA")
                                                    WHEN DAY1='Mon' THEN ("Week_Day_Rate" + "MON_RATE")  || '$' || ("Week_Extra_Rate" + "MON_RATE_EXTRA")
                                                    WHEN DAY1='Tue' THEN ("Week_Day_Rate" + "TUE_RATE")  || '$' || ("Week_Extra_Rate" + "TUE_RATE_EXTRA")
                                                    WHEN DAY1='Wed' THEN ("Week_Day_Rate" + "WED_RATE")  || '$' || ("Week_Extra_Rate" + "WED_RATE_EXTRA")
                                                    WHEN DAY1='Thu' THEN ("Week_Day_Rate" + "THU_RATE")  || '$' || ("Week_Extra_Rate" + "THU_RATE_EXTRA")
                                                    WHEN DAY1='Fri' THEN ("Week_Day_Rate" + "FRI_RATE")  || '$' || ("Week_Extra_Rate" + "FRI_RATE_EXTRA")
                                                    WHEN DAY1='Sat' THEN ("Week_Day_Rate" + "SAT_RATE")  || '$' || ("Week_Extra_Rate" + "SAT_RATE_EXTRA")
                                               END
                                            INTO FINALRATE
                                            FROM RATE_MAST WHERE "rateuniqueid"=FRATEUNIQUEID;
                                       EXCEPTION
                                        WHEN NO_DATA_FOUND THEN  NULL;
                                      END;
                                END IF;


                        ELSE

                                IF openreferExtra = 'open' THEN
                                    IF ratepremtype = 'per' THEN
                                          BEGIN
                                           SELECT CASE  WHEN DAY1='Sun' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "SUN_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "SUN_RATE")/100)* PERC/100))  || '$' || (("Week_Extra_Rate" + ("Week_Extra_Rate" * "SUN_RATE_EXTRA")/100) + (("Week_Extra_Rate" + ("Week_Extra_Rate" * "SUN_RATE_EXTRA")/100) * PERC/100))
                                                        WHEN DAY1='Mon' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "MON_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "MON_RATE")/100)* PERC/100))  || '$' || (("Week_Extra_Rate" + ("Week_Extra_Rate" * "MON_RATE_EXTRA")/100) + (("Week_Extra_Rate" + ("Week_Extra_Rate" * "MON_RATE_EXTRA")/100) * PERC/100))
                                                        WHEN DAY1='Tue' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "TUE_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "TUE_RATE")/100)* PERC/100))  || '$' || (("Week_Extra_Rate" + ("Week_Extra_Rate" * "TUE_RATE_EXTRA")/100) + (("Week_Extra_Rate" + ("Week_Extra_Rate" * "TUE_RATE_EXTRA")/100) * PERC/100))
                                                        WHEN DAY1='Wed' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "WED_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "WED_RATE")/100)* PERC/100))  || '$' || (("Week_Extra_Rate" + ("Week_Extra_Rate" * "WED_RATE_EXTRA")/100) + (("Week_Extra_Rate" + ("Week_Extra_Rate" * "WED_RATE_EXTRA")/100) * PERC/100))
                                                        WHEN DAY1='Thu' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "THU_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "THU_RATE")/100)* PERC/100))  || '$' || (("Week_Extra_Rate" + ("Week_Extra_Rate" * "THU_RATE_EXTRA")/100) + (("Week_Extra_Rate" + ("Week_Extra_Rate" * "THU_RATE_EXTRA")/100) * PERC/100))
                                                        WHEN DAY1='Fri' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "FRI_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "FRI_RATE")/100)* PERC/100))  || '$' || (("Week_Extra_Rate" + ("Week_Extra_Rate" * "FRI_RATE_EXTRA")/100) + (("Week_Extra_Rate" + ("Week_Extra_Rate" * "FRI_RATE_EXTRA")/100) * PERC/100))
                                                        WHEN DAY1='Sat' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "SAT_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "SAT_RATE")/100)* PERC/100))  || '$' || (("Week_Extra_Rate" + ("Week_Extra_Rate" * "SAT_RATE_EXTRA")/100) + (("Week_Extra_Rate" + ("Week_Extra_Rate" * "SAT_RATE_EXTRA")/100) * PERC/100))
                                            END
                                                INTO FINALRATE
                                                FROM RATE_MAST WHERE "rateuniqueid"=FRATEUNIQUEID;
                                            EXCEPTION
                                            WHEN NO_DATA_FOUND THEN  NULL;
                                            END;
                                    ELSE
                                          BEGIN
                                           SELECT CASE WHEN  DAY1='Sun' THEN (("Week_Day_Rate" + "SUN_RATE") + (("Week_Day_Rate" + "SUN_RATE")* PERC/100))  || '$' || (("Week_Extra_Rate" + "SUN_RATE_EXTRA") + (("Week_Extra_Rate" + "SUN_RATE_EXTRA") * PERC/100))
                                                        WHEN DAY1='Mon' THEN (("Week_Day_Rate" + "MON_RATE") + (("Week_Day_Rate" + "MON_RATE")* PERC/100))  || '$' || (("Week_Extra_Rate" + "MON_RATE_EXTRA") + (("Week_Extra_Rate" + "MON_RATE_EXTRA") * PERC/100))
                                                        WHEN DAY1='Tue' THEN (("Week_Day_Rate" + "TUE_RATE") + (("Week_Day_Rate" + "TUE_RATE")* PERC/100))  || '$' || (("Week_Extra_Rate" + "TUE_RATE_EXTRA") + (("Week_Extra_Rate" + "TUE_RATE_EXTRA") * PERC/100))
                                                        WHEN DAY1='Wed' THEN (("Week_Day_Rate" + "WED_RATE") + (("Week_Day_Rate" + "WED_RATE")* PERC/100))  || '$' || (("Week_Extra_Rate" + "WED_RATE_EXTRA") + (("Week_Extra_Rate" + "WED_RATE_EXTRA") * PERC/100))
                                                        WHEN DAY1='Thu' THEN (("Week_Day_Rate" + "THU_RATE") + (("Week_Day_Rate" + "THU_RATE")* PERC/100))  || '$' || (("Week_Extra_Rate" + "THU_RATE_EXTRA") + (("Week_Extra_Rate" + "THU_RATE_EXTRA") * PERC/100))
                                                        WHEN DAY1='Fri' THEN (("Week_Day_Rate" + "FRI_RATE") + (("Week_Day_Rate" + "FRI_RATE")* PERC/100))  || '$' || (("Week_Extra_Rate" + "FRI_RATE_EXTRA") + (("Week_Extra_Rate" + "FRI_RATE_EXTRA") * PERC/100))
                                                        WHEN DAY1='Sat' THEN (("Week_Day_Rate" + "SAT_RATE") + (("Week_Day_Rate" + "SAT_RATE")* PERC/100))  || '$' || (("Week_Extra_Rate" + "SAT_RATE_EXTRA") + (("Week_Extra_Rate" + "SAT_RATE_EXTRA") * PERC/100))
                                            END
                                             INTO FINALRATE
                                             FROM RATE_MAST WHERE "rateuniqueid"=FRATEUNIQUEID;
                                            EXCEPTION
                                            WHEN NO_DATA_FOUND THEN  NULL;
                                            END;
                                    END IF;
                                ELSE
                                    IF ratepremtype = 'per' THEN
                                          BEGIN
                                            SELECT CASE WHEN DAY1='Sun' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "SUN_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "SUN_RATE")/100)* PERC/100))  || '$' || ("Week_Extra_Rate" + ("Week_Extra_Rate" * "SUN_RATE_EXTRA")/100)
                                                        WHEN DAY1='Mon' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "MON_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "MON_RATE")/100)* PERC/100))  || '$' || ("Week_Extra_Rate" + ("Week_Extra_Rate" * "MON_RATE_EXTRA")/100)
                                                        WHEN DAY1='Tue' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "TUE_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "TUE_RATE")/100)* PERC/100))  || '$' || ("Week_Extra_Rate" + ("Week_Extra_Rate" * "TUE_RATE_EXTRA")/100)
                                                        WHEN DAY1='Wed' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "WED_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "WED_RATE")/100)* PERC/100))  || '$' || ("Week_Extra_Rate" + ("Week_Extra_Rate" * "WED_RATE_EXTRA")/100)
                                                        WHEN DAY1='Thu' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "THU_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "THU_RATE")/100)* PERC/100))  || '$' || ("Week_Extra_Rate" + ("Week_Extra_Rate" * "THU_RATE_EXTRA")/100)
                                                        WHEN DAY1='Fri' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "FRI_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "FRI_RATE")/100)* PERC/100))  || '$' || ("Week_Extra_Rate" + ("Week_Extra_Rate" * "FRI_RATE_EXTRA")/100)
                                                        WHEN DAY1='Sat' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "SAT_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "SAT_RATE")/100)* PERC/100))  || '$' || ("Week_Extra_Rate" + ("Week_Extra_Rate" * "SAT_RATE_EXTRA")/100)
                                                    END
                                                        INTO FINALRATE
                                                FROM RATE_MAST WHERE "rateuniqueid"=FRATEUNIQUEID;
                                                EXCEPTION
                                                WHEN NO_DATA_FOUND THEN  NULL;
                                               END;
                                    ELSE
                                           BEGIN
                                            SELECT CASE WHEN DAY1='Sun' THEN (("Week_Day_Rate" + "SUN_RATE") + (("Week_Day_Rate" + "SUN_RATE")* PERC/100))  || '$' || ("Week_Extra_Rate" + "SUN_RATE_EXTRA")
                                                        WHEN DAY1='Mon' THEN (("Week_Day_Rate" + "MON_RATE") + (("Week_Day_Rate" + "MON_RATE")* PERC/100))  || '$' || ("Week_Extra_Rate" + "MON_RATE_EXTRA")
                                                        WHEN DAY1='Tue' THEN (("Week_Day_Rate" + "TUE_RATE") + (("Week_Day_Rate" + "TUE_RATE")* PERC/100))  || '$' || ("Week_Extra_Rate" + "TUE_RATE_EXTRA")
                                                        WHEN DAY1='Wed' THEN (("Week_Day_Rate" + "WED_RATE") + (("Week_Day_Rate" + "WED_RATE")* PERC/100))  || '$' || ("Week_Extra_Rate" + "WED_RATE_EXTRA")
                                                        WHEN DAY1='Thu' THEN (("Week_Day_Rate" + "THU_RATE") + (("Week_Day_Rate" + "THU_RATE")* PERC/100))  || '$' || ("Week_Extra_Rate" + "THU_RATE_EXTRA")
                                                        WHEN DAY1='Fri' THEN (("Week_Day_Rate" + "FRI_RATE") + (("Week_Day_Rate" + "FRI_RATE")* PERC/100))  || '$' || ("Week_Extra_Rate" + "FRI_RATE_EXTRA")
                                                        WHEN DAY1='Sat' THEN (("Week_Day_Rate" + "SAT_RATE") + (("Week_Day_Rate" + "SAT_RATE")* PERC/100))  || '$' || ("Week_Extra_Rate" + "SAT_RATE_EXTRA")
                                                    END
                                                        INTO FINALRATE
                                                FROM RATE_MAST WHERE "rateuniqueid"=FRATEUNIQUEID;
                                                EXCEPTION
                                                WHEN NO_DATA_FOUND THEN  NULL;
                                               END;
                                    END IF;

                                END IF;

                        END IF;
                        if uomdesc = 'CD' then
                            SELECT "Week_Extra_Rate" INTO SOLORATEWEEK FROM RATE_MAST WHERE "rateuniqueid"=FRATEUNIQUEID;
                        else
                            SELECT "Week_Day_Rate" INTO SOLORATEWEEK FROM RATE_MAST WHERE "rateuniqueid"=FRATEUNIQUEID;
                        end if;
 dbms_output.put_line('FINALRATE'||FINALRATE);
                         SELECT SUBSTR(FINALRATE,1,INSTR(FINALRATE,'$')-1) INTO CARD_RATE FROM DUAL;
                         SELECT SUBSTR(FINALRATE,INSTR(FINALRATE,'$')+1) INTO EXTRA_RATE FROM DUAL;
                          FEXTRA_RATE:=0;
                          FCARD_RATE:=0;
                           dbms_output.put_line('CARD_RATE'||CARD_RATE);
                          
                        -- IF uomdesc != 'CD' THEN
                             IF EXTRA_RATE IS NULL THEN
                                EXTRA_RATE:=CARD_RATE;
                            END IF;
                             dbms_output.put_line('EXTRA_RATE'||EXTRA_RATE);
                             dbms_output.put_line('LINE'||LINE);
                             dbms_output.put_line('RLINE'||RLINE);
                             IF TO_NUMBER(LINE)>TO_NUMBER(RLINE) THEN
                                EXTRALINE:=LINE-RLINE;
                             --     dbms_output.put_line('EXTRALINE'||EXTRALINE);
                              --  CARD_RATE:= CARD_RATE * EXTRALINE;
                                FEXTRA_RATE:=EXTRA_RATE * EXTRALINE;
                                FCARD_RATE:= CARD_RATE + FEXTRA_RATE;
                             ELSE
                                FCARD_RATE:= CARD_RATE;
                                FEXTRA_RATE:=EXTRA_RATE;
                             END IF;
                       --  END IF;
                        dbms_output.put_line('premiumval'||PREM);
                        IF specialsize is not null and specialsizerate is not null then
                            FCARD_RATE:=TO_NUMBER(FCARD_RATE) + (TO_NUMBER(specialsize) * TO_NUMBER(specialsizerate));
                        end if;
                        IF PREM IS NOT NULL AND PREM!='0'  THEN
                            FCARD_RATE:=TO_NUMBER(FCARD_RATE) + (TO_NUMBER(FCARD_RATE) * TO_NUMBER(Getpospremium(PREM,compcode))/100);
                        END IF;
                        IF PAGEPREMNO IS NOT NULL AND PAGEPREMNO!='0'  THEN
                             dbms_output.put_line(PKGALIAS||'********'||PAGEPREMNO);
                             SELECT "premium_charges_type" INTO PREMTYPE FROM advpos_prem_mast WHERE "Premiumcode"=PAGEPREMNO  AND "comp_code"=compcode;
                             IF(PREMTYPE='per') then
                                FCARD_RATE:=TO_NUMBER(FCARD_RATE) + (TO_NUMBER(FCARD_RATE) * TO_NUMBER(Getpagepremium(PAGEPREMNO,compcode))/100);
                             ELSE
                                FCARD_RATE:=TO_NUMBER(FCARD_RATE) + TO_NUMBER(Getpagepremium(PAGEPREMNO,compcode));  
                             END IF;  
                        END IF;
                        ---- FOR FIX SIZE
                      
                        IF AdType='DI0' THEN
                             DBMS_OUTPUT.PUT_LINE('FIX SIZE12');
                            SELECT "Size_From" INTO SIZEFROM_FIX FROM RATE_MAST WHERE "rateuniqueid"=FRATEUNIQUEID;
                            DBMS_OUTPUT.PUT_LINE(SIZEFROM_FIX);
                            IF SIZEFROM_FIX IS NOT NULL AND SIZEFROM_FIX!='0' THEN
                            DBMS_OUTPUT.PUT_LINE('SIZEFROM_FIX');
                                CARD_RATE:=TO_NUMBER(CARD_RATE)/TO_NUMBER(SIZEFROM_FIX);
                                DBMS_OUTPUT.PUT_LINE(CARD_RATE);
                                EXTRA_RATE:=TO_NUMBER(EXTRA_RATE)/TO_NUMBER(SIZEFROM_FIX);
                            END IF;
                        END IF;
                        ----
                        INSERT INTO FINALRATE(PCODE,EDITION_NAME,RATEID,CARDRATE,EXTRARATE,FCARDRATE,FEXTRARATE,ADVCAT1,ADVCAT2,ADVCAT3,ADVCAT4,ADVCAT5,LINES,PKG_ALIAS,SOLORATE) VALUES(PKGCODE,EDITIONNAME,FRATEUNIQUEID,CARD_RATE,EXTRA_RATE,FCARD_RATE,FEXTRA_RATE,ADCAT1,ADCAT2,ADCAT3,ADCAT4,ADCAT5,LINE,PKGALIAS,SOLORATEWEEK);
                        IF schemetype = '1' THEN
                            INSERT INTO SCHEME_TEMP SELECT "From_Insertion_No","To_Insertion_No", "Discount", "Discount_Type", PKGCODE,"Scheme_Name","Scheme_Code","scheme_id" FROM SCHEME_MASTER WHERE "Scheme_Code" =(SELECT "Scheme_Code" FROM SCHEME_MASTER WHERE "scheme_id"=(SELECT "Scheme_Name" FROM RATE_MAST WHERE "rateuniqueid"=FRATEUNIQUEID) AND ROWNUM<=1) AND "From_Insertion_No"<=INSERTIONNUM AND "To_Insertion_No"<=INSERTIONNUM;
                        ELSE
                            INSERT INTO SCHEME_TEMP SELECT "From_Insertion_No","To_Insertion_No", "Discount", "Discount_Type", PKGCODE,"Scheme_Name","Scheme_Code","scheme_id" FROM SCHEME_MASTER WHERE "Scheme_Code" =(SELECT "Scheme_Code" FROM SCHEME_MASTER WHERE "scheme_id"=(SELECT "Scheme_Name" FROM RATE_MAST WHERE "rateuniqueid"=FRATEUNIQUEID) AND ROWNUM<=1) AND INSERTIONNUM ="To_Insertion_No"; --BETWEEN "From_Insertion_No" AND "To_Insertion_No";
                        END IF;
                    ELSE
                    --PACKAGE

                                IF openreferExtra = 'open' THEN
                                    IF ratepremtype = 'per' THEN
                                          BEGIN
                                           DBMS_OUTPUT.PUT_LINE('LLL'|| EDITIONNAME || ',' || FRATEUNIQUEID || ','||PKGALIAS ||',' || DAY1 || ',' || PERC);
                                           SELECT CASE  WHEN DAY1='Sun' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "SUN_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "SUN_RATE")/100)* PERC/100))  || '$' || (("Week_Extra_Rate" + ("Week_Extra_Rate" * "SUN_RATE_EXTRA")/100) + (("Week_Extra_Rate" + ("Week_Extra_Rate" * "SUN_RATE_EXTRA")/100) * PERC/100))
                                                        WHEN DAY1='Mon' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "MON_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "MON_RATE")/100)* PERC/100))  || '$' || (("Week_Extra_Rate" + ("Week_Extra_Rate" * "MON_RATE_EXTRA")/100) + (("Week_Extra_Rate" + ("Week_Extra_Rate" * "MON_RATE_EXTRA")/100) * PERC/100))
                                                        WHEN DAY1='Tue' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "TUE_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "TUE_RATE")/100)* PERC/100))  || '$' || (("Week_Extra_Rate" + ("Week_Extra_Rate" * "TUE_RATE_EXTRA")/100) + (("Week_Extra_Rate" + ("Week_Extra_Rate" * "TUE_RATE_EXTRA")/100) * PERC/100))
                                                        WHEN DAY1='Wed' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "WED_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "WED_RATE")/100)* PERC/100))  || '$' || (("Week_Extra_Rate" + ("Week_Extra_Rate" * "WED_RATE_EXTRA")/100) + (("Week_Extra_Rate" + ("Week_Extra_Rate" * "WED_RATE_EXTRA")/100) * PERC/100))
                                                        WHEN DAY1='Thu' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "THU_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "THU_RATE")/100)* PERC/100))  || '$' || (("Week_Extra_Rate" + ("Week_Extra_Rate" * "THU_RATE_EXTRA")/100) + (("Week_Extra_Rate" + ("Week_Extra_Rate" * "THU_RATE_EXTRA")/100) * PERC/100))
                                                        WHEN DAY1='Fri' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "FRI_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "FRI_RATE")/100)* PERC/100))  || '$' || (("Week_Extra_Rate" + ("Week_Extra_Rate" * "FRI_RATE_EXTRA")/100) + (("Week_Extra_Rate" + ("Week_Extra_Rate" * "FRI_RATE_EXTRA")/100) * PERC/100))
                                                        WHEN DAY1='Sat' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "SAT_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "SAT_RATE")/100)* PERC/100))  || '$' || (("Week_Extra_Rate" + ("Week_Extra_Rate" * "SAT_RATE_EXTRA")/100) + (("Week_Extra_Rate" + ("Week_Extra_Rate" * "SAT_RATE_EXTRA")/100) * PERC/100))
                                            END
                                                INTO FINALRATE
                                                FROM RATE_DETAILS WHERE "ratemastid"=FRATEUNIQUEID  AND LTRIM(RTRIM("edition_name"))=LTRIM(RTRIM(EDITIONNAME)) AND ("PKGNAME"=LTRIM(RTRIM(PKGALIAS)) OR "PKGNAME" IS NULL);
                                            EXCEPTION
                                            WHEN NO_DATA_FOUND THEN  NULL;
                                            END;
                                          
                                    ELSE
                                          BEGIN
                                           SELECT CASE WHEN  DAY1='Sun' THEN (("Week_Day_Rate" + "SUN_RATE") + (("Week_Day_Rate" + "SUN_RATE")* PERC/100))  || '$' || (("Week_Extra_Rate" + "SUN_RATE_EXTRA") + (("Week_Extra_Rate" + "SUN_RATE_EXTRA") * PERC/100))
                                                        WHEN DAY1='Mon' THEN (("Week_Day_Rate" + "MON_RATE") + (("Week_Day_Rate" + "MON_RATE")* PERC/100))  || '$' || (("Week_Extra_Rate" + "MON_RATE_EXTRA") + (("Week_Extra_Rate" + "MON_RATE_EXTRA") * PERC/100))
                                                        WHEN DAY1='Tue' THEN (("Week_Day_Rate" + "TUE_RATE") + (("Week_Day_Rate" + "TUE_RATE")* PERC/100))  || '$' || (("Week_Extra_Rate" + "TUE_RATE_EXTRA") + (("Week_Extra_Rate" + "TUE_RATE_EXTRA") * PERC/100))
                                                        WHEN DAY1='Wed' THEN (("Week_Day_Rate" + "WED_RATE") + (("Week_Day_Rate" + "WED_RATE")* PERC/100))  || '$' || (("Week_Extra_Rate" + "WED_RATE_EXTRA") + (("Week_Extra_Rate" + "WED_RATE_EXTRA") * PERC/100))
                                                        WHEN DAY1='Thu' THEN (("Week_Day_Rate" + "THU_RATE") + (("Week_Day_Rate" + "THU_RATE")* PERC/100))  || '$' || (("Week_Extra_Rate" + "THU_RATE_EXTRA") + (("Week_Extra_Rate" + "THU_RATE_EXTRA") * PERC/100))
                                                        WHEN DAY1='Fri' THEN (("Week_Day_Rate" + "FRI_RATE") + (("Week_Day_Rate" + "FRI_RATE")* PERC/100))  || '$' || (("Week_Extra_Rate" + "FRI_RATE_EXTRA") + (("Week_Extra_Rate" + "FRI_RATE_EXTRA") * PERC/100))
                                                        WHEN DAY1='Sat' THEN (("Week_Day_Rate" + "SAT_RATE") + (("Week_Day_Rate" + "SAT_RATE")* PERC/100))  || '$' || (("Week_Extra_Rate" + "SAT_RATE_EXTRA") + (("Week_Extra_Rate" + "SAT_RATE_EXTRA") * PERC/100))
                                            END
                                             INTO FINALRATE
                                            FROM RATE_DETAILS WHERE "ratemastid"=FRATEUNIQUEID AND LTRIM(RTRIM("edition_name"))=LTRIM(RTRIM(EDITIONNAME)) AND ("PKGNAME"=LTRIM(RTRIM(PKGALIAS)) OR "PKGNAME" IS NULL);
                                            EXCEPTION
                                            WHEN NO_DATA_FOUND THEN  NULL;
                                            END;
                                    END IF;
                                ELSE
                                    IF ratepremtype = 'per' THEN
                                          BEGIN
                                            SELECT CASE WHEN DAY1='Sun' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "SUN_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "SUN_RATE")/100)* PERC/100))  || '$' || ("Week_Extra_Rate" + ("Week_Extra_Rate" * "SUN_RATE_EXTRA")/100)
                                                        WHEN DAY1='Mon' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "MON_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "MON_RATE")/100)* PERC/100))  || '$' || ("Week_Extra_Rate" + ("Week_Extra_Rate" * "MON_RATE_EXTRA")/100)
                                                        WHEN DAY1='Tue' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "TUE_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "TUE_RATE")/100)* PERC/100))  || '$' || ("Week_Extra_Rate" + ("Week_Extra_Rate" * "TUE_RATE_EXTRA")/100)
                                                        WHEN DAY1='Wed' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "WED_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "WED_RATE")/100)* PERC/100))  || '$' || ("Week_Extra_Rate" + ("Week_Extra_Rate" * "WED_RATE_EXTRA")/100)
                                                        WHEN DAY1='Thu' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "THU_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "THU_RATE")/100)* PERC/100))  || '$' || ("Week_Extra_Rate" + ("Week_Extra_Rate" * "THU_RATE_EXTRA")/100)
                                                        WHEN DAY1='Fri' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "FRI_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "FRI_RATE")/100)* PERC/100))  || '$' || ("Week_Extra_Rate" + ("Week_Extra_Rate" * "FRI_RATE_EXTRA")/100)
                                                        WHEN DAY1='Sat' THEN (("Week_Day_Rate" + ("Week_Day_Rate" * "SAT_RATE")/100) + (("Week_Day_Rate" + ("Week_Day_Rate" * "SAT_RATE")/100)* PERC/100))  || '$' || ("Week_Extra_Rate" + ("Week_Extra_Rate" * "SAT_RATE_EXTRA")/100)
                                                    END
                                                        INTO FINALRATE
                                                FROM RATE_DETAILS WHERE "ratemastid"=FRATEUNIQUEID AND LTRIM(RTRIM("edition_name"))=LTRIM(RTRIM(EDITIONNAME)) AND ("PKGNAME"=LTRIM(RTRIM(PKGALIAS)) OR "PKGNAME" IS NULL);
                                                EXCEPTION
                                                WHEN NO_DATA_FOUND THEN  NULL;
                                               END;
                                    ELSE
                                           BEGIN
                                            SELECT CASE WHEN DAY1='Sun' THEN (("Week_Day_Rate" + "SUN_RATE") + (("Week_Day_Rate" + "SUN_RATE")* PERC/100))  || '$' || ("Week_Extra_Rate" + "SUN_RATE_EXTRA")
                                                        WHEN DAY1='Mon' THEN (("Week_Day_Rate" + "MON_RATE") + (("Week_Day_Rate" + "MON_RATE")* PERC/100))  || '$' || ("Week_Extra_Rate" + "MON_RATE_EXTRA")
                                                        WHEN DAY1='Tue' THEN (("Week_Day_Rate" + "TUE_RATE") + (("Week_Day_Rate" + "TUE_RATE")* PERC/100))  || '$' || ("Week_Extra_Rate" + "TUE_RATE_EXTRA")
                                                        WHEN DAY1='Wed' THEN (("Week_Day_Rate" + "WED_RATE") + (("Week_Day_Rate" + "WED_RATE")* PERC/100))  || '$' || ("Week_Extra_Rate" + "WED_RATE_EXTRA")
                                                        WHEN DAY1='Thu' THEN (("Week_Day_Rate" + "THU_RATE") + (("Week_Day_Rate" + "THU_RATE")* PERC/100))  || '$' || ("Week_Extra_Rate" + "THU_RATE_EXTRA")
                                                        WHEN DAY1='Fri' THEN (("Week_Day_Rate" + "FRI_RATE") + (("Week_Day_Rate" + "FRI_RATE")* PERC/100))  || '$' || ("Week_Extra_Rate" + "FRI_RATE_EXTRA")
                                                        WHEN DAY1='Sat' THEN (("Week_Day_Rate" + "SAT_RATE") + (("Week_Day_Rate" + "SAT_RATE")* PERC/100))  || '$' || ("Week_Extra_Rate" + "SAT_RATE_EXTRA")
                                                    END
                                                        INTO FINALRATE
                                                FROM RATE_DETAILS WHERE "ratemastid"=FRATEUNIQUEID AND LTRIM(RTRIM("edition_name"))=LTRIM(RTRIM(EDITIONNAME)) AND ("PKGNAME"=LTRIM(RTRIM(PKGALIAS)) OR "PKGNAME" IS NULL);
                                                EXCEPTION
                                                WHEN NO_DATA_FOUND THEN  NULL;
                                               END;
                                    END IF;

                                END IF;
                                begin
                                SELECT "Solus_week_rate" INTO SOLORATEWEEK FROM RATE_DETAILS WHERE "ratemastid"=FRATEUNIQUEID AND LTRIM(RTRIM("edition_name"))=LTRIM(RTRIM(EDITIONNAME)) AND ("PKGNAME"=LTRIM(RTRIM(PKGALIAS)) OR "PKGNAME" IS NULL);
                                  EXCEPTION
                                                WHEN NO_DATA_FOUND THEN  NULL;
                                               END;
                         SELECT SUBSTR(FINALRATE,1,INSTR(FINALRATE,'$')-1) INTO CARD_RATE FROM DUAL;
                         SELECT SUBSTR(FINALRATE,INSTR(FINALRATE,'$')+1) INTO EXTRA_RATE FROM DUAL;
                         FEXTRA_RATE:=0;
                         FCARD_RATE:=0;
                                IF EXTRA_RATE IS NULL THEN
                                    EXTRA_RATE:=CARD_RATE;
                                END IF;
                         --IF uomdesc != 'CD' THEN
                            IF SOLORATEWEEK IS NULL OR SOLORATEWEEK='0' THEN
                             DBMS_OUTPUT.PUT_LINE('SOLORATEWEEK...'||SOLORATEWEEK);
                                select "Comp_code","combin_desc","Adv_Cat_Code","Adv_subcat_code","Rate_Gr_Code","Valid_From","Valid_To"
                                into compcode_M,combindesc_M,advcatcode_M ,advsubcatcode_M,rategroupcode_M,validfrom_M,validto_M
                                from rate_mast where "rateuniqueid"=FRATEUNIQUEID;
                                DBMS_OUTPUT.PUT_LINE('compcode_M...'||compcode_M);
                                DBMS_OUTPUT.PUT_LINE('combindesc_M...'||combindesc_M);
                                DBMS_OUTPUT.PUT_LINE('advcatcode_M...'||advcatcode_M);
                                DBMS_OUTPUT.PUT_LINE('advsubcatcode_M...'||advsubcatcode_M);
                                DBMS_OUTPUT.PUT_LINE('rategroupcode_M...'||rategroupcode_M);
                                DBMS_OUTPUT.PUT_LINE('validfrom_M...'||validfrom_M);
                                DBMS_OUTPUT.PUT_LINE('validto_M...'||validto_M);
                                DBMS_OUTPUT.PUT_LINE('EDITIONNAME_M...'||EDITIONNAME);
                               BEGIN
                                select "Week_Day_Rate","Week_Extra_Rate" into weekdayrate_M,weekextrarate_M from rate_mast
                                where "Comp_code"=compcode_M AND "combin_desc"=EDITIONNAME  AND "Adv_Type_Code"=Adtype AND "Adv_Cat_Code"=advcatcode_M
                                AND "Adv_subcat_code"=advsubcatcode_M AND "Currency"=currency
                                AND "Rate_Gr_Code"=rategroupcode_M and "Color"=Col and "Premium"=premiumval
                                AND "Uom"=uom and "Valid_From"=validfrom_M and "Valid_To"=validto_M AND INSERTIONNUM BETWEEN "From_insertion" AND "To_insertion";-- and "Combin_Code"=  PKGCODE;
                                EXCEPTION
                                                WHEN NO_DATA_FOUND THEN  NULL;
                                               END;
                                IF weekdayrate_M IS NULL OR weekdayrate_M = '0' THEN
                                    SOLORATEWEEK:=weekextrarate_M;
                                ELSE
                                    SOLORATEWEEK:=weekdayrate_M;   
                                END IF;
                                DBMS_OUTPUT.PUT_LINE('SOLORATEWEEK...'||SOLORATEWEEK);
                            END IF;
                             IF TO_NUMBER(LINE)>TO_NUMBER(RLINE) THEN
                                DBMS_OUTPUT.PUT_LINE('LINES...'||LINE);
                                DBMS_OUTPUT.PUT_LINE('RLINE...'||RLINE);
                                DBMS_OUTPUT.PUT_LINE('MIN_SIZE...'||MIN_SIZE);
                                IF rateflag='Y' THEN
                                   
                                    IF uomdesc = 'CD' THEN
                                        IF(TO_NUMBER(LINE)>TO_NUMBER(MIN_SIZE)) THEN
                                            EXTRALINE:=MIN_SIZE-RLINE;
                                          --  CARD_RATE:= CARD_RATE * EXTRALINE;
                                            FEXTRA_RATE:=EXTRA_RATE * EXTRALINE;
                                            FCARD_RATE:= CARD_RATE + FEXTRA_RATE; 
                                            DIFFSIZE:=TO_NUMBER(LINE) - TO_NUMBER(MIN_SIZE);
                                            FEXTRA_RATE:=EXTRA_RATE + (SOLORATEWEEK * DIFFSIZE);
                                            FCARD_RATE:= FCARD_RATE + (SOLORATEWEEK * DIFFSIZE);
                                        else
                                             EXTRALINE:=LINE-RLINE;
                                            -- CARD_RATE:= CARD_RATE * EXTRALINE;
                                             FEXTRA_RATE:=EXTRA_RATE * EXTRALINE;
                                             FCARD_RATE:= CARD_RATE + FEXTRA_RATE;   
                                        END IF;
                                    else
                                         EXTRALINE:=LINE-RLINE;
                                      --   CARD_RATE:= CARD_RATE * EXTRALINE;
                                         FEXTRA_RATE:=EXTRA_RATE * EXTRALINE;
                                         FCARD_RATE:= CARD_RATE + FEXTRA_RATE;   
                                    END IF;
                                ELSE
                                     EXTRALINE:=LINE-RLINE;
                                   --  CARD_RATE:= CARD_RATE * EXTRALINE;
                                     FEXTRA_RATE:=EXTRA_RATE * EXTRALINE;
                                     FCARD_RATE:= CARD_RATE + FEXTRA_RATE;   
                                END IF;   
                             ELSE
                                FCARD_RATE:= CARD_RATE;
                                FEXTRA_RATE:=EXTRA_RATE;
                             
                             END IF;
                        -- END IF;
                           IF specialsize is not null and specialsizerate is not null then
                            FCARD_RATE:=TO_NUMBER(FCARD_RATE) + (TO_NUMBER(specialsize) * TO_NUMBER(specialsizerate));
                        end if;
                        IF PREM IS NOT NULL AND PREM !='0' THEN
                             FCARD_RATE:=TO_NUMBER(FCARD_RATE) + (TO_NUMBER(FCARD_RATE) * TO_NUMBER(Getpospremium(PREM,compcode))/100);
                        END IF;
                        IF PAGEPREMNO IS NOT NULL AND PAGEPREMNO !='0' THEN
                            FCARD_RATE:=TO_NUMBER(FCARD_RATE) + (TO_NUMBER(FCARD_RATE) * TO_NUMBER(Getpagepremium(PAGEPREMNO,compcode))/100);
                        END IF;
                         ---- FOR FIX SIZE
                          DBMS_OUTPUT.PUT_LINE('FIX SIZE');
                        IF AdType='DI0' THEN
                             DBMS_OUTPUT.PUT_LINE('FIX SIZE12');
                            SELECT "Size_From" INTO SIZEFROM_FIX FROM RATE_MAST WHERE "rateuniqueid"=FRATEUNIQUEID;
                            DBMS_OUTPUT.PUT_LINE(SIZEFROM_FIX);
                            IF SIZEFROM_FIX IS NOT NULL AND SIZEFROM_FIX!='0' THEN
                            DBMS_OUTPUT.PUT_LINE('SIZEFROM_FIX');
                                CARD_RATE:=TO_NUMBER(CARD_RATE)/TO_NUMBER(SIZEFROM_FIX);
                                DBMS_OUTPUT.PUT_LINE(CARD_RATE);
                                EXTRA_RATE:=TO_NUMBER(EXTRA_RATE)/TO_NUMBER(SIZEFROM_FIX);
                            END IF;
                        END IF;
                        ----
                        INSERT INTO FINALRATE(PCODE,EDITION_NAME,RATEID,CARDRATE,EXTRARATE,FCARDRATE,FEXTRARATE,ADVCAT1,ADVCAT2,ADVCAT3,ADVCAT4,ADVCAT5,LINES,PKG_ALIAS,SOLORATE) VALUES(PKGCODE,EDITIONNAME,FRATEUNIQUEID,CARD_RATE,EXTRA_RATE,FCARD_RATE,FEXTRA_RATE,ADCAT1,ADCAT2,ADCAT3,ADCAT4,ADCAT5,LINE,PKGALIAS,SOLORATEWEEK);
                        IF schemetype = '1' THEN
                            INSERT INTO SCHEME_TEMP SELECT "From_Insertion_No","To_Insertion_No", "Discount", "Discount_Type", PKGCODE,"Scheme_Name","Scheme_Code","scheme_id" FROM SCHEME_MASTER WHERE "Scheme_Code" =(SELECT "Scheme_Code" FROM SCHEME_MASTER WHERE "scheme_id"=(SELECT "Scheme_Name" FROM RATE_MAST WHERE "rateuniqueid"=FRATEUNIQUEID) AND ROWNUM<=1) AND "From_Insertion_No"<=INSERTIONNUM AND "To_Insertion_No"<=INSERTIONNUM;
                        ELSE
                            INSERT INTO SCHEME_TEMP SELECT "From_Insertion_No","To_Insertion_No", "Discount", "Discount_Type", PKGCODE,"Scheme_Name","Scheme_Code","scheme_id" FROM SCHEME_MASTER WHERE "Scheme_Code" =(SELECT "Scheme_Code" FROM SCHEME_MASTER WHERE "scheme_id"=(SELECT "Scheme_Name" FROM RATE_MAST WHERE "rateuniqueid"=FRATEUNIQUEID) AND ROWNUM<=1) AND INSERTIONNUM ="To_Insertion_No";--BETWEEN "From_Insertion_No" AND "To_Insertion_No";
                        END IF;
                    END IF;
                 COUNTRATE:=NULL;
                 FINALRATE:=NULL;

             END LOOP;
        END ;
        COUNTRATE:=NULL;
        RATEUNIQUEID:=NULL;
        FRATEUNIQUEID:=NULL;
        PKGCODE:=NULL;
        EDITIONNAME:=NULL;
        BDATE:=NULL;
        PERC:=NULL;
        COLREFER:=NULL;
        LINE:=NULL;
        ADCAT1:=NULL;
        ADCAT2:=NULL;
        ADCAT3:=NULL;
        ADCAT4:=NULL;
        ADCAT5:=NULL;
        CARD_RATE:=NULL;
        EXTRA_RATE:=NULL;
        FCARD_RATE:=NULL;
        FEXTRA_RATE:=NULL;
      
       SELECT COUNT(*) INTO COUNTRATE FROM ADONS_DETAILS WHERE "rateuniqueid" IN (SELECT RATEID FROM FINALRATE);
       SELECT COUNT(*) INTO COUNTADON FROM ADONS_DETAILS WHERE "rateuniqueid" IN (SELECT RATEID FROM FINALRATE) AND "Edition_Name" IN(SELECT EDITION_NAME FROM FINALRATE);

      
       IF COUNTRATE!=COUNTADON THEN
             
        BEGIN
         SELECT "Edition_Name",NVL(NO_OF_INSERT,0) INTO COUNTADONEDITION,COUNTADONINSERT FROM ADONS_DETAILS WHERE "rateuniqueid" IN (SELECT RATEID FROM FINALRATE) AND "Edition_Name" NOT IN(SELECT EDITION_NAME FROM FINALRATE) AND ROWNUM<=1;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN  NULL;
        END;
        DBMS_OUTPUT.PUT_LINE('COUNTADON');
        DBMS_OUTPUT.PUT_LINE(COUNTADONINSERT);
         IF COUNTADONINSERT IS NOT NULL AND COUNTADONINSERT!=0 AND counter<=COUNTADONINSERT THEN
         INSERT INTO ERRORMESSAGE(MESSAGE) VALUES('Please Take '|| COUNTADONEDITION || ' as Ad-Ons');
         COMMIT;
         GOTO L;
         END IF;     
       END IF; 
       
       
       IF COUNTRATE IS NOT NULL THEN
        DECLARE CURSOR R2_CURSOR
        IS
                SELECT DISTINCT "rateuniqueid" FROM ADONS_DETAILS WHERE "rateuniqueid" IN (SELECT RATEID FROM FINALRATE) AND "Edition_Name" IN(SELECT EDITION_NAME FROM FINALRATE);
        BEGIN
           OPEN R2_CURSOR;

             LOOP
                FETCH R2_CURSOR
                 INTO FRATEUNIQUEID;
                   EXIT WHEN R2_CURSOR%NOTFOUND;
                        SELECT  ADVCAT1, ADVCAT2, ADVCAT3, ADVCAT4, ADVCAT5 INTO ADCAT1, ADCAT2, ADCAT3, ADCAT4, ADCAT5 FROM FINALRATE WHERE "RATEID" = FRATEUNIQUEID AND ROWNUM<=1;

                        SELECT COUNT(*) INTO COUNTRATE1 FROM FINALRATE WHERE RATEID != FRATEUNIQUEID AND ADVCAT1 = ADCAT1 AND ADVCAT2 = ADCAT2 AND ADVCAT3 = ADCAT3 AND ADVCAT4 = ADCAT4 AND ADVCAT5 = ADCAT5 AND EDITION_NAME IN(SELECT "Edition_Name" FROM ADONS_DETAILS WHERE "rateuniqueid"=FRATEUNIQUEID);
                          DBMS_OUTPUT.PUT_LINE('LATA MADAN');
                          DBMS_OUTPUT.PUT_LINE(COUNTRATE1);
                         
                      IF COUNTRATE1 IS NOT NULL THEN

                         DECLARE CURSOR R3_CURSOR
                            IS
                                    SELECT RATEID,EDITION_NAME,LINES FROM FINALRATE WHERE RATEID != FRATEUNIQUEID AND ADVCAT1 = ADCAT1 AND ADVCAT2 = ADCAT2 AND ADVCAT3 = ADCAT3 AND ADVCAT4 = ADCAT4 AND ADVCAT5 = ADCAT5 AND EDITION_NAME IN(SELECT "Edition_Name" FROM ADONS_DETAILS WHERE "rateuniqueid"=FRATEUNIQUEID);
                            BEGIN
                               OPEN R3_CURSOR;

                                     LOOP
                                        FETCH R3_CURSOR
                                         INTO ARATEUNIQUEID, AEDITIONNAME, LINE;
                                           EXIT WHEN R3_CURSOR%NOTFOUND;
                                           BEGIN
                                           DBMS_OUTPUT.PUT_LINE('TEST-*'||ARATEUNIQUEID);
                                            SELECT "Rate","EXTRARATE" INTO CARD_RATE, EXTRA_RATE FROM ADONS_DETAILS WHERE "rateuniqueid"=FRATEUNIQUEID AND "Edition_Name"=AEDITIONNAME;

                                                    IF CARD_RATE IS NOT NULL THEN
                                                      SELECT "Size_To" INTO RLINE FROM RATE_MAST WHERE "rateuniqueid"=ARATEUNIQUEID;
                                                       DBMS_OUTPUT.PUT_LINE('LINE*-'||LINE);
                                                       DBMS_OUTPUT.PUT_LINE('RLINE*-'||RLINE);
                                                         IF LINE>RLINE THEN
                                                            EXTRALINE:=LINE-RLINE;
                                                            FEXTRA_RATE:=EXTRA_RATE * EXTRALINE;
                                                            FCARD_RATE:= CARD_RATE + FEXTRA_RATE;
                                                         ELSE
                                                            FCARD_RATE:= CARD_RATE;
                                                            FEXTRA_RATE:=EXTRA_RATE;
                                                         END IF;
                                                    END IF;
                                                EXCEPTION
                                                WHEN NO_DATA_FOUND THEN  NULL;
                                                END;
                                                 DBMS_OUTPUT.PUT_LINE('AEDITIONNAME-*'||AEDITIONNAME);
                                         UPDATE FINALRATE SET CARDRATE=CARD_RATE , EXTRARATE=EXTRA_RATE, FCARDRATE = FCARD_RATE , FEXTRARATE=FEXTRA_RATE WHERE RATEID=ARATEUNIQUEID AND EDITION_NAME=AEDITIONNAME;
                                             CARD_RATE:=NULL;
                                             EXTRA_RATE:=NULL;
                                             FCARD_RATE:=NULL;
                                             FEXTRA_RATE:=NULL;
                                     END LOOP;
                             END;
                      END IF;
             END LOOP;
        END;

       END IF;
       COMMIT;
        <<L>>
            OPEN p_accounts FOR
                SELECT * FROM ERRORMESSAGE;
            OPEN p_accounts1 FOR
                SELECT PCODE, EDITION_NAME, RATEID, CARDRATE, EXTRARATE, FCARDRATE, FEXTRARATE,PKG_ALIAS,SOLORATE,(SELECT "Pub_Code" from  EDITION_MAST WHERE "Edition_Alias"=EDITION_NAME) as PUBCODE,(SELECT "Size_To" FROM RATE_MAST where "rateuniqueid"=RATEID) AS MINWORD,
                (SELECT NVL(VAT_DETAIL,'0') FROM RATE_MAST WHERE "rateuniqueid"=RATEID) as  VAT_INC
                FROM FINALRATE ORDER BY PCODE;
               
            IF COUNTSCHEMEEDITION IS NOT NULL AND COUNTSCHEMEEDITION!=0 THEN
                OPEN p_accounts2 FOR                
                SELECT DISTINCT "From_Insertion_No" AS "FROM_INSERT","To_Insertion_No" AS "TO_INS","Discount" AS "AMT","Discount_Type" AS "TYPE",EDITION_NAME AS "PKG_CODE","Scheme_Name" AS "SCHEMENAME","Scheme_Code" AS "SCHEMECODE","scheme_id" AS "SCHEMEID",'T' AS "VAL" FROM SCHEME_MASTER , SCHEME_MASTER_EDITION WHERE SCHEME_MASTER_EDITION.SCHEMECODE=SCHEME_MASTER."Scheme_Code" ORDER BY EDITION_NAME ;
            ELSE
                OPEN p_accounts2 FOR
                SELECT distinct A.*,'P' AS "VAL" FROM SCHEME_TEMP A ORDER BY PKG_CODE;
            END IF;     
            dbg('agencycode:'||agencycode||'/'||uomcode);
        select count(*) into comm_rec  FROM COMM_DETAILS WHERE "Agency_code"||"Agency_sub_code"=UPPER(agencycode) AND UOM=uomcode AND ROWID=(SELECT MAX(ROWID) FROM COMM_DETAILS WHERE "Agency_code"||"Agency_sub_code"=UPPER(agencycode) and UOM=uomcode);
        if(comm_rec=0) THEN
          OPEN p_accounts3 FOR
              SELECT NVL("Comm_Rate",0) AS COMM_RATE , NVL("Addl_Comm_Rate",0) AS ADD_COMM_RATE,nvl(ADDITIONAL_FLAG,'0') as FLAG,FLOORAMT AS FLOORAMT FROM COMM_DETAILS WHERE "Agency_code"||"Agency_sub_code"=UPPER(agencycode) AND NVL(UOM,'!!') !=uomcode AND ROWID=(SELECT MAX(ROWID) FROM COMM_DETAILS WHERE "Agency_code"||"Agency_sub_code"=UPPER(agencycode) AND NVL(UOM,'!!')!=uomcode);
          
        else
           OPEN p_accounts3 FOR
            SELECT NVL("Comm_Rate",0) AS COMM_RATE , NVL("Addl_Comm_Rate",0) AS ADD_COMM_RATE,nvl(ADDITIONAL_FLAG,'0') as FLAG,FLOORAMT AS FLOORAMT FROM COMM_DETAILS WHERE "Agency_code"||"Agency_sub_code"=UPPER(agencycode) AND UOM=uomcode AND ROWID=(SELECT MAX(ROWID) FROM COMM_DETAILS WHERE "Agency_code"||"Agency_sub_code"=UPPER(agencycode) and UOM=uomcode);
          
         END IF;
commit;         
         END rate_qbc_p;
END Rate_Qbc;
/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

CREATE OR REPLACE PACKAGE filcur
 is
Type T_Accounts_Cursor is Ref Cursor;

procedure    filcur_p(userid in varchar2,
compcode in varchar2,p_Accounts out T_Accounts_Cursor);

end  filcur;
/

CREATE OR REPLACE PACKAGE BODY filcur
IS
   PROCEDURE filcur_p (
      userid       IN       VARCHAR2,
      compcode     IN       VARCHAR2,
      p_accounts   OUT      t_accounts_cursor
   )
   AS
   BEGIN
      OPEN p_accounts FOR
         SELECT "Curr_Alias", "Curr_Code", "Curr_Name"
           FROM curr_mast
          WHERE "Comp_Code" = compcode;-- AND "UserId" = userid;
   END filcur_p;
END filcur;
/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@6450 end@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@



/*********************************** issue 6339************************/

CREATE OR REPLACE PACKAGE chkdateconrate
is
Type T_Account_cursor is Ref cursor;
procedure  chkdateconrate_p (compcode in varchar2,
userid in varchar2,
txtconrate in varchar2,
txtfromdate in varchar2,
txtefftill in varchar2,
currcode in varchar2,
pcurrency in varchar2,
P_ACCOUNTS out T_Account_cursor);
end   chkdateconrate ;
/





CREATE OR REPLACE PACKAGE BODY chkdateconrate
is

procedure  chkdateconrate_p (compcode in varchar2,
userid in varchar2,
txtconrate in varchar2,
txtfromdate in varchar2,
txtefftill in varchar2,
currcode in varchar2,
pcurrency in varchar2,
P_ACCOUNTS out T_Account_cursor) as

begin
open  P_ACCOUNTS for
select to_char("Valid_From_Date",'mm-dd-yyyy') as "Valid_From_Date",to_char("Valid_Till_Date",'mm-dd-yyyy') as "Valid_Till_Date" from CURR_CONV_DET where "CONV_CURRENCY"=pcurrency and "Curr_Code"=currcode  and ( txtfromdate = "Valid_From_Date"  or  txtefftill="Valid_Till_Date"  or  txtfromdate between  "Valid_From_Date" and "Valid_Till_Date"   or  txtefftill between  "Valid_From_Date" and "Valid_Till_Date" or "Valid_Till_Date"  between txtfromdate and txtefftill  or "Valid_From_Date"  between txtfromdate and txtefftill  ) ;

end   chkdateconrate_p ;
end   chkdateconrate ;
/



CREATE OR REPLACE PACKAGE insertconvertrate is
procedure   insertconvertrate_p(compcode in varchar2,
  userid in varchar2,
  txtconrate in varchar2,
  txtfromdate in date,
  txtefftill in date,
  currcode in varchar2,
  currency in varchar2,
  txtunit in varchar2
);
end  insertconvertrate;
/






CREATE OR REPLACE PACKAGE BODY insertconvertrate is
procedure   insertconvertrate_p(compcode in varchar2,
  userid in varchar2,
  txtconrate in varchar2,
  txtfromdate in date,
  txtefftill in date,
  currcode in varchar2,
  currency in varchar2,
  txtunit in varchar2)as
begin

insert into CURR_CONV_DET("Convert_code", "Conv_Rate","Valid_From_Date","Valid_Till_Date","UserId","Comp_code","Curr_Code","Creation_Datetime",CONV_CURRENCY,UNIT )values(CONVERT_CODE.nextval,txtconrate,txtfromdate,txtefftill,userid,compcode,currcode,sysdate,currency,txtunit);
commit;
end   insertconvertrate_p;
end   insertconvertrate;
/
/*****************end****************** issue 6339************************/

/*********************************** issue 6339************************/


CREATE OR REPLACE PACKAGE bindcurrmast Is
Type T_Accounts_Cursor Is Ref Cursor;
Procedure  bindcurrmast_P(
code in varchar2,
compcode in varchar2,
userid in varchar2,
date1 in varchar2,
P_Accounts Out T_Accounts_Cursor);
End bindcurrmast ;
/




CREATE OR REPLACE PACKAGE BODY bindcurrmast Is
Procedure  bindcurrmast_P(
code in varchar2,
compcode in varchar2,
userid in varchar2,
date1 in varchar2,
P_Accounts Out T_Accounts_Cursor)as
begin
if(date1='mm/dd/yyyy') then
open P_Accounts for
select "Convert_code","Conv_Rate",to_char("Valid_From_Date",'mm/dd/yyyy') as "Valid_From_Date",to_char("Valid_Till_Date",'mm/dd/yyyy') as "Valid_Till_Date",CONV_CURRENCY,UNIT from CURR_CONV_DET where "Curr_Code"=code and "Comp_code"=compcode;-- and "UserId"=userid;
end if;

if(date1='dd/mm/yyyy') then
open P_Accounts for
select "Convert_code","Conv_Rate",to_char("Valid_From_Date",'dd/mm/yyyy') as "Valid_From_Date",to_char("Valid_Till_Date",'dd/mm/yyyy') as "Valid_Till_Date",CONV_CURRENCY,UNIT from CURR_CONV_DET where "Curr_Code"=code and "Comp_code"=compcode;-- and "UserId"=userid;
end if;

if(date1='yyyy/mm/dd') then
open P_Accounts for
select "Convert_code","Conv_Rate",to_char("Valid_From_Date",'yyyy/mm/dd') as "Valid_From_Date",to_char("Valid_Till_Date",'yyyy/mm/dd') as "Valid_Till_Date",CONV_CURRENCY,UNIT from CURR_CONV_DET where "Curr_Code"=code and "Comp_code"=compcode;-- and "UserId"=userid;
end if;

if(date1=null) then
open P_Accounts for
select "Convert_code","Conv_Rate",to_char("Valid_From_Date",'mm/dd/yyyy') as "Valid_From_Date",to_char("Valid_Till_Date",'mm/dd/yyyy') as "Valid_Till_Date",CONV_CURRENCY,UNIT from CURR_CONV_DET where "Curr_Code"=code and "Comp_code"=compcode;-- and "UserId"=userid;
end if;
end bindcurrmast_P;
End bindcurrmast ;
/




CREATE OR REPLACE PACKAGE selectfromcurrmast is
type T_ACCOUNT_CURSOR is ref cursor;
procedure   selectfromcurrmast_p(compcode in varchar2,
 userid in varchar2,
 currcode in varchar2,
 code10 in varchar2,P_ACCOUNT out T_ACCOUNT_CURSOR
);
end  selectfromcurrmast;
/





CREATE OR REPLACE PACKAGE BODY selectfromcurrmast is
procedure   selectfromcurrmast_p(compcode in varchar2,
 userid in varchar2,
 currcode in varchar2,
 code10 in varchar2,P_ACCOUNT out T_ACCOUNT_CURSOR)as
begin
open P_ACCOUNT for
select "Conv_Rate","Valid_From_Date","Valid_Till_Date",CONV_CURRENCY,UNIT from CURR_CONV_DET where "Comp_code"=compcode  and "Curr_Code"=currcode and "Convert_code"=code10;--and "UserId"=userid 

end   selectfromcurrmast_p;
end  selectfromcurrmast;
/




CREATE OR REPLACE PACKAGE updateconvertrate is

procedure  updateconvertrate_p(compcode in varchar2,
 userid in varchar2,
 txtconrate in varchar2,
 txtfromdate in date,
 txtefftill in date,
 currcode in varchar2,
 code10 in varchar2,
currency in varchar2,
txtunit in varchar2
);
end  updateconvertrate;
/





CREATE OR REPLACE PACKAGE BODY updateconvertrate is
procedure   updateconvertrate_p(compcode in varchar2,
 userid in varchar2,
 txtconrate in varchar2,
 txtfromdate in date,
 txtefftill in date,
 currcode in varchar2,
 code10 in varchar2,
 currency in varchar2,
 txtunit in varchar2)as
begin

update  CURR_CONV_DET set "Valid_From_Date"=txtfromdate,"Valid_Till_Date"=txtefftill,"Conv_Rate"=txtconrate,CONV_CURRENCY=currency,UNIT=txtunit where "Comp_code"=compcode /*and "UserId"=userid */ and "Curr_Code"=currcode and "Convert_code"=code10;
commit;
end   updateconvertrate_p;
end  updateconvertrate;
/




CREATE OR REPLACE PACKAGE chkdateupdate
is
Type T_Account_cursor is Ref cursor;
procedure chkdateupdate_p (compcode in varchar2,
userid in varchar2,
txtconrate in varchar2,
txtfromdate in varchar2,
txtefftill in varchar2,
currcode in varchar2,
code10 in varchar2,
pcurrency in varchar2,
P_ACCOUNTS out T_Account_cursor);
end  chkdateupdate ;
/






CREATE OR REPLACE PACKAGE BODY chkdateupdate
is

procedure chkdateupdate_p (compcode in varchar2,
userid in varchar2,
txtconrate in varchar2,
txtfromdate in varchar2,
txtefftill in varchar2,
currcode in varchar2,
code10 in varchar2,
pcurrency in varchar2,
P_ACCOUNTS out T_Account_cursor) as

begin
open  P_ACCOUNTS for
select to_char("Valid_From_Date",'mm-dd-yyyy') as "Valid_From_Date",to_char("Valid_Till_Date",'mm-dd-yyyy') as "Valid_Till_Date" from CURR_CONV_DET where "CONV_CURRENCY"=pcurrency and "Curr_Code"=currcode  and ( txtfromdate between  "Valid_From_Date" and "Valid_Till_Date"   or  txtefftill between  "Valid_From_Date" and "Valid_Till_Date" or "Valid_Till_Date"  between txtfromdate and txtefftill or "Valid_From_Date"  between txtfromdate and txtefftill ) and   "Convert_code"  <> code10;

end  chkdateupdate_p ;
end  chkdateupdate ;
/
/*****************end****************** issue 6339************************/
/**************mimoh*****Issue No. 0006211*********************/


CREATE OR REPLACE PROCEDURE cheackdeal
(
 compcode in varchar2,
 dealno in varchar2,
 P_Accounts OUT Cur_Type_New1.cursor_type
)
IS
BEGIN
    OPEN P_Accounts FOR
    SELECT AUDITBY, AUDIT_COMMENT FROM  CONTRACT_MAST WHERE "Comp_code"= compcode and "Deal_No"=dealno and AUDITBY is not null;
        
END;
/

/*********************************************************/


/******************************************/


CREATE OR REPLACE procedure BINDDEALforf2
(p_compcode in VARCHAR2,
p_dealname in  VARCHAR2,
P_Accounts OUT CUR_TYPE_NEW1.CURSOR_TYPE)
AS
BEGIN
OPEN P_Accounts FOR
SELECT DISTINCT "Deal_No", "deal_name"
                 FROM contract_mast  where  "Comp_code"=p_compcode 
                 AND ("deal_name" LIKE p_dealname || '%' OR p_dealname IS NULL) ;

END;
/

/*************************/


CREATE OR REPLACE PACKAGE insertcontactmast
IS
   PROCEDURE insertcontactmast_p (
      compcode         IN   VARCHAR2,
      userid           IN   VARCHAR2,
      dealno           IN   VARCHAR2,
      dealname         IN   VARCHAR2,
      agencycode       IN   VARCHAR2,
      subagencycode    IN   VARCHAR2,
      product          IN   VARCHAR2,
      validfromdate    IN   DATE,
      validtill        IN   DATE,
      representative   IN   VARCHAR2,
      clientname       IN   VARCHAR2,
      totalvalue       IN   NUMBER,
      totalvolume      IN   NUMBER,
      currencys        IN   VARCHAR2,
      teamname         IN   VARCHAR2,
      dealtype         IN   VARCHAR2,
      adtype1           IN   VARCHAR2,
      REMARK           IN  VARCHAR2,
      executive_var           IN  VARCHAR2,
        retainer_var           IN  VARCHAR2,
        contdate_var           IN  DATE,
        closedate_var           IN  DATE,
        servicetax_var           IN  VARCHAR2,
        caption_var           IN  VARCHAR2,
        paymode_var in varchar2,
        b2b_var in varchar2,
        chkmulti_var in varchar2,
        chkseq_var in varchar2,
        seqno_var in varchar2,
        chkparti_var in varchar2,
        indus_var in varchar2,
        induspro_var in varchar2,
        dealon_var in varchar2,
        attachment1 in varchar2,
        dealfrom in varchar2,
        dealcenter in varchar2,
        translation in varchar2
   );
END insertcontactmast;
/





CREATE OR REPLACE PACKAGE BODY insertcontactmast
IS
   PROCEDURE insertcontactmast_p (
        compcode         IN   VARCHAR2,
        userid           IN   VARCHAR2,
        dealno           IN   VARCHAR2,
        dealname         IN   VARCHAR2,
        agencycode       IN   VARCHAR2,
        subagencycode    IN   VARCHAR2,
        product          IN   VARCHAR2,
        validfromdate    IN   DATE,
        validtill        IN   DATE,
        representative   IN   VARCHAR2,
        clientname       IN   VARCHAR2,
        totalvalue       IN   NUMBER,
        totalvolume      IN   NUMBER,
        currencys        IN   VARCHAR2,
        teamname         IN   VARCHAR2,
        dealtype         IN   VARCHAR2,
        adtype1           IN   VARCHAR2,
        REMARK           IN  VARCHAR2,
        executive_var           IN  VARCHAR2,
        retainer_var           IN  VARCHAR2,
        contdate_var           IN  DATE,
        closedate_var           IN  DATE,
        servicetax_var           IN  VARCHAR2,
        caption_var           IN  VARCHAR2,
        paymode_var in varchar2,
         b2b_var in varchar2,
        chkmulti_var in varchar2,
        chkseq_var in varchar2,
        seqno_var in varchar2,
        chkparti_var in varchar2,
        indus_var in varchar2,
        induspro_var in varchar2,
        dealon_var in varchar2,
        attachment1 in varchar2,
        dealfrom in varchar2,
        dealcenter in varchar2,
        translation in varchar2
        )
   AS
   BEGIN
      INSERT INTO contract_mast
                  ("Deal_No", "Comp_code", "Agency_code", "Sub_Agency_Code",
                   "Client_code", "Product_code", "From_date", "Till_date",
                   "representative", "Userid", "Total_val", "Total_volu",
                   "curr_code", "team_code", "deal_type", "deal_name",
                   "Ad_type","Creation_datetime","REMARKS",EXECUTIVE, RETAINER, CONTRACTDATE, CLOSEDATE, SERVICETAX, PAYMENTTYPE, CAPTION, B2B, CHKMULTIAD, SEQNO_ALLOW, SEQNO, AFT_PRTCLR_AD, INDUSTRY, INDUSTRY_PRODUCT, DEALON,ATTACHMENT
                  ,DEAL_FROM, DEAL_CENTER, TRANSLATION_CHARGES)
           VALUES (dealno, compcode, agencycode, subagencycode,
                   clientname, product, validfromdate, validtill,
                   representative, userid, totalvalue, totalvolume,
                   currencys, teamname, dealtype, dealname,
                   adtype1,sysdate,REMARK,executive_var,retainer_var,contdate_var,closedate_var,servicetax_var,paymode_var,caption_var,
                   b2b_var,chkmulti_var,chkseq_var,seqno_var,chkparti_var,indus_var,induspro_var,dealon_var,attachment1
                  ,dealfrom,dealcenter,translation);

      COMMIT;
   END insertcontactmast_p;
END insertcontactmast;
/

/************************************************************************************/


CREATE OR REPLACE PACKAGE updatecontactmast
IS
   PROCEDURE updatecontactmast_p (
      compcode         IN   VARCHAR2,
      userid           IN   VARCHAR2,
      dealno           IN   VARCHAR2,
      dealname         IN   VARCHAR2,
      agencycode       IN   VARCHAR2,
      subagencycode    IN   VARCHAR2,
      product          IN   VARCHAR2,
      validfromdate    IN   DATE,
      validtill        IN   DATE,
      representative   IN   VARCHAR2,
      clientname       IN   VARCHAR2,
      totalvalue       IN   NUMBER,
      totalvolume      IN   NUMBER,
      currencys        IN   VARCHAR2,
      teamname         IN   VARCHAR2,
      dealtype         IN   VARCHAR2,
      adtype           IN   VARCHAR2,
       REMARK           IN  VARCHAR2,
      executive_var           IN  VARCHAR2,
        retainer_var           IN  VARCHAR2,
        contdate_var           IN  DATE,
        closedate_var           IN  DATE,
        servicetax_var           IN  VARCHAR2,
        caption_var           IN  VARCHAR2,
        paymode_var in varchar2,
         b2b_var in varchar2,
        chkmulti_var in varchar2,
        chkseq_var in varchar2,
        seqno_var in varchar2,
        chkparti_var in varchar2,
        indus_var in varchar2,
        induspro_var in varchar2,
        dealon_var in varchar2,
        attachment1 in varchar2,
        dealfrom in varchar2,
        dealcenter in varchar2,
        translation in varchar2
   );
END updatecontactmast;
/




CREATE OR REPLACE PACKAGE BODY updatecontactmast
IS
   PROCEDURE updatecontactmast_p (
      compcode         IN   VARCHAR2,
      userid           IN   VARCHAR2,
      dealno           IN   VARCHAR2,
      dealname         IN   VARCHAR2,
      agencycode       IN   VARCHAR2,
      subagencycode    IN   VARCHAR2,
      product          IN   VARCHAR2,
      validfromdate    IN   DATE,
      validtill        IN   DATE,
      representative   IN   VARCHAR2,
      clientname       IN   VARCHAR2,
      totalvalue       IN   NUMBER,
      totalvolume      IN   NUMBER,
      currencys        IN   VARCHAR2,
      teamname         IN   VARCHAR2,
      dealtype         IN   VARCHAR2,
      adtype           IN   VARCHAR2,
       REMARK           IN  VARCHAR2,
      executive_var           IN  VARCHAR2,
        retainer_var           IN  VARCHAR2,
        contdate_var           IN  DATE,
        closedate_var           IN  DATE,
        servicetax_var           IN  VARCHAR2,
        caption_var           IN  VARCHAR2,
        paymode_var in varchar2,
         b2b_var in varchar2,
        chkmulti_var in varchar2,
        chkseq_var in varchar2,
        seqno_var in varchar2,
        chkparti_var in varchar2,
        indus_var in varchar2,
        induspro_var in varchar2,
         dealon_var in varchar2,
         attachment1 in varchar2,
        dealfrom in varchar2,
        dealcenter in varchar2,
        translation in varchar2
   )
   AS
   BEGIN
      UPDATE contract_mast
         SET "deal_name" = dealname,
             "Agency_code" = agencycode,
             "Sub_Agency_Code" = subagencycode,
             "Client_code" = clientname,
             "Product_code" = product,
             "From_date" = validfromdate,
             "Till_date" = validtill,
             "representative" = representative,
             "Total_val" = totalvalue,
             "Total_volu" = totalvolume,
             "curr_code" = currencys,
             "team_code" = teamname,
             "deal_type" = dealtype,
             "Ad_type" = adtype,
             "REMARKS"=REMARK,
             EXECUTIVE=executive_var,
              RETAINER=retainer_var,
              CONTRACTDATE=contdate_var,
              CLOSEDATE=closedate_var,
               SERVICETAX=servicetax_var,
               PAYMENTTYPE=paymode_var,
                CAPTION=caption_var,
                B2B=b2b_var, CHKMULTIAD=chkmulti_var, SEQNO_ALLOW=chkseq_var, SEQNO=seqno_var, AFT_PRTCLR_AD=chkparti_var, INDUSTRY=indus_var, INDUSTRY_PRODUCT=induspro_var,
                DEALON=dealon_var,
                ATTACHMENT=attachment1,
                DEAL_FROM=dealfrom,
                DEAL_CENTER=dealcenter,
                TRANSLATION_CHARGES=translation
       WHERE "Deal_No" = dealno AND "Comp_code" = compcode;

      COMMIT;
   END updatecontactmast_p;
END updatecontactmast;
/

/**************************************************************************************/


CREATE OR REPLACE PACKAGE executecontract IS
Type T_Accounts_Cursor is Ref Cursor;
PROCEDURE executecontract_P(
compcode in varchar2,
userid in varchar2,--
DealNo in varchar2,--
dealname in varchar2,--
agencycode in varchar2,--
subagencycode in varchar2,--
representative in varchar2,
dealtype in varchar2,
P_Accounts  OUT  T_Accounts_Cursor
);
end executecontract;
/





CREATE OR REPLACE PACKAGE BODY Executecontract
IS
  PROCEDURE executecontract_P(
  			compcode IN VARCHAR2,
			userid IN VARCHAR2,--
			DealNo IN VARCHAR2,--
			dealname IN VARCHAR2,--
			agencycode IN VARCHAR2,--
			subagencycode IN VARCHAR2,--
			Representative IN VARCHAR2,
			dealtype IN VARCHAR2,
			P_Accounts  OUT  T_Accounts_Cursor)
	AS
	BEGIN
		 OPEN P_Accounts FOR
		 SELECT  "Deal_No","Comp_code",(select "Agency_Name"||'('|| "Agency_Code" ||')' from agency_mast where "Agency_Code"="Agency_code" and agency_mast."SUB_Agency_Code"=contract_mast."Sub_Agency_Code") as "Agency_code","Sub_Agency_Code",(select "Cust_Name"||'('||"Cust_Code"||')' from cust_mast where "Cust_Code"="Client_code") as "Client_code","Product_code",TO_CHAR("From_date",'mm/dd/yyyy') as "From_date",TO_CHAR("Till_date",'mm/dd/yyyy') as "Till_date","representative","Userid","Total_val","Total_volu","team_code","deal_type","deal_name","contract_id","Ad_type",REMARKS,(select "Exec_name"||'('||"Exe_no"||')' from exec_mast where "Exe_no"=EXECUTIVE) as EXECUTIVE, (select "Retain_Name"||'(' || "Retain_Code" || ')' from  retainermaster where "Retain_Code"=RETAINER) as RETAINER, TO_CHAR(CONTRACTDATE,'mm/dd/yyyy') as CONTRACTDATE,TO_CHAR(CLOSEDATE,'mm/dd/yyyy') as  CLOSEDATE, SERVICETAX, PAYMENTTYPE, CAPTION, B2B, CHKMULTIAD, SEQNO_ALLOW, SEQNO, AFT_PRTCLR_AD, INDUSTRY, INDUSTRY_PRODUCT, DEALON,ATTACHMENT,ad_get_fieldname ('Comp_Code',
                                    compcode,
                                    'Pub_cent_Code',
                                    CONTRACT_MAST.DEAL_FROM,
                                    'Pub_Cent_name',
                                    'pub_cent_mast',
                                    '',
                                    ''
                                   ) AS DEAL_FROM, DEAL_CENTER, TRANSLATION_CHARGES
          FROM CONTRACT_MAST
		 WHERE ("Comp_code" = compcode OR compcode IS NULL)
		 AND ("Deal_No" LIKE DealNo || '%' OR DealNo IS NULL)
		 AND("deal_name"  LIKE dealname ||'%'OR dealname IS NULL)
		 AND("Agency_code" LIKE agencycode||'%'OR agencycode IS NULL)
		 AND("deal_type" LIKE dealtype||'%'OR dealtype IS NULL)
		 AND("Sub_Agency_Code" LIKE subagencycode||'%'OR subagencycode IS NULL)
		 AND("representative" LIKE Representative||'%'OR Representative IS NULL);

END executecontract_P;
END Executecontract;
/


/*******************************************************************************************/



CREATE OR REPLACE PROCEDURE bindadvposition
(
p_compcode  in varchar2,
p_name  in varchar2,
extra1  in varchar2,
extra2  in varchar2,
p_accounts   OUT   cur_type_new1.cursor_type
)
as
BEGIN
OPEN p_accounts FOR
SELECT "Pos_Type_Code" as POS_TYPE_CODE,"Pos_Type" as POS_TYPE FROM advpos_type_mast WHERE  "Comp_Code"=p_compcode and
("Pos_Type" LIKE p_name || '%' OR p_name IS NULL);

END;
/

/**************************************************************************************/


CREATE OR REPLACE PROCEDURE savecontract_detail
(
dealno_p in varchar2,
adtype_p in varchar2,
hue_p in varchar2,
uom_p in varchar2,
package_p in varchar2,
category_p in varchar2,
premium_p in varchar2,
cardprem_p in varchar2,
contractprem_p in varchar2,
contrate_p in varchar2,
cardrate_p in varchar2,
deviation_p in varchar2,
disctype_p in varchar2,
discper_p in varchar2,
discon_p in varchar2,
minsize_p in varchar2,
maxsize_p in varchar2,
valuefrom_p in varchar2,
valueto_p in varchar2,
day_p in varchar2,
insertion_p in varchar2,
commallow_p in varchar2,
dealstart_p in varchar2,
currency_p in varchar2,
ratecode_p in varchar2,
totalrate_p in varchar2,
incentive_p in varchar2,
remarks_p in varchar2,
approved_p in varchar2,
compcode_p in varchar2,
userid_p in varchar2,
id_p in varchar2,
positionprem in varchar2,
contractamount1 in varchar2

)
as
begin 
if id_p is null then
insert into contract_detail("ContractCode","deal_code",ADTYPE,"color","Uom","packagecode","Advcategory","premiumcode","cardpremium","dealpremium","Dealarte","cardrate","deviation","discounted",DISCTYPE,DISCPER,SIZEFROM,SIZETO,"valuefrom","valueto",DAYNAME,INSERTION,COMMITION_ALLOW,DEAL_START,"currency","Rate_code","convertrate",INCENTIVE,REMARKS,"approved","creation_datetime","comp_code","userid",POSITION_PREM,CONTRACT_AMOUNT)
values(ContractCode_ident.NEXTVAL,dealno_p,adtype_p,hue_p,uom_p,package_p,category_p,premium_p,cardprem_p,contractprem_p,contrate_p,cardrate_p,deviation_p,disctype_p,discon_p,discper_p,minsize_p,maxsize_p,valuefrom_p,valueto_p,day_p,insertion_p,commallow_p,dealstart_p,currency_p,ratecode_p,totalrate_p,incentive_p,remarks_p,approved_p,sysdate,compcode_p,userid_p,positionprem,contractamount1);

else
update  contract_detail set ADTYPE=adtype_p, "color"=hue_p,"Uom"=uom_p,"packagecode"=package_p,"Advcategory"=category_p,"premiumcode"=premium_p,"cardpremium"=cardprem_p,"dealpremium"=contractprem_p,"Dealarte"=contrate_p,"cardrate"=cardrate_p,"deviation"=deviation_p,"discounted"=disctype_p,DISCTYPE=discon_p,DISCPER=discper_p,SIZEFROM=minsize_p,SIZETO=maxsize_p,"valuefrom"=valuefrom_p,"valueto"=valueto_p,DAYNAME=day_p,INSERTION=insertion_p,COMMITION_ALLOW=commallow_p,DEAL_START=dealstart_p,"currency"=currency_p,"Rate_code"=ratecode_p,"convertrate"=totalrate_p,INCENTIVE=incentive_p,REMARKS=remarks_p,"approved"=approved_p,POSITION_PREM=positionprem,CONTRACT_AMOUNT=contractamount1
where "deal_code"=dealno_p and "ContractCode"=id_p;
end if; 
commit;
end;
/

/*******************************************************************************************/



CREATE OR REPLACE PROCEDURE bindGridDetails_Contract
(
compcode in varchar2,
dealcode in varchar2,
seqno_p in varchar2,
p_accounts out Cur_Type_New1.cursor_type,
p_accounts1 out Cur_Type_New1.cursor_type
)
is 
begin
open p_accounts for 
    select  AD_GET_FIELDNAME('Comp_Code',compcode,'Adv_Type_Code',ADTYPE,'Adv_Type_Name','Adv_Type_Mast','','')  as ADTYPE,
    AD_GET_FIELDNAME('Comp_Code',compcode,'Col_Code',contract_detail."color",'Col_Name','Col_Mast','','') as color,
    AD_GET_FIELDNAME('Comp_Code',compcode,'Uom_Code',contract_detail."Uom",'Uom_Name','Uom_Mast','','') as Uom,
    AD_GET_FIELDNAME('Comp_Code',compcode,'Combin_Code',contract_detail."packagecode",'Combin_Desc','Combin_Mast','','') as packagecode,
    AD_GET_FIELDNAME('Comp_Code',compcode,'Adv_Cat_Code',contract_detail."Advcategory",'Adv_Cat_Name','Adv_Cat_Mast','','') as Advcategory,
    AD_GET_FIELDNAME('comp_code',compcode,'Premiumcode',contract_detail."premiumcode",'premiumname','ADVPOS_PREM_MAST','','') as premiumcode,
    nvl("cardpremium",'') as cardpremium,nvl("dealpremium",'') as dealpremium,nvl("Dealarte",'') as Dealarte,nvl("cardrate",'') as cardrate,
    nvl("deviation",'') as deviation,
    CASE  "discounted"
    WHEN '1' THEN 'Free(1)'
    WHEN '2' THEN 'Discounted(2)'
    WHEN '3' THEN 'Fixed Rate(3)'
    ELSE "discounted"
    END as discounted,
    nvl(DISCPER,'')  as DISCPER,
    CASE  DISCTYPE
    WHEN '1' THEN 'Discount On Bill(1)'
    WHEN '2' THEN 'Discount through Credit Note(2)'
    ELSE DISCTYPE
    END as DISCTYPE,
    nvl(SIZEFROM,'') as SIZEFROM,nvl(SIZETO,'') as SIZETO,
    nvl("valuefrom",'') as valuefrom,nvl("valueto",'') as valueto,nvl(DAYNAME,'') as DAYNAME,nvl(INSERTION,'') as INSERTION,
    CASE COMMITION_ALLOW
    WHEN 'Y' THEN 'Yes(Y)'
    WHEN 'N' THEN 'No(N)'
    ELSE COMMITION_ALLOW
    END as COMMITION_ALLOW,
    CASE  DEAL_START
    WHEN 'A' THEN 'After Target Achived(A)'
    WHEN 'B' THEN 'From Begining(B)'
    ELSE DEAL_START
    END as DEAL_START,
    AD_GET_FIELDNAME('Comp_Code',compcode,'Curr_Code',"currency",'Curr_Name','Curr_Mast','','') as currency,nvl("Rate_code",'') as Rate_code,nvl("convertrate",'') as convertrate,nvl(INCENTIVE,'') as INCENTIVE,nvl(REMARKS,'') as REMARKS,
     CASE "approved"
    WHEN 'Y' THEN 'Yes(Y)'
    WHEN 'N' THEN 'No(N)'
    ELSE "approved"
    END as approved,"ContractCode" as CONTRACTCODE,AD_GET_FIELDNAME('Comp_Code',compcode,'Pos_Type_Code',contract_detail."POSITION_PREM",'Pos_Type','advpos_type_mast','','') AS POSITION_PREM, CONTRACT_AMOUNT
     from contract_detail where "deal_code"=dealcode;
if seqno_p is null then
open p_accounts1 for 
    SELECT 
    AD_GET_FIELDNAME('COMP_CODE',compcode,'CHANNEL',CHANNEL,'NAME','TV_AD_CHANNEL','','')  as CHANNEL,
    AD_GET_FIELDNAME('COMP_CODE',compcode,'LOCCD',LOCATION_CODE,'NAME','TV_AD_LOCATION','','')  as LOCATION_CODE,
    AD_GET_FIELDNAME('COMP_CODE',compcode,'AD_TYPE',AD_TYPE,'DES','TV_AD_TYPE','CHANNEL',CHANNEL)  as AD_TYPE,
    CASE  PB_FLG
    WHEN 'P' THEN 'Paid(P)'
    WHEN 'B' THEN 'Bonus(B)'
    ELSE PB_FLG
    END AS PB_FLG,
    AD_GET_FIELDNAME('COMP_CODE',compcode,'PRG_ID',PRG_CODE,'SHORT_NAME','TV_AD_PROGRAMME','','')  as PRG_CODE,
    AD_GET_FIELDNAME('COMP_CODE',compcode,'TV_BTB_MST.BTB_CODE',BTB_CODE,'BTB_DESC','TV_BTB_MST','CHANNEL',CHANNEL)  as BTB_CODE,
  --  AD_GET_FIELDNAME('COMP_CODE',compcode,'BND_CODE',ROS_CODE,'BND_DESC','TV_BND_MST','BTB_CODE',BTB_CODE)  as ROS_CODE,
    NVL(ROS_CODE,'') as ROS_CODE,
    nvl(DAYS,'') as DAYS,nvl(NO_OF_INS,'') as NO_OF_INS,
    AD_GET_FIELDNAME('Comp_Code',compcode,'Combin_Code',PACKAGE_CODE,'Combin_Desc','TV_COMBIN_MAST','','') as PACKAGE_CODE, 
    nvl(VALUE_FROM,'') as VALUE_FROM, nvl(VALUE_TO,'') as VALUE_TO,
     CASE  DISC_TYPE
    WHEN '1' THEN 'Free(1)'
    WHEN '2' THEN 'Discounted(2)'
    WHEN '3' THEN 'Fixed Rate(3)'
    ELSE DISC_TYPE
    END as DISC_TYPE, 
    nvl(DISC_VAL,'') as DISC_VAL,
    AD_GET_FIELDNAME('comp_code',compcode,'Premiumcode',PREM_CODE,'premiumname','ADVPOS_PREM_MAST','','') as PREM_CODE,
     nvl(CONTRACT_PREM_VALUE,'') as CONTRACT_PREM_VALUE,nvl(CONTRACT_RATE,'') as CONTRACT_RATE, nvl(CARD_RATE,'') as CARD_RATE, 
     nvl(DEVIATION_RATE,'') as DEVIATION_RATE,nvl(CARD_PREM_VALUE,'') as CARD_PREM_VALUE,nvl(MIN_SIZE,'') as MIN_SIZE, nvl(MAX_SIZE,'') as MAX_SIZE,
      AD_GET_FIELDNAME('Comp_Code',compcode,'Curr_Code',CURRENCY,'Curr_Name','Curr_Mast','','') as CURRENCY,
     CASE  DEAL_START
    WHEN 'A' THEN 'After Target Achived(A)'
    WHEN 'B' THEN 'From Begining(B)'
    ELSE DEAL_START
    END as DEAL_START,
    AD_GET_FIELDNAME('comp_code',compcode,'PROGRAMME_TY',PRG_TYPE,'NAME','TV_AD_PROGRAMME_TY','','') as PRG_TYPE,
     AD_GET_FIELDNAME('Comp_Code',compcode,'Adv_Cat_Code',AD_CTG,'Adv_Cat_Name','Adv_Cat_Mast','','') as AD_CTG,
      CASE COMM_ALLOW
    WHEN 'Y' THEN 'Yes(Y)'
    WHEN 'N' THEN 'No(N)'
    ELSE COMM_ALLOW
    END as COMM_ALLOW,
    nvl(REMARKS,'') as REMARKS, nvl(RATE_CODE,'') as RATE_CODE,
    CASE DISC_ON
     WHEN '1' THEN 'Discount On Bill(1)'
    WHEN '2' THEN 'Discount through Credit Note(2)'
    ELSE DISC_ON
    END AS DISC_ON,
    nvl(to_char(SPN_ST_DT,'dd/mm/yyyy'),'') as SPN_ST_DT, nvl(to_char(SPN_END_DT,'dd/mm/yyyy'),'') as SPN_END_DT,nvl(INCENTIVE,'') as INCENTIVE,
    CASE APPROVED
    WHEN 'Y' THEN 'Yes(Y)'
    WHEN 'N' THEN 'No(N)'
    ELSE APPROVED
    END as APPROVED, SEQNO,AD_GET_FIELDNAME('Comp_Code',compcode,'Uom_Code',RATE_TYPE,'Uom_Alias','UOM_MAST','','') as RATE_TYPE,
    AD_GET_FIELDNAME('COMP_CODE',compcode,'SOURCE_TYPE',SOURCE,'NAME','TV_SOURCE_TYPE','','') as SOURCE,
    NVL(TOTALVAL,'') AS TOTALVAL
     FROM tv_deal_det WHERE DEALNO=dealcode;
else
open p_accounts1 for 
    SELECT 
    AD_GET_FIELDNAME('COMP_CODE',compcode,'CHANNEL',CHANNEL,'NAME','TV_AD_CHANNEL','','')  as CHANNEL,
    AD_GET_FIELDNAME('COMP_CODE',compcode,'LOCCD',LOCATION_CODE,'NAME','TV_AD_LOCATION','','')  as LOCATION_CODE,
    AD_GET_FIELDNAME('COMP_CODE',compcode,'AD_TYPE',AD_TYPE,'DES','TV_AD_TYPE','','')  as AD_TYPE,
    CASE  PB_FLG
    WHEN 'P' THEN 'Paid(P)'
    WHEN 'B' THEN 'Bonus(B)'
    ELSE PB_FLG
    END AS PB_FLG,
    AD_GET_FIELDNAME('COMP_CODE',compcode,'PRG_ID',PRG_CODE,'SHORT_NAME','TV_AD_PROGRAMME','','')  as PRG_CODE,
   AD_GET_FIELDNAME('COMP_CODE',compcode,'TV_BTB_MST.BTB_CODE',BTB_CODE,'BTB_DESC','TV_BTB_MST','CHANNEL',CHANNEL)  as BTB_CODE,
  --  AD_GET_FIELDNAME('COMP_CODE',compcode,'BND_CODE',ROS_CODE,'BND_DESC','TV_BND_MST','BTB_CODE',BTB_CODE)  as ROS_CODE,
    NVL(ROS_CODE,'') as ROS_CODE,
    nvl(DAYS,'') as DAYS,nvl(NO_OF_INS,'') as NO_OF_INS,
    AD_GET_FIELDNAME('Comp_Code',compcode,'Combin_Code',PACKAGE_CODE,'Combin_Desc','Combin_Mast','','') as PACKAGE_CODE, 
    nvl(VALUE_FROM,'') as VALUE_FROM, nvl(VALUE_TO,'') as VALUE_TO,
     CASE  DISC_TYPE
    WHEN '1' THEN 'Free(1)'
    WHEN '2' THEN 'Discounted(2)'
    WHEN '3' THEN 'Fixed Rate(3)'
    ELSE DISC_TYPE
    END as DISC_TYPE, 
    nvl(DISC_VAL,'') as DISC_VAL,
    AD_GET_FIELDNAME('comp_code',compcode,'Premiumcode',PREM_CODE,'premiumname','ADVPOS_PREM_MAST','','') as PREM_CODE,
     nvl(CONTRACT_PREM_VALUE,'') as CONTRACT_PREM_VALUE,nvl(CONTRACT_RATE,'') as CONTRACT_RATE, nvl(CARD_RATE,'') as CARD_RATE, 
     nvl(DEVIATION_RATE,'') as DEVIATION_RATE,nvl(CARD_PREM_VALUE,'') as CARD_PREM_VALUE,nvl(MIN_SIZE,'') as MIN_SIZE, nvl(MAX_SIZE,'') as MAX_SIZE,
      AD_GET_FIELDNAME('Comp_Code',compcode,'Curr_Code',CURRENCY,'Curr_Name','Curr_Mast','','') as CURRENCY,
     CASE  DEAL_START
    WHEN 'A' THEN 'After Target Achived(A)'
    WHEN 'B' THEN 'From Begining(B)'
    ELSE DEAL_START
    END as DEAL_START,
    AD_GET_FIELDNAME('comp_code',compcode,'PROGRAMME_TY',PRG_TYPE,'NAME','TV_AD_PROGRAMME_TY','','') as PRG_TYPE,
     AD_GET_FIELDNAME('Comp_Code',compcode,'Adv_Cat_Code',AD_CTG,'Adv_Cat_Name','Adv_Cat_Mast','','') as AD_CTG,
      CASE COMM_ALLOW
    WHEN 'Y' THEN 'Yes(Y)'
    WHEN 'N' THEN 'No(N)'
    ELSE COMM_ALLOW
    END as COMM_ALLOW,
    nvl(REMARKS,'') as REMARKS, nvl(RATE_CODE,'') as RATE_CODE,
    CASE DISC_ON
     WHEN '1' THEN 'Discount On Bill(1)'
    WHEN '2' THEN 'Discount through Credit Note(2)'
    ELSE DISC_ON
    END AS DISC_ON,
    nvl(SPN_ST_DT,'') as SPN_ST_DT, nvl(SPN_END_DT,'') as SPN_END_DT,nvl(INCENTIVE,'') as INCENTIVE,
    CASE APPROVED
    WHEN 'Y' THEN 'Yes(Y)'
    WHEN 'N' THEN 'No(N)'
    ELSE APPROVED
    END as APPROVED, SEQNO,AD_GET_FIELDNAME('Comp_Code',compcode,'Uom_Code',RATE_TYPE,'Uom_Alias','UOM_MAST','','') as RATE_TYPE,
    AD_GET_FIELDNAME('COMP_CODE',compcode,'SOURCE_TYPE',SOURCE,'NAME','TV_SOURCE_TYPE','','') as SOURCE,
    NVL(TOTALVAL,'') AS TOTALVAL
     FROM tv_deal_det WHERE DEALNO=dealcode and SEQNO=seqno_p;            
end if;      
end bindGridDetails_Contract;
/


/******************************************/


CREATE OR REPLACE PROCEDURE bindGridDetails_Contract
(
compcode in varchar2,
dealcode in varchar2,
seqno_p in varchar2,
p_accounts out Cur_Type_New1.cursor_type,
p_accounts1 out Cur_Type_New1.cursor_type
)
is 
begin
open p_accounts for 
    select  AD_GET_FIELDNAME('Comp_Code',compcode,'Adv_Type_Code',ADTYPE,'Adv_Type_Name','Adv_Type_Mast','','')  as ADTYPE,
    AD_GET_FIELDNAME('Comp_Code',compcode,'Col_Code',contract_detail."color",'Col_Name','Col_Mast','','') as color,
    AD_GET_FIELDNAME('Comp_Code',compcode,'Uom_Code',contract_detail."Uom",'Uom_Name','Uom_Mast','','') as Uom,
    AD_GET_FIELDNAME('Comp_Code',compcode,'Combin_Code',contract_detail."packagecode",'Package_Name','Combin_Mast','','') as packagecode,
    AD_GET_FIELDNAME('Comp_Code',compcode,'Adv_Cat_Code',contract_detail."Advcategory",'Adv_Cat_Name','Adv_Cat_Mast','','') as Advcategory,
    AD_GET_FIELDNAME('comp_code',compcode,'Premiumcode',contract_detail."premiumcode",'premiumname','ADVPOS_PREM_MAST','','') as premiumcode,
    nvl("cardpremium",'') as cardpremium,nvl("dealpremium",'') as dealpremium,nvl("Dealarte",'') as Dealarte,nvl("cardrate",'') as cardrate,
    nvl("deviation",'') as deviation,
    CASE  "discounted"
    WHEN '1' THEN 'Free(1)'
    WHEN '2' THEN 'Discounted(2)'
    WHEN '3' THEN 'Fixed Rate(3)'
    ELSE "discounted"
    END as discounted,
    nvl(DISCPER,'')  as DISCPER,
    CASE  DISCTYPE
    WHEN '1' THEN 'Discount On Bill(1)'
    WHEN '2' THEN 'Discount through Credit Note(2)'
    ELSE DISCTYPE
    END as DISCTYPE,
    nvl(SIZEFROM,'') as SIZEFROM,nvl(SIZETO,'') as SIZETO,
    nvl("valuefrom",'') as valuefrom,nvl("valueto",'') as valueto,nvl(DAYNAME,'') as DAYNAME,nvl(INSERTION,'') as INSERTION,
    CASE COMMITION_ALLOW
    WHEN 'Y' THEN 'Yes(Y)'
    WHEN 'N' THEN 'No(N)'
    ELSE COMMITION_ALLOW
    END as COMMITION_ALLOW,
    CASE  DEAL_START
    WHEN 'A' THEN 'After Target Achived(A)'
    WHEN 'B' THEN 'From Begining(B)'
    ELSE DEAL_START
    END as DEAL_START,
    AD_GET_FIELDNAME('Comp_Code',compcode,'Curr_Code',"currency",'Curr_Name','Curr_Mast','','') as currency,nvl("Rate_code",'') as Rate_code,nvl("convertrate",'') as convertrate,nvl(INCENTIVE,'') as INCENTIVE,nvl(REMARKS,'') as REMARKS,
     CASE "approved"
    WHEN 'Y' THEN 'Active(Y)'
    WHEN 'N' THEN 'Inactive(N)'
    ELSE "approved"
    END as approved,"ContractCode" as CONTRACTCODE,AD_GET_FIELDNAME('Comp_Code',compcode,'Pos_Type_Code',contract_detail."POSITION_PREM",'Pos_Type','advpos_type_mast','','') AS POSITION_PREM, CONTRACT_AMOUNT
     from contract_detail where "deal_code"=dealcode;
if seqno_p is null then
open p_accounts1 for 
    SELECT 
    AD_GET_FIELDNAME('COMP_CODE',compcode,'CHANNEL',CHANNEL,'NAME','TV_AD_CHANNEL','','')  as CHANNEL,
    AD_GET_FIELDNAME('COMP_CODE',compcode,'LOCCD',LOCATION_CODE,'NAME','TV_AD_LOCATION','','')  as LOCATION_CODE,
    AD_GET_FIELDNAME('COMP_CODE',compcode,'AD_TYPE',AD_TYPE,'DES','TV_AD_TYPE','CHANNEL',CHANNEL)  as AD_TYPE,
    CASE  PB_FLG
    WHEN 'P' THEN 'Paid(P)'
    WHEN 'B' THEN 'Bonus(B)'
    ELSE PB_FLG
    END AS PB_FLG,
    AD_GET_FIELDNAME('COMP_CODE',compcode,'PRG_ID',PRG_CODE,'SHORT_NAME','TV_AD_PROGRAMME','','')  as PRG_CODE,
    AD_GET_FIELDNAME('COMP_CODE',compcode,'TV_BTB_MST.BTB_CODE',BTB_CODE,'BTB_DESC','TV_BTB_MST','CHANNEL',CHANNEL)  as BTB_CODE,
  --  AD_GET_FIELDNAME('COMP_CODE',compcode,'BND_CODE',ROS_CODE,'BND_DESC','TV_BND_MST','BTB_CODE',BTB_CODE)  as ROS_CODE,
    NVL(ROS_CODE,'') as ROS_CODE,
    nvl(DAYS,'') as DAYS,nvl(NO_OF_INS,'') as NO_OF_INS,
    AD_GET_FIELDNAME('Comp_Code',compcode,'Combin_Code',PACKAGE_CODE,'Combin_Desc','TV_COMBIN_MAST','','') as PACKAGE_CODE, 
    nvl(VALUE_FROM,'') as VALUE_FROM, nvl(VALUE_TO,'') as VALUE_TO,
     CASE  DISC_TYPE
    WHEN '1' THEN 'Free(1)'
    WHEN '2' THEN 'Discounted(2)'
    WHEN '3' THEN 'Fixed Rate(3)'
    ELSE DISC_TYPE
    END as DISC_TYPE, 
    nvl(DISC_VAL,'') as DISC_VAL,
    AD_GET_FIELDNAME('comp_code',compcode,'Premiumcode',PREM_CODE,'premiumname','ADVPOS_PREM_MAST','','') as PREM_CODE,
     nvl(CONTRACT_PREM_VALUE,'') as CONTRACT_PREM_VALUE,nvl(CONTRACT_RATE,'') as CONTRACT_RATE, nvl(CARD_RATE,'') as CARD_RATE, 
     nvl(DEVIATION_RATE,'') as DEVIATION_RATE,nvl(CARD_PREM_VALUE,'') as CARD_PREM_VALUE,nvl(MIN_SIZE,'') as MIN_SIZE, nvl(MAX_SIZE,'') as MAX_SIZE,
      AD_GET_FIELDNAME('Comp_Code',compcode,'Curr_Code',CURRENCY,'Curr_Name','Curr_Mast','','') as CURRENCY,
     CASE  DEAL_START
    WHEN 'A' THEN 'After Target Achived(A)'
    WHEN 'B' THEN 'From Begining(B)'
    ELSE DEAL_START
    END as DEAL_START,
    AD_GET_FIELDNAME('comp_code',compcode,'PROGRAMME_TY',PRG_TYPE,'NAME','TV_AD_PROGRAMME_TY','','') as PRG_TYPE,
     AD_GET_FIELDNAME('Comp_Code',compcode,'Adv_Cat_Code',AD_CTG,'Adv_Cat_Name','Adv_Cat_Mast','','') as AD_CTG,
      CASE COMM_ALLOW
    WHEN 'Y' THEN 'Yes(Y)'
    WHEN 'N' THEN 'No(N)'
    ELSE COMM_ALLOW
    END as COMM_ALLOW,
    nvl(REMARKS,'') as REMARKS, nvl(RATE_CODE,'') as RATE_CODE,
    CASE DISC_ON
     WHEN '1' THEN 'Discount On Bill(1)'
    WHEN '2' THEN 'Discount through Credit Note(2)'
    ELSE DISC_ON
    END AS DISC_ON,
    nvl(to_char(SPN_ST_DT,'dd/mm/yyyy'),'') as SPN_ST_DT, nvl(to_char(SPN_END_DT,'dd/mm/yyyy'),'') as SPN_END_DT,nvl(INCENTIVE,'') as INCENTIVE,
    CASE APPROVED
    WHEN 'Y' THEN 'Yes(Y)'
    WHEN 'N' THEN 'No(N)'
    ELSE APPROVED
    END as APPROVED, SEQNO,AD_GET_FIELDNAME('Comp_Code',compcode,'Uom_Code',RATE_TYPE,'Uom_Alias','UOM_MAST','','') as RATE_TYPE,
    AD_GET_FIELDNAME('COMP_CODE',compcode,'SOURCE_TYPE',SOURCE,'NAME','TV_SOURCE_TYPE','','') as SOURCE,
    NVL(TOTALVAL,'') AS TOTALVAL
     FROM tv_deal_det WHERE DEALNO=dealcode;
else
open p_accounts1 for 
    SELECT 
    AD_GET_FIELDNAME('COMP_CODE',compcode,'CHANNEL',CHANNEL,'NAME','TV_AD_CHANNEL','','')  as CHANNEL,
    AD_GET_FIELDNAME('COMP_CODE',compcode,'LOCCD',LOCATION_CODE,'NAME','TV_AD_LOCATION','','')  as LOCATION_CODE,
    AD_GET_FIELDNAME('COMP_CODE',compcode,'AD_TYPE',AD_TYPE,'DES','TV_AD_TYPE','','')  as AD_TYPE,
    CASE  PB_FLG
    WHEN 'P' THEN 'Paid(P)'
    WHEN 'B' THEN 'Bonus(B)'
    ELSE PB_FLG
    END AS PB_FLG,
    AD_GET_FIELDNAME('COMP_CODE',compcode,'PRG_ID',PRG_CODE,'SHORT_NAME','TV_AD_PROGRAMME','','')  as PRG_CODE,
   AD_GET_FIELDNAME('COMP_CODE',compcode,'TV_BTB_MST.BTB_CODE',BTB_CODE,'BTB_DESC','TV_BTB_MST','CHANNEL',CHANNEL)  as BTB_CODE,
  --  AD_GET_FIELDNAME('COMP_CODE',compcode,'BND_CODE',ROS_CODE,'BND_DESC','TV_BND_MST','BTB_CODE',BTB_CODE)  as ROS_CODE,
    NVL(ROS_CODE,'') as ROS_CODE,
    nvl(DAYS,'') as DAYS,nvl(NO_OF_INS,'') as NO_OF_INS,
    AD_GET_FIELDNAME('Comp_Code',compcode,'Combin_Code',PACKAGE_CODE,'Combin_Desc','Combin_Mast','','') as PACKAGE_CODE, 
    nvl(VALUE_FROM,'') as VALUE_FROM, nvl(VALUE_TO,'') as VALUE_TO,
     CASE  DISC_TYPE
    WHEN '1' THEN 'Free(1)'
    WHEN '2' THEN 'Discounted(2)'
    WHEN '3' THEN 'Fixed Rate(3)'
    ELSE DISC_TYPE
    END as DISC_TYPE, 
    nvl(DISC_VAL,'') as DISC_VAL,
    AD_GET_FIELDNAME('comp_code',compcode,'Premiumcode',PREM_CODE,'premiumname','ADVPOS_PREM_MAST','','') as PREM_CODE,
     nvl(CONTRACT_PREM_VALUE,'') as CONTRACT_PREM_VALUE,nvl(CONTRACT_RATE,'') as CONTRACT_RATE, nvl(CARD_RATE,'') as CARD_RATE, 
     nvl(DEVIATION_RATE,'') as DEVIATION_RATE,nvl(CARD_PREM_VALUE,'') as CARD_PREM_VALUE,nvl(MIN_SIZE,'') as MIN_SIZE, nvl(MAX_SIZE,'') as MAX_SIZE,
      AD_GET_FIELDNAME('Comp_Code',compcode,'Curr_Code',CURRENCY,'Curr_Name','Curr_Mast','','') as CURRENCY,
     CASE  DEAL_START
    WHEN 'A' THEN 'After Target Achived(A)'
    WHEN 'B' THEN 'From Begining(B)'
    ELSE DEAL_START
    END as DEAL_START,
    AD_GET_FIELDNAME('comp_code',compcode,'PROGRAMME_TY',PRG_TYPE,'NAME','TV_AD_PROGRAMME_TY','','') as PRG_TYPE,
     AD_GET_FIELDNAME('Comp_Code',compcode,'Adv_Cat_Code',AD_CTG,'Adv_Cat_Name','Adv_Cat_Mast','','') as AD_CTG,
      CASE COMM_ALLOW
    WHEN 'Y' THEN 'Yes(Y)'
    WHEN 'N' THEN 'No(N)'
    ELSE COMM_ALLOW
    END as COMM_ALLOW,
    nvl(REMARKS,'') as REMARKS, nvl(RATE_CODE,'') as RATE_CODE,
    CASE DISC_ON
     WHEN '1' THEN 'Discount On Bill(1)'
    WHEN '2' THEN 'Discount through Credit Note(2)'
    ELSE DISC_ON
    END AS DISC_ON,
    nvl(SPN_ST_DT,'') as SPN_ST_DT, nvl(SPN_END_DT,'') as SPN_END_DT,nvl(INCENTIVE,'') as INCENTIVE,
    CASE APPROVED
    WHEN 'Y' THEN 'Yes(Y)'
    WHEN 'N' THEN 'No(N)'
    ELSE APPROVED
    END as APPROVED, SEQNO,AD_GET_FIELDNAME('Comp_Code',compcode,'Uom_Code',RATE_TYPE,'Uom_Alias','UOM_MAST','','') as RATE_TYPE,
    AD_GET_FIELDNAME('COMP_CODE',compcode,'SOURCE_TYPE',SOURCE,'NAME','TV_SOURCE_TYPE','','') as SOURCE,
    NVL(TOTALVAL,'') AS TOTALVAL
     FROM tv_deal_det WHERE DEALNO=dealcode and SEQNO=seqno_p;            
end if;      
end bindGridDetails_Contract;
/


/************************************************************/


CREATE OR REPLACE PACKAGE executecontract IS
Type T_Accounts_Cursor is Ref Cursor;
PROCEDURE executecontract_P(
compcode in varchar2,
userid in varchar2,--
DealNo in varchar2,--
dealname in varchar2,--
agencycode in varchar2,--
subagencycode in varchar2,--
representative in varchar2,
dealtype in varchar2,
P_Accounts  OUT  T_Accounts_Cursor
);
end executecontract;
/





CREATE OR REPLACE PACKAGE BODY Executecontract
IS
  PROCEDURE executecontract_P(
  			compcode IN VARCHAR2,
			userid IN VARCHAR2,--
			DealNo IN VARCHAR2,--
			dealname IN VARCHAR2,--
			agencycode IN VARCHAR2,--
			subagencycode IN VARCHAR2,--
			Representative IN VARCHAR2,
			dealtype IN VARCHAR2,
			P_Accounts  OUT  T_Accounts_Cursor)
	AS
	BEGIN
		 OPEN P_Accounts FOR
		 SELECT  "Deal_No","Comp_code",(select "Agency_Name"||'('|| "Agency_Code" ||')' from agency_mast where "Agency_Code"="Agency_code" and agency_mast."SUB_Agency_Code"=contract_mast."Sub_Agency_Code") as "Agency_code","Sub_Agency_Code",(select "Cust_Name"||'('||"Cust_Code"||')' from cust_mast where "Cust_Code"="Client_code") as "Client_code","Product_code",TO_CHAR("From_date",'mm/dd/yyyy') as "From_date",TO_CHAR("Till_date",'mm/dd/yyyy') as "Till_date","representative","Userid","Total_val","Total_volu","team_code","deal_type","deal_name","contract_id","Ad_type",REMARKS,(select "Exec_name"||'('||"Exe_no"||')' from exec_mast where "Exe_no"=EXECUTIVE) as EXECUTIVE, (select "Retain_Name"||'(' || "Retain_Code" || ')' from  retainermaster where "Retain_Code"=RETAINER) as RETAINER, TO_CHAR(CONTRACTDATE,'mm/dd/yyyy') as CONTRACTDATE,TO_CHAR(CLOSEDATE,'mm/dd/yyyy') as  CLOSEDATE, SERVICETAX, PAYMENTTYPE, CAPTION, B2B, CHKMULTIAD, SEQNO_ALLOW, SEQNO, AFT_PRTCLR_AD, INDUSTRY, INDUSTRY_PRODUCT, DEALON,ATTACHMENT,ad_get_fieldname ('Comp_Code',
                                    compcode,
                                    'Pub_cent_Code',
                                    CONTRACT_MAST.DEAL_FROM,
                                    'Pub_Cent_name',
                                    'pub_cent_mast',
                                    '',
                                    ''
                                   ) AS DEAL_FROM, DEAL_CENTER, TRANSLATION_CHARGES
          FROM CONTRACT_MAST
		 WHERE ("Comp_code" = compcode OR compcode IS NULL)
		 AND ("Deal_No" LIKE DealNo || '%' OR DealNo IS NULL)
		 AND("deal_name"  LIKE dealname ||'%'OR dealname IS NULL)
		 AND("Agency_code" LIKE agencycode||'%'OR agencycode IS NULL)
		 AND("deal_type" LIKE dealtype||'%'OR dealtype IS NULL)
		 AND("Sub_Agency_Code" LIKE subagencycode||'%'OR subagencycode IS NULL)
		 AND("representative" LIKE Representative||'%'OR Representative IS NULL);

END executecontract_P;
END Executecontract;
/



/**************mimoh*****Issue No. 0006211*********************/

\

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@bullet master@@@@@@@@@@@@@

//==============*********************Start Scripting****************==================//
ALTER TABLE TBL_BOOKING_SUBEDITION
 ADD (PAGE_NO  NUMBER);
 
 ALTER TABLE TBL_BOOKING_SUBEDITION_g
 ADD (PAGE_NO  NUMBER);
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PACKAGE Updatebullet IS
PROCEDURE updatebullet_p(
bulletcode IN VARCHAR2,
--edition IN VARCHAR2,
bulletdesc IN VARCHAR2,
bulletcharge IN VARCHAR2,
bullettext IN VARCHAR2,
remarks IN VARCHAR2,

validatedate IN DATE,
validatetill IN DATE,
compcode IN VARCHAR2,
userid IN VARCHAR2,
sumble IN VARCHAR2,
pubcenter in varchar2,
font1   in varchar2,
adcat in varchar2
);
END Updatebullet;
/

CREATE OR REPLACE PACKAGE BODY Updatebullet IS

PROCEDURE updatebullet_p(
bulletcode IN VARCHAR2,
--edition IN VARCHAR2,
bulletdesc IN VARCHAR2,
bulletcharge IN VARCHAR2,
bullettext IN VARCHAR2,
remarks IN VARCHAR2,

validatedate IN DATE,
validatetill IN DATE,
compcode IN VARCHAR2,
userid IN VARCHAR2,
sumble IN VARCHAR2,
pubcenter in varchar2,
font1   in varchar2,
adcat in varchar2
) AS
BEGIN
UPDATE BULLET_MAST SET "Bullet_Desc"=bulletdesc,"Bullet_Charges_Type"=bulletcharge,"Bullet_Charges"=bullettext,"Validity_From_Date"=validatedate,
"Validity_Till_Date"=validatetill,"Remarks"=remarks ,"Sumble"=sumble,"pub_center"=pubcenter,FONT=font1,"Adv_Cat_Code"=adcat WHERE "Comp_Code"=compcode  AND  "Bullet_Code"=bulletcode;





--update  temp_bullet_mast set "Bullet_Desc"=bulletdesc,"Bullet_Charges_Type"=bulletcharge,"Bullet_Charges"=bullettext,
--"Validity_From_Date"=validatedate,"Validity_Till_Date"=validatetill,"Remarks"=remarks  where "Comp_Code"=compcode
--and   "Bullet_Code"=bulletcode;

COMMIT;
END updatebullet_p;
END Updatebullet;
/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PACKAGE insertbullet is

 procedure insertbullet_p(
 bulletcode in varchar2,
--edition in varchar2,
bulletdesc in varchar2,
bulletcharge in varchar2,
bullettext in varchar2,
remarks in varchar2,
validatedate in date,
validatetill in date,
compcode in varchar2,
userid in varchar2,
sumble in varchar2,
pubcenter in varchar2,
font in varchar2,
adcat in varchar2);
end  insertbullet;
/

CREATE OR REPLACE PACKAGE BODY insertbullet is

 procedure insertbullet_p(bulletcode in varchar2,
--edition in varchar2,
bulletdesc in varchar2,
bulletcharge in varchar2,
bullettext in varchar2,
remarks in varchar2,

validatedate in date,
validatetill in date,
compcode in varchar2,
userid in varchar2,
sumble in varchar2,
pubcenter in varchar2,
font in varchar2,
adcat in varchar2)as
begin
insert into bullet_mast("Comp_Code","Bullet_Code","Bullet_Desc","Bullet_Charges_Type","Bullet_Charges","Validity_From_Date","Validity_Till_Date","Remarks","UserId","Sumble","Cration_Datetime","pub_center",FONT,"Adv_Cat_Code")
 values(compcode,bulletcode,bulletdesc,bulletcharge,bullettext,validatedate,validatetill,remarks,userid,sumble,sysdate,pubcenter,font,adcat);
commit;
end  insertbullet_p;
end  insertbullet;
/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PACKAGE Executebulletbullet IS
TYPE T_ACCOUNT_CURSOR IS REF CURSOR;
PROCEDURE executebulletbullet_p(
bulletcode IN VARCHAR2,
bulletdesc IN VARCHAR2,
bulletcharge IN VARCHAR2,
bullettext IN VARCHAR2,
compcode IN VARCHAR2,
userid IN VARCHAR2,
pubcenter in varchar2,
dateformat in varchar2,
adcat in varchar2,
P_ACCOUNT OUT T_ACCOUNT_CURSOR);
END Executebulletbullet;
/
CREATE OR REPLACE PACKAGE BODY Executebulletbullet IS

PROCEDURE executebulletbullet_p(
bulletcode IN VARCHAR2,
bulletdesc IN VARCHAR2,
bulletcharge IN VARCHAR2,
bullettext IN VARCHAR2,
compcode IN VARCHAR2,
userid IN VARCHAR2,
pubcenter in varchar2,
dateformat in varchar2,
adcat in varchar2,
P_ACCOUNT OUT T_ACCOUNT_CURSOR)AS
BEGIN
if(dateformat='dd/mm/yyyy') then
OPEN P_ACCOUNT FOR
SELECT  "Comp_Code" AS "comp_code","Edition_Code","Bullet_Code" AS "bullet_code" , "Bullet_Desc" AS "bullet_desc", "Bullet_Charges_Type" AS "bullet_charges_type", "Bullet_Charges" AS "bullet_charges", TO_CHAR(("Validity_From_Date"),'dd/mm/yyyy') AS "validity_from_date", TO_CHAR(("Validity_Till_Date"),'dd/mm/yyyy') AS "validity_till_date", "Remarks" AS "Remarks", "UserId" AS "userid", "Cration_Datetime", "Sumble" AS "Sumble", "pub_center",FONT,"Adv_Cat_Code"
FROM BULLET_MAST

WHERE ("Comp_Code" =compcode OR compcode IS NULL)
AND ("Bullet_Code" LIKE bulletcode OR bulletcode IS NULL)
AND ("Bullet_Desc" LIKE bulletdesc ||'%')--OR bulletdesc IS NULL)
AND ("Bullet_Charges_Type" LIKE bulletcharge ||'%')
AND ("Adv_Cat_Code" like '%' ||adcat||'%' OR adcat IS NULL)
AND ("pub_center"=pubcenter OR pubcenter IS NULL);-- OR bulletcharge IS NULL);


elsif(dateformat='mm/dd/yyyy') then

OPEN P_ACCOUNT FOR
SELECT  "Comp_Code" AS "comp_code","Edition_Code","Bullet_Code" AS "bullet_code" , "Bullet_Desc" AS "bullet_desc", "Bullet_Charges_Type" AS "bullet_charges_type", "Bullet_Charges" AS "bullet_charges", TO_CHAR(("Validity_From_Date"),'mm/dd/yyyy') AS "validity_from_date", TO_CHAR(("Validity_Till_Date"),'mm/dd/yyyy') AS "validity_till_date", "Remarks" AS "Remarks", "UserId" AS "userid", "Cration_Datetime", "Sumble" AS "Sumble", "pub_center",FONT,"Adv_Cat_Code"
FROM BULLET_MAST

WHERE ("Comp_Code" =compcode OR compcode IS NULL)
AND ("Bullet_Code" LIKE bulletcode OR bulletcode IS NULL)
AND ("Bullet_Desc" LIKE bulletdesc ||'%')--OR bulletdesc IS NULL)
AND ("Bullet_Charges_Type" LIKE bulletcharge ||'%')
AND ("Adv_Cat_Code" like '%' ||adcat||'%' OR adcat IS NULL)
AND ("pub_center"=pubcenter OR pubcenter IS NULL);-- OR bulletcharge IS NULL);

end if;


/*if bulletdesc is not null and bullettext is not null then
open P_ACCOUNT for
select  "Comp_Code" as "comp_code","Edition_Code","Bullet_Code" as "bullet_code" , "Bullet_Desc" as "bullet_desc", "Bullet_Charges_Type" as "bullet_charges_type", "Bullet_Charges" as "bullet_charges", to_char(("Validity_From_Date"),'mm/dd/yyyy') as "validity_from_date", to_char(("Validity_Till_Date"),'mm/dd/yyyy') as "validity_till_date", "Remarks" as "Remarks", "UserId" as "userid", "Cration_Datetime", "Sumble" as "Sumble"
from bullet_mast  where
("Bullet_Code"=bulletcode or bulletcode is null)and
"Bullet_Desc" like bulletdesc||'%' and
("Comp_Code"=compcode or compcode is null)and
("Bullet_Charges"=bulletcharge or bulletcharge is null)and
("UserId"=userid  or userid  is null);

elsif bulletdesc is not null then

open P_ACCOUNT for
select  "Comp_Code" as "comp_code","Edition_Code","Bullet_Code" as "bullet_code" , "Bullet_Desc" as "bullet_desc", "Bullet_Charges_Type" as "bullet_charges_type", "Bullet_Charges" as "bullet_charges", to_char(("Validity_From_Date"),'mm/dd/yyyy') as "validity_from_date", to_char(("Validity_Till_Date"),'mm/dd/yyyy') as "validity_till_date", "Remarks" as "Remarks", "UserId" as "userid", "Cration_Datetime", "Sumble" as "Sumble"
from bullet_mast  where
("Bullet_Code"=bulletcode or bulletcode is null)and
"Bullet_Desc" like bulletdesc||'%' and
("Comp_Code"=compcode or compcode is null)and
("Bullet_Charges"=bulletcharge or bulletcharge is null)and
("UserId"=userid  or userid  is null);


else
open P_ACCOUNT for
select  "Comp_Code" as "comp_code","Edition_Code","Bullet_Code" as "bullet_code" , "Bullet_Desc" as "bullet_desc", "Bullet_Charges_Type" as "bullet_charges_type", "Bullet_Charges" as "bullet_charges", to_char(("Validity_From_Date"),'mm/dd/yyyy') as "validity_from_date", to_char(("Validity_Till_Date"),'mm/dd/yyyy') as "validity_till_date", "Remarks" as "Remarks", "UserId" as "userid", "Cration_Datetime", "Sumble" as "Sumble"
from bullet_mast
where
("Bullet_Code"=bulletcode or bulletcode is null)and
--"Bullet_Desc" like bulletdesc||'%' and
("Comp_Code"=compcode or compcode is null)and
("Bullet_Charges"=bulletcharge or bulletcharge is null)and
("UserId"=userid  or userid  is null);

end if;
*/

END  executebulletbullet_p;
END Executebulletbullet;
/


@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PROCEDURE updateDataEditionDetail
(
 srno_p IN  VARCHAR2,
 insertid_p in varchar2,
  height_p in varchar2,
 width_p IN VARCHAR2,
 totarea_p in varchar2,
 dateI_p in date,
 edition_p in varchar2,
 receiptno_p in varchar2,
 insstatus_p in varchar2,
 pageno_p in varchar2)
IS
begin
if receiptno_p is null then
 update tbl_booking_subedition set INSERTDATE=dateI_p,HEIGHT=height_p,WIDTH=width_p,TOTALAREA=totarea_p, INSERTSTATUS=insstatus_p,
         PAGE_NO= pageno_p
 where /*RECEIPTNO=receiptno_p and*/ INSERTID=insertid_p AND SRNO=srno_p;

else
 update tbl_booking_subedition set INSERTDATE=dateI_p,HEIGHT=height_p,WIDTH=width_p,TOTALAREA=totarea_p, INSERTSTATUS=insstatus_p,
         PAGE_NO= pageno_p 
 where RECEIPTNO=receiptno_p and INSERTID=insertid_p AND SRNO=srno_p;

end if;        
 commit;                
END ;
/
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PROCEDURE FetchSubEditionDetail
(
 compcode IN  VARCHAR2,
 edition in varchar2,
  insertid in varchar2,
 dateformat IN VARCHAR2,
 pkgcode in varchar2,
 p_Accounts OUT Cur_Type_New1.cursor_type,
  p_Accounts1 OUT Cur_Type_New1.cursor_type
 )
IS
pubcode varchar2(10);
centcode varchar2(10);
insertidm varchar2(20);
begin
insertidm:=insertid;
select "Pub_Code","City_Code" into pubcode,centcode from edition_mast where "Edition_Alias"=edition;
if insertid is null or insertid=0 then
    open p_Accounts for
        select "Edition_Alias" as "Edition" from edition_mast where "Comp_Code"=compcode and "Edition_Type"='Edition' and "Pub_Code"=pubcode and "City_Code"=centcode;
else
if dateformat='dd/mm/yyyy' then
     open p_Accounts for
        select COMP_CODE, CIOID, INSERTID, PUBLICATION, (SELECT "Edition_Alias" from edition_Mast where "Edition_Code"=EDITION) as EDITION, to_char(INSERTDATE,'dd/mm/yyyy') as INSERTDATE, nvl(HEIGHT,'') as "HEIGHT", NVL(WIDTH,'') AS "WIDTH", TOTALAREA, INSERTSTATUS, RECEIPTNO,SRNO,NVL(PAGE_NO,'') as "PAGE_NO" from tbl_booking_subedition  where insertid=insertidm;
elsif dateformat='mm/dd/yyyy' then
    open p_Accounts for
        select COMP_CODE, CIOID, INSERTID, PUBLICATION, (SELECT "Edition_Alias" from edition_Mast where "Edition_Code"=EDITION) as EDITION, to_char(INSERTDATE,'mm/dd/yyyy') as INSERTDATE, nvl(HEIGHT,'') as "HEIGHT", NVL(WIDTH,'') AS "WIDTH", TOTALAREA, INSERTSTATUS, RECEIPTNO,SRNO,NVL(PAGE_NO,'') as "PAGE_NO" from tbl_booking_subedition  where insertid=insertidm;        
else
    open p_Accounts for
        select COMP_CODE, CIOID, INSERTID, PUBLICATION, (SELECT "Edition_Alias" from edition_Mast where "Edition_Code"=EDITION) as EDITION, to_char(INSERTDATE,'yyyy/mm/dd') as INSERTDATE, nvl(HEIGHT,'') as "HEIGHT", NVL(WIDTH,'') AS "WIDTH", TOTALAREA, INSERTSTATUS, RECEIPTNO,SRNO,NVL(PAGE_NO,'') as "PAGE_NO" from tbl_booking_subedition  where insertid=insertidm;        
end if;           
end if;  
    open p_Accounts1 for
        select "Combin_Desc" from combin_mast where "Combin_Code"=pkgcode;                   
END ;
/
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PROCEDURE insert_edition_details(p_str in varchar2,receiptnom in varchar2,cioidm in varchar2,insertidm in varchar2,compcodem in varchar2,editioncodem in varchar2,insertdatem in date,heightm in varchar2,widthm in varchar2,totaream varchar2,insstatusm varchar2,pkgcode varchar2,insertno number ,pageno number, p_error_text out varchar2)  IS
tmpVar NUMBER;
tmpStr VARCHAR2(4000);
l_str VARCHAR2(4000);
l_ed varchar2(50);
l_date date;
l_hight number;
l_width number;
l_size number;
l_pageno number;
l_status varchar2(20);
pubcode varchar2(10);
editioncode varchar2(50);
combinname varchar2(3000);
uomdesc varchar2(50);
BEGIN

if p_str is not null then
INSERT INTO TEST1 VALUES('pubcode','editioncode');
COMMIT;
 --insert into abctest values(insertidm,l_status);
   tmpVar := 0;
   tmpStr := p_str;
   l_str := p_str;
   for i in 1..length(tmpStr)-length(replace(tmpStr,'$',null))+1 
   loop 
      
      if instr(tmpStr,'$') > 0 then 
         l_str := substr(tmpStr,1,instr(tmpStr,'$')-1);
         else
          l_str := tmpStr;
      end if;
      --dbms_output.put_line('l_str:'||l_str);
      l_ed := substr(l_str,1,instr(l_str,'~')-1);
      l_str := substr(l_str,instr(l_str,'~')+1);
      l_date := to_date(substr(l_str,1,instr(l_str,'~')-1),'mm/dd/yyyy');
      l_str := substr(l_str,instr(l_str,'~')+1);
     
      l_hight := substr(l_str,1,instr(l_str,'~')-1);
      l_str := substr(l_str,instr(l_str,'~')+1);
      l_width := substr(l_str,1,instr(l_str,'~')-1);   
      l_str := substr(l_str,instr(l_str,'~')+1);
      l_size:=substr(l_str,1,instr(l_str,'~')-1);  
       l_str := substr(l_str,instr(l_str,'~')+1); 
      l_pageno:=substr(l_str,1,instr(l_str,'~')-1);  
       l_str := substr(l_str,instr(l_str,'~')+1);
      l_status :=l_str;
     -- insert into abctest values(insertidm,'Str:'||l_status||':'||receiptnom||':'||editioncode||':'||pubcode||':'||insertidm||':'||compcodem||':'||cioidm||':'||l_date||':'||l_ed||':'||l_hight||':'||l_width||':'||l_size);
      tmpStr := substr(tmpStr,instr(tmpStr,'$')+1);
         select "Pub_Code","Edition_Code" into pubcode,editioncode from edition_mast where "Edition_Alias"=l_ed AND ROWNUM<=1;
   dbms_output.put_line('Str:'||l_date||':'||l_ed||':'||l_hight||':'||l_width||':'||l_size);
   insert into tbl_booking_subedition_g(COMP_CODE, CIOID, INSERTID, PUBLICATION, EDITION, INSERTDATE, HEIGHT, WIDTH, TOTALAREA, INSERTSTATUS,RECEIPTNO,SRNO,NO_INSERT,PAGE_NO) 
   values(compcodem,cioidm,insertidm,pubcode,editioncode,l_date,l_hight,l_width,l_size,l_status,receiptnom,SUBEDI_S.NEXTVAL,insertno,l_pageno);
  -- insert into 
   end loop;
 
else
 dbms_output.put_line('lata');
  INSERT INTO TEST1 VALUES('pubcodeMAIN',editioncodem);
       select "Pub_Code","City_Code" into pubcode,editioncode from edition_mast where trim("Edition_Code")=trim(editioncodem) and rownum<=1;
     -- insert into abctest values(pubcode,editioncode);
      dbms_output.put_line(pubcode);
       dbms_output.put_line(editioncode);
          dbms_output.put_line(pkgcode);
     select "Combin_Desc" into combinname from combin_mast where "Combin_Code"=pkgcode;
     select UOM_DESC into uomdesc from uom_mast where "Uom_Code"=(select Uom_code from tbl_booking_mast_g where cio_booking_id=cioidm);
      dbms_output.put_line(combinname);
     if instr(combinname,'+')<0 and uomdesc='CD' then
      INSERT INTO TEST1 VALUES(pubcode,editioncode);
     COMMIT;
     insert into tbl_booking_subedition_g(COMP_CODE, CIOID, INSERTID, PUBLICATION, EDITION, INSERTDATE, HEIGHT, WIDTH, TOTALAREA, INSERTSTATUS,RECEIPTNO,SRNO,NO_INSERT,PAGE_NO)
       select compcodem,cioidm,insertidm,"Pub_Code","Edition_Code",insertdatem,heightm,widthm,totaream,'cancel',receiptnom,SUBEDI_S.NEXTVAL,insertno,pageno
       from edition_mast where  "Pub_Code"=pubcode and "City_Code"=editioncode and "Edition_Type"='Edition';
    
     else
     dbms_output.put_line('lata111');
     insert into tbl_booking_subedition_g(COMP_CODE, CIOID, INSERTID, PUBLICATION, EDITION, INSERTDATE, HEIGHT, WIDTH, TOTALAREA, INSERTSTATUS,RECEIPTNO,SRNO,NO_INSERT,PAGE_NO)
       select compcodem,cioidm,insertidm,"Pub_Code","Edition_Code",insertdatem,heightm,widthm,totaream,'booked',receiptnom,SUBEDI_S.NEXTVAL,insertno,pageno
       from edition_mast where  "Pub_Code"=pubcode and "City_Code"=editioncode and "Edition_Type"='Edition';
     end if;
       
       
 
       end if;
         COMMIT;  
exception 
   when others then 
p_error_text :=sqlerrm;       
END insert_edition_details;
/
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PACKAGE insertintobookchild
IS
   TYPE t_accounts_cursor IS REF CURSOR;

   PROCEDURE  insertintobookchild_p (


    insertdate in date,
edition in varchar2,
premium1 in varchar2,
premium2 in varchar2,
premallow in varchar2,
adcategory in varchar2,
latestdate in date,
material in varchar2,
cardrate in number,
matfilename in varchar2,
discrate in number,
insertstatus in varchar2,
billstatus in varchar2,
adsubcat1 in varchar2,
compcode in varchar2,
userid in varchar2,
cioid in varchar2,
height in number,
width in number,
totalsize in number,
pagepost in varchar2,
premper1 in number,
premper2 in number,
colid in varchar2,
repeat in date,
insertno in int,
paid in varchar2,
agrrate in number,
solorate in number,
grossrate in number,
insert_pageno in number,
insert_remarks in varchar2,
page_code in varchar2,
page_per in number,
noofcol in number,
billamt in number,
billrate in number,
logo_h in varchar2,
logo_w in varchar2,
logo_name in varchar2,
ad_cat_3 in varchar2,
ad_cat_4 in varchar2,
ad_cat_5 in varchar2,
pkgcode in varchar2,
gridins in number,
pkgalias in varchar2,
cirvts in varchar2,
cirpub in varchar2,
ciredi in varchar2,
cirrate in varchar2,
cirdate_v in date, 
ciragency_v in varchar2,
 ciragencysubcode_v in varchar2, 
 center_v in varchar2,
  branch_v in varchar2,
  splitdata_v in varchar2,
  subedidata in varchar2,
  splboldsizevalue IN VARCHAR2,
  vatrate_p in float,
  boxcharge_p in float,
  vat_inc_p in varchar2,
  grossamtlocal_p in varchar2,
  billamtlocal_p in varchar2,
  sectioncode_p in varchar2,
  resourceno_p in varchar2,
  caption_inserts_p in varchar2,
    p_error out varchar2

   );
END insertintobookchild;
/

CREATE OR REPLACE PACKAGE BODY insertintobookchild
IS
   PROCEDURE insertintobookchild_p (
      insertdate           IN       DATE,
      edition              IN       VARCHAR2,
      premium1             IN       VARCHAR2,
      premium2             IN       VARCHAR2,
      premallow            IN       VARCHAR2,
      adcategory           IN       VARCHAR2,
      latestdate           IN       DATE,
      material             IN       VARCHAR2,
      cardrate             IN       NUMBER,
      matfilename          IN       VARCHAR2,
      discrate             IN       NUMBER,
      insertstatus         IN       VARCHAR2,
      billstatus           IN       VARCHAR2,
      adsubcat1            IN       VARCHAR2,
      compcode             IN       VARCHAR2,
      userid               IN       VARCHAR2,
      cioid                IN       VARCHAR2,
      height               IN       NUMBER,
      width                IN       NUMBER,
      totalsize            IN       NUMBER,
      pagepost             IN       VARCHAR2,
      premper1             IN       NUMBER,
      premper2             IN       NUMBER,
      colid                IN       VARCHAR2,
      repeat               IN       DATE,
      insertno             IN       INT,
      paid                 IN       VARCHAR2,
      agrrate              IN       NUMBER,
      solorate             IN       NUMBER,
      grossrate            IN       NUMBER,
      insert_pageno        IN       NUMBER,
      insert_remarks       IN       VARCHAR2,
      page_code            IN       VARCHAR2,
      page_per             IN       NUMBER,
      noofcol              IN       NUMBER,
      billamt              IN       NUMBER,
      billrate             IN       NUMBER,
      logo_h               IN       VARCHAR2,
      logo_w               IN       VARCHAR2,
      logo_name            IN       VARCHAR2,
      ad_cat_3             IN       VARCHAR2,
      ad_cat_4             IN       VARCHAR2,
      ad_cat_5             IN       VARCHAR2,
      pkgcode              IN       VARCHAR2,
      gridins              IN       NUMBER,
      pkgalias             IN       VARCHAR2,
      cirvts               IN       VARCHAR2,
      cirpub               IN       VARCHAR2,
      ciredi               IN       VARCHAR2,
      cirrate              IN       VARCHAR2,
      cirdate_v            IN       DATE,
      ciragency_v          IN       VARCHAR2,
      ciragencysubcode_v   IN       VARCHAR2,
      center_v             IN       VARCHAR2,
      branch_v             IN       VARCHAR2,
        splitdata_v          IN       VARCHAR2,
         subedidata in varchar2,
         splboldsizevalue IN VARCHAR2,
          vatrate_p in float,
            boxcharge_p in float,
            vat_inc_p in varchar2,
            grossamtlocal_p in varchar2,
            billamtlocal_p in varchar2,
            sectioncode_p in varchar2,
              resourceno_p in varchar2,
              caption_inserts_p in varchar2,
      p_error              OUT      VARCHAR2
   )
   AS
      edi           VARCHAR2 (50);
      publi         VARCHAR2 (50);
      pub_cent      VARCHAR2 (50);
      supp          VARCHAR2 (50);
      cou1          NUMBER;
      ID            NUMBER;
      insertidval   NUMBER;
      receiptno_m varchar2(50);
      error1 varchar2(100);
   BEGIN
    BEGIN
    select Receipt_no into receiptno_m from tbl_booking_mast_g where cio_booking_id=cioid and rownum<=1;
     EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            NULL;
      END;
      BEGIN
         SELECT COUNT (*)
           INTO cou1
           FROM edition_mast
          WHERE ("Edition_Alias" = edition) AND ("Comp_Code" = compcode);
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            NULL;
      END;

      IF (cou1 > 0)
      THEN
         BEGIN
            SELECT "Edition_Code"
              INTO edi
              FROM edition_mast
             WHERE ("Edition_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         BEGIN
            SELECT "Pub_Code"
              INTO publi
              FROM edition_mast
             WHERE ("Edition_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         BEGIN
            SELECT "City_Code"
              INTO pub_cent
              FROM edition_mast
             WHERE ("Edition_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         supp := '';
      ELSE
         BEGIN
            SELECT "Edition_Code"
              INTO edi
              FROM supplement_mast
             WHERE ("Supp_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         BEGIN
            SELECT "Pub_Code"
              INTO publi
              FROM supplement_mast
             WHERE ("Supp_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         BEGIN
            SELECT "Supp_Code"
              INTO supp
              FROM supplement_mast
             WHERE ("Supp_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         BEGIN
            SELECT "City_Code"
              INTO pub_cent
              FROM edition_mast
             WHERE ("Edition_Code" = edi)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;
      END IF;

      IF (supp IS NULL)
      THEN
         supp := 'MN';
      END IF;

--insertidval:=INSERTID.nextval;
      SELECT insertid.NEXTVAL
        INTO insertidval
        FROM DUAL;
        INSERT INTO tbl_booking_insert_G
                  (CIO_BOOKING_ID, EDITION, INSERT_DATE, COL_CODE,
                   HEIGHT, WIDTH, SIZE_BOOK, PAGE_POST, PREMIUM1,
                   PREM_PER1, PREMIUM2, PREM_PER2, PREMIUM_ALLOW,
                   AD_CAT, AD_SUB_CAT, LATEST_BY, STATUS_MATERIAL,
                   FILE_NAME, CARD_RATE, DISC_RATE, INSERT_STATUS,
                   BILL_STATUS, COMP_CODE, USERID, REPEATING_DATE,
                   NO_INSERT, EDITION_CODE, PUBLICATION_CODE,
                   PUB_CENT_CODE, SUPP_CODE, PAI_FREE_INS,
                   AGREED_RATE, SOLO_RATE, GROSS_RATE, PAGE_NO,
                   REMARKS, PAGE_PREM, PAGE_PER, NO_OFCOLUMN,
                   BILL_AMT, BILL_RATE, LOGO_H, LOGO_W, LOGO_NAME,
                   INSERT_ID, AD_SUBCAT3, AD_SUBCAT4, AD_SUBCAT5,
                   PACKAGE_CODE, INSERTS, PKG_ALIAS, SESID,SPECIAL_SIZE1,VATAMT,BOXCHARGE,VAT_INC,LOCALGROSSAMT, LOCALBILLAMT, SECTIONCODE, RESOURCE_NO,CAPTION
                  )
           VALUES (cioid, edition, insertdate, colid,
                   height, width, totalsize, pagepost, premium1,
                   premper1, premium2, premper2, premallow,
                   adcategory, adsubcat1, latestdate, material,
                   matfilename, cardrate, discrate, insertstatus,
                   billstatus, compcode, userid, repeat,
                   insertno, edi, publi,
                   pub_cent, supp, paid,
                   agrrate, solorate, grossrate, insert_pageno,
                   insert_remarks, page_code, page_per, noofcol,
                   billamt, billrate, logo_h, logo_w, logo_name,
                   insertidval, ad_cat_3, ad_cat_4, ad_cat_5,
                   pkgcode, gridins, pkgalias,USERENV ('sessionid'),splboldsizevalue,vatrate_p,boxcharge_p,vat_inc_p,grossamtlocal_p,billamtlocal_p,sectioncode_p,  resourceno_p,caption_inserts_p
                  );
                  insert_split_details(splitdata_v,receiptno_m,cioid,insertidval,error1);
                 INSERT INTO TEST1 VALUES(edition,'EDITION');
                 insert_edition_details(subedidata,receiptno_m,cioid,insertidval,compcode,edi,insertdate,height,width,totalsize,insertstatus,pkgcode,insertno,insert_pageno,error1);
                 commit;
                  --insert into abctest values(edition);
/*                 
      INSERT INTO tbl_booking_insert
                  ("Cio_Booking_Id", "Edition", "Insert_Date", "Col_Code",
                   "Height", "Width", "Size_Book", "Page_Post", "Premium1",
                   "Prem_Per1", "Premium2", "Prem_Per2", "Premium_Allow",
                   "Ad_Cat", "Ad_Sub_Cat", "Latest_By", "Status_Material",
                   "File_Name", "Card_Rate", "Disc_Rate", "Insert_Status",
                   "Bill_Status", "Comp_Code", "Userid", "Repeating_Date",
                   "No_Insert", "Edition_Code", "Publication_Code",
                   "Pub_Cent_Code", "Supp_Code", "Pai_Free_Ins",
                   "Agreed_Rate", "Solo_Rate", "Gross_Rate", "Page_No",
                   "Remarks", "Page_Prem", "Page_Per", "No_Ofcolumn",
                   "Bill_Amt", "Bill_Rate", "Logo_H", "Logo_W", "Logo_name",
                   "Insert_Id", "AD_SUBCAT3", "AD_SUBCAT4", "AD_SUBCAT5",
                   package_code, inserts, pkg_alias
                  )
           VALUES (cioid, edition, insertdate, colid,
                   height, width, totalsize, pagepost, premium1,
                   premper1, premium2, premper2, premallow,
                   adcategory, adsubcat1, latestdate, material,
                   matfilename, cardrate, discrate, insertstatus,
                   billstatus, compcode, userid, repeat,
                   insertno, edi, publi,
                   pub_cent, supp, paid,
                   agrrate, solorate, grossrate, insert_pageno,
                   insert_remarks, page_code, page_per, noofcol,
                   billamt, billrate, logo_h, logo_w, logo_name,
                   insertidval, ad_cat_3, ad_cat_4, ad_cat_5,
                   pkgcode, gridins, pkgalias
                  );
*/
      IF (cirvts IS NOT NULL)
      THEN
         INSERT INTO TBL_BOOKING_VTS_g
                     (compcode, cioid, insertid, vts, publication, edition,
                      rate, ciragcode, ciragsubcode, center,
                      branch, publishdate ,SESID
                     )
              VALUES (compcode, cioid, insertidval, cirvts, cirpub, ciredi,
                      cirrate, ciragency_v, ciragencysubcode_v, center_v,
                      branch_v, cirdate_v,USERENV ('sessionid')
                     );
      END IF;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_error := 'Error:' || SQLERRM;
   END insertintobookchild_p;
END insertintobookchild;
/
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PROCEDURE committransaction(
    pcioid          in  varchar2,
    totalcount      in  int,
    pcompcode       in  varchar2,
    pcentname       in  varchar2,
    puserid         in  varchar2,
    pbkid_gentype   in  varchar2,
    pbk_type        in  varchar2,
    p_error         OUT VARCHAR2,
    p_new_cioid     OUT VARCHAR2) is
    
countnum        int;
newid           varchar2(100);
billpay         varchar2(20);
rostatus        varchar2(20);
remarks         varchar2(500);
clientname      varchar2(200);
v_cursor1       TYPES.cursor_type;
v_cursor2       TYPES.cursor_type;

v_cursor1_var1  varchar2(50);
v_cursor1_var2  varchar2(50);
v_cursor2_var1  varchar2(50);

begin
newid:=pcioid;

select count(*) into countnum from tbl_booking_insert_g where Cio_Booking_Id=pcioid;
if(countnum=totalcount) then 
     
    
   getautocodebooking.getautocodebooking_p (compcode        =>  pcompcode,
                                            auto1           =>  '0',
                                            no1             =>  '0',
                                            p_accounts      =>  v_cursor1,
                                            p_accounts1     =>  v_cursor2);
                                            
    FETCH v_cursor1 INTO v_cursor1_var1, v_cursor1_var2;
    
    FETCH v_cursor2 INTO v_cursor2_var1;
    
    if  pbkid_gentype='1' then--1 for First 3 character of Centre Name+Year + Slno  
        
        newid:=substr(pcentname,1,3)||v_cursor1_var2||LPAD(v_cursor1_var1,8,'0');
    
    elsif  pbkid_gentype='2' then--2 for First 3 character of Centre Name+Year + Userid + Slno
    
        newid:=substr(pcentname,1,3)||v_cursor1_var2||LPAD(v_cursor1_var1,8,'0')||puserid;

    elsif  pbkid_gentype='4' then--BK Type + Slno

        newid:=pbk_type||LPAD(v_cursor1_var1,8,'0');

    else

        newid:=LPAD(v_cursor1_var1,8,'0');

    end if; 
    
    p_error     :='Y';
    p_new_cioid := newid;

    INSERT INTO tbladid_ins(CIOID,COUNTNUM,FLAG) VALUES(newid,countnum,p_error);
    INSERT INTO TBL_BOOKING_MAST("date_time", "branch", "booked_by", "cio_booking_id", "prev_booking", "applied_by", "audit", "RO_No", "RO_Date", "Caption", "bill_status", "ro_status", "Agency_code", "Agency_address", "Client_code", "Client_address", "Agency_sub_code", "Dockit_no", "Executive_code", "Executive_zone", "Product_code", "Brand_code", "Key_no", "Bill_remarks", "Print_remark", "Package_code", "No_of_insertion", "Insertion_date", "Repeating_day", "Ad_type_code", "Ad_cat_code", "Ad_sub_cat_code", "Color_code", "Uom_code", "Page_position_code", "Page_type_code", "Page_no", "Ad_size_type_code", "Ad_size_height", "Ad_size_width", "Rate_code", "Scheme_type_code", "Currency_code", "Agrred_rate", "Agreed_amount", "Special_discount", "Space_discount", "Special_charges", "Agency_status", "Agency_type", "Agency_pay", "Agency_credit", "Total_area", "Card_rate", "Card_amount", "Discount", "Discount_per", "Bill_cycle", "Revenue_center", "Bill_pay", "Bill_height", "Bill_width", "Bill_to", "Invoices", "Vts", "Bill_add", "Trade_disc", "Agency_out", "Box_code", "Box_no", "Box_agency", "Box_client", "Box_address", "Comp_code", "Userid", "Creation_datetime", "Booking_type", "Tfn", "Coupan_ad", "Campaign", "Bill_amount", "Page_prem", "Page_amount", "Prem_per", "Gross_amount", "Ad_size_column", "Bill_column", "Bill_area", "Special_disc_per", "Space_disc_per", "Paid_ins", "Contract_rate", "Deviation", "Variant_code", "Contract_name", "Contract_type", "Card_name", "Card_type", "Card_month", "Card_year", "Card_number", "Receipt_no", "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color", "Bullet_code", "Bullet_premium", "Material_status", "Receipt_date", "prev_cioid", "prev_receipt", "prev_grossamt", "Region", "Variant", "Colortype", "Logo_H", "Logo_W", "Logo_color", "Logo_Uom", "SAPID", "RETAINER", "ADD_AGENCY_COMM", "AUDIT_COMMENT", "MOBILENO", "ADD_AGENCY_COMM_AMT", "RETAINER_COMM", "RETAINER_COMM_AMT", "CASH_RECIEVED", "CONT_GROSS", "CIRAGENCY", "CIRRATE", "CIREDITION", "CIRPUBLICATION", "CIRAGENCY_SUBCODE", "BARTER_TYPE", "APP_STATUS", "APP_REMARKS", "APP_DATE", "APP_USER", "RODOCSTATUS",CASHDISCOUNT, CASHDISCTYPE, ATTACHMENT1, ATTACHMENT2,DISC_PREMIUM,DOCTYPE,CHKTRADEDISC,CHK_NO,CHK_DATE,CHK_AMT,CHK_BANK_NAME,OUR_BANK,DEALERPANEL, DEALER_H, DEALER_W, DEALERTYPE,ACTIVE_AGREEDRATE, ACTIVE_AGREEDAMT,LOCALGROSSAMT, LOCALBILLAMT, PACKAGE_TYPE, AD_REFID,RECEIPT_CURRENCY, CONV_CURR_RATE,REVISE_DATE,CLIENT_TYPE) 
    SELECT DATE_TIME, BRANCH, BOOKED_BY, newid CIO_BOOKING_ID, PREV_BOOKING, APPLIED_BY, AUDIT_G, RO_NO, RO_DATE, CAPTION, BILL_STATUS, RO_STATUS, AGENCY_CODE, AGENCY_ADDRESS, CLIENT_CODE, CLIENT_ADDRESS, AGENCY_SUB_CODE, DOCKIT_NO, EXECUTIVE_CODE, EXECUTIVE_ZONE, PRODUCT_CODE, BRAND_CODE, KEY_NO, BILL_REMARKS, PRINT_REMARK, PACKAGE_CODE, NO_OF_INSERTION, INSERTION_DATE, REPEATING_DAY, AD_TYPE_CODE, AD_CAT_CODE, AD_SUB_CAT_CODE, COLOR_CODE, UOM_CODE, PAGE_POSITION_CODE, PAGE_TYPE_CODE, PAGE_NO, AD_SIZE_TYPE_CODE, AD_SIZE_HEIGHT, AD_SIZE_WIDTH, RATE_CODE, SCHEME_TYPE_CODE, CURRENCY_CODE, AGRRED_RATE, AGREED_AMOUNT, SPECIAL_DISCOUNT, SPACE_DISCOUNT, SPECIAL_CHARGES, AGENCY_STATUS, AGENCY_TYPE, AGENCY_PAY, AGENCY_CREDIT, TOTAL_AREA, CARD_RATE, CARD_AMOUNT, DISCOUNT, DISCOUNT_PER, BILL_CYCLE, REVENUE_CENTER, BILL_PAY, BILL_HEIGHT, BILL_WIDTH, BILL_TO, INVOICES, VTS, BILL_ADD, TRADE_DISC, AGENCY_OUT, BOX_CODE, BOX_NO, BOX_AGENCY, BOX_CLIENT, BOX_ADDRESS, COMP_CODE, USERID, CREATION_DATETIME, BOOKING_TYPE, TFN, COUPAN_AD, CAMPAIGN, BILL_AMOUNT, PAGE_PREM, PAGE_AMOUNT, PREM_PER, GROSS_AMOUNT, AD_SIZE_COLUMN, BILL_COLUMN, BILL_AREA, SPECIAL_DISC_PER, SPACE_DISC_PER, PAID_INS, CONTRACT_RATE, DEVIATION, VARIANT_CODE, CONTRACT_NAME, CONTRACT_TYPE, CARD_NAME, CARD_TYPE, CARD_MONTH, CARD_YEAR, CARD_NUMBER, RECEIPT_NO, AD_SUBCAT3, AD_SUBCAT4, AD_SUBCAT5, BG_COLOR, BULLET_CODE, BULLET_PREMIUM, MATERIAL_STATUS, RECEIPT_DATE, PREV_CIOID, PREV_RECEIPT, PREV_GROSSAMT, REGION, VARIANT, COLORTYPE, LOGO_H, LOGO_W, LOGO_COLOR, LOGO_UOM, SAPID, RETAINER, ADD_AGENCY_COMM, AUDIT_COMMENT, MOBILENO, ADD_AGENCY_COMM_AMT, RETAINER_COMM, RETAINER_COMM_AMT, CASH_RECIEVED, CONT_GROSS, CIRAGENCY, CIRRATE, CIREDITION, CIRPUBLICATION, CIRAGENCY_SUBCODE, BARTER_TYPE, APP_STATUS, APP_REMARKS, APP_DATE, APP_USER, RODOCSTATUS,CASHDISCOUNT, CASHDISCTYPE, ATTACHMENT1, ATTACHMENT2, DISC_PREMIUM, DOCTYPE,CHKTRADEDISC,CHK_NO,CHK_DATE,CHK_AMT,CHK_BANK_NAME,OUR_BANK, DEALERPANEL, DEALER_H, DEALER_W, DEALERTYPE,ACTIVE_AGREEDRATE, ACTIVE_AGREEDAMT,LOCALGROSSAMT, LOCALBILLAMT, PACKAGE_TYPE, AD_REFID, RECEIPT_CURRENCY, CONV_CURR_RATE,REVISE_DATE,CLIENT_TYPE FROM TBL_BOOKING_MAST_G WHERE  CIO_BOOKING_ID=pcioid;

    INSERT INTO TBL_BOOKING_insert("Insert_Id", "Cio_Booking_Id", "No_Insert", "Edition_Code", "Publication_Code", "Pub_Cent_Code", "Supp_Code", "Edition", "Insert_Date", "Col_Code", "Height", "Width", "Size_Book", "Page_Post", "Premium1", "Prem_Per1", "Premium2", "Prem_Per2", "Premium_Allow", "Ad_Cat", "Ad_Sub_Cat", "Latest_By", "Repeating_Date", "Status_Material", "File_Name", "Card_Rate", "Disc_Rate", "Insert_Status", "Bill_Status", "Agreed_Rate", "Pai_Free_Ins", "Solo_Rate", "Gross_Rate", "Comp_Code", "Userid", "Page_No", "Remarks", "Pub_Height", "Pub_Width", "Page_Prem", "Page_Per", "No_Ofcolumn", "Bill_Amt", "Bill_Rate", "Logo_H", "Logo_W", "Logo_name", "AD_SUBCAT3", "AD_SUBCAT4", "AD_SUBCAT5", "PACKAGE_CODE", "BILL_NO", "BILL_DATE", "INSERTS", "PKG_ALIAS", "CONT_GROSS_AMT", "APP_STATUS", "APP_REMARKS", "APP_DATE", "APP_USER",SPECIAL_SIZE1,VATAMT,BOXCHARGE,VAT_INC,LOCALGROSSAMT, LOCALBILLAMT,SECTIONCODE,RESOURCE_NO,CAPTION) 
    SELECT INSERT_ID, newid CIO_BOOKING_ID, NO_INSERT, EDITION_CODE, PUBLICATION_CODE, PUB_CENT_CODE, SUPP_CODE, EDITION, INSERT_DATE, COL_CODE, HEIGHT, WIDTH, SIZE_BOOK, PAGE_POST, PREMIUM1, PREM_PER1, PREMIUM2, PREM_PER2, PREMIUM_ALLOW, AD_CAT, AD_SUB_CAT, LATEST_BY, REPEATING_DATE, STATUS_MATERIAL, FILE_NAME, CARD_RATE, DISC_RATE, INSERT_STATUS, BILL_STATUS, AGREED_RATE, PAI_FREE_INS, SOLO_RATE, GROSS_RATE, COMP_CODE, USERID, PAGE_NO, REMARKS, PUB_HEIGHT, PUB_WIDTH, PAGE_PREM, PAGE_PER, NO_OFCOLUMN, BILL_AMT, BILL_RATE, LOGO_H, LOGO_W, LOGO_NAME, AD_SUBCAT3, AD_SUBCAT4, AD_SUBCAT5, PACKAGE_CODE, BILL_NO, BILL_DATE, INSERTS, PKG_ALIAS, CONT_GROSS_AMT, APP_STATUS, APP_REMARKS, APP_DATE, APP_USER, SPECIAL_SIZE1,VATAMT, BOXCHARGE, VAT_INC,LOCALGROSSAMT, LOCALBILLAMT, SECTIONCODE, RESOURCE_NO,CAPTION FROM TBL_BOOKING_INSERT_G WHERE  CIO_BOOKING_ID=pcioid;

    INSERT INTO TBL_BOOKING_VTS(COMPCODE, CIOID, INSERTID, VTS, PUBLICATION, EDITION, RATE, CREATIONDATETIME, CIRAGCODE, CIRAGSUBCODE, CENTER, BRANCH, PUBLISHDATE) 
    SELECT COMPCODE, newid CIOID, INSERTID, VTS, PUBLICATION, EDITION, RATE, CREATIONDATETIME, CIRAGCODE, CIRAGSUBCODE, CENTER, BRANCH, PUBLISHDATE FROM TBL_BOOKING_VTS_G WHERE  cioid=pcioid;

    insert into tbl_booking_insert_sizesplit(CIOID, RECEIPTNO, INSERTID, INSERTDATE, HEIGHT, WIDTH, AREA, SRNO, CREATIONDATETIME)
    select newid CIOID, RECEIPTNO, INSERTID, INSERTDATE, HEIGHT, WIDTH, AREA, SRNO, CREATIONDATETIME from tbl_booking_insert_sizesplit_g where cioid=pcioid;

    --INSERT INTO ABCTEST VALUES(newid,counttest);
    insert into tbl_booking_subedition(COMP_CODE, CIOID, INSERTID, PUBLICATION, EDITION, INSERTDATE, HEIGHT, WIDTH, TOTALAREA, INSERTSTATUS, RECEIPTNO,SRNO, NO_INSERT,PAGE_NO)
    select COMP_CODE, newid CIOID, INSERTID, PUBLICATION, EDITION, INSERTDATE, HEIGHT, WIDTH, TOTALAREA, INSERTSTATUS, RECEIPTNO, SRNO, NO_INSERT,PAGE_NO from tbl_booking_subedition_g
    where tbl_booking_subedition_g.CIOID=pcioid;

    insert into TBL_BOOKING_SHARING_TRANS(PUBLICATION, TYPE, SHARING, CIOID, SRNO)
    select PUBLICATION, TYPE, SHARING, newid CIOID, SRNO from TBL_BOOKING_SHARING_TRANS_g where CIOID=pcioid ;

    insert into TBL_BOOKING_FMG_TRANS(CIOID, INSERTID, CREATIONDATETIME)
    select newid CIOID, INSERTID, CREATIONDATETIME from TBL_BOOKING_FMG_TRANS_G where CIOID=pcioid;
    
    update tbl_matter set "cioid"=newid where "cioid"=pcioid; 

    select "Bill_pay","ro_status" into billpay,rostatus from tbl_booking_mast where "cio_booking_id"=newid;

    if billpay = 'CA0' and rostatus='1' then
        declare
            cursor c1 is
            select * from tbl_booking_mast where "cio_booking_id"=newid;
        v1 c1%rowtype;

        v_error      varchar2(2000);
        v_rcptno_r   varchar2(50);
        vrecpt       varchar2(20);
        branchcode   varchar2(20);
        vrepcode     varchar2(20);
        subagencyreg varchar2(20);
        prevcioid_v  varchar2(50);
        billamt_v    float;
        grossamt_v   float;
        v_curdate     date;
    begin
        open c1;
            fetch c1 into v1;
        Begin
            select "Branch_Code" into branchcode from branch_mst where "Comp_Code"=v1."Comp_code" and "Branch_Name"=v1."branch";
        Exception When no_data_found then
            branchcode:=v1."branch";
        End;
   
        Begin
            select "SUB_Agency_Code" into subagencyreg from agency_mast where "Comp_Code"=v1."Comp_code" and "code_subcode"=v1."Agency_sub_code";
        Exception When no_data_found then
            subagencyreg:='';
        End;
        vrecpt       :=v1."Receipt_no";
        prevcioid_v  :=v1."prev_cioid";
        if prevcioid_v is null or v1."prev_receipt" is null then
            billamt_v   :=v1."Bill_amount";
            grossamt_v  :=v1."Gross_amount";
            v_curdate   :=to_date(sysdate);
        else
            select "Bill_amount","Gross_amount" into  billamt_v,grossamt_v from tbl_booking_mast where "cio_booking_id"=prevcioid_v;
            billamt_v   :=v1."Bill_amount" - billamt_v;
            grossamt_v :=v1."Gross_amount" - grossamt_v;
            IF grossamt_v=0 OR grossamt_v IS NULL THEN
                grossamt_v:=v1."Gross_amount";
            END IF;
            v_curdate  :=to_date(sysdate);
        end if;

        -- select substr(max("recptno"),1,12)||lpad(substr(max("recptno"),-6)+1,6,'0') into vrecpt from ad_rcpthdr where "unit"=branchcode and "doctype"='RCP' and
        -- "recptdt" between '1-mar-2011' and '31-mar-2011';
         
        --receiptsave_booking.receiptsave_booking_P(pcompcode,puserid , punit ,ptype , precpt , prdate , ppaymodres ,preceivedreg ,pvouno  ,pamount  ,pagency , pothercd ,
        --pchno  ,pchedate , pbank  , pnarration ,prep   , pvdate , pag_main_code ,pag_sub_code , ourbank,  cioid , execname , retainer ,
        -- prevcioid , p_error)
        begin
            SELECT "Cust_Name" into clientname FROM CUST_MAST WHERE "Cust_Code" = v1."Client_code" and "Comp_Code"=v1."Comp_code";
        exception when NO_DATA_FOUND THEN
            clientname:=v1."Client_code";
        END;

        remarks:='RONO#'||v1."RO_No" ||' RODATE# ' || to_char(v1."RO_Date",'dd-mon-yyyy') || ' BOOKINGID# ' || v1."cio_booking_id" || ' CLIENT#' || clientname;

        receiptsave_booking.receiptsave_booking_p(v1."Comp_code",v1."Userid", v1."branch",V1.DOCTYPE,vrecpt,v_curdate,v1."Bill_pay",'','',billamt_v,v1."Agency_sub_code",grossamt_v,
            '','','',remarks,vrepcode,v1."date_time",v1."Agency_code",subagencyreg,'',v1."cio_booking_id",v1."Executive_code",v1.RETAINER,v1."prev_cioid",v_rcptno_r,v_error);
   
        update tbl_booking_mast set "Receipt_no"=v_rcptno_r,"Receipt_date"= v_curdate where "cio_booking_id"=v1."cio_booking_id";
    close c1;
    commit;
 end;
 end if;
 /*
 INSERT INTO TBL_BOOKING_MAST("date_time", "branch", "booked_by", "cio_booking_id", "prev_booking", "applied_by", "audit", "RO_No", "RO_Date", "Caption", "bill_status", "ro_status", "Agency_code", "Agency_address", "Client_code", "Client_address", "Agency_sub_code", "Dockit_no", "Executive_code", "Executive_zone", "Product_code", "Brand_code", "Key_no", "Bill_remarks", "Print_remark", "Package_code", "No_of_insertion", "Insertion_date", "Repeating_day", "Ad_type_code", "Ad_cat_code", "Ad_sub_cat_code", "Color_code", "Uom_code", "Page_position_code", "Page_type_code", "Page_no", "Ad_size_type_code", "Ad_size_height", "Ad_size_width", "Rate_code", "Scheme_type_code", "Currency_code", "Agrred_rate", "Agreed_amount", "Special_discount", "Space_discount", "Special_charges", "Agency_status", "Agency_type", "Agency_pay", "Agency_credit", "Total_area", "Card_rate", "Card_amount", "Discount", "Discount_per", "Bill_cycle", "Revenue_center", "Bill_pay", "Bill_height", "Bill_width", "Bill_to", "Invoices", "Vts", "Bill_add", "Trade_disc", "Agency_out", "Box_code", "Box_no", "Box_agency", "Box_client", "Box_address", "Comp_code", "Userid", "Creation_datetime", "Booking_type", "Tfn", "Coupan_ad", "Campaign", "Bill_amount", "Page_prem", "Page_amount", "Prem_per", "Gross_amount", "Ad_size_column", "Bill_column", "Bill_area", "Special_disc_per", "Space_disc_per", "Paid_ins", "Contract_rate", "Deviation", "Variant_code", "Contract_name", "Contract_type", "Card_name", "Card_type", "Card_month", "Card_year", "Card_number", "Receipt_no", "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color", "Bullet_code", "Bullet_premium", "Material_status", "Receipt_date", "prev_cioid", "prev_receipt", "prev_grossamt", "Region", "Variant", "Colortype", "Logo_H", "Logo_W", "Logo_color", "Logo_Uom", "SAPID", "RETAINER", "ADD_AGENCY_COMM", "AUDIT_COMMENT", "MOBILENO", "ADD_AGENCY_COMM_AMT", "RETAINER_COMM", "RETAINER_COMM_AMT", "CASH_RECIEVED", "CONT_GROSS", "CIRAGENCY", "CIRRATE", "CIREDITION", "CIRPUBLICATION", "CIRAGENCY_SUBCODE", "BARTER_TYPE", "APP_STATUS", "APP_REMARKS", "APP_DATE", "APP_USER", "RODOCSTATUS") 
SELECT DATE_TIME, BRANCH, BOOKED_BY, CIO_BOOKING_ID, PREV_BOOKING, APPLIED_BY, AUDIT_G, RO_NO, RO_DATE, CAPTION, BILL_STATUS, RO_STATUS, AGENCY_CODE, AGENCY_ADDRESS, CLIENT_CODE, CLIENT_ADDRESS, AGENCY_SUB_CODE, DOCKIT_NO, EXECUTIVE_CODE, EXECUTIVE_ZONE, PRODUCT_CODE, BRAND_CODE, KEY_NO, BILL_REMARKS, PRINT_REMARK, PACKAGE_CODE, NO_OF_INSERTION, INSERTION_DATE, REPEATING_DAY, AD_TYPE_CODE, AD_CAT_CODE, AD_SUB_CAT_CODE, COLOR_CODE, UOM_CODE, PAGE_POSITION_CODE, PAGE_TYPE_CODE, PAGE_NO, AD_SIZE_TYPE_CODE, AD_SIZE_HEIGHT, AD_SIZE_WIDTH, RATE_CODE, SCHEME_TYPE_CODE, CURRENCY_CODE, AGRRED_RATE, AGREED_AMOUNT, SPECIAL_DISCOUNT, SPACE_DISCOUNT, SPECIAL_CHARGES, AGENCY_STATUS, AGENCY_TYPE, AGENCY_PAY, AGENCY_CREDIT, TOTAL_AREA, CARD_RATE, CARD_AMOUNT, DISCOUNT, DISCOUNT_PER, BILL_CYCLE, REVENUE_CENTER, BILL_PAY, BILL_HEIGHT, BILL_WIDTH, BILL_TO, INVOICES, VTS, BILL_ADD, TRADE_DISC, AGENCY_OUT, BOX_CODE, BOX_NO, BOX_AGENCY, BOX_CLIENT, BOX_ADDRESS, COMP_CODE, USERID, CREATION_DATETIME, BOOKING_TYPE, TFN, COUPAN_AD, CAMPAIGN, BILL_AMOUNT, PAGE_PREM, PAGE_AMOUNT, PREM_PER, GROSS_AMOUNT, AD_SIZE_COLUMN, BILL_COLUMN, BILL_AREA, SPECIAL_DISC_PER, SPACE_DISC_PER, PAID_INS, CONTRACT_RATE, DEVIATION, VARIANT_CODE, CONTRACT_NAME, CONTRACT_TYPE, CARD_NAME, CARD_TYPE, CARD_MONTH, CARD_YEAR, CARD_NUMBER, RECEIPT_NO, AD_SUBCAT3, AD_SUBCAT4, AD_SUBCAT5, BG_COLOR, BULLET_CODE, BULLET_PREMIUM, MATERIAL_STATUS, RECEIPT_DATE, PREV_CIOID, PREV_RECEIPT, PREV_GROSSAMT, REGION, VARIANT, COLORTYPE, LOGO_H, LOGO_W, LOGO_COLOR, LOGO_UOM, SAPID, RETAINER, ADD_AGENCY_COMM, AUDIT_COMMENT, MOBILENO, ADD_AGENCY_COMM_AMT, RETAINER_COMM, RETAINER_COMM_AMT, CASH_RECIEVED, CONT_GROSS, CIRAGENCY, CIRRATE, CIREDITION, CIRPUBLICATION, CIRAGENCY_SUBCODE, BARTER_TYPE, APP_STATUS, APP_REMARKS, APP_DATE, APP_USER, RODOCSTATUS FROM TBL_BOOKING_MAST_G WHERE SESID=USERENV ('sessionid') and CIO_BOOKING_ID=cioid;

INSERT INTO TBL_BOOKING_insert("Insert_Id", "Cio_Booking_Id", "No_Insert", "Edition_Code", "Publication_Code", "Pub_Cent_Code", "Supp_Code", "Edition", "Insert_Date", "Col_Code", "Height", "Width", "Size_Book", "Page_Post", "Premium1", "Prem_Per1", "Premium2", "Prem_Per2", "Premium_Allow", "Ad_Cat", "Ad_Sub_Cat", "Latest_By", "Repeating_Date", "Status_Material", "File_Name", "Card_Rate", "Disc_Rate", "Insert_Status", "Bill_Status", "Agreed_Rate", "Pai_Free_Ins", "Solo_Rate", "Gross_Rate", "Comp_Code", "Userid", "Page_No", "Remarks", "Pub_Height", "Pub_Width", "Page_Prem", "Page_Per", "No_Ofcolumn", "Bill_Amt", "Bill_Rate", "Logo_H", "Logo_W", "Logo_name", "AD_SUBCAT3", "AD_SUBCAT4", "AD_SUBCAT5", "PACKAGE_CODE", "BILL_NO", "BILL_DATE", "INSERTS", "PKG_ALIAS", "CONT_GROSS_AMT", "APP_STATUS", "APP_REMARKS", "APP_DATE", "APP_USER") 
SELECT INSERT_ID, CIO_BOOKING_ID, NO_INSERT, EDITION_CODE, PUBLICATION_CODE, PUB_CENT_CODE, SUPP_CODE, EDITION, INSERT_DATE, COL_CODE, HEIGHT, WIDTH, SIZE_BOOK, PAGE_POST, PREMIUM1, PREM_PER1, PREMIUM2, PREM_PER2, PREMIUM_ALLOW, AD_CAT, AD_SUB_CAT, LATEST_BY, REPEATING_DATE, STATUS_MATERIAL, FILE_NAME, CARD_RATE, DISC_RATE, INSERT_STATUS, BILL_STATUS, AGREED_RATE, PAI_FREE_INS, SOLO_RATE, GROSS_RATE, COMP_CODE, USERID, PAGE_NO, REMARKS, PUB_HEIGHT, PUB_WIDTH, PAGE_PREM, PAGE_PER, NO_OFCOLUMN, BILL_AMT, BILL_RATE, LOGO_H, LOGO_W, LOGO_NAME, AD_SUBCAT3, AD_SUBCAT4, AD_SUBCAT5, PACKAGE_CODE, BILL_NO, BILL_DATE, INSERTS, PKG_ALIAS, CONT_GROSS_AMT, APP_STATUS, APP_REMARKS, APP_DATE, APP_USER FROM TBL_BOOKING_INSERT_G WHERE SESID=USERENV ('sessionid') and CIO_BOOKING_ID=cioid;

*/
else
rollback;
 p_error        :=  'N';
 p_new_cioid    :=  newid;
--DELETE FROM TBL_BOOKING_INSERT WHERE "Cio_Booking_Id"=cioid;
--DELETE FROM TBL_BOOKING_mast WHERE "cio_booking_id"=cioid;
INSERT INTO tbladid_ins(CIOID,COUNTNUM,FLAG) VALUES(newid,countnum,p_error);
end if;
--delete from tbl_booking_mast_g where  CIO_BOOKING_ID=cioid;
--delete from tbl_booking_insert_g where  CIO_BOOKING_ID=cioid;
--delete from tbl_booking_vts_g where  cioid=newid;
end;
/

//==================================************End*********************==================//

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@bullet master end@@@@@@@@@@@@@@@@@@@@@@@@@

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@28/01/2012@@@@@@@@@@@@@@@@@@@@@@@@@@@

//==============*********************Start Scripting****************==================//
CREATE OR REPLACE PACKAGE insertintobookchild
IS
   TYPE t_accounts_cursor IS REF CURSOR;

   PROCEDURE  insertintobookchild_p (


    insertdate in date,
edition in varchar2,
premium1 in varchar2,
premium2 in varchar2,
premallow in varchar2,
adcategory in varchar2,
latestdate in date,
material in varchar2,
cardrate in number,
matfilename in varchar2,
discrate in number,
insertstatus in varchar2,
billstatus in varchar2,
adsubcat1 in varchar2,
compcode in varchar2,
userid in varchar2,
cioid in varchar2,
height in number,
width in number,
totalsize in number,
pagepost in varchar2,
premper1 in number,
premper2 in number,
colid in varchar2,
repeat in date,
insertno in int,
paid in varchar2,
agrrate in number,
solorate in number,
grossrate in number,
insert_pageno in number,
insert_remarks in varchar2,
page_code in varchar2,
page_per in number,
noofcol in number,
billamt in number,
billrate in number,
logo_h in varchar2,
logo_w in varchar2,
logo_name in varchar2,
ad_cat_3 in varchar2,
ad_cat_4 in varchar2,
ad_cat_5 in varchar2,
pkgcode in varchar2,
gridins in number,
pkgalias in varchar2,
cirvts in varchar2,
cirpub in varchar2,
ciredi in varchar2,
cirrate in varchar2,
cirdate_v in date, 
ciragency_v in varchar2,
 ciragencysubcode_v in varchar2, 
 center_v in varchar2,
  branch_v in varchar2,
  splitdata_v in varchar2,
  subedidata in varchar2,
  splboldsizevalue IN VARCHAR2,
  vatrate_p in float,
  boxcharge_p in float,
  vat_inc_p in varchar2,
  grossamtlocal_p in varchar2,
  billamtlocal_p in varchar2,
  sectioncode_p in varchar2,
  resourceno_p in varchar2,
  caption_inserts_p in varchar2,
    p_error out varchar2

   );
END insertintobookchild;
/

CREATE OR REPLACE PACKAGE BODY insertintobookchild
IS
   PROCEDURE insertintobookchild_p (
      insertdate           IN       DATE,
      edition              IN       VARCHAR2,
      premium1             IN       VARCHAR2,
      premium2             IN       VARCHAR2,
      premallow            IN       VARCHAR2,
      adcategory           IN       VARCHAR2,
      latestdate           IN       DATE,
      material             IN       VARCHAR2,
      cardrate             IN       NUMBER,
      matfilename          IN       VARCHAR2,
      discrate             IN       NUMBER,
      insertstatus         IN       VARCHAR2,
      billstatus           IN       VARCHAR2,
      adsubcat1            IN       VARCHAR2,
      compcode             IN       VARCHAR2,
      userid               IN       VARCHAR2,
      cioid                IN       VARCHAR2,
      height               IN       NUMBER,
      width                IN       NUMBER,
      totalsize            IN       NUMBER,
      pagepost             IN       VARCHAR2,
      premper1             IN       NUMBER,
      premper2             IN       NUMBER,
      colid                IN       VARCHAR2,
      repeat               IN       DATE,
      insertno             IN       INT,
      paid                 IN       VARCHAR2,
      agrrate              IN       NUMBER,
      solorate             IN       NUMBER,
      grossrate            IN       NUMBER,
      insert_pageno        IN       NUMBER,
      insert_remarks       IN       VARCHAR2,
      page_code            IN       VARCHAR2,
      page_per             IN       NUMBER,
      noofcol              IN       NUMBER,
      billamt              IN       NUMBER,
      billrate             IN       NUMBER,
      logo_h               IN       VARCHAR2,
      logo_w               IN       VARCHAR2,
      logo_name            IN       VARCHAR2,
      ad_cat_3             IN       VARCHAR2,
      ad_cat_4             IN       VARCHAR2,
      ad_cat_5             IN       VARCHAR2,
      pkgcode              IN       VARCHAR2,
      gridins              IN       NUMBER,
      pkgalias             IN       VARCHAR2,
      cirvts               IN       VARCHAR2,
      cirpub               IN       VARCHAR2,
      ciredi               IN       VARCHAR2,
      cirrate              IN       VARCHAR2,
      cirdate_v            IN       DATE,
      ciragency_v          IN       VARCHAR2,
      ciragencysubcode_v   IN       VARCHAR2,
      center_v             IN       VARCHAR2,
      branch_v             IN       VARCHAR2,
        splitdata_v          IN       VARCHAR2,
         subedidata in varchar2,
         splboldsizevalue IN VARCHAR2,
          vatrate_p in float,
            boxcharge_p in float,
            vat_inc_p in varchar2,
            grossamtlocal_p in varchar2,
            billamtlocal_p in varchar2,
            sectioncode_p in varchar2,
              resourceno_p in varchar2,
              caption_inserts_p in varchar2,
      p_error              OUT      VARCHAR2
   )
   AS
      edi           VARCHAR2 (50);
      publi         VARCHAR2 (50);
      pub_cent      VARCHAR2 (50);
      supp          VARCHAR2 (50);
      cou1          NUMBER;
      ID            NUMBER;
      insertidval   NUMBER;
      receiptno_m varchar2(50);
      error1 varchar2(100);
   BEGIN
    BEGIN
    select Receipt_no into receiptno_m from tbl_booking_mast_g where cio_booking_id=cioid and rownum<=1;
     EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            NULL;
      END;
      BEGIN
         SELECT COUNT (*)
           INTO cou1
           FROM edition_mast
          WHERE ("Edition_Alias" = edition) AND ("Comp_Code" = compcode);
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            NULL;
      END;

      IF (cou1 > 0)
      THEN
         BEGIN
            SELECT "Edition_Code"
              INTO edi
              FROM edition_mast
             WHERE ("Edition_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         BEGIN
            SELECT "Pub_Code"
              INTO publi
              FROM edition_mast
             WHERE ("Edition_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         BEGIN
            SELECT "City_Code"
              INTO pub_cent
              FROM edition_mast
             WHERE ("Edition_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         supp := '';
      ELSE
         BEGIN
            SELECT "Edition_Code"
              INTO edi
              FROM supplement_mast
             WHERE ("Supp_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         BEGIN
            SELECT "Pub_Code"
              INTO publi
              FROM supplement_mast
             WHERE ("Supp_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         BEGIN
            SELECT "Supp_Code"
              INTO supp
              FROM supplement_mast
             WHERE ("Supp_Alias" = edition)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;

         BEGIN
            SELECT "City_Code"
              INTO pub_cent
              FROM edition_mast
             WHERE ("Edition_Code" = edi)
               AND ("Comp_Code" = compcode)
               AND ROWNUM <= 1;
         EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
               NULL;
         END;
      END IF;

      IF (supp IS NULL)
      THEN
         supp := 'MN';
      END IF;

--insertidval:=INSERTID.nextval;
      SELECT insertid.NEXTVAL
        INTO insertidval
        FROM DUAL;
        INSERT INTO tbl_booking_insert_G
                  (CIO_BOOKING_ID, EDITION, INSERT_DATE, COL_CODE,
                   HEIGHT, WIDTH, SIZE_BOOK, PAGE_POST, PREMIUM1,
                   PREM_PER1, PREMIUM2, PREM_PER2, PREMIUM_ALLOW,
                   AD_CAT, AD_SUB_CAT, LATEST_BY, STATUS_MATERIAL,
                   FILE_NAME, CARD_RATE, DISC_RATE, INSERT_STATUS,
                   BILL_STATUS, COMP_CODE, USERID, REPEATING_DATE,
                   NO_INSERT, EDITION_CODE, PUBLICATION_CODE,
                   PUB_CENT_CODE, SUPP_CODE, PAI_FREE_INS,
                   AGREED_RATE, SOLO_RATE, GROSS_RATE, PAGE_NO,
                   REMARKS, PAGE_PREM, PAGE_PER, NO_OFCOLUMN,
                   BILL_AMT, BILL_RATE, LOGO_H, LOGO_W, LOGO_NAME,
                   INSERT_ID, AD_SUBCAT3, AD_SUBCAT4, AD_SUBCAT5,
                   PACKAGE_CODE, INSERTS, PKG_ALIAS, SESID,SPECIAL_SIZE1,VATAMT,BOXCHARGE,VAT_INC,LOCALGROSSAMT, LOCALBILLAMT, SECTIONCODE, RESOURCE_NO,CAPTION
                  )
           VALUES (cioid, edition, insertdate, colid,
                   height, width, totalsize, pagepost, premium1,
                   premper1, premium2, premper2, premallow,
                   adcategory, adsubcat1, latestdate, material,
                   matfilename, cardrate, discrate, insertstatus,
                   billstatus, compcode, userid, repeat,
                   insertno, edi, publi,
                   pub_cent, supp, paid,
                   agrrate, solorate, grossrate, insert_pageno,
                   insert_remarks, page_code, page_per, noofcol,
                   billamt, billrate, logo_h, logo_w, logo_name,
                   insertidval, ad_cat_3, ad_cat_4, ad_cat_5,
                   pkgcode, gridins, pkgalias,USERENV ('sessionid'),splboldsizevalue,vatrate_p,boxcharge_p,vat_inc_p,grossamtlocal_p,billamtlocal_p,sectioncode_p,  resourceno_p,caption_inserts_p
                  );
                  insert_split_details(splitdata_v,receiptno_m,cioid,insertidval,error1);
                 INSERT INTO TEST1 VALUES(edition,'EDITION');
                 insert_edition_details(subedidata,receiptno_m,cioid,insertidval,compcode,edi,insertdate,height,width,totalsize,insertstatus,pkgcode,insertno,insert_pageno,error1);
                 commit;
                  --insert into abctest values(edition);
/*                 
      INSERT INTO tbl_booking_insert
                  ("Cio_Booking_Id", "Edition", "Insert_Date", "Col_Code",
                   "Height", "Width", "Size_Book", "Page_Post", "Premium1",
                   "Prem_Per1", "Premium2", "Prem_Per2", "Premium_Allow",
                   "Ad_Cat", "Ad_Sub_Cat", "Latest_By", "Status_Material",
                   "File_Name", "Card_Rate", "Disc_Rate", "Insert_Status",
                   "Bill_Status", "Comp_Code", "Userid", "Repeating_Date",
                   "No_Insert", "Edition_Code", "Publication_Code",
                   "Pub_Cent_Code", "Supp_Code", "Pai_Free_Ins",
                   "Agreed_Rate", "Solo_Rate", "Gross_Rate", "Page_No",
                   "Remarks", "Page_Prem", "Page_Per", "No_Ofcolumn",
                   "Bill_Amt", "Bill_Rate", "Logo_H", "Logo_W", "Logo_name",
                   "Insert_Id", "AD_SUBCAT3", "AD_SUBCAT4", "AD_SUBCAT5",
                   package_code, inserts, pkg_alias
                  )
           VALUES (cioid, edition, insertdate, colid,
                   height, width, totalsize, pagepost, premium1,
                   premper1, premium2, premper2, premallow,
                   adcategory, adsubcat1, latestdate, material,
                   matfilename, cardrate, discrate, insertstatus,
                   billstatus, compcode, userid, repeat,
                   insertno, edi, publi,
                   pub_cent, supp, paid,
                   agrrate, solorate, grossrate, insert_pageno,
                   insert_remarks, page_code, page_per, noofcol,
                   billamt, billrate, logo_h, logo_w, logo_name,
                   insertidval, ad_cat_3, ad_cat_4, ad_cat_5,
                   pkgcode, gridins, pkgalias
                  );
*/
      IF (cirvts IS NOT NULL)
      THEN
         INSERT INTO TBL_BOOKING_VTS_g
                     (compcode, cioid, insertid, vts, publication, edition,
                      rate, ciragcode, ciragsubcode, center,
                      branch, publishdate ,SESID
                     )
              VALUES (compcode, cioid, insertidval, cirvts, cirpub, ciredi,
                      cirrate, ciragency_v, ciragencysubcode_v, center_v,
                      branch_v, cirdate_v,USERENV ('sessionid')
                     );
      END IF;
   EXCEPTION
      WHEN OTHERS
      THEN
         p_error := 'Error:' || SQLERRM;
   END insertintobookchild_p;
END insertintobookchild;
/


//==================================************End*********************==================//


***************************************************start issue no:6305****************************************************
CREATE OR REPLACE procedure rpt_vts_report
(pagency_code in varchar2,
pclient_code in varchar2,
pfrom_date in varchar2,
pto_date in varchar2,
pdateformat in varchar2,
ppublication in varchar2,
pedition in varchar2,
ppub_center in varchar2,
pbranch in varchar2,
pcompcode in varchar2,
puserid in varchar2,
chk_access in varchar2,
clienttype in varchar2,
pextra1 in varchar2,
pextra2 in varchar2,
p_accounts OUT Cur_Type_New1.cursor_type
)
is 
query1 varchar2(8000);
v_frdt date;
v_todt date; 
begin

--v_frdt :=to_date(pfrom_date,pdateformat);
--v_todt :=to_date(pto_date,pdateformat);


v_frdt :=pfrom_date;
v_todt :=pto_date;


query1:=query1|| 'select 
c."Agency_Name" AS "AGENCY",
nvl((SELECT "Cust_Name" FROM  CUST_MAST WHERE a."Comp_code"= CUST_MAST."Comp_Code" AND "Cust_Code"="Client_code"),"Client_code")  AS "CLIENT", 
b."Edition" as "EDITION",
to_char("Insert_Date",'''||pdateformat||''') AS "PUB_DATE" ,
a."No_of_insertion",
nvl(a."Agrred_rate",a."Card_rate" ) AS "RATE",
(select "Comp_Name" from  comp_mst where comp_mst."Comp_Code"=a."Comp_code") comp_name
from  tbl_booking_mast a, tbl_booking_insert b, agency_mast c
WHERE a."Comp_code"='''||pcompcode||''' AND
a."Agency_sub_code"=c."code_subcode" AND
a."cio_booking_id"=b."Cio_Booking_Id"  
and
 ((b."Pub_Cent_Code" in (select distinct pub_center from  login_center where newuser_id='''||puserid||''') and '''||chk_access||'''=''1'')
or  ('''||chk_access||'''=''0'') )
';



IF(pfrom_date IS NOT NULL AND pto_date IS NOT NULL)
then
query1:=query1||' and b."Insert_Date" between  '''||v_frdt ||''' and  '''||v_todt||''' ';
END if;


IF(pagency_code IS NOT NULL )
then
query1:=query1||' and a."Agency_code" =  '''||pagency_code||''' ';
END if;

IF(pclient_code IS NOT NULL )
then
query1:=query1||' and a."Client_code"='''||pclient_code ||'''';
END if;

IF(ppublication IS NOT NULL )
then
query1:=query1||' and  b."Publication_Code"='''||ppublication||'''';
END if;

IF(ppub_center IS NOT NULL )
then
query1:=query1||'  and b."Pub_Cent_Code"='''||ppub_center||'''';
END if;

IF(pedition IS NOT NULL )
then
query1:=query1||'  and b."Edition_Code"='''||pedition||'''';
END if;

IF(pbranch IS NOT NULL )
then
query1:=query1||'  and a."branch"='''||pbranch||'''';
END if;


  if (clienttype is not null or clienttype<>'') then
      if clienttype = 'R' then
         query1:=query1||'  and "Client_code" in (select "Cust_Code" from  cust_mast where "Comp_Code" = '''||pcompcode||''''||'and "Cust_Status"=''ACTIVE'')';
      else if clienttype = 'N' then
         query1:=query1||'  and "Client_code" not in (select "Cust_Code" from  cust_mast where "Comp_Code = '''||pcompcode||''''||'and "Cust_Status"=''ACTIVE'')';
      else
         query1:=query1;
      end if;
      end if;
   end if; 

--insert into test1 (vstring) values (query1);commit;


open p_accounts for 
query1;


--DELETE  FROM SEARCHTBL;
--INSERT INTO SEARCHTBL VALUES('PK'||query1);
--COMMIT;

end rpt_vts_report;
/





******************************************************end issue no:6305******************************************


@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@6547@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

//==============*********************Start Scripting****************==================//
CREATE OR REPLACE PROCEDURE bookingdetailgrid (
      cioid     IN       VARCHAR2,
     P_Accounts OUT Cur_Type_New1.cursor_type

   )
is
newcioid varchar2(50);
countmatter number;
countinsert number;
filename varchar2(50);
BEGIN
newcioid:=cioid;
select count(*) into countmatter from tbl_matter where "cioid"=newcioid;
select count(*) into countinsert from tbl_booking_insert where "Cio_Booking_Id"=cioid and "File_Name" is not null;
if countmatter>countinsert then
    select "matter_filename" into filename from tbl_matter where "cioid"=newcioid and rownum<=1;
    update tbl_booking_insert set "File_Name"=filename where "Cio_Booking_Id"=cioid;
    commit;
end if;
OPEN p_Accounts FOR
select "No_Insert",
(select "pub_alias" from pub_mast where "Pub_Code"=tbl_booking_insert."Publication_Code") as Publication,
"Pub_Cent_Code" as Center,
"Edition",to_char("Insert_Date",'dd-mon-yyyy') as "Insert_Date","Col_Code","Page_No","Size_Book",
(select "Adv_Cat_Alias" from adv_cat_mast where "Adv_Cat_Code"=tbl_booking_insert."Ad_Cat" ) as AdCategory,
(select "Adv_Subcat_Alias" from adv_subcat_mast where "Adv_Subcat_Code"=tbl_booking_insert."Ad_Sub_Cat") as AdSubcategory,
"File_Name","Insert_Status",
case "Pai_Free_Ins"
when 'Y' then 'Yes'
when 'N' then 'No'
end as "Pai_Free_Ins"
,nvl("Gross_Rate",'0') as "Gross_Rate","Bill_Amt",BILL_NO,
SECTIONCODE,RESOURCE_NO,"Remarks",CAPTION



from tbl_booking_insert where "Cio_Booking_Id"=cioid order by "Insert_Id";


END ;
/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PACKAGE websp_bindaudit
IS
   TYPE t_accounts_cursor IS REF CURSOR;

   PROCEDURE websp_bindaudit_p(
fromdate IN varchar2,
todate IN varchar2,
date1 IN varchar2,
branch IN varchar2,
adtype IN varchar2,
publication in varchar2,
pub_cent in varchar2,
edition in varchar2,
agency in varchar2,
client in varchar2,
branchnew in varchar,
v_retainer in varchar,
v_executive in varchar,
v_supplement in varchar,
v_insert_status in varchar,
p_accounts   OUT      t_accounts_cursor
   );
END websp_bindaudit;
/

CREATE OR REPLACE PACKAGE BODY websp_bindaudit
IS
   PROCEDURE websp_bindaudit_p (
fromdate IN varchar2,
todate IN varchar2,
date1 IN varchar2,
branch IN varchar2,
adtype IN varchar2,
publication in varchar2,
pub_cent in varchar2,
edition in varchar2,
agency in varchar2,
client in varchar2,
branchnew in varchar,
v_retainer in varchar,
v_executive in varchar,
v_supplement in varchar,
v_insert_status in varchar,
p_accounts   OUT      t_accounts_cursor
   )




IS



query1 VARCHAR2(10000);

BEGIN

query1:='select tbl_booking_insert."Cio_Booking_Id" as "cio_booking_id",
"No_Insert" as "no_of_insertion" ,
"Edition"  as "edition",
nvl((select distinct cust_mast."Cust_Alias" from cust_mast  where  cust_mast."Cust_Code"=tbl_booking_mast."Client_code"),"Client_code") as "client",
AGENCY_MAST."Agency_Name" as "Agency",
tbl_booking_mast."Gross_amount" as "gross_amount",
tbl_booking_insert ."Insert_Status" as "status",
CASE ''date1''
 WHEN ''mm/dd/yyyy'' THEN TO_CHAR("Insert_Date",''mm/dd/yyyy'')
WHEN ''dd/mm/yyyy'' THEN TO_CHAR("Insert_Date",''dd/mm/yyyy'')
WHEN ''yyyy/mm/dd'' THEN TO_CHAR("Insert_Date",''yyyy/mm/dd'')  END AS "Ins.date",
tbl_booking_mast."RO_No",
COL_MAST."Col_Alias" as "Col_Name",
tbl_booking_insert ."Size_Book",
tbl_booking_insert."Agreed_Rate",
tbl_booking_insert."Bill_Amt",
tbl_booking_insert."Height", "Width"
from tbl_booking_insert,
tbl_booking_mast,
COL_MAST,
agency_mast where tbl_booking_mast."cio_booking_id"=tbl_booking_insert."Cio_Booking_Id"  and
 TBL_BOOKING_MAST."Color_code"=COL_MAST."Col_Code"  AND
 agency_mast."code_subcode"=tbl_booking_mast."Agency_sub_code"';



/*and "Insert_Date"  between fromdate and todate and "Ad_type_code"='''||adtype||'''

AND  (TBL_BOOKING_INSERT."Publication_Code"=publication OR publication IS NULL)
AND (TBL_BOOKING_INSERT."Pub_Cent_Code" =pub_cent OR pub_cent IS NULL)
AND (TBL_BOOKING_INSERT  ."Edition_Code"=edition OR  edition IS NULL)
AND (TBL_BOOKING_MAST."Agency_code" =agency OR agency  IS NULL)
AND (TBL_BOOKING_MAST."Client_code" =client OR client  IS NULL)
AND (TBL_BOOKING_MAST ."branch" =branchnew OR branchnew  IS NULL)
AND (TBL_BOOKING_insert."Supp_Code" =v_supplement OR v_supplement  IS NULL)
AND (TBL_BOOKING_MAST ."RETAINER" =v_retainer OR v_retainer  IS NULL)
AND (TBL_BOOKING_MAST  ."Executive_code" =v_executive OR v_executive  IS NULL)';*/






if(v_insert_status is not null)
then
query1:=query1 ||' AND TBL_BOOKING_insert. "Insert_Status" ='''||v_insert_status||''' ';
end if;





if(v_insert_status is  null)
then
query1:=query1 ||' AND TBL_BOOKING_insert. "Insert_Status" in (''publish'',''audit by rate'') ';
end if;



IF(v_retainer   IS NOT NULL)
THEN
query1:=query1||'  and tbl_booking_mast ."RETAINER"='''||v_retainer ||'''';
END IF;


IF(v_executive  IS NOT NULL)
THEN
query1:=query1||'  and tbl_booking_mast ."Executive_code"='''||v_executive||'''';
END IF;











IF(v_supplement  IS NOT NULL)
THEN
query1:=query1||'  and TBL_BOOKING_insert ."Supp_Code"='''||v_supplement||'''';
END IF;





IF(branchnew  IS NOT NULL)
THEN
query1:=query1||'  and tbl_booking_mast ."branch"='''||branchnew||'''';
END IF;



IF(client IS NOT NULL)
THEN
query1:=query1||'  and tbl_booking_mast ."Client_code"='''||client||'''';
END IF;



IF(pub_cent IS NOT NULL)
THEN
query1:=query1||'  and tbl_booking_insert."Pub_Cent_Code"='''||pub_cent||'''';
END IF;



IF(agency IS NOT NULL)
THEN
query1:=query1 ||' and TBL_BOOKING_MAST."Agency_code" ='''||agency ||'''';
END IF;







IF(publication IS NOT NULL)
THEN
query1:=query1||' and  TBL_BOOKING_insert."Publication_Code"='''||publication||'''';
END IF;




IF(adtype IS NOT NULL)
THEN
query1:=query1 || '   and TBL_BOOKING_MAST. "Ad_type_code" ='''||adtype||'''';
END IF;

IF(fromdate IS NOT NULL AND todate IS NOT NULL )
THEN
    query1:=query1||' and "Insert_Date" between  '''||fromdate ||''' and  '''||todate||''' ';
END IF;

IF(edition IS NOT NULL)
THEN
query1:=query1||'  and tbl_booking_insert."Edition_Code"='''||edition||'''';
END IF;




query1:=query1||'  order by tbl_booking_insert."Cio_Booking_Id"';




OPEN p_accounts  FOR

query1;





--delete from ANK_SEARCH ;
--iNSERT INTO ANK_SEARCH VALUES(query1);



  --and "branch"=branch






   END websp_bindaudit_p;
END websp_bindaudit;
/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PROCEDURE bindratecodeforrevisedate
(
compcode  in varchar2,
adcat1  in varchar2,
previsedate  in varchar2,

p_Accounts   OUT   cur_type_new1.cursor_type,
p_Accounts1   OUT   cur_type_new1.cursor_type
)
as
BEGIN

if(previsedate is null) then
begin
if(adcat1='contract')then
Open p_Accounts for
select  distinct  "Rate_Mast_Code" AS "rate_mast_code" from   rate_mast  where "Comp_code"= compcode and sysdate between "Valid_From" and "Valid_To";

Open p_Accounts1 For
 select "Bullet_Code","Bullet_Desc" from bullet_mast where "Comp_Code"=compcode and  "Adv_Cat_Code" like '%' || adcat1 || '%';
else
Open p_Accounts for
select  distinct  "Rate_Mast_Code" AS "rate_mast_code" from  rate_mast  where ("Comp_code"= compcode ) and ("Adv_Cat_Code"= adcat1) and sysdate between "Valid_From" and "Valid_To";

Open p_Accounts1 For
 select "Bullet_Code","Bullet_Desc" from bullet_mast where "Comp_Code"=compcode and  "Adv_Cat_Code" like '%' || adcat1 || '%';
end if;
end;
else
begin


if(adcat1='contract')then
Open p_Accounts for
select  distinct  "Rate_Mast_Code" AS "rate_mast_code" from   rate_mast  where "Comp_code"= compcode and previsedate between "Valid_From" and "Valid_To";
Open p_Accounts1 For
 select "Bullet_Code","Bullet_Desc" from bullet_mast where "Comp_Code"=compcode and  "Adv_Cat_Code" like '%' || adcat1 || '%';

else
Open p_Accounts for
select  distinct  "Rate_Mast_Code" AS "rate_mast_code" from  rate_mast  where ("Comp_code"= compcode ) and ("Adv_Cat_Code"= adcat1) and previsedate between "Valid_From" and "Valid_To";
Open p_Accounts1 For
 select "Bullet_Code","Bullet_Desc" from bullet_mast where "Comp_Code"=compcode and  "Adv_Cat_Code" like '%' || adcat1 || '%';

end if;
end;
end if;
END;
/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PACKAGE bindratecode
IS
Type T_Accounts_Cursor is Ref Cursor;

PROCEDURE  bindratecode_p(


compcode in varchar2,
adcat1 in  varchar2,
p_Accounts out T_Accounts_Cursor,
p_Accounts1 out T_Accounts_Cursor

);
End bindratecode;
/

//////////////////////////////

CREATE OR REPLACE PACKAGE BODY bindratecode
IS


PROCEDURE  bindratecode_p(


compcode in varchar2,
adcat1 in  varchar2,
p_Accounts out T_Accounts_Cursor,
p_Accounts1 out T_Accounts_Cursor

)as
begin

if(adcat1='contract')then
Open p_Accounts for
select  distinct  "Rate_Mast_Code" AS "rate_mast_code" from   rate_mast  where "Comp_code"= compcode and sysdate between "Valid_From" and "Valid_To";

Open p_Accounts1 For
 select "Bullet_Code","Bullet_Desc" from bullet_mast where "Comp_Code"=compcode and to_date(sysdate) between "Validity_From_Date" and "Validity_Till_Date" and "Adv_Cat_Code" like '%' || adcat1 || '%';
else
Open p_Accounts for
select  distinct  "Rate_Mast_Code" AS "rate_mast_code" from  rate_mast  where ("Comp_code"= compcode ) and ("Adv_Cat_Code"= adcat1) and sysdate between "Valid_From" and "Valid_To";

Open p_Accounts1 For
 select "Bullet_Code","Bullet_Desc" from bullet_mast where "Comp_Code"=compcode and to_date(sysdate) between "Validity_From_Date" and "Validity_Till_Date" and "Adv_Cat_Code" like '%' || adcat1 || '%';
end if;


End bindratecode_p;

End bindratecode;
/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PROCEDURE bind10agencyforbooking
(compcode in varchar2,
userid in varchar2,agency in varchar2,
pubcenter     in      varchar2,
p_Accounts OUT Cur_Type_New1.cursor_type
)
 is
    
    begin
if pubcenter = '0' or pubcenter is null then

open p_Accounts for
/*select  distinct  "code_subcode","Agency_Name" as "agency_name",(select "City_Name" from  city_mst where "Comp_Code"=compcode and "City_Code"=agency_mast."City_Code") CITYNAME from Agency_mast where "Comp_Code"=compcode
and "Agency_Name" like agency||'%' and rownum<=10  order by "Agency_Name" ;*/
select  distinct  "code_subcode","Agency_Name" as "agency_name",(select "City_Name" from  city_mst where "Comp_Code"=compcode and "City_Code"=agency_mast."City_Code")||'-'||"Add1"||'-'||"Add2"||'-'||"Add3"||"Street"
AS CITYNAME from Agency_mast where "Comp_Code"=compcode and
nvl((SELECT status_name FROM STATUS_DETAIL WHERE ROWNUM <= 1  AND "agency_code" || "agency_subcat_code" = AGENCY_MAST."code_subcode"  AND sysdate between "FROM_DATE" and "TO_DATE"),'AC0')='AC0'
and "Agency_Name" like agency||'%' and rownum<=10  order by "Agency_Name" ;

else
open p_Accounts for
/*select  distinct  "code_subcode","Agency_Name" as "agency_name",(select "City_Name" from  city_mst where "Comp_Code"=compcode and "City_Code"=agency_mast."City_Code") CITYNAME from Agency_mast where "Comp_Code"=compcode
and "Agency_Name" like agency||'%' and "Dist_Code"=(select "Dist_Code" from branch_mst where "Branch_Code"=pubcenter) and rownum<=10 order by "Agency_Name" ;*/
select  distinct  "code_subcode","Agency_Name" as "agency_name",(select "City_Name" from  city_mst where "Comp_Code"=compcode and "City_Code"=agency_mast."City_Code")||'-'||"Add1"||'-'||"Add2"||'-'||"Add3"||"Street"
AS CITYNAME from Agency_mast where "Comp_Code"=compcode and
nvl((SELECT status_name FROM STATUS_DETAIL WHERE ROWNUM <= 1  AND "agency_code" || "agency_subcat_code" = AGENCY_MAST."code_subcode"  AND sysdate between "FROM_DATE" and "TO_DATE"),'AC0')='AC0'
and "Agency_Name" like agency||'%' and "Dist_Code"=(select "Dist_Code" from branch_mst where "Branch_Code"=pubcenter) and rownum<=10  order by "Agency_Name" ;
end if;
end ;
/


@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@


//==================================************End*********************==================//

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@6547@@@@@@@@@@@@@@@@@@@end@@@@@@@@@@@@@@@@@@@@@@@@@@@


/*********************mimoh 0006376**********************************/
CREATE OR REPLACE PACKAGE execcontactupdate is
procedure execcontactupdate_p(
exename varchar2,
teamcode  varchar2,
designation  varchar2,
address  varchar2,
street  varchar2,
city  varchar2,
district  varchar2,
state  varchar2,
country  varchar2,
pin  varchar2,
phone  varchar2,
status  varchar2,
compcode  varchar2,
userid  varchar2,
code  varchar2,
report  varchar2,
TALUKA1  varchar2,
repname in varchar2,
adtype1 in varchar2,
branchcode in varchar2,
craditlimit varchar2,
mobile in varchar2,
email in varchar2,
p_empcode in varchar2
);
end  execcontactupdate;
/

CREATE OR REPLACE PACKAGE BODY execcontactupdate is
procedure execcontactupdate_p(
exename varchar2,
teamcode  varchar2,
designation  varchar2,
address  varchar2,
street  varchar2,
city  varchar2,
district  varchar2,
state  varchar2,
country  varchar2,
pin  varchar2,
phone  varchar2,
status  varchar2,
compcode  varchar2,
userid  varchar2,
code  varchar2,
report  varchar2,
TALUKA1  varchar2,
repname in varchar2,
adtype1 in varchar2,
branchcode in varchar2,
craditlimit in varchar2,
mobile in varchar2,
email in varchar2,
p_empcode in varchar2
)as

cityname varchar2(10);
countryname varchar2(10);

begin

update  Exec_mast set  "Exec_name"=exename,"Designation"=designation,"Add1"=address,"Street"=street,"Country_code"=country,"State_code"=state,"dist_code"=district,"city_code"=city,"phone"=phone,"exe_status"=status,"pin_code"=pin, "report_to"=report ,"TALUKA" = TALUKA1, REPRESENTATIVE=repname,ADTYPE=adtype1,"Branch_code"=branchcode,CREDIT_LIMIT=craditlimit,MOBILENO=mobile,EMAILID=email,HR_CODE =p_empcode where "comp_code"=compcode and "Exe_no"=code;


update Exec_mast set "CIty_Name"=(select "City_Code" from city_mst where "City_Code"=city) where "city_code"=city;

--update Exec_mast set "CIty_Name"=(select "CIty_Name" from city_mst where "city_code"=city) where "city_code"=city;
--update EXEC_ADCAT set catcode=adcategory;
commit;

end execcontactupdate_p;

end  execcontactupdate;
/
/**************************************/

CREATE OR REPLACE PACKAGE execcontactinsert is
Type T_Accounts_Cursor is Ref Cursor;
procedure execcontactinsert_p(
exename in varchar2,
teamcode in varchar2,
designation in varchar2,
address in varchar2,
street in varchar2,
city in varchar2,
district in varchar2,
state in varchar2,
country in varchar2,
pin in varchar2,
phone in varchar2,
status in varchar2,
compcode in varchar2,
userid in varchar2,
report in varchar2,
taluka1 in varchar2,
repname in varchar2,
adtype1 in varchar2,
branchcode in varchar2,
craditlimit in varchar2,
mobile in varchar2,
email in varchar2,
p_empcode in varchar2,
P_Accounts out T_Accounts_Cursor
);
end execcontactinsert;
/


CREATE OR REPLACE PACKAGE BODY execcontactinsert is
procedure execcontactinsert_p(
exename in varchar2,
teamcode in varchar2,
designation in varchar2,
address in varchar2,
street in varchar2,
city in varchar2,
district in varchar2,
state in varchar2,
country in varchar2,
pin in varchar2,
phone in varchar2,
status in varchar2,
compcode in varchar2,
userid in varchar2,
report in varchar2,
taluka1 in varchar2,
repname in varchar2,
adtype1 in varchar2,
branchcode in varchar2,
craditlimit in varchar2,
mobile in varchar2,
email in varchar2,
p_empcode in varchar2,
P_Accounts out T_Accounts_Cursor
)as
exeno int;
begin
select Exe_no_ident1.nextval into exeno from dual;
insert into Exec_mast("Exe_no","Team_code","Exec_name","Designation","Add1","Street","Country_code","State_code","dist_code","city_code","phone","exe_status","userid","comp_code","pin_code","report_to","TALUKA","creation_datetime",REPRESENTATIVE,ADTYPE,"Branch_code",CREDIT_LIMIT,MOBILENO,EMAILID,HR_CODE )
values(exeno,teamcode,exename,designation,address,street,country,state,district,city,phone,status,userid,compcode,pin,report,taluka1,sysdate,repname,adtype1,branchcode,craditlimit,mobile,email,p_empcode);



update Exec_mast set "CIty_Name"=(select "City_Name" from city_mst where "City_Code"=city) where "city_code"=city;
commit;
open P_Accounts for
select exeno as "exeno" from dual;
end execcontactinsert_p;
end execcontactinsert;
/
/********************************************************/

CREATE OR REPLACE PACKAGE execselectbind is

Type T_Accounts_Cursor Is Ref Cursor;
procedure execselectbind_p(
code in varchar2,
compcode in varchar2,
userid in varchar2,P_Accounts Out T_Accounts_Cursor,
P_Accounts1 Out T_Accounts_Cursor,
P_Accounts2 Out T_Accounts_Cursor
);
end execselectbind;
/

CREATE OR REPLACE PACKAGE BODY execselectbind is
procedure execselectbind_p(
code in varchar2,
compcode in varchar2,
userid in varchar2,P_Accounts Out T_Accounts_Cursor,
P_Accounts1 Out T_Accounts_Cursor,
P_Accounts2 Out T_Accounts_Cursor
)as

dist_code1 varchar2(100);

begin
Open P_Accounts For
select "Exec_name","Designation","Add1","Street","city_code","dist_code","State_code","Country_code","pin_code","phone","exe_status","Exe_no","report_to","TALUKA",REPRESENTATIVE AS "repname",ADTYPE as "adtype","Branch_code",CREDIT_LIMIT,MOBILENO,EMAILID,ad_get_fieldname('COMP_CD',compcode,'EMP_CODE',Exec_mast.HR_CODE,'NAME','HR_EMP_MST','','') AS HR_CODE from Exec_mast where "comp_code"=compcode  and "Exe_no" =code;
Open P_Accounts1 For
-- select talu_code,talu_name from taluka_mast WHERE DIST_CODE=(select "Dist_Code" from dist_mst where "Dist_Name" =(SELECT "dist_code" FROM Exec_mast where "comp_code"=compcode  and "Exe_no" =code)); 
select talu_code,talu_name from taluka_mast,Exec_mast WHERE DIST_CODE=(select "Dist_Code" from dist_mst where "Dist_Name" =(SELECT "dist_code" FROM Exec_mast where "comp_code"=compcode  and "Exe_no" =code)  ) and Exec_mast."comp_code"=compcode  and Exec_mast."Exe_no" =code;

open P_Accounts2 for
select catcode as "adcat" from exec_adcat where compcode=compcode  and execcode =code;

end  execselectbind_p;
end execselectbind;
/



/**************************************************************/


CREATE OR REPLACE procedure emp_code_bind (
   pcomp_code  IN       VARCHAR2,                 
   pname     in       VARCHAR2,
   pextra1     in       VARCHAR2,
   pextra2     in       VARCHAR2,
   pextra3     in       VARCHAR2,
   pextra4     in       VARCHAR2,
   p_accounts    OUT      cur_type_new1.cursor_type,
   p_accounts1    OUT      cur_type_new1.cursor_type,
   p_accounts2    OUT      cur_type_new1.cursor_type,
   p_accounts3   OUT      cur_type_new1.cursor_type
)
IS
BEGIN
   OPEN p_accounts FOR     
     SELECT emp_code,name FROM hr_EMP_MST where comp_cd=pcomp_code 
     and ( name like pname||'%' or pname is null);
     
     OPEN p_accounts1 FOR 
        select 'a' as "A" from dual;
     
     OPEN p_accounts2 FOR 
     select 'a'  as "A" from dual;
     OPEN p_accounts3 FOR 
     select 'a' as "A" from dual;
     
END;
/
/**********************************************************************/



CREATE OR REPLACE PACKAGE Logininsert
IS


   PROCEDURE  loginInsert_p (  username IN VARCHAR2,
password IN VARCHAR2,
userid1 IN VARCHAR2,
date_format IN VARCHAR2,
comp_name IN VARCHAR2,
com_code IN VARCHAR2,
curr_code IN VARCHAR2,
retainer_code IN VARCHAR2,

agencycode IN VARCHAR2,
USER IN  VARCHAR2,
ADMIN1 IN VARCHAR2,
comp_user IN VARCHAR2,
compnamelist in varchar2,
emailid  in varchar2,
disc in varchar2,
fil in varchar2,
role in varchar2,
editlines in varchar2,
firstname in varchar2,
lastname in varchar2,
pstatus  in varchar2,
p_empcode  in varchar2
);
END   Logininsert;
/





CREATE OR REPLACE PACKAGE BODY Logininsert
IS


   PROCEDURE  loginInsert_p (
username IN VARCHAR2,
password IN VARCHAR2,
userid1 IN VARCHAR2,
date_format IN VARCHAR2,
comp_name IN VARCHAR2,
com_code IN VARCHAR2,
curr_code IN VARCHAR2,
retainer_code IN VARCHAR2,
agencycode IN VARCHAR2,
USER IN  VARCHAR2,
ADMIN1 IN VARCHAR2,
comp_user IN VARCHAR2,
compnamelist in varchar2,
emailid  in varchar2,
disc in varchar2,
fil in varchar2,
role in varchar2,
editlines in varchar2,
firstname in varchar2,
lastname in varchar2,
pstatus  in varchar2,
p_empcode  in varchar2
) AS

BEGIN


INSERT INTO LOGIN("username","password","userid","date_format","comp_name","COM_CODE","curr_code","retainer_code","Agency_code","User_status","Admin","Company_user",USER_COMPANY,EMAIL,DISCOUNT,FILTER,ROLEID,BOOKING_EDITLINES,FIRSTNAME,LASTNAME,STATUS,HR_CODE)

VALUES(username,password,userid1,date_format,comp_name,com_code,curr_code,retainer_code,agencycode,USER,ADMIN1,comp_user,compnamelist,emailid,disc,fil,role,editlines,firstname,lastname,pstatus,p_empcode);
DELETE FROM MODULE_DETAIBUTTONL WHERE MODULE_DETAIBUTTONL."userid"=userid1;
COMMIT;
dbms_output.put_line(userid1);
INSERT INTO MODULE_DETAIBUTTONL("Button_id", "Form_Name", "comp_code", "userid", "Module_No", "Form_id", "Paid_permission", "Backdate_booking", "Ro_date_perm", "Confirm_qbc", BACK_DAYS) SELECT BUTTONID, FORM_NAME,COMPCODE,userid1,'',FORM_ID,'','','','',''  FROM ROLE_PERMISSION WHERE ROLEID=role;
update MODULE_DETAIBUTTONL set modulecode=(select modulecode from formmast where "Form_Name"= MODULE_DETAIBUTTONL."Form_Name" and rownum<=1) where "userid"=userid1;
COMMIT;

END   loginInsert_p;
END   Logininsert;
/

/*****************************************************************/



CREATE OR REPLACE PACKAGE Loginmodify
IS


   PROCEDURE   loginModify_p (username IN VARCHAR2,
password IN VARCHAR2,
userid1 IN VARCHAR2,
date_format IN VARCHAR2,
comp_name IN VARCHAR2,
compcode IN VARCHAR2,
curr_code IN VARCHAR2,
retainer_code IN VARCHAR2,

agencycode IN VARCHAR2,
USER IN  VARCHAR2,
ADMIN1 IN VARCHAR2,
comp_user IN VARCHAR2,
companylist in varchar2,
emailid  in varchar2,
disc in varchar2,
fil in varchar2,
role in varchar2,
editlines in varchar2,
fname in varchar2,
lname in varchar2,
pstatus  in varchar2,
p_empcode  in varchar2
 );
END    Loginmodify ;
/





CREATE OR REPLACE PACKAGE BODY Loginmodify
IS


   PROCEDURE   loginModify_p (username IN VARCHAR2,
password IN VARCHAR2,
userid1 IN VARCHAR2,
date_format IN VARCHAR2,
comp_name IN VARCHAR2,
compcode IN VARCHAR2,
curr_code IN VARCHAR2,
retainer_code IN VARCHAR2,

agencycode IN VARCHAR2,
USER IN  VARCHAR2,
ADMIN1 IN VARCHAR2,
comp_user IN VARCHAR2,
companylist in varchar2,
emailid  in varchar2,
disc in varchar2,
fil in varchar2,
role in varchar2,
editlines in varchar2,
fname in varchar2,
lname in varchar2,
pstatus  in varchar2,
p_empcode  in varchar2
) AS


BEGIN

UPDATE LOGIN SET FIRSTNAME=fname,LASTNAME=lname , BOOKING_EDITLINES=editlines, ROLEID=role,FILTER=fil, DISCOUNT=disc, "username"=username, "password"=password, "date_format"=date_format, "comp_name"=comp_name, "COM_CODE"=com_code, "curr_code"=curr_code,

"retainer_code"=retainer_code,"Agency_code"=agencycode,"User_status"=USER,"Admin"=ADMIN1,"Company_user"=comp_user,USER_COMPANY=companylist,EMAIL=emailid,STATUS=pstatus,HR_CODE=p_empcode WHERE "userid"=userid1;
/*
if(role!='0' or  role is not null)
then
DELETE FROM MODULE_DETAIBUTTONL WHERE MODULE_DETAIBUTTONL."userid"=userid1;
COMMIT;
INSERT INTO MODULE_DETAIBUTTONL SELECT BUTTONID, FORM_NAME,COMPCODE,userid1,'',FORM_ID,'','','',''  FROM ROLE_PERMISSION WHERE ROLEID=role;
COMMIT;
end if;*/

END    loginModify_p ;
END    Loginmodify ;
/

/***********************************************************************************/



CREATE OR REPLACE PACKAGE Loginexecute IS
 TYPE t_accounts_cursor IS REF CURSOR;
 PROCEDURE  loginexecute_p (
 username IN VARCHAR2,
 userid IN VARCHAR2,
 com_code IN VARCHAR2,
 admin1 IN VARCHAR2,
 p_accounts   OUT      t_accounts_cursor
 --p_accounts1   OUT      t_accounts_cursor,
 --p_accounts2   OUT      t_accounts_cursor
 );
 END Loginexecute;
/





CREATE OR REPLACE PACKAGE BODY Loginexecute IS
PROCEDURE  Loginexecute_p (
username IN VARCHAR2,
userid IN VARCHAR2,
com_code IN VARCHAR2,
admin1 IN VARCHAR2,
p_accounts   OUT  t_accounts_cursor

)AS
BEGIN
dbms_output.put_line(admin1);
if(admin1 is null) then

 OPEN p_accounts FOR
         SELECT "username", "password", "userid", "date_format", "COM_CODE", "comp_name", "Autogenerate", "curr_code", "retainer_code", "Agency_code", "User_status", "Admin", "Company_user", USER_COMPANY, CREATION_DATETIME, EMAIL, DISCOUNT, FILTER, ROLEID, BOOKING_EDITLINES, FIRSTNAME, LASTNAME, ROLE, STATUS, DOMAIN_USER, ad_get_fieldname('COMP_CD',com_code,'EMP_CODE',LOGIN.HR_CODE,'NAME','HR_EMP_MST','','') AS HR_CODE FROM LOGIN 
          WHERE "Admin"is null
            and ("COM_CODE" = com_code OR com_code IS NULL)
            AND ("username" LIKE username || '%' OR username IS NULL)
            AND ("userid" LIKE userid || '%' OR userid IS NULL);
  else
     OPEN p_accounts FOR
         SELECT "username", "password", "userid", "date_format", "COM_CODE", "comp_name", "Autogenerate", "curr_code", "retainer_code", "Agency_code", "User_status", "Admin", "Company_user", USER_COMPANY, CREATION_DATETIME, EMAIL, DISCOUNT, FILTER, ROLEID, BOOKING_EDITLINES, FIRSTNAME, LASTNAME, ROLE, STATUS, DOMAIN_USER, ad_get_fieldname('COMP_CD',com_code,'EMP_CODE',LOGIN.HR_CODE,'NAME','HR_EMP_MST','','') AS HR_CODE  FROM LOGIN
          WHERE  "Admin"='yes'
          and ("COM_CODE" = com_code OR com_code IS NULL)
            AND ("username" LIKE username || '%' OR username IS NULL)
            AND ("userid" LIKE userid || '%' OR userid IS NULL);       
end if;

END Loginexecute_p;
END Loginexecute;
/

/***************************************************************/



CREATE OR REPLACE PACKAGE Retainerexec IS

TYPE T_Accounts_Cursor IS REF CURSOR;


PROCEDURE RetainerExec_P(
compcode IN  VARCHAR2,
Retain_Code IN VARCHAR2,
retname  IN VARCHAR2,
retalias IN VARCHAR2,
citycode IN VARCHAR2,
pubcent  IN VARCHAR2,
country IN VARCHAR2,
box_matter IN VARCHAR2,
repname in varchar2,
branchname in varchar2,
p_Accounts OUT T_Accounts_Cursor );

END Retainerexec;
/





CREATE OR REPLACE PACKAGE BODY Retainerexec IS

PROCEDURE RetainerExec_P(
compcode IN  VARCHAR2,
Retain_Code IN VARCHAR2,
retname  IN VARCHAR2,
retalias IN VARCHAR2,
citycode IN VARCHAR2,
pubcent  IN VARCHAR2,
country IN VARCHAR2,
box_matter IN VARCHAR2,
repname in varchar2,
branchname in varchar2,
p_Accounts OUT T_Accounts_Cursor ) AS

BEGIN


OPEN p_Accounts FOR
SELECT "Comp_Code","userid","Retain_Code","Retain_Name","Retain_Alias","Add1","Street","City_Code","Zip","Dist_Code","State_Code","Region_Code","Country_Code","Phone1","Phone2","Fax","EmailID","Credit_Days","Remarks","PAN_No",
(SELECT  "Status_Name" FROM TBLSTATUS WHERE "Status_Code" =(select STATUS_NAME from ret_status_detail where "Retain_Code"=RETAINERMASTER."Retain_Code" and rownum <=1 AND sysdate between "FROM_DATE" and "TO_DATE")) as "Retain_status",SYSDATE,SYSDATE,"pubcent_code","BOXMATTER","PUBLICATION","EDITION","SUPPLEMENT","TALUKA",REPRESENTATIVE as "repname","Branch_code",CREDIT_LIMIT,MOBILENO,"SIGN",ad_get_fieldname('COMP_CD',compcode,'EMP_CODE',RETAINERMASTER.HR_CODE,'NAME','HR_EMP_MST','','') AS HR_CODE FROM  RETAINERMASTER
 WHERE "Comp_Code"=compcode AND  "Retain_Code"=Retain_Code OR Retain_Code IS NULL AND
 "Retain_Name" LIKE retname||'%'
AND  ("Retain_Alias" LIKE retalias||'%' )
AND  ("Country_Code"=country OR country IS NULL)
AND  ("City_Code"=citycode OR citycode IS NULL)
AND  ("pubcent_code"=pubcent OR pubcent IS NULL)
AND  ("Branch_code"=branchname OR branchname IS NULL)
;


END RetainerExec_P;

END Retainerexec;
/

/********************************************************************************/



CREATE OR REPLACE PACKAGE RetainerInsertDetail Is



Type T_Accounts_Cursor Is Ref Cursor;
Procedure RetainerInsertDetail_P (Comp_Code1  in varchar2,
Retain_Code1  in varchar2,
userid1 in varchar2,
Retain_Name1 in varchar2,
Retain_Alias1 in varchar2,
Add11 in varchar2 ,
Street1 in varchar2 ,
City_Code1 in varchar2,
pubcent   in varchar2,
Zip1 in varchar2 ,
Dist_Code1 in varchar2 ,
State_Code1 in varchar2,
zone_code1 in varchar2,
region_code1 in varchar2,
Country_Code1 in varchar2,
phone11 in varchar2,
Phone21 in varchar2 ,
Fax1 in varchar2 ,
EmailID1 in varchar2 ,
PAN_No1 in varchar2 ,
Credit_Days1 in varchar2,
Remarks1 in varchar2 ,
flag in number,
Box in varchar2,
Publication1 in varchar2,
Edition1 in varchar2,
Supplement1 in varchar2,
taluka1 in varchar2,
repname in varchar2,
branchcode in varchar2,
creditlimit in varchar2,
mobile1 in varchar2,
signature in varchar2,
p_empcode in varchar2
);

End RetainerInsertDetail;
/





CREATE OR REPLACE PACKAGE BODY RetainerInsertDetail Is

Procedure RetainerInsertDetail_P (Comp_Code1  in varchar2,
Retain_Code1 in varchar2,
userid1 in varchar2,
Retain_Name1 in varchar2,
Retain_Alias1 in varchar2,
Add11 in varchar2 ,
Street1 in varchar2 ,
City_Code1 in varchar2,
pubcent   in varchar2,
Zip1 in varchar2 ,
Dist_Code1 in varchar2 ,
State_Code1 in varchar2,
zone_code1 in varchar2,
region_code1 in varchar2,
Country_Code1 in varchar2,
phone11 in varchar2,
Phone21 in varchar2 ,
Fax1 in varchar2 ,
EmailID1 in varchar2 ,
PAN_No1 in varchar2 ,
Credit_Days1 in varchar2,
Remarks1 in varchar2 ,
flag in number,
Box in varchar2,
Publication1 in varchar2,
Edition1 in varchar2,
Supplement1 in varchar2,
taluka1 in varchar2,
repname in varchar2,
branchcode in varchar2,
creditlimit in varchar2,
mobile1 in varchar2,
signature in varchar2,
p_empcode in varchar2
) As

  Begin
    if flag = '0' then
   insert into RetainerMaster("Comp_Code" ,"Retain_Code" ,"userid" ,"Retain_Name" ,"Retain_Alias" ,"Add1" ,"Street" ,"City_Code" ,"Zip" ,"Dist_Code" ,"State_Code" ,"Zone_Code","Region_Code","Country_Code" ,"Phone1" ,"Phone2" ,"Fax" ,"EmailID" ,"PAN_No" ,"Credit_Days","Remarks" , "pubcent_code","Creation_Datetime", "Retain_status", "To_date","BOXMATTER","PUBLICATION","EDITION","SUPPLEMENT","TALUKA",REPRESENTATIVE,"Branch_code",CREDIT_LIMIT,MOBILENO,"SIGN",HR_CODE)values (Comp_Code1,Retain_Code1,userid1,Retain_Name1,Retain_Alias1,Add11,Street1,City_Code1,Zip1,Dist_Code1,State_Code1,zone_code1,region_code1,Country_Code1,phone11,Phone21,Fax1,EmailID1,PAN_No1,Credit_Days1,Remarks1,pubcent,sysdate,'','',Box,Publication1,Edition1,Supplement1,taluka1,repname,branchcode,creditlimit,mobile1,signature,p_empcode) ;
   else
   update RetainerMaster set "Retain_Name" = Retain_Name1  ,"Retain_Alias" =Retain_Alias1 ,"Add1" = Add11,"Street" = Street1,"City_Code" =City_Code1 ,"Zip" = Zip1,  "Dist_Code" = Dist_Code1 ,"State_Code" = State_Code1 ,"Zone_Code" = zone_code1,"Region_Code" = region_code1,"Country_Code" = Country_Code1,"Phone1" = phone11,"Phone2" =Phone21,"Fax" =Fax1 ,"EmailID" =EmailID1 ,"PAN_No" = PAN_No1,"Credit_Days" = Credit_Days1,"Remarks" =Remarks1, "pubcent_code"=pubcent, "BOXMATTER"=Box,"PUBLICATION"=Publication1,"EDITION"=Edition1,"SUPPLEMENT"=Supplement1,"TALUKA"=taluka1,REPRESENTATIVE=repname,"Branch_code"=branchcode,CREDIT_LIMIT=creditlimit,MOBILENO=mobile1,"SIGN"=signature,HR_CODE =p_empcode where "Comp_Code" = Comp_Code1 and "Retain_Code" = Retain_Code1;
   end if;
    commit;
   End RetainerInsertDetail_P;
 End RetainerInsertDetail;
/

/***************************************************************/
/*********************mimoh 0006376**********************************/

/*******************************************************start issue no:6305******************************************************
CREATE OR REPLACE procedure rpt_vts_report
(pagency_code in varchar2,
pclient_code in varchar2,
pfrom_date in varchar2,
pto_date in varchar2,
pdateformat in varchar2,
ppublication in varchar2,
pedition in varchar2,
ppub_center in varchar2,
pbranch in varchar2,
pcompcode in varchar2,
puserid in varchar2,
chk_access in varchar2,
clienttype in varchar2,
pextra1 in varchar2,
pextra2 in varchar2,
p_accounts OUT Cur_Type_New1.cursor_type
)
is 
query1 varchar2(8000);
v_frdt date;
v_todt date; 
begin

--v_frdt :=to_date(pfrom_date,pdateformat);
--v_todt :=to_date(pto_date,pdateformat);


v_frdt :=pfrom_date;
v_todt :=pto_date;


query1:=query1|| 'select 
c."Agency_Name" AS "AGENCY",
nvl((SELECT "Cust_Name" FROM  CUST_MAST WHERE a."Comp_code"= CUST_MAST."Comp_Code" AND "Cust_Code"="Client_code"),"Client_code")  AS "CLIENT", 
b."Edition" as "EDITION",
to_char("Insert_Date",'''||pdateformat||''') AS "PUB_DATE" ,
a."No_of_insertion",
nvl(a."Agrred_rate",a."Card_rate" ) AS "RATE",
(select "Comp_Name" from  comp_mst where comp_mst."Comp_Code"=a."Comp_code") comp_name
from  tbl_booking_mast a, tbl_booking_insert b, agency_mast c
WHERE a."Comp_code"='''||pcompcode||''' AND
a."Agency_sub_code"=c."code_subcode" AND
a."cio_booking_id"=b."Cio_Booking_Id"  
and
 ((b."Pub_Cent_Code" in (select distinct pub_center from  login_center where newuser_id='''||puserid||''') and '''||chk_access||'''=''1'')
or  ('''||chk_access||'''=''0'') )
';



IF(pfrom_date IS NOT NULL AND pto_date IS NOT NULL)
then
query1:=query1||' and b."Insert_Date" between  '''||v_frdt ||''' and  '''||v_todt||''' ';
END if;


IF(pagency_code IS NOT NULL )
then
query1:=query1||' and a."Agency_code" =  '''||pagency_code||''' ';
END if;

IF(pclient_code IS NOT NULL )
then
query1:=query1||' and a."Client_code"='''||pclient_code ||'''';
END if;

IF(ppublication IS NOT NULL )
then
query1:=query1||' and  b."Publication_Code"='''||ppublication||'''';
END if;

IF(ppub_center IS NOT NULL )
then
query1:=query1||'  and b."Pub_Cent_Code"='''||ppub_center||'''';
END if;

IF(pedition IS NOT NULL )
then
query1:=query1||'  and b."Edition_Code"='''||pedition||'''';
END if;

IF(pbranch IS NOT NULL )
then
query1:=query1||'  and a."branch"='''||pbranch||'''';
END if;


  if (clienttype is not null or clienttype<>'') then
      if clienttype = 'R' then
         query1:=query1||'  and "Client_code" in (select "Cust_Code" from  cust_mast where "Comp_Code" = '''||pcompcode||''''||'and "Cust_Status"=''ACTIVE'')';
      else if clienttype = 'N' then
         query1:=query1||'  and "Client_code" not in (select "Cust_Code" from  cust_mast where "Comp_Code" = '''||pcompcode||''''||'and "Cust_Status"=''ACTIVE'')';
      else
         query1:=query1;
      end if;
      end if;
   end if; 

--insert into test1 (vstring) values (query1);commit;


open p_accounts for query1;


--DELETE  FROM SEARCHTBL;
--INSERT INTO SEARCHTBL VALUES('PK'||query1);
--COMMIT;

end rpt_vts_report;
/


****************************************************************end issue no:6305***************************************************

/**************ankit********************* issue 6578************************/
CREATE OR REPLACE PACKAGE check_status_code
IS
   TYPE t_accounts_cursor IS REF CURSOR;

   PROCEDURE check_status_code_p (
      compcode     IN       VARCHAR2,
      statuscode   IN       VARCHAR2,
      statusname   IN       VARCHAR2,
      p_accounts   OUT      t_accounts_cursor,
       p_accounts1   OUT      t_accounts_cursor
   );
END check_status_code;
/




CREATE OR REPLACE PACKAGE BODY check_status_code
IS
   PROCEDURE check_status_code_p (
      compcode     IN       VARCHAR2,
      statuscode   IN       VARCHAR2,
      statusname   IN       VARCHAR2,
      p_accounts   OUT      t_accounts_cursor,
       p_accounts1   OUT      t_accounts_cursor
   )
   AS
   BEGIN
      OPEN p_accounts FOR
         SELECT "Status_Code"
           FROM tblstatus
          WHERE "Status_Code" = statuscode AND "Comp_Code" = compcode;
          
       OPEN p_accounts1 FOR
       select "Status_Name" from tblstatus where  "Status_Name" = statusname  and "Comp_Code"=compcode;
   END check_status_code_p;
END check_status_code;
/

/**************ankit********************* issue 6578********end****************/
/***************ankit******************** issue 6601************************/
CREATE OR REPLACE PACKAGE cat_namechk IS

TYPE T_Accounts_Cursor IS REF CURSOR;

PROCEDURE cat_namechk_p(
str IN VARCHAR2,
subcatname IN VARCHAR2,
company_code in varchar2,
p_Accounts OUT T_Accounts_Cursor,p_Accounts1 OUT T_Accounts_Cursor );

END cat_namechk;
/







CREATE OR REPLACE PACKAGE BODY cat_namechk IS

PROCEDURE cat_namechk_p(
str IN VARCHAR2,
subcatname IN VARCHAR2,
company_code in varchar2,
p_Accounts OUT T_Accounts_Cursor,p_Accounts1 OUT T_Accounts_Cursor ) AS

BEGIN


OPEN P_Accounts FOR
SELECT * FROM AD_CAT3 WHERE "compcode"=company_code and "catname"=str AND "subcatname"=subcatname;

OPEN p_Accounts1 FOR

select 'a' AS "A" from dual;


END cat_namechk_p;

END cat_namechk;
/


/***************ankit******************** issue 6601************************/
/***************ankit******************** issue 6578**************03 feb**********/
CREATE OR REPLACE PACKAGE check_status_code
IS
   TYPE t_accounts_cursor IS REF CURSOR;

   PROCEDURE check_status_code_p (
      compcode     IN       VARCHAR2,
      statuscode   IN       VARCHAR2,
      statusname   IN       VARCHAR2,
      p_accounts   OUT      t_accounts_cursor,
       p_accounts1   OUT      t_accounts_cursor
   );
END check_status_code;
/


CREATE OR REPLACE PACKAGE BODY check_status_code
IS
   PROCEDURE check_status_code_p (
      compcode     IN       VARCHAR2,
      statuscode   IN       VARCHAR2,
      statusname   IN       VARCHAR2,
      p_accounts   OUT      t_accounts_cursor,
       p_accounts1   OUT      t_accounts_cursor
   )
   AS
   BEGIN
      OPEN p_accounts FOR
         SELECT "Status_Code"
           FROM tblstatus
          WHERE "Status_Code" = statuscode AND "Comp_Code" = compcode;
          
       OPEN p_accounts1 FOR
       select "Status_Name" from tblstatus where  "Status_Name" = statusname  and "Comp_Code"=compcode;
   END check_status_code_p;
END check_status_code;
/
/***************ankit******************** issue 6578**************03 feb**********/

/*****************ankit****************** issue 6600**************06 feb**********/

CREATE OR REPLACE PACKAGE subcatupdate is
procedure subcatupdate_p
(compcode in varchar2,catcode in varchar2,subcatcode in varchar2,subcatname in varchar2,subcatalias in varchar2,userid in varchar2,
imagename in varchar2,subcatxml in varchar2,pri in varchar2,
status1 varchar2);
end subcatupdate;
/






CREATE OR REPLACE PACKAGE BODY subcatupdate is
procedure subcatupdate_p
(compcode in varchar2,catcode in varchar2,subcatcode in varchar2,subcatname in varchar2,subcatalias in varchar2,userid in varchar2,
imagename in varchar2,subcatxml in varchar2,pri in varchar2,status1 varchar2)as
begin

update adv_subcat_mast set  PRIORITY=pri,"Adv_Subcat_Name" = subcatname  , "Adv_Subcat_Alias" = subcatalias , "Image_name"=imagename,"ADMINWEBXML"=subcatxml,STATUS=status1 where "Comp_Code"=compcode and "UserId"=userid and "Adv_Cat_Code"=catcode and "Adv_Subcat_Code"=subcatcode;


update subcatdummy set "Adv_Subcat_Name" = subcatname  ,"Adv_Subcat_Alias"= subcatalias where "Comp_Code"=compcode and "Userid"=userid and "Adv_Cat_Code"=catcode and "Adv_Subcat_Code"=subcatcode;

commit;

end subcatupdate_p;

end subcatupdate;
/










CREATE OR REPLACE PACKAGE BODY subcatsave is
procedure subcatsave_p
(compcode in varchar2,catcode in varchar2,subcatcode in varchar2,subcatname in varchar2,subcatalias in varchar2,userid in varchar2,
imagename in varchar2,subcatxml in varchar2,pri in varchar2,status1 varchar2)as
begin
insert into adv_subcat_mast("Comp_Code", "Adv_Cat_Code", "Adv_Subcat_Code", "Adv_Subcat_Name", "Adv_Subcat_Alias", "UserId", "Creation_Datetime","Image_name","ADMINWEBXML",PRIORITY,STATUS)
values(compcode,catcode,subcatcode,subcatname,subcatalias,userid,sysdate,imagename,subcatxml,pri,status1);
commit;

end subcatsave_p;

end subcatsave;
/











CREATE OR REPLACE PACKAGE subcatsave is
procedure subcatsave_p
(compcode in varchar2,catcode in varchar2,subcatcode in varchar2,subcatname in varchar2,subcatalias in varchar2,userid in varchar2,
imagename in varchar2,subcatxml in varchar2,pri in varchar2,status1 varchar2);
end subcatsave;
/


/*****************ankit****************** issue 6600**************06 feb**********/


/*****************ankit****************** issue 6599**************06 feb**********/

CREATE OR REPLACE PACKAGE editionsubmit is
procedure editionsubmit_p
(adcatcode  in varchar2,compcode in varchar2,userid in varchar2,editioncode in varchar2,sun in  varchar2,
mon  in varchar2,tue in varchar2,wed in varchar2,thu in varchar2,fri in varchar2,sat in varchar2,allday in varchar2);
end editionsubmit;
/



CREATE OR REPLACE PACKAGE BODY editionsubmit is
procedure editionsubmit_p
(adcatcode  in varchar2,compcode in varchar2,userid in varchar2,editioncode in varchar2,sun in  varchar2,mon  in varchar2,tue in varchar2,wed in varchar2,thu in varchar2,fri in varchar2,sat in varchar2,allday in varchar2)as
begin
insert into CategoryWiseEdition("stat_code","Comp_code", "Userid", "Adv_Cat_Code", "Edition_code", "sun", "mon", "tue", "wed", "thu", "fri", "sat", "all", "creationdate")
                        values (EDITION_ID.nextval,compcode,     userid,    adcatcode,     editioncode,     sun,   mon,   tue,  wed,    thu,   fri,   sat,  allday, sysdate);
commit;

end editionsubmit_p;
end editionsubmit;
/

/*****************ankit****************** issue 6599**************06 feb**********/



/***************ajay*********Issue 6650***********/

CREATE OR REPLACE PACKAGE BODY HT18JULY.TCHARGEAUTOCODE
IS
   PROCEDURE TCHARGEAUTOCODE_p (
      str           IN       VARCHAR2,
      cod           IN       VARCHAR2,
      p_accounts    OUT      t_accounts_cursor,
      p_accounts1   OUT      t_accounts_cursor
   )
   AS
   BEGIN
      OPEN p_accounts FOR
         SELECT *
           FROM AD_CHARGE_MAST
          WHERE (CHARGE_NAME = str);

      OPEN p_accounts1 FOR
         
		  select MAX(TO_NUMBER(NVL(translate(CHARGE_CODE,'ABCDEFGHIJKLMNOPQRSTUVWXYZ-_.',0),0))) AS CHARGE_CODE from AD_CHARGE_MAST where  CHARGE_CODE like cod || '%';

      COMMIT;
   END TCHARGEAUTOCODE_p;
END TCHARGEAUTOCODE;
/





/*****************ankit****************** issue 6583**************07 feb**********/

CREATE OR REPLACE PACKAGE vat_delete
 is

procedure   vat_delete_p(comp_code in varchar2,
vat_description in varchar2,
p_fromdate in varchar2,
p_todate in varchar2,
p_publicat in varchar2,
p_edit in varchar2
);


end   vat_delete;
/






CREATE OR REPLACE PACKAGE BODY vat_delete
 is

procedure  vat_delete_p(comp_code in varchar2,
vat_description in varchar2,
p_fromdate in varchar2,
p_todate in varchar2,
p_publicat in varchar2,
p_edit in varchar2
) as
begin
  delete from tbl_vat_mast where  "Comp_Code"=comp_code and "Vat_Description" =vat_description 
    and "Vat_From_Date"=p_fromdate AND "Vat_To_Date"= p_todate and PUBLICATION=p_publicat and  EDITION=p_edit;
end vat_delete_p;
end  vat_delete;
/


/*****************ankit****************** issue 6583**************07 feb**********/


@@@@@@@@@@@@@@@@@@@@@@@@@@@@@(0006447,0006448)kuldeep@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

//==============*********************Start Scripting****************==================//
 ALTER TABLE TEMPBOOKING_MAST_AUDIT
 ADD (TRANSLATION_CODE  VARCHAR2(50));

ALTER TABLE TEMPBOOKING_MAST_AUDIT
 ADD (TRANSLATION_PREMIUM  NUMBER);

 ALTER TABLE TBL_BOOKING_MAST
 ADD (MODIFIED_AUDIT  VARCHAR2(50));
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PACKAGE updateauditbooking is
type T_ACCOUNT_CURSOR is ref cursor;

procedure updateauditbooking_p(
    cioid       in varchar2,
    auditname   in varchar2);
    
End updateauditbooking;
/
CREATE OR REPLACE PACKAGE BODY updateauditbooking is
procedure updateauditbooking_p(
    cioid       in varchar2,
    auditname   in varchar2)
As
Begin
    
    update tbl_booking_mast set "audit"=auditname, "ro_status"='1',modified_audit=null 
        where "cio_booking_id"=cioid;
    commit;

End updateauditbooking_p;
end updateauditbooking;
/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PROCEDURE bookingdetailgrid (
      cioid     IN       VARCHAR2,
     P_Accounts OUT Cur_Type_New1.cursor_type

   )
is
newcioid varchar2(50);
countmatter number;
countinsert number;
filename varchar2(50);
BEGIN
newcioid:=cioid;
select count(*) into countmatter from tbl_matter where "cioid"=newcioid;
select count(*) into countinsert from tbl_booking_insert where "Cio_Booking_Id"=cioid and "File_Name" is not null;
if countmatter>countinsert then
    select "matter_filename" into filename from tbl_matter where "cioid"=newcioid and rownum<=1;
    update tbl_booking_insert set "File_Name"=filename where "Cio_Booking_Id"=cioid;
    commit;
end if;
OPEN p_Accounts FOR
select "No_Insert",
(select "pub_alias" from pub_mast where "Pub_Code"=tbl_booking_insert."Publication_Code") as Publication,
"Pub_Cent_Code" as Center,
"Edition",to_char("Insert_Date",'dd-mon-yyyy') as "Insert_Date","Col_Code","Page_No","Size_Book","Width","Height",
(select "Adv_Cat_Alias" from adv_cat_mast where "Adv_Cat_Code"=tbl_booking_insert."Ad_Cat" ) as AdCategory,
(select "Adv_Subcat_Alias" from adv_subcat_mast where "Adv_Subcat_Code"=tbl_booking_insert."Ad_Sub_Cat") as AdSubcategory,
"File_Name","Insert_Status",
case "Pai_Free_Ins"
when 'Y' then 'Yes'
when 'N' then 'No'
end as "Pai_Free_Ins"
,nvl("Gross_Rate",'0') as "Gross_Rate",round("Bill_Amt",2) as "Bill_Amt",BILL_NO,
SECTIONCODE,RESOURCE_NO,nvl("Remarks",'') as "Remarks",nvl(CAPTION,'') as CAPTION



from tbl_booking_insert where "Cio_Booking_Id"=cioid order by "Insert_Id";


END ;
/
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PACKAGE Executebookingdispaudit
IS
  TYPE T_Accounts_Cursor IS REF CURSOR;
  PROCEDURE Executebookingdispaudit_p(
  compcode IN VARCHAR2,
  ciobookid IN VARCHAR2,
  docno IN VARCHAR2:=NULL,
  keyno IN VARCHAR2:=NULL,
  rono IN VARCHAR2:=NULL,
  agencycode IN VARCHAR2:=NULL,
  client IN VARCHAR2:=NULL,
  booking IN VARCHAR2,dateformat IN VARCHAR2,
  P_Accounts  OUT  T_Accounts_Cursor,P_Accounts1  OUT  T_Accounts_Cursor,P_Accounts2  OUT  T_Accounts_Cursor,
  P_Accounts3  OUT  T_Accounts_Cursor);
END Executebookingdispaudit ;
/
CREATE OR REPLACE PACKAGE BODY Executebookingdispaudit
IS
   PROCEDURE Executebookingdispaudit_p (
      compcode      IN       VARCHAR2,
      ciobookid     IN       VARCHAR2,
      docno         IN       VARCHAR2 := NULL,
      keyno         IN       VARCHAR2 := NULL,
      rono          IN       VARCHAR2 := NULL,
      agencycode    IN       VARCHAR2 := NULL,
      client        IN       VARCHAR2 := NULL,
      booking       IN       VARCHAR2,
      dateformat     IN          VARCHAR2,
      p_accounts    OUT      t_accounts_cursor,
      p_accounts1   OUT      t_accounts_cursor,
      p_accounts2   OUT      t_accounts_cursor,
      P_Accounts3  OUT  T_Accounts_Cursor
   )
   AS
      VERSION1   NUMBER;
      count1    NUMBER;

   BEGIN

       DELETE FROM TEMPBOOKING_MAST_AUDIT;

      INSERT INTO TEMPBOOKING_MAST_AUDIT
         SELECT "date_time", "branch", "booked_by", "cio_booking_id",
                "prev_booking", "applied_by", "audit", "RO_No", "RO_Date",
                "Caption", "bill_status", "ro_status", "Agency_code",
                "Agency_address", "Client_code", "Client_address",
                "Agency_sub_code", "Dockit_no", "Executive_code",
                "Executive_zone", "Product_code", "Brand_code", "Key_no",
                "Bill_remarks", "Print_remark", "Package_code",
                "No_of_insertion", "Insertion_date", "Repeating_day",
                "Ad_type_code", "Ad_cat_code", "Ad_sub_cat_code",
                "Color_code", "Uom_code", "Page_position_code",
                "Page_type_code", "Page_no", "Ad_size_type_code",
                "Ad_size_height", 
                           
                
                
                
                nvl(TBL_BOOKING_MAST."Ad_size_column" ,TBL_BOOKING_MAST."Ad_size_width") AS "Ad_size_width"               
                
                
                , "Rate_code",
                "Scheme_type_code", "Currency_code", NVL("Agrred_rate",'0'),
                NVL("Agreed_amount",'0'), "Special_discount", "Space_discount",
                "Special_charges", "Agency_status", "Agency_type",
                "Agency_pay", "Agency_credit", "Total_area", "Card_rate",
                "Card_amount", NVL("Discount",'0'), "Discount_per", "Bill_cycle",
                "Revenue_center", "Bill_pay", "Bill_height", "Bill_width",
                "Bill_to", "Invoices", "Vts", "Bill_add", "Trade_disc",
                "Agency_out", "Box_code", "Box_no", "Box_agency",
                "Box_client", "Box_address", "Comp_code", "Userid",
                "Creation_datetime", "Booking_type", "Tfn", "Coupan_ad",
                "Campaign", "Bill_amount", "Page_prem", "Page_amount",
                "Prem_per", "Gross_amount", "Ad_size_column", "Bill_column",
                "Bill_area", "Special_disc_per", "Space_disc_per",
                "Paid_ins", "Contract_rate", "Deviation", "Variant_code",
                "Contract_name", "Contract_type", "Card_name", "Card_type",
                "Card_month", "Card_year", "Card_number", "Receipt_no",
                "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color",
                "Bullet_code", "Bullet_premium", "Material_status",
                TRUNC("Receipt_date"), "prev_cioid", "prev_receipt",
                "prev_grossamt", "Region", "Variant", "Colortype", "Logo_H",
                "Logo_W", "Logo_color", "Logo_Uom",sapid,RETAINER,"ADD_AGENCY_COMM",
                MOBILENO,ADD_AGENCY_COMM_AMT,RETAINER_COMM,RETAINER_COMM_AMT,
                "Bullet_code","Bullet_premium",DOCTYPE,TRANSLATION_CODE, TRANSLATION_PREMIUM



           FROM TBL_BOOKING_MAST
          WHERE ("Comp_code" = compcode OR compcode IS NULL)
            AND ("cio_booking_id" = ciobookid OR ciobookid IS NULL
                )
            AND ("Dockit_no" = docno  OR docno IS NULL)
            AND ("Key_no" = keyno  OR keyno IS NULL)
            AND ("RO_No" = rono  OR rono IS NULL)
            AND ("Agency_sub_code" LIKE agencycode || '%'
                 OR agencycode IS NULL
                )
            AND ("Client_code" LIKE client || '%' OR client IS NULL)
        --    AND ("Ad_type_code" LIKE booking || '%' OR booking IS NULL)
            ;

      OPEN p_accounts FOR
      SELECT CASE dateformat
                     WHEN 'mm/dd/yyyy' THEN TO_CHAR("date_time",'mm/dd/yyyy')
                  WHEN 'dd/mm/yyyy' THEN TO_CHAR("date_time",'dd/mm/yyyy')
                     WHEN 'yyyy/mm/dd' THEN TO_CHAR("date_time",'yyyy/mm/dd')  END AS date_time,
                     "branch","booked_by", "cio_booking_id", "prev_booking", "applied_by","audit", "RO_No",
            CASE dateformat
                 WHEN 'mm/dd/yyyy' THEN TO_CHAR("RO_Date",'mm/dd/yyyy')
                 WHEN 'dd/mm/yyyy' THEN TO_CHAR("RO_Date",'dd/mm/yyyy')
                 WHEN 'yyyy/mm/dd' THEN TO_CHAR("RO_Date",'yyyy/mm/dd')  END AS "RO_Date",
                  TO_CHAR("RO_Date", 'dd/mm/yyyy') AS "RO_Date",
                "Caption", "bill_status", "ro_status", "Agency_code",
                "Agency_address", "Client_code", "Client_address",
                "Agency_sub_code", "Dockit_no", "Executive_code",
                "Executive_zone", "Product_code", "Brand_code", "Key_no",
                "Bill_remarks", "Print_remark", "Package_code","No_of_insertion",
            CASE dateformat
                    WHEN 'mm/dd/yyyy' THEN TO_CHAR("Insertion_date",'mm/dd/yyyy')
                    WHEN 'dd/mm/yyyy' THEN TO_CHAR("Insertion_date",'dd/mm/yyyy')
                    WHEN 'yyyy/mm/dd' THEN TO_CHAR("Insertion_date",'yyyy/mm/dd')  END    AS "Insertion_date",
                "Repeating_day", "Ad_type_code", "Ad_cat_code",
                "Ad_sub_cat_code", "Color_code", "Uom_code",
                "Page_position_code", "Page_type_code", "Page_no",
                "Ad_size_type_code", "Ad_size_height", 
                
                "Ad_size_width"
                
                , "Rate_code",
                (SELECT "Scheme_Name" FROM SCHEME_MASTER WHERE "scheme_id" =TEMPBOOKING_MAST_AUDIT."Scheme_type_code")AS "Scheme_type_code",
                 "Currency_code", "Agrred_rate", "Agreed_amount",
                "Special_discount", "Space_discount", "Special_charges",
                TEMPBOOKING_MAST_AUDIT."Comp_code", TEMPBOOKING_MAST_AUDIT."Userid",
                TEMPBOOKING_MAST_AUDIT."Agency_status", "Agency_type", "Agency_pay",
                "Agency_credit", "Total_area", "Card_rate", "Card_amount",
                "Discount", "Discount_per", "Bill_cycle", "Revenue_center",
                "Bill_pay", "Bill_height", "Bill_width",
                TEMPBOOKING_MAST_AUDIT."Bill_to", "Invoices", "Vts", "Bill_add",
                "Trade_disc", "Agency_out", "Booking_type", "Campaign",
                "Page_prem", "Page_amount", "Prem_per", "Gross_amount",
                "Bill_amount", "Box_code", "Box_no", "Box_agency",
                "Box_client", "Box_address", "Tfn", "Coupan_ad",
                "Ad_size_column", "Bill_column", "Bill_area",
                "Special_disc_per", "Space_disc_per",
                AGENCY_MAST."Agency_Name" || '(' || AGENCY_MAST."code_subcode" || ')' AS "AgencyName",
                (SELECT EXEC_MAST."Exec_name" || '(' || TO_CHAR(EXEC_MAST."Exe_no") || ')' FROM EXEC_MAST
                  WHERE TEMPBOOKING_MAST_AUDIT."Executive_code" = EXEC_MAST."Exe_no"
                    AND TEMPBOOKING_MAST_AUDIT."Comp_code" = EXEC_MAST."comp_code") AS "execname",

                (SELECT  PRODUCT_CAT_MAST."prod_desc" || '(' || PRODUCT_CAT_MAST."prod_cat_code" || ')' FROM PRODUCT_CAT_MAST
                  WHERE TEMPBOOKING_MAST_AUDIT."Product_code" = PRODUCT_CAT_MAST."prod_cat_code"
                    AND TEMPBOOKING_MAST_AUDIT."Comp_code" = PRODUCT_CAT_MAST."comp_code") AS "product",

                "Paid_ins", "Contract_rate", "Deviation", "Variant_code",
                "Contract_name", "Contract_type", "Card_name", "Card_type",

                "Card_month", "Card_year", "Card_number", "Receipt_no",
                "Ad_Subcat3"  , "Ad_Subcat4" , "Ad_subcat5" , "Bg_color",
                "Bullet_code", "Bullet_premium",
                (SELECT "Agency_Name" FROM AGENCY_MAST WHERE "code_subcode" =TEMPBOOKING_MAST_AUDIT."Agency_sub_code") AS "AgencySubCode",

                NVL ((SELECT "Cust_Name"||'('||"Cust_Code"||')' FROM CUST_MAST WHERE "Cust_Code" = "Client_code"), "Client_code") AS "Client",                                       --112
                (SELECT DISTINCT "Payment_Mode_Name" FROM PAYMENT_MODE_MAST WHERE "Comp_Code"=compcode and "Pay_Mode_Code" = "Agency_pay") AS "PayMode",
                (SELECT "Adv_Cat_Name" FROM ADV_CAT_MAST WHERE ADV_CAT_MAST."Adv_Cat_Code" =TEMPBOOKING_MAST_AUDIT."Ad_cat_code") AS "categoryname",
                
                (SELECT "Adv_Subcat_Name" FROM ADV_SUBCAT_MAST  WHERE ADV_SUBCAT_MAST."Adv_Cat_Code"=TEMPBOOKING_MAST_AUDIT."Ad_cat_code" AND ADV_SUBCAT_MAST."Adv_Subcat_Code" =TEMPBOOKING_MAST_AUDIT."Ad_sub_cat_code")
                 AS "subcategoryname",
                 
                (SELECT "brand_name" FROM BRAND_MST WHERE "brand_code" =TEMPBOOKING_MAST_AUDIT."Brand_code") AS "Brand",
                (SELECT "Uom_Name" FROM UOM_MAST WHERE "Uom_Code" = TEMPBOOKING_MAST_AUDIT."Uom_code") AS "UOM",
                (SELECT "premiumname" FROM ADVPOS_PREM_MAST WHERE "Premiumcode" =TEMPBOOKING_MAST_AUDIT."Page_prem") AS "PagePremium",
                 (SELECT "Pos_Type" FROM ADVPOS_TYPE_MAST
                  WHERE "Pos_Type_Code" = TEMPBOOKING_MAST_AUDIT."Page_position_code") AS "PositionPremium",
                (SELECT "Curr_Name" FROM CURR_MAST WHERE "Curr_Code" = TEMPBOOKING_MAST_AUDIT."Currency_code") AS "Currency",
                "Material_status", TO_CHAR("Receipt_date",'dd/mm/yyyy') AS "Receipt_date", TEMPBOOKING_MAST_AUDIT."Region",
                "Variant", "Colortype",
                (SELECT "UOM_DESC" FROM UOM_MAST WHERE "Uom_Code" = TEMPBOOKING_MAST_AUDIT."Uom_code") AS "uom_desc",
                (SELECT "Logo" FROM UOM_MAST WHERE "Uom_Code" = TEMPBOOKING_MAST_AUDIT."Uom_code") AS "logo","Logo_H", "Logo_W", "Logo_color", "Logo_Uom",
                (SELECT "Logo_Uom" FROM UOM_MAST WHERE "Uom_Code" = TEMPBOOKING_MAST_AUDIT."Uom_code")  AS "logocode",
                (SELECT "Box_Charges_Native" FROM BOX_MAST WHERE BOX_MAST."Box_Code"=TEMPBOOKING_MAST_AUDIT."Box_code") AS "boxchrg",TEMPBOOKING_MAST_AUDIT.sapid,
                retainer,(SELECT "Retain_Name"||'('||"Retain_Code"||')' FROM RETAINERMASTER WHERE RETAINERMASTER."Retain_Code"=TEMPBOOKING_MAST_AUDIT.RETAINER) AS "RETAINER1",
                (SELECT "Package_Name" FROM combin_mast WHERE "Combin_Code" =

                TEMPBOOKING_MAST_AUDIT."Package_code") as "Package_cod",(SELECT "Col_Name" FROM col_mast WHERE "Col_Code" = TEMPBOOKING_MAST_AUDIT."Color_code") as

                "Color_cod",(SELECT "Pos_Type" FROM advpos_type_mast WHERE "Pos_Type_Code" =

                TEMPBOOKING_MAST_AUDIT."Page_position_code") as "Page_position_cod",
                decode(TEMPBOOKING_MAST_AUDIT."Booking_type",'1','BARTER','2','FMG','3','NORMAL','4','INHOUSE') as "Book_type",
                (SELECT "catname"  FROM  AD_CAT3   WHERE

                AD_CAT3."catcode"=TEMPBOOKING_MAST_AUDIT."Ad_Subcat3")   as "SUBCAT3",(SELECT "Cat_Name"  FROM  TBL_CAT4   WHERE

                TBL_CAT4."Cat_Code"=TEMPBOOKING_MAST_AUDIT."Ad_Subcat4") as "SUBCAT4"  ,(SELECT "Cat_Name"  FROM  TBL_CAT5   WHERE

                TBL_CAT5."Cat_Code"=TEMPBOOKING_MAST_AUDIT."Ad_subcat5") as "SUBCAT5",(SELECT "Comm_Rate" FROM ret_comm_details WHERE

                ret_comm_details."Retain_Code"=TEMPBOOKING_MAST_AUDIT.RETAINER and rowid=(select max(rowid) from ret_comm_details where ret_comm_details."Retain_Code"=TEMPBOOKING_MAST_AUDIT.RETAINER)) AS "RETAINER_COMM",(select AUDIT_COMMENT from tbl_booking_mast where tbl_booking_mast."cio_booking_id"=TEMPBOOKING_MAST_AUDIT."cio_booking_id") as "remarks","ADD_AGENCY_COMM",
                (SELECT "Box_Charges_Type" FROM BOX_MAST WHERE BOX_MAST."Box_Code"=TEMPBOOKING_MAST_AUDIT."Box_code") AS "boxchargetype",
                (SELECT "Box_Name" FROM BOX_MAST WHERE BOX_MAST."Box_Code"=TEMPBOOKING_MAST_AUDIT."Box_code") AS "boxname",
                ADD_AGENCY_COMM_AMT,RETAINER_COMM,RETAINER_COMM_AMT,

                (select "Bullet_Desc" from  bullet_mast where bullet_mast ."Bullet_Code"=TEMPBOOKING_MAST_AUDIT  ."BULLET_DESP") as "Bullet_Desc",
                TEMPBOOKING_MAST_AUDIT."Bullet_premium",(select RO_COMMENT from tbl_booking_mast where tbl_booking_mast."cio_booking_id"=TEMPBOOKING_MAST_AUDIT."cio_booking_id") as "RO_COMMENT"
                ,DOCTYPE,TRANSLATION_CODE, TRANSLATION_PREMIUM
                
                FROM TEMPBOOKING_MAST_AUDIT, AGENCY_MAST
                WHERE AGENCY_MAST."code_subcode" =TEMPBOOKING_MAST_AUDIT."Agency_sub_code"
                AND AGENCY_MAST."Comp_Code" = compcode ORDER BY "Creation_datetime";


      Dbms_output.put_line('rinki--');
----------------------------------------------------Lata------------------------------------------------------

      OPEN p_accounts1 FOR
         SELECT NVL(COUNT (*),'0') AS "count"
                     FROM TBL_BOOKING_MAST_LOG WHERE "Receipt_no" = ciobookid AND "audit" IS NOT NULL;

      BEGIN
         SELECT MAX (VSEQNO) INTO VERSION1 FROM TBL_BOOKING_MAST_LOG
          WHERE "Receipt_no" = ciobookid AND VSEQNO < (SELECT MAX (VSEQNO) FROM TBL_BOOKING_MAST_LOG WHERE "Receipt_no" = ciobookid);
            EXCEPTION WHEN NO_DATA_FOUND THEN NULL;
      END;

      OPEN p_accounts2 FOR
         SELECT    CASE dateformat
                     WHEN 'mm/dd/yyyy' THEN TO_CHAR("date_time",'mm/dd/yyyy')
                  WHEN 'dd/mm/yyyy' THEN TO_CHAR("date_time",'dd/mm/yyyy')
                     WHEN 'yyyy/mm/dd' THEN TO_CHAR("date_time",'yyyy/mm/dd')  END AS "date_time",
                 "branch", "booked_by", "cio_booking_id", "prev_booking", "applied_by","audit", "RO_No",
               CASE dateformat
                     WHEN 'mm/dd/yyyy' THEN TO_CHAR("RO_Date",'mm/dd/yyyy')
                  WHEN 'dd/mm/yyyy' THEN TO_CHAR("RO_Date",'dd/mm/yyyy')
                     WHEN 'yyyy/mm/dd' THEN TO_CHAR("RO_Date",'yyyy/mm/dd')  END AS "RO_Date",
                "Caption","bill_status", "ro_status",
                TBL_BOOKING_MAST_LOG."Agency_code", "Agency_address",
                "Client_code", "Client_address", "Agency_sub_code",
                "Dockit_no", "Executive_code", "Executive_zone",
                "Product_code", "Brand_code", "Key_no", "Bill_remarks",
                "Print_remark", "Package_code", "No_of_insertion",
            CASE dateformat
                     WHEN 'mm/dd/yyyy' THEN TO_CHAR("Insertion_date",'mm/dd/yyyy')
                  WHEN 'dd/mm/yyyy' THEN TO_CHAR("Insertion_date",'dd/mm/yyyy')
                     WHEN 'yyyy/mm/dd' THEN TO_CHAR("Insertion_date",'yyyy/mm/dd')  END AS "Insertion_date",

                "Repeating_day", "Ad_type_code", "Ad_cat_code",
                "Ad_sub_cat_code", "Color_code", "Uom_code",
                "Page_position_code", "Page_type_code", "Page_no",
                "Ad_size_type_code", "Ad_size_height", "Ad_size_width",
                "Rate_code", "Scheme_type_code", "Currency_code",
                "Agrred_rate", "Agreed_amount", "Special_discount",
                "Space_discount", "Special_charges",
                TBL_BOOKING_MAST_LOG."Comp_code",
                TBL_BOOKING_MAST_LOG."Userid",
                TBL_BOOKING_MAST_LOG."Agency_status", "Agency_type",
                "Agency_pay", "Agency_credit", "Total_area", "Card_rate",
                "Card_amount", "Discount", "Discount_per", "Bill_cycle",
                "Revenue_center", "Bill_pay", "Bill_height", "Bill_width",
                TBL_BOOKING_MAST_LOG."Bill_to", "Invoices", "Vts",
                "Bill_add", "Trade_disc", "Agency_out", "Booking_type",
                "Campaign", "Page_prem", "Page_amount", "Prem_per",
                "Gross_amount", "Bill_amount", "Box_code", "Box_no",
                "Box_agency", "Box_client", "Box_address", "Tfn" "Coupan_ad",
                "Ad_size_column", "Bill_column", "Bill_area",
                "Special_disc_per", "Space_disc_per",
                  AGENCY_MAST."Agency_Name"|| '('|| AGENCY_MAST."code_subcode"|| ')' AS "AgencyName",
                   (SELECT    EXEC_MAST."Exec_name" || '('|| TO_CHAR (EXEC_MAST."Exe_no") || ')'
                   FROM EXEC_MAST  WHERE TBL_BOOKING_MAST_LOG."Executive_code" =EXEC_MAST."Exe_no"
                    AND TBL_BOOKING_MAST_LOG."Comp_code" =EXEC_MAST."comp_code")AS "execname",
               (SELECT    PRODUCT_CAT_MAST."prod_desc"|| '('|| PRODUCT_CAT_MAST."prod_cat_code" || ')'
                   FROM PRODUCT_CAT_MAST WHERE TBL_BOOKING_MAST_LOG."Product_code" =PRODUCT_CAT_MAST."prod_cat_code"
                    AND TBL_BOOKING_MAST_LOG."Comp_code" =PRODUCT_CAT_MAST."comp_code")                                                                 AS "product",
                "Paid_ins", "Contract_rate", "Deviation", "Variant_code",
                "Contract_name", "Contract_type", "Card_name", "Card_type",
                "Card_month", "Card_year", "Card_number", "Receipt_no",
                "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color",
                (SELECT "Agency_Name" FROM AGENCY_MAST WHERE "code_subcode" = TBL_BOOKING_MAST_LOG."Agency_sub_code")AS "AgencySubCode",
               NVL ((SELECT "Cust_Name"  FROM CUST_MAST WHERE "Cust_Code" = "Client_code"),'' ) AS "Client",
              (SELECT distinct "Payment_Mode_Name"  FROM PAYMENT_MODE_MAST WHERE "Comp_Code"=compcode and "Pay_Mode_Code" = "Agency_pay") AS "PayMode",
               (SELECT "Adv_Cat_Name" FROM ADV_CAT_MAST WHERE ADV_CAT_MAST."Adv_Cat_Code" =TBL_BOOKING_MAST_LOG."Ad_cat_code")AS "categoryname",
               (SELECT "Adv_Subcat_Name"  FROM ADV_SUBCAT_MAST WHERE ADV_SUBCAT_MAST."Adv_Subcat_Code" =TBL_BOOKING_MAST_LOG."Ad_sub_cat_code")
                 AS "subcategoryname",
               (SELECT "brand_name"  FROM BRAND_MST   WHERE "brand_code" = TBL_BOOKING_MAST_LOG."Brand_code")AS "Brand",
               (SELECT "Uom_Name" FROM UOM_MAST WHERE "Uom_Code" =TBL_BOOKING_MAST_LOG."Uom_code")AS "UOM",
               (SELECT "premiumname" FROM ADVPOS_PREM_MAST WHERE "Premiumcode" =TBL_BOOKING_MAST_LOG."Page_type_code")AS "PagePremium",
                (SELECT "Pos_Type" FROM ADVPOS_TYPE_MAST WHERE "Pos_Type_Code" =TBL_BOOKING_MAST_LOG."Page_position_code")AS "PositionPremium",
               (SELECT "Curr_Name"  FROM CURR_MAST WHERE "Curr_Code" =TBL_BOOKING_MAST_LOG."Currency_code") AS "Currency"
           FROM TBL_BOOKING_MAST_LOG, AGENCY_MAST
             WHERE TBL_BOOKING_MAST_LOG."Receipt_no" = ciobookid
            AND VSEQNO = VERSION1
            AND AGENCY_MAST."code_subcode" =
                                    TBL_BOOKING_MAST_LOG."Agency_sub_code"
            AND AGENCY_MAST."Comp_Code" = compcode;

      OPEN p_accounts3 FOR

         SELECT    CASE dateformat
                     WHEN 'mm/dd/yyyy' THEN TO_CHAR("date_time",'mm/dd/yyyy')
                  WHEN 'dd/mm/yyyy' THEN TO_CHAR("date_time",'dd/mm/yyyy')
                     WHEN 'yyyy/mm/dd' THEN TO_CHAR("date_time",'yyyy/mm/dd')  END AS "date_time",
                   "branch","booked_by", "cio_booking_id", "prev_booking", "applied_by","audit", "RO_No",
              CASE dateformat
                     WHEN 'mm/dd/yyyy' THEN TO_CHAR("RO_Date",'mm/dd/yyyy')
                  WHEN 'dd/mm/yyyy' THEN TO_CHAR("RO_Date",'dd/mm/yyyy')
                     WHEN 'yyyy/mm/dd' THEN TO_CHAR("RO_Date",'yyyy/mm/dd')  END AS "RO_Date",
                "Caption","bill_status", "ro_status",
                TBL_BOOKING_MAST_LOG."Agency_code", "Agency_address",
                "Client_code", "Client_address", "Agency_sub_code",
                "Dockit_no", "Executive_code", "Executive_zone",
                "Product_code", "Brand_code", "Key_no", "Bill_remarks",
                "Print_remark", "Package_code", "No_of_insertion",
            CASE dateformat
                     WHEN 'mm/dd/yyyy' THEN TO_CHAR("Insertion_date",'mm/dd/yyyy')
                  WHEN 'dd/mm/yyyy' THEN TO_CHAR("Insertion_date",'dd/mm/yyyy')
                     WHEN 'yyyy/mm/dd' THEN TO_CHAR("Insertion_date",'yyyy/mm/dd')  END AS "Insertion_date",
                "Repeating_day", "Ad_type_code", "Ad_cat_code",
                "Ad_sub_cat_code", "Color_code", "Uom_code",
                "Page_position_code", "Page_type_code", "Page_no",
                "Ad_size_type_code", "Ad_size_height", "Ad_size_width",
                "Rate_code", "Scheme_type_code", "Currency_code",
                "Agrred_rate", "Agreed_amount", "Special_discount",
                "Space_discount", "Special_charges",
                TBL_BOOKING_MAST_LOG."Comp_code",
                TBL_BOOKING_MAST_LOG."Userid",
                TBL_BOOKING_MAST_LOG."Agency_status", "Agency_type",
                "Agency_pay", "Agency_credit", "Total_area", "Card_rate",
                "Card_amount", "Discount", "Discount_per", "Bill_cycle",
                "Revenue_center", "Bill_pay", "Bill_height", "Bill_width",
                TBL_BOOKING_MAST_LOG."Bill_to", "Invoices", "Vts",
                "Bill_add", "Trade_disc", "Agency_out", "Booking_type",
                "Campaign", "Page_prem", "Page_amount", "Prem_per",
                "Gross_amount", "Bill_amount", "Box_code", "Box_no",
                "Box_agency", "Box_client", "Box_address", "Tfn", "Coupan_ad",
                "Ad_size_column", "Bill_column", "Bill_area",
                "Special_disc_per", "Space_disc_per",
                 AGENCY_MAST."Agency_Name" || '('|| AGENCY_MAST."code_subcode"|| ')' AS "AgencyName",
                (SELECT    EXEC_MAST."Exec_name" || '('|| TO_CHAR (EXEC_MAST."Exe_no")|| ')'
                   FROM EXEC_MAST  WHERE TBL_BOOKING_MAST_LOG."Executive_code" = EXEC_MAST."Exe_no"
                    AND TBL_BOOKING_MAST_LOG."Comp_code" = EXEC_MAST."comp_code")AS "execname",
                (SELECT    PRODUCT_CAT_MAST."prod_desc" || '(' || PRODUCT_CAT_MAST."prod_cat_code" || ')'
                   FROM PRODUCT_CAT_MAST WHERE TBL_BOOKING_MAST_LOG."Product_code" =PRODUCT_CAT_MAST."prod_cat_code"
                    AND TBL_BOOKING_MAST_LOG."Comp_code" =PRODUCT_CAT_MAST."comp_code")AS "product",
                "Paid_ins", "Contract_rate", "Deviation", "Variant_code",
                "Contract_name", "Contract_type", "Card_name", "Card_type",
                "Card_month", "Card_year", "Card_number", "Receipt_no",
                "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color",
                "Bullet_code", "Bullet_premium",
                (SELECT "Agency_Name" FROM AGENCY_MAST WHERE "code_subcode" =TBL_BOOKING_MAST_LOG."Agency_sub_code")AS "AgencySubCode",
                NVL ((SELECT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code" = "Client_code"),'' ) AS "Client",
                (SELECT distinct "Payment_Mode_Name" FROM PAYMENT_MODE_MAST WHERE "Comp_Code"=compcode and "Pay_Mode_Code" = "Agency_pay") AS "PayMode",
                (SELECT "Adv_Cat_Name" FROM ADV_CAT_MAST WHERE ADV_CAT_MAST."Adv_Cat_Code" =TBL_BOOKING_MAST_LOG."Ad_cat_code")AS "categoryname",
                (SELECT "Adv_Subcat_Name" FROM ADV_SUBCAT_MAST WHERE ADV_SUBCAT_MAST."Adv_Subcat_Code" =TBL_BOOKING_MAST_LOG."Ad_sub_cat_code")AS "subcategoryname",
                (SELECT "brand_name" FROM BRAND_MST WHERE "brand_code" =TBL_BOOKING_MAST_LOG."Brand_code")AS "Brand",
                (SELECT "Uom_Name" FROM UOM_MAST WHERE "Uom_Code" =TBL_BOOKING_MAST_LOG."Uom_code")AS "UOM",
                (SELECT "premiumname" FROM ADVPOS_PREM_MAST  WHERE "Premiumcode" =TBL_BOOKING_MAST_LOG."Page_type_code")AS "PagePremium",
                (SELECT "Pos_Type" FROM ADVPOS_TYPE_MAST WHERE "Pos_Type_Code" = TBL_BOOKING_MAST_LOG."Page_position_code")AS "PositionPremium",
                (SELECT "Curr_Name" FROM CURR_MAST WHERE "Curr_Code" =TBL_BOOKING_MAST_LOG."Currency_code")AS "Currency"
           FROM TBL_BOOKING_MAST_LOG, AGENCY_MAST
          WHERE TBL_BOOKING_MAST_LOG."Receipt_no" = ciobookid
            AND VSEQNO =(SELECT MAX (VSEQNO) FROM TBL_BOOKING_MAST_LOG WHERE "Receipt_no" = ciobookid AND VSEQNO <
            (SELECT MAX(VSEQNO) FROM TBL_BOOKING_MAST_LOG WHERE "Receipt_no" = ciobookid) AND "audit" IS NOT NULL)
                        AND AGENCY_MAST."code_subcode" =
             TBL_BOOKING_MAST_LOG."Agency_sub_code" AND AGENCY_MAST."Comp_Code" = compcode;


   END Executebookingdispaudit_p;
END Executebookingdispaudit;
/


@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PACKAGE getstatuspaymode IS
TYPE T_Accounts_Cursor IS REF CURSOR;
PROCEDURE getstatuspaymode_p(
compcode in varchar2,
agency in varchar2,
agencysubcode in varchar2,
datecheck in varchar2,
adtype1 in varchar2,
dateformat in varchar2,
P_Accounts1  OUT  T_Accounts_cursor,P_Accounts2  OUT  T_Accounts_cursor,P_Accounts3  OUT  T_Accounts_cursor,P_Accounts4  OUT  T_Accounts_cursor,
P_Accounts5  OUT  T_Accounts_cursor,P_Accounts6  OUT  T_Accounts_cursor,P_Accounts7  OUT  T_Accounts_cursor,P_Accounts8  OUT  T_Accounts_cursor
);
End getstatuspaymode;
/
CREATE OR REPLACE PACKAGE BODY getstatuspaymode IS
PROCEDURE getstatuspaymode_p(
compcode in varchar2,
agency in varchar2,
agencysubcode in varchar2,
datecheck in varchar2,
adtype1 in varchar2,
dateformat in varchar2,
P_Accounts1  OUT  T_Accounts_cursor,P_Accounts2  OUT  T_Accounts_cursor,P_Accounts3  OUT  T_Accounts_cursor,P_Accounts4  OUT  T_Accounts_cursor,
P_Accounts5  OUT  T_Accounts_cursor,P_Accounts6  OUT  T_Accounts_cursor,P_Accounts7  OUT  T_Accounts_cursor,P_Accounts8  OUT  T_Accounts_cursor
)as
a number;
agtyp  varchar2(50);
pay1 varchar2(50);
par varchar2(8);
testcode varchar2(100);
idcou number;
cntadtype number;
V_OUTSTANDING_AMT_CRITERIA number;
begin
delete from temppay;
dbms_output.put_line('agencysub='||trim(agencysubcode));
dbms_output.put_line('compcode='||trim(compcode));
begin
select "SUB_Agency_Code","Agency_Code" into testcode,par from Agency_mast where (trim("Comp_Code")=upper(trim(compcode)) or trim("Comp_Code")=lower(trim(compcode))) and (trim("code_subcode")=upper(trim(agency)) or trim("code_subcode")=lower(trim(agency)));
--select "SUB_Agency_Code","Agency_Code" into testcode,par from Agency_mast where ("Comp_Code"=upper(trim(compcode)) or "Comp_Code"=lower(trim(compcode))) and ("code_subcode"=upper(trim(agencysubcode)) or "code_subcode"=lower(trim(agencysubcode)));
exception when no_data_found then
NULL ;
end;
dbms_output.put_line('par'||par);
dbms_output.put_line('testcode = ' ||testcode );
begin
select "Cash" into pay1 from pay_mode_mst  where (trim("Agency_Code")=upper(trim(par)) or trim("Agency_Code")=lower(trim(par))) and (trim("Agency_subcat_code")=upper(trim(testcode)) or trim("Agency_subcat_code")=lower(trim(testcode))) and (trim("Comp_Code")=upper(trim(compcode)) or trim("Comp_Code")=lower(trim(compcode)));
exception when no_data_found then
NULL ;
end;

a:=fn_SplitField(pay1,',');

insert into temppay  select Edition_Name from result;
dbms_output.put_line('par'||par);
dbms_output.put_line('testcode = ' ||testcode );
dbms_output.put_line(compcode);
--begin
--testcode :=testcode;



begin
select "Agency_Type_Code" into agtyp from agency_mast where (trim("Comp_Code")=upper(trim(compcode)) or trim("Comp_Code")=lower(trim(compcode)))
and  (trim("Agency_Code")=upper(trim(par)) or trim("Agency_Code")=lower(trim(par)))
and (trim("SUB_Agency_Code")=upper(trim(testcode)) or trim("SUB_Agency_Code")=lower(trim(testcode)));
exception when no_data_found then
NULL ;
end;

dbms_output.put_line('lata--'||agtyp);
open P_Accounts1 for
select "Agency_Type_Name" AS "agency_type_name" from agency_type_mst where (trim("Agency_Type_Code")=upper(trim(agtyp)) or trim("Agency_Type_Code")=lower(trim(agtyp))) and (trim("Comp_Code")=upper(trim(compcode)) or trim("Comp_Code")=lower(trim(compcode)));


open P_Accounts2 for
select tblstatus."Status_Name" AS "status_name" from status_detail,tblstatus where tblstatus."Status_Code"=status_detail."STATUS_NAME" and trim("agency_code")=par and trim("agency_subcat_code")=testcode and trim("comp_code")=upper(trim(compcode)) and datecheck between "FROM_DATE" and "TO_DATE";

open P_Accounts3 for
select "Credit_Days","ALERT",CREDIT_LIMIT,BOOKING_TYPE from agency_mast where "Comp_Code"=upper(trim(compcode)) and "Agency_Code"=par and "SUB_Agency_Code"=testcode;

open P_Accounts4 for
select "Rate_Group" from agency_mast where "Comp_Code"=upper(trim(compcode)) and "Agency_Code"=par and "SUB_Agency_Code"=testcode;
    begin 
        select count(*) into cntadtype from comm_details where "Agency_code"=par and "Agency_sub_code"=testcode and "Comp_code"=upper(trim(compcode)) and datecheck between "Eff_from_Date" and "Eff_Till_Date" and "ADTYPE"=adtype1;
    EXCEPTION WHEN NO_DATA_FOUND THEN
    cntadtype:=0;
    END;
    if(cntadtype>0) then
        open P_Accounts5 for
        select "Comm_Rate" as "comm_rate",agtyp as "agencytypecode" ,"Addl_Comm_Rate",nvl(ADDITIONAL_FLAG,'0') as FLAG,CASH_DISCOUNT,CASH_DISCOUNTTYPE,
        (SELECT CASH_DISCOUNT FROM PREFERRENCES WHERE "comp_code"=comm_details."Comp_code") AS CASH_DISCOUNT1,(SELECT CASH_DISCOUNTTYPE FROM PREFERRENCES WHERE "comp_code"=comm_details."Comp_code") AS CASH_DISCOUNTTYPE
         from comm_details where "Agency_code"=par and "Agency_sub_code"=testcode and "Comp_code"=upper(trim(compcode)) and datecheck between "Eff_from_Date" and "Eff_Till_Date" and "ADTYPE"=adtype1;
    else
        open P_Accounts5 for
        select "Comm_Rate" as "comm_rate",agtyp as "agencytypecode","Addl_Comm_Rate",nvl(ADDITIONAL_FLAG,'0') as FLAG,CASH_DISCOUNT,CASH_DISCOUNTTYPE,
        (SELECT CASH_DISCOUNT FROM PREFERRENCES WHERE "comp_code"=comm_details."Comp_code") AS CASH_DISCOUNT1,(SELECT CASH_DISCOUNTTYPE FROM PREFERRENCES WHERE "comp_code"=comm_details."Comp_code") AS CASH_DISCOUNTTYPE
          from comm_details where "Agency_code"=par and "Agency_sub_code"=testcode and "Comp_code"=upper(trim(compcode)) and datecheck between "Eff_from_Date" and "Eff_Till_Date" and ("ADTYPE"='0' or "ADTYPE" is null);
    end if;
           
open P_Accounts6 for

select "Payment_Mode_Name" as "payment_mode_name","Pay_Mode_Code" as "pay_mode_code" from payment_mode_mast where
    "Pay_Mode_Code" in (select "PAYNAME" from temppay) and "Comp_Code"=upper(trim(compcode)) order by "Pay_Mode_Code" desc;

--begin
  --  select  max("Receipt_no") into idcou from  Ad_tableid;
    --exception when no_data_found then NULL ;
--end;

select count(*) into idcou from Ad_tableid;
 select OUTSTANDING_AMT_CRITERIA into V_OUTSTANDING_AMT_CRITERIA from PREFERRENCES where "comp_code" =compcode;

 if(idcou>0)then
    open P_Accounts7 for
    select  max("Receipt_no") as recno from  Ad_tableid ;
    

    open P_Accounts8 for
    select adagency_outstanding(compcode,'','',agency,to_char(sysdate,dateformat),dateformat) as "outstand" ,V_OUTSTANDING_AMT_CRITERIA as "OUTSTANDING_AMT_CRITERIA"   from dual;

   -- idcou:=idcou+1;

--    update Ad_tableid set "Receipt_no"=(select nvl(max("Receipt_no"),0)+1 from ad_tableid);
    commit;
 else

    insert into Ad_tableid("Receipt_no") values(1);
    
    open P_Accounts7 for
    select  max("Receipt_no") as recno from  Ad_tableid ;

   -- select OUTSTANDING_AMT_CRITERIA into V_OUTSTANDING_AMT_CRITERIA from PREFERRENCES where "comp_code" =compcode;


    open P_Accounts8 for
    select adagency_outstanding(compcode,'','',agency,to_char(sysdate,dateformat),dateformat) as "outstand",V_OUTSTANDING_AMT_CRITERIA as "OUTSTANDING_AMT_CRITERIA"   from dual;


 end if;

end getstatuspaymode_p;
End getstatuspaymode;
/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PACKAGE BODY GETRETAINER
IS
     PROCEDURE GETRETAINER_p
    (
        COMPCODE1   IN  VARCHAR2,
        PUBCENTER   IN  VARCHAR2,
         center in varchar2,
        p_accounts  out t_accounts_cursor
    )

    AS

    BEGIN
       
       -- SELECT "Retain_Name","Retain_Code" FROM RETAINERMASTER WHERE "Comp_Code"=COMPCODE1;-- AND "pubcent_code"=PUBCENTER;
       if center ='0' or center is null then
        OPEN p_accounts for
         SELECT "Retain_Name","Retain_Code" FROM RETAINERMASTER WHERE "Comp_Code"=COMPCODE1 AND "Retain_Name" LIKE  '%'|| upper(PUBCENTER) ||'%'
          and (SELECT  "Status_Name" FROM TBLSTATUS WHERE "Status_Code" =(select STATUS_NAME from ret_status_detail where
            "Retain_Code"=RETAINERMASTER."Retain_Code" and rownum <=1 AND sysdate between "FROM_DATE" and "TO_DATE"))='ACTIVE'
         ORDER BY "Retain_Name";
       else
        OPEN p_accounts for
         SELECT "Retain_Name","Retain_Code" FROM RETAINERMASTER WHERE "Comp_Code"=COMPCODE1 AND "Retain_Name" LIKE  '%'|| upper(PUBCENTER) ||'%'
        and "Dist_Code"=(select "Dist_Code" from branch_mst where "Branch_Code"=center)  and (SELECT  "Status_Name" FROM TBLSTATUS WHERE "Status_Code" =(select STATUS_NAME from ret_status_detail where
            "Retain_Code"=RETAINERMASTER."Retain_Code" and rownum <=1 AND sysdate between "FROM_DATE" and "TO_DATE"))='ACTIVE'
         ORDER BY "Retain_Name";-- AND "pubcent_code"=PUBCENTER;
       end if;
      
    END GETRETAINER_p;
END GETRETAINER;
/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PACKAGE BODY websp_getExec is
procedure websp_getExec_p(
compcode in varchar2,
execname in varchar2,
value in varchar2,
center in varchar2,
P_Accounts out T_Accounts_Cursor)as
begin
if center is not null and center!='0' then
    if(value <> '3')then
    open P_Accounts for
    select "Exe_no" as "exe_no","Exec_name" as "exec_name" from exec_mast where "comp_code"=compcode and  "Exec_name" like '%' || upper(execname)||'%'
    and "dist_code"=(select "Dist_Code" from branch_mst where "Branch_Code"=center) and "exe_status"='Active' order by "Exec_name";
    end if;
    if(value='3') then
    open P_Accounts for
    select "Exe_no" as "exe_no","Exec_name" as "exec_name" from exec_mast where "comp_code"=compcode and "Exe_no"=execname and "exe_status"='Active' order by "Exec_name";
    end if;
else
    if(value <> '3')then
    open P_Accounts for
    select "Exe_no" as "exe_no","Exec_name" as "exec_name" from exec_mast where "comp_code"=compcode and  "Exec_name" like '%' || upper(execname)||'%' and "exe_status"='Active'
     order by "Exec_name";
    end if;
    if(value='3') then
    open P_Accounts for
    select "Exe_no" as "exe_no","Exec_name" as "exec_name" from exec_mast where "comp_code"=compcode and "Exe_no"=execname and "exe_status"='Active' order by "Exec_name";
    end if;
end if;
end websp_getExec_p;
end  websp_getExec;
/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PACKAGE BODY executebooking
IS
   PROCEDURE executebooking_p (
      compcode      IN       VARCHAR2,
      ciobookid     IN       VARCHAR2,
      docno         IN       VARCHAR2 := NULL,
      keyno         IN       VARCHAR2 := NULL,
      rono          IN       VARCHAR2 := NULL,
      agencycode    IN       VARCHAR2 := NULL,
      client        IN       VARCHAR2 := NULL,
      booking       IN       VARCHAR2,
       dateformat     IN          VARCHAR2,
      revenue in varchar2,
      p_accounts    OUT      t_accounts_cursor,
      p_accounts1   OUT      t_accounts_cursor,
      p_accounts2   OUT      t_accounts_cursor,
      P_Accounts3  OUT  T_Accounts_Cursor
   )
   AS
      VERSION1   NUMBER;
      count1    NUMBER;

   BEGIN

       DELETE from tempbooking_mast;

      INSERT INTO tempbooking_mast
         SELECT "date_time", "branch", "booked_by", "cio_booking_id",
                "prev_booking", "applied_by", "audit", "RO_No", "RO_Date",
                "Caption", "bill_status", "ro_status", "Agency_code",
                "Agency_address", "Client_code", "Client_address",
                "Agency_sub_code", "Dockit_no", "Executive_code",
                "Executive_zone", "Product_code", "Brand_code", "Key_no",
                "Bill_remarks", "Print_remark", "Package_code",
                "No_of_insertion", "Insertion_date", "Repeating_day",
                "Ad_type_code", "Ad_cat_code", "Ad_sub_cat_code",
                "Color_code", "Uom_code", "Page_position_code",
                "Page_type_code", "Page_no", "Ad_size_type_code",
                "Ad_size_height", "Ad_size_width", "Rate_code",
                "Scheme_type_code", "Currency_code", nvl("Agrred_rate",'0'),
                nvl("Agreed_amount",'0'), "Special_discount", "Space_discount",
                "Special_charges", "Agency_status", "Agency_type",
                "Agency_pay", "Agency_credit", "Total_area", "Card_rate",
                "Card_amount", nvl("Discount",'0'), "Discount_per", "Bill_cycle",
                "Revenue_center", "Bill_pay", "Bill_height", "Bill_width",
                "Bill_to", "Invoices", "Vts", "Bill_add", "Trade_disc",
                "Agency_out", "Box_code", "Box_no", "Box_agency",
                "Box_client", "Box_address", "Comp_code", "Userid",
                "Creation_datetime", "Booking_type", "Tfn", "Coupan_ad",
                "Campaign", "Bill_amount", "Page_prem", "Page_amount",
                "Prem_per", "Gross_amount", "Ad_size_column", "Bill_column",
                "Bill_area", "Special_disc_per", "Space_disc_per",
                "Paid_ins", "Contract_rate", "Deviation", "Variant_code",
                "Contract_name", "Contract_type", "Card_name", "Card_type",
                "Card_month", "Card_year", "Card_number", "Receipt_no",
                "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color",
                "Bullet_code", "Bullet_premium", "Material_status",
                trunc("Receipt_date"), "prev_cioid", "prev_receipt",
                "prev_grossamt", "Region", "Variant", "Colortype", "Logo_H",
                "Logo_W", "Logo_color", "Logo_Uom",sapid,RETAINER,"ADD_AGENCY_COMM",MOBILENO,ADD_AGENCY_COMM_AMT,RETAINER_COMM,RETAINER_COMM_AMT,CASH_RECIEVED,CIRAGENCY,CIRRATE,CIREDITION,CIRPUBLICATION,CIRAGENCY_SUBCODE,BARTER_TYPE,
                CASHDISCOUNT, CASHDISCTYPE, ATTACHMENT1, ATTACHMENT2, DISC_PREMIUM,CHKTRADEDISC,CHK_DATE, CHK_AMT, CHK_BANK_NAME, OUR_BANK, CHK_NO,DEALERPANEL, DEALER_H, DEALER_W, DEALERTYPE,ACTIVE_AGREEDRATE,ACTIVE_AGREEDAMT,
                LOCALGROSSAMT, LOCALBILLAMT,PACKAGE_TYPE,AD_REFID,RECEIPT_CURRENCY, CONV_CURR_RATE,REVISE_DATE, CLIENT_TYPE,TRANSLATION_CODE,TRANSLATION_PREMIUM
           FROM tbl_booking_mast
          WHERE ("Comp_code" = compcode OR compcode IS NULL)
            AND (("cio_booking_id" = ciobookid OR ciobookid IS NULL
                ) OR("Receipt_no"=ciobookid OR ciobookid IS NULL))
            AND ("Dockit_no" LIKE docno || '%' OR docno IS NULL)
            AND ("Key_no" LIKE keyno || '%' OR keyno IS NULL)
            AND ("RO_No" LIKE rono || '%' OR rono IS NULL)
            AND ("Agency_sub_code" LIKE agencycode || '%' OR agencycode IS NULL)
            AND ("Client_code" LIKE client || '%' OR client IS NULL)
           AND ("Ad_type_code" LIKE booking || '%' OR booking IS NULL) 
           AND "branch" in(SELECT LTRIM(RTRIM(BRANCH_CODE)) FROM LOGIN_BRANCH_MAST WHERE USER_CODE=revenue and COMP_CODE=compcode and USER_FLAG='Y')
            ORDER BY "Creation_datetime";



  --Dbms_output.put_line('rinki--');
      OPEN p_accounts FOR
           SELECT CASE dateformat
                     WHEN 'mm/dd/yyyy' THEN TO_CHAR("date_time",'mm/dd/yyyy')
                  WHEN 'dd/mm/yyyy' THEN TO_CHAR("date_time",'dd/mm/yyyy')
                     WHEN 'yyyy/mm/dd' THEN TO_CHAR("date_time",'yyyy/mm/dd')  END AS date_time,
                      "branch","booked_by", "cio_booking_id", "prev_booking", "applied_by",
                "audit", "RO_No", TO_CHAR("RO_Date", 'dd/mm/yyyy') AS "RO_Date",
                "Caption", "bill_status", "ro_status", "Agency_code",
                "Agency_address", "Client_code", "Client_address",
                "Agency_sub_code", "Dockit_no", "Executive_code",
                "Executive_zone", "Product_code", "Brand_code", "Key_no",
                "Bill_remarks", "Print_remark", "Package_code",
                "No_of_insertion",
                TO_CHAR("Insertion_date", 'dd/mm/yyyy') AS "Insertion_date",
                "Repeating_day", "Ad_type_code", "Ad_cat_code",
                "Ad_sub_cat_code", "Color_code", "Uom_code",
                "Page_position_code", "Page_type_code", "Page_no",
                "Ad_size_type_code", "Ad_size_height", "Ad_size_width",
                "Rate_code",
                (SELECT "Scheme_Name" FROM scheme_master WHERE "scheme_id" =tempbooking_mast."Scheme_type_code")AS "Scheme_type_code",
                 "Currency_code", "Agrred_rate", "Agreed_amount",
                "Special_discount", "Space_discount", "Special_charges",
                tempbooking_mast."Comp_code", tempbooking_mast."Userid",
                tempbooking_mast."Agency_status", "Agency_type", "Agency_pay",
                "Agency_credit", "Total_area", "Card_rate", "Card_amount",
                "Discount", "Discount_per", "Bill_cycle", "Revenue_center",
                "Bill_pay", "Bill_height", "Bill_width",
                tempbooking_mast."Bill_to", "Invoices", "Vts", "Bill_add",
                "Trade_disc", "Agency_out", "Booking_type", "Campaign",
                "Page_prem", "Page_amount", "Prem_per", "Gross_amount",
                "Bill_amount", "Box_code", "Box_no", "Box_agency",
                "Box_client", "Box_address", "Tfn", "Coupan_ad",
                "Ad_size_column", "Bill_column", "Bill_area",
                "Special_disc_per", "Space_disc_per",
                   agency_mast."Agency_Name"
                || '('
                || agency_mast."code_subcode"
                || ')' AS "AgencyName",
                (SELECT   exec_mast."Exec_name"
                        || '('
                        || TO_CHAR(exec_mast."Exe_no")
                        || ')'
                   FROM exec_mast
                  WHERE tempbooking_mast."Executive_code" = exec_mast."Exe_no"
                    AND tempbooking_mast."Comp_code" = exec_mast."comp_code") AS "execname",
                    --91
                (SELECT    product_cat_mast."prod_desc"
                        || '('
                        || product_cat_mast."prod_cat_code"
                        || ')'
                   FROM product_cat_mast
                  WHERE tempbooking_mast."Product_code" = product_cat_mast."prod_cat_code"
                    AND tempbooking_mast."Comp_code" = product_cat_mast."comp_code") AS "product",
                    --92
                "Paid_ins", "Contract_rate", "Deviation", "Variant_code",
                (select "deal_name" from contract_mast where "Deal_No"= (select "deal_code" from contract_detail where "ContractCode"= "Contract_name")) as "Contract_name", "Contract_type", "Card_name", "Card_type",
                --100
                "Card_month", "Card_year", "Card_number", "Receipt_no",
                "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color",
                "Bullet_code", "Bullet_premium",
                (SELECT "Agency_Name" FROM agency_mast
                  WHERE "code_subcode" =tempbooking_mast."Agency_sub_code") AS "AgencySubCode",
              --111
                NVL ((SELECT "Cust_Name" FROM cust_mast WHERE "Cust_Code" = "Client_code"), '') AS "Client",                                       --112
                (SELECT "Payment_Mode_Name" FROM payment_mode_mast WHERE "Pay_Mode_Code" = "Agency_pay") AS "PayMode",
                (SELECT "Adv_Cat_Name" FROM adv_cat_mast WHERE adv_cat_mast."Adv_Cat_Code" =tempbooking_mast."Ad_cat_code") AS "categoryname",
                (SELECT "Adv_Subcat_Name" FROM adv_subcat_mast  WHERE adv_subcat_mast."Adv_Subcat_Code" =tempbooking_mast."Ad_sub_cat_code")
                 AS "subcategoryname",
                (SELECT "brand_name" FROM brand_mst WHERE "brand_code" =tempbooking_mast."Brand_code") AS "Brand",
                (SELECT "Uom_Name" FROM uom_mast WHERE "Uom_Code" = tempbooking_mast."Uom_code") AS "UOM",
                (SELECT "premiumname" FROM advpos_prem_mast WHERE "Premiumcode" =tempbooking_mast."Page_type_code")
                  AS "PagePremium",
                 (SELECT "Pos_Type"
                   FROM advpos_type_mast
                  WHERE "Pos_Type_Code" =
                           tempbooking_mast."Page_position_code")
                                                         AS "PositionPremium",
                (SELECT "Curr_Name"
                   FROM curr_mast
                  WHERE "Curr_Code" =
                               tempbooking_mast."Currency_code")
                                                                AS "Currency",
                "Material_status", TO_CHAR("Receipt_date",'dd/mm/yyyy') as "Receipt_date", tempbooking_mast."Region",
                "Variant", "Colortype",
                (SELECT "UOM_DESC"
                   FROM uom_mast
                  WHERE "Uom_Code" =
                                    tempbooking_mast."Uom_code")
                                                                AS "uom_desc",
                (SELECT "Logo"
                   FROM uom_mast
                  WHERE "Uom_Code" = tempbooking_mast."Uom_code") AS "logo",
                "Logo_H", "Logo_W", "Logo_color", "Logo_Uom",
                (SELECT "Logo_Uom"
                   FROM uom_mast
                  WHERE "Uom_Code" = tempbooking_mast."Uom_code")  AS "logocode",
                (select "Box_Charges_Native" from box_mast where box_mast."Box_Code"=tempbooking_mast."Box_code" and "pub_center"=(select "pub_center" from branch_mst where "Branch_Code"=tempbooking_mast."branch")) as "boxchrg",tempbooking_mast.sapid,
                retainer,(select "Retain_Name" from retainermaster where retainermaster."Retain_Code"=tempbooking_mast.retainer) as "RETAINER", (SELECT "Retain_Name"||'('||"Retain_Code"||')' FROM RETAINERMASTER WHERE RETAINERMASTER."Retain_Code"=TEMPBOOKING_MAST.RETAINER) AS "RETAINER1", (SELECT "Package_Name" FROM combin_mast WHERE "Combin_Code" = 

TEMPBOOKING_MAST."Package_code") as "Package_cod",(SELECT "Col_Name" FROM col_mast WHERE "Col_Code" = TEMPBOOKING_MAST."Color_code") as 

"Color_cod",(SELECT "Pos_Type" FROM advpos_type_mast WHERE "Pos_Type_Code" = 

TEMPBOOKING_MAST."Page_position_code") as "Page_position_cod",decode(TEMPBOOKING_MAST."Booking_type",'1','FMG','2','BARTER','3','NORMAL','4','COMPLIMEN

TRY') as "Book_type",(SELECT "catname"  FROM  AD_CAT3   WHERE 

AD_CAT3."catcode"=TEMPBOOKING_MAST."Ad_Subcat3")  as "Subcat3",(SELECT "Cat_Name"  FROM  TBL_CAT4   WHERE 

TBL_CAT4."Cat_Code"=TEMPBOOKING_MAST."Ad_Subcat4") as "Subcat4",(SELECT "Cat_Name"  FROM  TBL_CAT5   WHERE 

TBL_CAT5."Cat_Code"=TEMPBOOKING_MAST."Ad_subcat5") as "subcat5",(SELECT "Comm_Rate" FROM ret_comm_details WHERE 

ret_comm_details."Retain_Code"=TEMPBOOKING_MAST.RETAINER and rowid=(select max(rowid) from ret_comm_details where ret_comm_details."Retain_Code"=TEMPBOOKING_MAST.RETAINER)) AS "RETAINER_COMM","ADD_AGENCY_COMM",
tempbooking_mast."Scheme_type_code",MOBILENO,
CASHDISCOUNT, CASHDISCTYPE, ATTACHMENT1, ATTACHMENT2, DISC_PREMIUM,CHKTRADE,CHK_DATE, CHK_AMT, CHK_BANK_NAME, OUR_BANK, CHK_NO, agency_mast.BOOKING_TYPE,
DEALERPANEL, DEALER_H, DEALER_W, DEALERTYPE,MOBILENO,
                     (select "Comm_Rate" from comm_details where "Agency_code" || "Agency_sub_code"=TEMPBOOKING_MAST."Agency_sub_code"
 and "Comp_Code"=upper(compcode) and SYSDATE between "Eff_from_Date" and "Eff_Till_Date" AND ROWNUM<=1 ) as COMM_RATE,ACTIVE_AGREEDRATE,ACTIVE_AGREEDAMT, NVL(LOCALGROSSAMT,"Gross_amount") AS LOCALGROSSAMT, NVL(LOCALBILLAMT,"Bill_amount") as LOCALBILLAMT 
/*for Display and classified*/
           FROM tempbooking_mast, agency_mast
          WHERE agency_mast."code_subcode" =
                                            tempbooking_mast."Agency_sub_code"
            AND agency_mast."Comp_Code" = compcode order by "Creation_datetime";


      Dbms_output.put_line('rinki--');
----------------------------------------------------Lata------------------------------------------------------

      OPEN p_accounts1 FOR
      SELECT 'A' AS A FROM DUAL;
      /*   SELECT NVL(COUNT (*),'0') AS "count"
                     FROM tbl_booking_mast_LOG
          WHERE "Receipt_no" = ciobookid AND "audit" IS NOT NULL;


      BEGIN

         SELECT MAX (VSEQNO)
           INTO VERSION1
           FROM tbl_booking_mast_LOG
          WHERE "Receipt_no" = ciobookid
            AND VSEQNO < (SELECT MAX (VSEQNO)
                               FROM tbl_booking_mast_LOG
                              WHERE "Receipt_no" = ciobookid);
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            NULL;
      END;
*/
      OPEN p_accounts2 FOR
      SELECT 'A' AS A FROM DUAL;
        /* SELECT TO_CHAR ("date_time", 'dd/mm/yyyy') AS "date_time", "branch",
                "booked_by", "cio_booking_id", "prev_booking", "applied_by",
                "audit", "RO_No",
                TO_CHAR ("RO_Date", 'dd/mm/yyyy') AS "RO_Date", "Caption",
                "bill_status", "ro_status",
                tbl_booking_mast_log."Agency_code", "Agency_address",
                "Client_code", "Client_address", "Agency_sub_code",
                "Dockit_no", "Executive_code", "Executive_zone",
                "Product_code", "Brand_code", "Key_no", "Bill_remarks",
                "Print_remark", "Package_code", "No_of_insertion",
                TO_CHAR ("Insertion_date", 'dd/mm/yyyy') AS "Insertion_date",
                "Repeating_day", "Ad_type_code", "Ad_cat_code",
                "Ad_sub_cat_code", "Color_code", "Uom_code",
                "Page_position_code", "Page_type_code", "Page_no",
                "Ad_size_type_code", "Ad_size_height", "Ad_size_width",
                "Rate_code", "Scheme_type_code", "Currency_code",
                "Agrred_rate", "Agreed_amount", "Special_discount",
                "Space_discount", "Special_charges",
                tbl_booking_mast_log."Comp_code",
                tbl_booking_mast_log."Userid",
                tbl_booking_mast_log."Agency_status", "Agency_type",
                "Agency_pay", "Agency_credit", "Total_area", "Card_rate",
                "Card_amount", "Discount", "Discount_per", "Bill_cycle",
                "Revenue_center", "Bill_pay", "Bill_height", "Bill_width",
                tbl_booking_mast_log."Bill_to", "Invoices", "Vts",
                "Bill_add", "Trade_disc", "Agency_out", "Booking_type",
                "Campaign", "Page_prem", "Page_amount", "Prem_per",
                "Gross_amount", "Bill_amount", "Box_code", "Box_no",
                "Box_agency", "Box_client", "Box_address", "Tfn" "Coupan_ad",
                "Ad_size_column", "Bill_column", "Bill_area",
                "Special_disc_per", "Space_disc_per",
                  agency_mast."Agency_Name"|| '('|| agency_mast."code_subcode"|| ')' AS "AgencyName",
                   (SELECT    exec_mast."Exec_name" || '('|| TO_CHAR (exec_mast."Exe_no") || ')'
                   FROM exec_mast  WHERE tbl_booking_mast_log."Executive_code" =exec_mast."Exe_no"
                    AND tbl_booking_mast_log."Comp_code" =exec_mast."comp_code")AS "execname",
               (SELECT    product_cat_mast."prod_desc"|| '('|| product_cat_mast."prod_cat_code" || ')'
                   FROM product_cat_mast WHERE tbl_booking_mast_log."Product_code" =product_cat_mast."prod_cat_code"
                    AND tbl_booking_mast_log."Comp_code" =product_cat_mast."comp_code")                                                                 AS "product",
                "Paid_ins", "Contract_rate", "Deviation", "Variant_code",
                "Contract_name", "Contract_type", "Card_name", "Card_type",
                "Card_month", "Card_year", "Card_number", "Receipt_no",
                "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color",
                (SELECT "Agency_Name" FROM agency_mast WHERE "code_subcode" = tbl_booking_mast_log."Agency_sub_code")AS "AgencySubCode",
               NVL ((SELECT "Cust_Name"  FROM cust_mast WHERE "Cust_Code" = "Client_code"),'' ) AS "Client",
              (SELECT "Payment_Mode_Name"  FROM payment_mode_mast WHERE "Pay_Mode_Code" = "Agency_pay") AS "PayMode",
               (SELECT "Adv_Cat_Name" FROM adv_cat_mast WHERE adv_cat_mast."Adv_Cat_Code" =tbl_booking_mast_log."Ad_cat_code")AS "categoryname",
               (SELECT "Adv_Subcat_Name"  FROM adv_subcat_mast WHERE adv_subcat_mast."Adv_Subcat_Code" =tbl_booking_mast_log."Ad_sub_cat_code")
                 AS "subcategoryname",
               (SELECT "brand_name"  FROM brand_mst   WHERE "brand_code" = tbl_booking_mast_log."Brand_code")AS "Brand",
               (SELECT "Uom_Name" FROM uom_mast WHERE "Uom_Code" =tbl_booking_mast_log."Uom_code")AS "UOM",
               (SELECT "premiumname" FROM advpos_prem_mast WHERE "Premiumcode" =tbl_booking_mast_log."Page_type_code")AS "PagePremium",
                (SELECT "Pos_Type" FROM advpos_type_mast WHERE "Pos_Type_Code" =tbl_booking_mast_log."Page_position_code")AS "PositionPremium",
               (SELECT "Curr_Name"  FROM curr_mast WHERE "Curr_Code" =tbl_booking_mast_log."Currency_code") AS "Currency"
           FROM tbl_booking_mast_log, agency_mast
             WHERE tbl_booking_mast_log."Receipt_no" = ciobookid
            AND VSEQNO = VERSION1
            AND agency_mast."code_subcode" =
                                    tbl_booking_mast_log."Agency_sub_code"
            AND agency_mast."Comp_Code" = compcode;
*/
      OPEN p_accounts3 FOR
      SELECT 'A' AS A FROM DUAL;
--select * from tbl_booking_mast_log where cio_booking_id=@ciobookid and version=@version
       /*   SELECT TO_CHAR ("date_time", 'dd/mm/yyyy') AS "date_time", "branch",
                "booked_by", "cio_booking_id", "prev_booking", "applied_by",
                "audit", "RO_No",
                TO_CHAR ("RO_Date", 'dd/mm/yyyy') AS "RO_Date", "Caption",
                "bill_status", "ro_status",
                tbl_booking_mast_log."Agency_code", "Agency_address",
                "Client_code", "Client_address", "Agency_sub_code",
                "Dockit_no", "Executive_code", "Executive_zone",
                "Product_code", "Brand_code", "Key_no", "Bill_remarks",
                "Print_remark", "Package_code", "No_of_insertion",
                TO_CHAR ("Insertion_date", 'dd/mm/yyyy') AS "Insertion_date",
                "Repeating_day", "Ad_type_code", "Ad_cat_code",
                "Ad_sub_cat_code", "Color_code", "Uom_code",
                "Page_position_code", "Page_type_code", "Page_no",
                "Ad_size_type_code", "Ad_size_height", "Ad_size_width",
                "Rate_code", "Scheme_type_code", "Currency_code",
                "Agrred_rate", "Agreed_amount", "Special_discount",
                "Space_discount", "Special_charges",
                tbl_booking_mast_log."Comp_code",
                tbl_booking_mast_log."Userid",
                tbl_booking_mast_log."Agency_status", "Agency_type",
                "Agency_pay", "Agency_credit", "Total_area", "Card_rate",
                "Card_amount", "Discount", "Discount_per", "Bill_cycle",
                "Revenue_center", "Bill_pay", "Bill_height", "Bill_width",
                tbl_booking_mast_log."Bill_to", "Invoices", "Vts",
                "Bill_add", "Trade_disc", "Agency_out", "Booking_type",
                "Campaign", "Page_prem", "Page_amount", "Prem_per",
                "Gross_amount", "Bill_amount", "Box_code", "Box_no",
                "Box_agency", "Box_client", "Box_address", "Tfn", "Coupan_ad",
                "Ad_size_column", "Bill_column", "Bill_area",
                "Special_disc_per", "Space_disc_per",
                 agency_mast."Agency_Name" || '('|| agency_mast."code_subcode"|| ')' AS "AgencyName",
                (SELECT    exec_mast."Exec_name" || '('|| TO_CHAR (exec_mast."Exe_no")|| ')'
                   FROM exec_mast  WHERE tbl_booking_mast_log."Executive_code" = exec_mast."Exe_no"
                    AND tbl_booking_mast_log."Comp_code" = exec_mast."comp_code")AS "execname",
                (SELECT    product_cat_mast."prod_desc" || '(' || product_cat_mast."prod_cat_code" || ')'
                   FROM product_cat_mast WHERE tbl_booking_mast_log."Product_code" =product_cat_mast."prod_cat_code"
                    AND tbl_booking_mast_log."Comp_code" =product_cat_mast."comp_code")AS "product",
                "Paid_ins", "Contract_rate", "Deviation", "Variant_code",
                "Contract_name", "Contract_type", "Card_name", "Card_type",
                "Card_month", "Card_year", "Card_number", "Receipt_no",
                "Ad_Subcat3", "Ad_Subcat4", "Ad_subcat5", "Bg_color",
                "Bullet_code", "Bullet_premium",
                (SELECT "Agency_Name" FROM agency_mast WHERE "code_subcode" =tbl_booking_mast_log."Agency_sub_code")AS "AgencySubCode",
                NVL ((SELECT "Cust_Name" FROM cust_mast WHERE "Cust_Code" = "Client_code"),'' ) AS "Client",
                (SELECT "Payment_Mode_Name" FROM payment_mode_mast WHERE "Pay_Mode_Code" = "Agency_pay") AS "PayMode",
                (SELECT "Adv_Cat_Name" FROM adv_cat_mast WHERE adv_cat_mast."Adv_Cat_Code" =tbl_booking_mast_log."Ad_cat_code")AS "categoryname",
                (SELECT "Adv_Subcat_Name" FROM adv_subcat_mast WHERE adv_subcat_mast."Adv_Subcat_Code" =tbl_booking_mast_log."Ad_sub_cat_code")AS "subcategoryname",
                (SELECT "brand_name" FROM brand_mst WHERE "brand_code" =tbl_booking_mast_log."Brand_code")AS "Brand",
                (SELECT "Uom_Name" FROM uom_mast WHERE "Uom_Code" =tbl_booking_mast_log."Uom_code")AS "UOM",
                (SELECT "premiumname" FROM advpos_prem_mast  WHERE "Premiumcode" =tbl_booking_mast_log."Page_type_code")AS "PagePremium",
                (SELECT "Pos_Type" FROM advpos_type_mast WHERE "Pos_Type_Code" = tbl_booking_mast_log."Page_position_code")AS "PositionPremium",
                (SELECT "Curr_Name" FROM curr_mast WHERE "Curr_Code" =tbl_booking_mast_log."Currency_code")AS "Currency"
           FROM tbl_booking_mast_log, agency_mast
          WHERE tbl_booking_mast_log."Receipt_no" = ciobookid
            AND VSEQNO =(SELECT MAX (VSEQNO) FROM tbl_booking_mast_log WHERE "Receipt_no" = ciobookid AND VSEQNO <
            (SELECT MAX(VSEQNO) FROM tbl_booking_mast_log WHERE "Receipt_no" = ciobookid) AND "audit" IS NOT NULL)
                        AND agency_mast."code_subcode" =
             tbl_booking_mast_log."Agency_sub_code" AND agency_mast."Comp_Code" = compcode;
*/
   END executebooking_p;
END executebooking;
/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PROCEDURE Websp_Receiptnew2
(
 cio_booking_id IN  VARCHAR2,
 dateformat IN VARCHAR2,
 p_getbookingrecord OUT Cur_Type_New1.cursor_type,
 p_accounts1 OUT Cur_Type_New1.cursor_type,
 P_ACCOUNTS2 OUT Cur_Type_New1.cursor_type
)

IS
  str VARCHAR(8000);
  package_cd   VARCHAR(300);
  package_result   VARCHAR(300);
  package_cd1   VARCHAR(300);
  A NUMBER;

  BEGIN

         OPEN p_getbookingrecord FOR
               SELECT DISTINCT AGENCY_MAST."Agency_Name" AS "Agen",
            NVL((SELECT "Cust_Name" FROM CUST_MAST WHERE "Cust_Code"="Client_code"),"Client_code")  AS "Client",
            PUB_MAST."Pub_Name" AS "Pub",TBL_BOOKING_MAST."No_of_insertion" AS "noinsert",
          TBL_BOOKING_MAST ."Gross_amount" AS "gamt1",
            --TBL_BOOKING_MAST ."Gross_amount" AS "gamt",
           (select "oth_amount"  from ad_rcpthdr where "recptno"=TBL_BOOKING_MAST."Receipt_no"  and "doctype" in('RCP','CA')) as "gamt",
            TBL_BOOKING_MAST."cio_booking_id" AS "CIOID",
            NVL(AGENCY_MAST."Add1",' ') AS "address",
            PUB_CENT_MAST."Phone1" AS "ph1",
            PUB_CENT_MAST."Phone2" AS "ph2",
            PUB_CENT_MAST."Fax" AS "faxs",
            SYSDATE AS "receiptdate",
            TBL_BOOKING_MAST."Receipt_no" AS "recno",
            TBL_BOOKING_MAST."Trade_disc" AS "trade_disc",
            PUB_CENT_MAST."Add1" AS "address",
            (SELECT "Adv_Cat_Alias" FROM ADV_CAT_MAST,TBL_BOOKING_MAST WHERE ADV_CAT_MAST."Adv_Cat_Code"=TBL_BOOKING_MAST ."Ad_cat_code" AND "cio_booking_id"=cio_booking_id),
            (SELECT "Adv_Subcat_Alias" FROM ADV_SUBCAT_MAST,TBL_BOOKING_MAST WHERE ADV_SUBCAT_MAST."Adv_Subcat_Code"=TBL_BOOKING_MAST."Ad_sub_cat_code" AND "cio_booking_id"=cio_booking_id),
            (SELECT "catalias"  FROM AD_CAT3,TBL_BOOKING_MAST WHERE TBL_BOOKING_MAST."Ad_Subcat3"=AD_CAT3."catcode" AND "cio_booking_id"=cio_booking_id),
            (SELECT "Cat_Alias"  FROM TBL_CAT4,TBL_BOOKING_MAST WHERE TBL_BOOKING_MAST."Ad_Subcat4"=TBL_CAT4."Cat_Code" AND "cio_booking_id"=cio_booking_id),
            (SELECT "Cat_Alias"  FROM TBL_CAT5 ,TBL_BOOKING_MAST WHERE TBL_BOOKING_MAST."Ad_subcat5"=TBL_CAT5."Cat_Code" AND "cio_booking_id"=cio_booking_id),
            "Bill_area",

            CASE dateformat
                WHEN 'mm/dd/yyyy' THEN  (select TO_CHAR(nvl("recptdt","date_time"),'mm/dd/yyyy')  from ad_rcpthdr where "recptno"=TBL_BOOKING_MAST."Receipt_no"  and "doctype" in('RCP','CA'))
                 WHEN 'dd/mm/yyyy' THEN (select TO_CHAR(nvl("recptdt","date_time"),'dd/mm/yyyy')  from ad_rcpthdr where "recptno"=TBL_BOOKING_MAST."Receipt_no"  and "doctype" in('RCP','CA'))
                 WHEN 'yyyy/mm/dd' THEN (select TO_CHAR(nvl("recptdt","date_time"),'yyyy/mm/dd')  from ad_rcpthdr where "recptno"=TBL_BOOKING_MAST."Receipt_no"  and "doctype" in('RCP','CA'))  END AS "BookDate",
            CITY_MST."City_Name",
            (SELECT "Uom_Alias" FROM UOM_MAST,TBL_BOOKING_MAST WHERE UOM_MAST."Uom_Code"=TBL_BOOKING_MAST."Uom_code" AND "cio_booking_id"=cio_booking_id),
            TBL_BOOKING_MAST."branch",
            TBL_BOOKING_MAST."Bill_amount" AS "bilamt",
            SYSDATE AS "receiptdate1",
            TBL_BOOKING_MAST."Caption"  AS "caption",
            TBL_BOOKING_MAST."RO_No" AS "rono",
            CASE dateformat
                 WHEN 'mm/dd/yyyy' THEN TO_CHAR("RO_Date",'mm/dd/yyyy')
                 WHEN 'dd/mm/yyyy' THEN TO_CHAR("RO_Date",'dd/mm/yyyy')
                 WHEN 'yyyy/mm/dd' THEN TO_CHAR("RO_Date",'yyyy/mm/dd')  END AS "rodate",
               --  ADV_TYPE_MAST."Adv_Type_Name" AS "adtype",
                (SELECT "Adv_Cat_Name" FROM ADV_CAT_MAST,TBL_BOOKING_MAST WHERE ADV_CAT_MAST."Adv_Cat_Code"=TBL_BOOKING_MAST ."Ad_cat_code" AND "cio_booking_id"=cio_booking_id) as "adtype",
            (SELECT COMBIN_MAST."Package_Name" FROM COMBIN_MAST,TBL_BOOKING_MAST WHERE  TBL_BOOKING_MAST."Package_code"=COMBIN_MAST."Combin_Code" AND "cio_booking_id"=cio_booking_id ) AS "Package_Name",
            TBL_BOOKING_MAST."Card_rate" AS "pkgrate",TBL_BOOKING_MAST."Card_amount" AS "cardamount",
            COMP_MST."Comp_Name" AS "companyname",
            COMP_MST."Add1" AS "address",
            COMP_MST."EmailID" AS "emailid",
            COMP_MST."PAN_No" AS "pan_no",
            PAYMENT_MODE_MAST."Payment_Mode_Name",TBL_BOOKING_MAST."ADD_AGENCY_COMM" AS "adl_agency_comm",
            TBL_BOOKING_MAST."Page_amount" AS "Page_prem",
            TBL_BOOKING_MAST."Booking_type"    AS    "Booking_type",
            TBL_BOOKING_MAST."Box_no"    AS    "Box_no",
            TBL_BOOKING_MAST."Special_disc_per"    AS    "Special_disc_per",
            TBL_BOOKING_MAST."Prem_per"    AS    "Prem_per",
            nvl(TBL_BOOKING_MAST."Special_discount",0) as "Special_discount",nvl(TBL_BOOKING_MAST."Space_discount",0) as "Space_discount",
             "Agrred_rate" as "Agreed_Rate",TBL_BOOKING_INSERT."Insert_Date",DOCTYPE,
             (select "Bill_amount" from tbl_booking_mast A where A."cio_booking_id"=TBL_BOOKING_MAST."prev_cioid" ) as PREVBILLAMT,
             tbl_booking_mast.CASHDISCOUNT,CASHDISCTYPE,
             tbl_booking_mast.ADD_AGENCY_COMM_AMT,
             (select "Box_Charges_Native" from box_mast where "Box_Code" =TBL_BOOKING_MAST."Box_code") as boxcharge,
             (select "Box_Charges_Type" from box_mast where "Box_Code" =TBL_BOOKING_MAST."Box_code") as boxtype,
            nvl ( ( SELECT "Cust_Name"||'-'||TBL_BOOKING_MAST."Client_address" FROM CUST_MAST WHERE "Cust_Code" = TBL_BOOKING_MAST."Client_code") , TBL_BOOKING_MAST."Client_code"||'-'||TBL_BOOKING_MAST."Client_address") AS Client2
            ,( SELECT "Adv_Cat_Name" FROM ADV_CAT_MAST , TBL_BOOKING_MAST WHERE ADV_CAT_MAST."Adv_Cat_Code" = TBL_BOOKING_MAST."Ad_cat_code" AND "cio_booking_id" = cio_booking_id) as cat2,
            (select "amount"  from ad_rcpthdr where "recptno"=TBL_BOOKING_MAST."Receipt_no"  and "doctype" in('RCP','CA')) as "gcancelamt",
            nvl(tbl_booking_mast."Bullet_code",'') as "eyecatcher"
            
            FROM TBL_BOOKING_MAST,PUB_CENT_MAST,
            TBL_BOOKING_INSERT,
            AGENCY_MAST ,
            PUB_MAST,
            COL_MAST ,
            ADV_TYPE_MAST,
 --EDITION_MAST,
             CITY_MST,
            RATE_MAST,
            COMP_MST,
            PAYMENT_MODE_MAST
            WHERE
            TBL_BOOKING_MAST."Agency_sub_code"=AGENCY_MAST."code_subcode"
            AND TBL_BOOKING_INSERT."Publication_Code" = PUB_MAST."Pub_Code"
            AND TBL_BOOKING_MAST."cio_booking_id"=TBL_BOOKING_INSERT."Cio_Booking_Id"
            AND PUB_CENT_MAST."Pub_cent_Code"=TBL_BOOKING_INSERT."Pub_Cent_Code"
            AND CITY_MST."City_Code"=AGENCY_MAST."City_Code"
            AND TBL_BOOKING_MAST."Comp_code"=COMP_MST."Comp_Code" AND
            PAYMENT_MODE_MAST."Pay_Mode_Code"=TBL_BOOKING_MAST."Agency_pay"
            AND TBL_BOOKING_MAST."Ad_type_code"=ADV_TYPE_MAST."Adv_Type_Code"
            AND TBL_BOOKING_MAST."cio_booking_id"=cio_booking_id
            order by TBL_BOOKING_INSERT."Insert_Date" DESC;

            OPEN p_accounts1 FOR
                /* SELECT "Edition",
                 CASE dateformat
                       WHEN 'mm/dd/yyyy' THEN TO_CHAR("Insert_Date",'mm/dd/yyyy')
                       WHEN 'dd/mm/yyyy' THEN TO_CHAR("Insert_Date",'dd/mm/yyyy')
                      WHEN 'yyyy/mm/dd' THEN TO_CHAR("Insert_Date",'yyyy/mm/dd')  END AS "Insert_Date",
                "Height", "Width", "Size_Book",COL_MAST."Col_Alias", "Page_No", "Agreed_Rate","Solo_Rate"
                FROM TBL_BOOKING_INSERT , COL_MAST
                WHERE
                TBL_BOOKING_INSERT."Col_Code"=COL_MAST."Col_Code" AND "Cio_Booking_Id"=cio_booking_id;*/
                 SELECT (select "Package_Alias" from combin_mast where "Combin_Code"="PACKAGE_CODE") as "Edition",
                 CASE 'dd/mm/yyyy'
                       WHEN 'mm/dd/yyyy' THEN TO_CHAR("Insert_Date",'mm/dd/yyyy')
                       WHEN 'dd/mm/yyyy' THEN TO_CHAR("Insert_Date",'dd/mm/yyyy')
                      WHEN 'yyyy/mm/dd' THEN TO_CHAR("Insert_Date",'yyyy/mm/dd')  END AS "Insert_Date",
                 TBL_BOOKING_INSERT."Gross_Rate" as   "Gross_Rate",   
                "Height", "Width", "Size_Book",COL_MAST."Col_Alias", "Page_No", sum("Agreed_Rate") as "Agreed_Rate",sum("Solo_Rate") as "Solo_Rate"
                FROM TBL_BOOKING_INSERT , COL_MAST
                WHERE
                TBL_BOOKING_INSERT."Col_Code"=COL_MAST."Col_Code" AND "Cio_Booking_Id"=cio_booking_id 
                group by "PACKAGE_CODE","Insert_Date","Height","Gross_Rate","Width", "Size_Book",COL_MAST."Col_Alias","Page_No" order by TO_DATE("Insert_Date",'DD/MM/YYYY');-- DESC;

           BEGIN
                 SELECT  "Package_code" INTO  package_cd1 FROM TBL_BOOKING_MAST WHERE "cio_booking_id"=cio_booking_id;
                 EXCEPTION WHEN NO_DATA_FOUND THEN NULL;
          END;


          A:=Fn_Splitfield(package_cd1,',');

       DECLARE
              CURSOR c1 IS SELECT Edition_Name FROM RESULT;
       BEGIN
           OPEN c1;
           LOOP
                  FETCH  c1   INTO package_result;
                  EXIT WHEN C1%NOTFOUND;

                  INSERT INTO PACKAGE1 SELECT "Combin_Desc" FROM COMBIN_MAST WHERE "Combin_Code"=package_result;

           END LOOP;
              CLOSE c1;
       END ;
       BEGIN
          OPEN P_ACCOUNTS2 FOR
                 SELECT * FROM PACKAGE1;
               EXCEPTION WHEN NO_DATA_FOUND THEN NULL;
       END;

END ;
/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PACKAGE Bindaudit IS
TYPE T_ACCOUNT_CURSOR IS REF CURSOR;

PROCEDURE bindaudit_p(
fromdate        IN VARCHAR2,
todate          IN VARCHAR2,
date1           IN VARCHAR2,
BRANCH1         IN VARCHAR2,
Adtype          IN VARCHAR2,
audittype       IN VARCHAR2,
branch2         IN VARCHAR2,
v_Cat           in varchar2,
v_userid        in varchar2,
comp_code       in varchar2,
v_package_code  in varchar2,
pagency_code    in varchar2,
pclient_code    in varchar2,
psection_code   in varchar2,
P_ACCOUNT       OUT T_ACCOUNT_CURSOR);
END Bindaudit;
/
CREATE OR REPLACE PACKAGE BODY bindaudit IS
PROCEDURE bindaudit_p(
    fromdate        IN VARCHAR2,
    todate          IN VARCHAR2,
    date1           IN VARCHAR2,
    BRANCH1         IN VARCHAR2,
    Adtype          IN VARCHAR2,
    audittype       IN VARCHAR2,
    branch2         IN VARCHAR2,
    v_Cat           in varchar2,
    v_userid        in varchar2,
    comp_code       in varchar2,
    v_package_code  in varchar2,
    pagency_code    in varchar2,
    pclient_code    in varchar2,
    psection_code   in varchar2,
    P_ACCOUNT       OUT T_ACCOUNT_CURSOR)
AS

v_branch1    varchar2(50);
v_branch2    varchar2(50);
BEGIN
    /* INSERT INTO test1(vstring)
    VALUES (   'fromdate '|| fromdate|| ' todate '|| todate|| ' date1 '|| date1|| ' BRANCH1 '|| branch1
    || ' Adtype '|| adtype|| ' audittype '|| audittype|| ' branch2 '|| branch2|| ' v_Cat '|| v_cat|| ' v_userid '|| v_userid);
    COMMIT;*/
    If branch1 = 'All' then
        v_branch1 := null; 
    End if;
    
    If branch2 = 'All' then
        v_branch2 := null;
    End if;
--"cio_booking_id", "Agency_sub_code", "Ad_type_code", "Agency_type", "Executive_code", 
--RETAINER, "Uom_code", "branch", "Client_code"
    IF audittype = 'audit' THEN
        OPEN p_account FOR
        SELECT distinct m."cio_booking_id" as "cio_booking_id",
        NVL ((SELECT distinct  "Cust_Name" FROM cust_mast WHERE "Cust_Code" = m."Client_code"),
        m."Client_code") AS "Client_code",
        m."audit" as "audit", m."Ad_type_code" as "Ad_type_code",
        (SELECT distinct "File_Name" FROM tbl_booking_insert
        WHERE "Cio_Booking_Id" =m."cio_booking_id" AND "File_Name" IS NOT NULL AND ROWNUM <= 1) AS "FILENAME",
        CASE date1 WHEN 'mm/dd/yyyy' THEN TO_CHAR(m."Creation_datetime",'mm/dd/yyyy')
            WHEN 'dd/mm/yyyy' THEN TO_CHAR (m."Creation_datetime", 'dd/mm/yyyy')
            WHEN 'yyyy/mm/dd' THEN TO_CHAR (m."Creation_datetime", 'yyyy/mm/dd')
        END AS "Creation_datetime",m.ATTACHMENT1 as ATTACHMENT,
        AD_GETAGENCY_ADD(comp_code,m."cio_booking_id",'A') as "Agency_Remark",
        AD_GETAGENCY_ADD(comp_code,m."cio_booking_id",'C') as "Client_Remark"
        FROM tbl_booking_mast m,tbl_booking_insert i,branch_mst b,login_branch_mast lb
        WHERE m."cio_booking_id" =i."Cio_Booking_Id" 
        and m."Agency_sub_code"= nvl(pagency_code,m."Agency_sub_code")
        AND m."Ad_type_code" = adtype 
        AND m."branch" = nvl(v_branch2,m."branch")
        AND m."branch"= b."Branch_Code"
        and m."branch"= lb.branch_code
        and m."Client_code"= nvl(pclient_code,m."Client_code")
        and m."date_time" BETWEEN fromdate AND todate
        AND m."audit" IS NOT NULL
        AND m."Ad_cat_code" = nvl(v_cat,m."Ad_cat_code")
        AND lb.user_code = v_userid
        AND NVL (lb.user_flag, 'N') = 'Y'
        AND b."pub_center" = nvl(v_branch1,b."pub_center")
        and (i."PACKAGE_CODE"= v_package_code or v_package_code is null )
        and (i."SECTIONCODE"= psection_code or psection_code is null)
        order by "cio_booking_id";
    END IF;

    IF audittype = 'unaudit' or audittype is null THEN
        OPEN p_account FOR
            SELECT distinct m."cio_booking_id" as "cio_booking_id",
            NVL ((SELECT distinct "Cust_Name" FROM cust_mast WHERE "Cust_Code" = m."Client_code"),
            m."Client_code") AS "Client_code",
            m."audit" as "audit", m."Ad_type_code" as "Ad_type_code",
            (SELECT distinct  "File_Name" FROM tbl_booking_insert
            WHERE "Cio_Booking_Id" =m."cio_booking_id"
            AND "File_Name" IS NOT NULL
            AND ROWNUM <= 1) AS "FILENAME",
            CASE date1 WHEN 'mm/dd/yyyy' THEN TO_CHAR(m."Creation_datetime",'mm/dd/yyyy')
                WHEN 'dd/mm/yyyy' THEN TO_CHAR (m."Creation_datetime", 'dd/mm/yyyy')
                WHEN 'yyyy/mm/dd' THEN TO_CHAR (m."Creation_datetime", 'yyyy/mm/dd')
            END AS "Creation_datetime",m.ATTACHMENT1 as ATTACHMENT,
            AD_GETAGENCY_ADD(comp_code,m."cio_booking_id",'A') as "Agency_Remark",
            AD_GETAGENCY_ADD(comp_code,m."cio_booking_id",'C') as "Client_Remark"
            FROM tbl_booking_mast m,tbl_booking_insert i,branch_mst b,login_branch_mast lb
            WHERE m."cio_booking_id" =i."Cio_Booking_Id" 
            and m."Agency_sub_code"= nvl(pagency_code,m."Agency_sub_code")
            AND m."Ad_type_code" = adtype 
            AND m."branch" = nvl(v_branch2,m."branch")
            AND m."branch"= b."Branch_Code"
            and m."branch"= lb.branch_code
            and m."Client_code"= nvl(pclient_code,m."Client_code")
            and m."date_time" BETWEEN fromdate AND todate
            AND m."audit" IS NULL
            AND m."Ad_cat_code" = nvl(v_cat,m."Ad_cat_code")
            AND lb.user_code = v_userid
            AND NVL (lb.user_flag, 'N') = 'Y'
            AND b."pub_center" = nvl(v_branch1,b."pub_center")
            and (i."PACKAGE_CODE"= v_package_code or v_package_code is null )
            and (i."SECTIONCODE"= psection_code or psection_code is null)
            and nvl(m.modified_audit,'N')!='Y'
            order by "cio_booking_id";
    END IF;

    IF audittype = 'modified' THEN
        OPEN p_account FOR
            SELECT distinct m."cio_booking_id" as "cio_booking_id",
            NVL ((SELECT distinct "Cust_Name" FROM cust_mast WHERE "Cust_Code" = m."Client_code"),
            m."Client_code") AS "Client_code",
            m."audit" as "audit", m."Ad_type_code" as "Ad_type_code",
            (SELECT distinct  "File_Name" FROM tbl_booking_insert
            WHERE "Cio_Booking_Id" =m."cio_booking_id"
            AND "File_Name" IS NOT NULL
            AND ROWNUM <= 1) AS "FILENAME",
            CASE date1 WHEN 'mm/dd/yyyy' THEN TO_CHAR(m."Creation_datetime",'mm/dd/yyyy')
                WHEN 'dd/mm/yyyy' THEN TO_CHAR (m."Creation_datetime", 'dd/mm/yyyy')
                WHEN 'yyyy/mm/dd' THEN TO_CHAR (m."Creation_datetime", 'yyyy/mm/dd')
            END AS "Creation_datetime",m.ATTACHMENT1 as ATTACHMENT,
            AD_GETAGENCY_ADD(comp_code,m."cio_booking_id",'A') as "Agency_Remark",
            AD_GETAGENCY_ADD(comp_code,m."cio_booking_id",'C') as "Client_Remark"
            FROM tbl_booking_mast m,tbl_booking_insert i,branch_mst b,login_branch_mast lb
            WHERE m."cio_booking_id" =i."Cio_Booking_Id" 
            and m."Agency_sub_code"= nvl(pagency_code,m."Agency_sub_code")
            AND m."Ad_type_code" = adtype 
            AND m."branch" = nvl(v_branch2,m."branch")
            AND m."branch"= b."Branch_Code"
            and m."branch"= lb.branch_code
            and m."Client_code"= nvl(pclient_code,m."Client_code")
            /*and m."date_time" BETWEEN fromdate AND todate*/
            AND m."audit" IS NULL
            AND m."Ad_cat_code" = nvl(v_cat,m."Ad_cat_code")
            AND lb.user_code = v_userid
            AND NVL (lb.user_flag, 'N') = 'Y'
            AND b."pub_center" = nvl(v_branch1,b."pub_center")
            and (i."PACKAGE_CODE"= v_package_code or v_package_code is null )
            and (i."SECTIONCODE"= psection_code or psection_code is null)
            and nvl(m.modified_audit,'N')='Y'
            order by "cio_booking_id";
    END IF;

   END bindaudit_p;
END bindaudit;
/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE Procedure fmgdatabid(
comecode in varchar2,
todate in varchar2,
fromdate in varchar2,
bookingid in varchar2,
agency in varchar2,
client in varchar2,
insertid in varchar2,
p_adtye in varchar2,
extra in varchar2,
p_Accounts out Cur_Type_New1.cursor_type
)
is
a number;
 query1 varchar2(10000);
 
begin
if insertid is null then
 query1:='select distinct tbl_booking_insert."Cio_Booking_Id",(select "Col_Name" from col_mast where "Col_Code"=tbl_booking_insert."Col_Code" and "Comp_Code"=tbl_booking_insert."Comp_Code") as "color","Height","Width","Size_Book",(SELECT "Edition_Alias" from edition_Mast where "Edition_Code"=tbl_booking_insert."Edition_Code" and "Comp_Code"=tbl_booking_insert."Comp_Code") as "EDITION","Insert_Id",to_char("Insert_Date",''dd/mm/yyyy'') as "Insert_Date","Gross_Rate","Bill_Amt" from tbl_booking_insert,tbl_booking_mast where
 tbl_booking_mast."cio_booking_id"=tbl_booking_insert."Cio_Booking_Id" and tbl_booking_insert."Comp_Code"='''||comecode||''' and "Insert_Date" between '''||fromdate||''' and '''||todate||''' and tbl_booking_mast."Agency_sub_code"= '''||agency||''' and tbl_booking_mast."Ad_type_code"= '''||p_adtye||''' and "Insert_Status" in (''publish'',''billed'',''audit by rate'')';
 
 if(bookingid IS NOT NULL)then
 query1:=query1 || ' and tbl_booking_insert."Cio_Booking_Id"='''|| bookingid || '''';
 end if;

 if(client IS NOT NULL ) then
 query1:=query1 || ' and tbl_booking_mast."Client_code"='''|| client || '''';
  end if;
 
  query1:=query1 || ' order by "Insert_Id"';
 

 open  p_Accounts for
 query1;

else
delete from result;
a:=fn_splitfield(insertid,'~');
query1:='select distinct tbl_booking_insert."Cio_Booking_Id",(select "Col_Name" from col_mast where "Col_Code"=tbl_booking_insert."Col_Code" and "Comp_Code"=tbl_booking_insert."Comp_Code") as "color","Height","Width","Size_Book",(SELECT "Edition_Alias" from edition_Mast where "Edition_Code"=tbl_booking_insert."Edition_Code" and "Comp_Code"=tbl_booking_insert."Comp_Code") as "EDITION","Insert_Id",to_char("Insert_Date",''dd/mm/yyyy'') as "Insert_Date","Gross_Rate","Bill_Amt" from tbl_booking_insert,tbl_booking_mast where tbl_booking_insert."Comp_Code"='''||comecode||'''  and tbl_booking_mast."Agency_sub_code"= '''||agency||''' and tbl_booking_mast."Ad_type_code"= '''||p_adtye||''' and "Insert_Status" in (''publish'',''billed'',''audit by rate'')';
 query1:=query1 || ' and tbl_booking_insert."Insert_Id" in(select edition_name from result)';
  open  p_Accounts for
 query1;
end if;
 
 

end;
/
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

//==================================************End*********************==================//


@@@@@@@@@@@@@@@@@@@@@@@@@@@@@(0006447,0006448)kuldeep@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
/*************************mimoh 6673************************************/
CREATE OR REPLACE FUNCTION multipack_report(PCOMP_CD VARCHAR2,packag VARCHAR2,v_rt varchar,varchk varchar2) RETURN number

as
v_nm VARCHAR2(200);
v_gr varchar2(200);
v_val varchar2(4000);
v_vals varchar2(200);

---for rate--
v_rate number(12,2);
v_type varchar2(200);
v_amt number(12,2);
v_tot number(12,2);
per_amount number(12,2);

Cursor C1 Is select EDITION_NAME from result;
v1 C1%rowtype;
BEGIN
v_gr:=FN_SPLITFIELD(packag,',');

open C1;
loop
    fetch C1 into v1;
    exit when C1%notfound;
     begin
          select "Combin_Desc" into v_vals from  combin_mast where "Combin_Code"=v1.edition_name;
     exception when no_data_found then
     v_vals:='no'||v1.edition_name;
     end;
     if v_val is null then
          v_val:=v_vals;
     else
         v_val:=v_val||'+'||v_vals;
     end if;

end loop;
     -------------add by gaurav for rate-----------------
     --multipack_rat--table

     if(varchk='1')
     then
     begin
     select  "Premium","Amount" into v_type,v_rate from advpos_type_mast,tbl_booking_mast
     where tbl_booking_mast."cio_booking_id"=PCOMP_CD
     and tbl_booking_mast."Page_position_code"=advpos_type_mast."Pos_Type_Code"    ;
     exception when no_data_found then
     v_type :='no';v_rate :='0';
     end;

     /*begin
     select  "Amount" into v_rate from advpos_type_mast,tbl_booking_mast
     where tbl_booking_mast."cio_booking_id"=PCOMP_CD
     and tbl_booking_mast."Page_position_code"=advpos_type_mast."Pos_Type_Code"    ;
     exception when no_data_found then
     v_rate :='0';
     end;*/

     /* begin
     select  TBL_BOOKING_mast."Total_area" * tbl_booking_mast."Card_rate" into v_amt from tbl_booking_mast
     where tbl_booking_mast."cio_booking_id"=PCOMP_CD    ;
     exception when no_data_found then
     v_rate :='0';
     end;*/

     if v_type != 'per'
     then
     v_tot :=v_rate;
     per_amount := 0;
     else
     v_tot :=v_rt*v_rate/100;
     per_amount := v_rate;
     end if;

     insert into multipack_rat (CIOID,RAT,per_amt,SESS_ID) values (PCOMP_CD,v_tot,per_amount,userenv('sessionid'));
     ----------------------------------------------------

      -------------newwadded-----------------
     else
     begin
     select distinct "Premium" into v_type from advpos_type_mast,ad_bills
     where

     ad_bills.IDNUM =PCOMP_CD
     --and ad_bills.IDNUM=ad_bills_det.IDNUM
     and ad_bills.PAGE_POST =advpos_type_mast."Pos_Type_Code"  and rownum<=1  ;
     exception when no_data_found then
     v_type :='no';
     end;

     begin
     select distinct "Amount" into v_rate from advpos_type_mast,ad_bills
     where

     ad_bills.IDNUM =PCOMP_CD
     --and ad_bills.IDNUM=ad_bills_det.IDNUM
     and ad_bills.PAGE_POST =advpos_type_mast."Pos_Type_Code"   and rownum<=1 ;
     exception when no_data_found then
     v_rate :='0';
     end;

     /* begin
     select distinct sum(ad_bills_det.AGG_RATE) into v_amt from ad_bills_det--,ad_bills
     where ad_bills_det.IDNUM=PCOMP_CD  ;
     exception when no_data_found then
     v_rate :='0';
     end;*/

     if v_type != 'per'
     then
     v_tot :=v_rate;
     per_amount := 0;
     else
     v_tot :=v_rt*v_rate/100;
     per_amount := v_rate;
     end if;

     insert into multipack_ratnew (CIOID,RAT,per_amt,SESS_ID) values (PCOMP_CD,v_tot,per_amount,userenv('sessionid'));


     ----------------------------------------------------

     end if;



close C1;
insert into multipack_rep(CIOID,PACK,SESS_ID) values(PCOMP_CD,v_val,userenv('sessionid'));
commit;
return 0;
END;
/


/*************************mimoh 6673************************************/

/*********************************** issue 6675********ankit****************/
CREATE OR REPLACE PACKAGE deletepremtype
IS
   PROCEDURE deletepremtype_p (premcode IN VARCHAR2, compcode IN VARCHAR2);
END deletepremtype;
/





CREATE OR REPLACE PACKAGE BODY deletepremtype
IS
   PROCEDURE deletepremtype_p (premcode IN VARCHAR2, compcode IN VARCHAR2)
   AS
   BEGIN
      DELETE FROM prem_type_mast
            WHERE "Comp_Code" = compcode AND "Prem_Type_Code" = premcode;

      DELETE FROM temp_prem_type_mast
            WHERE "Comp_Code" = compcode AND "Prem_Type_Code" = premcode;

      COMMIT;
   END deletepremtype_p;
END deletepremtype;
/


/**************end********************* issue 6675********ankit****************/



@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@kuldeep@@10/02/2012@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

//==============*********************Start Scripting****************==================//
CREATE OR REPLACE PACKAGE Editioncodecheck Is
Type T_Accounts_Cursor Is Ref Cursor;

Procedure Editioncodecheck_p(
EditionCode in varchar2,
compcode in varchar2,
userid in varchar2,
editionalias in varchar2,
p_Accounts Out T_Accounts_Cursor,
p_Accounts1 Out T_Accounts_Cursor);

End Editioncodecheck ;
/
CREATE OR REPLACE PACKAGE BODY Editioncodecheck Is
Procedure Editioncodecheck_p(
EditionCode in varchar2,
compcode in varchar2,
userid in varchar2,
editionalias in varchar2,
p_Accounts Out T_Accounts_Cursor,
p_Accounts1 Out T_Accounts_Cursor)
 As

Begin
Open P_Accounts For
select "Edition_Code" from EDITION_MAST where "Comp_Code"=compcode and "Edition_Code"=EditionCode ;-- and "UserId"=userid 

Open P_Accounts1 For
select "Edition_Alias" from EDITION_MAST where "Comp_Code"=compcode and "Edition_Alias"=editionalias ;-- and "UserId"=userid 


Commit;

End Editioncodecheck_p;

End Editioncodecheck ;
/


@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@kuldeep@@10/02/2012@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@





@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@kuldeep@@11/02/2012@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@



//==============*********************Start Scripting****************==================//
CREATE OR REPLACE PACKAGE BODY updatebooking IS
PROCEDURE updatebooking_p(
approvedby      in varchar2,
audit1          in varchar2,
rono            in varchar2,
rodate          in date,
caption         in varchar2,
billstatus      in varchar2,
rostatus        in varchar2,
agency          in varchar2,
client          in varchar2,
agencyaddress   in varchar2,
clientaddresses in varchar2,
agencycode      in varchar2,
dockitno        in varchar2,
execname        in varchar2,
execzone        in varchar2,
product         in varchar2,
brand           in varchar2,
keyno           in varchar2,
billremark      in varchar2,
printremark     in varchar2,
package1        in varchar2,
insertion       in number,
startdate       in date,
repeatdate      in varchar2,
adtype1         in varchar2,
adcategory      in varchar2,
subcategory     in varchar2,
color           in varchar2,
uom             in varchar2,
pageposition    in varchar2,
pagetype1       in varchar2,
pageno          in number,
adsizheight     in number,
adsizwidth      in number,
ratecode11      in varchar2,
scheme1         in varchar2,
currency        in varchar2,
agreedrate      in number,
agreedamt       in number,
spedisc         in number,
spacedisx       in number,
compcode        in varchar2,
userid          in varchar2,
ciobookid       in varchar2,
date_time       in date,
branch          in varchar2,
booked_by       in varchar2,
prevbook        in varchar2,
adsizetype      in varchar2,
specialcharges  in number,
agencytype      in varchar2,
agencystatus    in varchar2,
paymode         in varchar2,
agencredit      in number,
cardrate        in number,
cardamount      in number,
discount        in number,
discountper     in number,
billaddress     in varchar2,
totarea         in number,
billcycle       in varchar2,
revenuecenter   in varchar2,
billpay         in varchar2,
billheight      in number,
billwidth       in number,
billto          in varchar2,
invoices        in number,
vts             in number,
tradedisc       in number,
agencyout       in varchar2,
boxcode         in varchar2,
boxno           in varchar2,
boxaddress      in varchar2,
boxagency       in varchar2,
boxclient       in varchar2,
bookingtype     in varchar2,
tfn             in varchar2,
coupan          in varchar2,
campaign        in varchar2,
bill_amt        in number,
pageprem        in varchar2,
pageamt         in number,
premper         in number,
grossamt        in number,
adsizcolumn     in number,
billarea        in number,
billcolumn      in number,
spacediscper    in number,
specdiscper     in number,
paidins         in number,
dealrate        in number,
deviation       in number,
varient         in varchar2,
dealtype        in varchar2,
contractname    in varchar2,
cardname        in varchar2,
cardtype        in varchar2,
cardmonth       in varchar2,
cardyear        in varchar2,
cardno          in varchar2,
receiptno       in varchar2,
adscat3         in varchar2,
adscat4         in varchar2,
adscat5         in varchar2,
bgcolor         in varchar2,
bulletcode      in varchar2,
bulletprm       in number,
material        in varchar2,
region1         in varchar2,
varient_name    in varchar2,
coltype         in varchar2,
logo_h          in varchar2,
logo_w          in varchar2,
logo_col        in varchar2,
logo_uom        in varchar2,
retainer1       in varchar2,
addagencyrate   in varchar2,
mobileno        in varchar2,
addlamt         in varchar2,
retamt          in varchar2,
retper          in varchar2,
cashrecieved    in varchar2,
CIRAGENCY_V     in varchar2,
CIRRATE_V       in varchar2,
CIREDITION_V    in varchar2,
CIRPUBLICATION_V    in varchar2,
CIRAGENCYSUBCODE_V  in varchar2,
BARTERTYPE          IN VARCHAR2,
CASHDISCOUNT_V      IN VARCHAR2,
CASHDISCOUNTPER_V   IN VARCHAR2,
attach1             in varchar2,
attach2             in varchar2,
drpdiscprem         in varchar2,
doctype_v           in varchar2,
CHKTRADE            IN VARCHAR2,
sharepub_p          in varchar2,
fmginsert           in varchar2,
chkno               in VARCHAR2,
chkdate             in date:=null,
chkamt              in VARCHAR2,
chkbankname         in varchar2,
ourbank             in varchar2,
DEALERPANEL_P       in VARCHAR2,
DEALERH_P           in FLOAT,
DEALERW_P           in FLOAT,
DEALERTYPE_P        in VARCHAR2,
multiselect         in VARCHAR2,
AGREEDRATE_ACTIVE   IN NUMBER,
AGREEDAMT_ACTIVE    IN NUMBER,
grossamtlocal_p     IN number,
billamtlocal_p      IN number,
chkadon_p           IN varchar2,
refid_p             IN varchar2,
rcpt_currency       IN varchar2,
cur_convrate        IN varchar2,
clienttype          IN varchar2,
translation         in varchar2,
translationcharge   in number,
p_revisedate        IN DATE
)As
error1          varchar2(100);
sccode          varchar2(50);
mobileno1       varchar2(50);
remarks         varchar2(500);
clientname      varchar2(200);
v_modifed_audit varchar2(1);
v_audit_exist   number(1);
Begin

mobileno1:=mobileno;
--begin
--select distinct "scheme_id" into  sccode  from scheme_master where "Scheme_Name"=ltrim(rtrim(scheme1)) and "Comp_code"=compcode;
--exception when no_data_found then
--NULL ;
--end;  

sccode:=scheme1;


v_modifed_audit:=null;

If audit1 is null and rostatus='1' then
    
    /*select count(*) into v_audit_exist from
    (select count(*) from tbl_booking_mast 
        where "Comp_code"=compcode and "cio_booking_id"=ciobookid and "ro_status"='1' and "audit" is not null
    union
    select count(*) from tbl_booking_mast 
    where "Comp_code"=compcode and "cio_booking_id"=ciobookid and "ro_status"='1' and nvl(modified_audit,'N')='Y') x;
    
    If v_audit_exist>0 then 
        v_modifed_audit:='Y';
    End if;*/
    
    select  case when "audit" is not null then 'Y' 
                 when nvl(modified_audit,'N')='Y' then 'Y' 
            else null  End as modifed_audit into v_modifed_audit from tbl_booking_mast 
        where "Comp_code"=compcode and "cio_booking_id"=ciobookid and "ro_status"='1';

End If;


update tbl_booking_mast set "date_time"=date_time,"branch"=branch,"booked_by"=booked_by,"prev_booking"=prevbook,"applied_by"=approvedby,"audit"=audit1,"RO_No"=rono,"RO_Date"=rodate,
"Caption"=caption,"bill_status"=billstatus,"ro_status"=rostatus,"Agency_code"=agency,"Agency_address"=agencyaddress,"Client_code"=client,"Client_address"=clientaddresses,"Agency_sub_code"=agencycode,
"Dockit_no"=dockitno,"Executive_code"=execname,"Executive_zone"=execzone,"Product_code"=product,"Brand_code"=brand,"Key_no"=keyno,"Bill_remarks"=billremark,"Print_remark"=printremark,
"Package_code"=package1,"No_of_insertion"=insertion,"Insertion_date"=startdate,"Repeating_day"=repeatdate,"Ad_type_code"=adtype1,"Ad_cat_code"=adcategory,"Ad_sub_cat_code"=subcategory,
"Color_code"=color,"Uom_code"=uom,"Page_position_code"=pageposition,"Page_type_code"=pagetype1,"Page_no"=pageno,"Ad_size_type_code"=adsizetype,"Ad_size_height"=adsizheight,
"Ad_size_width"=adsizwidth,"Rate_code"=ratecode11,"Scheme_type_code"=sccode,"Currency_code"=currency,"Agrred_rate"=agreedrate,"Agreed_amount"=agreedamt,"Special_discount"=spedisc,
"Space_discount"=spacedisx,"Special_charges"=specialcharges,"Agency_status"=agencystatus,"Agency_type"=agencytype,"Agency_pay"=paymode,"Agency_credit"=agencredit,
"Total_area"=totarea,"Card_rate"=cardrate,"Card_amount"=cardamount,"Discount"=discount,"Discount_per"=discountper,"Bill_cycle"=billcycle,"Revenue_center"=revenuecenter,
"Bill_pay"=billpay,"Bill_height"=billheight,"Bill_width"=billwidth,"Bill_to"=billto,"Invoices"=invoices,"Vts"=vts,"Bill_add"=billaddress,"Trade_disc"=tradedisc,"Agency_out"=agencyout,
"Box_code"=boxcode,"Box_no"=boxno,"Box_agency"=boxagency,"Box_client"=boxclient,"Box_address"=boxaddress,"Booking_type"=bookingtype,"Tfn"=tfn,"Coupan_ad"=coupan,"Campaign"=campaign,
"Bill_amount"=bill_amt,"Page_prem"=pageprem,"Page_amount"=pageamt,"Prem_per"=premper,"Gross_amount"=grossamt,"Ad_size_column"=adsizcolumn,"Bill_column"=billcolumn,
"Bill_area"=billarea,"Special_disc_per"=specdiscper,"Space_disc_per"=spacediscper,"Paid_ins"=paidins,"Contract_rate"=dealrate,"Deviation"=deviation,"Variant_code"=varient,
"Contract_name"=contractname,"Contract_type"=dealtype,"Card_name"=cardname,"Card_type"=cardtype,"Card_month"=cardmonth,"Card_year"=cardyear,"Card_number"=cardno,"Receipt_no"=receiptno,
"Ad_Subcat3"=adscat3,"Ad_Subcat4"=adscat4,"Ad_subcat5"=adscat5,"Bg_color"=bgcolor,"Bullet_code"=bulletcode,"Bullet_premium"=bulletprm,"Material_status"=material

,"Region"=region1,"Variant"=varient_name,"Colortype"=coltype,
"Logo_H"=logo_h,"Logo_W"=logo_w,"Logo_color"=logo_col,"Logo_Uom"=logo_uom,
"RETAINER"=retainer1, "ADD_AGENCY_COMM"=addagencyrate, tbl_booking_mast.MOBILENO=mobileno1,ADD_AGENCY_COMM_AMT=addlamt,RETAINER_COMM=retper,RETAINER_COMM_AMT=retamt,CASH_RECIEVED=cashrecieved,
CIRAGENCY=CIRAGENCY_V,CIRRATE=CIRRATE_V,CIREDITION=CIREDITION_V,CIRPUBLICATION=CIRPUBLICATION_V,CIRAGENCY_SUBCODE=CIRAGENCYSUBCODE_V,BARTER_TYPE=BARTERTYPE,
CASHDISCOUNT=CASHDISCOUNT_V, CASHDISCTYPE=CASHDISCOUNTPER_V, ATTACHMENT1=attach1, ATTACHMENT2=attach2, DISC_PREMIUM=drpdiscprem, DOCTYPE=doctype_v,CHKTRADEDISC=CHKTRADE,
CHK_NO=chkno,CHK_DATE=chkdate,CHK_AMT=chkamt,CHK_BANK_NAME=chkbankname,OUR_BANK=ourbank,DEALERPANEL=DEALERPANEL_P, DEALER_H=DEALERH_P, DEALER_W=DEALERW_P, DEALERTYPE=DEALERTYPE_P
,ACTIVE_AGREEDRATE=AGREEDRATE_ACTIVE, ACTIVE_AGREEDAMT=AGREEDAMT_ACTIVE,LOCALGROSSAMT=grossamtlocal_p,LOCALBILLAMT=billamtlocal_p,
PACKAGE_TYPE=chkadon_p, AD_REFID=refid_p,RECEIPT_CURRENCY=rcpt_currency,CONV_CURR_RATE=cur_convrate,REVISE_DATE=p_revisedate,CLIENT_TYPE=clienttype,TRANSLATION_CODE=translation, TRANSLATION_PREMIUM=translationcharge,
MODIFIED_AUDIT=v_modifed_audit
where "Comp_code"=compcode and "cio_booking_id"=ciobookid;

    IF sharepub_p is not null then
        insert_sharepub_details(sharepub_p,ciobookid,'UPDATE',error1);
    end if;

    delete from TBL_BOOKING_FMG_TRANS where CIOID=ciobookid;
    if fmginsert is not null then
        insert_fmgTrans_details(fmginsert,ciobookid,'UPDATE',error1);   
    end if;
      
    if multiselect is not null then
        insert_multiexec_details(userid,compcode,multiselect,ciobookid,'UPDATE',error1);
    end if;
                       
if billpay = 'CA0' and rostatus='1' and (receiptno is null or receiptno = '') then

    declare
        cursor c1 is
            select * from tbl_booking_mast where "cio_booking_id"=ciobookid;
       
    v1 c1%rowtype;
    v_error         varchar2(2000);
    v_rcptno_r      varchar2(50);
    vrecpt          varchar2(20);
    branchcode      varchar2(20);
    vrepcode        varchar2(20);
    subagencyreg    varchar2(20);
    prevcioid_v     varchar2(50);
    billamt_v       float;
    grossamt_v      float;
    v_curdate       date;
    begin

        open c1;
        fetch c1 into v1;
        
            Begin
                select "Branch_Code" into branchcode from branch_mst where "Comp_Code"=v1."Comp_code" and "Branch_Name"=v1."branch";
            Exception When no_data_found then
                branchcode:='';
            End;
       
            Begin
                select "SUB_Agency_Code" into subagencyreg from agency_mast where "Comp_Code"=v1."Comp_code" and "code_subcode"=v1."Agency_sub_code";
            Exception When no_data_found then
                subagencyreg:='';
            End;
            vrecpt      :=v1."Receipt_no";
            prevcioid_v :=v1."prev_cioid";

            if prevcioid_v is null or v1."prev_receipt" is null then
                billamt_v   :=v1."Bill_amount";
                grossamt_v  :=v1."Gross_amount";
                v_curdate   :=v1."date_time";
            else
                select "Bill_amount","Gross_amount" into  billamt_v,grossamt_v from tbl_booking_mast where "cio_booking_id"=prevcioid_v;
                billamt_v   :=v1."Bill_amount" - billamt_v;
                grossamt_v  :=v1."Gross_amount" - grossamt_v;
                v_curdate   :=to_date(sysdate);
            end if;
        
            -- select substr(max("recptno"),1,12)||lpad(substr(max("recptno"),-6)+1,6,'0') into vrecpt from ad_rcpthdr where "unit"=branchcode and "doctype"='RCP' and
            -- "recptdt" between '1-mar-2011' and '31-mar-2011';
             
            --receiptsave_booking.receiptsave_booking_P(pcompcode,puserid , punit ,ptype , precpt , prdate , ppaymodres ,preceivedreg ,pvouno  ,pamount  ,pagency , pothercd ,
            --pchno  ,pchedate , pbank  , pnarration ,prep   , pvdate , pag_main_code ,pag_sub_code , ourbank,  cioid , execname , retainer ,
            -- prevcioid , p_error)
                
            Begin
                SELECT "Cust_Name" into clientname FROM CUST_MAST WHERE "Cust_Code" = v1."Client_code" and "Comp_Code"=v1."Comp_code";
            Exception when NO_DATA_FOUND THEN
                clientname:=v1."Client_code";
            END;

            remarks:='RONO#'||v1."RO_No" ||' RODATE# ' || to_char(v1."RO_Date",'dd-mon-yyyy') || ' BOOKINGID# ' || v1."cio_booking_id" || ' CLIENT#' || clientname;

            receiptsave_booking.receiptsave_booking_p(v1."Comp_code",v1."Userid", v1."branch",v1.DOCTYPE,vrecpt,v_curdate,v1."Bill_pay",'','',billamt_v,v1."Agency_sub_code",grossamt_v,
            '','','',remarks,vrepcode,v1."date_time",v1."Agency_code",subagencyreg,'',v1."cio_booking_id",v1."Executive_code",v1.RETAINER,v1."prev_cioid",v_rcptno_r,v_error);
       
            update tbl_booking_mast set "Receipt_no"=v_rcptno_r,"Receipt_date"=v_curdate where "cio_booking_id"=v1."cio_booking_id";
        close c1;
        commit;
    End;
End if;
 
end updatebooking_p;
End updatebooking;
/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PROCEDURE Websp_Insert_Package1 (suppcode IN VARCHAR2)
AS
sun VARCHAR2(2);
mon VARCHAR2(2);
tue VARCHAR2(2);
wed VARCHAR2(2);
thu VARCHAR2(2);
fri VARCHAR2(2);
sat VARCHAR2(2);
all1 VARCHAR2(2);
packagename VARCHAR2(1000):=null;
edi_alias VARCHAR2(200):=null;
packagecode VARCHAR2(500);
combcode VARCHAR2(50);
count1 NUMBER;
pubname VARCHAR2(100);
compcode VARCHAR2(100);
userid VARCHAR2(100);
pubtype varchar(200);
pubname1 varchar(200);
pubcenter varchar2(200);
BEGIN
select "Pub_Code","Comp_Code","UserId","Supp_Alias","Supp_Alias" into pubname1,compcode,userid,packagename,edi_alias from SUPPLEMENT_MAST where "Supp_Code"=suppcode;
select "publication_type" into pubtype from pub_mast where "Pub_Code"=(pubname1);
if pubtype != 'CO0' then
begin
select "sun","mon","tue","wed","thu","fri","sat","all"
INTO sun,mon,tue,wed,thu,fri,sat,all1
from SELECT_SUPPLEMENT_DAY where "Supp_code"=suppcode;

exception when no_data_found then
null;
end;

combcode:=substr(packagename,1,2);

    begin
        select NVL(max(TO_NUMBER(SUBSTR("Combin_Code",3,lenGTH("Combin_Code")))),-1) INTO COUNT1 from  combin_mast where "Combin_Code" like  combcode||'%';
        exception when no_data_found then
    null;
    end;

if(COUNT1!=-1)THEN
COUNT1:=COUNT1+1;
else
COUNT1:=0;
END IF;

combcode:=combcode||TO_CHAR(COUNT1);

if(sun='Y')
THEN
packagecode:=packagename||'(SUN)';
end IF;
--delete from abc;commit;
--insert into abc values('packagecode',packagecode);
if(mon='Y')
THEN

    IF(packagecode is not null)THEN
    packagecode:=packagecode||'+'||packagename||'(Mon)';
    else
    packagecode:=packagecode||packagename||'(Mon)';
    END IF;

END IF;

--insert into abc values('packagecode',packagecode);
--commit;
if(tue='Y')THEN


    IF(packagecode is not null)THEN
    packagecode:=packagecode||'+'||packagename||'(Tue)';
    else
    packagecode:=packagecode||packagename||'(Tue)';
    END IF;

END IF;

if(wed='Y')
THEN

    IF(packagecode is not null)THEN
    packagecode:=packagecode||'+'||packagename||'(Wed)';
    else
    packagecode:=packagecode||packagename||'(Wed)';
    END IF;

END IF;


if(thu='Y')
THEN

    IF(packagecode  is not null)THEN
    packagecode:=packagecode||'+'||packagename||'(Thu)';
    else
    packagecode:=packagecode||packagename||'(Thu)';
    END IF;

END IF;


if(fri='Y')
THEN

    IF(packagecode is not null)THEN
    packagecode:=packagecode||'+'||packagename||'(Fri)';
    else
    packagecode:=packagecode||packagename||'(Fri)';
    END IF;

END IF;


if(sat='Y')
THEN
--insert into abc values('saty',sat);
    IF(packagecode is not null)THEN

    packagecode:=packagecode||'+'||packagename||'(Sat)';
     
    else
    packagecode:=packagecode||packagename||'(Sat)';
    
    END IF;

END IF;



select COUNT(*) INTO COUNT1 from combin_mast where "Combin_Desc"=packagename;


if(COUNT1=0)
THEN
select COUNT(*) INTO COUNT1 from ADV_TYPE_MAST where "Adv_Type_Code"='DI0';
IF (COUNT1>0) THEN
insert into combin_mast("Comp_Code","Combin_Code","Edition_Combin_Code","Combin_Desc","Package_Name","Package_Alias","UserId","No_Of_Edition","Share_Distribution","Ad_Type_code","Edition_Type","Creation_Datetime","pub_center")
values(compcode,combcode,packagecode,packagename,packagename,packagename,userid,1,'SO0','DI0',2,sysdate,'0');

INSERT INTO COMBIN_DAYS(COMP_CODE,COMBIN_CODE,EDITION_COMBIN_CODE,SUN,MON,TUE,WED,THU,FRI,SAT,ALLDAY,FOCUSDAY) VALUES(compcode,combcode,edi_alias,sun,mon,tue,wed,thu,fri,sat,all1,'N');
END IF;
-------------------------------------
combcode:=substr(packagename,1,2);

select NVL(MAX(TO_NUMBER(NVL(translate("Combin_Code",'ABCDEFGHIJKLMNOPQRSTUVWXYZ',0),0))),-1) INTO COUNT1 from combin_mast where "Combin_Code" like  combcode||'%';

if(COUNT1!=-1)THEN
COUNT1:=COUNT1+1;
else
COUNT1:=0;
END IF;

combcode:=combcode||TO_CHAR(COUNT1);
select COUNT(*) INTO COUNT1 from ADV_TYPE_MAST where "Adv_Type_Code"='CL0';
IF (COUNT1>0) THEN
insert into combin_mast("Comp_Code","Combin_Code","Edition_Combin_Code","Combin_Desc","Package_Name","Package_Alias","UserId","No_Of_Edition","Share_Distribution","Ad_Type_code","Edition_Type","Creation_Datetime","pub_center")
values(compcode,combcode,packagecode,packagename,packagename,packagename,userid,1,'SO0','CL0',2,sysdate,'0');

INSERT INTO COMBIN_DAYS(COMP_CODE,COMBIN_CODE,EDITION_COMBIN_CODE,SUN,MON,TUE,WED,THU,FRI,SAT,ALLDAY,FOCUSDAY) VALUES(compcode,combcode,edi_alias,sun,mon,tue,wed,thu,fri,sat,all1,'N');
END IF;
end IF;


end if;
commit;
END Websp_Insert_Package1;
/

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PROCEDURE Websp_Insert_Package (editioncode IN VARCHAR2)
AS
sun VARCHAR2(2);
mon VARCHAR2(2);
tue VARCHAR2(2);
wed VARCHAR2(2);
thu VARCHAR2(2);
fri VARCHAR2(2);
sat VARCHAR2(2);
all1 VARCHAR2(2);
packagename VARCHAR2(1000):=null;
edi_alias VARCHAR2(50):=null;
packagecode VARCHAR2(500);
combcode VARCHAR2(50);
count1 NUMBER;
pubname VARCHAR2(100);
compcode VARCHAR2(100);
userid VARCHAR2(100);
pubtype varchar(50);
pubname1 varchar(50);
pubcenter varchar2(50);
BEGIN
select "Pub_Code","Comp_Code","UserId","Edition_Alias","Edition_Alias" into pubname1,compcode,userid,packagename,edi_alias from edition_mast where "Edition_Code"=editioncode;
select "publication_type" into pubtype from pub_mast where "Pub_Code"=(pubname1);
if pubtype != 'CO0' then
begin
select "sun","mon","tue","wed","thu","fri","sat","all"
INTO sun,mon,tue,wed,thu,fri,sat,all1
from select_edition_day where "edition_code"=editioncode;

exception when no_data_found then
null;
end;

combcode:=substr(packagename,1,2);

    begin
        select NVL(max(TO_NUMBER(SUBSTR("Combin_Code",3,lenGTH("Combin_Code")))),-1) INTO COUNT1 from  combin_mast where "Combin_Code" like  combcode||'%';
        exception when no_data_found then
    null;
    end;

if(COUNT1!=-1)THEN
COUNT1:=COUNT1+1;
else
COUNT1:=0;
END IF;

combcode:=combcode||TO_CHAR(COUNT1);

if(sun='Y')
THEN
packagecode:=packagename||'(SUN)';
end IF;
--delete from abc;commit;
--insert into abc values('packagecode',packagecode);
if(mon='Y')
THEN

    IF(packagecode is not null)THEN
    packagecode:=packagecode||'+'||packagename||'(Mon)';
    else
    packagecode:=packagecode||packagename||'(Mon)';
    END IF;

END IF;

--insert into abc values('packagecode',packagecode);
--commit;
if(tue='Y')THEN


    IF(packagecode is not null)THEN
    packagecode:=packagecode||'+'||packagename||'(Tue)';
    else
    packagecode:=packagecode||packagename||'(Tue)';
    END IF;

END IF;

if(wed='Y')
THEN

    IF(packagecode is not null)THEN
    packagecode:=packagecode||'+'||packagename||'(Wed)';
    else
    packagecode:=packagecode||packagename||'(Wed)';
    END IF;

END IF;


if(thu='Y')
THEN

    IF(packagecode  is not null)THEN
    packagecode:=packagecode||'+'||packagename||'(Thu)';
    else
    packagecode:=packagecode||packagename||'(Thu)';
    END IF;

END IF;


if(fri='Y')
THEN

    IF(packagecode is not null)THEN
    packagecode:=packagecode||'+'||packagename||'(Fri)';
    else
    packagecode:=packagecode||packagename||'(Fri)';
    END IF;

END IF;


if(sat='Y')
THEN
--insert into abc values('saty',sat);
    IF(packagecode is not null)THEN

    packagecode:=packagecode||'+'||packagename||'(Sat)';
     
    else
    packagecode:=packagecode||packagename||'(Sat)';
    
    END IF;

END IF;



select COUNT(*) INTO COUNT1 from combin_mast where "Combin_Desc"=packagename;


if(COUNT1=0)
THEN
select COUNT(*) INTO COUNT1 from ADV_TYPE_MAST where "Adv_Type_Code"='DI0';
IF (COUNT1>0) THEN
insert into combin_mast("Comp_Code","Combin_Code","Edition_Combin_Code","Combin_Desc","Package_Name","Package_Alias","UserId","No_Of_Edition","Share_Distribution","Ad_Type_code","Edition_Type","Creation_Datetime","pub_center")
values(compcode,combcode,packagecode,packagename,packagename,packagename,userid,1,'SO0','DI0',1,sysdate,'0');

INSERT INTO COMBIN_DAYS(COMP_CODE,COMBIN_CODE,EDITION_COMBIN_CODE,SUN,MON,TUE,WED,THU,FRI,SAT,ALLDAY,FOCUSDAY) VALUES(compcode,combcode,edi_alias,sun,mon,tue,wed,thu,fri,sat,all1,'N');
END IF;
-------------------------------------
combcode:=substr(packagename,1,2);

select NVL(MAX(TO_NUMBER(NVL(translate("Combin_Code",'ABCDEFGHIJKLMNOPQRSTUVWXYZ',0),0))),-1) INTO COUNT1 from combin_mast where "Combin_Code" like  combcode||'%';

if(COUNT1!=-1)THEN
COUNT1:=COUNT1+1;
else
COUNT1:=0;
END IF;

combcode:=combcode||TO_CHAR(COUNT1);
select COUNT(*) INTO COUNT1 from ADV_TYPE_MAST where "Adv_Type_Code"='CL0';
IF (COUNT1>0) THEN
insert into combin_mast("Comp_Code","Combin_Code","Edition_Combin_Code","Combin_Desc","Package_Name","Package_Alias","UserId","No_Of_Edition","Share_Distribution","Ad_Type_code","Edition_Type","Creation_Datetime","pub_center")
values(compcode,combcode,packagecode,packagename,packagename,packagename,userid,1,'SO0','CL0',1,sysdate,'0');

INSERT INTO COMBIN_DAYS(COMP_CODE,COMBIN_CODE,EDITION_COMBIN_CODE,SUN,MON,TUE,WED,THU,FRI,SAT,ALLDAY,FOCUSDAY) VALUES(compcode,combcode,edi_alias,sun,mon,tue,wed,thu,fri,sat,all1,'N');
END IF;
end IF;


end if;
commit;
END Websp_Insert_Package;
/
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
CREATE OR REPLACE PROCEDURE insert_edition_details(
p_str           in varchar2,
receiptnom      in varchar2,
cioidm          in varchar2,
insertidm       in varchar2,
compcodem       in varchar2,
editioncodem    in varchar2,
insertdatem     in date,
heightm         in varchar2,
widthm          in varchar2,
totaream        in varchar2,
insstatusm      in varchar2,
pkgcode         in varchar2,
insertno        in number ,
pageno          in number, 
p_error_text    out varchar2)  
IS
tmpVar  NUMBER;
tmpStr  VARCHAR2(4000);
l_str   VARCHAR2(4000);
l_ed    varchar2(50);
l_date  date;
l_hight number;
l_width number;
l_size  number;
l_pageno number;
l_status    varchar2(20);
pubcode     varchar2(10);
editioncode varchar2(50);
combinname  varchar2(3000);
uomdesc     varchar2(50);
v_edtn_type varchar2(50);
BEGIN

if p_str is not null then
    --INSERT INTO TEST1 VALUES('pubcode','editioncode'); COMMIT;

    --insert into abctest values(insertidm,l_status);
    tmpVar  := 0;
    tmpStr  := p_str;
    l_str   := p_str;

    for i in 1..length(tmpStr)-length(replace(tmpStr,'$',null))+1 
    loop
      
        if instr(tmpStr,'$') > 0 then 
            l_str := substr(tmpStr,1,instr(tmpStr,'$')-1);
        else
            l_str := tmpStr;
        end if;
        --dbms_output.put_line('l_str:'||l_str);
        l_ed := substr(l_str,1,instr(l_str,'~')-1);
        l_str := substr(l_str,instr(l_str,'~')+1);
        l_date := to_date(substr(l_str,1,instr(l_str,'~')-1),'mm/dd/yyyy');
        l_str := substr(l_str,instr(l_str,'~')+1);
                             
        l_hight := substr(l_str,1,instr(l_str,'~')-1);
        l_str := substr(l_str,instr(l_str,'~')+1);
        l_width := substr(l_str,1,instr(l_str,'~')-1);   
        l_str := substr(l_str,instr(l_str,'~')+1);
        l_size:=substr(l_str,1,instr(l_str,'~')-1);  
        l_str := substr(l_str,instr(l_str,'~')+1); 
        l_pageno:=substr(l_str,1,instr(l_str,'~')-1);  
        l_str := substr(l_str,instr(l_str,'~')+1);
        l_status :=l_str;
        -- insert into abctest values(insertidm,'Str:'||l_status||':'||receiptnom||':'||editioncode||':'||pubcode||':'||insertidm||':'||compcodem||':'||cioidm||':'||l_date||':'||l_ed||':'||l_hight||':'||l_width||':'||l_size);
        tmpStr := substr(tmpStr,instr(tmpStr,'$')+1);

        select "Pub_Code","Edition_Code" into pubcode,editioncode from edition_mast where "Edition_Alias"=l_ed AND ROWNUM<=1;
        
        dbms_output.put_line('Str:'||l_date||':'||l_ed||':'||l_hight||':'||l_width||':'||l_size);

        insert into tbl_booking_subedition_g(COMP_CODE, CIOID, INSERTID, PUBLICATION, EDITION, INSERTDATE, HEIGHT, WIDTH, TOTALAREA, INSERTSTATUS,RECEIPTNO,SRNO,NO_INSERT,PAGE_NO) 
        values(compcodem,cioidm,insertidm,pubcode,editioncode,l_date,l_hight,l_width,l_size,l_status,receiptnom,SUBEDI_S.NEXTVAL,insertno,l_pageno);
        -- insert into 
    end loop;
else

    dbms_output.put_line('lata');

    --INSERT INTO TEST1 VALUES('pubcodeMAIN',editioncodem);
    
    select "Pub_Code","City_Code","Edition_Type" into pubcode,editioncode,v_edtn_type 
        from edition_mast 
            where trim("Edition_Code")=trim(editioncodem) and rownum<=1;
    
    -- insert into abctest values(pubcode,editioncode);
    dbms_output.put_line(pubcode);
    dbms_output.put_line(editioncode);
    dbms_output.put_line(pkgcode);
    
    If v_edtn_type='Main Edition' then
        select "Combin_Desc" into combinname from combin_mast where "Combin_Code"=pkgcode;
        
        select UOM_DESC into uomdesc from uom_mast where "Uom_Code"=(select Uom_code from tbl_booking_mast_g 
            where cio_booking_id=cioidm);
        dbms_output.put_line(combinname);
        
        if instr(combinname,'+')<0 and uomdesc='CD' then
            --INSERT INTO TEST1 VALUES(pubcode,editioncode);COMMIT;
            
            insert into tbl_booking_subedition_g(COMP_CODE, CIOID, INSERTID, PUBLICATION, EDITION, INSERTDATE, HEIGHT, WIDTH, TOTALAREA, INSERTSTATUS,RECEIPTNO,SRNO,NO_INSERT,PAGE_NO)
            select compcodem,cioidm,insertidm,"Pub_Code","Edition_Code",insertdatem,heightm,widthm,totaream,'cancel',receiptnom,SUBEDI_S.NEXTVAL,insertno,pageno
            from edition_mast where  "Pub_Code"=pubcode and "City_Code"=editioncode and "Edition_Type"='Edition';
            
        else
            dbms_output.put_line('lata111');
            insert into tbl_booking_subedition_g(COMP_CODE, CIOID, INSERTID, PUBLICATION, EDITION, INSERTDATE, HEIGHT, WIDTH, TOTALAREA, INSERTSTATUS,RECEIPTNO,SRNO,NO_INSERT,PAGE_NO)
            select compcodem,cioidm,insertidm,"Pub_Code","Edition_Code",insertdatem,heightm,widthm,totaream,'booked',receiptnom,SUBEDI_S.NEXTVAL,insertno,pageno
            from edition_mast where  "Pub_Code"=pubcode and "City_Code"=editioncode and "Edition_Type"='Edition';
        end if;
    End if;           
end if;
    COMMIT;  
    exception when others then 
    p_error_text :=sqlerrm;       
END insert_edition_details;
/

//==================================************End*********************==================//


@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@kuldeep@@11/02/2012@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@